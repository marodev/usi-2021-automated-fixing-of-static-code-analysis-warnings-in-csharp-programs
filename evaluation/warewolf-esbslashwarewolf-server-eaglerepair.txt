Found the following rules to apply: UseMethodAnyRewriterR6, MergeSequentialChecksRewriterR2, NullChecksShouldNotBeUsedWithIsRewriterR3, SimplifyLinqRewriterR4, TypeCheckAndCastRewriterR5, UseNullPropagationRewriterR7, UsePatternMatchingRewriterR8, UseStringInterpolationRewriterR9, UseStringIsNullOrEmptyRewriterR10



Project: Dev2.Server
    #1 Path: D:\a\1\s\Dev\Dev2.Server\ServerLifecycleManager.cs, Line: 359, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html
    #2 Path: D:\a\1\s\Dev\Dev2.Server\ServerLifecycleManager.cs, Line: 364, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html



Project: Dev2.Common
    #3 Path: D:\a\1\s\Dev\Dev2.Common\DebugStateTreeBuilder.cs, Line: 34, Message: ReSharper: ReplaceWithSingleCallToCount. / SonarQube "IEnumerable" LINQs should be simplified. See https://rules.sonarsource.com/csharp/RSPEC-2971
    #4 Path: D:\a\1\s\Dev\Dev2.Common\Wrappers\DirectoryWrapper.cs, Line: 151, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #5 Path: D:\a\1\s\Dev\Dev2.Common\Wrappers\IonicZipFileWrapper.cs, Line: 40, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html



Project: Dev2.Data
    #6 Path: D:\a\1\s\Dev\Dev2.Data\TO\Dev2Definition.cs, Line: 54, Message: ReSharper: Use 'String.IsNullOrEmpty'. See https://www.jetbrains.com/help/resharper/ReplaceWithStringIsNullOrEmpty.html / SonarQube: "string.IsNullOrEmpty" should be used. See https://rules.sonarsource.com/csharp/RSPEC-3256
    #7 Path: D:\a\1\s\Dev\Dev2.Data\Util\CommonDataUtils.cs, Line: 399, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #8 Path: D:\a\1\s\Dev\Dev2.Data\Util\Scrubber.cs, Line: 27, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #9 Path: D:\a\1\s\Dev\Dev2.Data\WarewolfIterator.cs, Line: 143, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html



Project: Dev2.Activities
    #10 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\ActivityParser.cs, Line: 259, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #11 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\ActivityParser.cs, Line: 293, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #12 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\AdvancedRecordsetActivity.cs, Line: 396, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #13 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\DateAndTime\DsfDotNetDateTimeActivity.cs, Line: 207, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #14 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\DateAndTime\DsfDotNetDateTimeActivity.cs, Line: 211, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #15 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\DateAndTime\DsfDotNetDateTimeActivity.cs, Line: 215, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #16 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\DateAndTime\DsfDotNetDateTimeActivity.cs, Line: 228, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #17 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\Debug\DebugItemWarewolfAtomListResult.cs, Line: 258, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #18 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\DropBox2016\DeleteActivity\DsfDropBoxDeleteActivity.cs, Line: 102, Message: ReSharper: Type check and casts can be merged. See https://www.jetbrains.com/help/resharper/MergeCastWithTypeCheck.html / SonarQube: Duplicate casts should not be made. See https://rules.sonarsource.com/csharp/RSPEC-3247
    #19 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\DropBox2016\DownloadActivity\DsfDropBoxDownloadActivity.cs, Line: 181, Message: ReSharper: Type check and casts can be merged. See https://www.jetbrains.com/help/resharper/MergeCastWithTypeCheck.html / SonarQube: Duplicate casts should not be made. See https://rules.sonarsource.com/csharp/RSPEC-3247
    #20 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\DropBox2016\DropboxFileActivity\DsfDropboxFileListActivity.cs, Line: 206, Message: ReSharper: Type check and casts can be merged. See https://www.jetbrains.com/help/resharper/MergeCastWithTypeCheck.html / SonarQube: Duplicate casts should not be made. See https://rules.sonarsource.com/csharp/RSPEC-3247
    #21 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\DropBox2016\UploadActivity\DsfDropBoxUploadActivity.cs, Line: 163, Message: ReSharper: Type check and casts can be merged. See https://www.jetbrains.com/help/resharper/MergeCastWithTypeCheck.html / SonarQube: Duplicate casts should not be made. See https://rules.sonarsource.com/csharp/RSPEC-3247
    #22 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\DsfBaseActivity.cs, Line: 66, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #23 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\DsfBaseConvertActivity.cs, Line: 265, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html
    #24 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\DsfCaseConvertActivity.cs, Line: 295, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html
    #25 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataMergeActivity.cs, Line: 395, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html
    #26 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataSplitActivity.cs, Line: 402, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html
    #27 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDateTimeActivity.cs, Line: 182, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #28 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDateTimeActivity.cs, Line: 187, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #29 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDateTimeActivity.cs, Line: 221, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #30 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDateTimeActivity.cs, Line: 225, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #31 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDateTimeActivity.cs, Line: 230, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #32 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDotNetGatherSystemInformationActivity.cs, Line: 400, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html
    #33 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDotNetMultiAssignActivity.cs, Line: 351, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #34 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDotNetMultiAssignObjectActivity.cs, Line: 290, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #35 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDotNetMultiAssignObjectActivity.cs, Line: 290, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #36 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs, Line: 345, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html
    #37 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\DsfGatherSystemInformationActivity.cs, Line: 440, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html
    #38 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\DsfMultiAssignActivity.cs, Line: 332, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #39 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\DsfMultiAssignActivity.cs, Line: 332, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #40 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\DsfMultiAssignObjectActivity.cs, Line: 340, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #41 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\DsfMultiAssignObjectActivity.cs, Line: 340, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #42 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\DsfNativeActivity.cs, Line: 492, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #43 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\DsfNativeActivity.cs, Line: 575, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #44 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\DsfNativeActivity.cs, Line: 609, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #45 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\DsfNativeActivity.cs, Line: 745, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #46 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\DsfNativeActivity.cs, Line: 767, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #47 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\DsfSwitch.cs, Line: 233, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html
    #48 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\DsfSwitch.cs, Line: 258, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html
    #49 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\DsfWebActivityBase.cs, Line: 83, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #50 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\DsfWebPutActivity.cs, Line: 109, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #51 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\DsfXPathActivity.cs, Line: 382, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html
    #52 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\RedisCache\RedisCacheActivity.cs, Line: 184, Message: ReSharper: Use '.Any()' to test whether this IEnumerable is empty or not. See ReSharper/UseMethodAny.0.html / SonarQube: "Any()" should be used to test for emptiness. See https://rules.sonarsource.com/csharp/RSPEC-1155
    #53 Path: D:\a\1\s\Dev\Dev2.Activities\Activities\Sharepoint\SharepointUtils.cs, Line: 131, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #54 Path: D:\a\1\s\Dev\Dev2.Activities\Utilities\ActivityHelper.cs, Line: 117, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html
    #55 Path: D:\a\1\s\Dev\Dev2.Activities\Utilities\ActivityHelper.cs, Line: 126, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html
    #56 Path: D:\a\1\s\Dev\Dev2.Activities\Utilities\ActivityHelper.cs, Line: 35, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html
    #57 Path: D:\a\1\s\Dev\Dev2.Activities\Utilities\ActivityHelper.cs, Line: 54, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html
    #58 Path: D:\a\1\s\Dev\Dev2.Activities\Utilities\ActivityHelper.cs, Line: 87, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html
    #59 Path: D:\a\1\s\Dev\Dev2.Activities\Utilities\WorkflowHelper.cs, Line: 129, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #60 Path: D:\a\1\s\Dev\Dev2.Activities\Utilities\WorkflowHelper.cs, Line: 194, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html



Project: Dev2.Core
    #61 Path: D:\a\1\s\Dev\Dev2.Core\Converters\Graph\Poco\PocoNavigator.cs, Line: 141, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #62 Path: D:\a\1\s\Dev\Dev2.Core\Converters\Graph\Poco\PocoPathSegment.cs, Line: 56, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #63 Path: D:\a\1\s\Dev\Dev2.Core\Converters\Graph\String\Json\JsonPathSegment.cs, Line: 56, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #64 Path: D:\a\1\s\Dev\Dev2.Core\Converters\Graph\String\Xml\XmlNavigator.cs, Line: 278, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #65 Path: D:\a\1\s\Dev\Dev2.Core\Converters\Graph\String\Xml\XmlNavigator.cs, Line: 287, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #66 Path: D:\a\1\s\Dev\Dev2.Core\Converters\Graph\String\Xml\XmlNavigator.cs, Line: 300, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #67 Path: D:\a\1\s\Dev\Dev2.Core\Converters\Graph\String\Xml\XmlNavigator.cs, Line: 459, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #68 Path: D:\a\1\s\Dev\Dev2.Core\Converters\Graph\String\Xml\XmlPathSegment.cs, Line: 44, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #69 Path: D:\a\1\s\Dev\Dev2.Core\InterfaceImplementors\DsfDataObject.cs, Line: 476, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html



Project: Dev2.Runtime.Services
    #70 Path: D:\a\1\s\Dev\Dev2.Runtime.Services\DynamicProxy\DynamicProxyFactory.cs, Line: 111, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #71 Path: D:\a\1\s\Dev\Dev2.Runtime.Services\DynamicProxy\DynamicProxyFactory.cs, Line: 115, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #72 Path: D:\a\1\s\Dev\Dev2.Runtime.Services\DynamicProxy\DynamicProxyFactory.cs, Line: 119, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #73 Path: D:\a\1\s\Dev\Dev2.Runtime.Services\Hosting\ResourceCatalogBuilder.cs, Line: 390, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #74 Path: D:\a\1\s\Dev\Dev2.Runtime.Services\Hosting\ResourceCatalogBuilder.cs, Line: 459, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #75 Path: D:\a\1\s\Dev\Dev2.Runtime.Services\Hosting\ServerVersionRepository.cs, Line: 294, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #76 Path: D:\a\1\s\Dev\Dev2.Runtime.Services\ServiceModel\Data\ExchangeSource.cs, Line: 182, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #77 Path: D:\a\1\s\Dev\Dev2.Runtime.Services\ServiceModel\Data\ExchangeSource.cs, Line: 183, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #78 Path: D:\a\1\s\Dev\Dev2.Runtime.Services\ServiceModel\Data\ExchangeSource.cs, Line: 184, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #79 Path: D:\a\1\s\Dev\Dev2.Runtime.Services\ServiceModel\Data\ExchangeSource.cs, Line: 185, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #80 Path: D:\a\1\s\Dev\Dev2.Runtime.Services\ServiceModel\Data\Service.cs, Line: 309, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #81 Path: D:\a\1\s\Dev\Dev2.Runtime.Services\ServiceModel\Data\Service.cs, Line: 310, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #82 Path: D:\a\1\s\Dev\Dev2.Runtime.Services\ServiceModel\Data\WcfProxyService.cs, Line: 113, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #83 Path: D:\a\1\s\Dev\Dev2.Runtime.Services\ServiceModel\Data\WcfSource.cs, Line: 115, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #84 Path: D:\a\1\s\Dev\Dev2.Runtime.Services\ServiceModel\Esb\Brokers\ComPlugin\ComPluginRuntimeHandler.cs, Line: 72, Message: ReSharper: Type check and casts can be merged. See https://www.jetbrains.com/help/resharper/MergeCastWithTypeCheck.html / SonarQube: Duplicate casts should not be made. See https://rules.sonarsource.com/csharp/RSPEC-3247
    #85 Path: D:\a\1\s\Dev\Dev2.Runtime.Services\ServiceModel\HubFactory.cs, Line: 35, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #86 Path: D:\a\1\s\Dev\Dev2.Runtime.Services\ServiceModel\WebSources.cs, Line: 240, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #87 Path: D:\a\1\s\Dev\Dev2.Runtime.Services\ServiceModel\WebSources.cs, Line: 255, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #88 Path: D:\a\1\s\Dev\Dev2.Runtime.Services\Workspaces\WorkspaceItem.cs, Line: 174, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html



Project: Dev2.Runtime.Configuration
    #89 Path: D:\a\1\s\Dev\Dev2.Runtime.Configuration\CustomControls\VisualStates.cs, Line: 417, Message: ReSharper: ReplaceWithSingleCallToFirstOrDefault. / SonarQube "IEnumerable" LINQs should be simplified. See https://rules.sonarsource.com/csharp/RSPEC-2971



Project: Dev2.Runtime.Configuration.Tests
    #90 Path: D:\a\1\s\Dev\Dev2.Runtime.Configuration.Tests\XML\XmlResource.cs, Line: 32, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html



Project: Dev2.Diagnostics
    #91 Path: D:\a\1\s\Dev\Dev2.Diagnostics\Debug\DebugItem.cs, Line: 117, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #92 Path: D:\a\1\s\Dev\Dev2.Diagnostics\Debug\DebugItem.cs, Line: 76, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #93 Path: D:\a\1\s\Dev\Dev2.Diagnostics\Debug\DebugItemResult.cs, Line: 33, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #94 Path: D:\a\1\s\Dev\Dev2.Diagnostics\Logging\EnvironmentVariables.cs, Line: 117, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #95 Path: D:\a\1\s\Dev\Dev2.Diagnostics\Logging\EnvironmentVariables.cs, Line: 126, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html



Project: Dev2.CustomControls
    #96 Path: D:\a\1\s\Dev\Dev2.CustomControls\Converters\IsValidDateTimeConverter.cs, Line: 21, Message: ReSharper: Type check and casts can be merged. See https://www.jetbrains.com/help/resharper/MergeCastWithTypeCheck.html / SonarQube: Duplicate casts should not be made. See https://rules.sonarsource.com/csharp/RSPEC-3247
    #97 Path: D:\a\1\s\Dev\Dev2.CustomControls\Converters\RowToIndexConverter.cs, Line: 28, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #98 Path: D:\a\1\s\Dev\Dev2.CustomControls\WatermarkTextBox.cs, Line: 109, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html



Project: Dev2.Infrastructure
    #99 Path: D:\a\1\s\Dev\Dev2.Infrastructure\PerformanceCounters\Counters\MyPerfCounter.cs, Line: 59, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html
    #100 Path: D:\a\1\s\Dev\Dev2.Infrastructure\PerformanceCounters\Counters\WarewolfAverageExecutionTimePerformanceCounter.cs, Line: 113, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html
    #101 Path: D:\a\1\s\Dev\Dev2.Infrastructure\PerformanceCounters\Counters\WarewolfNumberOfAuthErrors.cs, Line: 93, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html
    #102 Path: D:\a\1\s\Dev\Dev2.Infrastructure\PerformanceCounters\Counters\WarewolfNumberOfErrors.cs, Line: 91, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html
    #103 Path: D:\a\1\s\Dev\Dev2.Infrastructure\PerformanceCounters\Counters\WarewolfNumberOfErrorsByResource.cs, Line: 98, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html
    #104 Path: D:\a\1\s\Dev\Dev2.Infrastructure\PerformanceCounters\Counters\WarewolfServicesNotFoundCounter.cs, Line: 96, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html
    #105 Path: D:\a\1\s\Dev\Dev2.Infrastructure\PerformanceCounters\Management\WarewolfPerformanceCounterManager.cs, Line: 55, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #106 Path: D:\a\1\s\Dev\Dev2.Infrastructure\Providers\Validation\Rules\IsValidCollectionRule.cs, Line: 38, Message: ReSharper: Use '.Any()' to test whether this IEnumerable is empty or not. See ReSharper/UseMethodAny.0.html / SonarQube: "Any()" should be used to test for emptiness. See https://rules.sonarsource.com/csharp/RSPEC-1155
    #107 Path: D:\a\1\s\Dev\Dev2.Infrastructure\Providers\Validation\Rules\Rule.cs, Line: 54, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #108 Path: D:\a\1\s\Dev\Dev2.Infrastructure\Services\Security\AuthorizationServiceBase.cs, Line: 360, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #109 Path: D:\a\1\s\Dev\Dev2.Infrastructure\Shared Models\DbColumn.cs, Line: 64, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #110 Path: D:\a\1\s\Dev\Dev2.Infrastructure\Shared Models\DbColumn.cs, Line: 84, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #111 Path: D:\a\1\s\Dev\Dev2.Infrastructure\Shared Models\DbTable.cs, Line: 34, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html



Project: Dev2.Infrastructure.Tests
    #112 Path: D:\a\1\s\Dev\Dev2.Infrastructure.Tests\Communication\MemoTests.cs, Line: 31, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #113 Path: D:\a\1\s\Dev\Dev2.Infrastructure.Tests\XML\XmlResource.cs, Line: 32, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #114 Path: D:\a\1\s\Dev\Warewolf.UnitTestAttributes\Depends.cs, Line: 410, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html



Project: Dev2.Services.Sql
    #115 Path: D:\a\1\s\Dev\Dev2.Services.Sql\MySqlServer.cs, Line: 337, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #116 Path: D:\a\1\s\Dev\Dev2.Services.Sql\MySqlServer.cs, Line: 378, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #117 Path: D:\a\1\s\Dev\Dev2.Services.Sql\PostgreServer.cs, Line: 132, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html
    #118 Path: D:\a\1\s\Dev\Dev2.Services.Sql\PostgreServer.cs, Line: 336, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #119 Path: D:\a\1\s\Dev\Dev2.Services.Sql\PostgreServer.cs, Line: 478, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html
    #120 Path: D:\a\1\s\Dev\Dev2.Services.Sql\PostgreServer.cs, Line: 484, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html
    #121 Path: D:\a\1\s\Dev\Dev2.Services.Sql\SqliteServer.cs, Line: 182, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html



Project: Dev2.Services.Execution
    #122 Path: D:\a\1\s\Dev\Dev2.Services.Execution\DatabaseServiceExecution.cs, Line: 276, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #123 Path: D:\a\1\s\Dev\Dev2.Services.Execution\DatabaseServiceExecution.cs, Line: 290, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html



Project: Dev2.TaskScheduler.Wrappers
    #124 Path: D:\a\1\s\Dev\Dev2.TaskScheduler.Wrappers\TaskServiceConvertorFactory.cs, Line: 132, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #125 Path: D:\a\1\s\Dev\Dev2.TaskScheduler.Wrappers\TaskServiceConvertorFactory.cs, Line: 147, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #126 Path: D:\a\1\s\Dev\Dev2.TaskScheduler.Wrappers\TaskServiceConvertorFactory.cs, Line: 177, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html



Project: Dev2.Scheduler
    #127 Path: D:\a\1\s\Dev\Dev2.Scheduler\ScheduledResource.cs, Line: 373, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #128 Path: D:\a\1\s\Dev\Dev2.Scheduler\ServerSchedulerFactory.cs, Line: 30, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #129 Path: D:\a\1\s\Dev\Dev2.Scheduler\ServerSchedulerFactory.cs, Line: 31, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html



Project: Warewolf.Storage
    #130 Path: D:\a\1\s\Dev\Warewolf.Storage\ExecutionEnvironment.cs, Line: 63, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #131 Path: D:\a\1\s\Dev\Warewolf.Storage\ExecutionEnvironment.cs, Line: 892, Message: https://www.jetbrains.com/help/resharper/MergeSequentialChecks.html



Project: Warewolf.Core
    #132 Path: D:\a\1\s\Dev\Warewolf.Core\InputsFromJson.cs, Line: 105, Message: https://www.jetbrains.com/help/resharper/MergeSequentialChecks.html



Project: Warewolf.Sharepoint
    #133 Path: D:\a\1\s\Dev\Warewolf.Sharepoint\SharepointHelper.cs, Line: 242, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #134 Path: D:\a\1\s\Dev\Warewolf.Sharepoint\SharepointHelper.cs, Line: 343, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #135 Path: D:\a\1\s\Dev\Warewolf.Sharepoint\SharepointHelper.cs, Line: 358, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #136 Path: D:\a\1\s\Dev\Warewolf.Sharepoint\SharepointHelper.cs, Line: 379, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html



Project: Warewolf.Security
    #137 Path: D:\a\1\s\Dev\Warewolf.Security\Encryption\AESThenHMAC.cs, Line: 154, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #138 Path: D:\a\1\s\Dev\Warewolf.Security\Encryption\AESThenHMAC.cs, Line: 157, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #139 Path: D:\a\1\s\Dev\Warewolf.Security\Encryption\AESThenHMAC.cs, Line: 233, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #140 Path: D:\a\1\s\Dev\Warewolf.Security\Encryption\AESThenHMAC.cs, Line: 236, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #141 Path: D:\a\1\s\Dev\Warewolf.Security\Encryption\AESThenHMAC.cs, Line: 318, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #142 Path: D:\a\1\s\Dev\Warewolf.Security\Encryption\AESThenHMAC.cs, Line: 377, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html



Project: Dev2.Runtime.Tests
    #143 Path: D:\a\1\s\Dev\Dev2.Runtime.Tests\Json\JsonResource.cs, Line: 25, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #144 Path: D:\a\1\s\Dev\Dev2.Runtime.Tests\Plugins\DllExtractor.cs, Line: 28, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #145 Path: D:\a\1\s\Dev\Dev2.Runtime.Tests\Security\SecurityConfigFetcher.cs, Line: 25, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #146 Path: D:\a\1\s\Dev\Dev2.Runtime.Tests\Security\ServerAuthorizationServiceTests.cs, Line: 489, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #147 Path: D:\a\1\s\Dev\Dev2.Runtime.Tests\Security\ServerAuthorizationServiceTests.cs, Line: 514, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #148 Path: D:\a\1\s\Dev\Dev2.Runtime.Tests\ServiceModel\Data\PluginServiceTests.cs, Line: 152, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #149 Path: D:\a\1\s\Dev\Dev2.Runtime.Tests\ServiceModel\Data\ResourceTests.cs, Line: 1894, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #150 Path: D:\a\1\s\Dev\Dev2.Runtime.Tests\Services\FetchCurrentServerLogTests.cs, Line: 65, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #151 Path: D:\a\1\s\Dev\Dev2.Runtime.Tests\Services\FetchCurrentServerLogTests.cs, Line: 78, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #152 Path: D:\a\1\s\Dev\Dev2.Runtime.Tests\Services\FetchDebugItemFileTests.cs, Line: 119, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #153 Path: D:\a\1\s\Dev\Dev2.Runtime.Tests\Services\FetchDebugItemFileTests.cs, Line: 98, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #154 Path: D:\a\1\s\Dev\Dev2.Runtime.Tests\WebServer\Responses\StringResponseWriterTests.cs, Line: 131, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #155 Path: D:\a\1\s\Dev\Dev2.Runtime.Tests\WebServer\Security\AuthorizeWebAttributeTests.cs, Line: 181, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #156 Path: D:\a\1\s\Dev\Dev2.Runtime.Tests\WebServer\WebServerRequestTests.cs, Line: 136, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #157 Path: D:\a\1\s\Dev\Dev2.Runtime.Tests\XML\XmlResource.cs, Line: 32, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html



Project: Dev2.Data.Tests
    #158 Path: D:\a\1\s\Dev\Dev2.Data.Tests\Parsers\Dev2DataLanguageParserTests.cs, Line: 92, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html
    #159 Path: D:\a\1\s\Dev\Dev2.Data.Tests\XPathParserTests.cs, Line: 670, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html



Project: Dev2.Activities.Tests
    #160 Path: D:\a\1\s\Dev\Dev2.Activities.Tests\Activities\DsfWebGetRequestWithTimeoutActivity\DsfWebGetRequestWithTimeoutActivityTests.cs, Line: 383, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #161 Path: D:\a\1\s\Dev\Dev2.Activities.Tests\ActivityTests\DataSplitActivityTest.cs, Line: 251, Message: ReSharper: ReplaceWithSingleCallToCount. / SonarQube "IEnumerable" LINQs should be simplified. See https://rules.sonarsource.com/csharp/RSPEC-2971
    #162 Path: D:\a\1\s\Dev\Dev2.Activities.Tests\ActivityTests\DataSplitActivityTest.cs, Line: 252, Message: ReSharper: ReplaceWithSingleCallToCount. / SonarQube "IEnumerable" LINQs should be simplified. See https://rules.sonarsource.com/csharp/RSPEC-2971
    #163 Path: D:\a\1\s\Dev\Dev2.Activities.Tests\ActivityTests\DropBox2016\Download\DsfDropBoxDownloadAcivtityTestShould.cs, Line: 122, Message: ReSharper: ReplaceWithSingleCallToCount. / SonarQube "IEnumerable" LINQs should be simplified. See https://rules.sonarsource.com/csharp/RSPEC-2971
    #164 Path: D:\a\1\s\Dev\Dev2.Activities.Tests\ActivityTests\DropBox2016\Download\DsfDropBoxDownloadAcivtityTestShould.cs, Line: 138, Message: ReSharper: ReplaceWithSingleCallToCount. / SonarQube "IEnumerable" LINQs should be simplified. See https://rules.sonarsource.com/csharp/RSPEC-2971
    #165 Path: D:\a\1\s\Dev\Dev2.Activities.Tests\ActivityTests\DropBox2016\Download\DsfDropBoxDownloadAcivtityTestShould.cs, Line: 154, Message: ReSharper: ReplaceWithSingleCallToCount. / SonarQube "IEnumerable" LINQs should be simplified. See https://rules.sonarsource.com/csharp/RSPEC-2971
    #166 Path: D:\a\1\s\Dev\Dev2.Activities.Tests\ActivityTests\DropBox2016\Download\DsfDropBoxDownloadAcivtityTestShould.cs, Line: 171, Message: ReSharper: ReplaceWithSingleCallToCount. / SonarQube "IEnumerable" LINQs should be simplified. See https://rules.sonarsource.com/csharp/RSPEC-2971
    #167 Path: D:\a\1\s\Dev\Dev2.Activities.Tests\ActivityTests\DropBox2016\Download\DsfDropBoxDownloadAcivtityTestShould.cs, Line: 185, Message: ReSharper: ReplaceWithSingleCallToCount. / SonarQube "IEnumerable" LINQs should be simplified. See https://rules.sonarsource.com/csharp/RSPEC-2971
    #168 Path: D:\a\1\s\Dev\Dev2.Activities.Tests\ActivityTests\DropBox2016\Download\DsfDropBoxDownloadAcivtityTestShould.cs, Line: 199, Message: ReSharper: ReplaceWithSingleCallToCount. / SonarQube "IEnumerable" LINQs should be simplified. See https://rules.sonarsource.com/csharp/RSPEC-2971
    #169 Path: D:\a\1\s\Dev\Dev2.Activities.Tests\ActivityTests\DropBox2016\Download\DsfDropBoxDownloadAcivtityTestShould.cs, Line: 219, Message: ReSharper: ReplaceWithSingleCallToCount. / SonarQube "IEnumerable" LINQs should be simplified. See https://rules.sonarsource.com/csharp/RSPEC-2971
    #170 Path: D:\a\1\s\Dev\Dev2.Activities.Tests\ActivityTests\DropBox2016\Download\DsfDropBoxDownloadAcivtityTestShould.cs, Line: 579, Message: ReSharper: ReplaceWithSingleCallToCount. / SonarQube "IEnumerable" LINQs should be simplified. See https://rules.sonarsource.com/csharp/RSPEC-2971
    #171 Path: D:\a\1\s\Dev\Dev2.Activities.Tests\ActivityTests\DropBox2016\DropboxFiles\DropboxFileListActivityShould.cs, Line: 114, Message: ReSharper: ReplaceWithSingleCallToCount. / SonarQube "IEnumerable" LINQs should be simplified. See https://rules.sonarsource.com/csharp/RSPEC-2971
    #172 Path: D:\a\1\s\Dev\Dev2.Activities.Tests\ActivityTests\DropBox2016\DropboxFiles\DropboxFileListActivityShould.cs, Line: 156, Message: ReSharper: ReplaceWithSingleCallToCount. / SonarQube "IEnumerable" LINQs should be simplified. See https://rules.sonarsource.com/csharp/RSPEC-2971
    #173 Path: D:\a\1\s\Dev\Dev2.Activities.Tests\ActivityTests\DropBox2016\DropboxFiles\DropboxFileListActivityShould.cs, Line: 575, Message: ReSharper: ReplaceWithSingleCallToCount. / SonarQube "IEnumerable" LINQs should be simplified. See https://rules.sonarsource.com/csharp/RSPEC-2971
    #174 Path: D:\a\1\s\Dev\Dev2.Activities.Tests\ActivityTests\DropBox2016\DropboxFiles\DropboxFileListActivityShould.cs, Line: 98, Message: ReSharper: ReplaceWithSingleCallToCount. / SonarQube "IEnumerable" LINQs should be simplified. See https://rules.sonarsource.com/csharp/RSPEC-2971
    #175 Path: D:\a\1\s\Dev\Dev2.Activities.Tests\ActivityTests\IndexActivityTests.cs, Line: 377, Message: ReSharper: Use '.Any()' to test whether this IEnumerable is empty or not. See ReSharper/UseMethodAny.0.html / SonarQube: "Any()" should be used to test for emptiness. See https://rules.sonarsource.com/csharp/RSPEC-1155
    #176 Path: D:\a\1\s\Dev\Dev2.Activities.Tests\ActivityTests\RabbitMQ\Consume\DsfConsumeRabbitMQActivityTests.cs, Line: 519, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #177 Path: D:\a\1\s\Dev\Dev2.Activities.Tests\ActivityTests\RabbitMQ\Consume\DsfConsumeRabbitMQActivityTests.cs, Line: 557, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #178 Path: D:\a\1\s\Dev\Dev2.Activities.Tests\ActivityTests\RabbitMQ\Consume\DsfConsumeRabbitMQActivityTests.cs, Line: 721, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #179 Path: D:\a\1\s\Dev\Dev2.Activities.Tests\ActivityTests\RabbitMQ\Consume\DsfConsumeRabbitMQActivityTests.cs, Line: 734, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #180 Path: D:\a\1\s\Dev\Dev2.Activities.Tests\ActivityTests\RabbitMQ\Consume\DsfConsumeRabbitMQActivityTests.cs, Line: 777, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #181 Path: D:\a\1\s\Dev\Dev2.Activities.Tests\ActivityTests\RabbitMQ\Consume\DsfConsumeRabbitMQActivityTests.cs, Line: 805, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #182 Path: D:\a\1\s\Dev\Dev2.Activities.Tests\ActivityTests\RabbitMQ\Consume\DsfConsumeRabbitMQActivityTests.cs, Line: 807, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #183 Path: D:\a\1\s\Dev\Dev2.Activities.Tests\ActivityTests\RabbitMQ\Consume\DsfConsumeRabbitMQActivityTests.cs, Line: 822, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #184 Path: D:\a\1\s\Dev\Dev2.Activities.Tests\ActivityTests\RabbitMQ\Consume\DsfConsumeRabbitMQActivityTests.cs, Line: 943, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #185 Path: D:\a\1\s\Dev\Dev2.Activities.Tests\XML\XmlResource.cs, Line: 32, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html



Project: Dev2.Activities.Specs
    #186 Path: D:\a\1\s\Dev\Dev2.Activities.Specs\Composition\DBSource\XmlFetch.cs, Line: 32, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #187 Path: D:\a\1\s\Dev\Dev2.Activities.Specs\Composition\WorkflowExecutionSteps.cs, Line: 1431, Message: ReSharper: Use '.Any()' to test whether this IEnumerable is empty or not. See ReSharper/UseMethodAny.0.html / SonarQube: "Any()" should be used to test for emptiness. See https://rules.sonarsource.com/csharp/RSPEC-1155
    #188 Path: D:\a\1\s\Dev\Dev2.Activities.Specs\Composition\WorkflowExecutionSteps.cs, Line: 1463, Message: https://www.jetbrains.com/help/resharper/MergeSequentialChecks.html
    #189 Path: D:\a\1\s\Dev\Dev2.Activities.Specs\Composition\WorkflowExecutionSteps.cs, Line: 1533, Message: https://www.jetbrains.com/help/resharper/MergeSequentialChecks.html
    #190 Path: D:\a\1\s\Dev\Dev2.Activities.Specs\Composition\WorkflowExecutionSteps.cs, Line: 1601, Message: https://www.jetbrains.com/help/resharper/MergeSequentialChecks.html
    #191 Path: D:\a\1\s\Dev\Dev2.Activities.Specs\Composition\WorkflowExecutionSteps.cs, Line: 4742, Message: https://www.jetbrains.com/help/resharper/MergeSequentialChecks.html
    #192 Path: D:\a\1\s\Dev\Dev2.Activities.Specs\StudioTestFramework\StudioTestFrameworkSteps.cs, Line: 2179, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #193 Path: D:\a\1\s\Dev\Dev2.Activities.Specs\StudioTestFramework\StudioTestFrameworkSteps.cs, Line: 2203, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html



Project: Warewolf.Security.Specs
    #194 Path: D:\a\1\s\Dev\Warewolf.Security.Specs\SettingsPermissionsSteps.cs, Line: 248, Message: ReSharper: Use '.Any()' to test whether this IEnumerable is empty or not. See ReSharper/UseMethodAny.0.html / SonarQube: "Any()" should be used to test for emptiness. See https://rules.sonarsource.com/csharp/RSPEC-1155
    #195 Path: D:\a\1\s\Dev\Warewolf.Security.Specs\SettingsPermissionsSteps.cs, Line: 351, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html



Project: Dev2.Studio.Core
    #196 Path: D:\a\1\s\Dev\Dev2.Studio.Core\Activities\Utils\ModelItemUtils.cs, Line: 119, Message: https://www.jetbrains.com/help/resharper/MergeSequentialChecks.html
    #197 Path: D:\a\1\s\Dev\Dev2.Studio.Core\AppResources\Behaviors\PreventHorizontalScrollWhenFocusedTreeViewItemBehavior.cs, Line: 27, Message: ReSharper: Type check and casts can be merged. See https://www.jetbrains.com/help/resharper/MergeCastWithTypeCheck.html / SonarQube: Duplicate casts should not be made. See https://rules.sonarsource.com/csharp/RSPEC-3247
    #198 Path: D:\a\1\s\Dev\Dev2.Studio.Core\AppResources\Converters\IntToVisibilityConverter.cs, Line: 31, Message: ReSharper: Type check and casts can be merged. See https://www.jetbrains.com/help/resharper/MergeCastWithTypeCheck.html / SonarQube: Duplicate casts should not be made. See https://rules.sonarsource.com/csharp/RSPEC-3247
    #199 Path: D:\a\1\s\Dev\Dev2.Studio.Core\DataList\RecordsetHandler.cs, Line: 264, Message: ReSharper: Use '.Any()' to test whether this IEnumerable is empty or not. See ReSharper/UseMethodAny.0.html / SonarQube: "Any()" should be used to test for emptiness. See https://rules.sonarsource.com/csharp/RSPEC-1155
    #200 Path: D:\a\1\s\Dev\Dev2.Studio.Core\DependencyGraph\DependencyVisualization\CircularDependency.cs, Line: 35, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #201 Path: D:\a\1\s\Dev\Dev2.Studio.Core\Diagnostics\DebugStateTreeViewItemViewModel.cs, Line: 247, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #202 Path: D:\a\1\s\Dev\Dev2.Studio.Core\Network\WebServer.cs, Line: 113, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html



Project: Dev2.Intellisense
    #203 Path: D:\a\1\s\Dev\Dev2.Intellisense\Helper\FileSystemQuery.cs, Line: 213, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html



Project: Warewolf.Studio.CustomControls
    #204 Path: D:\a\1\s\Dev\Warewolf.Studio.CustomControls\WidthConverter.cs, Line: 45, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #205 Path: D:\a\1\s\Dev\Warewolf.Studio.CustomControls\WidthConverter.cs, Line: 69, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html



Project: Dev2.Activities.Designers
    #206 Path: D:\a\1\s\Dev\Dev2.Activities.Designers\Designers2\Core\QuickVariableInput\QuickVariableInputViewModel.cs, Line: 299, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #207 Path: D:\a\1\s\Dev\Dev2.Activities.Designers\Designers2\Decision\DecisionDesignerViewModel.cs, Line: 288, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #208 Path: D:\a\1\s\Dev\Dev2.Activities.Designers\Designers2\Decision\DecisionDesignerViewModel.cs, Line: 293, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #209 Path: D:\a\1\s\Dev\Dev2.Activities.Designers\Designers2\Gate\GateDesignerViewModel.cs, Line: 103, Message: https://www.jetbrains.com/help/resharper/MergeSequentialChecks.html
    #210 Path: D:\a\1\s\Dev\Dev2.Activities.Designers\Designers2\Sequence\SequenceDesignerViewModel.cs, Line: 153, Message: https://www.jetbrains.com/help/resharper/MergeSequentialChecks.html
    #211 Path: D:\a\1\s\Dev\Dev2.Activities.Designers\Designers2\Service\ServiceDesignerViewModel.cs, Line: 192, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #212 Path: D:\a\1\s\Dev\Dev2.Activities.Designers\Designers2\SqlBulkInsert\SqlBulkInsertDesignerViewModel.cs, Line: 430, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #213 Path: D:\a\1\s\Dev\Dev2.Activities.Designers\Designers2\SqlBulkInsert\SqlBulkInsertDesignerViewModel.cs, Line: 434, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #214 Path: D:\a\1\s\Dev\Dev2.Activities.Designers\Utils\DropEnabledActivityDesignerUtils.cs, Line: 106, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #215 Path: D:\a\1\s\Dev\Dev2.Activities.Designers\Utils\DropEnabledActivityDesignerUtils.cs, Line: 122, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #216 Path: D:\a\1\s\Dev\Dev2.Activities.Designers\Utils\DropEnabledActivityDesignerUtils.cs, Line: 91, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html



Project: Dev2.Common.Tests
    #217 Path: D:\a\1\s\Dev\Dev2.Common.Tests\DebugStateTreeBuilderTests.cs, Line: 32, Message: ReSharper: ReplaceWithSingleCallToCount. / SonarQube "IEnumerable" LINQs should be simplified. See https://rules.sonarsource.com/csharp/RSPEC-2971
    #218 Path: D:\a\1\s\Dev\Dev2.Common.Tests\DebugStateTreeBuilderTests.cs, Line: 50, Message: ReSharper: ReplaceWithSingleCallToCount. / SonarQube "IEnumerable" LINQs should be simplified. See https://rules.sonarsource.com/csharp/RSPEC-2971
    #219 Path: D:\a\1\s\Dev\Dev2.Common.Tests\Person.cs, Line: 10, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html



Project: Warewolf.MergeParser
    #220 Path: D:\a\1\s\Dev\Warewolf.MergeParser\ServiceDifferenceParser.cs, Line: 169, Message: ReSharper: ReplaceWithSingleCallToCount. / SonarQube "IEnumerable" LINQs should be simplified. See https://rules.sonarsource.com/csharp/RSPEC-2971



Project: Warewolf.Studio.ViewModels
    #221 Path: D:\a\1\s\Dev\Warewolf.Studio.ViewModels\ConnectControlViewModel.cs, Line: 345, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html
    #222 Path: D:\a\1\s\Dev\Warewolf.Studio.ViewModels\ToolBox\ToolboxViewModel.cs, Line: 152, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html
    #223 Path: D:\a\1\s\Dev\Warewolf.Studio.ViewModels\ToolBox\ToolboxViewModel.cs, Line: 200, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html



Project: Warewolf.Studio.Views
    #224 Path: D:\a\1\s\Dev\Warewolf.Studio.Views\ManageComPluginSourceControl.xaml.cs, Line: 114, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #225 Path: D:\a\1\s\Dev\Warewolf.Studio.Views\ManageDatabaseSourceControl.xaml.cs, Line: 40, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #226 Path: D:\a\1\s\Dev\Warewolf.Studio.Views\ManageEmailSourceControl.xaml.cs, Line: 41, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #227 Path: D:\a\1\s\Dev\Warewolf.Studio.Views\ManageExchangeSourceControl.xaml.cs, Line: 43, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #228 Path: D:\a\1\s\Dev\Warewolf.Studio.Views\ManagePluginSourceControl.xaml.cs, Line: 44, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #229 Path: D:\a\1\s\Dev\Warewolf.Studio.Views\ManageRabbitMQSourceControl.xaml.cs, Line: 67, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #230 Path: D:\a\1\s\Dev\Warewolf.Studio.Views\ManageServerControl.xaml.cs, Line: 166, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #231 Path: D:\a\1\s\Dev\Warewolf.Studio.Views\ManageWcfSourceControl.xaml.cs, Line: 50, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #232 Path: D:\a\1\s\Dev\Warewolf.Studio.Views\ManageWebserviceSourceControl.xaml.cs, Line: 51, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #233 Path: D:\a\1\s\Dev\Warewolf.Studio.Views\SharepointServerSource.xaml.cs, Line: 53, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html



Project: Dev2.Studio
    #234 Path: D:\a\1\s\Dev\Dev2.Studio\Bootstrapper.cs, Line: 86, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #235 Path: D:\a\1\s\Dev\Dev2.Studio\CustomControls\Progress\ProgressDialogViewModel.cs, Line: 55, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #236 Path: D:\a\1\s\Dev\Dev2.Studio\ViewModels\Diagnostics\DebugOutputViewModel.cs, Line: 125, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html
    #237 Path: D:\a\1\s\Dev\Dev2.Studio\ViewModels\Merge\Utils\ConflictRowListBuilder.cs, Line: 237, Message: ReSharper: ReplaceWithSingleCallToCount. / SonarQube "IEnumerable" LINQs should be simplified. See https://rules.sonarsource.com/csharp/RSPEC-2971
    #238 Path: D:\a\1\s\Dev\Dev2.Studio\ViewModels\Merge\Utils\ConflictRowListBuilder.cs, Line: 239, Message: ReSharper: ReplaceWithSingleCallToCount. / SonarQube "IEnumerable" LINQs should be simplified. See https://rules.sonarsource.com/csharp/RSPEC-2971
    #239 Path: D:\a\1\s\Dev\Dev2.Studio\ViewModels\ShellViewModel.cs, Line: 2325, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #240 Path: D:\a\1\s\Dev\Dev2.Studio\ViewModels\Workflow\WorkflowDesignerViewModel.cs, Line: 1022, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html
    #241 Path: D:\a\1\s\Dev\Dev2.Studio\ViewModels\Workflow\WorkflowDesignerViewModel.cs, Line: 1053, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html
    #242 Path: D:\a\1\s\Dev\Dev2.Studio\ViewModels\Workflow\WorkflowDesignerViewModel.cs, Line: 1204, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html
    #243 Path: D:\a\1\s\Dev\Dev2.Studio\ViewModels\Workflow\WorkflowDesignerViewModel.cs, Line: 2124, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html
    #244 Path: D:\a\1\s\Dev\Dev2.Studio\ViewModels\Workflow\WorkflowDesignerViewModel.cs, Line: 2638, Message: https://www.jetbrains.com/help/resharper/MergeSequentialChecks.html
    #245 Path: D:\a\1\s\Dev\Dev2.Studio\ViewModels\WorkSurface\WorkSurfaceContextViewModel.cs, Line: 327, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html
    #246 Path: D:\a\1\s\Dev\Dev2.Studio\ViewModels\WorkSurface\WorkSurfaceContextViewModel.cs, Line: 400, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html
    #247 Path: D:\a\1\s\Dev\Dev2.Studio\ViewModels\WorkSurface\WorkSurfaceContextViewModel.cs, Line: 433, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html
    #248 Path: D:\a\1\s\Dev\Dev2.Studio\ViewModels\WorksurfaceContextManager.cs, Line: 1287, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html
    #249 Path: D:\a\1\s\Dev\Dev2.Studio\ViewModels\WorksurfaceContextManager.cs, Line: 1298, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html
    #250 Path: D:\a\1\s\Dev\Dev2.Studio\ViewModels\WorksurfaceContextManager.cs, Line: 1315, Message: ReSharper: Replace if statement with null-propagating code. See https://www.jetbrains.com/help/resharper/UseNullPropagation.html
    #251 Path: D:\a\1\s\Dev\Dev2.Studio\ViewModels\WorksurfaceContextManager.cs, Line: 1358, Message: SonarQube: Null checks should not be used with "is". See https://rules.sonarsource.com/csharp/RSPEC-4201 / ReSharper: Merge sequential checks in && or || expressions. See https://www.jetbrains.com/help/resharper/MergeSequentialChecks.html
    #252 Path: D:\a\1\s\Dev\Dev2.Studio\ViewModels\WorksurfaceContextManager.cs, Line: 236, Message: SonarQube: Null checks should not be used with "is". See https://rules.sonarsource.com/csharp/RSPEC-4201 / ReSharper: Merge sequential checks in && or || expressions. See https://www.jetbrains.com/help/resharper/MergeSequentialChecks.html
    #253 Path: D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowDesignerView.xaml.cs, Line: 121, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #254 Path: D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowDesignerView.xaml.cs, Line: 48, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html
    #255 Path: D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowDesignerView.xaml.cs, Line: 80, Message: ReSharper: Convert 'as' expression type check and the following null check into pattern matching. See https://www.jetbrains.com/help/resharper/UsePatternMatching.html



Project: Dev2.Studio.Core.Tests
    #256 Path: D:\a\1\s\Dev\Dev2.Studio.Core.Tests\AppResources\Converters\CalculateIntellisenseTextConverterTests.cs, Line: 38, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #257 Path: D:\a\1\s\Dev\Dev2.Studio.Core.Tests\AppResources\Converters\CalculateIntellisenseTextConverterTests.cs, Line: 49, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #258 Path: D:\a\1\s\Dev\Dev2.Studio.Core.Tests\AppResources\Converters\CalculateIntellisenseTextConverterTests.cs, Line: 81, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #259 Path: D:\a\1\s\Dev\Dev2.Studio.Core.Tests\AppResources\Converters\CalculateIntellisenseTextConverterTests.cs, Line: 92, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #260 Path: D:\a\1\s\Dev\Dev2.Studio.Core.Tests\DeployServiceTest.cs, Line: 207, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #261 Path: D:\a\1\s\Dev\Dev2.Studio.Core.Tests\Environments\EnviromentRepositoryTest.cs, Line: 1350, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #262 Path: D:\a\1\s\Dev\Dev2.Studio.Core.Tests\Environments\EnviromentRepositoryTest.cs, Line: 1378, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #263 Path: D:\a\1\s\Dev\Dev2.Studio.Core.Tests\Environments\EnviromentRepositoryTest.cs, Line: 1379, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #264 Path: D:\a\1\s\Dev\Dev2.Studio.Core.Tests\QueryManagerProxyTest.cs, Line: 330, Message: ReSharper: ReplaceWithSingleCallToCount. / SonarQube "IEnumerable" LINQs should be simplified. See https://rules.sonarsource.com/csharp/RSPEC-2971
    #265 Path: D:\a\1\s\Dev\Dev2.Studio.Core.Tests\QueryManagerProxyTest.cs, Line: 340, Message: ReSharper: ReplaceWithSingleCallToCount. / SonarQube "IEnumerable" LINQs should be simplified. See https://rules.sonarsource.com/csharp/RSPEC-2971
    #266 Path: D:\a\1\s\Dev\Dev2.Studio.Core.Tests\QueryManagerProxyTest.cs, Line: 351, Message: ReSharper: ReplaceWithSingleCallToCount. / SonarQube "IEnumerable" LINQs should be simplified. See https://rules.sonarsource.com/csharp/RSPEC-2971
    #267 Path: D:\a\1\s\Dev\Dev2.Studio.Core.Tests\QueryManagerProxyTest.cs, Line: 362, Message: ReSharper: ReplaceWithSingleCallToCount. / SonarQube "IEnumerable" LINQs should be simplified. See https://rules.sonarsource.com/csharp/RSPEC-2971
    #268 Path: D:\a\1\s\Dev\Dev2.Studio.Core.Tests\QueryManagerProxyTest.cs, Line: 402, Message: ReSharper: ReplaceWithSingleCallToCount. / SonarQube "IEnumerable" LINQs should be simplified. See https://rules.sonarsource.com/csharp/RSPEC-2971
    #269 Path: D:\a\1\s\Dev\Dev2.Studio.Core.Tests\QueryManagerProxyTest.cs, Line: 433, Message: ReSharper: ReplaceWithSingleCallToCount. / SonarQube "IEnumerable" LINQs should be simplified. See https://rules.sonarsource.com/csharp/RSPEC-2971
    #270 Path: D:\a\1\s\Dev\Dev2.Studio.Core.Tests\QueryManagerProxyTest.cs, Line: 444, Message: ReSharper: ReplaceWithSingleCallToCount. / SonarQube "IEnumerable" LINQs should be simplified. See https://rules.sonarsource.com/csharp/RSPEC-2971
    #271 Path: D:\a\1\s\Dev\Dev2.Studio.Core.Tests\Workspaces\WorkspaceItemRepositoryTests.cs, Line: 444, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #272 Path: D:\a\1\s\Dev\Dev2.Studio.Core.Tests\XML\XmlResource.cs, Line: 32, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html



Project: Dev2.Activities.Designers.Tests
    #273 Path: D:\a\1\s\Dev\Dev2.Activities.Designers.Tests\Designers2\Core\ActivityCollectionDesignerViewModelTests.cs, Line: 1044, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #274 Path: D:\a\1\s\Dev\Dev2.Activities.Designers.Tests\Designers2\Core\ActivityCollectionDesignerViewModelTests.cs, Line: 1128, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #275 Path: D:\a\1\s\Dev\Dev2.Activities.Designers.Tests\Designers2\Core\ActivityCollectionDesignerViewModelTests.cs, Line: 354, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #276 Path: D:\a\1\s\Dev\Dev2.Activities.Designers.Tests\Designers2\Core\ActivityCollectionDesignerViewModelTests.cs, Line: 385, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #277 Path: D:\a\1\s\Dev\Dev2.Activities.Designers.Tests\Designers2\Core\ActivityCollectionDesignerViewModelTests.cs, Line: 472, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #278 Path: D:\a\1\s\Dev\Dev2.Activities.Designers.Tests\Designers2\Core\ActivityCollectionDesignerViewModelTests.cs, Line: 512, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #279 Path: D:\a\1\s\Dev\Dev2.Activities.Designers.Tests\Designers2\Core\ActivityCollectionDesignerViewModelTests.cs, Line: 550, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #280 Path: D:\a\1\s\Dev\Dev2.Activities.Designers.Tests\Designers2\Core\ActivityCollectionDesignerViewModelTests.cs, Line: 598, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #281 Path: D:\a\1\s\Dev\Dev2.Activities.Designers.Tests\Designers2\Core\ActivityCollectionDesignerViewModelTests.cs, Line: 640, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #282 Path: D:\a\1\s\Dev\Dev2.Activities.Designers.Tests\Designers2\Core\ActivityCollectionDesignerViewModelTests.cs, Line: 718, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #283 Path: D:\a\1\s\Dev\Dev2.Activities.Designers.Tests\Designers2\Core\ActivityCollectionDesignerViewModelTests.cs, Line: 881, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #284 Path: D:\a\1\s\Dev\Dev2.Activities.Designers.Tests\Designers2\Core\ActivityCollectionDesignerViewModelTests.cs, Line: 91, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #285 Path: D:\a\1\s\Dev\Dev2.Activities.Designers.Tests\SqlBulkInsert\SqlBulkInsertDesignerViewModelTests.cs, Line: 1034, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #286 Path: D:\a\1\s\Dev\Dev2.Activities.Designers.Tests\SqlBulkInsert\SqlBulkInsertDesignerViewModelTests.cs, Line: 1038, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #287 Path: D:\a\1\s\Dev\Dev2.Activities.Designers.Tests\SqlBulkInsert\SqlBulkInsertDesignerViewModelTests.cs, Line: 1115, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #288 Path: D:\a\1\s\Dev\Dev2.Activities.Designers.Tests\SqlBulkInsert\SqlBulkInsertDesignerViewModelTests.cs, Line: 1162, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html
    #289 Path: D:\a\1\s\Dev\Dev2.Activities.Designers.Tests\SqlBulkInsert\SqlBulkInsertDesignerViewModelTests.cs, Line: 487, Message: ReSharper: Use string interpolation expression. See https://www.jetbrains.com/help/resharper/UseStringInterpolation.html



--- Rules Summary ---
R9: 124
R8: 65
R7: 45
R4: 28
R2: 10
R5: 8
R6: 6
R3: 2
R10: 1

--- Summary ---
Fixed ReSharper issues: 279
Fixed SonarQube issues: 45
Total fixed issues: 289

Finished in: 1 min 35 s

######################################################################
Nr: 1 - UsePatternMatchingRewriterR8
Filepath: D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDotNetGatherSystemInformationActivity.cs
Description: Error: The created Syntax Tree is semantically incorrect.
------------------------------------------------------------------------
---- Original Tree ----
using System;
using System.Activities;
using System.Activities.Presentation.Model;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using System.Security.Principal;
using Dev2.Activities.Debug;
using Dev2.Common;
using Dev2.Common.ExtMethods;
using Dev2.Common.Interfaces.Diagnostics.Debug;
using Dev2.Common.Interfaces.Toolbox;
using Dev2.Common.State;
using Dev2.Data.Interfaces.Enums;
using Dev2.Data.TO;
using Dev2.DataList.Contract;
using Dev2.Diagnostics;
using Dev2.Interfaces;
using Dev2.Utilities;
using Unlimited.Applications.BusinessDesignStudio.Activities;
using Warewolf.Core;
using Warewolf.Resource.Errors;
using Warewolf.Storage.Interfaces;
using WarewolfParserInterop;

namespace Dev2.Activities
{
    [ToolDescriptorInfo("Utility-SystemInformation", "Sys Info", ToolType.Native, "8999E59A-38A3-43BB-A98F-6090C5C9EA1E", "Dev2.Activities", "1.0.0.0", "Legacy", "Utility", "/Warewolf.Studio.Themes.Luna;component/Images.xaml", "Tool_Utility_Sys_Info")]
    public class DsfDotNetGatherSystemInformationActivity : DsfActivityAbstract<string>, ICollectionActivity
    {
        IGetSystemInformation _getSystemInformation;
        IIdentity _currentIdentity;

        public IList<GatherSystemInformationTO> SystemInformationCollection { get; set; }

        public IGetSystemInformation GetSystemInformation
        {
            get => _getSystemInformation ?? (_getSystemInformation = new GetSystemInformationStandardHelper());
            set
            {
                _getSystemInformation = value;
            }
        }

        public override List<string> GetOutputs() => SystemInformationCollection.Select(to => to.Result).ToList();

        public DsfDotNetGatherSystemInformationActivity()
            : base("Gather System Information")
        {
            SystemInformationCollection = new List<GatherSystemInformationTO>();
        }

        public override IEnumerable<StateVariable> GetState()
        {
            return new[]
            {
                new StateVariable
                {
                    Name="SystemInformationCollection",
                    Type=StateVariable.StateType.InputOutput,
                    Value= ActivityHelper.GetSerializedStateValueFromCollection(SystemInformationCollection)
                }
            };
        }

        void CleanArgs()
        {
            var count = 0;
            while (count < SystemInformationCollection.Count)
            {
                if (string.IsNullOrWhiteSpace(SystemInformationCollection[count].Result))
                {
                    SystemInformationCollection.RemoveAt(count);
                }
                else
                {
                    count++;
                }
            }
        }

        protected override void OnExecute(NativeActivityContext context)
        {
            var dataObject = context.GetExtension<IDSFDataObject>();
            ExecuteTool(dataObject, 0);
        }

        protected override void ExecuteTool(IDSFDataObject dataObject, int update)
        {
            var allErrors = new ErrorResultTO();

            if (dataObject.ExecutingUser != null)
            {
                _currentIdentity = dataObject.ExecutingUser.Identity;
            }
            InitializeDebug(dataObject);
            try
            {
                TryExecute(dataObject, update, allErrors);
            }
            catch (Exception e)
            {
                Dev2Logger.Error("DSFGatherSystemInformationTool", e, GlobalConstants.WarewolfError);
                allErrors.AddError(e.Message);
            }
            finally
            {
                HandleErrors(dataObject, update, allErrors);
            }
        }

        private void TryExecute(IDSFDataObject dataObject, int update, ErrorResultTO allErrors)
        {
            CleanArgs();

            var indexCounter = 0;
            foreach (GatherSystemInformationTO item in SystemInformationCollection)
            {
                try
                {
                    indexCounter++;

                    if (dataObject.IsDebugMode())
                    {
                        var inputToAdd = new DebugItem();
                        AddDebugItem(new DebugItemStaticDataParams("", indexCounter.ToString(CultureInfo.InvariantCulture)), inputToAdd);
                        AddDebugItem(new DebugItemStaticDataParams("", dataObject.Environment.EvalToExpression(item.Result, update), "", "="), inputToAdd);
                        AddDebugItem(new DebugItemStaticDataParams(item.EnTypeOfSystemInformation.GetDescription(), ""), inputToAdd);
                        _debugInputs.Add(inputToAdd);
                    }

                    if (!allErrors.HasErrors())
                    {
                        HandleNoErrorsFound(dataObject, update, allErrors, item);
                    }
                }
                catch (Exception err)
                {
                    dataObject.Environment.Assign(item.Result, null, update);
                    allErrors.AddError(err.Message);
                }
            }
            dataObject.Environment.CommitAssign();
            if (dataObject.IsDebugMode() && !allErrors.HasErrors())
            {
                var innerCount = 1;
                foreach (GatherSystemInformationTO item in SystemInformationCollection)
                {
                    var itemToAdd = new DebugItem();
                    AddDebugItem(new DebugItemStaticDataParams("", "", innerCount.ToString(CultureInfo.InvariantCulture)), itemToAdd);
                    AddDebugItem(new DebugEvalResult(item.Result, "", dataObject.Environment, update), itemToAdd);
                    _debugOutputs.Add(itemToAdd);
                    innerCount++;
                }
            }
        }

        void HandleNoErrorsFound(IDSFDataObject dataObject, int update, ErrorResultTO allErrors, GatherSystemInformationTO item)
        {
            var val = GetCorrectSystemInformation(item.EnTypeOfSystemInformation);
            var expression = item.Result;

            var regions = DataListCleaningUtils.SplitIntoRegions(expression);
            if (regions.Count > 1)
            {
                allErrors.AddError(ErrorResource.MultipleVariablesInResultField);
            }
            else
            {
                foreach (var region in regions)
                {
                    dataObject.Environment.AssignWithFrame(new AssignValue(region, val), update);
                }
            }
        }

        void HandleErrors(IDSFDataObject dataObject, int update, ErrorResultTO allErrors)
        {
            var hasErrors = allErrors.HasErrors();
            if (hasErrors)
            {
                DisplayAndWriteError(nameof(DsfDotNetGatherSystemInformationActivity), allErrors);
                foreach (var error in allErrors.FetchErrors())
                {
                    dataObject.Environment.AddError(error);
                }
            }
            if (dataObject.IsDebugMode())
            {
                if (hasErrors)
                {
                    var innerCount = 1;
                    foreach (GatherSystemInformationTO item in SystemInformationCollection)
                    {
                        var itemToAdd = new DebugItem();
                        AddDebugItem(new DebugItemStaticDataParams("", innerCount.ToString(CultureInfo.InvariantCulture)), itemToAdd);
                        AddDebugItem(new DebugEvalResult(item.Result, "", dataObject.Environment, update), itemToAdd);
                        _debugOutputs.Add(itemToAdd);
                        innerCount++;
                    }
                }

                DispatchDebugState(dataObject, StateType.Before, update);
                DispatchDebugState(dataObject, StateType.After, update);
            }
        }

#pragma warning disable S1541 // Methods and properties should not be too complex
        public string GetCorrectSystemInformation(enTypeOfSystemInformationToGather enTypeOfSystemInformation)
#pragma warning restore S1541 // Methods and properties should not be too complex
        {
            switch (enTypeOfSystemInformation)
            {
                case enTypeOfSystemInformationToGather.ComputerName:
                    return GetSystemInformation.GetComputerName();
                case enTypeOfSystemInformationToGather.OperatingSystem:
                    return GetSystemInformation.GetOperatingSystemInformation();
                case enTypeOfSystemInformationToGather.OperatingSystemVersion:
                    return GetSystemInformation.GetOperatingSystemVersionInformation();
                case enTypeOfSystemInformationToGather.ServicePack:
                    return GetSystemInformation.GetServicePackInformation();
                case enTypeOfSystemInformationToGather.OSBitValue:
                    return GetSystemInformation.GetOSBitValueInformation();
                case enTypeOfSystemInformationToGather.FullDateTime:
                    return GetSystemInformation.GetFullDateTimeInformation();
                case enTypeOfSystemInformationToGather.DateTimeFormat:
                    return GetSystemInformation.GetDateTimeFormatInformation();
                case enTypeOfSystemInformationToGather.DiskAvailable:
                    return GetSystemInformation.GetDiskSpaceAvailableInformation();
                case enTypeOfSystemInformationToGather.DiskTotal:
                    return GetSystemInformation.GetDiskSpaceTotalInformation();
                case enTypeOfSystemInformationToGather.VirtualMemoryAvailable:
                    return GetSystemInformation.GetVirtualMemoryAvailableInformation();
                case enTypeOfSystemInformationToGather.VirtualMemoryTotal:
                    return GetSystemInformation.GetVirtualMemoryTotalInformation();
                case enTypeOfSystemInformationToGather.PhysicalMemoryAvailable:
                    return GetSystemInformation.GetPhysicalMemoryAvailableInformation();
                case enTypeOfSystemInformationToGather.PhysicalMemoryTotal:
                    return GetSystemInformation.GetPhysicalMemoryTotalInformation();
                case enTypeOfSystemInformationToGather.CPUAvailable:
                    return GetSystemInformation.GetCPUAvailableInformation();
                case enTypeOfSystemInformationToGather.CPUTotal:
                    return GetSystemInformation.GetCPUTotalInformation();
                case enTypeOfSystemInformationToGather.Language:
                    return GetSystemInformation.GetLanguageInformation();
                case enTypeOfSystemInformationToGather.Region:
                    return GetSystemInformation.GetRegionInformation();
                case enTypeOfSystemInformationToGather.UserRoles:
                    return GetSystemInformation.GetUserRolesInformation(_currentIdentity);
                case enTypeOfSystemInformationToGather.UserName:
                    return GetSystemInformation.GetUserNameInformation();
                case enTypeOfSystemInformationToGather.Domain:
                    return GetSystemInformation.GetDomainInformation();
                case enTypeOfSystemInformationToGather.NumberOfServerNICS:
                    return GetSystemInformation.GetNumberOfNICS();
                case enTypeOfSystemInformationToGather.MacAddress:
                    return GetSystemInformation.GetMACAdresses();
                case enTypeOfSystemInformationToGather.GateWayAddress:
                    return GetSystemInformation.GetDefaultGateway();
                case enTypeOfSystemInformationToGather.DNSAddress:
                    return GetSystemInformation.GetDNSServer();
                case enTypeOfSystemInformationToGather.IPv4Address:
                    return GetSystemInformation.GetIPv4Adresses();
                case enTypeOfSystemInformationToGather.IPv6Address:
                    return GetSystemInformation.GetIPv6Adresses();
                case enTypeOfSystemInformationToGather.WarewolfMemory:
                    return GetSystemInformation.GetWarewolfServerMemory();
                case enTypeOfSystemInformationToGather.WarewolfCPU:
                    return GetSystemInformation.GetWarewolfCPU();
                case enTypeOfSystemInformationToGather.WarewolfServerVersion:
                    return GetSystemInformation.GetWareWolfVersion();
                default:
                    throw new ArgumentOutOfRangeException("enTypeOfSystemInformation");
            }
        }

        public override IList<DsfForEachItem> GetForEachInputs()
        {
            var enumerable = SystemInformationCollection.Select(to => to.Result);
            return GetForEachItems(enumerable.ToArray());
        }

        public override IList<DsfForEachItem> GetForEachOutputs()
        {
            var enumerable = SystemInformationCollection.Select(to => to.Result);
            return GetForEachItems(enumerable.ToArray());
        }

        public override enFindMissingType GetFindMissingType() => enFindMissingType.DataGridActivity;

        public override void UpdateForEachInputs(IList<Tuple<string, string>> updates)
        {
            if (updates != null)
            {
                foreach (Tuple<string, string> t in updates)
                {
                    var t1 = t;
                    var items = SystemInformationCollection.Where(c => !string.IsNullOrEmpty(c.Result) && c.Result.Equals(t1.Item1));

                    foreach (var a in items)
                    {
                        a.Result = t.Item2;
                    }
                }
            }
        }

        public override void UpdateForEachOutputs(IList<Tuple<string, string>> updates)
        {
            if (updates != null)
            {
                foreach (Tuple<string, string> t in updates)
                {
                    var t1 = t;
                    var items = SystemInformationCollection.Where(c => !string.IsNullOrEmpty(c.Result) && c.Result.Equals(t1.Item1));

                    foreach (var a in items)
                    {
                        a.Result = t.Item2;
                    }
                }
            }
        }

        public override List<DebugItem> GetDebugInputs(IExecutionEnvironment env, int update) => _debugInputs;

        public override List<DebugItem> GetDebugOutputs(IExecutionEnvironment env, int update)
        {
            foreach (IDebugItem debugOutput in _debugOutputs)
            {
                debugOutput.FlushStringBuilder();
            }
            return _debugOutputs;
        }

        void InsertToCollection(IEnumerable<string> listToAdd, ModelItem modelItem)
        {
            var modelProperty = modelItem.Properties["SystemInformationCollection"];
            var mic = modelProperty?.Collection;
            if (mic == null)
            {
                return;
            }
            var listOfValidRows = SystemInformationCollection.Where(c => !c.CanRemove()).ToList();
            if (listOfValidRows.Count > 0)
            {
                var gatherSystemInformationTo = SystemInformationCollection.Last(c => !c.CanRemove());
                var startIndex = SystemInformationCollection.IndexOf(gatherSystemInformationTo) + 1;
                foreach (string s in listToAdd)
                {
                    mic.Insert(startIndex, new GatherSystemInformationTO(SystemInformationCollection[startIndex - 1].EnTypeOfSystemInformation, s, startIndex + 1));
                    startIndex++;
                }
                CleanUpCollection(mic, modelItem, startIndex);
            }
            else
            {
                AddToCollection(listToAdd, modelItem);
            }
        }

        void AddToCollection(IEnumerable<string> listToAdd, ModelItem modelItem)
        {
            var modelProperty = modelItem.Properties["SystemInformationCollection"];
            var mic = modelProperty?.Collection;
            if (mic == null)
            {
                return;
            }
            var startIndex = 0;
            const enTypeOfSystemInformationToGather EnTypeOfSystemInformation = enTypeOfSystemInformationToGather.FullDateTime;
            mic.Clear();
            foreach (string s in listToAdd)
            {
                mic.Add(new GatherSystemInformationTO(EnTypeOfSystemInformation, s, startIndex + 1));
                startIndex++;
            }
            CleanUpCollection(mic, modelItem, startIndex);
        }

        void CleanUpCollection(ModelItemCollection mic, ModelItem modelItem, int startIndex)
        {
            if (startIndex < mic.Count)
            {
                mic.RemoveAt(startIndex);
            }
            mic.Add(new GatherSystemInformationTO(enTypeOfSystemInformationToGather.FullDateTime, string.Empty, startIndex + 1));
            var modelProperty = modelItem.Properties["DisplayName"];
            modelProperty?.SetValue(CreateDisplayName(modelItem, startIndex + 1));
        }

        string CreateDisplayName(ModelItem modelItem, int count)
        {
            var modelProperty = modelItem.Properties["DisplayName"];
            if (modelProperty != null)
            {
                var currentName = modelProperty.ComputedValue as string;
                if (currentName != null && currentName.Contains("(") && currentName.Contains(")"))
                {
                    currentName = currentName.Remove(currentName.Contains(" (") ? currentName.IndexOf(" (", StringComparison.Ordinal) : currentName.IndexOf("(", StringComparison.Ordinal));
                }
                currentName = currentName + " (" + (count - 1) + ")";
                return currentName;
            }

            return string.Empty;
        }

        public int GetCollectionCount() => SystemInformationCollection.Count(caseConvertTo => !caseConvertTo.CanRemove());

        public void AddListToCollection(IList<string> listToAdd, bool overwrite, ModelItem modelItem)
        {
            if (!overwrite)
            {
                InsertToCollection(listToAdd, modelItem);
            }
            else
            {
                AddToCollection(listToAdd, modelItem);
            }
        }

        public bool Equals(DsfDotNetGatherSystemInformationActivity other)
        {
            var eq = base.Equals(other);
            eq &= DisplayName.Equals(other.DisplayName);
            if (!(_getSystemInformation is null))
            {
                eq &= _getSystemInformation.Equals(other._getSystemInformation);
            }
            if (!(_currentIdentity is null)) {
                eq &= _currentIdentity.Equals(other._currentIdentity);
            }

            return eq;
        }

        public override bool Equals(object obj)
        {
            if (obj is DsfDotNetGatherSystemInformationActivity instance)
            {
                return Equals(instance);
            }
            return false;
        }
    }
}

---- Transformed Tree ----
using System;
using System.Activities;
using System.Activities.Presentation.Model;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using System.Security.Principal;
using Dev2.Activities.Debug;
using Dev2.Common;
using Dev2.Common.ExtMethods;
using Dev2.Common.Interfaces.Diagnostics.Debug;
using Dev2.Common.Interfaces.Toolbox;
using Dev2.Common.State;
using Dev2.Data.Interfaces.Enums;
using Dev2.Data.TO;
using Dev2.DataList.Contract;
using Dev2.Diagnostics;
using Dev2.Interfaces;
using Dev2.Utilities;
using Unlimited.Applications.BusinessDesignStudio.Activities;
using Warewolf.Core;
using Warewolf.Resource.Errors;
using Warewolf.Storage.Interfaces;
using WarewolfParserInterop;

namespace Dev2.Activities
{
    [ToolDescriptorInfo("Utility-SystemInformation", "Sys Info", ToolType.Native, "8999E59A-38A3-43BB-A98F-6090C5C9EA1E", "Dev2.Activities", "1.0.0.0", "Legacy", "Utility", "/Warewolf.Studio.Themes.Luna;component/Images.xaml", "Tool_Utility_Sys_Info")]
    public class DsfDotNetGatherSystemInformationActivity : DsfActivityAbstract<string>, ICollectionActivity
    {
        IGetSystemInformation _getSystemInformation;
        IIdentity _currentIdentity;

        public IList<GatherSystemInformationTO> SystemInformationCollection { get; set; }

        public IGetSystemInformation GetSystemInformation
        {
            get => _getSystemInformation ?? (_getSystemInformation = new GetSystemInformationStandardHelper());
            set
            {
                _getSystemInformation = value;
            }
        }

        public override List<string> GetOutputs() => SystemInformationCollection.Select(to => to.Result).ToList();

        public DsfDotNetGatherSystemInformationActivity()
            : base("Gather System Information")
        {
            SystemInformationCollection = new List<GatherSystemInformationTO>();
        }

        public override IEnumerable<StateVariable> GetState()
        {
            return new[]
            {
                new StateVariable
                {
                    Name="SystemInformationCollection",
                    Type=StateVariable.StateType.InputOutput,
                    Value= ActivityHelper.GetSerializedStateValueFromCollection(SystemInformationCollection)
                }
            };
        }

        void CleanArgs()
        {
            var count = 0;
            while (count < SystemInformationCollection.Count)
            {
                if (string.IsNullOrWhiteSpace(SystemInformationCollection[count].Result))
                {
                    SystemInformationCollection.RemoveAt(count);
                }
                else
                {
                    count++;
                }
            }
        }

        protected override void OnExecute(NativeActivityContext context)
        {
            var dataObject = context.GetExtension<IDSFDataObject>();
            ExecuteTool(dataObject, 0);
        }

        protected override void ExecuteTool(IDSFDataObject dataObject, int update)
        {
            var allErrors = new ErrorResultTO();

            if (dataObject.ExecutingUser != null)
            {
                _currentIdentity = dataObject.ExecutingUser.Identity;
            }
            InitializeDebug(dataObject);
            try
            {
                TryExecute(dataObject, update, allErrors);
            }
            catch (Exception e)
            {
                Dev2Logger.Error("DSFGatherSystemInformationTool", e, GlobalConstants.WarewolfError);
                allErrors.AddError(e.Message);
            }
            finally
            {
                HandleErrors(dataObject, update, allErrors);
            }
        }

        private void TryExecute(IDSFDataObject dataObject, int update, ErrorResultTO allErrors)
        {
            CleanArgs();

            var indexCounter = 0;
            foreach (GatherSystemInformationTO item in SystemInformationCollection)
            {
                try
                {
                    indexCounter++;

                    if (dataObject.IsDebugMode())
                    {
                        var inputToAdd = new DebugItem();
                        AddDebugItem(new DebugItemStaticDataParams("", indexCounter.ToString(CultureInfo.InvariantCulture)), inputToAdd);
                        AddDebugItem(new DebugItemStaticDataParams("", dataObject.Environment.EvalToExpression(item.Result, update), "", "="), inputToAdd);
                        AddDebugItem(new DebugItemStaticDataParams(item.EnTypeOfSystemInformation.GetDescription(), ""), inputToAdd);
                        _debugInputs.Add(inputToAdd);
                    }

                    if (!allErrors.HasErrors())
                    {
                        HandleNoErrorsFound(dataObject, update, allErrors, item);
                    }
                }
                catch (Exception err)
                {
                    dataObject.Environment.Assign(item.Result, null, update);
                    allErrors.AddError(err.Message);
                }
            }
            dataObject.Environment.CommitAssign();
            if (dataObject.IsDebugMode() && !allErrors.HasErrors())
            {
                var innerCount = 1;
                foreach (GatherSystemInformationTO item in SystemInformationCollection)
                {
                    var itemToAdd = new DebugItem();
                    AddDebugItem(new DebugItemStaticDataParams("", "", innerCount.ToString(CultureInfo.InvariantCulture)), itemToAdd);
                    AddDebugItem(new DebugEvalResult(item.Result, "", dataObject.Environment, update), itemToAdd);
                    _debugOutputs.Add(itemToAdd);
                    innerCount++;
                }
            }
        }

        void HandleNoErrorsFound(IDSFDataObject dataObject, int update, ErrorResultTO allErrors, GatherSystemInformationTO item)
        {
            var val = GetCorrectSystemInformation(item.EnTypeOfSystemInformation);
            var expression = item.Result;

            var regions = DataListCleaningUtils.SplitIntoRegions(expression);
            if (regions.Count > 1)
            {
                allErrors.AddError(ErrorResource.MultipleVariablesInResultField);
            }
            else
            {
                foreach (var region in regions)
                {
                    dataObject.Environment.AssignWithFrame(new AssignValue(region, val), update);
                }
            }
        }

        void HandleErrors(IDSFDataObject dataObject, int update, ErrorResultTO allErrors)
        {
            var hasErrors = allErrors.HasErrors();
            if (hasErrors)
            {
                DisplayAndWriteError(nameof(DsfDotNetGatherSystemInformationActivity), allErrors);
                foreach (var error in allErrors.FetchErrors())
                {
                    dataObject.Environment.AddError(error);
                }
            }
            if (dataObject.IsDebugMode())
            {
                if (hasErrors)
                {
                    var innerCount = 1;
                    foreach (GatherSystemInformationTO item in SystemInformationCollection)
                    {
                        var itemToAdd = new DebugItem();
                        AddDebugItem(new DebugItemStaticDataParams("", innerCount.ToString(CultureInfo.InvariantCulture)), itemToAdd);
                        AddDebugItem(new DebugEvalResult(item.Result, "", dataObject.Environment, update), itemToAdd);
                        _debugOutputs.Add(itemToAdd);
                        innerCount++;
                    }
                }

                DispatchDebugState(dataObject, StateType.Before, update);
                DispatchDebugState(dataObject, StateType.After, update);
            }
        }

#pragma warning disable S1541 // Methods and properties should not be too complex
        public string GetCorrectSystemInformation(enTypeOfSystemInformationToGather enTypeOfSystemInformation)
#pragma warning restore S1541 // Methods and properties should not be too complex
        {
            switch (enTypeOfSystemInformation)
            {
                case enTypeOfSystemInformationToGather.ComputerName:
                    return GetSystemInformation.GetComputerName();
                case enTypeOfSystemInformationToGather.OperatingSystem:
                    return GetSystemInformation.GetOperatingSystemInformation();
                case enTypeOfSystemInformationToGather.OperatingSystemVersion:
                    return GetSystemInformation.GetOperatingSystemVersionInformation();
                case enTypeOfSystemInformationToGather.ServicePack:
                    return GetSystemInformation.GetServicePackInformation();
                case enTypeOfSystemInformationToGather.OSBitValue:
                    return GetSystemInformation.GetOSBitValueInformation();
                case enTypeOfSystemInformationToGather.FullDateTime:
                    return GetSystemInformation.GetFullDateTimeInformation();
                case enTypeOfSystemInformationToGather.DateTimeFormat:
                    return GetSystemInformation.GetDateTimeFormatInformation();
                case enTypeOfSystemInformationToGather.DiskAvailable:
                    return GetSystemInformation.GetDiskSpaceAvailableInformation();
                case enTypeOfSystemInformationToGather.DiskTotal:
                    return GetSystemInformation.GetDiskSpaceTotalInformation();
                case enTypeOfSystemInformationToGather.VirtualMemoryAvailable:
                    return GetSystemInformation.GetVirtualMemoryAvailableInformation();
                case enTypeOfSystemInformationToGather.VirtualMemoryTotal:
                    return GetSystemInformation.GetVirtualMemoryTotalInformation();
                case enTypeOfSystemInformationToGather.PhysicalMemoryAvailable:
                    return GetSystemInformation.GetPhysicalMemoryAvailableInformation();
                case enTypeOfSystemInformationToGather.PhysicalMemoryTotal:
                    return GetSystemInformation.GetPhysicalMemoryTotalInformation();
                case enTypeOfSystemInformationToGather.CPUAvailable:
                    return GetSystemInformation.GetCPUAvailableInformation();
                case enTypeOfSystemInformationToGather.CPUTotal:
                    return GetSystemInformation.GetCPUTotalInformation();
                case enTypeOfSystemInformationToGather.Language:
                    return GetSystemInformation.GetLanguageInformation();
                case enTypeOfSystemInformationToGather.Region:
                    return GetSystemInformation.GetRegionInformation();
                case enTypeOfSystemInformationToGather.UserRoles:
                    return GetSystemInformation.GetUserRolesInformation(_currentIdentity);
                case enTypeOfSystemInformationToGather.UserName:
                    return GetSystemInformation.GetUserNameInformation();
                case enTypeOfSystemInformationToGather.Domain:
                    return GetSystemInformation.GetDomainInformation();
                case enTypeOfSystemInformationToGather.NumberOfServerNICS:
                    return GetSystemInformation.GetNumberOfNICS();
                case enTypeOfSystemInformationToGather.MacAddress:
                    return GetSystemInformation.GetMACAdresses();
                case enTypeOfSystemInformationToGather.GateWayAddress:
                    return GetSystemInformation.GetDefaultGateway();
                case enTypeOfSystemInformationToGather.DNSAddress:
                    return GetSystemInformation.GetDNSServer();
                case enTypeOfSystemInformationToGather.IPv4Address:
                    return GetSystemInformation.GetIPv4Adresses();
                case enTypeOfSystemInformationToGather.IPv6Address:
                    return GetSystemInformation.GetIPv6Adresses();
                case enTypeOfSystemInformationToGather.WarewolfMemory:
                    return GetSystemInformation.GetWarewolfServerMemory();
                case enTypeOfSystemInformationToGather.WarewolfCPU:
                    return GetSystemInformation.GetWarewolfCPU();
                case enTypeOfSystemInformationToGather.WarewolfServerVersion:
                    return GetSystemInformation.GetWareWolfVersion();
                default:
                    throw new ArgumentOutOfRangeException("enTypeOfSystemInformation");
            }
        }

        public override IList<DsfForEachItem> GetForEachInputs()
        {
            var enumerable = SystemInformationCollection.Select(to => to.Result);
            return GetForEachItems(enumerable.ToArray());
        }

        public override IList<DsfForEachItem> GetForEachOutputs()
        {
            var enumerable = SystemInformationCollection.Select(to => to.Result);
            return GetForEachItems(enumerable.ToArray());
        }

        public override enFindMissingType GetFindMissingType() => enFindMissingType.DataGridActivity;

        public override void UpdateForEachInputs(IList<Tuple<string, string>> updates)
        {
            if (updates != null)
            {
                foreach (Tuple<string, string> t in updates)
                {
                    var t1 = t;
                    var items = SystemInformationCollection.Where(c => !string.IsNullOrEmpty(c.Result) && c.Result.Equals(t1.Item1));

                    foreach (var a in items)
                    {
                        a.Result = t.Item2;
                    }
                }
            }
        }

        public override void UpdateForEachOutputs(IList<Tuple<string, string>> updates)
        {
            if (updates != null)
            {
                foreach (Tuple<string, string> t in updates)
                {
                    var t1 = t;
                    var items = SystemInformationCollection.Where(c => !string.IsNullOrEmpty(c.Result) && c.Result.Equals(t1.Item1));

                    foreach (var a in items)
                    {
                        a.Result = t.Item2;
                    }
                }
            }
        }

        public override List<DebugItem> GetDebugInputs(IExecutionEnvironment env, int update) => _debugInputs;

        public override List<DebugItem> GetDebugOutputs(IExecutionEnvironment env, int update)
        {
            foreach (IDebugItem debugOutput in _debugOutputs)
            {
                debugOutput.FlushStringBuilder();
            }
            return _debugOutputs;
        }

        void InsertToCollection(IEnumerable<string> listToAdd, ModelItem modelItem)
        {
            var modelProperty = modelItem.Properties["SystemInformationCollection"];
            var mic = modelProperty?.Collection;
            if (mic == null)
            {
                return;
            }
            var listOfValidRows = SystemInformationCollection.Where(c => !c.CanRemove()).ToList();
            if (listOfValidRows.Count > 0)
            {
                var gatherSystemInformationTo = SystemInformationCollection.Last(c => !c.CanRemove());
                var startIndex = SystemInformationCollection.IndexOf(gatherSystemInformationTo) + 1;
                foreach (string s in listToAdd)
                {
                    mic.Insert(startIndex, new GatherSystemInformationTO(SystemInformationCollection[startIndex - 1].EnTypeOfSystemInformation, s, startIndex + 1));
                    startIndex++;
                }
                CleanUpCollection(mic, modelItem, startIndex);
            }
            else
            {
                AddToCollection(listToAdd, modelItem);
            }
        }

        void AddToCollection(IEnumerable<string> listToAdd, ModelItem modelItem)
        {
            var modelProperty = modelItem.Properties["SystemInformationCollection"];
            var mic = modelProperty?.Collection;
            if (mic == null)
            {
                return;
            }
            var startIndex = 0;
            const enTypeOfSystemInformationToGather EnTypeOfSystemInformation = enTypeOfSystemInformationToGather.FullDateTime;
            mic.Clear();
            foreach (string s in listToAdd)
            {
                mic.Add(new GatherSystemInformationTO(EnTypeOfSystemInformation, s, startIndex + 1));
                startIndex++;
            }
            CleanUpCollection(mic, modelItem, startIndex);
        }

        void CleanUpCollection(ModelItemCollection mic, ModelItem modelItem, int startIndex)
        {
            if (startIndex < mic.Count)
            {
                mic.RemoveAt(startIndex);
            }
            mic.Add(new GatherSystemInformationTO(enTypeOfSystemInformationToGather.FullDateTime, string.Empty, startIndex + 1));
            var modelProperty = modelItem.Properties["DisplayName"];
            modelProperty?.SetValue(CreateDisplayName(modelItem, startIndex + 1));
        }

        string CreateDisplayName(ModelItem modelItem, int count)
        {
            var modelProperty = modelItem.Properties["DisplayName"];
            if (modelProperty != null)
            {
                if (modelProperty.ComputedValue is string currentName && currentName.Contains("(") && currentName.Contains(")"))
                {
                    currentName = currentName.Remove(currentName.Contains(" (") ? currentName.IndexOf(" (", StringComparison.Ordinal) : currentName.IndexOf("(", StringComparison.Ordinal));
                }
                currentName = currentName + " (" + (count - 1) + ")";
                return currentName;
            }

            return string.Empty;
        }

        public int GetCollectionCount() => SystemInformationCollection.Count(caseConvertTo => !caseConvertTo.CanRemove());

        public void AddListToCollection(IList<string> listToAdd, bool overwrite, ModelItem modelItem)
        {
            if (!overwrite)
            {
                InsertToCollection(listToAdd, modelItem);
            }
            else
            {
                AddToCollection(listToAdd, modelItem);
            }
        }

        public bool Equals(DsfDotNetGatherSystemInformationActivity other)
        {
            var eq = base.Equals(other);
            eq &= DisplayName.Equals(other.DisplayName);
            if (!(_getSystemInformation is null))
            {
                eq &= _getSystemInformation.Equals(other._getSystemInformation);
            }
            if (!(_currentIdentity is null)) {
                eq &= _currentIdentity.Equals(other._currentIdentity);
            }

            return eq;
        }

        public override bool Equals(object obj)
        {
            if (obj is DsfDotNetGatherSystemInformationActivity instance)
            {
                return Equals(instance);
            }
            return false;
        }
    }
}

---- Semantic diagnostics *before* transformation ----

---- Semantic diagnostics *after* transformation ----
D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDotNetGatherSystemInformationActivity.cs(412,31): error CS0165: Use of unassigned local variable 'currentName'
######################################################################


######################################################################
Nr: 2 - UsePatternMatchingRewriterR8
Filepath: D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs
Description: Error: The created Syntax Tree is semantically incorrect.
------------------------------------------------------------------------
---- Original Tree ----
using System;
using System.Activities;
using System.Activities.Presentation.Model;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using Dev2;
using Dev2.Activities;
using Dev2.Activities.Debug;
using Dev2.Common;
using Dev2.Common.Interfaces.Diagnostics.Debug;
using Dev2.Common.Interfaces.Toolbox;
using Dev2.Data.TO;
using Dev2.Data.Util;
using Dev2.DataList;
using Dev2.DataList.Contract;
using Dev2.Diagnostics;
using Dev2.Interfaces;
using Dev2.Util;
using Unlimited.Applications.BusinessDesignStudio.Activities.Utilities;
using Warewolf.Core;
using Warewolf.Resource.Errors;
using Warewolf.Storage.Interfaces;
using Dev2.Comparer;
using Dev2.Common.Interfaces.Data.TO;
using Dev2.Common.State;
using Dev2.Utilities;

namespace Unlimited.Applications.BusinessDesignStudio.Activities

{
    /// <New>
    /// Activity for finding records accoring to a search criteria that the user specifies
    /// </New>
    [ToolDescriptorInfo("RecordSet-FindRecords", "Find Records", ToolType.Native, "8999E59A-38A3-43BB-A98F-6090C5C9EA1E", "Dev2.Activities", "1.0.0.0", "Legacy", "Recordset", "/Warewolf.Studio.Themes.Luna;component/Images.xaml", "Tool_Recordset_Find_Records")]
    public class DsfFindRecordsMultipleCriteriaActivity : DsfActivityAbstract<string>, ICollectionActivity, IEquatable<DsfFindRecordsMultipleCriteriaActivity>
    {
        #region Properties

        /// <summary>
        /// Property for holding a string the user enters into the "In Fields" box
        /// </summary>
        [Inputs("FieldsToSearch")]
        [FindMissing]
        public string FieldsToSearch { get; set; }


        /// <summary>
        /// Property for holding a string the user enters into the "Result" box
        /// </summary>
        [Outputs("Result")]
        [FindMissing]
        public new string Result { get; set; }

        /// <summary>
        /// Property for holding a string the user enters into the "Start Index" box
        /// </summary>
        [Inputs("StartIndex")]
        [FindMissing]
        public string StartIndex { get; set; }

        /// <summary>
        /// Property for holding a bool the user chooses with the "MatchCase" Checkbox
        /// </summary>
        [Inputs("MatchCase")]
        public bool MatchCase { get; set; }

        public bool RequireAllTrue { get; set; }

        public bool RequireAllFieldsToMatch { get; set; }
        #endregion Properties

        #region Ctor

        public DsfFindRecordsMultipleCriteriaActivity()
            : base("Find Record Index")
        {
            // Initialise all the properties here
            ResultsCollection = new List<FindRecordsTO>();
            FieldsToSearch = string.Empty;
            Result = string.Empty;
            StartIndex = string.Empty;
            RequireAllTrue = true;
            RequireAllFieldsToMatch = false;
        }

        #endregion Ctor

        public override IEnumerable<StateVariable> GetState()
        {
            return new[] {
                new StateVariable
                {
                    Name = "ResultsCollection",
                    Value = ActivityHelper.GetSerializedStateValueFromCollection(ResultsCollection),
                    Type = StateVariable.StateType.Input
                },
                new StateVariable
                {
                    Name = "FieldsToSearch",
                    Value = FieldsToSearch,
                    Type = StateVariable.StateType.Input
                },
                new StateVariable
                {
                    Name = "RequireAllTrue",
                    Value = RequireAllTrue.ToString(),
                    Type = StateVariable.StateType.Input
                },
                new StateVariable
                {
                    Name = "RequireAllFieldsToMatch",
                    Value = RequireAllFieldsToMatch.ToString(),
                    Type = StateVariable.StateType.Input
                },
                new StateVariable
                {
                    Name="Result",
                    Value = Result,
                    Type = StateVariable.StateType.Output
                }
            };
        }

        public override List<string> GetOutputs() => new List<string> { Result };

        protected override void OnExecute(NativeActivityContext context)
        {
            var dataObject = context.GetExtension<IDSFDataObject>();
            ExecuteTool(dataObject, 0);
        }

        protected override void ExecuteTool(IDSFDataObject dataObject, int update)
        {
            var searchQuery = new SearchQuery(this, Result, RequireAllFieldsToMatch, RequireAllTrue);

            var allErrors = new ErrorResultTO();
            try
            {
                InitializeDebug(dataObject);
                var searchContext = new SearchContext(this);
                if (dataObject.IsDebugMode())
                {
                    TryAddDebugInputValues(dataObject, searchContext.ToSearch, ref allErrors, update);
                }

                searchQuery.Execute(searchContext, allErrors, dataObject, update);

                if (dataObject.IsDebugMode())
                {
                    if (DataListUtil.IsValueRecordset(Result))
                    {
                        var recVar = DataListUtil.ReplaceRecordsetBlankWithStar(Result);
                        AddDebugOutputItem(new DebugEvalResult(recVar, "", dataObject.Environment, update));
                    }
                    else
                    {
                        AddDebugOutputItem(new DebugEvalResult(Result, "", dataObject.Environment, update));
                    }
                }
            }
            catch (Exception exception)
            {
                Dev2Logger.Error("DSFRecordsMultipleCriteria", exception, GlobalConstants.WarewolfError);
                allErrors.AddError(exception.Message);
            }
            finally
            {
                var hasErrors = allErrors.HasErrors();
                if (hasErrors)
                {
                    DisplayAndWriteError("DsfFindRecordsMultipleCriteriaActivity", allErrors);
                    var errorString = allErrors.MakeDisplayReady();
                    dataObject.Environment.AddError(errorString);
                    dataObject.Environment.Assign(Result, "-1", update);
                    if (dataObject.IsDebugMode())
                    {
                        AddDebugOutputItem(new DebugEvalResult(Result, "", dataObject.Environment, update));
                    }
                }

                if (dataObject.IsDebugMode())
                {
                    DispatchDebugState(dataObject, StateType.Before, update);
                    DispatchDebugState(dataObject, StateType.After, update);
                }
            }
        }

        internal void SetErrorsTO(ErrorResultTO errorTo)
        {
            _errorsTo = errorTo;
        }

        public override enFindMissingType GetFindMissingType() => enFindMissingType.MixedActivity;

        void TryAddDebugInputValues(IDSFDataObject dataObject, IEnumerable<string> toSearch, ref ErrorResultTO errorTos, int update)
        {
            if (dataObject.IsDebugMode())
            {
                try
                {
                    AddDebugInputValues(dataObject, toSearch, update);
                }
                catch (Exception e)
                {
                    errorTos.AddError(e.Message);
                }
            }
        }

        private void AddDebugInputValues(IDSFDataObject dataObject, IEnumerable<string> toSearch, int update)
        {
            var debugItem = new DebugItem();
            AddDebugItem(new DebugItemStaticDataParams("", "In Field(s)"), debugItem);
            foreach (var s in toSearch)
            {
                var searchFields = s;
                if (DataListUtil.IsValueRecordset(s))
                {
                    searchFields = searchFields.Replace("()", "(*)");
                }
                AddDebugItem(new DebugEvalResult(searchFields, "", dataObject.Environment, update), debugItem);
            }
            _debugInputs.Add(debugItem);
            AddResultDebugInputs(ResultsCollection, dataObject.Environment, update);
            AddDebugInputItem(new DebugItemStaticDataParams(RequireAllFieldsToMatch ? "YES" : "NO", "Require All Fields To Match"));
            AddDebugInputItem(new DebugItemStaticDataParams(RequireAllTrue ? "YES" : "NO", "Require All Matches To Be True"));
        }

        #region Overrides of DsfNativeActivity<string>

        public override List<DebugItem> GetDebugOutputs(IExecutionEnvironment env, int update)
        {
            return _debugOutputs;
        }

        #endregion

        #region Private Methods

        void AddResultDebugInputs(IEnumerable<FindRecordsTO> resultsCollection, IExecutionEnvironment environment, int update)
        {
            var indexCount = 1;
            foreach (var findRecordsTo in resultsCollection)
            {
                var debugItem = new DebugItem();
                if (!String.IsNullOrEmpty(findRecordsTo.SearchType))
                {
                    AddDebugItem(new DebugItemStaticDataParams("", indexCount.ToString(CultureInfo.InvariantCulture)), debugItem);
                    AddDebugItem(new DebugItemStaticDataParams(findRecordsTo.SearchType, ""), debugItem);

                    if (!string.IsNullOrEmpty(findRecordsTo.SearchCriteria))
                    {
                        AddDebugItem(new DebugEvalResult(findRecordsTo.SearchCriteria, "", environment, update, ""), debugItem);
                    }

                    if (findRecordsTo.SearchType == "Is Between" || findRecordsTo.SearchType == "Not Between")
                    {
                        AddDebugItem(new DebugEvalResult(findRecordsTo.From, "", environment, update), debugItem);

                        AddDebugItem(new DebugEvalResult(findRecordsTo.To, " And", environment, update), debugItem);
                    }

                    _debugInputs.Add(debugItem);
                    indexCount++;
                }
            }
        }

        void InsertToCollection(IEnumerable<string> listToAdd, ModelItem modelItem)
        {
            var modelProperty = modelItem.Properties["ResultsCollection"];
            if (modelProperty == null)
            {
                return;
            }
            var mic = modelProperty.Collection;

            if (mic == null)
            {
                return;
            }
            var listOfValidRows = ResultsCollection.Where(c => !c.CanRemove()).ToList();
            if (listOfValidRows.Count > 0)
            {
                var findRecordsTo = ResultsCollection.Last(c => !c.CanRemove());
                var startIndex = ResultsCollection.IndexOf(findRecordsTo) + 1;
                foreach (var s in listToAdd)
                {
                    mic.Insert(startIndex, new FindRecordsTO(s, ResultsCollection[startIndex - 1].SearchType, startIndex + 1));
                    startIndex++;
                }
                CleanUpCollection(mic, modelItem, startIndex);
            }
            else
            {
                AddToCollection(listToAdd, modelItem);
            }
        }

        void AddToCollection(IEnumerable<string> listToAdd, ModelItem modelItem)
        {
            var modelProperty = modelItem.Properties["ResultsCollection"];
            if (modelProperty == null)
            {
                return;
            }
            var mic = modelProperty.Collection;

            if (mic == null)
            {
                return;
            }
            var startIndex = 0;
            var searchType = ResultsCollection[0].SearchType;
            mic.Clear();
            foreach (var s in listToAdd)
            {
                mic.Add(new FindRecordsTO(s, searchType, startIndex + 1));
                startIndex++;
            }
            CleanUpCollection(mic, modelItem, startIndex);
        }

        static void CleanUpCollection(ModelItemCollection mic, ModelItem modelItem, int startIndex)
        {
            if (startIndex < mic.Count)
            {
                mic.RemoveAt(startIndex);
            }
            mic.Add(new XPathDTO(string.Empty, "", startIndex + 1));
            var modelProperty = modelItem.Properties["DisplayName"];
            modelProperty?.SetValue(CreateDisplayName(modelItem, startIndex + 1));
        }

        static string CreateDisplayName(ModelItem modelItem, int count)
        {
            var modelProperty = modelItem.Properties["DisplayName"];
            if (modelProperty == null)
            {
                return "";
            }
            var currentName = modelProperty.ComputedValue as string;
            if (currentName != null && currentName.Contains("(") && currentName.Contains(")"))
            {
                currentName = currentName.Remove(currentName.Contains(" (") ? currentName.IndexOf(" (", StringComparison.Ordinal) : currentName.IndexOf("(", StringComparison.Ordinal));
            }
            currentName = currentName + " (" + (count - 1) + ")";
            return currentName;
        }

        #endregion Private Methods

        #region Get Debug Inputs/Outputs

        public override List<DebugItem> GetDebugInputs(IExecutionEnvironment env, int update)
        {
            foreach (IDebugItem debugInput in _debugInputs)
            {
                debugInput.FlushStringBuilder();
            }
            return _debugInputs;
        }


        #endregion Get Inputs/Outputs

        #region Get ForEach Inputs/Ouputs

        public override void UpdateForEachInputs(IList<Tuple<string, string>> updates)
        {
            if (updates != null)
            {
                foreach (Tuple<string, string> t in updates)
                {
                    // locate all updates for this tuple
                    var t1 = t;
                    var items = ResultsCollection.Where(c => !string.IsNullOrEmpty(c.SearchCriteria) && c.SearchCriteria.Equals(t1.Item1));

                    // issues updates
                    foreach (var a in items)
                    {
                        a.SearchCriteria = t.Item2;
                    }

                    if (FieldsToSearch == t.Item1)
                    {
                        FieldsToSearch = t.Item2;
                    }
                }
            }
        }

        public override void UpdateForEachOutputs(IList<Tuple<string, string>> updates)
        {
            if (updates != null)
            {
                foreach (var t in updates)
                {
                    if (Result == t.Item1)
                    {
                        Result = t.Item2;
                    }
                }
            }
        }

        #endregion

        #region GetForEachInputs/Outputs

        public override IList<DsfForEachItem> GetForEachInputs()
        {
            var items = new[] { FieldsToSearch }.Union(ResultsCollection.Where(c => !string.IsNullOrEmpty(c.SearchCriteria)).Select(c => c.SearchCriteria)).ToArray();
            return GetForEachItems(items);
        }

        public override IList<DsfForEachItem> GetForEachOutputs()
        {
            var items = Result;
            return GetForEachItems(items);
        }

        #endregion

        #region Implementation of ICollectionActivity

        public int GetCollectionCount()
        {
            return ResultsCollection.Count(findRecordsTo => !findRecordsTo.CanRemove());
        }

        public IList<FindRecordsTO> ResultsCollection { get; set; }

        public void AddListToCollection(IList<string> listToAdd, bool overwrite, ModelItem modelItem)
        {
            if (!overwrite)
            {
                InsertToCollection(listToAdd, modelItem);
            }
            else
            {
                AddToCollection(listToAdd, modelItem);
            }
        }

        #endregion

        public bool Equals(DsfFindRecordsMultipleCriteriaActivity other)
        {
            if (ReferenceEquals(null, other))
            {
                return false;
            }

            if (ReferenceEquals(this, other))
            {
                return true;
            }

            var resultsCollectionsAreEqual = CommonEqualityOps.CollectionEquals(ResultsCollection, other.ResultsCollection, new FindRecordsTOComparer());
            return base.Equals(other)
                && string.Equals(FieldsToSearch, other.FieldsToSearch)
                && string.Equals(Result, other.Result)
                && string.Equals(StartIndex, other.StartIndex)
                && MatchCase == other.MatchCase
                && RequireAllTrue == other.RequireAllTrue
                && RequireAllFieldsToMatch == other.RequireAllFieldsToMatch
                && resultsCollectionsAreEqual;
        }

        public override bool Equals(object obj)
        {
            if (ReferenceEquals(null, obj))
            {
                return false;
            }

            if (ReferenceEquals(this, obj))
            {
                return true;
            }

            if (obj.GetType() != this.GetType())
            {
                return false;
            }

            return Equals((DsfFindRecordsMultipleCriteriaActivity)obj);
        }

        public override int GetHashCode()
        {
            unchecked
            {
                var hashCode = base.GetHashCode();
                hashCode = (hashCode * 397) ^ (FieldsToSearch != null ? FieldsToSearch.GetHashCode() : 0);
                hashCode = (hashCode * 397) ^ (Result != null ? Result.GetHashCode() : 0);
                hashCode = (hashCode * 397) ^ (StartIndex != null ? StartIndex.GetHashCode() : 0);
                hashCode = (hashCode * 397) ^ MatchCase.GetHashCode();
                hashCode = (hashCode * 397) ^ RequireAllTrue.GetHashCode();
                hashCode = (hashCode * 397) ^ RequireAllFieldsToMatch.GetHashCode();
                hashCode = (hashCode * 397) ^ (ResultsCollection != null ? ResultsCollection.GetHashCode() : 0);
                return hashCode;
            }
        }
    }


    class SearchQuery
    {
        public readonly bool RequireAllFieldsToMatch;
        public readonly bool RequireAllTrue;
        protected DsfFindRecordsMultipleCriteriaActivity activity;
        protected readonly string Result;


        public SearchQuery(DsfFindRecordsMultipleCriteriaActivity activity, string Result, bool RequireAllFieldsToMatch, bool RequireAllTrue)
        {
            this.activity = activity;
            this.Result = Result;
            this.RequireAllFieldsToMatch = RequireAllFieldsToMatch;
            this.RequireAllTrue = RequireAllTrue;
        }


#pragma warning disable S1541 // Methods and properties should not be too complex
        public void Execute(SearchContext searchContext, ErrorResultTO errorResult, IDSFDataObject dataObject, int update)
#pragma warning restore S1541 // Methods and properties should not be too complex
        {
            var env = dataObject.Environment;

            // Local Functions
            //-------------------------------------------------------------------------------------
            #region local-functions
            void ApplyResultsToEnvironment(IList<int> results)
            {
                var distinctResults = results.Distinct();
                if (DataListUtil.IsValueScalar(Result))
                {
                    var res = string.Join(",", distinctResults);
                    env.Assign(Result, res, update);
                }
                else
                {
                    foreach (var distinctResult in distinctResults)
                    {
                        env.Assign(Result, distinctResult.ToString(), update);
                    }
                }
            }
            IEnumerable<int> GetResultsForField(string searchvar)
            {
                Func<DataStorage.WarewolfAtom, bool> func = null;
                foreach (FindRecordsTO criteria in activity.ResultsCollection.Where(a => !String.IsNullOrEmpty(a.SearchType)))
                {
                    var right = env.EvalAsList(criteria.SearchCriteria, update);
                    IEnumerable<DataStorage.WarewolfAtom> from = new List<DataStorage.WarewolfAtom>();
                    IEnumerable<DataStorage.WarewolfAtom> tovalue = new List<DataStorage.WarewolfAtom>();

                    if (!String.IsNullOrEmpty(criteria.From))
                    {
                        @from = env.EvalAsList(criteria.From, update);
                    }
                    if (!String.IsNullOrEmpty(criteria.To))
                    {
                        tovalue = env.EvalAsList(criteria.To, update);
                    }
                    func = BuildQueryExpression(func, criteria, right, from, tovalue);
                }
                return env.EvalWhere(env.ToStar(searchvar), func, update);
            }
            List<int> GetResults()
            {
                var hasEvaled = false;
                var results = new List<int>();

                foreach (var searchvar in searchContext.ToSearch)
                {
                    var output = GetResultsForField(searchvar);

                    results = RequireAllFieldsToMatch && hasEvaled ? results.Intersect(output).ToList() : results.Union(output).ToList();
                    hasEvaled = true;
                }

                if (!results.Any())
                {
                    results.Add(-1);
                }

                return results;
            }

            Func<DataStorage.WarewolfAtom, bool> BuildQueryExpression(Func<DataStorage.WarewolfAtom, bool> func, FindRecordsTO criteria, IEnumerable<DataStorage.WarewolfAtom> right, IEnumerable<DataStorage.WarewolfAtom> from, IEnumerable<DataStorage.WarewolfAtom> tovalue)
            {
                return func == null ?
                    CreateFuncFromOperator(criteria.SearchType, right, @from, tovalue) :
                    RequireAllTrue ?
                        CombineFuncAnd(func, criteria.SearchType, right, @from, tovalue) :
                        CombineFuncOr(func, criteria.SearchType, right, @from, tovalue);
            }

            
            #endregion
            
            searchContext.Validate(errorResult);


            var queryResults = GetResults();
            ApplyResultsToEnvironment(queryResults);
        }


        Func<DataStorage.WarewolfAtom, bool> CombineFuncAnd(Func<DataStorage.WarewolfAtom, bool> func, string searchType, IEnumerable<DataStorage.WarewolfAtom> values, IEnumerable<DataStorage.WarewolfAtom> from, IEnumerable<DataStorage.WarewolfAtom> to)
        {
            var func2 = CreateFuncFromOperator(searchType, values, from, to);

            return a =>
            {
                try
                {
                    return func.Invoke(a) && func2.Invoke(a);
                }
                catch (DataStorage.WarewolfInvalidComparisonException ex)
                {
                    return false;
                }
            };
        }

        Func<DataStorage.WarewolfAtom, bool> CombineFuncOr(Func<DataStorage.WarewolfAtom, bool> func, string searchType, IEnumerable<DataStorage.WarewolfAtom> values, IEnumerable<DataStorage.WarewolfAtom> from, IEnumerable<DataStorage.WarewolfAtom> to)
        {
            var func2 = CreateFuncFromOperator(searchType, values, from, to);
            return a =>
            {
                bool CatchInvalidComparisons(Func<DataStorage.WarewolfAtom, bool> f)
                {
                    var ret = false;
                    try
                    {
                        ret = f.Invoke(a);
                        if (ret)
                        {
                            return ret;
                        }
                    }
                    catch (DataStorage.WarewolfInvalidComparisonException ex)
                    {
                        ret = false;
                    }
                    return ret;
                }
                return CatchInvalidComparisons(func) || CatchInvalidComparisons(func2);
            };
        }


        Func<DataStorage.WarewolfAtom, bool> CreateFuncFromOperator(string searchType, IEnumerable<DataStorage.WarewolfAtom> values, IEnumerable<DataStorage.WarewolfAtom> from, IEnumerable<DataStorage.WarewolfAtom> to)
        {

            var opt = FindRecsetOptions.FindMatch(searchType);
            return (a) =>
            {
                try
                {
                    return opt.GenerateFunc(values, from, to, RequireAllFieldsToMatch).Invoke(a);
                }
                catch (DataStorage.WarewolfInvalidComparisonException ex)
                {
                    return false;
                }
            };
        }

    }

    class SearchContext
    {
        protected DsfFindRecordsMultipleCriteriaActivity activity;

        public readonly IList<string> ToSearch;

        public SearchContext(DsfFindRecordsMultipleCriteriaActivity activity)
        {
            this.activity = activity;
            ToSearch = activity.FieldsToSearch.Split(',')
                            .Select(a => a.Trim())
                            .ToList();
        }

        public void Validate(ErrorResultTO errorsTo)
        {
            ValidateSearchFields();
            ValidateMatchesAgainstFields(errorsTo);
        }

        void ValidateSearchFields()
        {
            var scalarValues = ToSearch.Where(DataListUtil.IsValueScalar).ToList();
            if (scalarValues.Any())
            {
                throw new Exception(ErrorResource.ScalarsNotAllowed + Environment.NewLine + string.Join(Environment.NewLine, scalarValues));
            }
        }

        void ValidateMatchesAgainstFields(ErrorResultTO errorsTo)
        {
            foreach (FindRecordsTO criteria in activity.ResultsCollection.Where(a => !String.IsNullOrEmpty(a.SearchType)))
            {
                if (criteria.From.Length > 0 && String.IsNullOrEmpty(criteria.To)
                   || criteria.To.Length > 0 && String.IsNullOrEmpty(criteria.From))
                {
                    throw new Exception(ErrorResource.FROMAndTORequired);
                }
                ValidateRequiredFields(criteria, errorsTo);
            }
        }

        static void ValidateRequiredFields(FindRecordsTO searchTo, ErrorResultTO errors)
        {
            if (string.IsNullOrEmpty(searchTo.SearchType))
            {
                errors.AddError(string.Format(ErrorResource.IsRequired, "Search Type"));
            }

            if (searchTo.SearchType.Equals("Is Between"))
            {
                if (string.IsNullOrEmpty(searchTo.From))
                {
                    errors.AddError(string.Format(ErrorResource.IsRequired, "FROM"));
                }

                if (string.IsNullOrEmpty(searchTo.To))
                {
                    errors.AddError(string.Format(ErrorResource.IsRequired, "TO"));
                }
            }
        }
    }
}

---- Transformed Tree ----
using System;
using System.Activities;
using System.Activities.Presentation.Model;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using Dev2;
using Dev2.Activities;
using Dev2.Activities.Debug;
using Dev2.Common;
using Dev2.Common.Interfaces.Diagnostics.Debug;
using Dev2.Common.Interfaces.Toolbox;
using Dev2.Data.TO;
using Dev2.Data.Util;
using Dev2.DataList;
using Dev2.DataList.Contract;
using Dev2.Diagnostics;
using Dev2.Interfaces;
using Dev2.Util;
using Unlimited.Applications.BusinessDesignStudio.Activities.Utilities;
using Warewolf.Core;
using Warewolf.Resource.Errors;
using Warewolf.Storage.Interfaces;
using Dev2.Comparer;
using Dev2.Common.Interfaces.Data.TO;
using Dev2.Common.State;
using Dev2.Utilities;

namespace Unlimited.Applications.BusinessDesignStudio.Activities

{
    /// <New>
    /// Activity for finding records accoring to a search criteria that the user specifies
    /// </New>
    [ToolDescriptorInfo("RecordSet-FindRecords", "Find Records", ToolType.Native, "8999E59A-38A3-43BB-A98F-6090C5C9EA1E", "Dev2.Activities", "1.0.0.0", "Legacy", "Recordset", "/Warewolf.Studio.Themes.Luna;component/Images.xaml", "Tool_Recordset_Find_Records")]
    public class DsfFindRecordsMultipleCriteriaActivity : DsfActivityAbstract<string>, ICollectionActivity, IEquatable<DsfFindRecordsMultipleCriteriaActivity>
    {
        #region Properties

        /// <summary>
        /// Property for holding a string the user enters into the "In Fields" box
        /// </summary>
        [Inputs("FieldsToSearch")]
        [FindMissing]
        public string FieldsToSearch { get; set; }


        /// <summary>
        /// Property for holding a string the user enters into the "Result" box
        /// </summary>
        [Outputs("Result")]
        [FindMissing]
        public new string Result { get; set; }

        /// <summary>
        /// Property for holding a string the user enters into the "Start Index" box
        /// </summary>
        [Inputs("StartIndex")]
        [FindMissing]
        public string StartIndex { get; set; }

        /// <summary>
        /// Property for holding a bool the user chooses with the "MatchCase" Checkbox
        /// </summary>
        [Inputs("MatchCase")]
        public bool MatchCase { get; set; }

        public bool RequireAllTrue { get; set; }

        public bool RequireAllFieldsToMatch { get; set; }
        #endregion Properties

        #region Ctor

        public DsfFindRecordsMultipleCriteriaActivity()
            : base("Find Record Index")
        {
            // Initialise all the properties here
            ResultsCollection = new List<FindRecordsTO>();
            FieldsToSearch = string.Empty;
            Result = string.Empty;
            StartIndex = string.Empty;
            RequireAllTrue = true;
            RequireAllFieldsToMatch = false;
        }

        #endregion Ctor

        public override IEnumerable<StateVariable> GetState()
        {
            return new[] {
                new StateVariable
                {
                    Name = "ResultsCollection",
                    Value = ActivityHelper.GetSerializedStateValueFromCollection(ResultsCollection),
                    Type = StateVariable.StateType.Input
                },
                new StateVariable
                {
                    Name = "FieldsToSearch",
                    Value = FieldsToSearch,
                    Type = StateVariable.StateType.Input
                },
                new StateVariable
                {
                    Name = "RequireAllTrue",
                    Value = RequireAllTrue.ToString(),
                    Type = StateVariable.StateType.Input
                },
                new StateVariable
                {
                    Name = "RequireAllFieldsToMatch",
                    Value = RequireAllFieldsToMatch.ToString(),
                    Type = StateVariable.StateType.Input
                },
                new StateVariable
                {
                    Name="Result",
                    Value = Result,
                    Type = StateVariable.StateType.Output
                }
            };
        }

        public override List<string> GetOutputs() => new List<string> { Result };

        protected override void OnExecute(NativeActivityContext context)
        {
            var dataObject = context.GetExtension<IDSFDataObject>();
            ExecuteTool(dataObject, 0);
        }

        protected override void ExecuteTool(IDSFDataObject dataObject, int update)
        {
            var searchQuery = new SearchQuery(this, Result, RequireAllFieldsToMatch, RequireAllTrue);

            var allErrors = new ErrorResultTO();
            try
            {
                InitializeDebug(dataObject);
                var searchContext = new SearchContext(this);
                if (dataObject.IsDebugMode())
                {
                    TryAddDebugInputValues(dataObject, searchContext.ToSearch, ref allErrors, update);
                }

                searchQuery.Execute(searchContext, allErrors, dataObject, update);

                if (dataObject.IsDebugMode())
                {
                    if (DataListUtil.IsValueRecordset(Result))
                    {
                        var recVar = DataListUtil.ReplaceRecordsetBlankWithStar(Result);
                        AddDebugOutputItem(new DebugEvalResult(recVar, "", dataObject.Environment, update));
                    }
                    else
                    {
                        AddDebugOutputItem(new DebugEvalResult(Result, "", dataObject.Environment, update));
                    }
                }
            }
            catch (Exception exception)
            {
                Dev2Logger.Error("DSFRecordsMultipleCriteria", exception, GlobalConstants.WarewolfError);
                allErrors.AddError(exception.Message);
            }
            finally
            {
                var hasErrors = allErrors.HasErrors();
                if (hasErrors)
                {
                    DisplayAndWriteError("DsfFindRecordsMultipleCriteriaActivity", allErrors);
                    var errorString = allErrors.MakeDisplayReady();
                    dataObject.Environment.AddError(errorString);
                    dataObject.Environment.Assign(Result, "-1", update);
                    if (dataObject.IsDebugMode())
                    {
                        AddDebugOutputItem(new DebugEvalResult(Result, "", dataObject.Environment, update));
                    }
                }

                if (dataObject.IsDebugMode())
                {
                    DispatchDebugState(dataObject, StateType.Before, update);
                    DispatchDebugState(dataObject, StateType.After, update);
                }
            }
        }

        internal void SetErrorsTO(ErrorResultTO errorTo)
        {
            _errorsTo = errorTo;
        }

        public override enFindMissingType GetFindMissingType() => enFindMissingType.MixedActivity;

        void TryAddDebugInputValues(IDSFDataObject dataObject, IEnumerable<string> toSearch, ref ErrorResultTO errorTos, int update)
        {
            if (dataObject.IsDebugMode())
            {
                try
                {
                    AddDebugInputValues(dataObject, toSearch, update);
                }
                catch (Exception e)
                {
                    errorTos.AddError(e.Message);
                }
            }
        }

        private void AddDebugInputValues(IDSFDataObject dataObject, IEnumerable<string> toSearch, int update)
        {
            var debugItem = new DebugItem();
            AddDebugItem(new DebugItemStaticDataParams("", "In Field(s)"), debugItem);
            foreach (var s in toSearch)
            {
                var searchFields = s;
                if (DataListUtil.IsValueRecordset(s))
                {
                    searchFields = searchFields.Replace("()", "(*)");
                }
                AddDebugItem(new DebugEvalResult(searchFields, "", dataObject.Environment, update), debugItem);
            }
            _debugInputs.Add(debugItem);
            AddResultDebugInputs(ResultsCollection, dataObject.Environment, update);
            AddDebugInputItem(new DebugItemStaticDataParams(RequireAllFieldsToMatch ? "YES" : "NO", "Require All Fields To Match"));
            AddDebugInputItem(new DebugItemStaticDataParams(RequireAllTrue ? "YES" : "NO", "Require All Matches To Be True"));
        }

        #region Overrides of DsfNativeActivity<string>

        public override List<DebugItem> GetDebugOutputs(IExecutionEnvironment env, int update)
        {
            return _debugOutputs;
        }

        #endregion

        #region Private Methods

        void AddResultDebugInputs(IEnumerable<FindRecordsTO> resultsCollection, IExecutionEnvironment environment, int update)
        {
            var indexCount = 1;
            foreach (var findRecordsTo in resultsCollection)
            {
                var debugItem = new DebugItem();
                if (!String.IsNullOrEmpty(findRecordsTo.SearchType))
                {
                    AddDebugItem(new DebugItemStaticDataParams("", indexCount.ToString(CultureInfo.InvariantCulture)), debugItem);
                    AddDebugItem(new DebugItemStaticDataParams(findRecordsTo.SearchType, ""), debugItem);

                    if (!string.IsNullOrEmpty(findRecordsTo.SearchCriteria))
                    {
                        AddDebugItem(new DebugEvalResult(findRecordsTo.SearchCriteria, "", environment, update, ""), debugItem);
                    }

                    if (findRecordsTo.SearchType == "Is Between" || findRecordsTo.SearchType == "Not Between")
                    {
                        AddDebugItem(new DebugEvalResult(findRecordsTo.From, "", environment, update), debugItem);

                        AddDebugItem(new DebugEvalResult(findRecordsTo.To, " And", environment, update), debugItem);
                    }

                    _debugInputs.Add(debugItem);
                    indexCount++;
                }
            }
        }

        void InsertToCollection(IEnumerable<string> listToAdd, ModelItem modelItem)
        {
            var modelProperty = modelItem.Properties["ResultsCollection"];
            if (modelProperty == null)
            {
                return;
            }
            var mic = modelProperty.Collection;

            if (mic == null)
            {
                return;
            }
            var listOfValidRows = ResultsCollection.Where(c => !c.CanRemove()).ToList();
            if (listOfValidRows.Count > 0)
            {
                var findRecordsTo = ResultsCollection.Last(c => !c.CanRemove());
                var startIndex = ResultsCollection.IndexOf(findRecordsTo) + 1;
                foreach (var s in listToAdd)
                {
                    mic.Insert(startIndex, new FindRecordsTO(s, ResultsCollection[startIndex - 1].SearchType, startIndex + 1));
                    startIndex++;
                }
                CleanUpCollection(mic, modelItem, startIndex);
            }
            else
            {
                AddToCollection(listToAdd, modelItem);
            }
        }

        void AddToCollection(IEnumerable<string> listToAdd, ModelItem modelItem)
        {
            var modelProperty = modelItem.Properties["ResultsCollection"];
            if (modelProperty == null)
            {
                return;
            }
            var mic = modelProperty.Collection;

            if (mic == null)
            {
                return;
            }
            var startIndex = 0;
            var searchType = ResultsCollection[0].SearchType;
            mic.Clear();
            foreach (var s in listToAdd)
            {
                mic.Add(new FindRecordsTO(s, searchType, startIndex + 1));
                startIndex++;
            }
            CleanUpCollection(mic, modelItem, startIndex);
        }

        static void CleanUpCollection(ModelItemCollection mic, ModelItem modelItem, int startIndex)
        {
            if (startIndex < mic.Count)
            {
                mic.RemoveAt(startIndex);
            }
            mic.Add(new XPathDTO(string.Empty, "", startIndex + 1));
            var modelProperty = modelItem.Properties["DisplayName"];
            modelProperty?.SetValue(CreateDisplayName(modelItem, startIndex + 1));
        }

        static string CreateDisplayName(ModelItem modelItem, int count)
        {
            var modelProperty = modelItem.Properties["DisplayName"];
            if (modelProperty == null)
            {
                return "";
            }
            if (modelProperty.ComputedValue is string currentName && currentName.Contains("(") && currentName.Contains(")"))
            {
                currentName = currentName.Remove(currentName.Contains(" (") ? currentName.IndexOf(" (", StringComparison.Ordinal) : currentName.IndexOf("(", StringComparison.Ordinal));
            }
            currentName = currentName + " (" + (count - 1) + ")";
            return currentName;
        }

        #endregion Private Methods

        #region Get Debug Inputs/Outputs

        public override List<DebugItem> GetDebugInputs(IExecutionEnvironment env, int update)
        {
            foreach (IDebugItem debugInput in _debugInputs)
            {
                debugInput.FlushStringBuilder();
            }
            return _debugInputs;
        }


        #endregion Get Inputs/Outputs

        #region Get ForEach Inputs/Ouputs

        public override void UpdateForEachInputs(IList<Tuple<string, string>> updates)
        {
            if (updates != null)
            {
                foreach (Tuple<string, string> t in updates)
                {
                    // locate all updates for this tuple
                    var t1 = t;
                    var items = ResultsCollection.Where(c => !string.IsNullOrEmpty(c.SearchCriteria) && c.SearchCriteria.Equals(t1.Item1));

                    // issues updates
                    foreach (var a in items)
                    {
                        a.SearchCriteria = t.Item2;
                    }

                    if (FieldsToSearch == t.Item1)
                    {
                        FieldsToSearch = t.Item2;
                    }
                }
            }
        }

        public override void UpdateForEachOutputs(IList<Tuple<string, string>> updates)
        {
            if (updates != null)
            {
                foreach (var t in updates)
                {
                    if (Result == t.Item1)
                    {
                        Result = t.Item2;
                    }
                }
            }
        }

        #endregion

        #region GetForEachInputs/Outputs

        public override IList<DsfForEachItem> GetForEachInputs()
        {
            var items = new[] { FieldsToSearch }.Union(ResultsCollection.Where(c => !string.IsNullOrEmpty(c.SearchCriteria)).Select(c => c.SearchCriteria)).ToArray();
            return GetForEachItems(items);
        }

        public override IList<DsfForEachItem> GetForEachOutputs()
        {
            var items = Result;
            return GetForEachItems(items);
        }

        #endregion

        #region Implementation of ICollectionActivity

        public int GetCollectionCount()
        {
            return ResultsCollection.Count(findRecordsTo => !findRecordsTo.CanRemove());
        }

        public IList<FindRecordsTO> ResultsCollection { get; set; }

        public void AddListToCollection(IList<string> listToAdd, bool overwrite, ModelItem modelItem)
        {
            if (!overwrite)
            {
                InsertToCollection(listToAdd, modelItem);
            }
            else
            {
                AddToCollection(listToAdd, modelItem);
            }
        }

        #endregion

        public bool Equals(DsfFindRecordsMultipleCriteriaActivity other)
        {
            if (ReferenceEquals(null, other))
            {
                return false;
            }

            if (ReferenceEquals(this, other))
            {
                return true;
            }

            var resultsCollectionsAreEqual = CommonEqualityOps.CollectionEquals(ResultsCollection, other.ResultsCollection, new FindRecordsTOComparer());
            return base.Equals(other)
                && string.Equals(FieldsToSearch, other.FieldsToSearch)
                && string.Equals(Result, other.Result)
                && string.Equals(StartIndex, other.StartIndex)
                && MatchCase == other.MatchCase
                && RequireAllTrue == other.RequireAllTrue
                && RequireAllFieldsToMatch == other.RequireAllFieldsToMatch
                && resultsCollectionsAreEqual;
        }

        public override bool Equals(object obj)
        {
            if (ReferenceEquals(null, obj))
            {
                return false;
            }

            if (ReferenceEquals(this, obj))
            {
                return true;
            }

            if (obj.GetType() != this.GetType())
            {
                return false;
            }

            return Equals((DsfFindRecordsMultipleCriteriaActivity)obj);
        }

        public override int GetHashCode()
        {
            unchecked
            {
                var hashCode = base.GetHashCode();
                hashCode = (hashCode * 397) ^ (FieldsToSearch != null ? FieldsToSearch.GetHashCode() : 0);
                hashCode = (hashCode * 397) ^ (Result != null ? Result.GetHashCode() : 0);
                hashCode = (hashCode * 397) ^ (StartIndex != null ? StartIndex.GetHashCode() : 0);
                hashCode = (hashCode * 397) ^ MatchCase.GetHashCode();
                hashCode = (hashCode * 397) ^ RequireAllTrue.GetHashCode();
                hashCode = (hashCode * 397) ^ RequireAllFieldsToMatch.GetHashCode();
                hashCode = (hashCode * 397) ^ (ResultsCollection != null ? ResultsCollection.GetHashCode() : 0);
                return hashCode;
            }
        }
    }


    class SearchQuery
    {
        public readonly bool RequireAllFieldsToMatch;
        public readonly bool RequireAllTrue;
        protected DsfFindRecordsMultipleCriteriaActivity activity;
        protected readonly string Result;


        public SearchQuery(DsfFindRecordsMultipleCriteriaActivity activity, string Result, bool RequireAllFieldsToMatch, bool RequireAllTrue)
        {
            this.activity = activity;
            this.Result = Result;
            this.RequireAllFieldsToMatch = RequireAllFieldsToMatch;
            this.RequireAllTrue = RequireAllTrue;
        }


#pragma warning disable S1541 // Methods and properties should not be too complex
        public void Execute(SearchContext searchContext, ErrorResultTO errorResult, IDSFDataObject dataObject, int update)
#pragma warning restore S1541 // Methods and properties should not be too complex
        {
            var env = dataObject.Environment;

            // Local Functions
            //-------------------------------------------------------------------------------------
            #region local-functions
            void ApplyResultsToEnvironment(IList<int> results)
            {
                var distinctResults = results.Distinct();
                if (DataListUtil.IsValueScalar(Result))
                {
                    var res = string.Join(",", distinctResults);
                    env.Assign(Result, res, update);
                }
                else
                {
                    foreach (var distinctResult in distinctResults)
                    {
                        env.Assign(Result, distinctResult.ToString(), update);
                    }
                }
            }
            IEnumerable<int> GetResultsForField(string searchvar)
            {
                Func<DataStorage.WarewolfAtom, bool> func = null;
                foreach (FindRecordsTO criteria in activity.ResultsCollection.Where(a => !String.IsNullOrEmpty(a.SearchType)))
                {
                    var right = env.EvalAsList(criteria.SearchCriteria, update);
                    IEnumerable<DataStorage.WarewolfAtom> from = new List<DataStorage.WarewolfAtom>();
                    IEnumerable<DataStorage.WarewolfAtom> tovalue = new List<DataStorage.WarewolfAtom>();

                    if (!String.IsNullOrEmpty(criteria.From))
                    {
                        @from = env.EvalAsList(criteria.From, update);
                    }
                    if (!String.IsNullOrEmpty(criteria.To))
                    {
                        tovalue = env.EvalAsList(criteria.To, update);
                    }
                    func = BuildQueryExpression(func, criteria, right, from, tovalue);
                }
                return env.EvalWhere(env.ToStar(searchvar), func, update);
            }
            List<int> GetResults()
            {
                var hasEvaled = false;
                var results = new List<int>();

                foreach (var searchvar in searchContext.ToSearch)
                {
                    var output = GetResultsForField(searchvar);

                    results = RequireAllFieldsToMatch && hasEvaled ? results.Intersect(output).ToList() : results.Union(output).ToList();
                    hasEvaled = true;
                }

                if (!results.Any())
                {
                    results.Add(-1);
                }

                return results;
            }

            Func<DataStorage.WarewolfAtom, bool> BuildQueryExpression(Func<DataStorage.WarewolfAtom, bool> func, FindRecordsTO criteria, IEnumerable<DataStorage.WarewolfAtom> right, IEnumerable<DataStorage.WarewolfAtom> from, IEnumerable<DataStorage.WarewolfAtom> tovalue)
            {
                return func == null ?
                    CreateFuncFromOperator(criteria.SearchType, right, @from, tovalue) :
                    RequireAllTrue ?
                        CombineFuncAnd(func, criteria.SearchType, right, @from, tovalue) :
                        CombineFuncOr(func, criteria.SearchType, right, @from, tovalue);
            }

            
            #endregion
            
            searchContext.Validate(errorResult);


            var queryResults = GetResults();
            ApplyResultsToEnvironment(queryResults);
        }


        Func<DataStorage.WarewolfAtom, bool> CombineFuncAnd(Func<DataStorage.WarewolfAtom, bool> func, string searchType, IEnumerable<DataStorage.WarewolfAtom> values, IEnumerable<DataStorage.WarewolfAtom> from, IEnumerable<DataStorage.WarewolfAtom> to)
        {
            var func2 = CreateFuncFromOperator(searchType, values, from, to);

            return a =>
            {
                try
                {
                    return func.Invoke(a) && func2.Invoke(a);
                }
                catch (DataStorage.WarewolfInvalidComparisonException ex)
                {
                    return false;
                }
            };
        }

        Func<DataStorage.WarewolfAtom, bool> CombineFuncOr(Func<DataStorage.WarewolfAtom, bool> func, string searchType, IEnumerable<DataStorage.WarewolfAtom> values, IEnumerable<DataStorage.WarewolfAtom> from, IEnumerable<DataStorage.WarewolfAtom> to)
        {
            var func2 = CreateFuncFromOperator(searchType, values, from, to);
            return a =>
            {
                bool CatchInvalidComparisons(Func<DataStorage.WarewolfAtom, bool> f)
                {
                    var ret = false;
                    try
                    {
                        ret = f.Invoke(a);
                        if (ret)
                        {
                            return ret;
                        }
                    }
                    catch (DataStorage.WarewolfInvalidComparisonException ex)
                    {
                        ret = false;
                    }
                    return ret;
                }
                return CatchInvalidComparisons(func) || CatchInvalidComparisons(func2);
            };
        }


        Func<DataStorage.WarewolfAtom, bool> CreateFuncFromOperator(string searchType, IEnumerable<DataStorage.WarewolfAtom> values, IEnumerable<DataStorage.WarewolfAtom> from, IEnumerable<DataStorage.WarewolfAtom> to)
        {

            var opt = FindRecsetOptions.FindMatch(searchType);
            return (a) =>
            {
                try
                {
                    return opt.GenerateFunc(values, from, to, RequireAllFieldsToMatch).Invoke(a);
                }
                catch (DataStorage.WarewolfInvalidComparisonException ex)
                {
                    return false;
                }
            };
        }

    }

    class SearchContext
    {
        protected DsfFindRecordsMultipleCriteriaActivity activity;

        public readonly IList<string> ToSearch;

        public SearchContext(DsfFindRecordsMultipleCriteriaActivity activity)
        {
            this.activity = activity;
            ToSearch = activity.FieldsToSearch.Split(',')
                            .Select(a => a.Trim())
                            .ToList();
        }

        public void Validate(ErrorResultTO errorsTo)
        {
            ValidateSearchFields();
            ValidateMatchesAgainstFields(errorsTo);
        }

        void ValidateSearchFields()
        {
            var scalarValues = ToSearch.Where(DataListUtil.IsValueScalar).ToList();
            if (scalarValues.Any())
            {
                throw new Exception(ErrorResource.ScalarsNotAllowed + Environment.NewLine + string.Join(Environment.NewLine, scalarValues));
            }
        }

        void ValidateMatchesAgainstFields(ErrorResultTO errorsTo)
        {
            foreach (FindRecordsTO criteria in activity.ResultsCollection.Where(a => !String.IsNullOrEmpty(a.SearchType)))
            {
                if (criteria.From.Length > 0 && String.IsNullOrEmpty(criteria.To)
                   || criteria.To.Length > 0 && String.IsNullOrEmpty(criteria.From))
                {
                    throw new Exception(ErrorResource.FROMAndTORequired);
                }
                ValidateRequiredFields(criteria, errorsTo);
            }
        }

        static void ValidateRequiredFields(FindRecordsTO searchTo, ErrorResultTO errors)
        {
            if (string.IsNullOrEmpty(searchTo.SearchType))
            {
                errors.AddError(string.Format(ErrorResource.IsRequired, "Search Type"));
            }

            if (searchTo.SearchType.Equals("Is Between"))
            {
                if (string.IsNullOrEmpty(searchTo.From))
                {
                    errors.AddError(string.Format(ErrorResource.IsRequired, "FROM"));
                }

                if (string.IsNullOrEmpty(searchTo.To))
                {
                    errors.AddError(string.Format(ErrorResource.IsRequired, "TO"));
                }
            }
        }
    }
}

---- Semantic diagnostics *before* transformation ----
D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(626,66): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(626,135): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(626,181): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(626,225): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(626,14): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(643,65): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(643,134): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(643,180): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(643,224): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(643,14): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(670,100): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(670,146): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(670,190): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(670,14): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(566,22): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(569,33): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(570,33): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(570,75): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(571,33): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(571,78): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(575,33): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(579,35): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(583,24): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(606,76): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(606,150): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(606,195): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(606,239): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(606,18): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(636,24): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(659,28): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(648,51): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(680,24): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?)
---- Semantic diagnostics *after* transformation ----
D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(625,66): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(625,135): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(625,181): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(625,225): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(625,14): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(642,65): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(642,134): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(642,180): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(642,224): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(642,14): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(669,100): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(669,146): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(669,190): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(669,14): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(565,22): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(568,33): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(569,33): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(569,75): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(570,33): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(570,78): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(574,33): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(578,35): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(582,24): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(605,76): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(605,150): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(605,195): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(605,239): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(605,18): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(359,27): error CS0165: Use of unassigned local variable 'currentName',D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(635,24): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(658,28): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(647,51): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfFindRecordsMultipleCriteriaActivity.cs(679,24): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?)
######################################################################


######################################################################
Nr: 3 - UsePatternMatchingRewriterR8
Filepath: D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataMergeActivity.cs
Description: Error: The created Syntax Tree is semantically incorrect.
------------------------------------------------------------------------
---- Original Tree ----
using System;
using System.Activities;
using System.Activities.Presentation.Model;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using Dev2;
using Dev2.Activities;
using Dev2.Activities.Debug;
using Dev2.Common;
using Dev2.Common.Interfaces;
using Dev2.Common.Interfaces.Diagnostics.Debug;
using Dev2.Common.Interfaces.Toolbox;
using Dev2.Data;
using Dev2.Data.Interfaces;
using Dev2.Data.Operations;
using Dev2.Data.TO;
using Dev2.Data.Util;
using Dev2.Diagnostics;
using Dev2.Interfaces;
using Warewolf.Core;
using Warewolf.Resource.Errors;
using Warewolf.Storage;
using Warewolf.Storage.Interfaces;
using WarewolfParserInterop;
using Dev2.Comparer;
using Dev2.Common.State;
using Dev2.Utilities;

namespace Unlimited.Applications.BusinessDesignStudio.Activities

{
    [ToolDescriptorInfo("Data-DataMerge", "Data Merge", ToolType.Native, "8999E59A-38A3-43BB-A98F-6090C5C9EA1E", "Dev2.Activities", "1.0.0.0", "Legacy", "Data", "/Warewolf.Studio.Themes.Luna;component/Images.xaml", "Tool_Data_Data_Merge")]
    public class DsfDataMergeActivity : DsfActivityAbstract<string>, ICollectionActivity, IEquatable<DsfDataMergeActivity>
    {
        #region Class Members

        string _result;

        #endregion Class Members

        #region Properties

        IList<DataMergeDTO> _mergeCollection;
        public IList<DataMergeDTO> MergeCollection
        {
            get
            {
                return _mergeCollection;
            }
            set
            {
                _mergeCollection = value;
                OnPropertyChanged("MergeCollection");
            }
        }

        public new string Result
        {
            get
            {
                return _result;
            }
            set
            {
                _result = value;
                OnPropertyChanged("Result");
            }
        }

        protected override bool CanInduceIdle => true;

        #endregion

        #region Ctor

        public DsfDataMergeActivity()
            : base("Data Merge")
        {
            MergeCollection = new List<DataMergeDTO>();
        }

        #endregion

        #region Overridden NativeActivity Methods

        protected override void CacheMetadata(NativeActivityMetadata metadata) => base.CacheMetadata(metadata);


        protected override void OnExecute(NativeActivityContext context)
        {
            var dataObject = context.GetExtension<IDSFDataObject>();
            ExecuteTool(dataObject, 0);
        }

        protected override void ExecuteTool(IDSFDataObject dataObject, int update)
        {


            IDev2MergeOperations mergeOperations = new Dev2MergeOperations();
            var allErrors = new ErrorResultTO();
            var errorResultTo = new ErrorResultTO();

            InitializeDebug(dataObject);
            try
            {
                CleanArguments(MergeCollection);

                if (MergeCollection.Count <= 0)
                {
                    return;
                }
                TryExecuteTool(dataObject, update, mergeOperations, allErrors, errorResultTo);
            }
            catch (Exception e)
            {
                Dev2Logger.Error("DSFDataMerge", e, GlobalConstants.WarewolfError);
                allErrors.AddError(e.Message);
            }
            finally
            {
                #region Handle Errors

                if (allErrors.HasErrors())
                {
                    if (dataObject.IsDebugMode())
                    {
                        AddDebugOutputItem(new DebugItemStaticDataParams("", Result, ""));
                    }
                    DisplayAndWriteError("DsfDataMergeActivity", allErrors);
                    var errorString = allErrors.MakeDisplayReady();
                    dataObject.Environment.AddError(errorString);
                }

                if (dataObject.IsDebugMode())
                {
                    DispatchDebugState(dataObject, StateType.Before, update);
                    DispatchDebugState(dataObject, StateType.After, update);
                }

                #endregion
            }
        }

#pragma warning disable S1541 // Methods and properties should not be too complex
#pragma warning disable S3776 // Cognitive Complexity of methods should not be too high
        private void TryExecuteTool(IDSFDataObject dataObject, int update, IDev2MergeOperations mergeOperations, ErrorResultTO allErrors, ErrorResultTO errorResultTo)
#pragma warning restore S3776 // Cognitive Complexity of methods should not be too high
#pragma warning restore S1541 // Methods and properties should not be too complex
        {
            IWarewolfListIterator warewolfListIterator = new WarewolfListIterator();
            allErrors.MergeErrors(errorResultTo);
            var listOfIterators = new Dictionary<int, List<IWarewolfIterator>>();

            #region Create a iterator for each row in the data grid in the designer so that the right iteration happen on the data

            var dictionaryKey = 0;
            foreach (DataMergeDTO row in MergeCollection)
            {
                allErrors.MergeErrors(errorResultTo);

                if (dataObject.IsDebugMode())
                {
                    var debugItem = new DebugItem();
                    AddDebugItem(new DebugItemStaticDataParams("", (MergeCollection.IndexOf(row) + 1).ToString(CultureInfo.InvariantCulture)), debugItem);
                    AddDebugItem(new DebugEvalResult(row.InputVariable, "", dataObject.Environment, update, true), debugItem);
                    AddDebugItem(new DebugItemStaticDataParams(row.MergeType, "With"), debugItem);
                    AddDebugItem(new DebugEvalResult(row.At, "Using", dataObject.Environment, update), debugItem);
                    AddDebugItem(new DebugEvalResult(row.Padding, "Pad", dataObject.Environment, update), debugItem);

                    //Old workflows don't have this set. 
                    if (row.Alignment == null)
                    {
                        row.Alignment = string.Empty;
                    }

                    AddDebugItem(DataListUtil.IsEvaluated(row.Alignment) ? new DebugItemStaticDataParams("", row.Alignment, "Align") : new DebugItemStaticDataParams(row.Alignment, "Align"), debugItem);

                    _debugInputs.Add(debugItem);
                }
                var listOfEvalResultsForInput = dataObject.Environment.EvalForDataMerge(row.InputVariable, update);
                var innerIterator = new WarewolfListIterator();
                var innerListOfIters = new List<WarewolfIterator>();

                foreach (var listOfIterator in listOfEvalResultsForInput)
                {
                    var inIterator = new WarewolfIterator(listOfIterator);
                    innerIterator.AddVariableToIterateOn(inIterator);
                    innerListOfIters.Add(inIterator);
                }
                var atomList = new List<DataStorage.WarewolfAtom>();
                while (innerIterator.HasMoreData())
                {
                    var stringToUse = "";
                    foreach (var warewolfIterator in innerListOfIters)
                    {
                        stringToUse += warewolfIterator.GetNextValue();
                    }
                    atomList.Add(DataStorage.WarewolfAtom.NewDataString(stringToUse));
                }
                var finalString = string.Join("", atomList);
                var inputListResult = CommonFunctions.WarewolfEvalResult.NewWarewolfAtomListresult(new WarewolfAtomList<DataStorage.WarewolfAtom>(DataStorage.WarewolfAtom.Nothing, atomList));
                if (DataListUtil.IsFullyEvaluated(finalString))
                {
                    inputListResult = dataObject.Environment.Eval(finalString, update);
                }

                var inputIterator = new WarewolfIterator(inputListResult);
                var atIterator = new WarewolfIterator(dataObject.Environment.Eval(row.At, update));
                var paddingIterator = new WarewolfIterator(dataObject.Environment.Eval(row.Padding, update));
                warewolfListIterator.AddVariableToIterateOn(inputIterator);
                warewolfListIterator.AddVariableToIterateOn(atIterator);
                warewolfListIterator.AddVariableToIterateOn(paddingIterator);

                listOfIterators.Add(dictionaryKey, new List<IWarewolfIterator> { inputIterator, atIterator, paddingIterator });
                dictionaryKey++;
            }

            #endregion

            #region Iterate and Merge Data

            if (!allErrors.HasErrors())
            {
                while (warewolfListIterator.HasMoreData())
                {
                    var pos = 0;
                    foreach (var iterator in listOfIterators)
                    {
                        var val = warewolfListIterator.FetchNextValue(iterator.Value[0]);
                        var at = warewolfListIterator.FetchNextValue(iterator.Value[1]);
                        var pad = warewolfListIterator.FetchNextValue(iterator.Value[2]);
                        pos = AddErrorAndMerge(mergeOperations, allErrors, pos, val, at, pad);
                    }
                }
                if (!allErrors.HasErrors())
                {
                    if (string.IsNullOrEmpty(Result))
                    {
                        AddDebugOutputItem(new DebugItemStaticDataParams("", ""));
                    }
                    else
                    {
                        AddToErrorsToDebugOutput(dataObject, update, mergeOperations, allErrors, errorResultTo);
                    }
                }
            }

            #endregion Iterate and Merge Data
        }

        private void AddToErrorsToDebugOutput(IDSFDataObject dataObject, int update, IDev2MergeOperations mergeOperations, ErrorResultTO allErrors, ErrorResultTO errorResultTo)
        {
            dataObject.Environment.Assign(Result, mergeOperations.MergeData.ToString(), update);
            allErrors.MergeErrors(errorResultTo);

            if (dataObject.IsDebugMode() && !allErrors.HasErrors())
            {
                AddDebugOutputItem(new DebugEvalResult(Result, "", dataObject.Environment, update));
            }
        }

#pragma warning disable S1541 // Methods and properties should not be too complex
        private int AddErrorAndMerge(IDev2MergeOperations mergeOperations, ErrorResultTO allErrors, int pos, string val, string at, string pad)
#pragma warning restore S1541 // Methods and properties should not be too complex
        {
            if (val != null && at != null && pad != null)
            {
                if (MergeCollection[pos].MergeType == "Index")
                {
                    if (string.IsNullOrEmpty(at))
                    {
                        allErrors.AddError(ErrorResource.BlankUSINGValue);
                    }

                    if (!Int32.TryParse(at, out int atValue) || atValue < 0)
                    {
                        allErrors.AddError(ErrorResource.USINGMustBeARealNumber);
                    }
                    if (pad.Length > 1)
                    {
                        allErrors.AddError(ErrorResource.PADDINGMustBeSingleCharecter);
                    }
                }
                else
                {
                    if (MergeCollection[pos].MergeType == "Chars" && string.IsNullOrEmpty(at))
                    {
                        allErrors.AddError(ErrorResource.BlankUSINGValue);
                    }
                }
                mergeOperations.Merge(val, MergeCollection[pos].MergeType, at, pad, MergeCollection[pos].Alignment);
                pos++;
            }

            return pos;
        }

        public override enFindMissingType GetFindMissingType() => enFindMissingType.MixedActivity;

        #endregion

        #region Private Methods

        void CleanArguments(IList<DataMergeDTO> args)
        {
            var count = 0;
            while (count < args.Count)
            {
                if (args[count].IsEmpty())
                {
                    args.RemoveAt(count);
                }
                else
                {
                    count++;
                }
            }
        }

        void InsertToCollection(IEnumerable<string> listToAdd, ModelItem modelItem)
        {
            var modelProperty = modelItem.Properties["MergeCollection"];
            if (modelProperty == null)
            {
                return;
            }
            var mic = modelProperty.Collection;

            if (mic == null)
            {
                return;
            }
            var listOfValidRows = MergeCollection.Where(c => !c.CanRemove()).ToList();
            if (listOfValidRows.Count > 0)
            {
                var dataMergeDto = MergeCollection.Last(c => !c.CanRemove());
                var startIndex = MergeCollection.IndexOf(dataMergeDto) + 1;
                foreach (string s in listToAdd)
                {
                    mic.Insert(startIndex, new DataMergeDTO(s, MergeCollection[startIndex - 1].MergeType, MergeCollection[startIndex - 1].At, startIndex + 1, MergeCollection[startIndex - 1].Padding, MergeCollection[startIndex - 1].Alignment));
                    startIndex++;
                }
                CleanUpCollection(mic, modelItem, startIndex);
            }
            else
            {
                AddToCollection(listToAdd, modelItem);
            }
        }

        void AddToCollection(IEnumerable<string> listToAdd, ModelItem modelItem)
        {
            var modelProperty = modelItem.Properties["MergeCollection"];
            if (modelProperty != null)
            {
                var mic = modelProperty.Collection;

                if (mic != null)
                {
                    var startIndex = 0;
                    var firstRowMergeType = MergeCollection[0].MergeType;
                    var firstRowPadding = MergeCollection[0].Padding;
                    var firstRowAlignment = MergeCollection[0].Alignment;
                    mic.Clear();
                    foreach (string s in listToAdd)
                    {
                        mic.Add(new DataMergeDTO(s, firstRowMergeType, string.Empty, startIndex + 1, firstRowPadding, firstRowAlignment));
                        startIndex++;
                    }
                    CleanUpCollection(mic, modelItem, startIndex);
                }
            }
        }

        void CleanUpCollection(ModelItemCollection mic, ModelItem modelItem, int startIndex)
        {
            if (startIndex < mic.Count)
            {
                mic.RemoveAt(startIndex);
            }
            mic.Add(new DataMergeDTO(string.Empty, "None", string.Empty, startIndex + 1, " ", "Left To Right"));
            var modelProperty = modelItem.Properties["DisplayName"];
            modelProperty?.SetValue(CreateDisplayName(modelItem, startIndex + 1));
        }

        string CreateDisplayName(ModelItem modelItem, int count)
        {
            var modelProperty = modelItem.Properties["DisplayName"];
            if (modelProperty != null)
            {
                var currentName = modelProperty.ComputedValue as string;
                if (currentName != null && currentName.Contains("(") && currentName.Contains(")"))
                {
                    currentName = currentName.Remove(currentName.Contains(" (") ? currentName.IndexOf(" (", StringComparison.Ordinal) : currentName.IndexOf("(", StringComparison.Ordinal));
                }
                currentName = currentName + " (" + (count - 1) + ")";
                return currentName;
            }
            return null;
        }

        #endregion Private Methods

        #region Get Debug Inputs/Outputs





        public override List<DebugItem> GetDebugInputs(IExecutionEnvironment env, int update) => _debugInputs;

        public override List<DebugItem> GetDebugOutputs(IExecutionEnvironment env, int update)
        {
            foreach (IDebugItem debugOutput in _debugOutputs)
            {
                debugOutput.FlushStringBuilder();
            }
            return _debugOutputs;
        }


        #endregion

        #region Get ForEach Inputs/Outputs

        public override void UpdateForEachInputs(IList<Tuple<string, string>> updates)
        {
            if (updates != null)
            {
                foreach (Tuple<string, string> t in updates)
                {
                    // locate all updates for this tuple
                    var t1 = t;
                    var items = MergeCollection.Where(c => !string.IsNullOrEmpty(c.InputVariable) && c.InputVariable.Equals(t1.Item1));

                    // issues updates
                    foreach (var a in items)
                    {
                        a.InputVariable = t.Item2;
                    }
                }
            }
        }

        public override void UpdateForEachOutputs(IList<Tuple<string, string>> updates)
        {
            var itemUpdate = updates?.FirstOrDefault(tuple => tuple.Item1 == Result);
            if (itemUpdate != null)
            {
                Result = itemUpdate.Item2;
            }
        }

        #endregion

        #region GetForEachInputs/Outputs

        public override IList<DsfForEachItem> GetForEachInputs()
        {
            var items = MergeCollection.Where(c => !string.IsNullOrEmpty(c.InputVariable)).Select(c => c.InputVariable).Union(MergeCollection.Where(c => !string.IsNullOrEmpty(c.At)).Select(c => c.At)).ToArray();
            return GetForEachItems(items);
        }

        public override IList<DsfForEachItem> GetForEachOutputs()
        {
            var items = new string[1];
            if (!string.IsNullOrEmpty(Result))
            {
                items[0] = Result;
            }
            return GetForEachItems(items);
        }

        #endregion

        #region Implementation of ICollectionActivity

        public int GetCollectionCount() => MergeCollection.Count(caseConvertTo => !caseConvertTo.CanRemove());

        public void AddListToCollection(IList<string> listToAdd, bool overwrite, ModelItem modelItem)
        {
            if (!overwrite)
            {
                InsertToCollection(listToAdd, modelItem);
            }
            else
            {
                AddToCollection(listToAdd, modelItem);
            }
        }

        #endregion

        public override List<string> GetOutputs() => new List<string> { Result };

        public override IEnumerable<StateVariable> GetState()
        {
            return new[]
            {
                new StateVariable
                {
                    Name="Merge Collection",
                    Type=StateVariable.StateType.Input,
                    Value= ActivityHelper.GetSerializedStateValueFromCollection(MergeCollection)
                },
                new StateVariable
                {
                    Name="Result",
                    Type=StateVariable.StateType.Output,
                    Value=Result
                }
            };
        }

        public bool Equals(DsfDataMergeActivity other)
        {
            if (ReferenceEquals(null, other))
            {
                return false;
            }

            if (ReferenceEquals(this, other))
            {
                return true;
            }

            var mergeCollsAreEqual = CommonEqualityOps.CollectionEquals(MergeCollection, other.MergeCollection, new DataMergeDtoComparer());
            return base.Equals(other) && string.Equals(Result, other.Result)
                && mergeCollsAreEqual;
        }

        public override bool Equals(object obj)
        {
            if (ReferenceEquals(null, obj))
            {
                return false;
            }

            if (ReferenceEquals(this, obj))
            {
                return true;
            }

            if (obj.GetType() != this.GetType())
            {
                return false;
            }

            return Equals((DsfDataMergeActivity)obj);
        }

        public override int GetHashCode()
        {
            unchecked
            {
                var hashCode = base.GetHashCode();
                hashCode = (hashCode * 397) ^ (Result != null ? Result.GetHashCode() : 0);
                hashCode = (hashCode * 397) ^ (MergeCollection != null ? MergeCollection.GetHashCode() : 0);
                return hashCode;
            }
        }
    }
}

---- Transformed Tree ----
using System;
using System.Activities;
using System.Activities.Presentation.Model;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using Dev2;
using Dev2.Activities;
using Dev2.Activities.Debug;
using Dev2.Common;
using Dev2.Common.Interfaces;
using Dev2.Common.Interfaces.Diagnostics.Debug;
using Dev2.Common.Interfaces.Toolbox;
using Dev2.Data;
using Dev2.Data.Interfaces;
using Dev2.Data.Operations;
using Dev2.Data.TO;
using Dev2.Data.Util;
using Dev2.Diagnostics;
using Dev2.Interfaces;
using Warewolf.Core;
using Warewolf.Resource.Errors;
using Warewolf.Storage;
using Warewolf.Storage.Interfaces;
using WarewolfParserInterop;
using Dev2.Comparer;
using Dev2.Common.State;
using Dev2.Utilities;

namespace Unlimited.Applications.BusinessDesignStudio.Activities

{
    [ToolDescriptorInfo("Data-DataMerge", "Data Merge", ToolType.Native, "8999E59A-38A3-43BB-A98F-6090C5C9EA1E", "Dev2.Activities", "1.0.0.0", "Legacy", "Data", "/Warewolf.Studio.Themes.Luna;component/Images.xaml", "Tool_Data_Data_Merge")]
    public class DsfDataMergeActivity : DsfActivityAbstract<string>, ICollectionActivity, IEquatable<DsfDataMergeActivity>
    {
        #region Class Members

        string _result;

        #endregion Class Members

        #region Properties

        IList<DataMergeDTO> _mergeCollection;
        public IList<DataMergeDTO> MergeCollection
        {
            get
            {
                return _mergeCollection;
            }
            set
            {
                _mergeCollection = value;
                OnPropertyChanged("MergeCollection");
            }
        }

        public new string Result
        {
            get
            {
                return _result;
            }
            set
            {
                _result = value;
                OnPropertyChanged("Result");
            }
        }

        protected override bool CanInduceIdle => true;

        #endregion

        #region Ctor

        public DsfDataMergeActivity()
            : base("Data Merge")
        {
            MergeCollection = new List<DataMergeDTO>();
        }

        #endregion

        #region Overridden NativeActivity Methods

        protected override void CacheMetadata(NativeActivityMetadata metadata) => base.CacheMetadata(metadata);


        protected override void OnExecute(NativeActivityContext context)
        {
            var dataObject = context.GetExtension<IDSFDataObject>();
            ExecuteTool(dataObject, 0);
        }

        protected override void ExecuteTool(IDSFDataObject dataObject, int update)
        {


            IDev2MergeOperations mergeOperations = new Dev2MergeOperations();
            var allErrors = new ErrorResultTO();
            var errorResultTo = new ErrorResultTO();

            InitializeDebug(dataObject);
            try
            {
                CleanArguments(MergeCollection);

                if (MergeCollection.Count <= 0)
                {
                    return;
                }
                TryExecuteTool(dataObject, update, mergeOperations, allErrors, errorResultTo);
            }
            catch (Exception e)
            {
                Dev2Logger.Error("DSFDataMerge", e, GlobalConstants.WarewolfError);
                allErrors.AddError(e.Message);
            }
            finally
            {
                #region Handle Errors

                if (allErrors.HasErrors())
                {
                    if (dataObject.IsDebugMode())
                    {
                        AddDebugOutputItem(new DebugItemStaticDataParams("", Result, ""));
                    }
                    DisplayAndWriteError("DsfDataMergeActivity", allErrors);
                    var errorString = allErrors.MakeDisplayReady();
                    dataObject.Environment.AddError(errorString);
                }

                if (dataObject.IsDebugMode())
                {
                    DispatchDebugState(dataObject, StateType.Before, update);
                    DispatchDebugState(dataObject, StateType.After, update);
                }

                #endregion
            }
        }

#pragma warning disable S1541 // Methods and properties should not be too complex
#pragma warning disable S3776 // Cognitive Complexity of methods should not be too high
        private void TryExecuteTool(IDSFDataObject dataObject, int update, IDev2MergeOperations mergeOperations, ErrorResultTO allErrors, ErrorResultTO errorResultTo)
#pragma warning restore S3776 // Cognitive Complexity of methods should not be too high
#pragma warning restore S1541 // Methods and properties should not be too complex
        {
            IWarewolfListIterator warewolfListIterator = new WarewolfListIterator();
            allErrors.MergeErrors(errorResultTo);
            var listOfIterators = new Dictionary<int, List<IWarewolfIterator>>();

            #region Create a iterator for each row in the data grid in the designer so that the right iteration happen on the data

            var dictionaryKey = 0;
            foreach (DataMergeDTO row in MergeCollection)
            {
                allErrors.MergeErrors(errorResultTo);

                if (dataObject.IsDebugMode())
                {
                    var debugItem = new DebugItem();
                    AddDebugItem(new DebugItemStaticDataParams("", (MergeCollection.IndexOf(row) + 1).ToString(CultureInfo.InvariantCulture)), debugItem);
                    AddDebugItem(new DebugEvalResult(row.InputVariable, "", dataObject.Environment, update, true), debugItem);
                    AddDebugItem(new DebugItemStaticDataParams(row.MergeType, "With"), debugItem);
                    AddDebugItem(new DebugEvalResult(row.At, "Using", dataObject.Environment, update), debugItem);
                    AddDebugItem(new DebugEvalResult(row.Padding, "Pad", dataObject.Environment, update), debugItem);

                    //Old workflows don't have this set. 
                    if (row.Alignment == null)
                    {
                        row.Alignment = string.Empty;
                    }

                    AddDebugItem(DataListUtil.IsEvaluated(row.Alignment) ? new DebugItemStaticDataParams("", row.Alignment, "Align") : new DebugItemStaticDataParams(row.Alignment, "Align"), debugItem);

                    _debugInputs.Add(debugItem);
                }
                var listOfEvalResultsForInput = dataObject.Environment.EvalForDataMerge(row.InputVariable, update);
                var innerIterator = new WarewolfListIterator();
                var innerListOfIters = new List<WarewolfIterator>();

                foreach (var listOfIterator in listOfEvalResultsForInput)
                {
                    var inIterator = new WarewolfIterator(listOfIterator);
                    innerIterator.AddVariableToIterateOn(inIterator);
                    innerListOfIters.Add(inIterator);
                }
                var atomList = new List<DataStorage.WarewolfAtom>();
                while (innerIterator.HasMoreData())
                {
                    var stringToUse = "";
                    foreach (var warewolfIterator in innerListOfIters)
                    {
                        stringToUse += warewolfIterator.GetNextValue();
                    }
                    atomList.Add(DataStorage.WarewolfAtom.NewDataString(stringToUse));
                }
                var finalString = string.Join("", atomList);
                var inputListResult = CommonFunctions.WarewolfEvalResult.NewWarewolfAtomListresult(new WarewolfAtomList<DataStorage.WarewolfAtom>(DataStorage.WarewolfAtom.Nothing, atomList));
                if (DataListUtil.IsFullyEvaluated(finalString))
                {
                    inputListResult = dataObject.Environment.Eval(finalString, update);
                }

                var inputIterator = new WarewolfIterator(inputListResult);
                var atIterator = new WarewolfIterator(dataObject.Environment.Eval(row.At, update));
                var paddingIterator = new WarewolfIterator(dataObject.Environment.Eval(row.Padding, update));
                warewolfListIterator.AddVariableToIterateOn(inputIterator);
                warewolfListIterator.AddVariableToIterateOn(atIterator);
                warewolfListIterator.AddVariableToIterateOn(paddingIterator);

                listOfIterators.Add(dictionaryKey, new List<IWarewolfIterator> { inputIterator, atIterator, paddingIterator });
                dictionaryKey++;
            }

            #endregion

            #region Iterate and Merge Data

            if (!allErrors.HasErrors())
            {
                while (warewolfListIterator.HasMoreData())
                {
                    var pos = 0;
                    foreach (var iterator in listOfIterators)
                    {
                        var val = warewolfListIterator.FetchNextValue(iterator.Value[0]);
                        var at = warewolfListIterator.FetchNextValue(iterator.Value[1]);
                        var pad = warewolfListIterator.FetchNextValue(iterator.Value[2]);
                        pos = AddErrorAndMerge(mergeOperations, allErrors, pos, val, at, pad);
                    }
                }
                if (!allErrors.HasErrors())
                {
                    if (string.IsNullOrEmpty(Result))
                    {
                        AddDebugOutputItem(new DebugItemStaticDataParams("", ""));
                    }
                    else
                    {
                        AddToErrorsToDebugOutput(dataObject, update, mergeOperations, allErrors, errorResultTo);
                    }
                }
            }

            #endregion Iterate and Merge Data
        }

        private void AddToErrorsToDebugOutput(IDSFDataObject dataObject, int update, IDev2MergeOperations mergeOperations, ErrorResultTO allErrors, ErrorResultTO errorResultTo)
        {
            dataObject.Environment.Assign(Result, mergeOperations.MergeData.ToString(), update);
            allErrors.MergeErrors(errorResultTo);

            if (dataObject.IsDebugMode() && !allErrors.HasErrors())
            {
                AddDebugOutputItem(new DebugEvalResult(Result, "", dataObject.Environment, update));
            }
        }

#pragma warning disable S1541 // Methods and properties should not be too complex
        private int AddErrorAndMerge(IDev2MergeOperations mergeOperations, ErrorResultTO allErrors, int pos, string val, string at, string pad)
#pragma warning restore S1541 // Methods and properties should not be too complex
        {
            if (val != null && at != null && pad != null)
            {
                if (MergeCollection[pos].MergeType == "Index")
                {
                    if (string.IsNullOrEmpty(at))
                    {
                        allErrors.AddError(ErrorResource.BlankUSINGValue);
                    }

                    if (!Int32.TryParse(at, out int atValue) || atValue < 0)
                    {
                        allErrors.AddError(ErrorResource.USINGMustBeARealNumber);
                    }
                    if (pad.Length > 1)
                    {
                        allErrors.AddError(ErrorResource.PADDINGMustBeSingleCharecter);
                    }
                }
                else
                {
                    if (MergeCollection[pos].MergeType == "Chars" && string.IsNullOrEmpty(at))
                    {
                        allErrors.AddError(ErrorResource.BlankUSINGValue);
                    }
                }
                mergeOperations.Merge(val, MergeCollection[pos].MergeType, at, pad, MergeCollection[pos].Alignment);
                pos++;
            }

            return pos;
        }

        public override enFindMissingType GetFindMissingType() => enFindMissingType.MixedActivity;

        #endregion

        #region Private Methods

        void CleanArguments(IList<DataMergeDTO> args)
        {
            var count = 0;
            while (count < args.Count)
            {
                if (args[count].IsEmpty())
                {
                    args.RemoveAt(count);
                }
                else
                {
                    count++;
                }
            }
        }

        void InsertToCollection(IEnumerable<string> listToAdd, ModelItem modelItem)
        {
            var modelProperty = modelItem.Properties["MergeCollection"];
            if (modelProperty == null)
            {
                return;
            }
            var mic = modelProperty.Collection;

            if (mic == null)
            {
                return;
            }
            var listOfValidRows = MergeCollection.Where(c => !c.CanRemove()).ToList();
            if (listOfValidRows.Count > 0)
            {
                var dataMergeDto = MergeCollection.Last(c => !c.CanRemove());
                var startIndex = MergeCollection.IndexOf(dataMergeDto) + 1;
                foreach (string s in listToAdd)
                {
                    mic.Insert(startIndex, new DataMergeDTO(s, MergeCollection[startIndex - 1].MergeType, MergeCollection[startIndex - 1].At, startIndex + 1, MergeCollection[startIndex - 1].Padding, MergeCollection[startIndex - 1].Alignment));
                    startIndex++;
                }
                CleanUpCollection(mic, modelItem, startIndex);
            }
            else
            {
                AddToCollection(listToAdd, modelItem);
            }
        }

        void AddToCollection(IEnumerable<string> listToAdd, ModelItem modelItem)
        {
            var modelProperty = modelItem.Properties["MergeCollection"];
            if (modelProperty != null)
            {
                var mic = modelProperty.Collection;

                if (mic != null)
                {
                    var startIndex = 0;
                    var firstRowMergeType = MergeCollection[0].MergeType;
                    var firstRowPadding = MergeCollection[0].Padding;
                    var firstRowAlignment = MergeCollection[0].Alignment;
                    mic.Clear();
                    foreach (string s in listToAdd)
                    {
                        mic.Add(new DataMergeDTO(s, firstRowMergeType, string.Empty, startIndex + 1, firstRowPadding, firstRowAlignment));
                        startIndex++;
                    }
                    CleanUpCollection(mic, modelItem, startIndex);
                }
            }
        }

        void CleanUpCollection(ModelItemCollection mic, ModelItem modelItem, int startIndex)
        {
            if (startIndex < mic.Count)
            {
                mic.RemoveAt(startIndex);
            }
            mic.Add(new DataMergeDTO(string.Empty, "None", string.Empty, startIndex + 1, " ", "Left To Right"));
            var modelProperty = modelItem.Properties["DisplayName"];
            modelProperty?.SetValue(CreateDisplayName(modelItem, startIndex + 1));
        }

        string CreateDisplayName(ModelItem modelItem, int count)
        {
            var modelProperty = modelItem.Properties["DisplayName"];
            if (modelProperty != null)
            {
                if (modelProperty.ComputedValue is string currentName && currentName.Contains("(") && currentName.Contains(")"))
                {
                    currentName = currentName.Remove(currentName.Contains(" (") ? currentName.IndexOf(" (", StringComparison.Ordinal) : currentName.IndexOf("(", StringComparison.Ordinal));
                }
                currentName = currentName + " (" + (count - 1) + ")";
                return currentName;
            }
            return null;
        }

        #endregion Private Methods

        #region Get Debug Inputs/Outputs





        public override List<DebugItem> GetDebugInputs(IExecutionEnvironment env, int update) => _debugInputs;

        public override List<DebugItem> GetDebugOutputs(IExecutionEnvironment env, int update)
        {
            foreach (IDebugItem debugOutput in _debugOutputs)
            {
                debugOutput.FlushStringBuilder();
            }
            return _debugOutputs;
        }


        #endregion

        #region Get ForEach Inputs/Outputs

        public override void UpdateForEachInputs(IList<Tuple<string, string>> updates)
        {
            if (updates != null)
            {
                foreach (Tuple<string, string> t in updates)
                {
                    // locate all updates for this tuple
                    var t1 = t;
                    var items = MergeCollection.Where(c => !string.IsNullOrEmpty(c.InputVariable) && c.InputVariable.Equals(t1.Item1));

                    // issues updates
                    foreach (var a in items)
                    {
                        a.InputVariable = t.Item2;
                    }
                }
            }
        }

        public override void UpdateForEachOutputs(IList<Tuple<string, string>> updates)
        {
            var itemUpdate = updates?.FirstOrDefault(tuple => tuple.Item1 == Result);
            if (itemUpdate != null)
            {
                Result = itemUpdate.Item2;
            }
        }

        #endregion

        #region GetForEachInputs/Outputs

        public override IList<DsfForEachItem> GetForEachInputs()
        {
            var items = MergeCollection.Where(c => !string.IsNullOrEmpty(c.InputVariable)).Select(c => c.InputVariable).Union(MergeCollection.Where(c => !string.IsNullOrEmpty(c.At)).Select(c => c.At)).ToArray();
            return GetForEachItems(items);
        }

        public override IList<DsfForEachItem> GetForEachOutputs()
        {
            var items = new string[1];
            if (!string.IsNullOrEmpty(Result))
            {
                items[0] = Result;
            }
            return GetForEachItems(items);
        }

        #endregion

        #region Implementation of ICollectionActivity

        public int GetCollectionCount() => MergeCollection.Count(caseConvertTo => !caseConvertTo.CanRemove());

        public void AddListToCollection(IList<string> listToAdd, bool overwrite, ModelItem modelItem)
        {
            if (!overwrite)
            {
                InsertToCollection(listToAdd, modelItem);
            }
            else
            {
                AddToCollection(listToAdd, modelItem);
            }
        }

        #endregion

        public override List<string> GetOutputs() => new List<string> { Result };

        public override IEnumerable<StateVariable> GetState()
        {
            return new[]
            {
                new StateVariable
                {
                    Name="Merge Collection",
                    Type=StateVariable.StateType.Input,
                    Value= ActivityHelper.GetSerializedStateValueFromCollection(MergeCollection)
                },
                new StateVariable
                {
                    Name="Result",
                    Type=StateVariable.StateType.Output,
                    Value=Result
                }
            };
        }

        public bool Equals(DsfDataMergeActivity other)
        {
            if (ReferenceEquals(null, other))
            {
                return false;
            }

            if (ReferenceEquals(this, other))
            {
                return true;
            }

            var mergeCollsAreEqual = CommonEqualityOps.CollectionEquals(MergeCollection, other.MergeCollection, new DataMergeDtoComparer());
            return base.Equals(other) && string.Equals(Result, other.Result)
                && mergeCollsAreEqual;
        }

        public override bool Equals(object obj)
        {
            if (ReferenceEquals(null, obj))
            {
                return false;
            }

            if (ReferenceEquals(this, obj))
            {
                return true;
            }

            if (obj.GetType() != this.GetType())
            {
                return false;
            }

            return Equals((DsfDataMergeActivity)obj);
        }

        public override int GetHashCode()
        {
            unchecked
            {
                var hashCode = base.GetHashCode();
                hashCode = (hashCode * 397) ^ (Result != null ? Result.GetHashCode() : 0);
                hashCode = (hashCode * 397) ^ (MergeCollection != null ? MergeCollection.GetHashCode() : 0);
                return hashCode;
            }
        }
    }
}

---- Semantic diagnostics *before* transformation ----
D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataMergeActivity.cs(192,49): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataMergeActivity.cs(196,48): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataMergeActivity.cs(196,48): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataMergeActivity.cs(196,48): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataMergeActivity.cs(198,42): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataMergeActivity.cs(202,41): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataMergeActivity.cs(210,34): error CS0103: The name 'DataStorage' does not exist in the current context,D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataMergeActivity.cs(213,39): error CS0103: The name 'CommonFunctions' does not exist in the current context,D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataMergeActivity.cs(213,121): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataMergeActivity.cs(213,147): error CS0103: The name 'DataStorage' does not exist in the current context,D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataMergeActivity.cs(216,39): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataMergeActivity.cs(219,41): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataMergeActivity.cs(220,55): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataMergeActivity.cs(220,38): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataMergeActivity.cs(221,60): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataMergeActivity.cs(221,43): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?)
---- Semantic diagnostics *after* transformation ----
D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataMergeActivity.cs(192,49): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataMergeActivity.cs(196,48): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataMergeActivity.cs(196,48): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataMergeActivity.cs(196,48): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataMergeActivity.cs(198,42): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataMergeActivity.cs(202,41): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataMergeActivity.cs(210,34): error CS0103: The name 'DataStorage' does not exist in the current context,D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataMergeActivity.cs(213,39): error CS0103: The name 'CommonFunctions' does not exist in the current context,D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataMergeActivity.cs(213,121): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataMergeActivity.cs(213,147): error CS0103: The name 'DataStorage' does not exist in the current context,D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataMergeActivity.cs(216,39): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataMergeActivity.cs(219,41): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataMergeActivity.cs(220,55): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataMergeActivity.cs(220,38): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataMergeActivity.cs(221,60): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataMergeActivity.cs(221,43): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataMergeActivity.cs(407,31): error CS0165: Use of unassigned local variable 'currentName'
######################################################################


######################################################################
Nr: 4 - UsePatternMatchingRewriterR8
Filepath: D:\a\1\s\Dev\Dev2.Activities\Activities\DsfBaseConvertActivity.cs
Description: Error: The created Syntax Tree is semantically incorrect.
------------------------------------------------------------------------
---- Original Tree ----
using System;
using System.Activities;
using System.Activities.Presentation.Model;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using Dev2;
using Dev2.Activities;
using Dev2.Activities.Debug;
using Dev2.Common;
using Dev2.Common.Interfaces.Diagnostics.Debug;
using Dev2.Common.Interfaces.Enums.Enums;
using Dev2.Common.Interfaces.Toolbox;
using Dev2.Common.State;
using Dev2.Comparer;
using Dev2.Converters;
using Dev2.Data.TO;
using Dev2.Diagnostics;
using Dev2.Interfaces;
using Dev2.Utilities;
using Dev2.Validation;
using Warewolf.Core;
using Warewolf.Resource.Errors;
using Warewolf.Storage.Interfaces;

namespace Unlimited.Applications.BusinessDesignStudio.Activities
{
    [ToolDescriptorInfo("Data-BaseConversion", "Base Convert", ToolType.Native, "8999E59A-38A3-43BB-A98F-6090C5C9EA1E", "Dev2.Activities", "1.0.0.0", "", "Data", "/Warewolf.Studio.Themes.Luna;component/Images.xaml", "Tool_Data_Base_Convert")]
    public class DsfBaseConvertActivity : DsfActivityAbstract<string>, ICollectionActivity, IEquatable<DsfBaseConvertActivity>
    {
        readonly Dev2BaseConversionFactory _fac = new Dev2BaseConversionFactory();


        /// <summary>
        /// The property that holds all the convertions
        /// </summary>
        public IList<BaseConvertTO> ConvertCollection { get; set; }

        public DsfBaseConvertActivity()
            : base("Base Conversion")
        {
            ConvertCollection = new List<BaseConvertTO>();
        }

        public override List<string> GetOutputs() => ConvertCollection.Select(to => to.ToExpression).ToList();

        protected override void CacheMetadata(NativeActivityMetadata metadata) => base.CacheMetadata(metadata);

        protected override void OnExecute(NativeActivityContext context)
        {
            var dataObject = context.GetExtension<IDSFDataObject>();

            ExecuteTool(dataObject, 0);
        }

        protected override void ExecuteTool(IDSFDataObject dataObject, int update)
        {
            var allErrors = new ErrorResultTO();
            InitializeDebug(dataObject);
            var env = dataObject.Environment;
            try
            {
                TryExecute(dataObject, update, allErrors, env);
            }
            catch (Exception e)
            {
                Dev2Logger.Error("DSFBaseConvert", e, GlobalConstants.WarewolfError);
                allErrors.AddError(e.Message);
            }
            finally
            {
                HandleErrors(dataObject, update, allErrors);
            }
        }

        private void TryExecute(IDSFDataObject dataObject, int update, ErrorResultTO allErrors, IExecutionEnvironment env)
        {
            CleanArgs();

            var inputIndex = 1;
            var outputIndex = 1;

            foreach (var item in ConvertCollection.Where(a => !String.IsNullOrEmpty(a.FromExpression)))
            {
                if (dataObject.IsDebugMode())
                {
                    var debugItem = new DebugItem();
                    AddDebugItem(new DebugItemStaticDataParams("", inputIndex.ToString(CultureInfo.InvariantCulture)), debugItem);
                    AddDebugItem(new DebugEvalResult(item.FromExpression, "Convert", env, update), debugItem);
                    AddDebugItem(new DebugItemStaticDataParams(item.FromType, "From"), debugItem);
                    AddDebugItem(new DebugItemStaticDataParams(item.ToType, "To"), debugItem);
                    _debugInputs.Add(debugItem);
                    inputIndex++;
                }

                try
                {
                    env.ApplyUpdate(item.FromExpression, TryConvertFunc(item, env, update), update);
                    IsSingleValueRule.ApplyIsSingleValueRule(item.FromExpression, allErrors);
                    if (dataObject.IsDebugMode())
                    {
                        var debugItem = new DebugItem();
                        AddDebugItem(new DebugItemStaticDataParams("", outputIndex.ToString(CultureInfo.InvariantCulture)), debugItem);
                        AddDebugItem(new DebugEvalResult(item.FromExpression, "", env, update), debugItem);
                        _debugOutputs.Add(debugItem);
                        outputIndex++;
                    }
                }
                catch (Exception e)
                {
                    Dev2Logger.Error("DSFBaseConvert", e, GlobalConstants.WarewolfError);
                    allErrors.AddError(e.Message);
                    if (dataObject.IsDebugMode())
                    {
                        outputIndex++;
                    }
                }
            }
        }

        private void HandleErrors(IDSFDataObject dataObject, int update, ErrorResultTO allErrors)
        {
            var hasErrors = allErrors.HasErrors();
            if (hasErrors)
            {
                DisplayAndWriteError(nameof(DsfBaseConvertActivity), allErrors);
                var errorString = allErrors.MakeDisplayReady();
                dataObject.Environment.AddError(errorString);
            }
            if (dataObject.IsDebugMode())
            {
                DispatchDebugState(dataObject, StateType.Before, update);
                DispatchDebugState(dataObject, StateType.After, update);
            }
        }

        public override enFindMissingType GetFindMissingType() => enFindMissingType.DataGridActivity;

        Func<DataStorage.WarewolfAtom, DataStorage.WarewolfAtom> TryConvertFunc(BaseConvertTO item, IExecutionEnvironment env, int update) => a =>
        {
            var from = _fac.CreateConverter((enDev2BaseConvertType)Dev2EnumConverter.GetEnumFromStringDiscription(item.FromType, typeof(enDev2BaseConvertType)));
            var to = _fac.CreateConverter((enDev2BaseConvertType)Dev2EnumConverter.GetEnumFromStringDiscription(item.ToType, typeof(enDev2BaseConvertType)));
            var broker = _fac.CreateBroker(@from, to);
            var value = a.ToString();
            if (a.IsNothing)
            {
                throw new Exception(string.Format(ErrorResource.NullScalarValue, item.FromExpression));
            }
            if (String.IsNullOrEmpty(value))
            {
                return DataStorage.WarewolfAtom.NewDataString("");
            }
            var upper = broker.Convert(value);
            var evalled = env.Eval(upper, update);
            if (evalled.IsWarewolfAtomResult)
            {
                if (evalled is CommonFunctions.WarewolfEvalResult.WarewolfAtomResult warewolfAtomResult)
                {
                    return warewolfAtomResult.Item;
                }
                return DataStorage.WarewolfAtom.Nothing;
            }
            return DataStorage.WarewolfAtom.NewDataString(CommonFunctions.evalResultToString(evalled));
        };

        void CleanArgs()
        {
            var count = 0;
            while (count < ConvertCollection.Count)
            {
                if (string.IsNullOrWhiteSpace(ConvertCollection[count].FromExpression))
                {
                    ConvertCollection.RemoveAt(count);
                }
                else
                {
                    count++;
                }
            }
        }

        public override List<DebugItem> GetDebugInputs(IExecutionEnvironment env, int update)
        {
            foreach (IDebugItem debugInput in _debugInputs)
            {
                debugInput.FlushStringBuilder();
            }
            return _debugInputs;
        }

        public override List<DebugItem> GetDebugOutputs(IExecutionEnvironment env, int update)
        {
            foreach (IDebugItem debugOutput in _debugOutputs)
            {
                debugOutput.FlushStringBuilder();
            }
            return _debugOutputs;
        }

        void InsertToCollection(IEnumerable<string> listToAdd, ModelItem modelItem)
        {
            var modelProperty = modelItem.Properties["ConvertCollection"];
            var mic = modelProperty?.Collection;

            if (mic != null)
            {
                var listOfValidRows = ConvertCollection.Where(c => !c.CanRemove()).ToList();
                if (listOfValidRows.Count > 0)
                {
                    var baseConvertTo = ConvertCollection.Last(c => !c.CanRemove());
                    var startIndex = ConvertCollection.IndexOf(baseConvertTo) + 1;
                    foreach (string s in listToAdd)
                    {
                        mic.Insert(startIndex, new BaseConvertTO(s, ConvertCollection[startIndex - 1].FromType, ConvertCollection[startIndex - 1].ToType, string.Empty, startIndex + 1));
                        startIndex++;
                    }
                    CleanUpCollection(mic, modelItem, startIndex);
                }
                else
                {
                    AddToCollection(listToAdd, modelItem);
                }
            }
        }

        void AddToCollection(IEnumerable<string> listToAdd, ModelItem modelItem)
        {
            var modelProperty = modelItem.Properties["ConvertCollection"];
            var mic = modelProperty?.Collection;

            if (mic != null)
            {
                var startIndex = 0;
                var firstRowConvertFromType = ConvertCollection[0].FromType;
                var firstRowConvertToType = ConvertCollection[0].ToType;
                mic.Clear();
                foreach (string s in listToAdd)
                {
                    mic.Add(new BaseConvertTO(s, firstRowConvertFromType, firstRowConvertToType, string.Empty, startIndex + 1));
                    startIndex++;
                }
                CleanUpCollection(mic, modelItem, startIndex);
            }
        }

        void CleanUpCollection(ModelItemCollection mic, ModelItem modelItem, int startIndex)
        {
            if (startIndex < mic.Count)
            {
                mic.RemoveAt(startIndex);
            }
            mic.Add(new BaseConvertTO(string.Empty, "Text", "Base 64", string.Empty, startIndex + 1));
            var modelProperty = modelItem.Properties["DisplayName"];
            modelProperty?.SetValue(CreateDisplayName(modelItem, startIndex + 1));
        }

        string CreateDisplayName(ModelItem modelItem, int count)
        {
            var modelProperty = modelItem.Properties["DisplayName"];
            if (modelProperty != null)
            {
                var currentName = modelProperty.ComputedValue as string;
                if (currentName != null && currentName.Contains("(") && currentName.Contains(")"))
                {
                    currentName = currentName.Remove(currentName.Contains(" (") ? currentName.IndexOf(" (", StringComparison.Ordinal) : currentName.IndexOf("(", StringComparison.Ordinal));
                }
                currentName = currentName + " (" + (count - 1) + ")";
                return currentName;
            }

            return string.Empty;
        }

        public override void UpdateForEachInputs(IList<Tuple<string, string>> updates)
        {
            foreach (Tuple<string, string> t in updates)
            {
                // locate all updates for this tuple
                var t1 = t;
                var items = ConvertCollection.Where(c => !string.IsNullOrEmpty(c.FromExpression) && c.FromExpression.Contains(t1.Item1));

                // issues updates
                foreach (var a in items)
                {
                    a.FromExpression = a.FromExpression.Replace(t.Item1, t.Item2);
                }
            }
        }

        public override void UpdateForEachOutputs(IList<Tuple<string, string>> updates)
        {
            foreach (Tuple<string, string> t in updates)
            {
                var t1 = t;
                var items = ConvertCollection.Where(c => !string.IsNullOrEmpty(c.FromExpression) && c.FromExpression.Contains(t1.Item1));

                // issues updates
                foreach (var a in items)
                {
                    a.ToExpression = a.FromExpression.Replace(t.Item1, t.Item2);
                }
            }
        }

        public override IList<DsfForEachItem> GetForEachInputs()
        {
            var result = new List<DsfForEachItem>();

            foreach (var item in ConvertCollection)
            {
                if (!string.IsNullOrEmpty(item.FromExpression) && item.FromExpression.Contains("[["))
                {
                    result.Add(new DsfForEachItem { Name = item.FromExpression, Value = item.FromExpression });
                }
            }

            return result;
        }

        public override IList<DsfForEachItem> GetForEachOutputs()
        {
            var result = new List<DsfForEachItem>();

            foreach (var item in ConvertCollection)
            {
                if (!string.IsNullOrEmpty(item.FromExpression) && item.FromExpression.Contains("[["))
                {
                    result.Add(new DsfForEachItem { Name = item.FromExpression, Value = item.FromExpression });
                }
            }

            return result;
        }

        public int GetCollectionCount() => throw new NotImplementedException();

        public void AddListToCollection(IList<string> listToAdd, bool overwrite, ModelItem modelItem)
        {
            if (!overwrite)
            {
                InsertToCollection(listToAdd, modelItem);
            }
            else
            {
                AddToCollection(listToAdd, modelItem);
            }
        }

        public bool Equals(DsfBaseConvertActivity other)
        {
            if (ReferenceEquals(null, other))
            {
                return false;
            }

            if (ReferenceEquals(this, other))
            {
                return true;
            }

            var collectionEquals = CommonEqualityOps.CollectionEquals(ConvertCollection, other.ConvertCollection, new BaseConvertToComparer());
            return base.Equals(other)
                && collectionEquals;
        }

        public override bool Equals(object obj)
        {
            if (ReferenceEquals(null, obj))
            {
                return false;
            }

            if (ReferenceEquals(this, obj))
            {
                return true;
            }

            if (obj.GetType() != this.GetType())
            {
                return false;
            }

            return Equals((DsfBaseConvertActivity)obj);
        }

        public override int GetHashCode()
        {
            unchecked
            {
                var hashCode = base.GetHashCode();
                hashCode = (hashCode * 397) ^ (_fac != null ? _fac.GetHashCode() : 0);
                hashCode = (hashCode * 397) ^ (ConvertCollection != null ? ConvertCollection.GetHashCode() : 0);
                return hashCode;
            }
        }

        public override IEnumerable<StateVariable> GetState()
        {
            return new[]
            {
                new StateVariable
                {
                    Name = "Convert Collection",
                    Value = ActivityHelper.GetSerializedStateValueFromCollection(ConvertCollection),
                    Type = StateVariable.StateType.InputOutput
                }
            };
        }
    }
}

---- Transformed Tree ----
using System;
using System.Activities;
using System.Activities.Presentation.Model;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using Dev2;
using Dev2.Activities;
using Dev2.Activities.Debug;
using Dev2.Common;
using Dev2.Common.Interfaces.Diagnostics.Debug;
using Dev2.Common.Interfaces.Enums.Enums;
using Dev2.Common.Interfaces.Toolbox;
using Dev2.Common.State;
using Dev2.Comparer;
using Dev2.Converters;
using Dev2.Data.TO;
using Dev2.Diagnostics;
using Dev2.Interfaces;
using Dev2.Utilities;
using Dev2.Validation;
using Warewolf.Core;
using Warewolf.Resource.Errors;
using Warewolf.Storage.Interfaces;

namespace Unlimited.Applications.BusinessDesignStudio.Activities
{
    [ToolDescriptorInfo("Data-BaseConversion", "Base Convert", ToolType.Native, "8999E59A-38A3-43BB-A98F-6090C5C9EA1E", "Dev2.Activities", "1.0.0.0", "", "Data", "/Warewolf.Studio.Themes.Luna;component/Images.xaml", "Tool_Data_Base_Convert")]
    public class DsfBaseConvertActivity : DsfActivityAbstract<string>, ICollectionActivity, IEquatable<DsfBaseConvertActivity>
    {
        readonly Dev2BaseConversionFactory _fac = new Dev2BaseConversionFactory();


        /// <summary>
        /// The property that holds all the convertions
        /// </summary>
        public IList<BaseConvertTO> ConvertCollection { get; set; }

        public DsfBaseConvertActivity()
            : base("Base Conversion")
        {
            ConvertCollection = new List<BaseConvertTO>();
        }

        public override List<string> GetOutputs() => ConvertCollection.Select(to => to.ToExpression).ToList();

        protected override void CacheMetadata(NativeActivityMetadata metadata) => base.CacheMetadata(metadata);

        protected override void OnExecute(NativeActivityContext context)
        {
            var dataObject = context.GetExtension<IDSFDataObject>();

            ExecuteTool(dataObject, 0);
        }

        protected override void ExecuteTool(IDSFDataObject dataObject, int update)
        {
            var allErrors = new ErrorResultTO();
            InitializeDebug(dataObject);
            var env = dataObject.Environment;
            try
            {
                TryExecute(dataObject, update, allErrors, env);
            }
            catch (Exception e)
            {
                Dev2Logger.Error("DSFBaseConvert", e, GlobalConstants.WarewolfError);
                allErrors.AddError(e.Message);
            }
            finally
            {
                HandleErrors(dataObject, update, allErrors);
            }
        }

        private void TryExecute(IDSFDataObject dataObject, int update, ErrorResultTO allErrors, IExecutionEnvironment env)
        {
            CleanArgs();

            var inputIndex = 1;
            var outputIndex = 1;

            foreach (var item in ConvertCollection.Where(a => !String.IsNullOrEmpty(a.FromExpression)))
            {
                if (dataObject.IsDebugMode())
                {
                    var debugItem = new DebugItem();
                    AddDebugItem(new DebugItemStaticDataParams("", inputIndex.ToString(CultureInfo.InvariantCulture)), debugItem);
                    AddDebugItem(new DebugEvalResult(item.FromExpression, "Convert", env, update), debugItem);
                    AddDebugItem(new DebugItemStaticDataParams(item.FromType, "From"), debugItem);
                    AddDebugItem(new DebugItemStaticDataParams(item.ToType, "To"), debugItem);
                    _debugInputs.Add(debugItem);
                    inputIndex++;
                }

                try
                {
                    env.ApplyUpdate(item.FromExpression, TryConvertFunc(item, env, update), update);
                    IsSingleValueRule.ApplyIsSingleValueRule(item.FromExpression, allErrors);
                    if (dataObject.IsDebugMode())
                    {
                        var debugItem = new DebugItem();
                        AddDebugItem(new DebugItemStaticDataParams("", outputIndex.ToString(CultureInfo.InvariantCulture)), debugItem);
                        AddDebugItem(new DebugEvalResult(item.FromExpression, "", env, update), debugItem);
                        _debugOutputs.Add(debugItem);
                        outputIndex++;
                    }
                }
                catch (Exception e)
                {
                    Dev2Logger.Error("DSFBaseConvert", e, GlobalConstants.WarewolfError);
                    allErrors.AddError(e.Message);
                    if (dataObject.IsDebugMode())
                    {
                        outputIndex++;
                    }
                }
            }
        }

        private void HandleErrors(IDSFDataObject dataObject, int update, ErrorResultTO allErrors)
        {
            var hasErrors = allErrors.HasErrors();
            if (hasErrors)
            {
                DisplayAndWriteError(nameof(DsfBaseConvertActivity), allErrors);
                var errorString = allErrors.MakeDisplayReady();
                dataObject.Environment.AddError(errorString);
            }
            if (dataObject.IsDebugMode())
            {
                DispatchDebugState(dataObject, StateType.Before, update);
                DispatchDebugState(dataObject, StateType.After, update);
            }
        }

        public override enFindMissingType GetFindMissingType() => enFindMissingType.DataGridActivity;

        Func<DataStorage.WarewolfAtom, DataStorage.WarewolfAtom> TryConvertFunc(BaseConvertTO item, IExecutionEnvironment env, int update) => a =>
        {
            var from = _fac.CreateConverter((enDev2BaseConvertType)Dev2EnumConverter.GetEnumFromStringDiscription(item.FromType, typeof(enDev2BaseConvertType)));
            var to = _fac.CreateConverter((enDev2BaseConvertType)Dev2EnumConverter.GetEnumFromStringDiscription(item.ToType, typeof(enDev2BaseConvertType)));
            var broker = _fac.CreateBroker(@from, to);
            var value = a.ToString();
            if (a.IsNothing)
            {
                throw new Exception(string.Format(ErrorResource.NullScalarValue, item.FromExpression));
            }
            if (String.IsNullOrEmpty(value))
            {
                return DataStorage.WarewolfAtom.NewDataString("");
            }
            var upper = broker.Convert(value);
            var evalled = env.Eval(upper, update);
            if (evalled.IsWarewolfAtomResult)
            {
                if (evalled is CommonFunctions.WarewolfEvalResult.WarewolfAtomResult warewolfAtomResult)
                {
                    return warewolfAtomResult.Item;
                }
                return DataStorage.WarewolfAtom.Nothing;
            }
            return DataStorage.WarewolfAtom.NewDataString(CommonFunctions.evalResultToString(evalled));
        };

        void CleanArgs()
        {
            var count = 0;
            while (count < ConvertCollection.Count)
            {
                if (string.IsNullOrWhiteSpace(ConvertCollection[count].FromExpression))
                {
                    ConvertCollection.RemoveAt(count);
                }
                else
                {
                    count++;
                }
            }
        }

        public override List<DebugItem> GetDebugInputs(IExecutionEnvironment env, int update)
        {
            foreach (IDebugItem debugInput in _debugInputs)
            {
                debugInput.FlushStringBuilder();
            }
            return _debugInputs;
        }

        public override List<DebugItem> GetDebugOutputs(IExecutionEnvironment env, int update)
        {
            foreach (IDebugItem debugOutput in _debugOutputs)
            {
                debugOutput.FlushStringBuilder();
            }
            return _debugOutputs;
        }

        void InsertToCollection(IEnumerable<string> listToAdd, ModelItem modelItem)
        {
            var modelProperty = modelItem.Properties["ConvertCollection"];
            var mic = modelProperty?.Collection;

            if (mic != null)
            {
                var listOfValidRows = ConvertCollection.Where(c => !c.CanRemove()).ToList();
                if (listOfValidRows.Count > 0)
                {
                    var baseConvertTo = ConvertCollection.Last(c => !c.CanRemove());
                    var startIndex = ConvertCollection.IndexOf(baseConvertTo) + 1;
                    foreach (string s in listToAdd)
                    {
                        mic.Insert(startIndex, new BaseConvertTO(s, ConvertCollection[startIndex - 1].FromType, ConvertCollection[startIndex - 1].ToType, string.Empty, startIndex + 1));
                        startIndex++;
                    }
                    CleanUpCollection(mic, modelItem, startIndex);
                }
                else
                {
                    AddToCollection(listToAdd, modelItem);
                }
            }
        }

        void AddToCollection(IEnumerable<string> listToAdd, ModelItem modelItem)
        {
            var modelProperty = modelItem.Properties["ConvertCollection"];
            var mic = modelProperty?.Collection;

            if (mic != null)
            {
                var startIndex = 0;
                var firstRowConvertFromType = ConvertCollection[0].FromType;
                var firstRowConvertToType = ConvertCollection[0].ToType;
                mic.Clear();
                foreach (string s in listToAdd)
                {
                    mic.Add(new BaseConvertTO(s, firstRowConvertFromType, firstRowConvertToType, string.Empty, startIndex + 1));
                    startIndex++;
                }
                CleanUpCollection(mic, modelItem, startIndex);
            }
        }

        void CleanUpCollection(ModelItemCollection mic, ModelItem modelItem, int startIndex)
        {
            if (startIndex < mic.Count)
            {
                mic.RemoveAt(startIndex);
            }
            mic.Add(new BaseConvertTO(string.Empty, "Text", "Base 64", string.Empty, startIndex + 1));
            var modelProperty = modelItem.Properties["DisplayName"];
            modelProperty?.SetValue(CreateDisplayName(modelItem, startIndex + 1));
        }

        string CreateDisplayName(ModelItem modelItem, int count)
        {
            var modelProperty = modelItem.Properties["DisplayName"];
            if (modelProperty != null)
            {
                if (modelProperty.ComputedValue is string currentName && currentName.Contains("(") && currentName.Contains(")"))
                {
                    currentName = currentName.Remove(currentName.Contains(" (") ? currentName.IndexOf(" (", StringComparison.Ordinal) : currentName.IndexOf("(", StringComparison.Ordinal));
                }
                currentName = currentName + " (" + (count - 1) + ")";
                return currentName;
            }

            return string.Empty;
        }

        public override void UpdateForEachInputs(IList<Tuple<string, string>> updates)
        {
            foreach (Tuple<string, string> t in updates)
            {
                // locate all updates for this tuple
                var t1 = t;
                var items = ConvertCollection.Where(c => !string.IsNullOrEmpty(c.FromExpression) && c.FromExpression.Contains(t1.Item1));

                // issues updates
                foreach (var a in items)
                {
                    a.FromExpression = a.FromExpression.Replace(t.Item1, t.Item2);
                }
            }
        }

        public override void UpdateForEachOutputs(IList<Tuple<string, string>> updates)
        {
            foreach (Tuple<string, string> t in updates)
            {
                var t1 = t;
                var items = ConvertCollection.Where(c => !string.IsNullOrEmpty(c.FromExpression) && c.FromExpression.Contains(t1.Item1));

                // issues updates
                foreach (var a in items)
                {
                    a.ToExpression = a.FromExpression.Replace(t.Item1, t.Item2);
                }
            }
        }

        public override IList<DsfForEachItem> GetForEachInputs()
        {
            var result = new List<DsfForEachItem>();

            foreach (var item in ConvertCollection)
            {
                if (!string.IsNullOrEmpty(item.FromExpression) && item.FromExpression.Contains("[["))
                {
                    result.Add(new DsfForEachItem { Name = item.FromExpression, Value = item.FromExpression });
                }
            }

            return result;
        }

        public override IList<DsfForEachItem> GetForEachOutputs()
        {
            var result = new List<DsfForEachItem>();

            foreach (var item in ConvertCollection)
            {
                if (!string.IsNullOrEmpty(item.FromExpression) && item.FromExpression.Contains("[["))
                {
                    result.Add(new DsfForEachItem { Name = item.FromExpression, Value = item.FromExpression });
                }
            }

            return result;
        }

        public int GetCollectionCount() => throw new NotImplementedException();

        public void AddListToCollection(IList<string> listToAdd, bool overwrite, ModelItem modelItem)
        {
            if (!overwrite)
            {
                InsertToCollection(listToAdd, modelItem);
            }
            else
            {
                AddToCollection(listToAdd, modelItem);
            }
        }

        public bool Equals(DsfBaseConvertActivity other)
        {
            if (ReferenceEquals(null, other))
            {
                return false;
            }

            if (ReferenceEquals(this, other))
            {
                return true;
            }

            var collectionEquals = CommonEqualityOps.CollectionEquals(ConvertCollection, other.ConvertCollection, new BaseConvertToComparer());
            return base.Equals(other)
                && collectionEquals;
        }

        public override bool Equals(object obj)
        {
            if (ReferenceEquals(null, obj))
            {
                return false;
            }

            if (ReferenceEquals(this, obj))
            {
                return true;
            }

            if (obj.GetType() != this.GetType())
            {
                return false;
            }

            return Equals((DsfBaseConvertActivity)obj);
        }

        public override int GetHashCode()
        {
            unchecked
            {
                var hashCode = base.GetHashCode();
                hashCode = (hashCode * 397) ^ (_fac != null ? _fac.GetHashCode() : 0);
                hashCode = (hashCode * 397) ^ (ConvertCollection != null ? ConvertCollection.GetHashCode() : 0);
                return hashCode;
            }
        }

        public override IEnumerable<StateVariable> GetState()
        {
            return new[]
            {
                new StateVariable
                {
                    Name = "Convert Collection",
                    Value = ActivityHelper.GetSerializedStateValueFromCollection(ConvertCollection),
                    Type = StateVariable.StateType.InputOutput
                }
            };
        }
    }
}

---- Semantic diagnostics *before* transformation ----
D:\a\1\s\Dev\Dev2.Activities\Activities\DsfBaseConvertActivity.cs(150,14): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfBaseConvertActivity.cs(150,40): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfBaseConvertActivity.cs(109,21): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfBaseConvertActivity.cs(162,24): error CS0103: The name 'DataStorage' does not exist in the current context,D:\a\1\s\Dev\Dev2.Activities\Activities\DsfBaseConvertActivity.cs(165,27): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfBaseConvertActivity.cs(168,32): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfBaseConvertActivity.cs(172,24): error CS0103: The name 'DataStorage' does not exist in the current context,D:\a\1\s\Dev\Dev2.Activities\Activities\DsfBaseConvertActivity.cs(174,20): error CS0103: The name 'DataStorage' does not exist in the current context,D:\a\1\s\Dev\Dev2.Activities\Activities\DsfBaseConvertActivity.cs(174,59): error CS0103: The name 'CommonFunctions' does not exist in the current context
---- Semantic diagnostics *after* transformation ----
D:\a\1\s\Dev\Dev2.Activities\Activities\DsfBaseConvertActivity.cs(150,14): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfBaseConvertActivity.cs(150,40): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfBaseConvertActivity.cs(109,21): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfBaseConvertActivity.cs(162,24): error CS0103: The name 'DataStorage' does not exist in the current context,D:\a\1\s\Dev\Dev2.Activities\Activities\DsfBaseConvertActivity.cs(165,27): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfBaseConvertActivity.cs(168,32): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfBaseConvertActivity.cs(172,24): error CS0103: The name 'DataStorage' does not exist in the current context,D:\a\1\s\Dev\Dev2.Activities\Activities\DsfBaseConvertActivity.cs(174,20): error CS0103: The name 'DataStorage' does not exist in the current context,D:\a\1\s\Dev\Dev2.Activities\Activities\DsfBaseConvertActivity.cs(174,59): error CS0103: The name 'CommonFunctions' does not exist in the current context,D:\a\1\s\Dev\Dev2.Activities\Activities\DsfBaseConvertActivity.cs(277,31): error CS0165: Use of unassigned local variable 'currentName'
######################################################################


######################################################################
Nr: 5 - UsePatternMatchingRewriterR8
Filepath: D:\a\1\s\Dev\Dev2.Activities\Activities\DsfCaseConvertActivity.cs
Description: Error: The created Syntax Tree is semantically incorrect.
------------------------------------------------------------------------
---- Original Tree ----
using System;
using System.Activities;
using System.Activities.Presentation.Model;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using Dev2;
using Dev2.Activities;
using Dev2.Activities.Debug;
using Dev2.Common;
using Dev2.Common.Interfaces.Core.Convertors.Case;
using Dev2.Common.Interfaces.Diagnostics.Debug;
using Dev2.Common.Interfaces.Toolbox;
using Dev2.Comparer;
using Dev2.Data.TO;
using Dev2.Diagnostics;
using Dev2.Interfaces;
using Dev2.Validation;
using Warewolf.Core;
using Warewolf.Resource.Errors;
using Warewolf.Storage.Interfaces;
using Dev2.Activities.Factories.Case;
using Dev2.Common.State;
using Dev2.Utilities;

namespace Unlimited.Applications.BusinessDesignStudio.Activities
{
    [ToolDescriptorInfo("Data-CaseConversion", "Case Convert", ToolType.Native, "8999E59A-38A3-43BB-A98F-6090C5C9EA1E", "Dev2.Activities", "1.0.0.0", "Legacy", "Data", "/Warewolf.Studio.Themes.Luna;component/Images.xaml", "Tool_Data_Case_Convert")]
    public class DsfCaseConvertActivity : DsfActivityAbstract<string>, ICollectionActivity, IEquatable<DsfCaseConvertActivity>
    {
        public IList<ICaseConvertTO> ConvertCollection { get; set; }

        public DsfCaseConvertActivity()
            : base("Case Conversion")
        {
            ConvertCollection = new List<ICaseConvertTO>();
        }

        protected override void CacheMetadata(NativeActivityMetadata metadata) => base.CacheMetadata(metadata);

        protected override void OnExecute(NativeActivityContext context)
        {
            var dataObject = context.GetExtension<IDSFDataObject>();
            ExecuteTool(dataObject, 0);
        }

        protected override void ExecuteTool(IDSFDataObject dataObject, int update)
        {
            var allErrors = new ErrorResultTO();
            var errors = new ErrorResultTO();
            var env = dataObject.Environment;
            InitializeDebug(dataObject);
            try
            {
                TryExecute(dataObject, update, allErrors, errors, env);
            }
            catch (Exception e)
            {
                allErrors.AddError(e.Message);
            }
            finally
            {
                HandleErrors(dataObject, update, allErrors);
            }
        }

        private void TryExecute(IDSFDataObject dataObject, int update, ErrorResultTO allErrors, ErrorResultTO errors, IExecutionEnvironment env)
        {
            CleanArgs();

            allErrors.MergeErrors(errors);

            var inputIndex = 1;
            var outputIndex = 1;

            foreach (ICaseConvertTO item in ConvertCollection.Where(a => !String.IsNullOrEmpty(a.StringToConvert)))
            {
                IsSingleValueRule.ApplyIsSingleValueRule(item.ExpressionToConvert, allErrors);
                if (dataObject.IsDebugMode())
                {
                    var debugItem = new DebugItem();
                    AddDebugItem(new DebugItemStaticDataParams("", inputIndex.ToString(CultureInfo.InvariantCulture)), debugItem);
                    AddDebugItem(new DebugEvalResult(item.StringToConvert, "Convert", env, update), debugItem);
                    AddDebugItem(new DebugItemStaticDataParams(item.ConvertType, "To"), debugItem);
                    _debugInputs.Add(debugItem);
                    inputIndex++;
                }
                if (!allErrors.HasErrors())
                {
                    try
                    {
                        env.ApplyUpdate(item.StringToConvert, TryConvertFunc(item, env, update), update);
                    }
                    catch (Exception e)
                    {
                        allErrors.AddError(e.Message);
                    }

                    if (!allErrors.HasErrors() && dataObject.IsDebugMode())
                    {
                        var debugItem = new DebugItem();
                        AddDebugItem(new DebugItemStaticDataParams("", outputIndex.ToString(CultureInfo.InvariantCulture)), debugItem);
                        AddDebugItem(new DebugEvalResult(item.StringToConvert, "", env, update), debugItem);
                        _debugOutputs.Add(debugItem);
                        outputIndex++;
                    }
                }
            }
        }

        void HandleErrors(IDSFDataObject dataObject, int update, ErrorResultTO allErrors)
        {
            var hasErrors = allErrors.HasErrors();
            if (hasErrors)
            {
                DisplayAndWriteError(nameof(DsfCaseConvertActivity), allErrors);
                var errorString = allErrors.MakeDisplayReady();
                dataObject.Environment.AddError(errorString);
            }
            if (dataObject.IsDebugMode())
            {
                DispatchDebugState(dataObject, StateType.Before, update);
                DispatchDebugState(dataObject, StateType.After, update);
            }
        }

        static Func<DataStorage.WarewolfAtom, DataStorage.WarewolfAtom> TryConvertFunc(ICaseConvertTO conversionType, IExecutionEnvironment env, int update)
        {
            var convertFunct = CaseConverter.GetFuncs();

            if (convertFunct.TryGetValue(conversionType.ConvertType, out Func<string, string> returnedFunc) && returnedFunc != null)
            {
                return a =>
                {
                    var upper = returnedFunc.Invoke(a.ToString());
                    var evalled = env.Eval(upper, update);

                    if (evalled.IsWarewolfAtomResult)
                    {
                        if (evalled is CommonFunctions.WarewolfEvalResult.WarewolfAtomResult warewolfAtomResult)
                        {
                            return warewolfAtomResult.Item;
                        }
                        return DataStorage.WarewolfAtom.Nothing;
                    }

                    return DataStorage.WarewolfAtom.NewDataString(CommonFunctions.evalResultToString(evalled));
                };
            }
            throw new Exception(ErrorResource.ConvertOptionDoesNotExist);
        }


        public override enFindMissingType GetFindMissingType() => enFindMissingType.DataGridActivity;

        void BuildStringToConvert(int i, List<string> targetList, List<string> resultList)
        {
            ConvertCollection[i].StringToConvert = targetList[0];
            ConvertCollection[i].Result = resultList[0];
            var canidateResult = resultList[0];
            for (var q = 1; q < targetList.Count; q++)
            {
                var pos = ConvertCollection.Count + 1;

                // now process all new results ;)
                // we always keep the last value in-case we run out of indexes
                // as they do not have to balance ;)
                if (q < resultList.Count)
                {
                    canidateResult = resultList[q];
                }

                ConvertCollection.Add(new CaseConvertTO(targetList[q], ConvertCollection[i].ConvertType, canidateResult, pos));
            }
        }

        List<string> BreakIntoTokens(string value)
        {
            var parts = value.Split(',');
            var result = parts.Select(r => r.Trim()).ToList();
            return result;
        }

        void CleanArgs()
        {
            var workItems = new ICaseConvertTO[ConvertCollection.Count];
            ConvertCollection.CopyTo(workItems, 0);


            for (var i = 0; i < workItems.Length; i++)

            {
                var convertResult = workItems[i].Result;
                var convertTarget = workItems[i].StringToConvert;

                if (!string.IsNullOrEmpty(convertTarget) && !string.IsNullOrEmpty(convertResult))
                {
                    var targetList = BreakIntoTokens(convertTarget);
                    var resultList = BreakIntoTokens(convertResult);

                    // now add them back together
                    if (targetList.Count > 0 && resultList.Count > 0)
                    {
                        // build up the StringToConvert section ;)
                        // existing record
                        BuildStringToConvert(i, targetList, resultList);
                    }
                }
                else
                {
                    ConvertCollection.RemoveAt(i);
                }
            }
        }

        void InsertToCollection(IEnumerable<string> listToAdd, ModelItem modelItem)
        {
            var modelProperty = modelItem.Properties["ConvertCollection"];
            if (modelProperty != null)
            {
                var mic = modelProperty.Collection;

                if (mic != null)
                {
                    AddToConvertCollection(listToAdd, modelItem, mic);
                }
            }
        }

        private void AddToConvertCollection(IEnumerable<string> listToAdd, ModelItem modelItem, ModelItemCollection mic)
        {
            var listOfValidRows = ConvertCollection.Where(c => !c.CanRemove()).ToList();
            if (listOfValidRows.Count > 0)
            {
                var startIndex = ConvertCollection.IndexOf(listOfValidRows.Last()) + 1;
                foreach (string s in listToAdd)
                {
                    mic.Insert(startIndex, new CaseConvertTO(s, ConvertCollection[startIndex - 1].ConvertType, s, startIndex + 1));
                    startIndex++;
                }
                CleanUpCollection(mic, modelItem, startIndex);
            }
            else
            {
                AddToCollection(listToAdd, modelItem);
            }
        }

        void AddToCollection(IEnumerable<string> listToAdd, ModelItem modelItem)
        {
            var modelProperty = modelItem.Properties["ConvertCollection"];
            if (modelProperty != null)
            {
                var mic = modelProperty.Collection;

                if (mic != null)
                {
                    var startIndex = 0;
                    var firstRowConvertType = ConvertCollection[0].ConvertType;
                    mic.Clear();
                    foreach (string s in listToAdd)
                    {
                        mic.Insert(startIndex, new CaseConvertTO(s, firstRowConvertType, s, startIndex + 1));
                        startIndex++;
                    }
                    CleanUpCollection(mic, modelItem, startIndex);
                }
                else
                {
                    AddToCollection(listToAdd, modelItem);
                }
            }
        }


        void CleanUpCollection(ModelItemCollection mic, ModelItem modelItem, int startIndex)
        {
            if (startIndex < mic.Count)
            {
                mic.RemoveAt(startIndex);
            }
            mic.Add(new CaseConvertTO(string.Empty, "UPPER", string.Empty, startIndex + 1));
            var modelProperty = modelItem.Properties["DisplayName"];
            modelProperty?.SetValue(CreateDisplayName(modelItem, startIndex + 1));
        }

        string CreateDisplayName(ModelItem modelItem, int count)
        {
            var modelProperty = modelItem.Properties["DisplayName"];
            if (modelProperty != null)
            {
                var currentName = modelProperty.ComputedValue as string;
                if (currentName != null && currentName.Contains("(") && currentName.Contains(")"))
                {
                    currentName = currentName.Remove(currentName.Contains(" (") ? currentName.IndexOf(" (", StringComparison.Ordinal) : currentName.IndexOf("(", StringComparison.Ordinal));
                }
                currentName = currentName + " (" + (count - 1) + ")";
                return currentName;
            }

            return string.Empty;
        }

        public override List<DebugItem> GetDebugInputs(IExecutionEnvironment env, int update)
        {
            foreach (IDebugItem debugInput in _debugInputs)
            {
                debugInput.FlushStringBuilder();
            }
            return _debugInputs;
        }

        public override List<DebugItem> GetDebugOutputs(IExecutionEnvironment env, int update)
        {
            foreach (IDebugItem debugOutput in _debugOutputs)
            {
                debugOutput.FlushStringBuilder();
            }
            return _debugOutputs;
        }

        public override void UpdateForEachInputs(IList<Tuple<string, string>> updates)
        {
            foreach (Tuple<string, string> t in updates)
            {
                // locate all updates for this tuple
                var t1 = t;
                var items = ConvertCollection.Where(c => !string.IsNullOrEmpty(c.StringToConvert) && c.StringToConvert.Contains(t1.Item1));

                // issues updates
                foreach (var a in items)
                {
                    a.StringToConvert = a.StringToConvert.Replace(t.Item1, t.Item2);
                }
            }
        }

        public override void UpdateForEachOutputs(IList<Tuple<string, string>> updates)
        {
            foreach (Tuple<string, string> t in updates)
            {
                // locate all updates for this tuple
                var t1 = t;
                var items = ConvertCollection.Where(c => !string.IsNullOrEmpty(c.Result) && c.Result.Contains(t1.Item1));

                // issues updates
                foreach (var a in items)
                {
                    a.Result = a.Result.Replace(t.Item1, t.Item2);
                }
            }
        }

        public override IList<DsfForEachItem> GetForEachInputs()
        {
            var result = new List<DsfForEachItem>();

            foreach (var item in ConvertCollection)
            {
                if (!string.IsNullOrEmpty(item.StringToConvert) && item.StringToConvert.Contains("[["))
                {
                    result.Add(new DsfForEachItem { Name = item.StringToConvert, Value = item.Result });
                }
            }

            return result;
        }

        public override IList<DsfForEachItem> GetForEachOutputs()
        {
            var result = new List<DsfForEachItem>();
            foreach (var item in ConvertCollection)
            {
                if (!string.IsNullOrEmpty(item.StringToConvert) && item.StringToConvert.Contains("[["))
                {
                    result.Add(new DsfForEachItem { Name = item.Result, Value = item.StringToConvert });
                }
            }
            return result;
        }

        public int GetCollectionCount() => ConvertCollection.Count(caseConvertTo => !caseConvertTo.CanRemove());

        public void AddListToCollection(IList<string> listToAdd, bool overwrite, ModelItem modelItem)
        {
            if (!overwrite)
            {
                InsertToCollection(listToAdd, modelItem);
            }
            else
            {
                AddToCollection(listToAdd, modelItem);
            }
        }

        public override List<string> GetOutputs() => ConvertCollection.Select(to => to.Result).ToList();

        public override IEnumerable<StateVariable> GetState()
        {
            return new[]
            {
                new StateVariable
                {
                    Name="Convert Collection",
                    Type= StateVariable.StateType.InputOutput,
                    Value = ActivityHelper.GetSerializedStateValueFromCollection(ConvertCollection)
                }
            };
        }

        public bool Equals(DsfCaseConvertActivity other)
        {
            if (ReferenceEquals(null, other))
            {
                return false;
            }

            if (ReferenceEquals(this, other))
            {
                return true;
            }

            var collectionEquals = CommonEqualityOps.CollectionEquals(ConvertCollection, other.ConvertCollection, new CaseConvertToComparer());
            
            return base.Equals(other) && collectionEquals;
        }

        public override bool Equals(object obj)
        {
            if (ReferenceEquals(null, obj))
            {
                return false;
            }

            if (ReferenceEquals(this, obj))
            {
                return true;
            }

            if (obj.GetType() != this.GetType())
            {
                return false;
            }

            return Equals((DsfCaseConvertActivity) obj);
        }

        public override int GetHashCode()
        {
            unchecked
            {
                return (base.GetHashCode() * 397) ^ (ConvertCollection != null ? ConvertCollection.GetHashCode() : 0);
            }
        }
    }
}

---- Transformed Tree ----
using System;
using System.Activities;
using System.Activities.Presentation.Model;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using Dev2;
using Dev2.Activities;
using Dev2.Activities.Debug;
using Dev2.Common;
using Dev2.Common.Interfaces.Core.Convertors.Case;
using Dev2.Common.Interfaces.Diagnostics.Debug;
using Dev2.Common.Interfaces.Toolbox;
using Dev2.Comparer;
using Dev2.Data.TO;
using Dev2.Diagnostics;
using Dev2.Interfaces;
using Dev2.Validation;
using Warewolf.Core;
using Warewolf.Resource.Errors;
using Warewolf.Storage.Interfaces;
using Dev2.Activities.Factories.Case;
using Dev2.Common.State;
using Dev2.Utilities;

namespace Unlimited.Applications.BusinessDesignStudio.Activities
{
    [ToolDescriptorInfo("Data-CaseConversion", "Case Convert", ToolType.Native, "8999E59A-38A3-43BB-A98F-6090C5C9EA1E", "Dev2.Activities", "1.0.0.0", "Legacy", "Data", "/Warewolf.Studio.Themes.Luna;component/Images.xaml", "Tool_Data_Case_Convert")]
    public class DsfCaseConvertActivity : DsfActivityAbstract<string>, ICollectionActivity, IEquatable<DsfCaseConvertActivity>
    {
        public IList<ICaseConvertTO> ConvertCollection { get; set; }

        public DsfCaseConvertActivity()
            : base("Case Conversion")
        {
            ConvertCollection = new List<ICaseConvertTO>();
        }

        protected override void CacheMetadata(NativeActivityMetadata metadata) => base.CacheMetadata(metadata);

        protected override void OnExecute(NativeActivityContext context)
        {
            var dataObject = context.GetExtension<IDSFDataObject>();
            ExecuteTool(dataObject, 0);
        }

        protected override void ExecuteTool(IDSFDataObject dataObject, int update)
        {
            var allErrors = new ErrorResultTO();
            var errors = new ErrorResultTO();
            var env = dataObject.Environment;
            InitializeDebug(dataObject);
            try
            {
                TryExecute(dataObject, update, allErrors, errors, env);
            }
            catch (Exception e)
            {
                allErrors.AddError(e.Message);
            }
            finally
            {
                HandleErrors(dataObject, update, allErrors);
            }
        }

        private void TryExecute(IDSFDataObject dataObject, int update, ErrorResultTO allErrors, ErrorResultTO errors, IExecutionEnvironment env)
        {
            CleanArgs();

            allErrors.MergeErrors(errors);

            var inputIndex = 1;
            var outputIndex = 1;

            foreach (ICaseConvertTO item in ConvertCollection.Where(a => !String.IsNullOrEmpty(a.StringToConvert)))
            {
                IsSingleValueRule.ApplyIsSingleValueRule(item.ExpressionToConvert, allErrors);
                if (dataObject.IsDebugMode())
                {
                    var debugItem = new DebugItem();
                    AddDebugItem(new DebugItemStaticDataParams("", inputIndex.ToString(CultureInfo.InvariantCulture)), debugItem);
                    AddDebugItem(new DebugEvalResult(item.StringToConvert, "Convert", env, update), debugItem);
                    AddDebugItem(new DebugItemStaticDataParams(item.ConvertType, "To"), debugItem);
                    _debugInputs.Add(debugItem);
                    inputIndex++;
                }
                if (!allErrors.HasErrors())
                {
                    try
                    {
                        env.ApplyUpdate(item.StringToConvert, TryConvertFunc(item, env, update), update);
                    }
                    catch (Exception e)
                    {
                        allErrors.AddError(e.Message);
                    }

                    if (!allErrors.HasErrors() && dataObject.IsDebugMode())
                    {
                        var debugItem = new DebugItem();
                        AddDebugItem(new DebugItemStaticDataParams("", outputIndex.ToString(CultureInfo.InvariantCulture)), debugItem);
                        AddDebugItem(new DebugEvalResult(item.StringToConvert, "", env, update), debugItem);
                        _debugOutputs.Add(debugItem);
                        outputIndex++;
                    }
                }
            }
        }

        void HandleErrors(IDSFDataObject dataObject, int update, ErrorResultTO allErrors)
        {
            var hasErrors = allErrors.HasErrors();
            if (hasErrors)
            {
                DisplayAndWriteError(nameof(DsfCaseConvertActivity), allErrors);
                var errorString = allErrors.MakeDisplayReady();
                dataObject.Environment.AddError(errorString);
            }
            if (dataObject.IsDebugMode())
            {
                DispatchDebugState(dataObject, StateType.Before, update);
                DispatchDebugState(dataObject, StateType.After, update);
            }
        }

        static Func<DataStorage.WarewolfAtom, DataStorage.WarewolfAtom> TryConvertFunc(ICaseConvertTO conversionType, IExecutionEnvironment env, int update)
        {
            var convertFunct = CaseConverter.GetFuncs();

            if (convertFunct.TryGetValue(conversionType.ConvertType, out Func<string, string> returnedFunc) && returnedFunc != null)
            {
                return a =>
                {
                    var upper = returnedFunc.Invoke(a.ToString());
                    var evalled = env.Eval(upper, update);

                    if (evalled.IsWarewolfAtomResult)
                    {
                        if (evalled is CommonFunctions.WarewolfEvalResult.WarewolfAtomResult warewolfAtomResult)
                        {
                            return warewolfAtomResult.Item;
                        }
                        return DataStorage.WarewolfAtom.Nothing;
                    }

                    return DataStorage.WarewolfAtom.NewDataString(CommonFunctions.evalResultToString(evalled));
                };
            }
            throw new Exception(ErrorResource.ConvertOptionDoesNotExist);
        }


        public override enFindMissingType GetFindMissingType() => enFindMissingType.DataGridActivity;

        void BuildStringToConvert(int i, List<string> targetList, List<string> resultList)
        {
            ConvertCollection[i].StringToConvert = targetList[0];
            ConvertCollection[i].Result = resultList[0];
            var canidateResult = resultList[0];
            for (var q = 1; q < targetList.Count; q++)
            {
                var pos = ConvertCollection.Count + 1;

                // now process all new results ;)
                // we always keep the last value in-case we run out of indexes
                // as they do not have to balance ;)
                if (q < resultList.Count)
                {
                    canidateResult = resultList[q];
                }

                ConvertCollection.Add(new CaseConvertTO(targetList[q], ConvertCollection[i].ConvertType, canidateResult, pos));
            }
        }

        List<string> BreakIntoTokens(string value)
        {
            var parts = value.Split(',');
            var result = parts.Select(r => r.Trim()).ToList();
            return result;
        }

        void CleanArgs()
        {
            var workItems = new ICaseConvertTO[ConvertCollection.Count];
            ConvertCollection.CopyTo(workItems, 0);


            for (var i = 0; i < workItems.Length; i++)

            {
                var convertResult = workItems[i].Result;
                var convertTarget = workItems[i].StringToConvert;

                if (!string.IsNullOrEmpty(convertTarget) && !string.IsNullOrEmpty(convertResult))
                {
                    var targetList = BreakIntoTokens(convertTarget);
                    var resultList = BreakIntoTokens(convertResult);

                    // now add them back together
                    if (targetList.Count > 0 && resultList.Count > 0)
                    {
                        // build up the StringToConvert section ;)
                        // existing record
                        BuildStringToConvert(i, targetList, resultList);
                    }
                }
                else
                {
                    ConvertCollection.RemoveAt(i);
                }
            }
        }

        void InsertToCollection(IEnumerable<string> listToAdd, ModelItem modelItem)
        {
            var modelProperty = modelItem.Properties["ConvertCollection"];
            if (modelProperty != null)
            {
                var mic = modelProperty.Collection;

                if (mic != null)
                {
                    AddToConvertCollection(listToAdd, modelItem, mic);
                }
            }
        }

        private void AddToConvertCollection(IEnumerable<string> listToAdd, ModelItem modelItem, ModelItemCollection mic)
        {
            var listOfValidRows = ConvertCollection.Where(c => !c.CanRemove()).ToList();
            if (listOfValidRows.Count > 0)
            {
                var startIndex = ConvertCollection.IndexOf(listOfValidRows.Last()) + 1;
                foreach (string s in listToAdd)
                {
                    mic.Insert(startIndex, new CaseConvertTO(s, ConvertCollection[startIndex - 1].ConvertType, s, startIndex + 1));
                    startIndex++;
                }
                CleanUpCollection(mic, modelItem, startIndex);
            }
            else
            {
                AddToCollection(listToAdd, modelItem);
            }
        }

        void AddToCollection(IEnumerable<string> listToAdd, ModelItem modelItem)
        {
            var modelProperty = modelItem.Properties["ConvertCollection"];
            if (modelProperty != null)
            {
                var mic = modelProperty.Collection;

                if (mic != null)
                {
                    var startIndex = 0;
                    var firstRowConvertType = ConvertCollection[0].ConvertType;
                    mic.Clear();
                    foreach (string s in listToAdd)
                    {
                        mic.Insert(startIndex, new CaseConvertTO(s, firstRowConvertType, s, startIndex + 1));
                        startIndex++;
                    }
                    CleanUpCollection(mic, modelItem, startIndex);
                }
                else
                {
                    AddToCollection(listToAdd, modelItem);
                }
            }
        }


        void CleanUpCollection(ModelItemCollection mic, ModelItem modelItem, int startIndex)
        {
            if (startIndex < mic.Count)
            {
                mic.RemoveAt(startIndex);
            }
            mic.Add(new CaseConvertTO(string.Empty, "UPPER", string.Empty, startIndex + 1));
            var modelProperty = modelItem.Properties["DisplayName"];
            modelProperty?.SetValue(CreateDisplayName(modelItem, startIndex + 1));
        }

        string CreateDisplayName(ModelItem modelItem, int count)
        {
            var modelProperty = modelItem.Properties["DisplayName"];
            if (modelProperty != null)
            {
                if (modelProperty.ComputedValue is string currentName && currentName.Contains("(") && currentName.Contains(")"))
                {
                    currentName = currentName.Remove(currentName.Contains(" (") ? currentName.IndexOf(" (", StringComparison.Ordinal) : currentName.IndexOf("(", StringComparison.Ordinal));
                }
                currentName = currentName + " (" + (count - 1) + ")";
                return currentName;
            }

            return string.Empty;
        }

        public override List<DebugItem> GetDebugInputs(IExecutionEnvironment env, int update)
        {
            foreach (IDebugItem debugInput in _debugInputs)
            {
                debugInput.FlushStringBuilder();
            }
            return _debugInputs;
        }

        public override List<DebugItem> GetDebugOutputs(IExecutionEnvironment env, int update)
        {
            foreach (IDebugItem debugOutput in _debugOutputs)
            {
                debugOutput.FlushStringBuilder();
            }
            return _debugOutputs;
        }

        public override void UpdateForEachInputs(IList<Tuple<string, string>> updates)
        {
            foreach (Tuple<string, string> t in updates)
            {
                // locate all updates for this tuple
                var t1 = t;
                var items = ConvertCollection.Where(c => !string.IsNullOrEmpty(c.StringToConvert) && c.StringToConvert.Contains(t1.Item1));

                // issues updates
                foreach (var a in items)
                {
                    a.StringToConvert = a.StringToConvert.Replace(t.Item1, t.Item2);
                }
            }
        }

        public override void UpdateForEachOutputs(IList<Tuple<string, string>> updates)
        {
            foreach (Tuple<string, string> t in updates)
            {
                // locate all updates for this tuple
                var t1 = t;
                var items = ConvertCollection.Where(c => !string.IsNullOrEmpty(c.Result) && c.Result.Contains(t1.Item1));

                // issues updates
                foreach (var a in items)
                {
                    a.Result = a.Result.Replace(t.Item1, t.Item2);
                }
            }
        }

        public override IList<DsfForEachItem> GetForEachInputs()
        {
            var result = new List<DsfForEachItem>();

            foreach (var item in ConvertCollection)
            {
                if (!string.IsNullOrEmpty(item.StringToConvert) && item.StringToConvert.Contains("[["))
                {
                    result.Add(new DsfForEachItem { Name = item.StringToConvert, Value = item.Result });
                }
            }

            return result;
        }

        public override IList<DsfForEachItem> GetForEachOutputs()
        {
            var result = new List<DsfForEachItem>();
            foreach (var item in ConvertCollection)
            {
                if (!string.IsNullOrEmpty(item.StringToConvert) && item.StringToConvert.Contains("[["))
                {
                    result.Add(new DsfForEachItem { Name = item.Result, Value = item.StringToConvert });
                }
            }
            return result;
        }

        public int GetCollectionCount() => ConvertCollection.Count(caseConvertTo => !caseConvertTo.CanRemove());

        public void AddListToCollection(IList<string> listToAdd, bool overwrite, ModelItem modelItem)
        {
            if (!overwrite)
            {
                InsertToCollection(listToAdd, modelItem);
            }
            else
            {
                AddToCollection(listToAdd, modelItem);
            }
        }

        public override List<string> GetOutputs() => ConvertCollection.Select(to => to.Result).ToList();

        public override IEnumerable<StateVariable> GetState()
        {
            return new[]
            {
                new StateVariable
                {
                    Name="Convert Collection",
                    Type= StateVariable.StateType.InputOutput,
                    Value = ActivityHelper.GetSerializedStateValueFromCollection(ConvertCollection)
                }
            };
        }

        public bool Equals(DsfCaseConvertActivity other)
        {
            if (ReferenceEquals(null, other))
            {
                return false;
            }

            if (ReferenceEquals(this, other))
            {
                return true;
            }

            var collectionEquals = CommonEqualityOps.CollectionEquals(ConvertCollection, other.ConvertCollection, new CaseConvertToComparer());
            
            return base.Equals(other) && collectionEquals;
        }

        public override bool Equals(object obj)
        {
            if (ReferenceEquals(null, obj))
            {
                return false;
            }

            if (ReferenceEquals(this, obj))
            {
                return true;
            }

            if (obj.GetType() != this.GetType())
            {
                return false;
            }

            return Equals((DsfCaseConvertActivity) obj);
        }

        public override int GetHashCode()
        {
            unchecked
            {
                return (base.GetHashCode() * 397) ^ (ConvertCollection != null ? ConvertCollection.GetHashCode() : 0);
            }
        }
    }
}

---- Semantic diagnostics *before* transformation ----
D:\a\1\s\Dev\Dev2.Activities\Activities\DsfCaseConvertActivity.cs(138,21): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfCaseConvertActivity.cs(138,47): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfCaseConvertActivity.cs(103,25): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfCaseConvertActivity.cs(147,35): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfCaseConvertActivity.cs(151,40): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfCaseConvertActivity.cs(155,32): error CS0103: The name 'DataStorage' does not exist in the current context,D:\a\1\s\Dev\Dev2.Activities\Activities\DsfCaseConvertActivity.cs(158,28): error CS0103: The name 'DataStorage' does not exist in the current context,D:\a\1\s\Dev\Dev2.Activities\Activities\DsfCaseConvertActivity.cs(158,67): error CS0103: The name 'CommonFunctions' does not exist in the current context
---- Semantic diagnostics *after* transformation ----
D:\a\1\s\Dev\Dev2.Activities\Activities\DsfCaseConvertActivity.cs(138,21): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfCaseConvertActivity.cs(138,47): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfCaseConvertActivity.cs(103,25): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfCaseConvertActivity.cs(147,35): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfCaseConvertActivity.cs(151,40): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfCaseConvertActivity.cs(155,32): error CS0103: The name 'DataStorage' does not exist in the current context,D:\a\1\s\Dev\Dev2.Activities\Activities\DsfCaseConvertActivity.cs(158,28): error CS0103: The name 'DataStorage' does not exist in the current context,D:\a\1\s\Dev\Dev2.Activities\Activities\DsfCaseConvertActivity.cs(158,67): error CS0103: The name 'CommonFunctions' does not exist in the current context,D:\a\1\s\Dev\Dev2.Activities\Activities\DsfCaseConvertActivity.cs(307,31): error CS0165: Use of unassigned local variable 'currentName'
######################################################################


######################################################################
Nr: 6 - UsePatternMatchingRewriterR8
Filepath: D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataSplitActivity.cs
Description: Error: The created Syntax Tree is semantically incorrect.
------------------------------------------------------------------------
---- Original Tree ----
using System;
using System.Activities;
using System.Activities.Presentation.Model;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using System.Text.RegularExpressions;
using Dev2;
using Dev2.Activities;
using Dev2.Activities.Debug;
using Dev2.Common;
using Dev2.Common.Interfaces.Diagnostics.Debug;
using Dev2.Common.Interfaces.StringTokenizer.Interfaces;
using Dev2.Common.Interfaces.Toolbox;
using Dev2.Data;
using Dev2.Data.TO;
using Dev2.Data.Util;
using Dev2.Diagnostics;
using Dev2.Interfaces;
using Dev2.Validation;
using Warewolf.Core;
using Warewolf.Storage;
using Warewolf.Storage.Interfaces;
using WarewolfParserInterop;
using Dev2.Comparer;
using System.IO;
using System.Text;
using Dev2.Common.Common;
using Dev2.Common.State;
using Dev2.Utilities;

namespace Unlimited.Applications.BusinessDesignStudio.Activities
{
    [ToolDescriptorInfo("Data-DataSplit", "Data Split", ToolType.Native, "8999E59A-38A3-43BB-A98F-6090C5C9EA1E", "Dev2.Activities", "1.0.0.0", "Legacy", "Data", "/Warewolf.Studio.Themes.Luna;component/Images.xaml", "Tool_Data_Data_Split")]
    public class DsfDataSplitActivity : DsfActivityAbstract<string>, ICollectionActivity, IEquatable<DsfDataSplitActivity>
    {
        string _sourceString;
        int _indexCounter = 1;
        IList<DataSplitDTO> _resultsCollection;
        bool _reverseOrder;
        bool _skipBlankRows;

        public IList<DataSplitDTO> ResultsCollection
        {
            get => _resultsCollection;
            set
            {
                _resultsCollection = value;
                OnPropertyChanged("ResultsCollection");
            }
        }

        public bool ReverseOrder
        {
            get => _reverseOrder;
            set
            {
                _reverseOrder = value;
                OnPropertyChanged("ReverseOrder");
            }
        }

        public string SourceString
        {
            get => _sourceString;
            set
            {
                _sourceString = value;
                OnPropertyChanged("SourceString");
            }
        }

        public bool SkipBlankRows
        {
            get => _skipBlankRows;
            set
            {
                _skipBlankRows = value;
                OnPropertyChanged("SkipBlankRows");
            }
        }
        private string NewLineFormat { get; set; } = "\r\n";


        protected override bool CanInduceIdle => true;

        public DsfDataSplitActivity()
            : base("Data Split")
        {
            ResultsCollection = new List<DataSplitDTO>();
        }

        public override IEnumerable<StateVariable> GetState()
        {
            return new[] {
                new StateVariable
                {
                    Name = "SourceString",
                    Value = SourceString,
                    Type = StateVariable.StateType.Input
                },
                new StateVariable
                {
                    Name = "ReverseOrder",
                    Value = ReverseOrder.ToString(),
                    Type = StateVariable.StateType.Input
                },
                new StateVariable
                {
                    Name = "SkipBlankRows",
                    Value = SkipBlankRows.ToString(),
                    Type = StateVariable.StateType.Input
                },
                new StateVariable
                {
                    Name="ResultsCollection",
                    Value = ActivityHelper.GetSerializedStateValueFromCollection(ResultsCollection),
                    Type = StateVariable.StateType.Output
                }
            };
        }


        protected override void CacheMetadata(NativeActivityMetadata metadata)
        {
            base.CacheMetadata(metadata);
        }


        protected override void OnExecute(NativeActivityContext context)
        {
            var dataObject = context.GetExtension<IDSFDataObject>();
            ExecuteTool(dataObject, 0);
        }

#pragma warning disable S1541 // Methods and properties should not be too complex
        protected override void ExecuteTool(IDSFDataObject dataObject, int update)
#pragma warning restore S1541 // Methods and properties should not be too complex
        {
            _indexCounter = 1;

            var allErrors = new ErrorResultTO();
            var env = dataObject.Environment;
            var iter = new WarewolfListIterator();

            InitializeDebug(dataObject);
            try
            {
                var sourceString = SourceString ?? "";
                if (dataObject.IsDebugMode())
                {
                    AddDebugInputItem(new DebugEvalResult(sourceString, "String to Split", env, update));
                    AddDebugInputItem(new DebugItemStaticDataParams(ReverseOrder ? "Backward" : "Forward", "Process Direction"));
                    AddDebugInputItem(new DebugItemStaticDataParams(SkipBlankRows ? "Yes" : "No", "Skip blank rows"));
                    AddDebug(ResultsCollection, dataObject.Environment, update);
                }
                var sourceStringValue = env.Eval(sourceString, update);
                var res = new WarewolfIterator(sourceStringValue);
                NewLineFormat = res.NewLineFormat;


                iter.AddVariableToIterateOn(res);
                IDictionary<string, int> positions = new Dictionary<string, int>();
                CleanArguments(ResultsCollection);
                ResultsCollection.ToList().ForEach(a =>
                {
                    if (!positions.ContainsKey(a.OutputVariable))
                    {
                        positions.Add(a.OutputVariable, update == 0 ? 1 : update);
                    }
                    IsSingleValueRule.ApplyIsSingleValueRule(a.OutputVariable, allErrors);
                });
                var singleInnerIteration = ArePureScalarTargets(ResultsCollection);
                var resultsEnumerator = ResultsCollection.GetEnumerator();
                var debugDictionary = new List<string>();
                while (res.HasMoreData())
                {
                    CommitItem(dataObject, update, allErrors, env, res, positions, singleInnerIteration, resultsEnumerator, debugDictionary);
                    if (singleInnerIteration)
                    {
                        break;
                    }
                }

                if (dataObject.IsDebugMode())
                {
                    var outputIndex = 1;
                    foreach (var varDebug in debugDictionary)
                    {
                        var debugItem = new DebugItem();
                        AddDebugItem(new DebugItemStaticDataParams("", outputIndex.ToString(CultureInfo.InvariantCulture)), debugItem);
                        var dataSplitUsesStarForOutput = varDebug.Replace("().", "(*).");
                        AddDebugItem(new DebugEvalResult(dataSplitUsesStarForOutput, "", env, update), debugItem);
                        _debugOutputs.Add(debugItem);
                        outputIndex++;
                    }
                }
            }
            catch (Exception e)
            {
                Dev2Logger.Error("DSFDataSplit", e, GlobalConstants.WarewolfError);
                allErrors.AddError(e.Message);
            }
            finally
            {
                HandleErrors(dataObject, update, allErrors);
            }
        }

        private void CommitItem(IDSFDataObject dataObject, int update, ErrorResultTO allErrors, IExecutionEnvironment env, WarewolfIterator res, IDictionary<string, int> positions, bool singleInnerIteration, IEnumerator<DataSplitDTO> resultsEnumerator, List<string> debugDictionary)
        {
            var item = new StringBuilder(res.GetNextValue());
            if (item.Length > 0)
            {
                var tokenizer = CreateSplitPattern(ref item, ResultsCollection, env, out ErrorResultTO errors, update);
                allErrors.MergeErrors(errors);

                if (!allErrors.HasErrors() && tokenizer != null)
                {
                    ProcessTokenizerItems(dataObject, update, env, positions, singleInnerIteration, resultsEnumerator, debugDictionary, tokenizer);
                }
            }
            env.CommitAssign();
        }

        void ProcessTokenizerItems(IDSFDataObject dataObject, int update, IExecutionEnvironment env, IDictionary<string, int> positions, bool singleInnerIteration, IEnumerator<DataSplitDTO> resultsEnumerator, List<string> debugDictionary, IDev2Tokenizer tokenizer)
        {
            var lastItemEndedInNewLine = false;
            while (tokenizer.HasMoreOps())
            {
                var currentval = resultsEnumerator.MoveNext();
                if (!currentval)
                {
                    if (singleInnerIteration)
                    {
                        break;
                    }
                    resultsEnumerator.Reset();
                    resultsEnumerator.MoveNext();
                }
                var tmp = tokenizer.NextToken();
                if (tmp.StartsWith(NewLineFormat) && !SkipBlankRows)
                {
                    resultsEnumerator.Reset();
                    while (resultsEnumerator.MoveNext())
                    {
                        AssignOutputVariable(update, env, resultsEnumerator, positions);
                    }
                    resultsEnumerator.Reset();
                    resultsEnumerator.MoveNext();
                }
                var outputVar = resultsEnumerator.Current.OutputVariable;
                if (!NewLine(tmp))
                {
                    lastItemEndedInNewLine = tmp.EndsWith(NewLineFormat);
                    AssignItem(update, env, positions, ref tmp, outputVar);
                    if (dataObject.IsDebugMode())
                    {
                        AddOutputToDebugOutput(update, env, resultsEnumerator, debugDictionary);
                    }
                }
            }

            if (lastItemEndedInNewLine)
            {
                var tovar = resultsEnumerator.Current.OutputVariable;
                var assignToVar = ExecutionEnvironment.ConvertToIndex(tovar, positions[tovar]);
                env.AssignWithFrame(new AssignValue(assignToVar, ""), update);
                positions[tovar] = positions[tovar] + 1;
            }
        }

        private void AssignItem(int update, IExecutionEnvironment env, IDictionary<string, int> positions, ref string tmp, string outputVar)
        {
            if (!String.IsNullOrEmpty(outputVar))
            {
                var assignVar = ExecutionEnvironment.ConvertToIndex(outputVar, positions[outputVar]);
                if (!SkipBlankRows)
                {
                    tmp = tmp.Replace(NewLineFormat, "");
                }
                env.AssignWithFrame(new AssignValue(assignVar, tmp), update);
                positions[outputVar] = positions[outputVar] + 1;
            }
        }

        void AddOutputToDebugOutput(int update, IExecutionEnvironment env, IEnumerator<DataSplitDTO> resultsEnumerator, List<string> debugDictionary)
        {
            var debugItem = new DebugItem();
            var outputVarTo = resultsEnumerator.Current.OutputVariable;
            AddDebugItem(new DebugEvalResult(outputVarTo, "", env, update), debugItem);
            if (!debugDictionary.Contains(outputVarTo))
            {
                debugDictionary.Add(outputVarTo);
            }
        }

        static void AssignOutputVariable(int update, IExecutionEnvironment env, IEnumerator<DataSplitDTO> resultsEnumerator, IDictionary<string, int> positions)
        {
            var tovar = resultsEnumerator.Current.OutputVariable;
            if (!String.IsNullOrEmpty(tovar))
            {
                var assignToVar = ExecutionEnvironment.ConvertToIndex(tovar, positions[tovar]);
                env.AssignWithFrame(new AssignValue(assignToVar, ""), update);
                positions[tovar] = positions[tovar] + 1;
            }
        }

        private static bool NewLine(string tmp) => tmp == "\r" || tmp == "\n" || tmp == Environment.NewLine;

        void HandleErrors(IDSFDataObject dataObject, int update, ErrorResultTO allErrors)
        {
            var hasErrors = allErrors.HasErrors();
            if (hasErrors)
            {
                DisplayAndWriteError("DsfDataSplitActivity", allErrors);
                var errorString = allErrors.MakeDisplayReady();
                dataObject.Environment.AddError(errorString);
            }

            if (dataObject.IsDebugMode())
            {
                DispatchDebugState(dataObject, StateType.Before, update);
                DispatchDebugState(dataObject, StateType.After, update);
            }
        }

        public override enFindMissingType GetFindMissingType() => enFindMissingType.MixedActivity;

        static bool ArePureScalarTargets(IEnumerable<DataSplitDTO> args) => args.All(arg => !DataListUtil.IsValueRecordset(arg.OutputVariable));

        void InsertToCollection(IEnumerable<string> listToAdd, ModelItem modelItem)
        {
            var modelProperty = modelItem.Properties["ResultsCollection"];
            var mic = modelProperty?.Collection;

            if (mic != null)
            {
                var listOfValidRows = ResultsCollection.Where(c => !c.CanRemove()).ToList();
                if (listOfValidRows.Count > 0)
                {
                    ConcatenateCollections(listToAdd, modelItem, mic);
                }
                else
                {
                    AddToCollection(listToAdd, modelItem);
                }
            }
        }

        void ConcatenateCollections(IEnumerable<string> listToAdd, ModelItem modelItem, ModelItemCollection mic)
        {
            var dataSplitDto = ResultsCollection.Last(c => !c.CanRemove());
            var startIndex = ResultsCollection.IndexOf(dataSplitDto) + 1;
            foreach (string s in listToAdd)
            {
                mic.Insert(startIndex, new DataSplitDTO(s, ResultsCollection[startIndex - 1].SplitType, ResultsCollection[startIndex - 1].At, startIndex + 1));
                startIndex++;
            }
            CleanUpCollection(mic, modelItem, startIndex);
        }

        void AddToCollection(IEnumerable<string> listToAdd, ModelItem modelItem)
        {
            var modelProperty = modelItem.Properties["ResultsCollection"];
            var mic = modelProperty?.Collection;

            if (mic != null)
            {
                var startIndex = 0;
                var firstRowSplitType = ResultsCollection[0].SplitType;
                var firstRowAt = ResultsCollection[0].At;
                mic.Clear();
                foreach (string s in listToAdd)
                {
                    mic.Add(new DataSplitDTO(s, firstRowSplitType, firstRowAt, startIndex + 1));
                    startIndex++;
                }
                CleanUpCollection(mic, modelItem, startIndex);
            }
        }

        void CleanUpCollection(ModelItemCollection mic, ModelItem modelItem, int startIndex)
        {
            if (startIndex < mic.Count)
            {
                mic.RemoveAt(startIndex);
            }
            mic.Add(new DataSplitDTO(string.Empty, "Chars", string.Empty, startIndex + 1));
            var modelProperty = modelItem.Properties["DisplayName"];
            modelProperty?.SetValue(CreateDisplayName(modelItem, startIndex + 1));
        }

        string CreateDisplayName(ModelItem modelItem, int count)
        {
            var modelProperty = modelItem.Properties["DisplayName"];
            if (modelProperty != null)
            {
                var currentName = modelProperty.ComputedValue as string;
                if (currentName != null && currentName.Contains("(") && currentName.Contains(")"))
                {
                    currentName = currentName.Remove(currentName.Contains(" (") ? currentName.IndexOf(" (", StringComparison.Ordinal) : currentName.IndexOf("(", StringComparison.Ordinal));
                }
                currentName = currentName + " (" + (count - 1) + ")";
                return currentName;
            }

            return string.Empty;
        }

        IDev2Tokenizer CreateSplitPattern(ref StringBuilder stringToSplit, IEnumerable<DataSplitDTO> args, IExecutionEnvironment compiler, out ErrorResultTO errors, int update)
        {


            var dtb = new Dev2TokenizerBuilder { ToTokenize = stringToSplit, ReverseOrder = ReverseOrder };
            errors = new ErrorResultTO();

            foreach (DataSplitDTO t in args)
            {
                stringToSplit = AddTokenOp(stringToSplit, compiler, errors, update, dtb, t);
                _indexCounter++;
            }
            return stringToSplit.Length <= 0 || errors.HasErrors() ? null : dtb.Generate();
        }

        StringBuilder AddTokenOp(StringBuilder stringToSplit, IExecutionEnvironment compiler, ErrorResultTO errors, int update, Dev2TokenizerBuilder dtb, DataSplitDTO t)
        {
            var parsedAt = t.At ?? string.Empty;
            var entry = "";

            switch (t.SplitType)
            {
                case "Index":
                    AddIndexOperation(dtb, compiler, errors, update, parsedAt);
                    break;
                case "End":
                    dtb.AddEoFOp();
                    break;
                case "Space":
                    dtb.AddTokenOp(" ", t.Include);
                    break;
                case "Tab":
                    dtb.AddTokenOp("\t", t.Include);
                    break;
                case "New Line":
                    t.Include |= !SkipBlankRows;
                    AddLineBreakTokenOp(stringToSplit, dtb, t);
                    break;
                case "Chars":
                    AddCharacterTokenOp(ref stringToSplit, compiler, update, dtb, t, parsedAt, ref entry);
                    break;
                default:
                    Dev2Logger.Info("No Split type for the Data Split Property Name: " + t.SplitType, GlobalConstants.WarewolfInfo);
                    break;
            }

            return stringToSplit;
        }

        void AddCharacterTokenOp(ref StringBuilder stringToSplit, IExecutionEnvironment compiler, int update, Dev2TokenizerBuilder dtb, DataSplitDTO t, string parsedAt, ref string entry)
        {
            if (!string.IsNullOrEmpty(parsedAt))
            {
                entry = EvalLineBreakCharacter(ref stringToSplit, compiler, update, dtb, parsedAt);
                var escape = EvalEscapeCharacter(compiler, update, t);
                dtb.AddTokenOp(entry, t.Include, escape);
            }
        }

        static void AddLineBreakTokenOp(StringBuilder stringToSplit, Dev2TokenizerBuilder dtb, DataSplitDTO t)
        {
            if (stringToSplit.Contains("\r\n"))
            {
                dtb.AddTokenOp("\r\n", t.Include);
            }
            else if (stringToSplit.Contains("\n"))
            {
                dtb.AddTokenOp("\n", t.Include);
            }
            else
            {
                if (stringToSplit.Contains("\r"))
                {
                    dtb.AddTokenOp("\r", t.Include);
                }
            }
        }

        string EvalLineBreakCharacter(ref StringBuilder stringToSplit, IExecutionEnvironment compiler, int update, Dev2TokenizerBuilder dtb, string parsedAt)
        {
            var entry = compiler.EvalAsListOfStrings(parsedAt, update).FirstOrDefault();
            if (entry != null && (entry.Contains(@"\r\n") || entry.Contains(@"\n")))
            {
                var match = Regex.Match(stringToSplit.ToString(), @"[\r\n]+");
                if (match.Success && !SkipBlankRows)
                {
                    stringToSplit = new StringBuilder(Regex.Escape(stringToSplit.ToString()));
                    dtb.ToTokenize = stringToSplit;
                }
            }

            return entry;
        }

        static string EvalEscapeCharacter(IExecutionEnvironment compiler, int update, DataSplitDTO t)
        {
            var escape = t.EscapeChar;
            if (!String.IsNullOrEmpty(escape))
            {
                escape = compiler.EvalAsListOfStrings(t.EscapeChar, update).FirstOrDefault();
            }

            return escape;
        }

        static void AddIndexOperation(Dev2TokenizerBuilder dtb, IExecutionEnvironment compiler, ErrorResultTO errors, int update, string parsedAt)
        {
            try
            {
                var entry = compiler.EvalAsListOfStrings(parsedAt, update).FirstOrDefault();
                if (entry == null)
                {
                    throw new Exception("null iterator expression");
                }

                var index = entry;
                var indexNum = Convert.ToInt32(index);
                if (indexNum > 0)
                {
                    dtb.AddIndexOp(indexNum);
                }
            }
            catch (Exception ex)
            {
                errors.AddError(ex.Message);
            }
        }

        void AddDebug(IEnumerable<DataSplitDTO> resultCollection, IExecutionEnvironment env, int update)
        {
            foreach (DataSplitDTO t in resultCollection)
            {
                var debugItem = AddParamsToDebug(env, update, t);
                AddResultsToDebug(env, update, t, debugItem);
                _indexCounter++;
                _debugInputs.Add(debugItem);
            }
        }

        void AddResultsToDebug(IExecutionEnvironment env, int update, DataSplitDTO t, DebugItem debugItem)
        {
            switch (t.SplitType)
            {
                case "Index":
                    AddDebugItem(new DebugEvalResult(t.At, "Using", env, update), debugItem);
                    AddDebugItem(new DebugItemStaticDataParams(t.Include ? "Yes" : "No", "Include"), debugItem);
                    break;
                case "End":
                case "Space":
                case "Tab":
                case "New Line":
                    AddDebugItem(new DebugItemStaticDataParams(t.Include ? "Yes" : "No", "Include"), debugItem);
                    break;
                case "Chars":
                    AddDebugItem(new DebugEvalResult(t.At, "Using", env, update), debugItem);
                    AddDebugItem(new DebugItemStaticDataParams(t.Include ? "Yes" : "No", "Include"), debugItem);
                    AddDebugItem(new DebugItemStaticDataParams(t.EscapeChar, "Escape"), debugItem);
                    break;
                default:
                    return;
            }
        }

        DebugItem AddParamsToDebug(IExecutionEnvironment env, int update, DataSplitDTO t)
        {
            var debugItem = new DebugItem();
            AddDebugItem(new DebugItemStaticDataParams("", _indexCounter.ToString(CultureInfo.InvariantCulture)), debugItem);
            if (!string.IsNullOrEmpty(t.OutputVariable))
            {
                AddDebugItem(new DebugEvalResult(t.OutputVariable, "", env, update), debugItem);
            }
            AddDebugItem(new DebugItemStaticDataParams(t.SplitType, "With"), debugItem);
            return debugItem;
        }

        static void CleanArguments(IList<DataSplitDTO> args)
        {
            var count = 0;
            while (count < args.Count)
            {
                if (string.IsNullOrEmpty(args[count].OutputVariable))
                {
                    if (args[count].SplitType == "Index" && string.IsNullOrEmpty(args[count].At) ||
                       args[count].SplitType == "Chars" && string.IsNullOrEmpty(args[count].At))
                    {
                        args.RemoveAt(count);
                    }
                    else
                    {
                        count++;
                    }
                }
                else
                {
                    count++;
                }
            }
        }

        public override List<DebugItem> GetDebugInputs(IExecutionEnvironment env, int update)
        {
            foreach (IDebugItem debugInput in _debugInputs)
            {
                debugInput.FlushStringBuilder();
            }
            return _debugInputs;
        }

        public override List<DebugItem> GetDebugOutputs(IExecutionEnvironment env, int update)
        {
            foreach (IDebugItem debugOutput in _debugOutputs)
            {
                debugOutput.FlushStringBuilder();
            }
            return _debugOutputs;
        }

        public override void UpdateForEachInputs(IList<Tuple<string, string>> updates)
        {
            if (updates == null)
            {
                return;
            }
            foreach (Tuple<string, string> t in updates)
            {
                // locate all updates for this tuple
                var t1 = t;
                var items = ResultsCollection.Where(c => !string.IsNullOrEmpty(c.At) && c.At.Equals(t1.Item1));

                // issues updates
                foreach (var a in items)
                {
                    a.At = t.Item2;
                }

                if (SourceString == t.Item1)
                {
                    SourceString = t.Item2;
                }
            }
        }

        public override void UpdateForEachOutputs(IList<Tuple<string, string>> updates)
        {
            if (updates == null)
            {
                return;
            }
            foreach (Tuple<string, string> t in updates)
            {
                // locate all updates for this tuple
                var t1 = t;
                var items = ResultsCollection.Where(c => !string.IsNullOrEmpty(c.OutputVariable) && c.OutputVariable.Equals(t1.Item1));

                // issues updates
                foreach (var a in items)
                {
                    a.OutputVariable = t.Item2;
                }
            }
        }

        public override IList<DsfForEachItem> GetForEachInputs()
        {
            var items = new[] { SourceString }.Union(ResultsCollection.Where(c => !string.IsNullOrEmpty(c.At)).Select(c => c.At)).ToArray();
            return GetForEachItems(items);
        }

        public override IList<DsfForEachItem> GetForEachOutputs()
        {
            var items = ResultsCollection.Where(c => !string.IsNullOrEmpty(c.OutputVariable)).Select(c => c.OutputVariable).ToArray();
            return GetForEachItems(items);
        }

        public int GetCollectionCount() => ResultsCollection.Count(caseConvertTo => !caseConvertTo.CanRemove());

        public void AddListToCollection(IList<string> listToAdd, bool overwrite, ModelItem modelItem)
        {
            if (!overwrite)
            {
                InsertToCollection(listToAdd, modelItem);
            }
            else
            {
                AddToCollection(listToAdd, modelItem);
            }
        }

        public override List<string> GetOutputs() => ResultsCollection.Select(dto => dto.OutputVariable).ToList();

        public bool Equals(DsfDataSplitActivity other)
        {
            if (ReferenceEquals(null, other))
            {
                return false;
            }

            if (ReferenceEquals(this, other))
            {
                return true;
            }

            var resultsCollectionsAreEqual = CommonEqualityOps.CollectionEquals(ResultsCollection.OrderBy(dto => dto.IndexNumber), other.ResultsCollection.OrderBy(dto => dto.IndexNumber), new DataSplitDTOComparer());
            return base.Equals(other)
                && string.Equals(SourceString, other.SourceString)
                && _indexCounter == other._indexCounter
                && resultsCollectionsAreEqual
                && ReverseOrder == other.ReverseOrder
                && SkipBlankRows == other.SkipBlankRows;
        }

        public override bool Equals(object obj)
        {
            if (ReferenceEquals(null, obj))
            {
                return false;
            }

            if (ReferenceEquals(this, obj))
            {
                return true;
            }

            if (obj.GetType() != this.GetType())
            {
                return false;
            }

            return Equals((DsfDataSplitActivity)obj);
        }

        public override int GetHashCode()
        {
            unchecked
            {
                var hashCode = base.GetHashCode();
                hashCode = (hashCode * 397) ^ (SourceString != null ? SourceString.GetHashCode() : 0);
                hashCode = (hashCode * 397) ^ _indexCounter;
                hashCode = (hashCode * 397) ^ (_resultsCollection != null ? _resultsCollection.GetHashCode() : 0);
                hashCode = (hashCode * 397) ^ ReverseOrder.GetHashCode();
                hashCode = (hashCode * 397) ^ SkipBlankRows.GetHashCode();
                return hashCode;
            }
        }
    }
}
---- Transformed Tree ----
using System;
using System.Activities;
using System.Activities.Presentation.Model;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using System.Text.RegularExpressions;
using Dev2;
using Dev2.Activities;
using Dev2.Activities.Debug;
using Dev2.Common;
using Dev2.Common.Interfaces.Diagnostics.Debug;
using Dev2.Common.Interfaces.StringTokenizer.Interfaces;
using Dev2.Common.Interfaces.Toolbox;
using Dev2.Data;
using Dev2.Data.TO;
using Dev2.Data.Util;
using Dev2.Diagnostics;
using Dev2.Interfaces;
using Dev2.Validation;
using Warewolf.Core;
using Warewolf.Storage;
using Warewolf.Storage.Interfaces;
using WarewolfParserInterop;
using Dev2.Comparer;
using System.IO;
using System.Text;
using Dev2.Common.Common;
using Dev2.Common.State;
using Dev2.Utilities;

namespace Unlimited.Applications.BusinessDesignStudio.Activities
{
    [ToolDescriptorInfo("Data-DataSplit", "Data Split", ToolType.Native, "8999E59A-38A3-43BB-A98F-6090C5C9EA1E", "Dev2.Activities", "1.0.0.0", "Legacy", "Data", "/Warewolf.Studio.Themes.Luna;component/Images.xaml", "Tool_Data_Data_Split")]
    public class DsfDataSplitActivity : DsfActivityAbstract<string>, ICollectionActivity, IEquatable<DsfDataSplitActivity>
    {
        string _sourceString;
        int _indexCounter = 1;
        IList<DataSplitDTO> _resultsCollection;
        bool _reverseOrder;
        bool _skipBlankRows;

        public IList<DataSplitDTO> ResultsCollection
        {
            get => _resultsCollection;
            set
            {
                _resultsCollection = value;
                OnPropertyChanged("ResultsCollection");
            }
        }

        public bool ReverseOrder
        {
            get => _reverseOrder;
            set
            {
                _reverseOrder = value;
                OnPropertyChanged("ReverseOrder");
            }
        }

        public string SourceString
        {
            get => _sourceString;
            set
            {
                _sourceString = value;
                OnPropertyChanged("SourceString");
            }
        }

        public bool SkipBlankRows
        {
            get => _skipBlankRows;
            set
            {
                _skipBlankRows = value;
                OnPropertyChanged("SkipBlankRows");
            }
        }
        private string NewLineFormat { get; set; } = "\r\n";


        protected override bool CanInduceIdle => true;

        public DsfDataSplitActivity()
            : base("Data Split")
        {
            ResultsCollection = new List<DataSplitDTO>();
        }

        public override IEnumerable<StateVariable> GetState()
        {
            return new[] {
                new StateVariable
                {
                    Name = "SourceString",
                    Value = SourceString,
                    Type = StateVariable.StateType.Input
                },
                new StateVariable
                {
                    Name = "ReverseOrder",
                    Value = ReverseOrder.ToString(),
                    Type = StateVariable.StateType.Input
                },
                new StateVariable
                {
                    Name = "SkipBlankRows",
                    Value = SkipBlankRows.ToString(),
                    Type = StateVariable.StateType.Input
                },
                new StateVariable
                {
                    Name="ResultsCollection",
                    Value = ActivityHelper.GetSerializedStateValueFromCollection(ResultsCollection),
                    Type = StateVariable.StateType.Output
                }
            };
        }


        protected override void CacheMetadata(NativeActivityMetadata metadata)
        {
            base.CacheMetadata(metadata);
        }


        protected override void OnExecute(NativeActivityContext context)
        {
            var dataObject = context.GetExtension<IDSFDataObject>();
            ExecuteTool(dataObject, 0);
        }

#pragma warning disable S1541 // Methods and properties should not be too complex
        protected override void ExecuteTool(IDSFDataObject dataObject, int update)
#pragma warning restore S1541 // Methods and properties should not be too complex
        {
            _indexCounter = 1;

            var allErrors = new ErrorResultTO();
            var env = dataObject.Environment;
            var iter = new WarewolfListIterator();

            InitializeDebug(dataObject);
            try
            {
                var sourceString = SourceString ?? "";
                if (dataObject.IsDebugMode())
                {
                    AddDebugInputItem(new DebugEvalResult(sourceString, "String to Split", env, update));
                    AddDebugInputItem(new DebugItemStaticDataParams(ReverseOrder ? "Backward" : "Forward", "Process Direction"));
                    AddDebugInputItem(new DebugItemStaticDataParams(SkipBlankRows ? "Yes" : "No", "Skip blank rows"));
                    AddDebug(ResultsCollection, dataObject.Environment, update);
                }
                var sourceStringValue = env.Eval(sourceString, update);
                var res = new WarewolfIterator(sourceStringValue);
                NewLineFormat = res.NewLineFormat;


                iter.AddVariableToIterateOn(res);
                IDictionary<string, int> positions = new Dictionary<string, int>();
                CleanArguments(ResultsCollection);
                ResultsCollection.ToList().ForEach(a =>
                {
                    if (!positions.ContainsKey(a.OutputVariable))
                    {
                        positions.Add(a.OutputVariable, update == 0 ? 1 : update);
                    }
                    IsSingleValueRule.ApplyIsSingleValueRule(a.OutputVariable, allErrors);
                });
                var singleInnerIteration = ArePureScalarTargets(ResultsCollection);
                var resultsEnumerator = ResultsCollection.GetEnumerator();
                var debugDictionary = new List<string>();
                while (res.HasMoreData())
                {
                    CommitItem(dataObject, update, allErrors, env, res, positions, singleInnerIteration, resultsEnumerator, debugDictionary);
                    if (singleInnerIteration)
                    {
                        break;
                    }
                }

                if (dataObject.IsDebugMode())
                {
                    var outputIndex = 1;
                    foreach (var varDebug in debugDictionary)
                    {
                        var debugItem = new DebugItem();
                        AddDebugItem(new DebugItemStaticDataParams("", outputIndex.ToString(CultureInfo.InvariantCulture)), debugItem);
                        var dataSplitUsesStarForOutput = varDebug.Replace("().", "(*).");
                        AddDebugItem(new DebugEvalResult(dataSplitUsesStarForOutput, "", env, update), debugItem);
                        _debugOutputs.Add(debugItem);
                        outputIndex++;
                    }
                }
            }
            catch (Exception e)
            {
                Dev2Logger.Error("DSFDataSplit", e, GlobalConstants.WarewolfError);
                allErrors.AddError(e.Message);
            }
            finally
            {
                HandleErrors(dataObject, update, allErrors);
            }
        }

        private void CommitItem(IDSFDataObject dataObject, int update, ErrorResultTO allErrors, IExecutionEnvironment env, WarewolfIterator res, IDictionary<string, int> positions, bool singleInnerIteration, IEnumerator<DataSplitDTO> resultsEnumerator, List<string> debugDictionary)
        {
            var item = new StringBuilder(res.GetNextValue());
            if (item.Length > 0)
            {
                var tokenizer = CreateSplitPattern(ref item, ResultsCollection, env, out ErrorResultTO errors, update);
                allErrors.MergeErrors(errors);

                if (!allErrors.HasErrors() && tokenizer != null)
                {
                    ProcessTokenizerItems(dataObject, update, env, positions, singleInnerIteration, resultsEnumerator, debugDictionary, tokenizer);
                }
            }
            env.CommitAssign();
        }

        void ProcessTokenizerItems(IDSFDataObject dataObject, int update, IExecutionEnvironment env, IDictionary<string, int> positions, bool singleInnerIteration, IEnumerator<DataSplitDTO> resultsEnumerator, List<string> debugDictionary, IDev2Tokenizer tokenizer)
        {
            var lastItemEndedInNewLine = false;
            while (tokenizer.HasMoreOps())
            {
                var currentval = resultsEnumerator.MoveNext();
                if (!currentval)
                {
                    if (singleInnerIteration)
                    {
                        break;
                    }
                    resultsEnumerator.Reset();
                    resultsEnumerator.MoveNext();
                }
                var tmp = tokenizer.NextToken();
                if (tmp.StartsWith(NewLineFormat) && !SkipBlankRows)
                {
                    resultsEnumerator.Reset();
                    while (resultsEnumerator.MoveNext())
                    {
                        AssignOutputVariable(update, env, resultsEnumerator, positions);
                    }
                    resultsEnumerator.Reset();
                    resultsEnumerator.MoveNext();
                }
                var outputVar = resultsEnumerator.Current.OutputVariable;
                if (!NewLine(tmp))
                {
                    lastItemEndedInNewLine = tmp.EndsWith(NewLineFormat);
                    AssignItem(update, env, positions, ref tmp, outputVar);
                    if (dataObject.IsDebugMode())
                    {
                        AddOutputToDebugOutput(update, env, resultsEnumerator, debugDictionary);
                    }
                }
            }

            if (lastItemEndedInNewLine)
            {
                var tovar = resultsEnumerator.Current.OutputVariable;
                var assignToVar = ExecutionEnvironment.ConvertToIndex(tovar, positions[tovar]);
                env.AssignWithFrame(new AssignValue(assignToVar, ""), update);
                positions[tovar] = positions[tovar] + 1;
            }
        }

        private void AssignItem(int update, IExecutionEnvironment env, IDictionary<string, int> positions, ref string tmp, string outputVar)
        {
            if (!String.IsNullOrEmpty(outputVar))
            {
                var assignVar = ExecutionEnvironment.ConvertToIndex(outputVar, positions[outputVar]);
                if (!SkipBlankRows)
                {
                    tmp = tmp.Replace(NewLineFormat, "");
                }
                env.AssignWithFrame(new AssignValue(assignVar, tmp), update);
                positions[outputVar] = positions[outputVar] + 1;
            }
        }

        void AddOutputToDebugOutput(int update, IExecutionEnvironment env, IEnumerator<DataSplitDTO> resultsEnumerator, List<string> debugDictionary)
        {
            var debugItem = new DebugItem();
            var outputVarTo = resultsEnumerator.Current.OutputVariable;
            AddDebugItem(new DebugEvalResult(outputVarTo, "", env, update), debugItem);
            if (!debugDictionary.Contains(outputVarTo))
            {
                debugDictionary.Add(outputVarTo);
            }
        }

        static void AssignOutputVariable(int update, IExecutionEnvironment env, IEnumerator<DataSplitDTO> resultsEnumerator, IDictionary<string, int> positions)
        {
            var tovar = resultsEnumerator.Current.OutputVariable;
            if (!String.IsNullOrEmpty(tovar))
            {
                var assignToVar = ExecutionEnvironment.ConvertToIndex(tovar, positions[tovar]);
                env.AssignWithFrame(new AssignValue(assignToVar, ""), update);
                positions[tovar] = positions[tovar] + 1;
            }
        }

        private static bool NewLine(string tmp) => tmp == "\r" || tmp == "\n" || tmp == Environment.NewLine;

        void HandleErrors(IDSFDataObject dataObject, int update, ErrorResultTO allErrors)
        {
            var hasErrors = allErrors.HasErrors();
            if (hasErrors)
            {
                DisplayAndWriteError("DsfDataSplitActivity", allErrors);
                var errorString = allErrors.MakeDisplayReady();
                dataObject.Environment.AddError(errorString);
            }

            if (dataObject.IsDebugMode())
            {
                DispatchDebugState(dataObject, StateType.Before, update);
                DispatchDebugState(dataObject, StateType.After, update);
            }
        }

        public override enFindMissingType GetFindMissingType() => enFindMissingType.MixedActivity;

        static bool ArePureScalarTargets(IEnumerable<DataSplitDTO> args) => args.All(arg => !DataListUtil.IsValueRecordset(arg.OutputVariable));

        void InsertToCollection(IEnumerable<string> listToAdd, ModelItem modelItem)
        {
            var modelProperty = modelItem.Properties["ResultsCollection"];
            var mic = modelProperty?.Collection;

            if (mic != null)
            {
                var listOfValidRows = ResultsCollection.Where(c => !c.CanRemove()).ToList();
                if (listOfValidRows.Count > 0)
                {
                    ConcatenateCollections(listToAdd, modelItem, mic);
                }
                else
                {
                    AddToCollection(listToAdd, modelItem);
                }
            }
        }

        void ConcatenateCollections(IEnumerable<string> listToAdd, ModelItem modelItem, ModelItemCollection mic)
        {
            var dataSplitDto = ResultsCollection.Last(c => !c.CanRemove());
            var startIndex = ResultsCollection.IndexOf(dataSplitDto) + 1;
            foreach (string s in listToAdd)
            {
                mic.Insert(startIndex, new DataSplitDTO(s, ResultsCollection[startIndex - 1].SplitType, ResultsCollection[startIndex - 1].At, startIndex + 1));
                startIndex++;
            }
            CleanUpCollection(mic, modelItem, startIndex);
        }

        void AddToCollection(IEnumerable<string> listToAdd, ModelItem modelItem)
        {
            var modelProperty = modelItem.Properties["ResultsCollection"];
            var mic = modelProperty?.Collection;

            if (mic != null)
            {
                var startIndex = 0;
                var firstRowSplitType = ResultsCollection[0].SplitType;
                var firstRowAt = ResultsCollection[0].At;
                mic.Clear();
                foreach (string s in listToAdd)
                {
                    mic.Add(new DataSplitDTO(s, firstRowSplitType, firstRowAt, startIndex + 1));
                    startIndex++;
                }
                CleanUpCollection(mic, modelItem, startIndex);
            }
        }

        void CleanUpCollection(ModelItemCollection mic, ModelItem modelItem, int startIndex)
        {
            if (startIndex < mic.Count)
            {
                mic.RemoveAt(startIndex);
            }
            mic.Add(new DataSplitDTO(string.Empty, "Chars", string.Empty, startIndex + 1));
            var modelProperty = modelItem.Properties["DisplayName"];
            modelProperty?.SetValue(CreateDisplayName(modelItem, startIndex + 1));
        }

        string CreateDisplayName(ModelItem modelItem, int count)
        {
            var modelProperty = modelItem.Properties["DisplayName"];
            if (modelProperty != null)
            {
                if (modelProperty.ComputedValue is string currentName && currentName.Contains("(") && currentName.Contains(")"))
                {
                    currentName = currentName.Remove(currentName.Contains(" (") ? currentName.IndexOf(" (", StringComparison.Ordinal) : currentName.IndexOf("(", StringComparison.Ordinal));
                }
                currentName = currentName + " (" + (count - 1) + ")";
                return currentName;
            }

            return string.Empty;
        }

        IDev2Tokenizer CreateSplitPattern(ref StringBuilder stringToSplit, IEnumerable<DataSplitDTO> args, IExecutionEnvironment compiler, out ErrorResultTO errors, int update)
        {


            var dtb = new Dev2TokenizerBuilder { ToTokenize = stringToSplit, ReverseOrder = ReverseOrder };
            errors = new ErrorResultTO();

            foreach (DataSplitDTO t in args)
            {
                stringToSplit = AddTokenOp(stringToSplit, compiler, errors, update, dtb, t);
                _indexCounter++;
            }
            return stringToSplit.Length <= 0 || errors.HasErrors() ? null : dtb.Generate();
        }

        StringBuilder AddTokenOp(StringBuilder stringToSplit, IExecutionEnvironment compiler, ErrorResultTO errors, int update, Dev2TokenizerBuilder dtb, DataSplitDTO t)
        {
            var parsedAt = t.At ?? string.Empty;
            var entry = "";

            switch (t.SplitType)
            {
                case "Index":
                    AddIndexOperation(dtb, compiler, errors, update, parsedAt);
                    break;
                case "End":
                    dtb.AddEoFOp();
                    break;
                case "Space":
                    dtb.AddTokenOp(" ", t.Include);
                    break;
                case "Tab":
                    dtb.AddTokenOp("\t", t.Include);
                    break;
                case "New Line":
                    t.Include |= !SkipBlankRows;
                    AddLineBreakTokenOp(stringToSplit, dtb, t);
                    break;
                case "Chars":
                    AddCharacterTokenOp(ref stringToSplit, compiler, update, dtb, t, parsedAt, ref entry);
                    break;
                default:
                    Dev2Logger.Info("No Split type for the Data Split Property Name: " + t.SplitType, GlobalConstants.WarewolfInfo);
                    break;
            }

            return stringToSplit;
        }

        void AddCharacterTokenOp(ref StringBuilder stringToSplit, IExecutionEnvironment compiler, int update, Dev2TokenizerBuilder dtb, DataSplitDTO t, string parsedAt, ref string entry)
        {
            if (!string.IsNullOrEmpty(parsedAt))
            {
                entry = EvalLineBreakCharacter(ref stringToSplit, compiler, update, dtb, parsedAt);
                var escape = EvalEscapeCharacter(compiler, update, t);
                dtb.AddTokenOp(entry, t.Include, escape);
            }
        }

        static void AddLineBreakTokenOp(StringBuilder stringToSplit, Dev2TokenizerBuilder dtb, DataSplitDTO t)
        {
            if (stringToSplit.Contains("\r\n"))
            {
                dtb.AddTokenOp("\r\n", t.Include);
            }
            else if (stringToSplit.Contains("\n"))
            {
                dtb.AddTokenOp("\n", t.Include);
            }
            else
            {
                if (stringToSplit.Contains("\r"))
                {
                    dtb.AddTokenOp("\r", t.Include);
                }
            }
        }

        string EvalLineBreakCharacter(ref StringBuilder stringToSplit, IExecutionEnvironment compiler, int update, Dev2TokenizerBuilder dtb, string parsedAt)
        {
            var entry = compiler.EvalAsListOfStrings(parsedAt, update).FirstOrDefault();
            if (entry != null && (entry.Contains(@"\r\n") || entry.Contains(@"\n")))
            {
                var match = Regex.Match(stringToSplit.ToString(), @"[\r\n]+");
                if (match.Success && !SkipBlankRows)
                {
                    stringToSplit = new StringBuilder(Regex.Escape(stringToSplit.ToString()));
                    dtb.ToTokenize = stringToSplit;
                }
            }

            return entry;
        }

        static string EvalEscapeCharacter(IExecutionEnvironment compiler, int update, DataSplitDTO t)
        {
            var escape = t.EscapeChar;
            if (!String.IsNullOrEmpty(escape))
            {
                escape = compiler.EvalAsListOfStrings(t.EscapeChar, update).FirstOrDefault();
            }

            return escape;
        }

        static void AddIndexOperation(Dev2TokenizerBuilder dtb, IExecutionEnvironment compiler, ErrorResultTO errors, int update, string parsedAt)
        {
            try
            {
                var entry = compiler.EvalAsListOfStrings(parsedAt, update).FirstOrDefault();
                if (entry == null)
                {
                    throw new Exception("null iterator expression");
                }

                var index = entry;
                var indexNum = Convert.ToInt32(index);
                if (indexNum > 0)
                {
                    dtb.AddIndexOp(indexNum);
                }
            }
            catch (Exception ex)
            {
                errors.AddError(ex.Message);
            }
        }

        void AddDebug(IEnumerable<DataSplitDTO> resultCollection, IExecutionEnvironment env, int update)
        {
            foreach (DataSplitDTO t in resultCollection)
            {
                var debugItem = AddParamsToDebug(env, update, t);
                AddResultsToDebug(env, update, t, debugItem);
                _indexCounter++;
                _debugInputs.Add(debugItem);
            }
        }

        void AddResultsToDebug(IExecutionEnvironment env, int update, DataSplitDTO t, DebugItem debugItem)
        {
            switch (t.SplitType)
            {
                case "Index":
                    AddDebugItem(new DebugEvalResult(t.At, "Using", env, update), debugItem);
                    AddDebugItem(new DebugItemStaticDataParams(t.Include ? "Yes" : "No", "Include"), debugItem);
                    break;
                case "End":
                case "Space":
                case "Tab":
                case "New Line":
                    AddDebugItem(new DebugItemStaticDataParams(t.Include ? "Yes" : "No", "Include"), debugItem);
                    break;
                case "Chars":
                    AddDebugItem(new DebugEvalResult(t.At, "Using", env, update), debugItem);
                    AddDebugItem(new DebugItemStaticDataParams(t.Include ? "Yes" : "No", "Include"), debugItem);
                    AddDebugItem(new DebugItemStaticDataParams(t.EscapeChar, "Escape"), debugItem);
                    break;
                default:
                    return;
            }
        }

        DebugItem AddParamsToDebug(IExecutionEnvironment env, int update, DataSplitDTO t)
        {
            var debugItem = new DebugItem();
            AddDebugItem(new DebugItemStaticDataParams("", _indexCounter.ToString(CultureInfo.InvariantCulture)), debugItem);
            if (!string.IsNullOrEmpty(t.OutputVariable))
            {
                AddDebugItem(new DebugEvalResult(t.OutputVariable, "", env, update), debugItem);
            }
            AddDebugItem(new DebugItemStaticDataParams(t.SplitType, "With"), debugItem);
            return debugItem;
        }

        static void CleanArguments(IList<DataSplitDTO> args)
        {
            var count = 0;
            while (count < args.Count)
            {
                if (string.IsNullOrEmpty(args[count].OutputVariable))
                {
                    if (args[count].SplitType == "Index" && string.IsNullOrEmpty(args[count].At) ||
                       args[count].SplitType == "Chars" && string.IsNullOrEmpty(args[count].At))
                    {
                        args.RemoveAt(count);
                    }
                    else
                    {
                        count++;
                    }
                }
                else
                {
                    count++;
                }
            }
        }

        public override List<DebugItem> GetDebugInputs(IExecutionEnvironment env, int update)
        {
            foreach (IDebugItem debugInput in _debugInputs)
            {
                debugInput.FlushStringBuilder();
            }
            return _debugInputs;
        }

        public override List<DebugItem> GetDebugOutputs(IExecutionEnvironment env, int update)
        {
            foreach (IDebugItem debugOutput in _debugOutputs)
            {
                debugOutput.FlushStringBuilder();
            }
            return _debugOutputs;
        }

        public override void UpdateForEachInputs(IList<Tuple<string, string>> updates)
        {
            if (updates == null)
            {
                return;
            }
            foreach (Tuple<string, string> t in updates)
            {
                // locate all updates for this tuple
                var t1 = t;
                var items = ResultsCollection.Where(c => !string.IsNullOrEmpty(c.At) && c.At.Equals(t1.Item1));

                // issues updates
                foreach (var a in items)
                {
                    a.At = t.Item2;
                }

                if (SourceString == t.Item1)
                {
                    SourceString = t.Item2;
                }
            }
        }

        public override void UpdateForEachOutputs(IList<Tuple<string, string>> updates)
        {
            if (updates == null)
            {
                return;
            }
            foreach (Tuple<string, string> t in updates)
            {
                // locate all updates for this tuple
                var t1 = t;
                var items = ResultsCollection.Where(c => !string.IsNullOrEmpty(c.OutputVariable) && c.OutputVariable.Equals(t1.Item1));

                // issues updates
                foreach (var a in items)
                {
                    a.OutputVariable = t.Item2;
                }
            }
        }

        public override IList<DsfForEachItem> GetForEachInputs()
        {
            var items = new[] { SourceString }.Union(ResultsCollection.Where(c => !string.IsNullOrEmpty(c.At)).Select(c => c.At)).ToArray();
            return GetForEachItems(items);
        }

        public override IList<DsfForEachItem> GetForEachOutputs()
        {
            var items = ResultsCollection.Where(c => !string.IsNullOrEmpty(c.OutputVariable)).Select(c => c.OutputVariable).ToArray();
            return GetForEachItems(items);
        }

        public int GetCollectionCount() => ResultsCollection.Count(caseConvertTo => !caseConvertTo.CanRemove());

        public void AddListToCollection(IList<string> listToAdd, bool overwrite, ModelItem modelItem)
        {
            if (!overwrite)
            {
                InsertToCollection(listToAdd, modelItem);
            }
            else
            {
                AddToCollection(listToAdd, modelItem);
            }
        }

        public override List<string> GetOutputs() => ResultsCollection.Select(dto => dto.OutputVariable).ToList();

        public bool Equals(DsfDataSplitActivity other)
        {
            if (ReferenceEquals(null, other))
            {
                return false;
            }

            if (ReferenceEquals(this, other))
            {
                return true;
            }

            var resultsCollectionsAreEqual = CommonEqualityOps.CollectionEquals(ResultsCollection.OrderBy(dto => dto.IndexNumber), other.ResultsCollection.OrderBy(dto => dto.IndexNumber), new DataSplitDTOComparer());
            return base.Equals(other)
                && string.Equals(SourceString, other.SourceString)
                && _indexCounter == other._indexCounter
                && resultsCollectionsAreEqual
                && ReverseOrder == other.ReverseOrder
                && SkipBlankRows == other.SkipBlankRows;
        }

        public override bool Equals(object obj)
        {
            if (ReferenceEquals(null, obj))
            {
                return false;
            }

            if (ReferenceEquals(this, obj))
            {
                return true;
            }

            if (obj.GetType() != this.GetType())
            {
                return false;
            }

            return Equals((DsfDataSplitActivity)obj);
        }

        public override int GetHashCode()
        {
            unchecked
            {
                var hashCode = base.GetHashCode();
                hashCode = (hashCode * 397) ^ (SourceString != null ? SourceString.GetHashCode() : 0);
                hashCode = (hashCode * 397) ^ _indexCounter;
                hashCode = (hashCode * 397) ^ (_resultsCollection != null ? _resultsCollection.GetHashCode() : 0);
                hashCode = (hashCode * 397) ^ ReverseOrder.GetHashCode();
                hashCode = (hashCode * 397) ^ SkipBlankRows.GetHashCode();
                return hashCode;
            }
        }
    }
}
---- Semantic diagnostics *before* transformation ----
D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataSplitActivity.cs(168,41): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataSplitActivity.cs(169,31): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?)
---- Semantic diagnostics *after* transformation ----
D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataSplitActivity.cs(168,41): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataSplitActivity.cs(169,31): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfDataSplitActivity.cs(414,31): error CS0165: Use of unassigned local variable 'currentName'
######################################################################


######################################################################
Nr: 7 - UsePatternMatchingRewriterR8
Filepath: D:\a\1\s\Dev\Dev2.Activities\Activities\DsfGatherSystemInformationActivity.cs
Description: Error: The created Syntax Tree is semantically incorrect.
------------------------------------------------------------------------
---- Original Tree ----
using System;
using System.Activities;
using System.Activities.Presentation.Model;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using System.Security.Principal;
using Dev2.Activities.Debug;
using Dev2.Common;
using Dev2.Common.ExtMethods;
using Dev2.Common.Interfaces.Diagnostics.Debug;
using Dev2.Common.Interfaces.Toolbox;
using Dev2.Data.Interfaces.Enums;
using Dev2.Data.TO;
using Dev2.DataList.Contract;
using Dev2.Diagnostics;
using Dev2.Interfaces;
using Unlimited.Applications.BusinessDesignStudio.Activities;
using Warewolf.Core;
using Warewolf.Resource.Errors;
using Warewolf.Storage.Interfaces;
using WarewolfParserInterop;
using Dev2.Comparer;
using Dev2.Common.State;
using Dev2.Utilities;

namespace Dev2.Activities
{
    public class DsfGatherSystemInformationActivity : DsfActivityAbstract<string>, ICollectionActivity
    {
        #region Fields

        IGetSystemInformation _getSystemInformation;
        IIdentity _currentIdentity;

        #endregion

        /// <summary>
        /// The property that holds all the conversions
        /// </summary>
        public IList<GatherSystemInformationTO> SystemInformationCollection { get; set; }

        public IGetSystemInformation GetSystemInformation
        {
            get
            {
                return _getSystemInformation ?? (_getSystemInformation = new GetSystemInformationHelper());
            }
            set
            {
                _getSystemInformation = value;
            }
        }


        public override List<string> GetOutputs() => SystemInformationCollection.Select(to => to.Result).ToList();

        #region Overrides of DsfNativeActivity<string>

        public DsfGatherSystemInformationActivity()
            : base("Gather System Information")
        {
            SystemInformationCollection = new List<GatherSystemInformationTO>();
        }

        public override IEnumerable<StateVariable> GetState()
        {
            return new[]
            {
                new StateVariable
                {
                    Name="SystemInformationCollection",
                    Type=StateVariable.StateType.InputOutput,
                    Value= ActivityHelper.GetSerializedStateValueFromCollection(SystemInformationCollection)
                }
            };
        }

        void CleanArgs()
        {
            var count = 0;
            while (count < SystemInformationCollection.Count)
            {
                if (string.IsNullOrWhiteSpace(SystemInformationCollection[count].Result))
                {
                    SystemInformationCollection.RemoveAt(count);
                }
                else
                {
                    count++;
                }
            }
        }
        /// <summary>
        /// When overridden runs the activity's execution logic
        /// </summary>
        /// <param name="context">The context to be used.</param>

        protected override void OnExecute(NativeActivityContext context)
            
        {
            var dataObject = context.GetExtension<IDSFDataObject>();
            ExecuteTool(dataObject, 0);
        }

        protected override void ExecuteTool(IDSFDataObject dataObject, int update)
        {
            var allErrors = new ErrorResultTO();

            if (dataObject.ExecutingUser != null)
            {
                _currentIdentity = dataObject.ExecutingUser.Identity;
            }
            InitializeDebug(dataObject);
            try
            {
                TryExecute(dataObject, update, allErrors);
            }
            catch (Exception e)
            {
                Dev2Logger.Error("DSFGatherSystemInformationTool", e, GlobalConstants.WarewolfError);
                allErrors.AddError(e.Message);
            }
            finally
            {
                HandleErrors(dataObject, update, allErrors);
            }
        }

        void HandleErrors(IDSFDataObject dataObject, int update, ErrorResultTO allErrors)
        {
            var hasErrors = allErrors.HasErrors();
            if (hasErrors)
            {
                DisplayAndWriteError("DsfExecuteCommandLineActivity", allErrors);
                foreach (var error in allErrors.FetchErrors())
                {
                    dataObject.Environment.AddError(error);
                }
            }
            if (dataObject.IsDebugMode())
            {
                if (hasErrors)
                {
                    var innerCount = 1;
                    foreach (GatherSystemInformationTO item in SystemInformationCollection)
                    {
                        var itemToAdd = new DebugItem();
                        AddDebugItem(new DebugItemStaticDataParams("", innerCount.ToString(CultureInfo.InvariantCulture)), itemToAdd);
                        AddDebugItem(new DebugEvalResult(item.Result, "", dataObject.Environment, update), itemToAdd);
                        _debugOutputs.Add(itemToAdd);
                        innerCount++;
                    }
                }

                DispatchDebugState(dataObject, StateType.Before, update);
                DispatchDebugState(dataObject, StateType.After, update);
            }
        }

        void TryExecute(IDSFDataObject dataObject, int update, ErrorResultTO allErrors)
        {
            var indexCounter = 0;
            CleanArgs();

            foreach (GatherSystemInformationTO item in SystemInformationCollection)
            {
                try
                {
                    if (dataObject.IsDebugMode())
                    {
                        var inputToAdd = new DebugItem();
                        AddDebugItem(new DebugItemStaticDataParams("", (++indexCounter).ToString(CultureInfo.InvariantCulture)), inputToAdd);
                        AddDebugItem(new DebugItemStaticDataParams("", dataObject.Environment.EvalToExpression(item.Result, update), "", "="), inputToAdd);
                        AddDebugItem(new DebugItemStaticDataParams(item.EnTypeOfSystemInformation.GetDescription(), ""), inputToAdd);
                        _debugInputs.Add(inputToAdd);
                    }

                    var hasErrors = allErrors.HasErrors();
                    if (!hasErrors)
                    {
                        ExecuteForTO(dataObject, update, allErrors, item);
                    }
                }
                catch (Exception err)
                {
                    dataObject.Environment.Assign(item.Result, null, update);
                    allErrors.AddError(err.Message);
                }
            }
            dataObject.Environment.CommitAssign();
            if (dataObject.IsDebugMode() && !allErrors.HasErrors())
            {
                var innerCount = 1;
                foreach (GatherSystemInformationTO item in SystemInformationCollection)
                {
                    var itemToAdd = new DebugItem();
                    AddDebugItem(new DebugItemStaticDataParams("", "", innerCount.ToString(CultureInfo.InvariantCulture)), itemToAdd);
                    AddDebugItem(new DebugEvalResult(item.Result, "", dataObject.Environment, update), itemToAdd);
                    _debugOutputs.Add(itemToAdd);
                    innerCount++;
                }
            }
        }

        void ExecuteForTO(IDSFDataObject dataObject, int update, ErrorResultTO allErrors, GatherSystemInformationTO item)
        {
            var val = GetCorrectSystemInformation(item.EnTypeOfSystemInformation);
            var expression = item.Result;

            var regions = DataListCleaningUtils.SplitIntoRegions(expression);
            if (regions.Count > 1)
            {
                allErrors.AddError(ErrorResource.MultipleVariablesInResultField);
            }
            else
            {
                foreach (var region in regions)
                {
                    dataObject.Environment.AssignWithFrame(new AssignValue(region, val), update);
                }
            }
        }

#pragma warning disable S1541 // Methods and properties should not be too complex
        public string GetCorrectSystemInformation(enTypeOfSystemInformationToGather enTypeOfSystemInformation)
#pragma warning restore S1541 // Methods and properties should not be too complex
        {
            switch(enTypeOfSystemInformation)
            {
                case enTypeOfSystemInformationToGather.ComputerName:
                    return GetSystemInformation.GetComputerName();
                case enTypeOfSystemInformationToGather.OperatingSystem:
                    return GetSystemInformation.GetOperatingSystemInformation();
                case enTypeOfSystemInformationToGather.OperatingSystemVersion:
                    return GetSystemInformation.GetOperatingSystemVersionInformation();
                case enTypeOfSystemInformationToGather.ServicePack:
                    return GetSystemInformation.GetServicePackInformation();
                case enTypeOfSystemInformationToGather.OSBitValue:
                    return GetSystemInformation.GetOSBitValueInformation();
                case enTypeOfSystemInformationToGather.FullDateTime:
                    return GetSystemInformation.GetFullDateTimeInformation();
                case enTypeOfSystemInformationToGather.DateTimeFormat:
                    return GetSystemInformation.GetDateTimeFormatInformation();
                case enTypeOfSystemInformationToGather.DiskAvailable:
                    return GetSystemInformation.GetDiskSpaceAvailableInformation();
                case enTypeOfSystemInformationToGather.DiskTotal:
                    return GetSystemInformation.GetDiskSpaceTotalInformation();
                case enTypeOfSystemInformationToGather.VirtualMemoryAvailable:
                    return GetSystemInformation.GetVirtualMemoryAvailableInformation();
                case enTypeOfSystemInformationToGather.VirtualMemoryTotal:
                    return GetSystemInformation.GetVirtualMemoryTotalInformation();
                case enTypeOfSystemInformationToGather.PhysicalMemoryAvailable:
                    return GetSystemInformation.GetPhysicalMemoryAvailableInformation();
                case enTypeOfSystemInformationToGather.PhysicalMemoryTotal:
                    return GetSystemInformation.GetPhysicalMemoryTotalInformation();
                case enTypeOfSystemInformationToGather.CPUAvailable:
                    return GetSystemInformation.GetCPUAvailableInformation();
                case enTypeOfSystemInformationToGather.CPUTotal:
                    return GetSystemInformation.GetCPUTotalInformation();
                case enTypeOfSystemInformationToGather.Language:
                    return GetSystemInformation.GetLanguageInformation();
                case enTypeOfSystemInformationToGather.Region:
                    return GetSystemInformation.GetRegionInformation();
                case enTypeOfSystemInformationToGather.UserRoles:
                    return GetSystemInformation.GetUserRolesInformation(_currentIdentity);
                case enTypeOfSystemInformationToGather.UserName:
                    return GetSystemInformation.GetUserNameInformation();
                case enTypeOfSystemInformationToGather.Domain:
                    return GetSystemInformation.GetDomainInformation();
                case enTypeOfSystemInformationToGather.NumberOfServerNICS:
                    return GetSystemInformation.GetNumberOfNICS();
                case enTypeOfSystemInformationToGather.MacAddress:
                    return GetSystemInformation.GetMACAdresses();
                case enTypeOfSystemInformationToGather.GateWayAddress:
                    return GetSystemInformation.GetDefaultGateway();
                case enTypeOfSystemInformationToGather.DNSAddress:
                    return GetSystemInformation.GetDNSServer();
                case enTypeOfSystemInformationToGather.IPv4Address:
                    return GetSystemInformation.GetIPv4Adresses();
                case enTypeOfSystemInformationToGather.IPv6Address:
                    return GetSystemInformation.GetIPv6Adresses();
                case enTypeOfSystemInformationToGather.WarewolfMemory:
                    return GetSystemInformation.GetWarewolfServerMemory();
                case enTypeOfSystemInformationToGather.WarewolfCPU:
                    return GetSystemInformation.GetWarewolfCPU();
                case enTypeOfSystemInformationToGather.WarewolfServerVersion:
                    return GetSystemInformation.GetWareWolfVersion();
                default:
                    throw new ArgumentOutOfRangeException("enTypeOfSystemInformation");
            }
        }

        public override IList<DsfForEachItem> GetForEachInputs()
        {
            var enumerable = SystemInformationCollection.Select(to => to.Result);
            return GetForEachItems(enumerable.ToArray());
        }

        public override IList<DsfForEachItem> GetForEachOutputs()
        {
            var enumerable = SystemInformationCollection.Select(to => to.Result);
            return GetForEachItems(enumerable.ToArray());
        }

        public override enFindMissingType GetFindMissingType() => enFindMissingType.DataGridActivity;

        public override void UpdateForEachInputs(IList<Tuple<string, string>> updates)
        {
            if(updates != null)
            {
                foreach(Tuple<string, string> t in updates)
                {
                    // locate all updates for this tuple
                    var t1 = t;
                    var items = SystemInformationCollection.Where(c => !string.IsNullOrEmpty(c.Result) && c.Result.Equals(t1.Item1));

                    // issues updates
                    foreach(var a in items)
                    {
                        a.Result = t.Item2;
                    }
                }
            }
        }

        public override void UpdateForEachOutputs(IList<Tuple<string, string>> updates)
        {
            if(updates != null)
            {
                foreach(Tuple<string, string> t in updates)
                {
                    // locate all updates for this tuple
                    var t1 = t;
                    var items = SystemInformationCollection.Where(c => !string.IsNullOrEmpty(c.Result) && c.Result.Equals(t1.Item1));

                    // issues updates
                    foreach(var a in items)
                    {
                        a.Result = t.Item2;
                    }
                }
            }
        }

        #region Overrides of DsfNativeActivity<string>

        public override List<DebugItem> GetDebugInputs(IExecutionEnvironment env, int update) => _debugInputs;

        public override List<DebugItem> GetDebugOutputs(IExecutionEnvironment env, int update)
        {
            foreach(IDebugItem debugOutput in _debugOutputs)
            {
                debugOutput.FlushStringBuilder();
            }
            return _debugOutputs;
        }

        #endregion

        #region Private Methods

        void InsertToCollection(IEnumerable<string> listToAdd, ModelItem modelItem)
        {
            var modelProperty = modelItem.Properties["SystemInformationCollection"];
            if (modelProperty != null)
            {
                var mic = modelProperty.Collection;

                if (mic != null)
                {
                    var listOfValidRows = SystemInformationCollection.Where(c => !c.CanRemove()).ToList();
                    if (listOfValidRows.Count > 0)
                    {
                        var gatherSystemInformationTo = SystemInformationCollection.Last(c => !c.CanRemove());
                        var startIndex = SystemInformationCollection.IndexOf(gatherSystemInformationTo) + 1;
                        startIndex = InsertAllItems(listToAdd, mic, startIndex);
                        CleanUpCollection(mic, modelItem, startIndex);
                    }
                    else
                    {
                        AddToCollection(listToAdd, modelItem);
                    }
                }
            }
        }

        private int InsertAllItems(IEnumerable<string> listToAdd, ModelItemCollection mic, int startIndex)
        {
            foreach (string s in listToAdd)
            {
                mic.Insert(startIndex, new GatherSystemInformationTO(SystemInformationCollection[startIndex - 1].EnTypeOfSystemInformation, s, startIndex + 1));
                startIndex++;
            }

            return startIndex;
        }

        void AddToCollection(IEnumerable<string> listToAdd, ModelItem modelItem)
        {
            var modelProperty = modelItem.Properties["SystemInformationCollection"];
            if (modelProperty != null)
            {
                var mic = modelProperty.Collection;

                if (mic != null)
                {
                    var startIndex = 0;
                    const enTypeOfSystemInformationToGather EnTypeOfSystemInformation = enTypeOfSystemInformationToGather.FullDateTime;
                    mic.Clear();
                    foreach (string s in listToAdd)
                    {
                        mic.Add(new GatherSystemInformationTO(EnTypeOfSystemInformation, s, startIndex + 1));
                        startIndex++;
                    }
                    CleanUpCollection(mic, modelItem, startIndex);
                }
            }
        }

        void CleanUpCollection(ModelItemCollection mic, ModelItem modelItem, int startIndex)
        {
            if (startIndex < mic.Count)
            {
                mic.RemoveAt(startIndex);
            }
            mic.Add(new GatherSystemInformationTO(enTypeOfSystemInformationToGather.FullDateTime, string.Empty, startIndex + 1));
            var modelProperty = modelItem.Properties["DisplayName"];
            modelProperty?.SetValue(CreateDisplayName(modelItem, startIndex + 1));
        }

        string CreateDisplayName(ModelItem modelItem, int count)
        {
            var modelProperty = modelItem.Properties["DisplayName"];
            if (modelProperty != null)
            {
                var currentName = modelProperty.ComputedValue as string;
                if (currentName != null && currentName.Contains("(") && currentName.Contains(")"))
                {
                    currentName = currentName.Remove(currentName.Contains(" (") ? currentName.IndexOf(" (", StringComparison.Ordinal) : currentName.IndexOf("(", StringComparison.Ordinal));
                }
                currentName = currentName + " (" + (count - 1) + ")";
                return currentName;
            }

            return string.Empty;
        }

        #endregion

        #endregion

        #region Implementation of ICollectionActivity

        public int GetCollectionCount() => SystemInformationCollection.Count(caseConvertTo => !caseConvertTo.CanRemove());

        public void AddListToCollection(IList<string> listToAdd, bool overwrite, ModelItem modelItem)
        {
            if(!overwrite)
            {
                InsertToCollection(listToAdd, modelItem);
            }
            else
            {
                AddToCollection(listToAdd, modelItem);
            }
        }

        #endregion

        public bool Equals(DsfGatherSystemInformationActivity other)
        {
            if (ReferenceEquals(null, other))
            {
                return false;
            }

            if (ReferenceEquals(this, other))
            {
                return true;
            }

            return base.Equals(other)
                && CommonEqualityOps.CollectionEquals(SystemInformationCollection, other.SystemInformationCollection, new GatherSystemInformationTOComparer());
        }

        public override bool Equals(object obj)
        {
            if (ReferenceEquals(null, obj))
            {
                return false;
            }

            if (ReferenceEquals(this, obj))
            {
                return true;
            }

            if (obj.GetType() != this.GetType())
            {
                return false;
            }

            return Equals((DsfGatherSystemInformationActivity) obj);
        }

        public override int GetHashCode()
        {
            unchecked
            {
                var hashCode = base.GetHashCode();
                hashCode = (hashCode * 397) ^ (SystemInformationCollection != null ? SystemInformationCollection.GetHashCode() : 0);
                return hashCode;
            }
        }
    }


}

---- Transformed Tree ----
using System;
using System.Activities;
using System.Activities.Presentation.Model;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using System.Security.Principal;
using Dev2.Activities.Debug;
using Dev2.Common;
using Dev2.Common.ExtMethods;
using Dev2.Common.Interfaces.Diagnostics.Debug;
using Dev2.Common.Interfaces.Toolbox;
using Dev2.Data.Interfaces.Enums;
using Dev2.Data.TO;
using Dev2.DataList.Contract;
using Dev2.Diagnostics;
using Dev2.Interfaces;
using Unlimited.Applications.BusinessDesignStudio.Activities;
using Warewolf.Core;
using Warewolf.Resource.Errors;
using Warewolf.Storage.Interfaces;
using WarewolfParserInterop;
using Dev2.Comparer;
using Dev2.Common.State;
using Dev2.Utilities;

namespace Dev2.Activities
{
    public class DsfGatherSystemInformationActivity : DsfActivityAbstract<string>, ICollectionActivity
    {
        #region Fields

        IGetSystemInformation _getSystemInformation;
        IIdentity _currentIdentity;

        #endregion

        /// <summary>
        /// The property that holds all the conversions
        /// </summary>
        public IList<GatherSystemInformationTO> SystemInformationCollection { get; set; }

        public IGetSystemInformation GetSystemInformation
        {
            get
            {
                return _getSystemInformation ?? (_getSystemInformation = new GetSystemInformationHelper());
            }
            set
            {
                _getSystemInformation = value;
            }
        }


        public override List<string> GetOutputs() => SystemInformationCollection.Select(to => to.Result).ToList();

        #region Overrides of DsfNativeActivity<string>

        public DsfGatherSystemInformationActivity()
            : base("Gather System Information")
        {
            SystemInformationCollection = new List<GatherSystemInformationTO>();
        }

        public override IEnumerable<StateVariable> GetState()
        {
            return new[]
            {
                new StateVariable
                {
                    Name="SystemInformationCollection",
                    Type=StateVariable.StateType.InputOutput,
                    Value= ActivityHelper.GetSerializedStateValueFromCollection(SystemInformationCollection)
                }
            };
        }

        void CleanArgs()
        {
            var count = 0;
            while (count < SystemInformationCollection.Count)
            {
                if (string.IsNullOrWhiteSpace(SystemInformationCollection[count].Result))
                {
                    SystemInformationCollection.RemoveAt(count);
                }
                else
                {
                    count++;
                }
            }
        }
        /// <summary>
        /// When overridden runs the activity's execution logic
        /// </summary>
        /// <param name="context">The context to be used.</param>

        protected override void OnExecute(NativeActivityContext context)
            
        {
            var dataObject = context.GetExtension<IDSFDataObject>();
            ExecuteTool(dataObject, 0);
        }

        protected override void ExecuteTool(IDSFDataObject dataObject, int update)
        {
            var allErrors = new ErrorResultTO();

            if (dataObject.ExecutingUser != null)
            {
                _currentIdentity = dataObject.ExecutingUser.Identity;
            }
            InitializeDebug(dataObject);
            try
            {
                TryExecute(dataObject, update, allErrors);
            }
            catch (Exception e)
            {
                Dev2Logger.Error("DSFGatherSystemInformationTool", e, GlobalConstants.WarewolfError);
                allErrors.AddError(e.Message);
            }
            finally
            {
                HandleErrors(dataObject, update, allErrors);
            }
        }

        void HandleErrors(IDSFDataObject dataObject, int update, ErrorResultTO allErrors)
        {
            var hasErrors = allErrors.HasErrors();
            if (hasErrors)
            {
                DisplayAndWriteError("DsfExecuteCommandLineActivity", allErrors);
                foreach (var error in allErrors.FetchErrors())
                {
                    dataObject.Environment.AddError(error);
                }
            }
            if (dataObject.IsDebugMode())
            {
                if (hasErrors)
                {
                    var innerCount = 1;
                    foreach (GatherSystemInformationTO item in SystemInformationCollection)
                    {
                        var itemToAdd = new DebugItem();
                        AddDebugItem(new DebugItemStaticDataParams("", innerCount.ToString(CultureInfo.InvariantCulture)), itemToAdd);
                        AddDebugItem(new DebugEvalResult(item.Result, "", dataObject.Environment, update), itemToAdd);
                        _debugOutputs.Add(itemToAdd);
                        innerCount++;
                    }
                }

                DispatchDebugState(dataObject, StateType.Before, update);
                DispatchDebugState(dataObject, StateType.After, update);
            }
        }

        void TryExecute(IDSFDataObject dataObject, int update, ErrorResultTO allErrors)
        {
            var indexCounter = 0;
            CleanArgs();

            foreach (GatherSystemInformationTO item in SystemInformationCollection)
            {
                try
                {
                    if (dataObject.IsDebugMode())
                    {
                        var inputToAdd = new DebugItem();
                        AddDebugItem(new DebugItemStaticDataParams("", (++indexCounter).ToString(CultureInfo.InvariantCulture)), inputToAdd);
                        AddDebugItem(new DebugItemStaticDataParams("", dataObject.Environment.EvalToExpression(item.Result, update), "", "="), inputToAdd);
                        AddDebugItem(new DebugItemStaticDataParams(item.EnTypeOfSystemInformation.GetDescription(), ""), inputToAdd);
                        _debugInputs.Add(inputToAdd);
                    }

                    var hasErrors = allErrors.HasErrors();
                    if (!hasErrors)
                    {
                        ExecuteForTO(dataObject, update, allErrors, item);
                    }
                }
                catch (Exception err)
                {
                    dataObject.Environment.Assign(item.Result, null, update);
                    allErrors.AddError(err.Message);
                }
            }
            dataObject.Environment.CommitAssign();
            if (dataObject.IsDebugMode() && !allErrors.HasErrors())
            {
                var innerCount = 1;
                foreach (GatherSystemInformationTO item in SystemInformationCollection)
                {
                    var itemToAdd = new DebugItem();
                    AddDebugItem(new DebugItemStaticDataParams("", "", innerCount.ToString(CultureInfo.InvariantCulture)), itemToAdd);
                    AddDebugItem(new DebugEvalResult(item.Result, "", dataObject.Environment, update), itemToAdd);
                    _debugOutputs.Add(itemToAdd);
                    innerCount++;
                }
            }
        }

        void ExecuteForTO(IDSFDataObject dataObject, int update, ErrorResultTO allErrors, GatherSystemInformationTO item)
        {
            var val = GetCorrectSystemInformation(item.EnTypeOfSystemInformation);
            var expression = item.Result;

            var regions = DataListCleaningUtils.SplitIntoRegions(expression);
            if (regions.Count > 1)
            {
                allErrors.AddError(ErrorResource.MultipleVariablesInResultField);
            }
            else
            {
                foreach (var region in regions)
                {
                    dataObject.Environment.AssignWithFrame(new AssignValue(region, val), update);
                }
            }
        }

#pragma warning disable S1541 // Methods and properties should not be too complex
        public string GetCorrectSystemInformation(enTypeOfSystemInformationToGather enTypeOfSystemInformation)
#pragma warning restore S1541 // Methods and properties should not be too complex
        {
            switch(enTypeOfSystemInformation)
            {
                case enTypeOfSystemInformationToGather.ComputerName:
                    return GetSystemInformation.GetComputerName();
                case enTypeOfSystemInformationToGather.OperatingSystem:
                    return GetSystemInformation.GetOperatingSystemInformation();
                case enTypeOfSystemInformationToGather.OperatingSystemVersion:
                    return GetSystemInformation.GetOperatingSystemVersionInformation();
                case enTypeOfSystemInformationToGather.ServicePack:
                    return GetSystemInformation.GetServicePackInformation();
                case enTypeOfSystemInformationToGather.OSBitValue:
                    return GetSystemInformation.GetOSBitValueInformation();
                case enTypeOfSystemInformationToGather.FullDateTime:
                    return GetSystemInformation.GetFullDateTimeInformation();
                case enTypeOfSystemInformationToGather.DateTimeFormat:
                    return GetSystemInformation.GetDateTimeFormatInformation();
                case enTypeOfSystemInformationToGather.DiskAvailable:
                    return GetSystemInformation.GetDiskSpaceAvailableInformation();
                case enTypeOfSystemInformationToGather.DiskTotal:
                    return GetSystemInformation.GetDiskSpaceTotalInformation();
                case enTypeOfSystemInformationToGather.VirtualMemoryAvailable:
                    return GetSystemInformation.GetVirtualMemoryAvailableInformation();
                case enTypeOfSystemInformationToGather.VirtualMemoryTotal:
                    return GetSystemInformation.GetVirtualMemoryTotalInformation();
                case enTypeOfSystemInformationToGather.PhysicalMemoryAvailable:
                    return GetSystemInformation.GetPhysicalMemoryAvailableInformation();
                case enTypeOfSystemInformationToGather.PhysicalMemoryTotal:
                    return GetSystemInformation.GetPhysicalMemoryTotalInformation();
                case enTypeOfSystemInformationToGather.CPUAvailable:
                    return GetSystemInformation.GetCPUAvailableInformation();
                case enTypeOfSystemInformationToGather.CPUTotal:
                    return GetSystemInformation.GetCPUTotalInformation();
                case enTypeOfSystemInformationToGather.Language:
                    return GetSystemInformation.GetLanguageInformation();
                case enTypeOfSystemInformationToGather.Region:
                    return GetSystemInformation.GetRegionInformation();
                case enTypeOfSystemInformationToGather.UserRoles:
                    return GetSystemInformation.GetUserRolesInformation(_currentIdentity);
                case enTypeOfSystemInformationToGather.UserName:
                    return GetSystemInformation.GetUserNameInformation();
                case enTypeOfSystemInformationToGather.Domain:
                    return GetSystemInformation.GetDomainInformation();
                case enTypeOfSystemInformationToGather.NumberOfServerNICS:
                    return GetSystemInformation.GetNumberOfNICS();
                case enTypeOfSystemInformationToGather.MacAddress:
                    return GetSystemInformation.GetMACAdresses();
                case enTypeOfSystemInformationToGather.GateWayAddress:
                    return GetSystemInformation.GetDefaultGateway();
                case enTypeOfSystemInformationToGather.DNSAddress:
                    return GetSystemInformation.GetDNSServer();
                case enTypeOfSystemInformationToGather.IPv4Address:
                    return GetSystemInformation.GetIPv4Adresses();
                case enTypeOfSystemInformationToGather.IPv6Address:
                    return GetSystemInformation.GetIPv6Adresses();
                case enTypeOfSystemInformationToGather.WarewolfMemory:
                    return GetSystemInformation.GetWarewolfServerMemory();
                case enTypeOfSystemInformationToGather.WarewolfCPU:
                    return GetSystemInformation.GetWarewolfCPU();
                case enTypeOfSystemInformationToGather.WarewolfServerVersion:
                    return GetSystemInformation.GetWareWolfVersion();
                default:
                    throw new ArgumentOutOfRangeException("enTypeOfSystemInformation");
            }
        }

        public override IList<DsfForEachItem> GetForEachInputs()
        {
            var enumerable = SystemInformationCollection.Select(to => to.Result);
            return GetForEachItems(enumerable.ToArray());
        }

        public override IList<DsfForEachItem> GetForEachOutputs()
        {
            var enumerable = SystemInformationCollection.Select(to => to.Result);
            return GetForEachItems(enumerable.ToArray());
        }

        public override enFindMissingType GetFindMissingType() => enFindMissingType.DataGridActivity;

        public override void UpdateForEachInputs(IList<Tuple<string, string>> updates)
        {
            if(updates != null)
            {
                foreach(Tuple<string, string> t in updates)
                {
                    // locate all updates for this tuple
                    var t1 = t;
                    var items = SystemInformationCollection.Where(c => !string.IsNullOrEmpty(c.Result) && c.Result.Equals(t1.Item1));

                    // issues updates
                    foreach(var a in items)
                    {
                        a.Result = t.Item2;
                    }
                }
            }
        }

        public override void UpdateForEachOutputs(IList<Tuple<string, string>> updates)
        {
            if(updates != null)
            {
                foreach(Tuple<string, string> t in updates)
                {
                    // locate all updates for this tuple
                    var t1 = t;
                    var items = SystemInformationCollection.Where(c => !string.IsNullOrEmpty(c.Result) && c.Result.Equals(t1.Item1));

                    // issues updates
                    foreach(var a in items)
                    {
                        a.Result = t.Item2;
                    }
                }
            }
        }

        #region Overrides of DsfNativeActivity<string>

        public override List<DebugItem> GetDebugInputs(IExecutionEnvironment env, int update) => _debugInputs;

        public override List<DebugItem> GetDebugOutputs(IExecutionEnvironment env, int update)
        {
            foreach(IDebugItem debugOutput in _debugOutputs)
            {
                debugOutput.FlushStringBuilder();
            }
            return _debugOutputs;
        }

        #endregion

        #region Private Methods

        void InsertToCollection(IEnumerable<string> listToAdd, ModelItem modelItem)
        {
            var modelProperty = modelItem.Properties["SystemInformationCollection"];
            if (modelProperty != null)
            {
                var mic = modelProperty.Collection;

                if (mic != null)
                {
                    var listOfValidRows = SystemInformationCollection.Where(c => !c.CanRemove()).ToList();
                    if (listOfValidRows.Count > 0)
                    {
                        var gatherSystemInformationTo = SystemInformationCollection.Last(c => !c.CanRemove());
                        var startIndex = SystemInformationCollection.IndexOf(gatherSystemInformationTo) + 1;
                        startIndex = InsertAllItems(listToAdd, mic, startIndex);
                        CleanUpCollection(mic, modelItem, startIndex);
                    }
                    else
                    {
                        AddToCollection(listToAdd, modelItem);
                    }
                }
            }
        }

        private int InsertAllItems(IEnumerable<string> listToAdd, ModelItemCollection mic, int startIndex)
        {
            foreach (string s in listToAdd)
            {
                mic.Insert(startIndex, new GatherSystemInformationTO(SystemInformationCollection[startIndex - 1].EnTypeOfSystemInformation, s, startIndex + 1));
                startIndex++;
            }

            return startIndex;
        }

        void AddToCollection(IEnumerable<string> listToAdd, ModelItem modelItem)
        {
            var modelProperty = modelItem.Properties["SystemInformationCollection"];
            if (modelProperty != null)
            {
                var mic = modelProperty.Collection;

                if (mic != null)
                {
                    var startIndex = 0;
                    const enTypeOfSystemInformationToGather EnTypeOfSystemInformation = enTypeOfSystemInformationToGather.FullDateTime;
                    mic.Clear();
                    foreach (string s in listToAdd)
                    {
                        mic.Add(new GatherSystemInformationTO(EnTypeOfSystemInformation, s, startIndex + 1));
                        startIndex++;
                    }
                    CleanUpCollection(mic, modelItem, startIndex);
                }
            }
        }

        void CleanUpCollection(ModelItemCollection mic, ModelItem modelItem, int startIndex)
        {
            if (startIndex < mic.Count)
            {
                mic.RemoveAt(startIndex);
            }
            mic.Add(new GatherSystemInformationTO(enTypeOfSystemInformationToGather.FullDateTime, string.Empty, startIndex + 1));
            var modelProperty = modelItem.Properties["DisplayName"];
            modelProperty?.SetValue(CreateDisplayName(modelItem, startIndex + 1));
        }

        string CreateDisplayName(ModelItem modelItem, int count)
        {
            var modelProperty = modelItem.Properties["DisplayName"];
            if (modelProperty != null)
            {
                if (modelProperty.ComputedValue is string currentName && currentName.Contains("(") && currentName.Contains(")"))
                {
                    currentName = currentName.Remove(currentName.Contains(" (") ? currentName.IndexOf(" (", StringComparison.Ordinal) : currentName.IndexOf("(", StringComparison.Ordinal));
                }
                currentName = currentName + " (" + (count - 1) + ")";
                return currentName;
            }

            return string.Empty;
        }

        #endregion

        #endregion

        #region Implementation of ICollectionActivity

        public int GetCollectionCount() => SystemInformationCollection.Count(caseConvertTo => !caseConvertTo.CanRemove());

        public void AddListToCollection(IList<string> listToAdd, bool overwrite, ModelItem modelItem)
        {
            if(!overwrite)
            {
                InsertToCollection(listToAdd, modelItem);
            }
            else
            {
                AddToCollection(listToAdd, modelItem);
            }
        }

        #endregion

        public bool Equals(DsfGatherSystemInformationActivity other)
        {
            if (ReferenceEquals(null, other))
            {
                return false;
            }

            if (ReferenceEquals(this, other))
            {
                return true;
            }

            return base.Equals(other)
                && CommonEqualityOps.CollectionEquals(SystemInformationCollection, other.SystemInformationCollection, new GatherSystemInformationTOComparer());
        }

        public override bool Equals(object obj)
        {
            if (ReferenceEquals(null, obj))
            {
                return false;
            }

            if (ReferenceEquals(this, obj))
            {
                return true;
            }

            if (obj.GetType() != this.GetType())
            {
                return false;
            }

            return Equals((DsfGatherSystemInformationActivity) obj);
        }

        public override int GetHashCode()
        {
            unchecked
            {
                var hashCode = base.GetHashCode();
                hashCode = (hashCode * 397) ^ (SystemInformationCollection != null ? SystemInformationCollection.GetHashCode() : 0);
                return hashCode;
            }
        }
    }


}

---- Semantic diagnostics *before* transformation ----

---- Semantic diagnostics *after* transformation ----
D:\a\1\s\Dev\Dev2.Activities\Activities\DsfGatherSystemInformationActivity.cs(452,31): error CS0165: Use of unassigned local variable 'currentName'
######################################################################


######################################################################
Nr: 8 - UsePatternMatchingRewriterR8
Filepath: D:\a\1\s\Dev\Dev2.Activities\Activities\DsfXPathActivity.cs
Description: Error: The created Syntax Tree is semantically incorrect.
------------------------------------------------------------------------
---- Original Tree ----
using System;
using System.Activities;
using System.Activities.Presentation.Model;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using Dev2.Activities.Debug;
using Dev2.Common.Interfaces.Diagnostics.Debug;
using Dev2.Common.Interfaces.Toolbox;
using Dev2.Common.State;
using Dev2.Data;
using Dev2.Data.Parsers;
using Dev2.Data.TO;
using Dev2.Data.Util;
using Dev2.Diagnostics;
using Dev2.Interfaces;
using Dev2.Utilities;
using Unlimited.Applications.BusinessDesignStudio.Activities;
using Warewolf.Core;
using Warewolf.Storage;
using Warewolf.Storage.Interfaces;

namespace Dev2.Activities
{
    [ToolDescriptorInfo("Utility-Path", "XPath", ToolType.Native, "8999E59A-38A3-43BB-A98F-6090C5C9EA1E", "Dev2.Activities", "1.0.0.0", "Legacy", "Utility", "/Warewolf.Studio.Themes.Luna;component/Images.xaml", "Tool_Utility_Xpath")]
    public class DsfXPathActivity : DsfActivityAbstract<string>, ICollectionActivity,IEquatable<DsfXPathActivity>
    {
        #region Fields

        IList<XPathDTO> _resultsCollection;
        string _sourceString;
        bool _isDebugMode;

        #endregion

        #region Properties

        public IList<XPathDTO> ResultsCollection
        {
            get
            {
                return _resultsCollection;
            }
            set
            {
                _resultsCollection = value;
                OnPropertyChanged("ResultsCollection");
            }
        }

        public string SourceString
        {
            get
            {
                return _sourceString;
            }
            set
            {
                _sourceString = value;
                OnPropertyChanged("SourceString");
            }
        }

        protected override bool CanInduceIdle => true;

        #endregion

        #region Ctor

        public DsfXPathActivity()
            : base("XPath")
        {
            ResultsCollection = new List<XPathDTO>();
        }


        public override IEnumerable<StateVariable> GetState()
        {
            return new[] {
                new StateVariable
                {
                    Name = "SourceString",
                    Value = SourceString,
                    Type = StateVariable.StateType.Input
                },
                new StateVariable
                {
                    Name="ResultsCollection",
                    Value = ActivityHelper.GetSerializedStateValueFromCollection(ResultsCollection),
                    Type = StateVariable.StateType.Output
                }
            };
        }


        #endregion

        public override List<string> GetOutputs() => ResultsCollection?.Select(dto => dto.OutputVariable).ToList() ?? new List<string>();

        #region Overridden NativeActivity Methods

        protected override void OnExecute(NativeActivityContext context)
        {
            var dataObject = context.GetExtension<IDSFDataObject>();

            ExecuteTool(dataObject, 0);
        }

        protected override void ExecuteTool(IDSFDataObject dataObject, int update)
        {
            _debugOutputs.Clear();

            _isDebugMode = dataObject.IsDebugMode();
            var errors = new ErrorResultTO();
            var allErrors = new ErrorResultTO();
            var parser = new XPathParser();
            var i = 0;

            InitializeDebug(dataObject);
            try
            {
                if (!string.IsNullOrEmpty(SourceString))
                {
                    if (_isDebugMode)
                    {
                        AddSourceStringDebugInputItem(SourceString, dataObject.Environment, update);
                        AddResultDebugInputs(ResultsCollection, out errors);
                        allErrors.MergeErrors(errors);
                    }
                    if (!allErrors.HasErrors())
                    {
                        i = Process(dataObject, update, i, parser, allErrors, errors);
                    }
                    DoDebug(dataObject, update, allErrors);
                }
            }
            catch(Exception ex)
            {
                allErrors.AddError(ex.Message);
            }
            finally
            {
                var actualIndex = i - 1;
                var hasErrors = allErrors.HasErrors();
                ProcessErrors(dataObject, update, hasErrors, allErrors, actualIndex);

                DispatchDebugState(dataObject, StateType.Before, update);
                DispatchDebugState(dataObject, StateType.After, update);
            }
        }

        void ProcessErrors(IDSFDataObject dataObject, int update, bool hasErrors, ErrorResultTO allErrors, int actualIndex)
        {
            if (hasErrors)
            {
                DisplayAndWriteError("DsfXPathActivity", allErrors);
                var errorString = allErrors.MakeDataListReady();
                dataObject.Environment.AddError(errorString);
                if (actualIndex > -1)
                {
                    dataObject.Environment.Assign(ResultsCollection[actualIndex].OutputVariable, null, update);
                }
                if (_isDebugMode)
                {
                    var itemToAdd = new DebugItem();
                    if (actualIndex < 0)
                    {
                        actualIndex = 0;
                    }
                    AddDebugItem(new DebugItemStaticDataParams("", (actualIndex + 1).ToString(CultureInfo.InvariantCulture)), itemToAdd);

                    var outputVariable = "";
                    if (actualIndex >= 0)
                    {
                        outputVariable = ResultsCollection[actualIndex].OutputVariable;
                    }
                    AddDebugItem(new DebugEvalResult(outputVariable, "", dataObject.Environment, update), itemToAdd);
                    _debugOutputs.Add(itemToAdd);

                }
            }

        }

        void DoDebug(IDSFDataObject dataObject, int update, ErrorResultTO allErrors)
        {
            if (_isDebugMode && !allErrors.HasErrors())
            {
                var innerCount = 1;
                foreach (var debugOutputTo in ResultsCollection)
                {
                    if (!string.IsNullOrEmpty(debugOutputTo.OutputVariable))
                    {
                        var itemToAdd = new DebugItem();
                        AddDebugItem(new DebugItemStaticDataParams("", innerCount.ToString(CultureInfo.InvariantCulture)), itemToAdd);
                        AddDebugItem(new DebugEvalResult(DataListUtil.ReplaceRecordsetBlankWithStar(debugOutputTo.OutputVariable), "", dataObject.Environment, update), itemToAdd);
                        _debugOutputs.Add(itemToAdd);
                        innerCount++;
                    }
                }
            }
        }

        int Process(IDSFDataObject dataObject, int update, int i, XPathParser parser, ErrorResultTO allErrors, ErrorResultTO errors)
        {
            if (!string.IsNullOrEmpty(SourceString))
            {
                var itr = new WarewolfListIterator();
                var sourceIterator = new WarewolfIterator(dataObject.Environment.Eval(SourceString, update));
                itr.AddVariableToIterateOn(sourceIterator);
                while (itr.HasMoreData())
                {
                    var c = itr.FetchNextValue(sourceIterator);
                    i = ProcessResultsCollection(dataObject, update, parser, allErrors, c);
                    allErrors.MergeErrors(errors);
                }
            }
            return i;
        }

        int ProcessResultsCollection(IDSFDataObject dataObject, int update, XPathParser parser, ErrorResultTO allErrors, string c)
        {
            int i;
            for (i = 0; i < ResultsCollection.Count; i++)
            {
                if (!string.IsNullOrEmpty(ResultsCollection[i].OutputVariable))
                {
                    IterateOverXPath(dataObject, update, parser, allErrors, c, i);
                }
            }

            return i;
        }

        void IterateOverXPath(IDSFDataObject dataObject, int update, XPathParser parser, ErrorResultTO allErrors, string c, int i)
        {
            var xpathEntry = dataObject.Environment.Eval(ResultsCollection[i].XPath, update);
            var xpathIterator = new WarewolfIterator(xpathEntry);
            while (xpathIterator.HasMoreData())
            {
                var xpathCol = xpathIterator.GetNextValue();
                try
                {
                    var eval = parser.ExecuteXPath(c, xpathCol).ToList();
                    var variable = ResultsCollection[i].OutputVariable;
                    AssignResult(variable, dataObject, eval, update);
                }
                catch (Exception e)
                {
                    allErrors.AddError(e.Message);
                    dataObject.Environment.Assign(ResultsCollection[i].OutputVariable, null, update);
                }
            }
        }

        void AssignResult(string variable, IDSFDataObject dataObject, IEnumerable<string> eval, int update)
        {
            var index = 1;
            if(DataListUtil.IsValueScalar(variable))
            {
                var values = eval as IList<string> ?? eval.ToList();
                dataObject.Environment.Assign(variable, values.LastOrDefault(), update);
            }
            else
            {
                
                foreach(var val in eval)
                {
                    var correctedVariable = variable;
                    if(DataListUtil.IsValueRecordset(variable) && DataListUtil.IsStarIndex(variable) && update==0)
                    {
                        correctedVariable = DataListUtil.ReplaceStarWithFixedIndex(variable, index);
                    }
                    dataObject.Environment.Assign(correctedVariable, val, update);
                    index++;
                }
            }
        }

        void AddResultDebugInputs(IEnumerable<XPathDTO> resultsCollection, out ErrorResultTO errors)
        {
            errors = new ErrorResultTO();
            var i = 1;
            foreach(var xPathDto in resultsCollection)
            {
                if (!String.IsNullOrEmpty(xPathDto.OutputVariable) && _isDebugMode)
                {
                    var itemToAdd = new DebugItem();
                    AddDebugItem(new DebugItemStaticDataParams("", i.ToString(CultureInfo.InvariantCulture)), itemToAdd);
                    AddDebugItem(new DebugItemWarewolfAtomResult(xPathDto.XPath, xPathDto.OutputVariable, ""), itemToAdd);
                    _debugInputs.Add(itemToAdd);
                    i++;
                }

            }
        }

        void AddSourceStringDebugInputItem(string expression, IExecutionEnvironment environment, int update)
        {
            AddDebugInputItem(new DebugEvalResult(expression, "XML", environment, update));
        }

        public override enFindMissingType GetFindMissingType() => enFindMissingType.MixedActivity;

        #endregion

        #region Private Methods
        void InsertToCollection(IEnumerable<string> listToAdd, ModelItem modelItem)
        {
            var modelProperty = modelItem.Properties["ResultsCollection"];
            if(modelProperty == null)
            {
                return;
            }
            var mic = modelProperty.Collection;

            if(mic == null)
            {
                return;
            }
            var listOfValidRows = ResultsCollection.Where(c => !c.CanRemove()).ToList();
            if(listOfValidRows.Count > 0)
            {
                var xPathDto = ResultsCollection.Last(c => !c.CanRemove());
                var startIndex = ResultsCollection.IndexOf(xPathDto) + 1;
                foreach(var s in listToAdd)
                {
                    mic.Insert(startIndex, new XPathDTO(s, ResultsCollection[startIndex - 1].XPath, startIndex + 1));
                    startIndex++;
                }
                CleanUpCollection(mic, modelItem, startIndex);
            }
            else
            {
                AddToCollection(listToAdd, modelItem);
            }
        }

        void AddToCollection(IEnumerable<string> listToAdd, ModelItem modelItem)
        {
            var modelProperty = modelItem.Properties["ResultsCollection"];
            if(modelProperty == null)
            {
                return;
            }
            var mic = modelProperty.Collection;

            if(mic == null)
            {
                return;
            }
            var startIndex = 0;
            var firstRowXPath = ResultsCollection[0].XPath;
            mic.Clear();
            foreach(var s in listToAdd)
            {
                mic.Add(new XPathDTO(s, firstRowXPath, startIndex + 1));
                startIndex++;
            }
            CleanUpCollection(mic, modelItem, startIndex);
        }

        void CleanUpCollection(ModelItemCollection mic, ModelItem modelItem, int startIndex)
        {
            if(startIndex < mic.Count)
            {
                mic.RemoveAt(startIndex);
            }
            mic.Add(new XPathDTO(string.Empty, "", startIndex + 1));
            var modelProperty = modelItem.Properties["DisplayName"];
            modelProperty?.SetValue(CreateDisplayName(modelItem, startIndex + 1));
        }

        string CreateDisplayName(ModelItem modelItem, int count)
        {
            var modelProperty = modelItem.Properties["DisplayName"];
            if(modelProperty == null)
            {
                return "";
            }
            var currentName = modelProperty.ComputedValue as string;
            if (currentName != null && currentName.Contains("(") && currentName.Contains(")"))
            {
                currentName = currentName.Remove(currentName.Contains(" (") ? currentName.IndexOf(" (", StringComparison.Ordinal) : currentName.IndexOf("(", StringComparison.Ordinal));
            }
            currentName = currentName + " (" + (count - 1) + ")";
            return currentName;
        }

        #endregion Private Methods

        #region Get Debug Inputs/Outputs

        #region GetDebugInputs

        public override List<DebugItem> GetDebugInputs(IExecutionEnvironment env, int update)
        {
            foreach(IDebugItem debugInput in _debugInputs)
            {
                debugInput.FlushStringBuilder();
            }
            return _debugInputs;
        }

        #endregion

        #region GetDebugOutputs

        public override List<DebugItem> GetDebugOutputs(IExecutionEnvironment env, int update)
        {
            foreach(IDebugItem debugOutput in _debugOutputs)
            {
                debugOutput.FlushStringBuilder();
            }
            return _debugOutputs;
        }

        #endregion

        #endregion

        #region Get ForEach Inputs/Ouputs

        public override void UpdateForEachInputs(IList<Tuple<string, string>> updates)
        {
            if(updates != null)
            {
                foreach(Tuple<string, string> t in updates)
                {
                    // locate all updates for this tuple
                    var t1 = t;
                    var items = ResultsCollection.Where(c => !string.IsNullOrEmpty(c.XPath) && c.XPath.Equals(t1.Item1));

                    // issues updates
                    foreach(var a in items)
                    {
                        a.XPath = t.Item2;
                    }

                    if(SourceString == t.Item1)
                    {
                        SourceString = t.Item2;
                    }
                }
            }
        }

        public override void UpdateForEachOutputs(IList<Tuple<string, string>> updates)
        {
            if(updates != null)
            {
                foreach(Tuple<string, string> t in updates)
                {
                    // locate all updates for this tuple
                    var t1 = t;
                    var items = ResultsCollection.Where(c => !string.IsNullOrEmpty(c.OutputVariable) && c.OutputVariable.Equals(t1.Item1));

                    // issues updates
                    foreach(var a in items)
                    {
                        a.OutputVariable = t.Item2;
                    }
                }
            }
        }

        #endregion

        #region GetForEachInputs/Outputs

        public override IList<DsfForEachItem> GetForEachInputs()
        {
            var items = new[] { SourceString }.Union(ResultsCollection.Where(c => !string.IsNullOrEmpty(c.XPath)).Select(c => c.XPath)).ToArray();
            return GetForEachItems(items);
        }

        public override IList<DsfForEachItem> GetForEachOutputs()
        {
            var items = ResultsCollection.Where(c => !string.IsNullOrEmpty(c.OutputVariable)).Select(c => c.OutputVariable).ToArray();
            return GetForEachItems(items);
        }

        #endregion

        #region Implementation of ICollectionActivity

        public int GetCollectionCount() => ResultsCollection.Count(xPathDto => !xPathDto.CanRemove());

        public void AddListToCollection(IList<string> listToAdd, bool overwrite, ModelItem modelItem)
        {
            if(!overwrite)
            {
                InsertToCollection(listToAdd, modelItem);
            }
            else
            {
                AddToCollection(listToAdd, modelItem);
            }
        }

        #endregion

        public bool Equals(DsfXPathActivity other)
        {
            if (ReferenceEquals(null, other))
            {
                return false;
            }

            if (ReferenceEquals(this, other))
            {
                return true;
            }

            return base.Equals(other)
                && ResultsCollection.SequenceEqual(other.ResultsCollection)
                && string.Equals(SourceString, other.SourceString) ;
        }

        public override bool Equals(object obj)
        {
            if (ReferenceEquals(null, obj))
            {
                return false;
            }

            if (ReferenceEquals(this, obj))
            {
                return true;
            }

            if (obj.GetType() != this.GetType())
            {
                return false;
            }

            return Equals((DsfXPathActivity) obj);
        }

        public override int GetHashCode()
        {
            unchecked
            {
                var hashCode = base.GetHashCode();
                hashCode = (hashCode * 397) ^ (ResultsCollection != null ? ResultsCollection.GetHashCode() : 0);
                hashCode = (hashCode * 397) ^ (SourceString != null ? SourceString.GetHashCode() : 0);
                hashCode = (hashCode * 397) ^ _isDebugMode.GetHashCode();
                return hashCode;
            }
        }
    }
}

---- Transformed Tree ----
using System;
using System.Activities;
using System.Activities.Presentation.Model;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using Dev2.Activities.Debug;
using Dev2.Common.Interfaces.Diagnostics.Debug;
using Dev2.Common.Interfaces.Toolbox;
using Dev2.Common.State;
using Dev2.Data;
using Dev2.Data.Parsers;
using Dev2.Data.TO;
using Dev2.Data.Util;
using Dev2.Diagnostics;
using Dev2.Interfaces;
using Dev2.Utilities;
using Unlimited.Applications.BusinessDesignStudio.Activities;
using Warewolf.Core;
using Warewolf.Storage;
using Warewolf.Storage.Interfaces;

namespace Dev2.Activities
{
    [ToolDescriptorInfo("Utility-Path", "XPath", ToolType.Native, "8999E59A-38A3-43BB-A98F-6090C5C9EA1E", "Dev2.Activities", "1.0.0.0", "Legacy", "Utility", "/Warewolf.Studio.Themes.Luna;component/Images.xaml", "Tool_Utility_Xpath")]
    public class DsfXPathActivity : DsfActivityAbstract<string>, ICollectionActivity,IEquatable<DsfXPathActivity>
    {
        #region Fields

        IList<XPathDTO> _resultsCollection;
        string _sourceString;
        bool _isDebugMode;

        #endregion

        #region Properties

        public IList<XPathDTO> ResultsCollection
        {
            get
            {
                return _resultsCollection;
            }
            set
            {
                _resultsCollection = value;
                OnPropertyChanged("ResultsCollection");
            }
        }

        public string SourceString
        {
            get
            {
                return _sourceString;
            }
            set
            {
                _sourceString = value;
                OnPropertyChanged("SourceString");
            }
        }

        protected override bool CanInduceIdle => true;

        #endregion

        #region Ctor

        public DsfXPathActivity()
            : base("XPath")
        {
            ResultsCollection = new List<XPathDTO>();
        }


        public override IEnumerable<StateVariable> GetState()
        {
            return new[] {
                new StateVariable
                {
                    Name = "SourceString",
                    Value = SourceString,
                    Type = StateVariable.StateType.Input
                },
                new StateVariable
                {
                    Name="ResultsCollection",
                    Value = ActivityHelper.GetSerializedStateValueFromCollection(ResultsCollection),
                    Type = StateVariable.StateType.Output
                }
            };
        }


        #endregion

        public override List<string> GetOutputs() => ResultsCollection?.Select(dto => dto.OutputVariable).ToList() ?? new List<string>();

        #region Overridden NativeActivity Methods

        protected override void OnExecute(NativeActivityContext context)
        {
            var dataObject = context.GetExtension<IDSFDataObject>();

            ExecuteTool(dataObject, 0);
        }

        protected override void ExecuteTool(IDSFDataObject dataObject, int update)
        {
            _debugOutputs.Clear();

            _isDebugMode = dataObject.IsDebugMode();
            var errors = new ErrorResultTO();
            var allErrors = new ErrorResultTO();
            var parser = new XPathParser();
            var i = 0;

            InitializeDebug(dataObject);
            try
            {
                if (!string.IsNullOrEmpty(SourceString))
                {
                    if (_isDebugMode)
                    {
                        AddSourceStringDebugInputItem(SourceString, dataObject.Environment, update);
                        AddResultDebugInputs(ResultsCollection, out errors);
                        allErrors.MergeErrors(errors);
                    }
                    if (!allErrors.HasErrors())
                    {
                        i = Process(dataObject, update, i, parser, allErrors, errors);
                    }
                    DoDebug(dataObject, update, allErrors);
                }
            }
            catch(Exception ex)
            {
                allErrors.AddError(ex.Message);
            }
            finally
            {
                var actualIndex = i - 1;
                var hasErrors = allErrors.HasErrors();
                ProcessErrors(dataObject, update, hasErrors, allErrors, actualIndex);

                DispatchDebugState(dataObject, StateType.Before, update);
                DispatchDebugState(dataObject, StateType.After, update);
            }
        }

        void ProcessErrors(IDSFDataObject dataObject, int update, bool hasErrors, ErrorResultTO allErrors, int actualIndex)
        {
            if (hasErrors)
            {
                DisplayAndWriteError("DsfXPathActivity", allErrors);
                var errorString = allErrors.MakeDataListReady();
                dataObject.Environment.AddError(errorString);
                if (actualIndex > -1)
                {
                    dataObject.Environment.Assign(ResultsCollection[actualIndex].OutputVariable, null, update);
                }
                if (_isDebugMode)
                {
                    var itemToAdd = new DebugItem();
                    if (actualIndex < 0)
                    {
                        actualIndex = 0;
                    }
                    AddDebugItem(new DebugItemStaticDataParams("", (actualIndex + 1).ToString(CultureInfo.InvariantCulture)), itemToAdd);

                    var outputVariable = "";
                    if (actualIndex >= 0)
                    {
                        outputVariable = ResultsCollection[actualIndex].OutputVariable;
                    }
                    AddDebugItem(new DebugEvalResult(outputVariable, "", dataObject.Environment, update), itemToAdd);
                    _debugOutputs.Add(itemToAdd);

                }
            }

        }

        void DoDebug(IDSFDataObject dataObject, int update, ErrorResultTO allErrors)
        {
            if (_isDebugMode && !allErrors.HasErrors())
            {
                var innerCount = 1;
                foreach (var debugOutputTo in ResultsCollection)
                {
                    if (!string.IsNullOrEmpty(debugOutputTo.OutputVariable))
                    {
                        var itemToAdd = new DebugItem();
                        AddDebugItem(new DebugItemStaticDataParams("", innerCount.ToString(CultureInfo.InvariantCulture)), itemToAdd);
                        AddDebugItem(new DebugEvalResult(DataListUtil.ReplaceRecordsetBlankWithStar(debugOutputTo.OutputVariable), "", dataObject.Environment, update), itemToAdd);
                        _debugOutputs.Add(itemToAdd);
                        innerCount++;
                    }
                }
            }
        }

        int Process(IDSFDataObject dataObject, int update, int i, XPathParser parser, ErrorResultTO allErrors, ErrorResultTO errors)
        {
            if (!string.IsNullOrEmpty(SourceString))
            {
                var itr = new WarewolfListIterator();
                var sourceIterator = new WarewolfIterator(dataObject.Environment.Eval(SourceString, update));
                itr.AddVariableToIterateOn(sourceIterator);
                while (itr.HasMoreData())
                {
                    var c = itr.FetchNextValue(sourceIterator);
                    i = ProcessResultsCollection(dataObject, update, parser, allErrors, c);
                    allErrors.MergeErrors(errors);
                }
            }
            return i;
        }

        int ProcessResultsCollection(IDSFDataObject dataObject, int update, XPathParser parser, ErrorResultTO allErrors, string c)
        {
            int i;
            for (i = 0; i < ResultsCollection.Count; i++)
            {
                if (!string.IsNullOrEmpty(ResultsCollection[i].OutputVariable))
                {
                    IterateOverXPath(dataObject, update, parser, allErrors, c, i);
                }
            }

            return i;
        }

        void IterateOverXPath(IDSFDataObject dataObject, int update, XPathParser parser, ErrorResultTO allErrors, string c, int i)
        {
            var xpathEntry = dataObject.Environment.Eval(ResultsCollection[i].XPath, update);
            var xpathIterator = new WarewolfIterator(xpathEntry);
            while (xpathIterator.HasMoreData())
            {
                var xpathCol = xpathIterator.GetNextValue();
                try
                {
                    var eval = parser.ExecuteXPath(c, xpathCol).ToList();
                    var variable = ResultsCollection[i].OutputVariable;
                    AssignResult(variable, dataObject, eval, update);
                }
                catch (Exception e)
                {
                    allErrors.AddError(e.Message);
                    dataObject.Environment.Assign(ResultsCollection[i].OutputVariable, null, update);
                }
            }
        }

        void AssignResult(string variable, IDSFDataObject dataObject, IEnumerable<string> eval, int update)
        {
            var index = 1;
            if(DataListUtil.IsValueScalar(variable))
            {
                var values = eval as IList<string> ?? eval.ToList();
                dataObject.Environment.Assign(variable, values.LastOrDefault(), update);
            }
            else
            {
                
                foreach(var val in eval)
                {
                    var correctedVariable = variable;
                    if(DataListUtil.IsValueRecordset(variable) && DataListUtil.IsStarIndex(variable) && update==0)
                    {
                        correctedVariable = DataListUtil.ReplaceStarWithFixedIndex(variable, index);
                    }
                    dataObject.Environment.Assign(correctedVariable, val, update);
                    index++;
                }
            }
        }

        void AddResultDebugInputs(IEnumerable<XPathDTO> resultsCollection, out ErrorResultTO errors)
        {
            errors = new ErrorResultTO();
            var i = 1;
            foreach(var xPathDto in resultsCollection)
            {
                if (!String.IsNullOrEmpty(xPathDto.OutputVariable) && _isDebugMode)
                {
                    var itemToAdd = new DebugItem();
                    AddDebugItem(new DebugItemStaticDataParams("", i.ToString(CultureInfo.InvariantCulture)), itemToAdd);
                    AddDebugItem(new DebugItemWarewolfAtomResult(xPathDto.XPath, xPathDto.OutputVariable, ""), itemToAdd);
                    _debugInputs.Add(itemToAdd);
                    i++;
                }

            }
        }

        void AddSourceStringDebugInputItem(string expression, IExecutionEnvironment environment, int update)
        {
            AddDebugInputItem(new DebugEvalResult(expression, "XML", environment, update));
        }

        public override enFindMissingType GetFindMissingType() => enFindMissingType.MixedActivity;

        #endregion

        #region Private Methods
        void InsertToCollection(IEnumerable<string> listToAdd, ModelItem modelItem)
        {
            var modelProperty = modelItem.Properties["ResultsCollection"];
            if(modelProperty == null)
            {
                return;
            }
            var mic = modelProperty.Collection;

            if(mic == null)
            {
                return;
            }
            var listOfValidRows = ResultsCollection.Where(c => !c.CanRemove()).ToList();
            if(listOfValidRows.Count > 0)
            {
                var xPathDto = ResultsCollection.Last(c => !c.CanRemove());
                var startIndex = ResultsCollection.IndexOf(xPathDto) + 1;
                foreach(var s in listToAdd)
                {
                    mic.Insert(startIndex, new XPathDTO(s, ResultsCollection[startIndex - 1].XPath, startIndex + 1));
                    startIndex++;
                }
                CleanUpCollection(mic, modelItem, startIndex);
            }
            else
            {
                AddToCollection(listToAdd, modelItem);
            }
        }

        void AddToCollection(IEnumerable<string> listToAdd, ModelItem modelItem)
        {
            var modelProperty = modelItem.Properties["ResultsCollection"];
            if(modelProperty == null)
            {
                return;
            }
            var mic = modelProperty.Collection;

            if(mic == null)
            {
                return;
            }
            var startIndex = 0;
            var firstRowXPath = ResultsCollection[0].XPath;
            mic.Clear();
            foreach(var s in listToAdd)
            {
                mic.Add(new XPathDTO(s, firstRowXPath, startIndex + 1));
                startIndex++;
            }
            CleanUpCollection(mic, modelItem, startIndex);
        }

        void CleanUpCollection(ModelItemCollection mic, ModelItem modelItem, int startIndex)
        {
            if(startIndex < mic.Count)
            {
                mic.RemoveAt(startIndex);
            }
            mic.Add(new XPathDTO(string.Empty, "", startIndex + 1));
            var modelProperty = modelItem.Properties["DisplayName"];
            modelProperty?.SetValue(CreateDisplayName(modelItem, startIndex + 1));
        }

        string CreateDisplayName(ModelItem modelItem, int count)
        {
            var modelProperty = modelItem.Properties["DisplayName"];
            if(modelProperty == null)
            {
                return "";
            }
            if (modelProperty.ComputedValue is string currentName && currentName.Contains("(") && currentName.Contains(")"))
            {
                currentName = currentName.Remove(currentName.Contains(" (") ? currentName.IndexOf(" (", StringComparison.Ordinal) : currentName.IndexOf("(", StringComparison.Ordinal));
            }
            currentName = currentName + " (" + (count - 1) + ")";
            return currentName;
        }

        #endregion Private Methods

        #region Get Debug Inputs/Outputs

        #region GetDebugInputs

        public override List<DebugItem> GetDebugInputs(IExecutionEnvironment env, int update)
        {
            foreach(IDebugItem debugInput in _debugInputs)
            {
                debugInput.FlushStringBuilder();
            }
            return _debugInputs;
        }

        #endregion

        #region GetDebugOutputs

        public override List<DebugItem> GetDebugOutputs(IExecutionEnvironment env, int update)
        {
            foreach(IDebugItem debugOutput in _debugOutputs)
            {
                debugOutput.FlushStringBuilder();
            }
            return _debugOutputs;
        }

        #endregion

        #endregion

        #region Get ForEach Inputs/Ouputs

        public override void UpdateForEachInputs(IList<Tuple<string, string>> updates)
        {
            if(updates != null)
            {
                foreach(Tuple<string, string> t in updates)
                {
                    // locate all updates for this tuple
                    var t1 = t;
                    var items = ResultsCollection.Where(c => !string.IsNullOrEmpty(c.XPath) && c.XPath.Equals(t1.Item1));

                    // issues updates
                    foreach(var a in items)
                    {
                        a.XPath = t.Item2;
                    }

                    if(SourceString == t.Item1)
                    {
                        SourceString = t.Item2;
                    }
                }
            }
        }

        public override void UpdateForEachOutputs(IList<Tuple<string, string>> updates)
        {
            if(updates != null)
            {
                foreach(Tuple<string, string> t in updates)
                {
                    // locate all updates for this tuple
                    var t1 = t;
                    var items = ResultsCollection.Where(c => !string.IsNullOrEmpty(c.OutputVariable) && c.OutputVariable.Equals(t1.Item1));

                    // issues updates
                    foreach(var a in items)
                    {
                        a.OutputVariable = t.Item2;
                    }
                }
            }
        }

        #endregion

        #region GetForEachInputs/Outputs

        public override IList<DsfForEachItem> GetForEachInputs()
        {
            var items = new[] { SourceString }.Union(ResultsCollection.Where(c => !string.IsNullOrEmpty(c.XPath)).Select(c => c.XPath)).ToArray();
            return GetForEachItems(items);
        }

        public override IList<DsfForEachItem> GetForEachOutputs()
        {
            var items = ResultsCollection.Where(c => !string.IsNullOrEmpty(c.OutputVariable)).Select(c => c.OutputVariable).ToArray();
            return GetForEachItems(items);
        }

        #endregion

        #region Implementation of ICollectionActivity

        public int GetCollectionCount() => ResultsCollection.Count(xPathDto => !xPathDto.CanRemove());

        public void AddListToCollection(IList<string> listToAdd, bool overwrite, ModelItem modelItem)
        {
            if(!overwrite)
            {
                InsertToCollection(listToAdd, modelItem);
            }
            else
            {
                AddToCollection(listToAdd, modelItem);
            }
        }

        #endregion

        public bool Equals(DsfXPathActivity other)
        {
            if (ReferenceEquals(null, other))
            {
                return false;
            }

            if (ReferenceEquals(this, other))
            {
                return true;
            }

            return base.Equals(other)
                && ResultsCollection.SequenceEqual(other.ResultsCollection)
                && string.Equals(SourceString, other.SourceString) ;
        }

        public override bool Equals(object obj)
        {
            if (ReferenceEquals(null, obj))
            {
                return false;
            }

            if (ReferenceEquals(this, obj))
            {
                return true;
            }

            if (obj.GetType() != this.GetType())
            {
                return false;
            }

            return Equals((DsfXPathActivity) obj);
        }

        public override int GetHashCode()
        {
            unchecked
            {
                var hashCode = base.GetHashCode();
                hashCode = (hashCode * 397) ^ (ResultsCollection != null ? ResultsCollection.GetHashCode() : 0);
                hashCode = (hashCode * 397) ^ (SourceString != null ? SourceString.GetHashCode() : 0);
                hashCode = (hashCode * 397) ^ _isDebugMode.GetHashCode();
                return hashCode;
            }
        }
    }
}

---- Semantic diagnostics *before* transformation ----
D:\a\1\s\Dev\Dev2.Activities\Activities\DsfXPathActivity.cs(220,59): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfXPathActivity.cs(220,42): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfXPathActivity.cs(248,30): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfXPathActivity.cs(249,37): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?)
---- Semantic diagnostics *after* transformation ----
D:\a\1\s\Dev\Dev2.Activities\Activities\DsfXPathActivity.cs(220,59): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfXPathActivity.cs(220,42): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfXPathActivity.cs(248,30): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfXPathActivity.cs(249,37): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Activities\Activities\DsfXPathActivity.cs(396,27): error CS0165: Use of unassigned local variable 'currentName'
######################################################################


######################################################################
Nr: 9 - UsePatternMatchingRewriterR8
Filepath: D:\a\1\s\Dev\Dev2.Core\Converters\Graph\String\Json\JsonNavigator.cs
Description: Error: The created Syntax Tree is semantically incorrect.
------------------------------------------------------------------------
---- Original Tree ----
using System;
using System.Collections;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using Dev2;
using Dev2.Common;
using Dev2.Common.Interfaces.Core.Graph;
using Dev2.Converters.Graph;
using Newtonsoft.Json.Linq;
using Warewolf.Resource.Errors;

namespace Unlimited.Framework.Converters.Graph.String.Json
{
    [Serializable]
    public class JsonNavigator : NavigatorBase, INavigator
    {
        public JsonNavigator(object data) => Data = JToken.Parse(data.ToString());

        #region Methods

        public object SelectScalar(IPath path)
        {
            if (path == null)
            {
                throw new ArgumentNullException("path");
            }

            var jsonPath = path as JsonPath;

            if (jsonPath == null)
            {
                throw new Exception(string.Format(ErrorResource.PathMismatch,
                    typeof (JsonPath), path.GetType()));
            }

            var currentData = Data as JToken;

            if (path.ActualPath == JsonPath.SeperatorSymbol)
            {
                //nothing to do here yet
            }
            else if (path.ActualPath == JsonPath.EnumerableSymbol + JsonPath.SeperatorSymbol)
            {
                var enumerableData = currentData as IEnumerable;
                var enumerator = enumerableData.GetEnumerator();
                enumerator.Reset();
                while (enumerator.MoveNext())
                {
                    currentData = enumerator.Current as JToken;
                }
            }
            else
            {
                var pathSegments = jsonPath.GetSegements().ToList();
                var segmentIndex = 0;

                while (currentData != null && segmentIndex < pathSegments.Count)
                {
                    if (pathSegments[segmentIndex].IsEnumarable)
                    {
                        currentData = GetEnumuratedValueForPathSegment(currentData, pathSegments, segmentIndex);
                    }
                    else
                    {
                        currentData = GetScalarValueForPathSegment(pathSegments[segmentIndex], currentData);
                    }

                    segmentIndex++;
                }
            }

            var returnVal = "";

            if (currentData != null)
            {
                returnVal = currentData.ToString();
            }

            return returnVal;
        }

        private JToken GetEnumuratedValueForPathSegment(JToken currentData, List<IPathSegment> pathSegments, int segmentIndex)
        {
            var enumerableData = GetEnumerableValueForPathSegment(pathSegments[segmentIndex],
                                        currentData);

            if (enumerableData != null)
            {
                var enumerator = enumerableData.GetEnumerator();
                enumerator.Reset();
                while (enumerator.MoveNext())
                {
                    currentData = enumerator.Current as JToken;
                }
            }

            return currentData;
        }

        public IEnumerable<object> SelectEnumerable(IPath path)
        {
            if (path == null)
            {
                throw new ArgumentNullException("path");
            }

            var jsonPath = path as JsonPath;

            if (jsonPath == null)
            {
                throw new Exception(string.Format(ErrorResource.DataTypeMismatch,
                    typeof (JsonPath), path.GetType()));
            }

            List<object> returnData;

            if (path.ActualPath == JsonPath.SeperatorSymbol)
            {
                returnData = new List<object> {Data};
            }
            else if (path.ActualPath == JsonPath.EnumerableSymbol + JsonPath.SeperatorSymbol)
            {
                var enumerableData = Data as IEnumerable;
                returnData = new List<object>();

                if (enumerableData != null)
                {
                    var enumerator = enumerableData.GetEnumerator();
                    enumerator.Reset();
                    while (enumerator.MoveNext())
                    {
                        returnData.Add(enumerator.Current);
                    }
                }
            }
            else
            {
                returnData =
                    new List<object>(
                        SelectEnumberable(jsonPath.GetSegements().ToList(), Data as JToken).Select(o => o.ToString()));
            }

            return returnData;
        }

        public Dictionary<IPath, IList<object>> SelectEnumerablesAsRelated(IList<IPath> paths)
        {
            //
            // Get valid paths
            //
            IList<IPath> validPaths = new List<IPath>(paths.OfType<JsonPath>().ToList());

            //
            // Setup results structure
            //
            var results = new Dictionary<IPath, IList<object>>();
            BuildResultsStructure(validPaths, results);

            if (validPaths.Count == 1 && validPaths[0].ActualPath == JsonPath.SeperatorSymbol)
            {
                results[validPaths[0]].Add(Data);
            }
            else if (validPaths.Count == 1 &&
                     validPaths[0].ActualPath == JsonPath.EnumerableSymbol + JsonPath.SeperatorSymbol)
            {

                if (Data is IEnumerable enumerableData)
                {
                    var enumerator = enumerableData.GetEnumerator();
                    enumerator.Reset();
                    while (enumerator.MoveNext())
                    {
                        results[validPaths[0]].Add(enumerator.Current);
                    }
                }
            }
            else
            {
                CreateRootNode(validPaths, results);
            }
            return results;
        }

        public void Dispose()
        {
            Data = null;
        }

        #endregion Methods

        #region Private Methods

        IEnumerable<object> SelectEnumberable(IList<IPathSegment> pathSegments, JToken data)
        {
            var returnData = new List<object>();
            var currentData = data;

            for (int i = 0; i < pathSegments.Count; i++)
            {
                var pathSegment = pathSegments[i];
                var lastSegment = i == pathSegments.Count - 1;

                if (pathSegment.IsEnumarable)
                {
                    var enumerableData = GetEnumerableValueForPathSegment(pathSegment, currentData);

                    if (enumerableData != null)
                    {
                        GetEnumerableValueForSegment(pathSegments, returnData, currentData, i, enumerableData);
                    }

                    return returnData;
                }

                currentData = GetScalarValueForPathSegment(pathSegment, currentData);

                if (currentData != null && lastSegment)
                {
                    returnData.Add(currentData.ToString());
                }
            }

            return returnData;
        }

        void GetEnumerableValueForSegment(IList<IPathSegment> pathSegments, List<object> returnData, JToken currentData, int i, IEnumerable enumerableData)
        {
            var enumerator = enumerableData.GetEnumerator();
            enumerator.Reset();

            var testToken = enumerableData as JToken;

            if (testToken.IsEnumerableOfPrimitives())
            {
                while (enumerator.MoveNext())
                {
                    var currentToken = enumerator.Current as JToken;
                    if (currentData != null && currentToken != null)
                    {
                        returnData.Add(currentToken.ToString());
                    }

                }
            }
            else
            {
                while (enumerator.MoveNext())
                {
                    returnData.AddRange(SelectEnumberable(pathSegments.Skip(i + 1).ToList(),
                        enumerator.Current as JToken));
                }
            }
        }

        protected override IndexedPathSegmentTreeNode<string> CreatePathSegmentIndexedPathSegmentTreeNode(
            IPathSegment pathSegment, IndexedPathSegmentTreeNode<string> parentNode)
        {
            var newIndexedValueTreeNode = new IndexedPathSegmentTreeNode<string>();

            if (parentNode.EnumerationComplete)
            {
                newIndexedValueTreeNode.CurrentValue = string.Empty;
                newIndexedValueTreeNode.EnumerationComplete = true;
            }
            else
            {
                if (pathSegment.IsEnumarable)
                {
                    GetEnumerableValueForPathSegment(pathSegment, parentNode, newIndexedValueTreeNode);
                }
                else
                {
                    newIndexedValueTreeNode.CurrentValue = GetScalarValueForPathSegment(pathSegment,
                        parentNode.CurrentValue as JToken);

                    if (newIndexedValueTreeNode.CurrentValue == null)
                    {
                        newIndexedValueTreeNode.CurrentValue = string.Empty;
                        newIndexedValueTreeNode.EnumerationComplete = true;
                    }
                }
            }

            return newIndexedValueTreeNode;
        }

        private void GetEnumerableValueForPathSegment(IPathSegment pathSegment, IndexedPathSegmentTreeNode<string> parentNode, IndexedPathSegmentTreeNode<string> newIndexedValueTreeNode)
        {
            var data = parentNode.CurrentValue as JToken;
            newIndexedValueTreeNode.EnumerableValue = GetEnumerableValueForPathSegment(pathSegment, data);

            if (newIndexedValueTreeNode.EnumerableValue == null)
            {
                newIndexedValueTreeNode.CurrentValue = string.Empty;
                newIndexedValueTreeNode.EnumerationComplete = true;
            }
            else
            {
                var isPrimitiveArray = false;
                if (data is JObject jObject)
                {
                    var property = jObject.Property(pathSegment.ActualSegment);
                    isPrimitiveArray = property.IsEnumerableOfPrimitives();
                }

                newIndexedValueTreeNode.Enumerator = newIndexedValueTreeNode.EnumerableValue.GetEnumerator();
                newIndexedValueTreeNode.Enumerator.Reset();

                if (isPrimitiveArray)
                {
                    var valueBuilder = new StringBuilder();
                    while (newIndexedValueTreeNode.Enumerator.MoveNext())
                    {
                        valueBuilder.Append(newIndexedValueTreeNode.Enumerator.Current);
                        valueBuilder.Append(",");
                    }
                    newIndexedValueTreeNode.EnumerationComplete = true;
                    newIndexedValueTreeNode.CurrentValue = valueBuilder.ToString().TrimEnd(',');
                }
                else
                {
                    if (!newIndexedValueTreeNode.Enumerator.MoveNext())
                    {
                        newIndexedValueTreeNode.CurrentValue = string.Empty;
                        newIndexedValueTreeNode.EnumerationComplete = true;
                    }
                    else
                    {
                        newIndexedValueTreeNode.CurrentValue = newIndexedValueTreeNode.Enumerator.Current;
                    }
                }
            }
        }

        JToken GetScalarValueForPathSegment(IPathSegment pathSegment, IEnumerable<JToken> data)
        {
            var jObject = data as JObject;

            JToken returnVal = null;
            var property = jObject?.Property(pathSegment.ActualSegment);

            if (property != null)
            {
                returnVal = property.Value;
            }

            return returnVal;
        }

        IEnumerable GetEnumerableValueForPathSegment(IPathSegment pathSegment, IEnumerable<JToken> data)
        {
            var jObject = data as JObject;

            IEnumerable returnVal = null;
            var property = jObject?.Property(pathSegment.ActualSegment);

            if (property != null && property.IsEnumerable())
            {
                returnVal = property.Value as JArray;
            }

            if (data is JArray jArray)
            {
                returnVal = jArray;
            }

            return returnVal;
        }

        protected override void WriteToResults(IList<IPath> paths,
            Dictionary<IPath, List<IPathSegment>> indexedPathSegments,
            IndexedPathSegmentTreeNode<string> rootIndexedValueTreeNode, Dictionary<IPath, IList<object>> results)
        {
            foreach (IPath path in paths)
            {
                var indexedPathSegment = indexedPathSegments[path];
                var complexKey = indexedPathSegment.Select(p => p.ActualSegment).ToList();
                var IndexedPathSegmentTreeNode = rootIndexedValueTreeNode[complexKey];
                results[path].Add(IndexedPathSegmentTreeNode.CurrentValue.ToString());
            }
        }

        #endregion Private Methods
    }
}
---- Transformed Tree ----
using System;
using System.Collections;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using Dev2;
using Dev2.Common;
using Dev2.Common.Interfaces.Core.Graph;
using Dev2.Converters.Graph;
using Newtonsoft.Json.Linq;
using Warewolf.Resource.Errors;

namespace Unlimited.Framework.Converters.Graph.String.Json
{
    [Serializable]
    public class JsonNavigator : NavigatorBase, INavigator
    {
        public JsonNavigator(object data) => Data = JToken.Parse(data.ToString());

        #region Methods

        public object SelectScalar(IPath path)
        {
            if (path == null)
            {
                throw new ArgumentNullException("path");
            }

            var jsonPath = path as JsonPath;

            if (jsonPath == null)
            {
                throw new Exception(string.Format(ErrorResource.PathMismatch,
                    typeof (JsonPath), path.GetType()));
            }

            if (path.ActualPath == JsonPath.SeperatorSymbol)
            {
                //nothing to do here yet
            }
            else if (path.ActualPath == JsonPath.EnumerableSymbol + JsonPath.SeperatorSymbol)
            {
                var enumerableData = currentData as IEnumerable;
                var enumerator = enumerableData.GetEnumerator();
                enumerator.Reset();
                while (enumerator.MoveNext())
                {
                    currentData = enumerator.Current as JToken;
                }
            }
            else
            {
                var pathSegments = jsonPath.GetSegements().ToList();
                var segmentIndex = 0;

                while (Data is JToken currentData && segmentIndex < pathSegments.Count)
                {
                    if (pathSegments[segmentIndex].IsEnumarable)
                    {
                        currentData = GetEnumuratedValueForPathSegment(currentData, pathSegments, segmentIndex);
                    }
                    else
                    {
                        currentData = GetScalarValueForPathSegment(pathSegments[segmentIndex], currentData);
                    }

                    segmentIndex++;
                }
            }

            var returnVal = "";

            if (Data is JToken currentData)
            {
                returnVal = currentData.ToString();
            }

            return returnVal;
        }

        private JToken GetEnumuratedValueForPathSegment(JToken currentData, List<IPathSegment> pathSegments, int segmentIndex)
        {
            var enumerableData = GetEnumerableValueForPathSegment(pathSegments[segmentIndex],
                                        currentData);

            if (enumerableData != null)
            {
                var enumerator = enumerableData.GetEnumerator();
                enumerator.Reset();
                while (enumerator.MoveNext())
                {
                    currentData = enumerator.Current as JToken;
                }
            }

            return currentData;
        }

        public IEnumerable<object> SelectEnumerable(IPath path)
        {
            if (path == null)
            {
                throw new ArgumentNullException("path");
            }

            var jsonPath = path as JsonPath;

            if (jsonPath == null)
            {
                throw new Exception(string.Format(ErrorResource.DataTypeMismatch,
                    typeof (JsonPath), path.GetType()));
            }

            List<object> returnData;

            if (path.ActualPath == JsonPath.SeperatorSymbol)
            {
                returnData = new List<object> {Data};
            }
            else if (path.ActualPath == JsonPath.EnumerableSymbol + JsonPath.SeperatorSymbol)
            {
                returnData = new List<object>();

                if (Data is IEnumerable enumerableData)
                {
                    var enumerator = enumerableData.GetEnumerator();
                    enumerator.Reset();
                    while (enumerator.MoveNext())
                    {
                        returnData.Add(enumerator.Current);
                    }
                }
            }
            else
            {
                returnData =
                    new List<object>(
                        SelectEnumberable(jsonPath.GetSegements().ToList(), Data as JToken).Select(o => o.ToString()));
            }

            return returnData;
        }

        public Dictionary<IPath, IList<object>> SelectEnumerablesAsRelated(IList<IPath> paths)
        {
            //
            // Get valid paths
            //
            IList<IPath> validPaths = new List<IPath>(paths.OfType<JsonPath>().ToList());

            //
            // Setup results structure
            //
            var results = new Dictionary<IPath, IList<object>>();
            BuildResultsStructure(validPaths, results);

            if (validPaths.Count == 1 && validPaths[0].ActualPath == JsonPath.SeperatorSymbol)
            {
                results[validPaths[0]].Add(Data);
            }
            else if (validPaths.Count == 1 &&
                     validPaths[0].ActualPath == JsonPath.EnumerableSymbol + JsonPath.SeperatorSymbol)
            {

                if (Data is IEnumerable enumerableData)
                {
                    var enumerator = enumerableData.GetEnumerator();
                    enumerator.Reset();
                    while (enumerator.MoveNext())
                    {
                        results[validPaths[0]].Add(enumerator.Current);
                    }
                }
            }
            else
            {
                CreateRootNode(validPaths, results);
            }
            return results;
        }

        public void Dispose()
        {
            Data = null;
        }

        #endregion Methods

        #region Private Methods

        IEnumerable<object> SelectEnumberable(IList<IPathSegment> pathSegments, JToken data)
        {
            var returnData = new List<object>();
            var currentData = data;

            for (int i = 0; i < pathSegments.Count; i++)
            {
                var pathSegment = pathSegments[i];
                var lastSegment = i == pathSegments.Count - 1;

                if (pathSegment.IsEnumarable)
                {
                    var enumerableData = GetEnumerableValueForPathSegment(pathSegment, currentData);

                    if (enumerableData != null)
                    {
                        GetEnumerableValueForSegment(pathSegments, returnData, currentData, i, enumerableData);
                    }

                    return returnData;
                }

                currentData = GetScalarValueForPathSegment(pathSegment, currentData);

                if (currentData != null && lastSegment)
                {
                    returnData.Add(currentData.ToString());
                }
            }

            return returnData;
        }

        void GetEnumerableValueForSegment(IList<IPathSegment> pathSegments, List<object> returnData, JToken currentData, int i, IEnumerable enumerableData)
        {
            var enumerator = enumerableData.GetEnumerator();
            enumerator.Reset();

            var testToken = enumerableData as JToken;

            if (testToken.IsEnumerableOfPrimitives())
            {
                while (enumerator.MoveNext())
                {
                    if (currentData != null && enumerator.Current is JToken currentToken)
                    {
                        returnData.Add(currentToken.ToString());
                    }

                }
            }
            else
            {
                while (enumerator.MoveNext())
                {
                    returnData.AddRange(SelectEnumberable(pathSegments.Skip(i + 1).ToList(),
                        enumerator.Current as JToken));
                }
            }
        }

        protected override IndexedPathSegmentTreeNode<string> CreatePathSegmentIndexedPathSegmentTreeNode(
            IPathSegment pathSegment, IndexedPathSegmentTreeNode<string> parentNode)
        {
            var newIndexedValueTreeNode = new IndexedPathSegmentTreeNode<string>();

            if (parentNode.EnumerationComplete)
            {
                newIndexedValueTreeNode.CurrentValue = string.Empty;
                newIndexedValueTreeNode.EnumerationComplete = true;
            }
            else
            {
                if (pathSegment.IsEnumarable)
                {
                    GetEnumerableValueForPathSegment(pathSegment, parentNode, newIndexedValueTreeNode);
                }
                else
                {
                    newIndexedValueTreeNode.CurrentValue = GetScalarValueForPathSegment(pathSegment,
                        parentNode.CurrentValue as JToken);

                    if (newIndexedValueTreeNode.CurrentValue == null)
                    {
                        newIndexedValueTreeNode.CurrentValue = string.Empty;
                        newIndexedValueTreeNode.EnumerationComplete = true;
                    }
                }
            }

            return newIndexedValueTreeNode;
        }

        private void GetEnumerableValueForPathSegment(IPathSegment pathSegment, IndexedPathSegmentTreeNode<string> parentNode, IndexedPathSegmentTreeNode<string> newIndexedValueTreeNode)
        {
            var data = parentNode.CurrentValue as JToken;
            newIndexedValueTreeNode.EnumerableValue = GetEnumerableValueForPathSegment(pathSegment, data);

            if (newIndexedValueTreeNode.EnumerableValue == null)
            {
                newIndexedValueTreeNode.CurrentValue = string.Empty;
                newIndexedValueTreeNode.EnumerationComplete = true;
            }
            else
            {
                var isPrimitiveArray = false;
                if (data is JObject jObject)
                {
                    var property = jObject.Property(pathSegment.ActualSegment);
                    isPrimitiveArray = property.IsEnumerableOfPrimitives();
                }

                newIndexedValueTreeNode.Enumerator = newIndexedValueTreeNode.EnumerableValue.GetEnumerator();
                newIndexedValueTreeNode.Enumerator.Reset();

                if (isPrimitiveArray)
                {
                    var valueBuilder = new StringBuilder();
                    while (newIndexedValueTreeNode.Enumerator.MoveNext())
                    {
                        valueBuilder.Append(newIndexedValueTreeNode.Enumerator.Current);
                        valueBuilder.Append(",");
                    }
                    newIndexedValueTreeNode.EnumerationComplete = true;
                    newIndexedValueTreeNode.CurrentValue = valueBuilder.ToString().TrimEnd(',');
                }
                else
                {
                    if (!newIndexedValueTreeNode.Enumerator.MoveNext())
                    {
                        newIndexedValueTreeNode.CurrentValue = string.Empty;
                        newIndexedValueTreeNode.EnumerationComplete = true;
                    }
                    else
                    {
                        newIndexedValueTreeNode.CurrentValue = newIndexedValueTreeNode.Enumerator.Current;
                    }
                }
            }
        }

        JToken GetScalarValueForPathSegment(IPathSegment pathSegment, IEnumerable<JToken> data)
        {
            var jObject = data as JObject;

            JToken returnVal = null;
            var property = jObject?.Property(pathSegment.ActualSegment);

            if (property != null)
            {
                returnVal = property.Value;
            }

            return returnVal;
        }

        IEnumerable GetEnumerableValueForPathSegment(IPathSegment pathSegment, IEnumerable<JToken> data)
        {
            var jObject = data as JObject;

            IEnumerable returnVal = null;
            var property = jObject?.Property(pathSegment.ActualSegment);

            if (property != null && property.IsEnumerable())
            {
                returnVal = property.Value as JArray;
            }

            if (data is JArray jArray)
            {
                returnVal = jArray;
            }

            return returnVal;
        }

        protected override void WriteToResults(IList<IPath> paths,
            Dictionary<IPath, List<IPathSegment>> indexedPathSegments,
            IndexedPathSegmentTreeNode<string> rootIndexedValueTreeNode, Dictionary<IPath, IList<object>> results)
        {
            foreach (IPath path in paths)
            {
                var indexedPathSegment = indexedPathSegments[path];
                var complexKey = indexedPathSegment.Select(p => p.ActualSegment).ToList();
                var IndexedPathSegmentTreeNode = rootIndexedValueTreeNode[complexKey];
                results[path].Add(IndexedPathSegmentTreeNode.CurrentValue.ToString());
            }
        }

        #endregion Private Methods
    }
}
---- Semantic diagnostics *before* transformation ----

---- Semantic diagnostics *after* transformation ----
D:\a\1\s\Dev\Dev2.Core\Converters\Graph\String\Json\JsonNavigator.cs(54,38): error CS0841: Cannot use local variable 'currentData' before it is declared,D:\a\1\s\Dev\Dev2.Core\Converters\Graph\String\Json\JsonNavigator.cs(59,21): error CS0841: Cannot use local variable 'currentData' before it is declared,D:\a\1\s\Dev\Dev2.Core\Converters\Graph\String\Json\JsonNavigator.cs(67,39): error CS0136: A local or parameter named 'currentData' cannot be declared in this scope because that name is used in an enclosing local scope to define a local or parameter
######################################################################


######################################################################
Nr: 10 - UsePatternMatchingRewriterR8
Filepath: D:\a\1\s\Dev\Dev2.Core\ExecutionEnvironmentUtils.cs
Description: Error: The created Syntax Tree is semantically incorrect.
------------------------------------------------------------------------
---- Original Tree ----
using System;
using System.Collections.Generic;
using System.Data;
using System.IO;
using System.Linq;
using System.Text;
using System.Text.RegularExpressions;
using System.Xml;
using System.Xml.Linq;
using Dev2.Common;
using Dev2.Common.ExtMethods;
using Dev2.Common.Interfaces.DB;
using Dev2.Data;
using Dev2.Data.Interfaces.Enums;
using Dev2.Data.Util;
using Dev2.Interfaces;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using Warewolf.Storage.Interfaces;
using WarewolfParserInterop;
using Warewolf.Data;

namespace Dev2
{
    public static class ExecutionEnvironmentUtils
    {
        public static string GetXmlOutputFromEnvironment(IDSFDataObject dataObject, string dataList, int update)
        {
            var jsonOutput = GetJsonForEnvironmentWithColumnIoDirection(dataObject, dataList, enDev2ColumnArgumentDirection.Output, update);
            var xml = JsonConvert.DeserializeXNode(jsonOutput, "DataList", true);
            return xml.ToString();
        }

        static string GetJsonForEnvironmentWithColumnIoDirection(IDSFDataObject dataObject, string dataList, enDev2ColumnArgumentDirection requestIODirection, int update)
        {
            var environment = dataObject.Environment;
            var fixedDataList = dataList.Replace(GlobalConstants.SerializableResourceQuote, "\"").Replace(GlobalConstants.SerializableResourceSingleQuote, "\'");
            var serializeXNode = JsonConvert.SerializeXNode(XDocument.Parse(fixedDataList), Newtonsoft.Json.Formatting.Indented, true);
            if (JsonConvert.DeserializeObject(serializeXNode) is JObject deserializeObject)
            {
                var outputObj = new JObject();
                var props = deserializeObject.Properties().ToList();
                foreach (var prop in props)
                {
                    TryAddPropToOutput(requestIODirection, update, environment, outputObj, prop);
                }

                var dataListString = outputObj.ToString(Newtonsoft.Json.Formatting.Indented);
                return dataListString;
            }

            return "{}";
        }

        private static void TryAddPropToOutput(enDev2ColumnArgumentDirection requestIODirection, int update, IExecutionEnvironment environment, JObject outputObj, JProperty prop)
        {
            if (prop.Value != null && prop.Value.Type == JTokenType.Object)
            {
                var val = prop.Value as JObject;
                var jProperty = val?.Properties().FirstOrDefault(property => property.Name == "@ColumnIODirection");
                if (jProperty != null)
                {
                    var propValue = jProperty.Value;
                    if (Enum.TryParse(propValue.ToString(), true, out enDev2ColumnArgumentDirection ioDirection) && (ioDirection == enDev2ColumnArgumentDirection.Both || ioDirection == requestIODirection))
                    {
                        AddPropToOutput(requestIODirection, update, environment, outputObj, prop, val);
                    }
                }
            }
        }

        private static void AddPropToOutput(enDev2ColumnArgumentDirection requestIODirection, int update, IExecutionEnvironment environment, JObject outputObj, JProperty prop, JObject val)
        {
            var objName = prop.Name;
            var isJson = val.Properties().FirstOrDefault(property => property.Name == "@IsJson");
            if (isJson != null && isJson.Value.ToString() == "True")
            {
                AddObjectsToOutput(environment, objName, outputObj);
            }
            else
            {
                if (prop.Value.Count() > 3)
                {
                    AddRecordsetsToOutput(environment, objName, val, outputObj, requestIODirection, update);
                }
                else
                {
                    AddScalarsToOutput(prop, environment, objName, outputObj, requestIODirection);
                }
            }
        }

        static void AddObjectsToOutput(IExecutionEnvironment environment, string objName, JObject outputObj)
        {
            var evalResult = environment.EvalJContainer("[[@" + objName + "]]");
            if (evalResult != null)
            {
                outputObj.Add(objName, evalResult);
            }
        }

        static void AddScalarsToOutput(JProperty prop, IExecutionEnvironment environment, string objName, JObject outputObj, enDev2ColumnArgumentDirection requestIODirection)
        {
            var v = prop.Value as JObject;
            var ioDire = v?.Properties().FirstOrDefault(property => property.Name == "@ColumnIODirection");
            if (ioDire != null)
            {
                var x = (enDev2ColumnArgumentDirection) Enum.Parse(typeof(enDev2ColumnArgumentDirection), ioDire.Value.ToString());
                if ((x == enDev2ColumnArgumentDirection.Both || x == requestIODirection) && (environment.Eval("[[" + objName + "]]", 0) is CommonFunctions.WarewolfEvalResult.WarewolfAtomResult warewolfEvalResult))
                {
                    ParseDataItemToOutputs(outputObj, objName, warewolfEvalResult.Item);
                }
            }
        }

        static void AddRecordsetsToOutput(IExecutionEnvironment environment, string objName, JObject val, JObject outputObj, enDev2ColumnArgumentDirection requestedIODirection, int update)
        {
            var evalResult = environment.Eval("[[" + objName + "(*)]]", update);
            var newArray = new JArray();
            if (evalResult != null)
            {
                if (evalResult is CommonFunctions.WarewolfEvalResult.WarewolfRecordSetResult res)
                {
                    var data = res.Item.Data;
                    foreach (var dataItem in data)
                    {
                        AddDataItemToOutputs(val, requestedIODirection, newArray, dataItem);
                    }
                }

                outputObj.Add(objName, newArray);
            }
        }

        static void AddDataItemToOutputs(JObject val, enDev2ColumnArgumentDirection requestedIODirection, JArray newArray, KeyValuePair<string, WarewolfAtomList<DataStorage.WarewolfAtom>> dataItem)
        {
            var jObjForArray = new JObject();
            var recCol = val.Properties().FirstOrDefault(property => property.Name == dataItem.Key);
            var io = recCol?.Children().FirstOrDefault() as JObject;
            var p = io?.Properties().FirstOrDefault(token => token.Name == "@ColumnIODirection");
            if (p != null)
            {
                var direction = (enDev2ColumnArgumentDirection) Enum.Parse(typeof(enDev2ColumnArgumentDirection), p.Value.ToString(), true);
                if (direction == enDev2ColumnArgumentDirection.Both || direction == requestedIODirection)
                {
                    var i = 0;
                    foreach (var warewolfAtom in dataItem.Value)
                    {
                        ParseDataItemToOutputs(jObjForArray, dataItem.Key, warewolfAtom);

                        dataItem = CreateDataItem(newArray, dataItem, jObjForArray, i, warewolfAtom);
                        jObjForArray = new JObject();
                        i++;
                    }
                }
            }
        }

        private static KeyValuePair<string, WarewolfAtomList<DataStorage.WarewolfAtom>> CreateDataItem(JArray newArray, KeyValuePair<string, WarewolfAtomList<DataStorage.WarewolfAtom>> dataItem, JObject jObjForArray, int i, DataStorage.WarewolfAtom warewolfAtom)
        {
            if (newArray.Count < i + 1 || newArray.Count == 0)
            {
                newArray.Add(jObjForArray);
            }
            else
            {
                var jToken = newArray[i] as JObject;
                ParseDataItemToOutputs(jToken, dataItem.Key, warewolfAtom);
            }

            return dataItem;
        }

        static void ParseDataItemToOutputs(JObject jObject, string key, DataStorage.WarewolfAtom warewolfAtom)
        {
            if (warewolfAtom is DataStorage.WarewolfAtom.DataString stringResult)
            {
                jObject.Add(key, stringResult.Item);
            }
            else if (warewolfAtom is DataStorage.WarewolfAtom.Int intResult)
            {
                jObject.Add(key, intResult.Item);
            }
            else if (warewolfAtom is DataStorage.WarewolfAtom.Float floatResult)
            {
                jObject.Add(key, floatResult.Item);
            }
            else
            {
                jObject.Add(key, warewolfAtom.ToString());
            }
        }

        public static string GetJsonOutputFromEnvironment(IDSFDataObject dataObject, string dataList, int update) => GetJsonForEnvironmentWithColumnIoDirection(dataObject, dataList, enDev2ColumnArgumentDirection.Output, update);

        public static void UpdateEnvironmentFromXmlPayload(IDSFDataObject dataObject, StringBuilder rawPayload, string dataList, int update)
        {
            var toLoad = rawPayload.ToString().ToCleanXml();
            var xDoc = new XmlDocument();
            toLoad = string.Format("<Tmp{0:N}>{1}</Tmp{0:N}>", Guid.NewGuid(), toLoad);
            xDoc.LoadXml(toLoad);
            if (dataList != null)
            {
                dataList = dataList.Replace("ADL>", "DataList>").Replace("root>", "DataList>");
                if (xDoc.DocumentElement != null)
                {
                    var children = xDoc.DocumentElement.ChildNodes;
                    var dataListTO = new DataListTO(dataList, true);
                    TryLoadXmlIntoEnvironment(dataObject, children, dataListTO.Inputs, update);
                }
            }
        }

        public static void UpdateEnvironmentFromInputPayload(IDSFDataObject dataObject, StringBuilder rawPayload, string dataList)
        {
            dataList = dataList.Replace("ADL>", "DataList>").Replace("root>", "DataList>");
            var dataListTO = new DataListTO(dataList);
            var inputs = dataListTO.Inputs;
            TryUpdateEnviromentWithMappings(dataObject, rawPayload, inputs);
        }

        static void TryUpdateEnviromentWithMappings(IDSFDataObject dataObject, StringBuilder rawPayload, List<string> mappings)
        {
            JObject inputObject;
            var toLoad = rawPayload.ToString();
            if (string.IsNullOrEmpty(toLoad))
            {
                return;
            }

            if (!toLoad.IsJSON())
            {
                toLoad = toLoad.ToCleanXml();
                var sXNode = JsonConvert.SerializeXNode(XDocument.Parse(toLoad), Newtonsoft.Json.Formatting.Indented, true);
                inputObject = JsonConvert.DeserializeObject(sXNode) as JObject;
            }
            else
            {
                inputObject = JsonConvert.DeserializeObject(toLoad) as JObject;
            }

            if (inputObject != null)
            {
                UpdateEnviromentWithMappings(dataObject, mappings, inputObject);
            }
        }

        static void UpdateEnviromentWithMappings(IDSFDataObject dataObject, List<string> mappings, JObject inputObject)
        {
            var recSets = mappings.Where(DataListUtil.IsValueRecordset).ToList();
            var processedRecsets = new List<string>();
            foreach (var input in mappings)
            {
                var inputName = input;
                var isValueRecordset = DataListUtil.IsValueRecordset(input);
                if (isValueRecordset)
                {
                    inputName = DataListUtil.ExtractRecordsetNameFromValue(input);
                    if (processedRecsets.Contains(inputName))
                    {
                        continue;
                    }
                }

                var propsMatching = inputObject.Properties().Where(property => property.Name == inputName).ToList();
                foreach (var prop in propsMatching)
                {
                    var value = prop.Value;
                    var tokenType = value.Type;
                    if (tokenType == JTokenType.Object)
                    {
                        PerformRecordsetUpdate(dataObject, value, processedRecsets, input, recSets, inputName, isValueRecordset);
                    }
                    else if (tokenType == JTokenType.Array)
                    {
                        PerformRecordsetUpdate(dataObject, value, isValueRecordset, input, recSets, inputName, processedRecsets);
                    }
                    else
                    {
                        dataObject.Environment.Assign(DataListUtil.AddBracketsToValueIfNotExist(input), value.ToString(), 0);
                    }
                }
            }
        }

        private static void PerformRecordsetUpdate(IDSFDataObject dataObject, JToken value, List<string> processedRecsets, string input, List<string> recSets, string inputName, bool isValueRecordset)
        {
            if (isValueRecordset)
            {
                var arr = new JArray(value);
                PerformRecordsetUpdate(dataObject, arr, true, input, recSets, inputName, processedRecsets);
            }
            else
            {
                var jContainer = value as JContainer;
                dataObject.Environment.AddToJsonObjects(DataListUtil.AddBracketsToValueIfNotExist("@" + input), jContainer);
            }
        }

        static void PerformRecordsetUpdate(IDSFDataObject dataObject, JToken value, bool isValueRecordset, string input, List<string> recSets, string inputName, List<string> processedRecsets)
        {
            var arrayValue = value as JArray;
            if (!isValueRecordset)
            {
                dataObject.Environment.AddToJsonObjects(DataListUtil.AddBracketsToValueIfNotExist("@" + input + "()"), arrayValue);
            }
            else
            {
                if (arrayValue != null)
                {
                    for (int i = 0; i < arrayValue.Count; i++)
                    {
                        UpdateEnvironmentFromJObject(dataObject, recSets, inputName, i, arrayValue[i]);
                    }

                    processedRecsets.Add(inputName);
                }
            }
        }

        static void UpdateEnvironmentFromJObject(IDSFDataObject dataObject, List<string> recSets, string inputName, int i, JToken val)
        {
            if (val is JObject valObj)
            {
                var recs = recSets.Where(s => DataListUtil.ExtractRecordsetNameFromValue(s) == inputName);
                foreach (var rec in recs)
                {
                    var field = DataListUtil.ExtractFieldNameOnlyFromValue(rec);
                    var fieldProp = valObj.Properties().FirstOrDefault(property => property.Name == field);
                    if (fieldProp != null)
                    {
                        dataObject.Environment.Assign(DataListUtil.AddBracketsToValueIfNotExist(rec), fieldProp.Value.ToString(), i + 1);
                    }
                }
            }
        }

        public static void UpdateEnvironmentFromOutputPayload(IDSFDataObject dataObject, StringBuilder rawPayload, string dataList)
        {
            dataList = dataList.Replace("ADL>", "DataList>").Replace("root>", "DataList>");
            var dataListTO = new DataListTO(dataList);
            var outputs = dataListTO.Outputs;
            TryUpdateEnviromentWithMappings(dataObject, rawPayload, outputs);
        }

        static void TryLoadXmlIntoEnvironment(IDSFDataObject dataObject, XmlNodeList children, List<string> inputDefs, int update, int level = 0)
        {
            try
            {
                LoadXmlIntoEnvironment(dataObject, children, inputDefs, update, level);
            }
            finally
            {
                dataObject.Environment.CommitAssign();
            }
        }

        static void LoadXmlIntoEnvironment(IDSFDataObject dataObject, XmlNodeList children, List<string> inputDefs, int update, int level)
        {
            foreach (XmlNode c in children)
            {
                if (c.Name != GlobalConstants.NaughtyTextNode)
                {
                    if (level > 0)
                    {
                        var c1 = c;
                        var scalars = inputDefs.Where(definition => definition == c1.Name);
                        var recSets = inputDefs.Where(definition => DataListUtil.ExtractRecordsetNameFromValue(definition) == c1.Name);
                        UpdateForRecordset(dataObject, update, recSets, c);
                        UpdateForScalars(dataObject, update, scalars, c);
                    }
                    else
                    {
                        ContinueLoadingXmlIntoEnvironment(dataObject, inputDefs, update, level, c);
                    }
                }
            }
        }

        static void ContinueLoadingXmlIntoEnvironment(IDSFDataObject dataObject, List<string> inputDefs, int update, int level, XmlNode c)
        {
            if (level == 0)
            {
                TryLoadXmlIntoEnvironment(dataObject, c.ChildNodes, inputDefs, update, ++level);
            }
        }

        static void UpdateForScalars(IDSFDataObject dataObject, int update, IEnumerable<string> scalars, XmlNode c)
        {
            var scalarDefs = scalars as string[] ?? scalars.ToArray();
            if (scalarDefs.Length != 0)
            {
                // fetch recordset index
                // process recordset
                var a = c.InnerXml;
                a = RemoveXMLPrefix(a);
                dataObject.Environment.Assign(DataListUtil.AddBracketsToValueIfNotExist(c.Name), a, update);
            }
        }

        static void UpdateForRecordset(IDSFDataObject dataObject, int update, IEnumerable<string> recSets, XmlNode c)
        {
            var recSetDefs = recSets as string[] ?? recSets.ToArray();
            if (recSetDefs.Length != 0)
            {
                var nl = c.ChildNodes;
                foreach (XmlNode subc in nl)
                {
                    foreach (var definition in recSetDefs)
                    {
                        UpdateForChildNodes(dataObject, update, subc, definition);
                    }
                }
            }
        }

        private static void UpdateForChildNodes(IDSFDataObject dataObject, int update, XmlNode subc, string definition)
        {
            if (DataListUtil.IsValueRecordset(definition) && DataListUtil.ExtractFieldNameFromValue(definition) == subc.Name)
            {
                var recSetAppend = DataListUtil.ReplaceRecordsetIndexWithBlank(definition);
                var a = subc.InnerXml;
                a = RemoveXMLPrefix(a);
                dataObject.Environment.AssignWithFrame(new AssignValue(recSetAppend, a), update);
            }
        }

        static string RemoveXMLPrefix(string a)
        {
            if (a.StartsWith(GlobalConstants.XMLPrefix))
            {
                a = a.Replace(GlobalConstants.XMLPrefix, "");
                a = Encoding.UTF8.GetString(System.Convert.FromBase64String(a));
            }

            return a;
        }

        public static string GetXmlInputFromEnvironment(IDSFDataObject dataObject, string dataList, int update)
        {
            var xml = JsonConvert.DeserializeXNode(GetJsonForEnvironmentWithColumnIoDirection(dataObject, dataList, enDev2ColumnArgumentDirection.Input, update), "DataList", true);
            return xml.ToString();
        }

        public static string GetOpenAPIOutputForService(IWarewolfResource resource, string dataList, string webServerUrl)
        {
            if (resource == null)
            {
                throw new ArgumentNullException(nameof(resource));
            }

            if (string.IsNullOrEmpty(dataList))
            {
                throw new ArgumentNullException(nameof(dataList));
            }

            Uri.TryCreate(webServerUrl, UriKind.RelativeOrAbsolute, out Uri url);
            var jsonOpenAPIInfoObject = BuildJsonOpenAPIInfoObject(resource);
            var jsonOpenAPIServerObject = BuildJsonOpenAPIServerObject(url);
            var jsonOpenAPIPathObject = BuildJsonOpenAPIPathObject(url, dataList);
            var jsonOpenAPIObject = BuildJsonOpenAPIObject(jsonOpenAPIInfoObject, jsonOpenAPIServerObject, jsonOpenAPIPathObject);
            var resultString = GetSerializedOpenAPIObject(jsonOpenAPIObject);
            return resultString;
        }

        public static string GetOpenAPIOutputForServiceList(IList<IWarewolfResource> resourceList,
            string webServerUrl)
        {
            if (resourceList == null)
            {
                throw new ArgumentNullException(nameof(resourceList));
            }
            
            if (string.IsNullOrEmpty(webServerUrl))
            {
                throw new ArgumentNullException(nameof(webServerUrl));
            }

            var paths = new List<JObject>();
            foreach (var resource in resourceList)
            {
                var filePath1 = webServerUrl;
                filePath1 = filePath1.Substring(0, filePath1.IndexOf("secure", StringComparison.Ordinal) + 6);

                var filePath2 = resource.FilePath;
                filePath2 = filePath2.Substring(filePath2.IndexOf("Resources", StringComparison.Ordinal) + 10)
                    .Replace(".bite", ".api");

                Uri.TryCreate($"{filePath1}/{filePath2}", UriKind.RelativeOrAbsolute, out Uri url);
                paths.Add(BuildJsonOpenAPIPathObject(url, resource.DataList.ToString()));
            }
            
            var info =  new JObject
            {
                {"title", new JValue(webServerUrl)},
                {"description", new JValue(webServerUrl)},
                {"version", "1"}
            };
            
            var jsonOpenAPIObject = new JObject
            {
                {"openapi", new JValue(EnvironmentVariables.OpenAPiVersion)},
                {"info", info},
                {"servers", new JArray(BuildJsonOpenAPIServerObject(new Uri(webServerUrl)))},
                {"paths", new JArray(paths)}
            };
            var serializedObject = GetSerializedOpenAPIObject(jsonOpenAPIObject);
            serializedObject = RemovePathsArray(serializedObject);

            return serializedObject;
        }

        static string RemovePathsArray(string apiObject)
        {
            apiObject = apiObject.Replace("\"paths\": [", "\"paths\": ");
            apiObject = apiObject.Replace("},\r\n    {\r\n      \"/secure", ",\r\n      \"/secure");
            apiObject = apiObject.Remove(apiObject.LastIndexOf("]"), 1);
            return apiObject;
        }

        static string GetSerializedOpenAPIObject(JObject jsonOpenAPIObject)
        {
            var converter = new JsonSerializer();
            var result = new StringBuilder();
            var jsonTextWriter = new JsonTextWriter(new StringWriter(result)) {Formatting = Newtonsoft.Json.Formatting.Indented};
            converter.Serialize(jsonTextWriter, jsonOpenAPIObject);
            jsonTextWriter.Flush();
            var resultString = Regex.Replace(result.ToString(), @"^\s+$[\r\n]*", "", RegexOptions.Multiline);
            return resultString;
        }

        static JObject BuildJsonOpenAPIObject(JObject jsonOpenAPIInfoObject, JObject jsonOpenAPIServerObject, JObject jsonOpenAPIPathObject)
        {
            var jsonOpenAPIObject = new JObject
            {
                {"openapi", new JValue(EnvironmentVariables.OpenAPiVersion)},
                {"info", jsonOpenAPIInfoObject},
                {"servers", new JArray(jsonOpenAPIServerObject)},
                {"paths", jsonOpenAPIPathObject}
            };
            return jsonOpenAPIObject;
        }

        static JObject BuildJsonOpenAPIServerObject(Uri url)
        {
            var jsonOpenAPIServerObject = new JObject
            {
                {"url", new JValue(url.Scheme + "://" + url.Host)}
            };
            return jsonOpenAPIServerObject;
        }

        static JObject BuildJsonOpenAPIInfoObject(IWarewolfResource resource)
        {
            var versionValue = resource.VersionInfo != null ? new JValue(resource.VersionInfo.VersionNumber) : new JValue("1.0.0");

            var jsonOpenAPIInfoObject = new JObject
            {
                {"title", new JValue(resource.ResourceName)},
                {"description", new JValue(resource.ResourceName)},
                {"version", versionValue}
            };
            return jsonOpenAPIInfoObject;
        }

        static JObject BuildJsonOpenAPIPathObject(Uri path, string dataList)
        {
            var parametersObject = BuildParametersObject(dataList);
            var responseObject = BuildJsonOpenAPIResponsesObject(dataList);
            var pathGetObject = new JObject
            {
                {
                    "get", new JObject
                    {
                        {"tags", new JArray("")},
                        {"description", new JValue("")},
                        {"parameters", parametersObject},
                        {"responses", responseObject}
                    }
                }
            };

            var pathObject = new JObject
            {
                {path.AbsolutePath.Replace(".api", ""), pathGetObject}
            };
            return pathObject;
        }

        static JToken BuildParametersObject(string dataList)
        {
            JArray arrayObj = new JArray();
            var dataListTo = new DataListTO(dataList);

            var scalarInputs = dataListTo.Inputs.Where(s => !DataListUtil.IsValueRecordset(s));
            foreach (var input in scalarInputs)
            {
                var inputObject = new JObject
                {
                    {"name", input},
                    {"in", "query"},
                    {"required", true},
                    {
                        "schema", new JObject
                        {
                            {"type", "string"}
                        }
                    }
                };
                arrayObj.Add(inputObject);
            }

            var recSetInputs = dataListTo.Inputs.Where(DataListUtil.IsValueRecordset).ToList();
            var groupedRecSets = recSetInputs.GroupBy(DataListUtil.ExtractRecordsetNameFromValue);
            foreach (var groupedRecSet in groupedRecSets)
            {
                var recSetName = groupedRecSet.Key;
                var propObject = BuildPropertyDefinition(groupedRecSet);
                var recSchemaObject = new Schema
                {
                    Type = "object",
                    Properties = propObject
                };
                var serializedSchema = JsonConvert.SerializeObject(recSchemaObject);
                var deserializedSchema = JsonConvert.DeserializeObject(serializedSchema) as JToken;
                var recObject = new JObject
                {
                    {"name", recSetName},
                    {"in", "query"},
                    {"required", true},
                    {"schema", deserializedSchema}
                };
                arrayObj.Add(recObject);
            }

            var serialized = JsonConvert.SerializeObject(arrayObj);
            var des = JsonConvert.DeserializeObject(serialized) as JToken;
            var definitionObject = des;
            return definitionObject;
        }

        static JObject BuildJsonOpenAPIResponsesObject(string dataList)
        {
            var jsonOpenAPIResponsesObject = new JObject
            {
                {
                    "200", new JObject
                    {
                        {"description", new JValue("Success")},
                        {
                            "content", new JObject
                            {
                                {
                                    "application/json", BuildResponseSchema(dataList)
                                }
                            }
                        }
                    }
                }
            };
            return jsonOpenAPIResponsesObject;
        }

        private static JToken BuildResponseSchema(string dataList)
        {
            var dataListTo = new DataListTO(dataList);
            var scalarOutputs = dataListTo.Outputs.Where(s => !DataListUtil.IsValueRecordset(s));
            var recSetOutputs = dataListTo.Outputs.Where(DataListUtil.IsValueRecordset);

            var propertiesObject = scalarOutputs.ToDictionary(scalarInput => scalarInput, scalarInput => new Schema {Type = "string"});
            var groupedRecSets = recSetOutputs.GroupBy(DataListUtil.ExtractRecordsetNameFromValue);
            foreach (var groupedRecSet in groupedRecSets)
            {
                var recSetName = groupedRecSet.Key;
                var propObject = BuildPropertyDefinition(groupedRecSet);

                var recObject = new Schema
                {
                    Type = "object",
                    Properties = propObject
                };
                propertiesObject.Add(recSetName, recObject);
            }

            var responseSchema = new Dictionary<string, Schema>
            {
                {
                    "schema", new Schema
                    {
                        Type = "object",
                        Properties = propertiesObject,
                    }
                }
            };
            var serialized = JsonConvert.SerializeObject(responseSchema);
            var definitionObject = JsonConvert.DeserializeObject(serialized) as JToken;
            var res = definitionObject;
            return res;
        }

        static Dictionary<string, Schema> BuildPropertyDefinition(IGrouping<string, string> groupedRecSet) => groupedRecSet.ToDictionary(DataListUtil.ExtractFieldNameOnlyFromValue, name => new Schema
        {
            Type = "string"
        });


        public static void ProcessOutputMapping(IExecutionEnvironment environment, int update, ref bool started, ref int rowIdx, DataRow row, IServiceOutputMapping serviceOutputMapping)
        {
            var rsType = DataListUtil.GetRecordsetIndexType(serviceOutputMapping.MappedTo);
            var rowIndex = DataListUtil.ExtractIndexRegionFromRecordset(serviceOutputMapping.MappedTo);

            var rs = serviceOutputMapping.RecordSetName;
            if (!string.IsNullOrEmpty(rs) && environment.HasRecordSet(DataListUtil.AddBracketsToValueIfNotExist(DataListUtil.MakeValueIntoHighLevelRecordset(rs, rsType == enRecordsetIndexType.Star))))
            {
                if (started)
                {
                    rowIdx = environment.GetLength(rs) + 1;
                    started = false;
                }
            }
            else
            {
                try
                {
                    environment.AssignDataShape(serviceOutputMapping.MappedTo);
                }
                catch (Exception e)
                {
                    Dev2Logger.Error(e, GlobalConstants.WarewolfError);
                }
            }

            GetRowIndex(ref started, ref rowIdx, rsType, rowIndex);
            if (!row.Table.Columns.Contains(serviceOutputMapping.MappedFrom))
            {
                return;
            }

            var value = row[serviceOutputMapping.MappedFrom];

            var colDataType = row.Table.Columns[serviceOutputMapping.MappedFrom].DataType;
            if (colDataType.Name == "Byte[]")
            {
                value = Encoding.UTF8.GetString(value as byte[]);
            }

            if (update != 0)
            {
                rowIdx = update;
            }

            var displayExpression = DataListUtil.ReplaceRecordsetBlankWithIndex(DataListUtil.AddBracketsToValueIfNotExist(serviceOutputMapping.MappedTo), rowIdx);
            if (rsType == enRecordsetIndexType.Star)
            {
                displayExpression = DataListUtil.ReplaceStarWithFixedIndex(displayExpression, rowIdx);
            }

            environment.Assign(displayExpression, value.ToString(), update);
        }

        static void GetRowIndex(ref bool started, ref int rowIdx, enRecordsetIndexType rsType, string rowIndex)
        {
            if (rsType == enRecordsetIndexType.Star && started)
            {
                rowIdx = 1;
                started = false;
            }

            if (rsType == enRecordsetIndexType.Numeric)
            {
                rowIdx = int.Parse(rowIndex);
            }
        }
    }

    public class Schema
    {
        [JsonProperty("type")] public string Type { get; set; }

        [JsonProperty("properties", NullValueHandling = NullValueHandling.Ignore)]
        public IDictionary<string, Schema> Properties { get; set; }
    }
}
---- Transformed Tree ----
using System;
using System.Collections.Generic;
using System.Data;
using System.IO;
using System.Linq;
using System.Text;
using System.Text.RegularExpressions;
using System.Xml;
using System.Xml.Linq;
using Dev2.Common;
using Dev2.Common.ExtMethods;
using Dev2.Common.Interfaces.DB;
using Dev2.Data;
using Dev2.Data.Interfaces.Enums;
using Dev2.Data.Util;
using Dev2.Interfaces;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using Warewolf.Storage.Interfaces;
using WarewolfParserInterop;
using Warewolf.Data;

namespace Dev2
{
    public static class ExecutionEnvironmentUtils
    {
        public static string GetXmlOutputFromEnvironment(IDSFDataObject dataObject, string dataList, int update)
        {
            var jsonOutput = GetJsonForEnvironmentWithColumnIoDirection(dataObject, dataList, enDev2ColumnArgumentDirection.Output, update);
            var xml = JsonConvert.DeserializeXNode(jsonOutput, "DataList", true);
            return xml.ToString();
        }

        static string GetJsonForEnvironmentWithColumnIoDirection(IDSFDataObject dataObject, string dataList, enDev2ColumnArgumentDirection requestIODirection, int update)
        {
            var environment = dataObject.Environment;
            var fixedDataList = dataList.Replace(GlobalConstants.SerializableResourceQuote, "\"").Replace(GlobalConstants.SerializableResourceSingleQuote, "\'");
            var serializeXNode = JsonConvert.SerializeXNode(XDocument.Parse(fixedDataList), Newtonsoft.Json.Formatting.Indented, true);
            if (JsonConvert.DeserializeObject(serializeXNode) is JObject deserializeObject)
            {
                var outputObj = new JObject();
                var props = deserializeObject.Properties().ToList();
                foreach (var prop in props)
                {
                    TryAddPropToOutput(requestIODirection, update, environment, outputObj, prop);
                }

                var dataListString = outputObj.ToString(Newtonsoft.Json.Formatting.Indented);
                return dataListString;
            }

            return "{}";
        }

        private static void TryAddPropToOutput(enDev2ColumnArgumentDirection requestIODirection, int update, IExecutionEnvironment environment, JObject outputObj, JProperty prop)
        {
            if (prop.Value != null && prop.Value.Type == JTokenType.Object)
            {
                var val = prop.Value as JObject;
                var jProperty = val?.Properties().FirstOrDefault(property => property.Name == "@ColumnIODirection");
                if (jProperty != null)
                {
                    var propValue = jProperty.Value;
                    if (Enum.TryParse(propValue.ToString(), true, out enDev2ColumnArgumentDirection ioDirection) && (ioDirection == enDev2ColumnArgumentDirection.Both || ioDirection == requestIODirection))
                    {
                        AddPropToOutput(requestIODirection, update, environment, outputObj, prop, val);
                    }
                }
            }
        }

        private static void AddPropToOutput(enDev2ColumnArgumentDirection requestIODirection, int update, IExecutionEnvironment environment, JObject outputObj, JProperty prop, JObject val)
        {
            var objName = prop.Name;
            var isJson = val.Properties().FirstOrDefault(property => property.Name == "@IsJson");
            if (isJson != null && isJson.Value.ToString() == "True")
            {
                AddObjectsToOutput(environment, objName, outputObj);
            }
            else
            {
                if (prop.Value.Count() > 3)
                {
                    AddRecordsetsToOutput(environment, objName, val, outputObj, requestIODirection, update);
                }
                else
                {
                    AddScalarsToOutput(prop, environment, objName, outputObj, requestIODirection);
                }
            }
        }

        static void AddObjectsToOutput(IExecutionEnvironment environment, string objName, JObject outputObj)
        {
            var evalResult = environment.EvalJContainer("[[@" + objName + "]]");
            if (evalResult != null)
            {
                outputObj.Add(objName, evalResult);
            }
        }

        static void AddScalarsToOutput(JProperty prop, IExecutionEnvironment environment, string objName, JObject outputObj, enDev2ColumnArgumentDirection requestIODirection)
        {
            var v = prop.Value as JObject;
            var ioDire = v?.Properties().FirstOrDefault(property => property.Name == "@ColumnIODirection");
            if (ioDire != null)
            {
                var x = (enDev2ColumnArgumentDirection) Enum.Parse(typeof(enDev2ColumnArgumentDirection), ioDire.Value.ToString());
                if ((x == enDev2ColumnArgumentDirection.Both || x == requestIODirection) && (environment.Eval("[[" + objName + "]]", 0) is CommonFunctions.WarewolfEvalResult.WarewolfAtomResult warewolfEvalResult))
                {
                    ParseDataItemToOutputs(outputObj, objName, warewolfEvalResult.Item);
                }
            }
        }

        static void AddRecordsetsToOutput(IExecutionEnvironment environment, string objName, JObject val, JObject outputObj, enDev2ColumnArgumentDirection requestedIODirection, int update)
        {
            var evalResult = environment.Eval("[[" + objName + "(*)]]", update);
            var newArray = new JArray();
            if (evalResult != null)
            {
                if (evalResult is CommonFunctions.WarewolfEvalResult.WarewolfRecordSetResult res)
                {
                    var data = res.Item.Data;
                    foreach (var dataItem in data)
                    {
                        AddDataItemToOutputs(val, requestedIODirection, newArray, dataItem);
                    }
                }

                outputObj.Add(objName, newArray);
            }
        }

        static void AddDataItemToOutputs(JObject val, enDev2ColumnArgumentDirection requestedIODirection, JArray newArray, KeyValuePair<string, WarewolfAtomList<DataStorage.WarewolfAtom>> dataItem)
        {
            var jObjForArray = new JObject();
            var recCol = val.Properties().FirstOrDefault(property => property.Name == dataItem.Key);
            var io = recCol?.Children().FirstOrDefault() as JObject;
            var p = io?.Properties().FirstOrDefault(token => token.Name == "@ColumnIODirection");
            if (p != null)
            {
                var direction = (enDev2ColumnArgumentDirection) Enum.Parse(typeof(enDev2ColumnArgumentDirection), p.Value.ToString(), true);
                if (direction == enDev2ColumnArgumentDirection.Both || direction == requestedIODirection)
                {
                    var i = 0;
                    foreach (var warewolfAtom in dataItem.Value)
                    {
                        ParseDataItemToOutputs(jObjForArray, dataItem.Key, warewolfAtom);

                        dataItem = CreateDataItem(newArray, dataItem, jObjForArray, i, warewolfAtom);
                        jObjForArray = new JObject();
                        i++;
                    }
                }
            }
        }

        private static KeyValuePair<string, WarewolfAtomList<DataStorage.WarewolfAtom>> CreateDataItem(JArray newArray, KeyValuePair<string, WarewolfAtomList<DataStorage.WarewolfAtom>> dataItem, JObject jObjForArray, int i, DataStorage.WarewolfAtom warewolfAtom)
        {
            if (newArray.Count < i + 1 || newArray.Count == 0)
            {
                newArray.Add(jObjForArray);
            }
            else
            {
                var jToken = newArray[i] as JObject;
                ParseDataItemToOutputs(jToken, dataItem.Key, warewolfAtom);
            }

            return dataItem;
        }

        static void ParseDataItemToOutputs(JObject jObject, string key, DataStorage.WarewolfAtom warewolfAtom)
        {
            if (warewolfAtom is DataStorage.WarewolfAtom.DataString stringResult)
            {
                jObject.Add(key, stringResult.Item);
            }
            else if (warewolfAtom is DataStorage.WarewolfAtom.Int intResult)
            {
                jObject.Add(key, intResult.Item);
            }
            else if (warewolfAtom is DataStorage.WarewolfAtom.Float floatResult)
            {
                jObject.Add(key, floatResult.Item);
            }
            else
            {
                jObject.Add(key, warewolfAtom.ToString());
            }
        }

        public static string GetJsonOutputFromEnvironment(IDSFDataObject dataObject, string dataList, int update) => GetJsonForEnvironmentWithColumnIoDirection(dataObject, dataList, enDev2ColumnArgumentDirection.Output, update);

        public static void UpdateEnvironmentFromXmlPayload(IDSFDataObject dataObject, StringBuilder rawPayload, string dataList, int update)
        {
            var toLoad = rawPayload.ToString().ToCleanXml();
            var xDoc = new XmlDocument();
            toLoad = string.Format("<Tmp{0:N}>{1}</Tmp{0:N}>", Guid.NewGuid(), toLoad);
            xDoc.LoadXml(toLoad);
            if (dataList != null)
            {
                dataList = dataList.Replace("ADL>", "DataList>").Replace("root>", "DataList>");
                if (xDoc.DocumentElement != null)
                {
                    var children = xDoc.DocumentElement.ChildNodes;
                    var dataListTO = new DataListTO(dataList, true);
                    TryLoadXmlIntoEnvironment(dataObject, children, dataListTO.Inputs, update);
                }
            }
        }

        public static void UpdateEnvironmentFromInputPayload(IDSFDataObject dataObject, StringBuilder rawPayload, string dataList)
        {
            dataList = dataList.Replace("ADL>", "DataList>").Replace("root>", "DataList>");
            var dataListTO = new DataListTO(dataList);
            var inputs = dataListTO.Inputs;
            TryUpdateEnviromentWithMappings(dataObject, rawPayload, inputs);
        }

        static void TryUpdateEnviromentWithMappings(IDSFDataObject dataObject, StringBuilder rawPayload, List<string> mappings)
        {
            JObject inputObject;
            var toLoad = rawPayload.ToString();
            if (string.IsNullOrEmpty(toLoad))
            {
                return;
            }

            if (!toLoad.IsJSON())
            {
                toLoad = toLoad.ToCleanXml();
                var sXNode = JsonConvert.SerializeXNode(XDocument.Parse(toLoad), Newtonsoft.Json.Formatting.Indented, true);
                inputObject = JsonConvert.DeserializeObject(sXNode) as JObject;
            }
            else
            {
                inputObject = JsonConvert.DeserializeObject(toLoad) as JObject;
            }

            if (inputObject != null)
            {
                UpdateEnviromentWithMappings(dataObject, mappings, inputObject);
            }
        }

        static void UpdateEnviromentWithMappings(IDSFDataObject dataObject, List<string> mappings, JObject inputObject)
        {
            var recSets = mappings.Where(DataListUtil.IsValueRecordset).ToList();
            var processedRecsets = new List<string>();
            foreach (var input in mappings)
            {
                var inputName = input;
                var isValueRecordset = DataListUtil.IsValueRecordset(input);
                if (isValueRecordset)
                {
                    inputName = DataListUtil.ExtractRecordsetNameFromValue(input);
                    if (processedRecsets.Contains(inputName))
                    {
                        continue;
                    }
                }

                var propsMatching = inputObject.Properties().Where(property => property.Name == inputName).ToList();
                foreach (var prop in propsMatching)
                {
                    var value = prop.Value;
                    var tokenType = value.Type;
                    if (tokenType == JTokenType.Object)
                    {
                        PerformRecordsetUpdate(dataObject, value, processedRecsets, input, recSets, inputName, isValueRecordset);
                    }
                    else if (tokenType == JTokenType.Array)
                    {
                        PerformRecordsetUpdate(dataObject, value, isValueRecordset, input, recSets, inputName, processedRecsets);
                    }
                    else
                    {
                        dataObject.Environment.Assign(DataListUtil.AddBracketsToValueIfNotExist(input), value.ToString(), 0);
                    }
                }
            }
        }

        private static void PerformRecordsetUpdate(IDSFDataObject dataObject, JToken value, List<string> processedRecsets, string input, List<string> recSets, string inputName, bool isValueRecordset)
        {
            if (isValueRecordset)
            {
                var arr = new JArray(value);
                PerformRecordsetUpdate(dataObject, arr, true, input, recSets, inputName, processedRecsets);
            }
            else
            {
                var jContainer = value as JContainer;
                dataObject.Environment.AddToJsonObjects(DataListUtil.AddBracketsToValueIfNotExist("@" + input), jContainer);
            }
        }

        static void PerformRecordsetUpdate(IDSFDataObject dataObject, JToken value, bool isValueRecordset, string input, List<string> recSets, string inputName, List<string> processedRecsets)
        {
            if (!isValueRecordset)
            {
                dataObject.Environment.AddToJsonObjects(DataListUtil.AddBracketsToValueIfNotExist("@" + input + "()"), arrayValue);
            }
            else
            {
                if (value is JArray arrayValue)
                {
                    for (int i = 0; i < arrayValue.Count; i++)
                    {
                        UpdateEnvironmentFromJObject(dataObject, recSets, inputName, i, arrayValue[i]);
                    }

                    processedRecsets.Add(inputName);
                }
            }
        }

        static void UpdateEnvironmentFromJObject(IDSFDataObject dataObject, List<string> recSets, string inputName, int i, JToken val)
        {
            if (val is JObject valObj)
            {
                var recs = recSets.Where(s => DataListUtil.ExtractRecordsetNameFromValue(s) == inputName);
                foreach (var rec in recs)
                {
                    var field = DataListUtil.ExtractFieldNameOnlyFromValue(rec);
                    var fieldProp = valObj.Properties().FirstOrDefault(property => property.Name == field);
                    if (fieldProp != null)
                    {
                        dataObject.Environment.Assign(DataListUtil.AddBracketsToValueIfNotExist(rec), fieldProp.Value.ToString(), i + 1);
                    }
                }
            }
        }

        public static void UpdateEnvironmentFromOutputPayload(IDSFDataObject dataObject, StringBuilder rawPayload, string dataList)
        {
            dataList = dataList.Replace("ADL>", "DataList>").Replace("root>", "DataList>");
            var dataListTO = new DataListTO(dataList);
            var outputs = dataListTO.Outputs;
            TryUpdateEnviromentWithMappings(dataObject, rawPayload, outputs);
        }

        static void TryLoadXmlIntoEnvironment(IDSFDataObject dataObject, XmlNodeList children, List<string> inputDefs, int update, int level = 0)
        {
            try
            {
                LoadXmlIntoEnvironment(dataObject, children, inputDefs, update, level);
            }
            finally
            {
                dataObject.Environment.CommitAssign();
            }
        }

        static void LoadXmlIntoEnvironment(IDSFDataObject dataObject, XmlNodeList children, List<string> inputDefs, int update, int level)
        {
            foreach (XmlNode c in children)
            {
                if (c.Name != GlobalConstants.NaughtyTextNode)
                {
                    if (level > 0)
                    {
                        var c1 = c;
                        var scalars = inputDefs.Where(definition => definition == c1.Name);
                        var recSets = inputDefs.Where(definition => DataListUtil.ExtractRecordsetNameFromValue(definition) == c1.Name);
                        UpdateForRecordset(dataObject, update, recSets, c);
                        UpdateForScalars(dataObject, update, scalars, c);
                    }
                    else
                    {
                        ContinueLoadingXmlIntoEnvironment(dataObject, inputDefs, update, level, c);
                    }
                }
            }
        }

        static void ContinueLoadingXmlIntoEnvironment(IDSFDataObject dataObject, List<string> inputDefs, int update, int level, XmlNode c)
        {
            if (level == 0)
            {
                TryLoadXmlIntoEnvironment(dataObject, c.ChildNodes, inputDefs, update, ++level);
            }
        }

        static void UpdateForScalars(IDSFDataObject dataObject, int update, IEnumerable<string> scalars, XmlNode c)
        {
            var scalarDefs = scalars as string[] ?? scalars.ToArray();
            if (scalarDefs.Length != 0)
            {
                // fetch recordset index
                // process recordset
                var a = c.InnerXml;
                a = RemoveXMLPrefix(a);
                dataObject.Environment.Assign(DataListUtil.AddBracketsToValueIfNotExist(c.Name), a, update);
            }
        }

        static void UpdateForRecordset(IDSFDataObject dataObject, int update, IEnumerable<string> recSets, XmlNode c)
        {
            var recSetDefs = recSets as string[] ?? recSets.ToArray();
            if (recSetDefs.Length != 0)
            {
                var nl = c.ChildNodes;
                foreach (XmlNode subc in nl)
                {
                    foreach (var definition in recSetDefs)
                    {
                        UpdateForChildNodes(dataObject, update, subc, definition);
                    }
                }
            }
        }

        private static void UpdateForChildNodes(IDSFDataObject dataObject, int update, XmlNode subc, string definition)
        {
            if (DataListUtil.IsValueRecordset(definition) && DataListUtil.ExtractFieldNameFromValue(definition) == subc.Name)
            {
                var recSetAppend = DataListUtil.ReplaceRecordsetIndexWithBlank(definition);
                var a = subc.InnerXml;
                a = RemoveXMLPrefix(a);
                dataObject.Environment.AssignWithFrame(new AssignValue(recSetAppend, a), update);
            }
        }

        static string RemoveXMLPrefix(string a)
        {
            if (a.StartsWith(GlobalConstants.XMLPrefix))
            {
                a = a.Replace(GlobalConstants.XMLPrefix, "");
                a = Encoding.UTF8.GetString(System.Convert.FromBase64String(a));
            }

            return a;
        }

        public static string GetXmlInputFromEnvironment(IDSFDataObject dataObject, string dataList, int update)
        {
            var xml = JsonConvert.DeserializeXNode(GetJsonForEnvironmentWithColumnIoDirection(dataObject, dataList, enDev2ColumnArgumentDirection.Input, update), "DataList", true);
            return xml.ToString();
        }

        public static string GetOpenAPIOutputForService(IWarewolfResource resource, string dataList, string webServerUrl)
        {
            if (resource == null)
            {
                throw new ArgumentNullException(nameof(resource));
            }

            if (string.IsNullOrEmpty(dataList))
            {
                throw new ArgumentNullException(nameof(dataList));
            }

            Uri.TryCreate(webServerUrl, UriKind.RelativeOrAbsolute, out Uri url);
            var jsonOpenAPIInfoObject = BuildJsonOpenAPIInfoObject(resource);
            var jsonOpenAPIServerObject = BuildJsonOpenAPIServerObject(url);
            var jsonOpenAPIPathObject = BuildJsonOpenAPIPathObject(url, dataList);
            var jsonOpenAPIObject = BuildJsonOpenAPIObject(jsonOpenAPIInfoObject, jsonOpenAPIServerObject, jsonOpenAPIPathObject);
            var resultString = GetSerializedOpenAPIObject(jsonOpenAPIObject);
            return resultString;
        }

        public static string GetOpenAPIOutputForServiceList(IList<IWarewolfResource> resourceList,
            string webServerUrl)
        {
            if (resourceList == null)
            {
                throw new ArgumentNullException(nameof(resourceList));
            }
            
            if (string.IsNullOrEmpty(webServerUrl))
            {
                throw new ArgumentNullException(nameof(webServerUrl));
            }

            var paths = new List<JObject>();
            foreach (var resource in resourceList)
            {
                var filePath1 = webServerUrl;
                filePath1 = filePath1.Substring(0, filePath1.IndexOf("secure", StringComparison.Ordinal) + 6);

                var filePath2 = resource.FilePath;
                filePath2 = filePath2.Substring(filePath2.IndexOf("Resources", StringComparison.Ordinal) + 10)
                    .Replace(".bite", ".api");

                Uri.TryCreate($"{filePath1}/{filePath2}", UriKind.RelativeOrAbsolute, out Uri url);
                paths.Add(BuildJsonOpenAPIPathObject(url, resource.DataList.ToString()));
            }
            
            var info =  new JObject
            {
                {"title", new JValue(webServerUrl)},
                {"description", new JValue(webServerUrl)},
                {"version", "1"}
            };
            
            var jsonOpenAPIObject = new JObject
            {
                {"openapi", new JValue(EnvironmentVariables.OpenAPiVersion)},
                {"info", info},
                {"servers", new JArray(BuildJsonOpenAPIServerObject(new Uri(webServerUrl)))},
                {"paths", new JArray(paths)}
            };
            var serializedObject = GetSerializedOpenAPIObject(jsonOpenAPIObject);
            serializedObject = RemovePathsArray(serializedObject);

            return serializedObject;
        }

        static string RemovePathsArray(string apiObject)
        {
            apiObject = apiObject.Replace("\"paths\": [", "\"paths\": ");
            apiObject = apiObject.Replace("},\r\n    {\r\n      \"/secure", ",\r\n      \"/secure");
            apiObject = apiObject.Remove(apiObject.LastIndexOf("]"), 1);
            return apiObject;
        }

        static string GetSerializedOpenAPIObject(JObject jsonOpenAPIObject)
        {
            var converter = new JsonSerializer();
            var result = new StringBuilder();
            var jsonTextWriter = new JsonTextWriter(new StringWriter(result)) {Formatting = Newtonsoft.Json.Formatting.Indented};
            converter.Serialize(jsonTextWriter, jsonOpenAPIObject);
            jsonTextWriter.Flush();
            var resultString = Regex.Replace(result.ToString(), @"^\s+$[\r\n]*", "", RegexOptions.Multiline);
            return resultString;
        }

        static JObject BuildJsonOpenAPIObject(JObject jsonOpenAPIInfoObject, JObject jsonOpenAPIServerObject, JObject jsonOpenAPIPathObject)
        {
            var jsonOpenAPIObject = new JObject
            {
                {"openapi", new JValue(EnvironmentVariables.OpenAPiVersion)},
                {"info", jsonOpenAPIInfoObject},
                {"servers", new JArray(jsonOpenAPIServerObject)},
                {"paths", jsonOpenAPIPathObject}
            };
            return jsonOpenAPIObject;
        }

        static JObject BuildJsonOpenAPIServerObject(Uri url)
        {
            var jsonOpenAPIServerObject = new JObject
            {
                {"url", new JValue(url.Scheme + "://" + url.Host)}
            };
            return jsonOpenAPIServerObject;
        }

        static JObject BuildJsonOpenAPIInfoObject(IWarewolfResource resource)
        {
            var versionValue = resource.VersionInfo != null ? new JValue(resource.VersionInfo.VersionNumber) : new JValue("1.0.0");

            var jsonOpenAPIInfoObject = new JObject
            {
                {"title", new JValue(resource.ResourceName)},
                {"description", new JValue(resource.ResourceName)},
                {"version", versionValue}
            };
            return jsonOpenAPIInfoObject;
        }

        static JObject BuildJsonOpenAPIPathObject(Uri path, string dataList)
        {
            var parametersObject = BuildParametersObject(dataList);
            var responseObject = BuildJsonOpenAPIResponsesObject(dataList);
            var pathGetObject = new JObject
            {
                {
                    "get", new JObject
                    {
                        {"tags", new JArray("")},
                        {"description", new JValue("")},
                        {"parameters", parametersObject},
                        {"responses", responseObject}
                    }
                }
            };

            var pathObject = new JObject
            {
                {path.AbsolutePath.Replace(".api", ""), pathGetObject}
            };
            return pathObject;
        }

        static JToken BuildParametersObject(string dataList)
        {
            JArray arrayObj = new JArray();
            var dataListTo = new DataListTO(dataList);

            var scalarInputs = dataListTo.Inputs.Where(s => !DataListUtil.IsValueRecordset(s));
            foreach (var input in scalarInputs)
            {
                var inputObject = new JObject
                {
                    {"name", input},
                    {"in", "query"},
                    {"required", true},
                    {
                        "schema", new JObject
                        {
                            {"type", "string"}
                        }
                    }
                };
                arrayObj.Add(inputObject);
            }

            var recSetInputs = dataListTo.Inputs.Where(DataListUtil.IsValueRecordset).ToList();
            var groupedRecSets = recSetInputs.GroupBy(DataListUtil.ExtractRecordsetNameFromValue);
            foreach (var groupedRecSet in groupedRecSets)
            {
                var recSetName = groupedRecSet.Key;
                var propObject = BuildPropertyDefinition(groupedRecSet);
                var recSchemaObject = new Schema
                {
                    Type = "object",
                    Properties = propObject
                };
                var serializedSchema = JsonConvert.SerializeObject(recSchemaObject);
                var deserializedSchema = JsonConvert.DeserializeObject(serializedSchema) as JToken;
                var recObject = new JObject
                {
                    {"name", recSetName},
                    {"in", "query"},
                    {"required", true},
                    {"schema", deserializedSchema}
                };
                arrayObj.Add(recObject);
            }

            var serialized = JsonConvert.SerializeObject(arrayObj);
            var des = JsonConvert.DeserializeObject(serialized) as JToken;
            var definitionObject = des;
            return definitionObject;
        }

        static JObject BuildJsonOpenAPIResponsesObject(string dataList)
        {
            var jsonOpenAPIResponsesObject = new JObject
            {
                {
                    "200", new JObject
                    {
                        {"description", new JValue("Success")},
                        {
                            "content", new JObject
                            {
                                {
                                    "application/json", BuildResponseSchema(dataList)
                                }
                            }
                        }
                    }
                }
            };
            return jsonOpenAPIResponsesObject;
        }

        private static JToken BuildResponseSchema(string dataList)
        {
            var dataListTo = new DataListTO(dataList);
            var scalarOutputs = dataListTo.Outputs.Where(s => !DataListUtil.IsValueRecordset(s));
            var recSetOutputs = dataListTo.Outputs.Where(DataListUtil.IsValueRecordset);

            var propertiesObject = scalarOutputs.ToDictionary(scalarInput => scalarInput, scalarInput => new Schema {Type = "string"});
            var groupedRecSets = recSetOutputs.GroupBy(DataListUtil.ExtractRecordsetNameFromValue);
            foreach (var groupedRecSet in groupedRecSets)
            {
                var recSetName = groupedRecSet.Key;
                var propObject = BuildPropertyDefinition(groupedRecSet);

                var recObject = new Schema
                {
                    Type = "object",
                    Properties = propObject
                };
                propertiesObject.Add(recSetName, recObject);
            }

            var responseSchema = new Dictionary<string, Schema>
            {
                {
                    "schema", new Schema
                    {
                        Type = "object",
                        Properties = propertiesObject,
                    }
                }
            };
            var serialized = JsonConvert.SerializeObject(responseSchema);
            var definitionObject = JsonConvert.DeserializeObject(serialized) as JToken;
            var res = definitionObject;
            return res;
        }

        static Dictionary<string, Schema> BuildPropertyDefinition(IGrouping<string, string> groupedRecSet) => groupedRecSet.ToDictionary(DataListUtil.ExtractFieldNameOnlyFromValue, name => new Schema
        {
            Type = "string"
        });


        public static void ProcessOutputMapping(IExecutionEnvironment environment, int update, ref bool started, ref int rowIdx, DataRow row, IServiceOutputMapping serviceOutputMapping)
        {
            var rsType = DataListUtil.GetRecordsetIndexType(serviceOutputMapping.MappedTo);
            var rowIndex = DataListUtil.ExtractIndexRegionFromRecordset(serviceOutputMapping.MappedTo);

            var rs = serviceOutputMapping.RecordSetName;
            if (!string.IsNullOrEmpty(rs) && environment.HasRecordSet(DataListUtil.AddBracketsToValueIfNotExist(DataListUtil.MakeValueIntoHighLevelRecordset(rs, rsType == enRecordsetIndexType.Star))))
            {
                if (started)
                {
                    rowIdx = environment.GetLength(rs) + 1;
                    started = false;
                }
            }
            else
            {
                try
                {
                    environment.AssignDataShape(serviceOutputMapping.MappedTo);
                }
                catch (Exception e)
                {
                    Dev2Logger.Error(e, GlobalConstants.WarewolfError);
                }
            }

            GetRowIndex(ref started, ref rowIdx, rsType, rowIndex);
            if (!row.Table.Columns.Contains(serviceOutputMapping.MappedFrom))
            {
                return;
            }

            var value = row[serviceOutputMapping.MappedFrom];

            var colDataType = row.Table.Columns[serviceOutputMapping.MappedFrom].DataType;
            if (colDataType.Name == "Byte[]")
            {
                value = Encoding.UTF8.GetString(value as byte[]);
            }

            if (update != 0)
            {
                rowIdx = update;
            }

            var displayExpression = DataListUtil.ReplaceRecordsetBlankWithIndex(DataListUtil.AddBracketsToValueIfNotExist(serviceOutputMapping.MappedTo), rowIdx);
            if (rsType == enRecordsetIndexType.Star)
            {
                displayExpression = DataListUtil.ReplaceStarWithFixedIndex(displayExpression, rowIdx);
            }

            environment.Assign(displayExpression, value.ToString(), update);
        }

        static void GetRowIndex(ref bool started, ref int rowIdx, enRecordsetIndexType rsType, string rowIndex)
        {
            if (rsType == enRecordsetIndexType.Star && started)
            {
                rowIdx = 1;
                started = false;
            }

            if (rsType == enRecordsetIndexType.Numeric)
            {
                rowIdx = int.Parse(rowIndex);
            }
        }
    }

    public class Schema
    {
        [JsonProperty("type")] public string Type { get; set; }

        [JsonProperty("properties", NullValueHandling = NullValueHandling.Ignore)]
        public IDictionary<string, Schema> Properties { get; set; }
    }
}
---- Semantic diagnostics *before* transformation ----
D:\a\1\s\Dev\Dev2.Core\ExecutionEnvironmentUtils.cs(145,162): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Core\ExecutionEnvironmentUtils.cs(169,159): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Core\ExecutionEnvironmentUtils.cs(169,225): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Core\ExecutionEnvironmentUtils.cs(169,62): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Core\ExecutionEnvironmentUtils.cs(184,73): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Core\ExecutionEnvironmentUtils.cs(119,94): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Core\ExecutionEnvironmentUtils.cs(119,140): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Core\ExecutionEnvironmentUtils.cs(128,30): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Core\ExecutionEnvironmentUtils.cs(132,35): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Core\ExecutionEnvironmentUtils.cs(186,33): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Core\ExecutionEnvironmentUtils.cs(190,38): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Core\ExecutionEnvironmentUtils.cs(194,38): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?)
---- Semantic diagnostics *after* transformation ----
D:\a\1\s\Dev\Dev2.Core\ExecutionEnvironmentUtils.cs(145,162): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Core\ExecutionEnvironmentUtils.cs(169,159): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Core\ExecutionEnvironmentUtils.cs(169,225): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Core\ExecutionEnvironmentUtils.cs(169,62): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Core\ExecutionEnvironmentUtils.cs(184,73): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Core\ExecutionEnvironmentUtils.cs(119,94): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Core\ExecutionEnvironmentUtils.cs(119,140): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Core\ExecutionEnvironmentUtils.cs(128,30): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Core\ExecutionEnvironmentUtils.cs(132,35): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Core\ExecutionEnvironmentUtils.cs(186,33): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Core\ExecutionEnvironmentUtils.cs(190,38): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Core\ExecutionEnvironmentUtils.cs(194,38): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Core\ExecutionEnvironmentUtils.cs(314,120): error CS0103: The name 'arrayValue' does not exist in the current context
######################################################################


######################################################################
Nr: 11 - UsePatternMatchingRewriterR8
Filepath: D:\a\1\s\Dev\Dev2.Runtime\ESB\Control\EnvironmentOutputMappingManager.cs
Description: Error: The created Syntax Tree is semantically incorrect.
------------------------------------------------------------------------
---- Original Tree ----
using System.Collections.Generic;
using System.Linq;
using Dev2.Common.Interfaces.Data;
using Dev2.Data.Interfaces;
using Dev2.Data.Interfaces.Enums;
using Dev2.Data.TO;
using Dev2.Data.Util;
using Dev2.DataList.Contract;
using Dev2.Interfaces;
using Warewolf.Storage;
using Warewolf.Storage.Interfaces;

namespace Dev2.Runtime.ESB.Control
{
    public class EnvironmentOutputMappingManager : IEnvironmentOutputMappingManager
    {
        readonly IDataListFactory _dataListFactory;
        public EnvironmentOutputMappingManager()
            : this(DataListFactory.Instance)
        {
        }
        public EnvironmentOutputMappingManager(IDataListFactory dataListFactory)
        {
            _dataListFactory = dataListFactory;
        }

        public IExecutionEnvironment UpdatePreviousEnvironmentWithSubExecutionResultUsingOutputMappings(IDSFDataObject dataObject, string outputDefs, int update, bool handleErrors, ErrorResultTO errors)
        {
            var innerEnvironment = dataObject.Environment;
            dataObject.PopEnvironment();
            OutputsToEnvironment(innerEnvironment, dataObject.Environment, outputDefs, update);
            if (innerEnvironment.HasErrors() && !handleErrors)
            {
                CopyErrors(dataObject, errors, innerEnvironment);
            }
            if (innerEnvironment.HasErrors() && handleErrors)
            {
                CopyErrorsAndHandleThem(dataObject, errors, innerEnvironment);
            }
            return innerEnvironment;
        }

        private static void CopyErrors(IDSFDataObject dataObject, ErrorResultTO errors, IExecutionEnvironment innerEnvironment)
        {
            foreach (var error in innerEnvironment.AllErrors)
            {
                if (!dataObject.Environment.AllErrors.Contains(error))
                {
                    dataObject.Environment.AllErrors.Add(error);
                    errors.AddError(error);
                }
            }
            foreach (var error in innerEnvironment.Errors)
            {
                if (!dataObject.Environment.AllErrors.Contains(error))
                {
                    dataObject.Environment.AllErrors.Add(error);
                    errors.AddError(error);
                }
            }
        }

        private static void CopyErrorsAndHandleThem(IDSFDataObject dataObject, ErrorResultTO errors, IExecutionEnvironment innerEnvironment)
        {
            foreach (var error in innerEnvironment.AllErrors)
            {
                if (!dataObject.Environment.AllErrors.Contains(error))
                {

                    errors.AddError(error);
                }
            }
            foreach (var error in innerEnvironment.Errors)
            {
                if (!dataObject.Environment.AllErrors.Contains(error))
                {

                    errors.AddError(error);
                }
            }
        }

        void OutputsToEnvironment(IExecutionEnvironment innerEnvironment, IExecutionEnvironment environment, string outputDefs, int update)
        {
            try
            {
                var outputs = _dataListFactory.CreateOutputParser().Parse(outputDefs);
                var outputRecSets = _dataListFactory.CreateRecordSetCollection(outputs, true);
                var outputScalarList = _dataListFactory.CreateScalarList(outputs, true);
                var outputComplexObjectList = _dataListFactory.CreateObjectList(outputs);
                TryEvalAssignRecordSets(innerEnvironment, environment, update, outputRecSets, outputs);
                TryEvalAssignScalars(innerEnvironment, environment, update, outputScalarList);
                TryEvalAssignComplexObjects(innerEnvironment, environment, outputComplexObjectList);
            }
            finally
            {
                environment.CommitAssign();
            }

        }

        static void TryEvalAssignComplexObjects(IExecutionEnvironment innerEnvironment, IExecutionEnvironment environment, IEnumerable<IDev2Definition> outputComplexObjectList)
        {
            foreach (var dev2Definition in outputComplexObjectList)
            {
                if (dev2Definition.IsObject)
                {
                    EvalAssignComplexObjects(innerEnvironment, environment, dev2Definition);
                }
            }
        }

        static void TryEvalAssignScalars(IExecutionEnvironment innerEnvironment, IExecutionEnvironment environment, int update, IEnumerable<IDev2Definition> outputScalarList)
        {
            foreach (var dev2Definition in outputScalarList)
            {
                if (!dev2Definition.IsRecordSet && !dev2Definition.IsObject)
                {
                    EvalAssignScalars(innerEnvironment, environment, update, dev2Definition);
                }
            }
        }

        static void TryEvalAssignRecordSets(IExecutionEnvironment innerEnvironment, IExecutionEnvironment environment, int update, IRecordSetCollection outputRecSets, IList<IDev2Definition> outputs)
        {
            foreach (var recordSetDefinition in outputRecSets.RecordSets)
            {
                var outPutRecSet = outputs.FirstOrDefault(definition => definition.IsRecordSet && definition.RecordSetName == recordSetDefinition.SetName);
                if (outPutRecSet != null)
                {
                    foreach (var outputColumnDefinitions in recordSetDefinition.Columns)
                    {
                        EvalAssignRecordSets(innerEnvironment, environment, update, outPutRecSet, outputColumnDefinitions);
                    }
                }
            }
        }

        static void EvalAssignComplexObjects(IExecutionEnvironment innerEnvironment, IExecutionEnvironment environment, IDev2Definition dev2Definition)
        {
            var warewolfEvalResult = innerEnvironment.EvalJContainer(DataListUtil.AddBracketsToValueIfNotExist(dev2Definition.Name));
            if (warewolfEvalResult != null)
            {
                environment.AddToJsonObjects(DataListUtil.AddBracketsToValueIfNotExist(dev2Definition.Value), warewolfEvalResult);
            }
        }

        static void EvalAssignScalars(IExecutionEnvironment innerEnvironment, IExecutionEnvironment environment, int update, IDev2Definition dev2Definition)
        {
            var warewolfEvalResult = innerEnvironment.Eval(DataListUtil.AddBracketsToValueIfNotExist(dev2Definition.Name), update);
            if (warewolfEvalResult.IsWarewolfAtomListresult)
            {
                if (warewolfEvalResult is CommonFunctions.WarewolfEvalResult.WarewolfAtomListresult data && data.Item.Any())
                {
                    environment.Assign("[[" + dev2Definition.Value + "]]", ExecutionEnvironment.WarewolfAtomToString(data.Item.Last()), update);
                }
            }
            else
            {
                if (warewolfEvalResult is CommonFunctions.WarewolfEvalResult.WarewolfAtomResult data)
                {
                    environment.Assign(DataListUtil.AddBracketsToValueIfNotExist(dev2Definition.Value), ExecutionEnvironment.WarewolfAtomToString(data.Item), update);
                }
            }
        }

        static void EvalAssignRecordSets(IExecutionEnvironment innerEnvironment, IExecutionEnvironment environment, int update, IDev2Definition outPutRecSet, IDev2Definition outputColumnDefinitions)
        {
            var correctRecSet = "[[" + outputColumnDefinitions.RecordSetName + "(*)." + outputColumnDefinitions.Name + "]]";
            var warewolfEvalResult = innerEnvironment.Eval(correctRecSet, 0);
            if (warewolfEvalResult.IsWarewolfAtomListresult)
            {
                var recsetResult = warewolfEvalResult as CommonFunctions.WarewolfEvalResult.WarewolfAtomListresult;
                if (outPutRecSet.IsRecordSet)
                {
                    var enRecordsetIndexType = DataListUtil.GetRecordsetIndexType(outputColumnDefinitions.RawValue);
                    if (enRecordsetIndexType == enRecordsetIndexType.Star && recsetResult != null)
                    {
                        environment.EvalAssignFromNestedStar(outputColumnDefinitions.RawValue, recsetResult, update);
                    }

                    if (enRecordsetIndexType == enRecordsetIndexType.Blank && recsetResult != null)
                    {
                        environment.EvalAssignFromNestedLast(outputColumnDefinitions.RawValue, recsetResult, 0);
                    }

                    if (enRecordsetIndexType == enRecordsetIndexType.Numeric && recsetResult != null)
                    {
                        environment.EvalAssignFromNestedNumeric(outputColumnDefinitions.RawValue, recsetResult, 0);
                    }
                }
            }
        }
    }
}
---- Transformed Tree ----
using System.Collections.Generic;
using System.Linq;
using Dev2.Common.Interfaces.Data;
using Dev2.Data.Interfaces;
using Dev2.Data.Interfaces.Enums;
using Dev2.Data.TO;
using Dev2.Data.Util;
using Dev2.DataList.Contract;
using Dev2.Interfaces;
using Warewolf.Storage;
using Warewolf.Storage.Interfaces;

namespace Dev2.Runtime.ESB.Control
{
    public class EnvironmentOutputMappingManager : IEnvironmentOutputMappingManager
    {
        readonly IDataListFactory _dataListFactory;
        public EnvironmentOutputMappingManager()
            : this(DataListFactory.Instance)
        {
        }
        public EnvironmentOutputMappingManager(IDataListFactory dataListFactory)
        {
            _dataListFactory = dataListFactory;
        }

        public IExecutionEnvironment UpdatePreviousEnvironmentWithSubExecutionResultUsingOutputMappings(IDSFDataObject dataObject, string outputDefs, int update, bool handleErrors, ErrorResultTO errors)
        {
            var innerEnvironment = dataObject.Environment;
            dataObject.PopEnvironment();
            OutputsToEnvironment(innerEnvironment, dataObject.Environment, outputDefs, update);
            if (innerEnvironment.HasErrors() && !handleErrors)
            {
                CopyErrors(dataObject, errors, innerEnvironment);
            }
            if (innerEnvironment.HasErrors() && handleErrors)
            {
                CopyErrorsAndHandleThem(dataObject, errors, innerEnvironment);
            }
            return innerEnvironment;
        }

        private static void CopyErrors(IDSFDataObject dataObject, ErrorResultTO errors, IExecutionEnvironment innerEnvironment)
        {
            foreach (var error in innerEnvironment.AllErrors)
            {
                if (!dataObject.Environment.AllErrors.Contains(error))
                {
                    dataObject.Environment.AllErrors.Add(error);
                    errors.AddError(error);
                }
            }
            foreach (var error in innerEnvironment.Errors)
            {
                if (!dataObject.Environment.AllErrors.Contains(error))
                {
                    dataObject.Environment.AllErrors.Add(error);
                    errors.AddError(error);
                }
            }
        }

        private static void CopyErrorsAndHandleThem(IDSFDataObject dataObject, ErrorResultTO errors, IExecutionEnvironment innerEnvironment)
        {
            foreach (var error in innerEnvironment.AllErrors)
            {
                if (!dataObject.Environment.AllErrors.Contains(error))
                {

                    errors.AddError(error);
                }
            }
            foreach (var error in innerEnvironment.Errors)
            {
                if (!dataObject.Environment.AllErrors.Contains(error))
                {

                    errors.AddError(error);
                }
            }
        }

        void OutputsToEnvironment(IExecutionEnvironment innerEnvironment, IExecutionEnvironment environment, string outputDefs, int update)
        {
            try
            {
                var outputs = _dataListFactory.CreateOutputParser().Parse(outputDefs);
                var outputRecSets = _dataListFactory.CreateRecordSetCollection(outputs, true);
                var outputScalarList = _dataListFactory.CreateScalarList(outputs, true);
                var outputComplexObjectList = _dataListFactory.CreateObjectList(outputs);
                TryEvalAssignRecordSets(innerEnvironment, environment, update, outputRecSets, outputs);
                TryEvalAssignScalars(innerEnvironment, environment, update, outputScalarList);
                TryEvalAssignComplexObjects(innerEnvironment, environment, outputComplexObjectList);
            }
            finally
            {
                environment.CommitAssign();
            }

        }

        static void TryEvalAssignComplexObjects(IExecutionEnvironment innerEnvironment, IExecutionEnvironment environment, IEnumerable<IDev2Definition> outputComplexObjectList)
        {
            foreach (var dev2Definition in outputComplexObjectList)
            {
                if (dev2Definition.IsObject)
                {
                    EvalAssignComplexObjects(innerEnvironment, environment, dev2Definition);
                }
            }
        }

        static void TryEvalAssignScalars(IExecutionEnvironment innerEnvironment, IExecutionEnvironment environment, int update, IEnumerable<IDev2Definition> outputScalarList)
        {
            foreach (var dev2Definition in outputScalarList)
            {
                if (!dev2Definition.IsRecordSet && !dev2Definition.IsObject)
                {
                    EvalAssignScalars(innerEnvironment, environment, update, dev2Definition);
                }
            }
        }

        static void TryEvalAssignRecordSets(IExecutionEnvironment innerEnvironment, IExecutionEnvironment environment, int update, IRecordSetCollection outputRecSets, IList<IDev2Definition> outputs)
        {
            foreach (var recordSetDefinition in outputRecSets.RecordSets)
            {
                var outPutRecSet = outputs.FirstOrDefault(definition => definition.IsRecordSet && definition.RecordSetName == recordSetDefinition.SetName);
                if (outPutRecSet != null)
                {
                    foreach (var outputColumnDefinitions in recordSetDefinition.Columns)
                    {
                        EvalAssignRecordSets(innerEnvironment, environment, update, outPutRecSet, outputColumnDefinitions);
                    }
                }
            }
        }

        static void EvalAssignComplexObjects(IExecutionEnvironment innerEnvironment, IExecutionEnvironment environment, IDev2Definition dev2Definition)
        {
            var warewolfEvalResult = innerEnvironment.EvalJContainer(DataListUtil.AddBracketsToValueIfNotExist(dev2Definition.Name));
            if (warewolfEvalResult != null)
            {
                environment.AddToJsonObjects(DataListUtil.AddBracketsToValueIfNotExist(dev2Definition.Value), warewolfEvalResult);
            }
        }

        static void EvalAssignScalars(IExecutionEnvironment innerEnvironment, IExecutionEnvironment environment, int update, IDev2Definition dev2Definition)
        {
            var warewolfEvalResult = innerEnvironment.Eval(DataListUtil.AddBracketsToValueIfNotExist(dev2Definition.Name), update);
            if (warewolfEvalResult.IsWarewolfAtomListresult)
            {
                if (warewolfEvalResult is CommonFunctions.WarewolfEvalResult.WarewolfAtomListresult data && data.Item.Any())
                {
                    environment.Assign("[[" + dev2Definition.Value + "]]", ExecutionEnvironment.WarewolfAtomToString(data.Item.Last()), update);
                }
            }
            else
            {
                if (warewolfEvalResult is CommonFunctions.WarewolfEvalResult.WarewolfAtomResult data)
                {
                    environment.Assign(DataListUtil.AddBracketsToValueIfNotExist(dev2Definition.Value), ExecutionEnvironment.WarewolfAtomToString(data.Item), update);
                }
            }
        }

        static void EvalAssignRecordSets(IExecutionEnvironment innerEnvironment, IExecutionEnvironment environment, int update, IDev2Definition outPutRecSet, IDev2Definition outputColumnDefinitions)
        {
            var correctRecSet = "[[" + outputColumnDefinitions.RecordSetName + "(*)." + outputColumnDefinitions.Name + "]]";
            var warewolfEvalResult = innerEnvironment.Eval(correctRecSet, 0);
            if (warewolfEvalResult.IsWarewolfAtomListresult)
            {
                if (outPutRecSet.IsRecordSet)
                {
                    var enRecordsetIndexType = DataListUtil.GetRecordsetIndexType(outputColumnDefinitions.RawValue);

                    if (enRecordsetIndexType == enRecordsetIndexType.Star && warewolfEvalResult is CommonFunctions.WarewolfEvalResult.WarewolfAtomListresult recsetResult)
                    {
                        environment.EvalAssignFromNestedStar(outputColumnDefinitions.RawValue, recsetResult, update);
                    }

                    if (enRecordsetIndexType == enRecordsetIndexType.Blank && warewolfEvalResult is CommonFunctions.WarewolfEvalResult.WarewolfAtomListresult recsetResult)
                    {
                        environment.EvalAssignFromNestedLast(outputColumnDefinitions.RawValue, recsetResult, 0);
                    }

                    if (enRecordsetIndexType == enRecordsetIndexType.Numeric && warewolfEvalResult is CommonFunctions.WarewolfEvalResult.WarewolfAtomListresult recsetResult)
                    {
                        environment.EvalAssignFromNestedNumeric(outputColumnDefinitions.RawValue, recsetResult, 0);
                    }
                }
            }
        }
    }
}
---- Semantic diagnostics *before* transformation ----
D:\a\1\s\Dev\Dev2.Runtime\ESB\Control\EnvironmentOutputMappingManager.cs(161,38): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Runtime\ESB\Control\EnvironmentOutputMappingManager.cs(164,43): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Runtime\ESB\Control\EnvironmentOutputMappingManager.cs(166,76): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Runtime\ESB\Control\EnvironmentOutputMappingManager.cs(171,43): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Runtime\ESB\Control\EnvironmentOutputMappingManager.cs(173,105): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Runtime\ESB\Control\EnvironmentOutputMappingManager.cs(181,38): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Runtime\ESB\Control\EnvironmentOutputMappingManager.cs(184,58): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Runtime\ESB\Control\EnvironmentOutputMappingManager.cs(190,25): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Runtime\ESB\Control\EnvironmentOutputMappingManager.cs(195,25): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Runtime\ESB\Control\EnvironmentOutputMappingManager.cs(200,25): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?)
---- Semantic diagnostics *after* transformation ----
D:\a\1\s\Dev\Dev2.Runtime\ESB\Control\EnvironmentOutputMappingManager.cs(161,38): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Runtime\ESB\Control\EnvironmentOutputMappingManager.cs(164,43): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Runtime\ESB\Control\EnvironmentOutputMappingManager.cs(166,76): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Runtime\ESB\Control\EnvironmentOutputMappingManager.cs(171,43): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Runtime\ESB\Control\EnvironmentOutputMappingManager.cs(173,105): error CS0246: The type or namespace name 'DataStorage' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Runtime\ESB\Control\EnvironmentOutputMappingManager.cs(181,38): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Runtime\ESB\Control\EnvironmentOutputMappingManager.cs(188,100): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Runtime\ESB\Control\EnvironmentOutputMappingManager.cs(190,25): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Runtime\ESB\Control\EnvironmentOutputMappingManager.cs(193,101): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Runtime\ESB\Control\EnvironmentOutputMappingManager.cs(193,159): error CS0128: A local variable or function named 'recsetResult' is already defined in this scope,D:\a\1\s\Dev\Dev2.Runtime\ESB\Control\EnvironmentOutputMappingManager.cs(195,25): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Runtime\ESB\Control\EnvironmentOutputMappingManager.cs(198,103): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?),D:\a\1\s\Dev\Dev2.Runtime\ESB\Control\EnvironmentOutputMappingManager.cs(198,161): error CS0128: A local variable or function named 'recsetResult' is already defined in this scope,D:\a\1\s\Dev\Dev2.Runtime\ESB\Control\EnvironmentOutputMappingManager.cs(200,25): error CS0246: The type or namespace name 'CommonFunctions' could not be found (are you missing a using directive or an assembly reference?)
######################################################################


######################################################################
Nr: 12 - UsePatternMatchingRewriterR8
Filepath: D:\a\1\s\Dev\Dev2.Runtime.Configuration\CustomControls\AutoCompleteBox.cs
Description: Error: The created Syntax Tree is semantically incorrect.
------------------------------------------------------------------------
---- Original Tree ----
using System.Collections;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Diagnostics.CodeAnalysis;
using System.Globalization;
using System.Linq;
using System.Windows.Automation.Peers;
using System.Windows.Controls.Primitives;
using System.Windows.Data;
using System.Windows.Input;
using System.Windows.Markup;
using System.Windows.Media;
using System.Windows.Threading;

namespace System.Windows.Controls
{
    [TemplatePart(Name = nameof(SelectionAdapter), Type = typeof(ISelectionAdapter))]
    [TemplatePart(Name = "Selector", Type = typeof(Selector))]
    [TemplatePart(Name = nameof(Text), Type = typeof(TextBox))]
    [TemplatePart(Name = "Popup", Type = typeof(Popup))]
    [StyleTypedProperty(Property = nameof(TextBoxStyle), StyleTargetType = typeof(TextBox))]
    [StyleTypedProperty(Property = nameof(ItemContainerStyle), StyleTargetType = typeof(ListBox))]
    [TemplateVisualState(Name = VisualStates.StateNormal, GroupName = VisualStates.GroupCommon)]
    [TemplateVisualState(Name = VisualStates.StateMouseOver, GroupName = VisualStates.GroupCommon)]
    [TemplateVisualState(Name = VisualStates.StatePressed, GroupName = VisualStates.GroupCommon)]
    [TemplateVisualState(Name = VisualStates.StateDisabled, GroupName = VisualStates.GroupCommon)]
    [TemplateVisualState(Name = VisualStates.StateFocused, GroupName = VisualStates.GroupFocus)]
    [TemplateVisualState(Name = VisualStates.StateUnfocused, GroupName = VisualStates.GroupFocus)]
    [TemplateVisualState(Name = VisualStates.StatePopupClosed, GroupName = VisualStates.GroupPopup)]
    [TemplateVisualState(Name = VisualStates.StatePopupOpened, GroupName = VisualStates.GroupPopup)]
    [TemplateVisualState(Name = VisualStates.StateValid, GroupName = VisualStates.GroupValidation)]
    [TemplateVisualState(Name = VisualStates.StateInvalidFocused, GroupName = VisualStates.GroupValidation)]
    [TemplateVisualState(Name = VisualStates.StateInvalidUnfocused, GroupName = VisualStates.GroupValidation)]
    [SuppressMessage("Microsoft.Maintainability", "CA1506:AvoidExcessiveClassCoupling", Justification = "Large implementation keeps the components contained.")]
    [ContentProperty("ItemsSource")]
    public class AutoCompleteBox : Control, IUpdateVisualState
    {
        List<object> _items;
        ObservableCollection<object> _view;
        int _ignoreTextPropertyChange;
        bool _ignorePropertyChange;
        bool _ignoreTextSelectionChange;
        bool _skipSelectedItemTextUpdate;
        int _textSelectionStart;
        bool _userCalledPopulate;
        bool _popupHasOpened;
        DispatcherTimer _delayTimer;
        bool _allowWrite;
        internal InteractionHelper Interaction { get; set; }
        BindingEvaluator<string> _valueBindingEvaluator;

        public int MinimumPrefixLength
        {
            get => (int)GetValue(MinimumPrefixLengthProperty);
            set => SetValue(MinimumPrefixLengthProperty, value);
        }

        public static readonly DependencyProperty MinimumPrefixLengthProperty =
            DependencyProperty.Register(nameof(MinimumPrefixLength), typeof(int), typeof(AutoCompleteBox), new PropertyMetadata(1, OnMinimumPrefixLengthPropertyChanged));

        [SuppressMessage("Microsoft.Usage", "CA2208:InstantiateArgumentExceptionsCorrectly", Justification = "MinimumPrefixLength is the name of the actual dependency property.")]
        static void OnMinimumPrefixLengthPropertyChanged(DependencyObject d, DependencyPropertyChangedEventArgs e)
        {
            var newValue = (int)e.NewValue;

            if (newValue < 0 && newValue != -1)
            {
                throw new ArgumentOutOfRangeException(nameof(MinimumPrefixLength));
            }
        }

        [ExcludeFromCodeCoverage]
        public int MinimumPopulateDelay
        {
            get => (int)GetValue(MinimumPopulateDelayProperty);
            set => SetValue(MinimumPopulateDelayProperty, value);
        }

        public static readonly DependencyProperty MinimumPopulateDelayProperty =
            DependencyProperty.Register(nameof(MinimumPopulateDelay), typeof(int), typeof(AutoCompleteBox), new PropertyMetadata(OnMinimumPopulateDelayPropertyChanged));

        [SuppressMessage("Microsoft.Usage", "CA2208:InstantiateArgumentExceptionsCorrectly", Justification = "The exception is most likely to be called through the CLR property setter.")]
        [ExcludeFromCodeCoverage]
        static void OnMinimumPopulateDelayPropertyChanged(DependencyObject d, DependencyPropertyChangedEventArgs e)
        {
            var source = d as AutoCompleteBox;

            if (source != null && source._ignorePropertyChange)
            {
                source._ignorePropertyChange = false;
                return;
            }

            var newValue = (int)e.NewValue;
            if (newValue < 0)
            {
                if (source != null)
                {
                    source._ignorePropertyChange = true;
                }
                d.SetValue(e.Property, e.OldValue);

                throw new ArgumentException(string.Format(CultureInfo.InvariantCulture,
                    Dev2.Runtime.Configuration.Properties.Resources.AutoComplete_OnMinimumPopulateDelayPropertyChanged_InvalidValue, newValue));
            }

            SetupNewDelayTimer(source, newValue);
        }

        private static void SetupNewDelayTimer(AutoCompleteBox source, int newValue)
        {
            if (source?._delayTimer != null)
            {
                source._delayTimer.Stop();

                if (newValue == 0)
                {
                    source._delayTimer = null;
                }
            }

            if (source != null && newValue > 0 && source._delayTimer == null)
            {
                source._delayTimer = new DispatcherTimer();
                source._delayTimer.Tick += source.PopulateDropDown;
            }

            if (source != null && newValue > 0 && source._delayTimer != null)
            {
                source._delayTimer.Interval = TimeSpan.FromMilliseconds(newValue);
            }
        }

        public static readonly DependencyProperty DefaultTextTemplateProperty =
            DependencyProperty.Register(nameof(DefaultTextTemplate), typeof(DataTemplate), typeof(AutoCompleteBox), new UIPropertyMetadata(null));

        [ExcludeFromCodeCoverage]
        public DataTemplate DefaultTextTemplate
        {
            get => (DataTemplate)GetValue(DefaultTextTemplateProperty);
            set => SetValue(DefaultTextTemplateProperty, value);
        }

        public static readonly DependencyProperty DefaultTextProperty =
            DependencyProperty.Register(nameof(DefaultText), typeof(object), typeof(AutoCompleteBox), new UIPropertyMetadata(null));

        public object DefaultText
        {
            get => GetValue(DefaultTextProperty);
            set => SetValue(DefaultTextProperty, value);
        }

        public static readonly DependencyProperty AllowUserInsertLineProperty =
            DependencyProperty.Register(nameof(AllowUserInsertLine), typeof(bool), typeof(AutoCompleteBox), new PropertyMetadata(true));

        public bool AllowUserInsertLine
        {
            get => (bool)GetValue(AllowUserInsertLineProperty);
            set => SetValue(AllowUserInsertLineProperty, value);
        }

        public bool IsTextCompletionEnabled
        {
            get => (bool)GetValue(IsTextCompletionEnabledProperty);
            set => SetValue(IsTextCompletionEnabledProperty, value);
        }

        public static readonly DependencyProperty IsTextCompletionEnabledProperty =
            DependencyProperty.Register(nameof(IsTextCompletionEnabled), typeof(bool), typeof(AutoCompleteBox), new PropertyMetadata(false, null));

        [ExcludeFromCodeCoverage]
        public DataTemplate ItemTemplate
        {
            get => GetValue(ItemTemplateProperty) as DataTemplate;
            set => SetValue(ItemTemplateProperty, value);
        }

        public static readonly DependencyProperty ItemTemplateProperty =
            DependencyProperty.Register(nameof(ItemTemplate), typeof(DataTemplate), typeof(AutoCompleteBox), new PropertyMetadata(null));

        [ExcludeFromCodeCoverage]
        public Style ItemContainerStyle
        {
            get => GetValue(ItemContainerStyleProperty) as Style;
            set => SetValue(ItemContainerStyleProperty, value);
        }

        public static readonly DependencyProperty ItemContainerStyleProperty =
            DependencyProperty.Register(nameof(ItemContainerStyle), typeof(Style), typeof(AutoCompleteBox), new PropertyMetadata(null, null));

        [ExcludeFromCodeCoverage]
        public Style TextBoxStyle
        {
            get => GetValue(TextBoxStyleProperty) as Style;
            set => SetValue(TextBoxStyleProperty, value);
        }

        public static readonly DependencyProperty TextBoxStyleProperty =
            DependencyProperty.Register(nameof(TextBoxStyle), typeof(Style), typeof(AutoCompleteBox), new PropertyMetadata(null));

        [ExcludeFromCodeCoverage]
        public double MaxDropDownHeight
        {
            get => (double)GetValue(MaxDropDownHeightProperty);
            set => SetValue(MaxDropDownHeightProperty, value);
        }

        public static readonly DependencyProperty MaxDropDownHeightProperty =
            DependencyProperty.Register(nameof(MaxDropDownHeight), typeof(double), typeof(AutoCompleteBox), new PropertyMetadata(double.PositiveInfinity, OnMaxDropDownHeightPropertyChanged));

        [SuppressMessage("Microsoft.Usage", "CA2208:InstantiateArgumentExceptionsCorrectly", Justification = "The exception will be called through a CLR setter in most cases.")]
        static void OnMaxDropDownHeightPropertyChanged(DependencyObject d, DependencyPropertyChangedEventArgs e)
        {
            var source = d as AutoCompleteBox;
            if (source != null && source._ignorePropertyChange)
            {
                source._ignorePropertyChange = false;
                return;
            }

            var newValue = (double)e.NewValue;

            if (newValue < 0)
            {
                if (source != null)
                {
                    source._ignorePropertyChange = true;
                    source.SetValue(e.Property, e.OldValue);
                }

                throw new ArgumentException(string.Format(CultureInfo.InvariantCulture, Dev2.Runtime.Configuration.Properties.Resources.AutoComplete_OnMaxDropDownHeightPropertyChanged_InvalidValue, e.NewValue));
            }

            source?.OnMaxDropDownHeightChanged(newValue);
        }

        public static readonly DependencyProperty IsDropDownOpenProperty =
            DependencyProperty.Register(nameof(IsDropDownOpen), typeof(bool), typeof(AutoCompleteBox), new PropertyMetadata(false, OnIsDropDownOpenPropertyChanged));

        public bool IsDropDownOpen
        {
            get => (bool)GetValue(IsDropDownOpenProperty);
            set => SetValue(IsDropDownOpenProperty, value);
        }

        static void OnIsDropDownOpenPropertyChanged(DependencyObject d, DependencyPropertyChangedEventArgs e)
        {
            var source = d as AutoCompleteBox;

            if (source != null && source._ignorePropertyChange)
            {
                source._ignorePropertyChange = false;
                return;
            }

            var oldValue = (bool)e.OldValue;
            var newValue = (bool)e.NewValue;
            if (source != null)
            {
                if (newValue)
                {
                    source.TextUpdated(source.Text, true);
                }
                else
                {
                    source.ClosingDropDown(oldValue);
                }

                source.UpdateVisualState(true);
            }
        }

        public IEnumerable ItemsSource
        {
            get => GetValue(ItemsSourceProperty) as IEnumerable;
            set => SetValue(ItemsSourceProperty, value);
        }

        public static readonly DependencyProperty ItemsSourceProperty =
            DependencyProperty.Register(nameof(ItemsSource), typeof(IEnumerable), typeof(AutoCompleteBox), new PropertyMetadata(OnItemsSourcePropertyChanged));

        static void OnItemsSourcePropertyChanged(DependencyObject d, DependencyPropertyChangedEventArgs e)
        {
            var autoComplete = d as AutoCompleteBox;
            autoComplete?.OnItemsSourceChanged((IEnumerable)e.OldValue, (IEnumerable)e.NewValue);
        }

        public object SelectedItem
        {
            get => GetValue(SelectedItemProperty);
            set => SetValue(SelectedItemProperty, value);
        }

        public static readonly DependencyProperty SelectedItemProperty =
            DependencyProperty.Register(nameof(SelectedItem), typeof(object), typeof(AutoCompleteBox), new PropertyMetadata(OnSelectedItemPropertyChanged));

        static void OnSelectedItemPropertyChanged(DependencyObject d, DependencyPropertyChangedEventArgs e)
        {
            var source = d as AutoCompleteBox;
            if (source != null)
            {
                if (source._ignorePropertyChange)
                {
                    source._ignorePropertyChange = false;
                    return;
                }

                if (source._skipSelectedItemTextUpdate)
                {
                    source._skipSelectedItemTextUpdate = false;
                }
                else
                {
                    source.OnSelectedItemChanged(e.NewValue);
                }
            }

            var removed = new List<object>();
            if (e.OldValue != null)
            {
                removed.Add(e.OldValue);
            }

            var added = new List<object>();
            if (e.NewValue != null)
            {
                added.Add(e.NewValue);
            }

            source?.OnSelectionChanged(new SelectionChangedEventArgs(SelectionChangedEvent, removed, added));
        }

        void OnSelectedItemChanged(object newItem)
        {
            if (CustomSelection)
            {
                return;
            }
            var text = newItem == null ? SearchText : FormatValue(newItem, true);

            UpdateTextValue(text);

            if (TextBox != null && Text != null)
            {
                TextBox.SelectionStart = Text.Length;
            }
        }

        public bool CustomSelection { get; set; }

        public string Text
        {
            get => GetValue(TextProperty) as string;
            set => SetValue(TextProperty, value);
        }

        public static readonly DependencyProperty TextProperty =
            DependencyProperty.Register(nameof(Text), typeof(string), typeof(AutoCompleteBox), new PropertyMetadata(string.Empty, OnTextPropertyChanged));

        static void OnTextPropertyChanged(DependencyObject d, DependencyPropertyChangedEventArgs e)
        {
            var source = d as AutoCompleteBox;
            source?.TextUpdated((string)e.NewValue, false);
        }

        public string SearchText
        {
            get => (string)GetValue(SearchTextProperty);
            private set
            {
                try
                {
                    _allowWrite = true;
                    SetValue(SearchTextProperty, value);
                }
                finally
                {
                    _allowWrite = false;
                }
            }
        }

        public static readonly DependencyProperty SearchTextProperty =
            DependencyProperty.Register(nameof(SearchText), typeof(string), typeof(AutoCompleteBox), new PropertyMetadata(string.Empty, OnSearchTextPropertyChanged));

        static void OnSearchTextPropertyChanged(DependencyObject d, DependencyPropertyChangedEventArgs e)
        {
            var source = d as AutoCompleteBox;
            if (source != null && source._ignorePropertyChange)
            {
                source._ignorePropertyChange = false;
                return;
            }

            if (source != null && !source._allowWrite)
            {
                source._ignorePropertyChange = true;
                source.SetValue(e.Property, e.OldValue);

                throw new InvalidOperationException(Dev2.Runtime.Configuration.Properties.Resources.AutoComplete_OnSearchTextPropertyChanged_InvalidWrite);
            }
        }

        public AutoCompleteFilterMode FilterMode
        {
            get => (AutoCompleteFilterMode)GetValue(FilterModeProperty);
            set => SetValue(FilterModeProperty, value);
        }

        public static readonly DependencyProperty FilterModeProperty =
            DependencyProperty.Register(nameof(FilterMode), typeof(AutoCompleteFilterMode), typeof(AutoCompleteBox), new PropertyMetadata(AutoCompleteFilterMode.StartsWith, OnFilterModePropertyChanged));

        [SuppressMessage("Microsoft.Usage", "CA2208:InstantiateArgumentExceptionsCorrectly", Justification = "The exception will be thrown when the CLR setter is used in most situations.")]
        [ExcludeFromCodeCoverage]
        static void OnFilterModePropertyChanged(DependencyObject d, DependencyPropertyChangedEventArgs e)
        {
            var source = d as AutoCompleteBox;
            var mode = (AutoCompleteFilterMode)e.NewValue;

            var modeNotContainingFilterMode = mode != AutoCompleteFilterMode.Contains;
            modeNotContainingFilterMode &= mode != AutoCompleteFilterMode.EqualsCaseSensitive;
            modeNotContainingFilterMode &= mode != AutoCompleteFilterMode.StartsWith;
            modeNotContainingFilterMode &= mode != AutoCompleteFilterMode.Custom;
            modeNotContainingFilterMode &= mode != AutoCompleteFilterMode.None;

            if (modeNotContainingFilterMode)
            {
                source?.SetValue(e.Property, e.OldValue);
                throw new ArgumentException(Dev2.Runtime.Configuration.Properties.Resources.AutoComplete_OnFilterModePropertyChanged_InvalidValue);
            }

            var newValue = (AutoCompleteFilterMode)e.NewValue;
            if (source != null)
            {
                source.TextFilter = AutoCompleteSearch.GetFilter(newValue);
            }
        }

        public AutoCompleteFilterPredicate<object> ItemFilter
        {
            get => GetValue(ItemFilterProperty) as AutoCompleteFilterPredicate<object>;
            set => SetValue(ItemFilterProperty, value);
        }

        public static readonly DependencyProperty ItemFilterProperty =
            DependencyProperty.Register(nameof(ItemFilter), typeof(AutoCompleteFilterPredicate<object>), typeof(AutoCompleteBox), new PropertyMetadata(OnItemFilterPropertyChanged));

        static void OnItemFilterPropertyChanged(DependencyObject d, DependencyPropertyChangedEventArgs e)
        {
            var autoCompleteBox = d as AutoCompleteBox;
            if (e.NewValue is AutoCompleteFilterPredicate<object>)
            {
                if (autoCompleteBox != null)
                {
                    autoCompleteBox.FilterMode = AutoCompleteFilterMode.Custom;
                    autoCompleteBox.TextFilter = null;
                }
                return;
            }
            if (autoCompleteBox != null)
            {
                autoCompleteBox.FilterMode = AutoCompleteFilterMode.None;
            }
        }

        public AutoCompleteFilterPredicate<string> TextFilter
        {
            get => GetValue(TextFilterProperty) as AutoCompleteFilterPredicate<string>;
            set => SetValue(TextFilterProperty, value);
        }

        public static readonly DependencyProperty TextFilterProperty =
            DependencyProperty.Register(nameof(TextFilter), typeof(AutoCompleteFilterPredicate<string>), typeof(AutoCompleteBox), new PropertyMetadata(AutoCompleteSearch.GetFilter(AutoCompleteFilterMode.StartsWith)));

        PopupHelper DropDownPopup { get; set; }
        TextBox _text;
        ISelectionAdapter _adapter;

        public TextBox TextBox
        {
            get => _text;
            set
            {
                if (_text != null)
                {
                    _text.SelectionChanged -= OnTextBoxSelectionChanged;
                    _text.TextChanged -= OnTextBoxTextChanged;
                }
                _text = value;
                if (_text != null)
                {
                    _text.SelectionChanged += OnTextBoxSelectionChanged;
                    _text.TextChanged += OnTextBoxTextChanged;

                    if (Text != null)
                    {
                        UpdateTextValue(Text);
                    }
                }
            }
        }

        protected internal ISelectionAdapter SelectionAdapter
        {
            get => _adapter;
            set
            {
                if (_adapter != null)
                {
                    _adapter.SelectionChanged -= OnAdapterSelectionChanged;
                    _adapter.Commit -= OnAdapterSelectionComplete;
                    _adapter.Cancel -= OnAdapterSelectionCanceled;
                    _adapter.Cancel -= OnAdapterSelectionComplete;
                    _adapter.ItemsSource = null;
                }

                _adapter = value;

                if (_adapter != null)
                {
                    _adapter.SelectionChanged += OnAdapterSelectionChanged;
                    _adapter.Commit += OnAdapterSelectionComplete;
                    _adapter.Cancel += OnAdapterSelectionCanceled;
                    _adapter.Cancel += OnAdapterSelectionComplete;
                    _adapter.ItemsSource = _view;
                }
            }
        }

        public static readonly DependencyProperty HasErrorProperty =
            DependencyProperty.Register(nameof(HasError), typeof(bool), typeof(AutoCompleteBox), new PropertyMetadata(false));

        public bool HasError
        {
            get => (bool)GetValue(HasErrorProperty);
            set => SetValue(HasErrorProperty, value);
        }

        public static readonly RoutedEvent TextChangedEvent = EventManager.RegisterRoutedEvent(nameof(TextChanged), RoutingStrategy.Bubble, typeof(RoutedEventHandler), typeof(AutoCompleteBox));

        public event RoutedEventHandler TextChanged
        {
            add { AddHandler(TextChangedEvent, value); }
            remove { RemoveHandler(TextChangedEvent, value); }
        }

        public static readonly RoutedEvent PopulatingEvent = EventManager.RegisterRoutedEvent(nameof(Populating), RoutingStrategy.Bubble, typeof(PopulatingEventHandler), typeof(AutoCompleteBox));

        public event PopulatingEventHandler Populating
        {
            add { AddHandler(PopulatingEvent, value); }
            remove { RemoveHandler(PopulatingEvent, value); }
        }

        public static readonly RoutedEvent PopulatedEvent = EventManager.RegisterRoutedEvent(nameof(Populated), RoutingStrategy.Bubble, typeof(PopulatedEventHandler), typeof(AutoCompleteBox));

        public event PopulatedEventHandler Populated
        {
            add { AddHandler(PopulatedEvent, value); }
            remove { RemoveHandler(PopulatedEvent, value); }
        }

        public static readonly RoutedEvent DropDownOpeningEvent = EventManager.RegisterRoutedEvent(nameof(DropDownOpening), RoutingStrategy.Bubble, typeof(RoutedPropertyChangingEventHandler<bool>), typeof(AutoCompleteBox));

        public event RoutedPropertyChangingEventHandler<bool> DropDownOpening
        {
            add { AddHandler(PopulatedEvent, value); }
            remove { RemoveHandler(PopulatedEvent, value); }
        }

        public static readonly RoutedEvent DropDownOpenedEvent = EventManager.RegisterRoutedEvent(nameof(DropDownOpened), RoutingStrategy.Bubble, typeof(RoutedPropertyChangedEventHandler<bool>), typeof(AutoCompleteBox));

        public event RoutedPropertyChangedEventHandler<bool> DropDownOpened
        {
            add { AddHandler(DropDownOpenedEvent, value); }
            remove { RemoveHandler(DropDownOpenedEvent, value); }
        }

        public static readonly RoutedEvent DropDownClosingEvent = EventManager.RegisterRoutedEvent(nameof(DropDownClosing), RoutingStrategy.Bubble, typeof(RoutedPropertyChangingEventHandler<bool>), typeof(AutoCompleteBox));

        public event RoutedPropertyChangingEventHandler<bool> DropDownClosing
        {
            add { AddHandler(DropDownClosingEvent, value); }
            remove { RemoveHandler(DropDownClosingEvent, value); }
        }

        public static readonly RoutedEvent DropDownClosedEvent = EventManager.RegisterRoutedEvent(nameof(DropDownClosed), RoutingStrategy.Bubble, typeof(RoutedPropertyChangedEventHandler<bool>), typeof(AutoCompleteBox));

        public event RoutedPropertyChangedEventHandler<bool> DropDownClosed
        {
            add { AddHandler(DropDownClosedEvent, value); }
            remove { RemoveHandler(DropDownClosedEvent, value); }
        }

        public static readonly RoutedEvent SelectionChangedEvent = EventManager.RegisterRoutedEvent(nameof(SelectionChanged), RoutingStrategy.Bubble, typeof(SelectionChangedEventHandler), typeof(AutoCompleteBox));

        public event SelectionChangedEventHandler SelectionChanged
        {
            add { AddHandler(SelectionChangedEvent, value); }
            remove { RemoveHandler(SelectionChangedEvent, value); }
        }

        public Binding ValueMemberBinding
        {
            get => _valueBindingEvaluator?.ValueBinding;
            set => _valueBindingEvaluator = new BindingEvaluator<string>(value);
        }

        public string ValueMemberPath
        {
            get => ValueMemberBinding?.Path.Path;
            set => ValueMemberBinding = value == null ? null : new Binding(value);
        }

        public ObservableCollection<object> View => _view;

        static AutoCompleteBox()
        {
            DefaultStyleKeyProperty.OverrideMetadata(typeof(AutoCompleteBox), new FrameworkPropertyMetadata(typeof(AutoCompleteBox)));
        }

        public AutoCompleteBox()
        {
            IsEnabledChanged += ControlIsEnabledChanged;
            Interaction = new InteractionHelper(this);

            ClearView();
            if (Application.Current != null)
            {
                Style = Application.Current.TryFindResource("AutoCompleteBoxStyle") as Style;
            }
        }

        protected override Size ArrangeOverride(Size arrangeBounds)
        {
            var r = base.ArrangeOverride(arrangeBounds);
            DropDownPopup?.Arrange();
            return r;
        }

        public override void OnApplyTemplate()
        {
            if (TextBox != null)
            {
                TextBox.PreviewKeyDown -= OnTextBoxPreviewKeyDown;
            }

            if (DropDownPopup != null)
            {
                DropDownPopup.Closed -= DropDownPopupClosed;
                DropDownPopup.FocusChanged -= OnDropDownFocusChanged;
                DropDownPopup.UpdateVisualStates -= OnDropDownPopupUpdateVisualStates;
                DropDownPopup.BeforeOnApplyTemplate();
                DropDownPopup = null;
            }

            base.OnApplyTemplate();

            if (GetTemplateChild("Popup") is Popup popup)
            {
                DropDownPopup = new PopupHelper(this, popup) { MaxDropDownHeight = MaxDropDownHeight };
                DropDownPopup.AfterOnApplyTemplate();
                DropDownPopup.Closed += DropDownPopupClosed;
                DropDownPopup.FocusChanged += OnDropDownFocusChanged;
                DropDownPopup.UpdateVisualStates += OnDropDownPopupUpdateVisualStates;
            }
            SelectionAdapter = GetSelectionAdapterPart();
            TextBox = GetTemplateChild("Text") as TextBox;

            if (TextBox != null)
            {
                TextBox.PreviewKeyDown += OnTextBoxPreviewKeyDown;
            }

            Interaction.OnApplyTemplateBase();

            if (IsDropDownOpen && DropDownPopup != null && !DropDownPopup.IsOpen)
            {
                OpeningDropDown(false);
            }
        }

        void OnDropDownPopupUpdateVisualStates(object sender, EventArgs e)
        {
            UpdateVisualState(true);
        }

        void OnDropDownFocusChanged(object sender, EventArgs e)
        {
            FocusChanged(HasFocus());
        }

        void ClosingDropDown(bool oldValue)
        {
            var delayedClosingVisual = false;
            if (DropDownPopup != null)
            {
                delayedClosingVisual = DropDownPopup.UsesClosingVisualState;
            }

            var args = new RoutedPropertyChangingEventArgs<bool>(IsDropDownOpenProperty, oldValue, false, true, DropDownClosingEvent);
            OnDropDownClosing(args);

            if (_view == null || _view.Count == 0)
            {
                delayedClosingVisual = false;
            }

            if (args.Cancel)
            {
                _ignorePropertyChange = true;
                SetValue(IsDropDownOpenProperty, oldValue);
            }
            else
            {
                RaiseExpandCollapseAutomationEvent(oldValue, false);
                if (!delayedClosingVisual)
                {
                    CloseDropDown(oldValue, false);
                }
            }

            UpdateVisualState(true);
        }

        void OpeningDropDown(bool oldValue)
        {
            var args = new RoutedPropertyChangingEventArgs<bool>(IsDropDownOpenProperty, oldValue, true, true, DropDownOpeningEvent);
            OnDropDownOpening(args);

            if (args.Cancel)
            {
                _ignorePropertyChange = true;
                SetValue(IsDropDownOpenProperty, oldValue);
            }
            else
            {
                RaiseExpandCollapseAutomationEvent(oldValue, true);
                OpenDropDown(oldValue, true);
            }

            UpdateVisualState(true);
        }

        void RaiseExpandCollapseAutomationEvent(bool oldValue, bool newValue)
        {
            var peer = UIElementAutomationPeer.FromElement(this) as AutoCompleteBoxAutomationPeer;
            peer?.RaiseExpandCollapseAutomationEvent(oldValue, newValue);
        }

        void OnTextBoxPreviewKeyDown(object sender, KeyEventArgs e)
        {
            OnKeyDown(e);
        }

        void DropDownPopupClosed(object sender, EventArgs e)
        {
            if (IsDropDownOpen)
            {
                IsDropDownOpen = false;
            }

            if (_popupHasOpened)
            {
                OnDropDownClosed(new RoutedPropertyChangedEventArgs<bool>(true, false, DropDownClosedEvent));
            }
        }

        protected override AutomationPeer OnCreateAutomationPeer() => new AutoCompleteBoxAutomationPeer(this);

        void FocusChanged(bool hasFocus)
        {
            if (!hasFocus)
            {
                IsDropDownOpen = false;
                _userCalledPopulate = false;
                TextBox?.Select(TextBox.Text.Length, 0);
            }
        }

        protected bool HasFocus()
        {
            var focused = IsKeyboardFocusWithin ? Keyboard.FocusedElement as DependencyObject : FocusManager.GetFocusedElement(this) as DependencyObject;
            while (focused != null)
            {
                if (ReferenceEquals(focused, this))
                {
                    return true;
                }

                var parent = VisualTreeHelper.GetParent(focused);
                if (parent == null && focused is FrameworkElement element)
                {
                    parent = element.Parent;
                }

                focused = parent;
            }
            return false;
        }

        protected override void OnGotFocus(RoutedEventArgs e)
        {
            base.OnGotFocus(e);
            FocusChanged(HasFocus());
        }

        protected override void OnIsKeyboardFocusWithinChanged(DependencyPropertyChangedEventArgs e)
        {
            base.OnIsKeyboardFocusWithinChanged(e);
            if (!IsKeyboardFocusWithin)
            {
                IsDropDownOpen = false;
            }
        }

        protected override void OnLostFocus(RoutedEventArgs e)
        {
            base.OnLostFocus(e);
            FocusChanged(HasFocus());
        }

        void ControlIsEnabledChanged(object sender, DependencyPropertyChangedEventArgs e)
        {
            var isEnabled = (bool)e.NewValue;
            if (!isEnabled)
            {
                IsDropDownOpen = false;
            }
        }

        [SuppressMessage("Microsoft.Design", "CA1024:UsePropertiesWhereAppropriate", Justification = "Following the GetTemplateChild pattern for the method.")]
        [ExcludeFromCodeCoverage]
        protected virtual ISelectionAdapter GetSelectionAdapterPart()
        {
            ISelectionAdapter adapter = null;
            if (GetTemplateChild("Selector") is Selector selector)
            {
                adapter = selector as ISelectionAdapter ?? new SelectorSelectionAdapter(selector);
            }

            return adapter ?? GetTemplateChild("SelectionAdapter") as ISelectionAdapter;
        }

        [ExcludeFromCodeCoverage]
        void PopulateDropDown(object sender, EventArgs e)
        {
            _delayTimer?.Stop();
            SearchText = Text;

            var populating = new PopulatingEventArgs(SearchText, PopulatingEvent);

            OnPopulating(populating);
            if (!populating.Cancel)
            {
                PopulateComplete();
            }
        }

        protected virtual void OnPopulating(PopulatingEventArgs e)
        {
            RaiseEvent(e);
        }

        [ExcludeFromCodeCoverage]
        protected virtual void OnPopulated(PopulatedEventArgs e)
        {
            RaiseEvent(e);
        }

        [ExcludeFromCodeCoverage]
        protected virtual void OnSelectionChanged(SelectionChangedEventArgs e)
        {
            RaiseEvent(e);

            var box = (AutoCompleteBox)e.Source;
            var innerListBox = (ListBox)box?.Template?.FindName("Selector", box);
            innerListBox?.ScrollIntoView(innerListBox.SelectedItem);

            RaiseEvent(e);
        }

        [ExcludeFromCodeCoverage]
        protected virtual void OnDropDownOpening(RoutedPropertyChangingEventArgs<bool> e)
        {
            RaiseEvent(e);
        }

        [ExcludeFromCodeCoverage]
        protected virtual void OnDropDownOpened(RoutedPropertyChangedEventArgs<bool> e)
        {
            RaiseEvent(e);
        }

        [ExcludeFromCodeCoverage]
        protected virtual void OnDropDownClosing(RoutedPropertyChangingEventArgs<bool> e)
        {
            RaiseEvent(e);
        }

        protected virtual void OnDropDownClosed(RoutedPropertyChangedEventArgs<bool> e)
        {
            RaiseEvent(e);
        }

        string FormatValue(object value, bool clearDataContext)
        {
            var str = FormatValue(value);
            if (clearDataContext)
            {
                _valueBindingEvaluator?.ClearDataContext();
            }
            return str;
        }

        protected virtual string FormatValue(object value)
        {
            if (_valueBindingEvaluator != null)
            {
                return _valueBindingEvaluator.GetDynamicValue(value) ?? string.Empty;
            }

            return value?.ToString() ?? string.Empty;
        }

        protected virtual void OnTextChanged(RoutedEventArgs e)
        {
            RaiseEvent(e);
        }

        void OnTextBoxTextChanged(object sender, TextChangedEventArgs e)
        {
            TextUpdated(_text.Text, true);
        }

        void OnTextBoxSelectionChanged(object sender, RoutedEventArgs e)
        {
            if (_ignoreTextSelectionChange)
            {
                return;
            }

            _textSelectionStart = _text.SelectionStart;
        }

        void UpdateTextValue(string value)
        {
            UpdateTextValue(value, null);
        }

        void UpdateTextValue(string value, bool? userInitiated)
        {
            var textUpdated = false;

            if ((userInitiated is null || userInitiated == true) && Text != value)
            {
                _ignoreTextPropertyChange++;
                Text = value;
                textUpdated = true;
            }

            if (TextBox is null)
            {
                Text = value;
                textUpdated = true;
            }

            var textBoxUpdated = UpdateTextBoxValue(value, userInitiated);

            if (textUpdated || textBoxUpdated)
            {
                OnTextChanged(new RoutedEventArgs(TextChangedEvent));
            }
        }

        private bool UpdateTextBoxValue(string value, bool? userInitiated)
        {
            if ((userInitiated is null || userInitiated == false) && TextBox != null && TextBox.Text != value)
            {
                _ignoreTextPropertyChange++;
                TextBox.Text = value ?? string.Empty;

                if (Text == value || Text is null)
                {
                    return true;
                }
            }
            return false;
        }

        void TextUpdated(string newText, bool userInitiated)
        {
            if (_ignoreTextPropertyChange > 0)
            {
                _ignoreTextPropertyChange--;
                return;
            }

            var text = newText;

            if (text == null)
            {
                text = string.Empty;
            }

            if (IsTextCompletionEnabled && TextBox != null && TextBox.SelectionLength > 0 && TextBox.SelectionStart != TextBox.Text.Length)
            {
                return;
            }

            var populateReady = text.Length >= MinimumPrefixLength && MinimumPrefixLength >= 0;
            _userCalledPopulate = populateReady && userInitiated;

            UpdateTextValue(text, userInitiated);

            if (populateReady)
            {
                PopulateReady();
                return;
            }
            PopulateNotReady();
        }

        private void PopulateReady()
        {
            _ignoreTextSelectionChange = true;

            if (_delayTimer != null)
            {
                _delayTimer.Start();
            }
            else
            {
                PopulateDropDown(this, EventArgs.Empty);
            }
        }

        private void PopulateNotReady()
        {
            SearchText = string.Empty;
            if (SelectedItem != null)
            {
                _skipSelectedItemTextUpdate = true;
            }
            SelectedItem = null;
            if (IsDropDownOpen)
            {
                IsDropDownOpen = false;
            }
        }

        public void PopulateComplete()
        {
            RefreshView();

            var populated = new PopulatedEventArgs(new ReadOnlyCollection<object>(_view), PopulatedEvent);
            OnPopulated(populated);

            if (SelectionAdapter != null && !SelectionAdapter.ItemsSource.Equals(_view))
            {
                SelectionAdapter.ItemsSource = _view;
            }

            var isDropDownOpen = _userCalledPopulate && _view.Count > 0;
            if (isDropDownOpen != IsDropDownOpen)
            {
                _ignorePropertyChange = true;
                IsDropDownOpen = isDropDownOpen;
            }
            if (IsDropDownOpen)
            {
                OpeningDropDown(false);
                DropDownPopup?.Arrange();
            }
            else
            {
                ClosingDropDown(true);
            }

            UpdateTextCompletion(_userCalledPopulate);
        }

        void UpdateTextCompletion(bool userInitiated)
        {
            object newSelectedItem = null;
            var text = Text;
            if (_view.Count > 0)
            {
                if (IsTextCompletionEnabled && TextBox != null && userInitiated)
                {
                    var currentLength = TextBox.Text.Length;
                    var selectionStart = TextBox.SelectionStart;
                    newSelectedItem = UpdateSelection(newSelectedItem, text, currentLength, selectionStart);
                }
                else
                {
                    newSelectedItem = TryGetMatch(text, _view, AutoCompleteSearch.GetFilter(AutoCompleteFilterMode.EqualsCaseSensitive));
                }
            }
            if (SelectedItem != newSelectedItem)
            {
                _skipSelectedItemTextUpdate = true;
            }
            SelectedItem = newSelectedItem;
            if (_ignoreTextSelectionChange)
            {
                _ignoreTextSelectionChange = false;
                if (TextBox != null)
                {
                    _textSelectionStart = TextBox.SelectionStart;
                }
            }
        }

        private object UpdateSelection(object newSelectedItem, string text, int currentLength, int selectionStart)
        {
            var selectedItem = newSelectedItem;
            if (selectionStart == text.Length && selectionStart > _textSelectionStart)
            {
                var top = FilterMode == AutoCompleteFilterMode.StartsWith || FilterMode == AutoCompleteFilterMode.StartsWithCaseSensitive
                    ? _view[0]
                    : TryGetMatch(text, _view, AutoCompleteSearch.GetFilter(AutoCompleteFilterMode.StartsWith));
                if (top != null)
                {
                    selectedItem = top;
                    var topString = FormatValue(top, true);
                    var minLength = Math.Min(topString.Length, Text.Length);
                    if (AutoCompleteSearch.Equals(Text.Substring(0, minLength), topString.Substring(0, minLength)))
                    {
                        UpdateTextValue(topString);
                        TextBox.SelectionStart = currentLength;
                        TextBox.SelectionLength = topString.Length - currentLength;
                    }
                }
            }

            return selectedItem;
        }

        object TryGetMatch(string searchText, ObservableCollection<object> view, AutoCompleteFilterPredicate<string> predicate)
        {
            if (view != null && view.Count > 0)
            {
                return view.FirstOrDefault(o => predicate?.Invoke(searchText, FormatValue(o)) ?? default(bool));
            }

            return null;
        }

        void ClearView()
        {
            if (_view == null)
            {
                _view = new ObservableCollection<object>();
            }
            else
            {
                _view.Clear();
            }
        }

        void RefreshView()
        {
            if (_items == null)
            {
                ClearView();
                return;
            }

            _view.Clear();

            var filteredItems = GetFilteredItems();
            foreach (var item in filteredItems)
            {
                _view.Add(item);
            }

            _valueBindingEvaluator?.ClearDataContext();
        }

        private IEnumerable<object> GetFilteredItems()
        {
            var text = Text ?? string.Empty;
            var stringFiltering = TextFilter != null;
            var objectFiltering = FilterMode == AutoCompleteFilterMode.Custom && TextFilter == null;

            var filteredItems = _items.Where(item =>
            {
                var isAutoCompleteMatch = !(stringFiltering || objectFiltering);
                if (!isAutoCompleteMatch)
                {
                    isAutoCompleteMatch = stringFiltering ? TextFilter?.Invoke(text, FormatValue(item)) ?? default(bool) : ItemFilter?.Invoke(text, item) ?? default(bool);
                }
                return isAutoCompleteMatch;
            });
            return filteredItems;
        }

        [SuppressMessage("Microsoft.Usage", "CA1801:ReviewUnusedParameters", MessageId = "oldValue", Justification = "This makes it easy to add validation or other changes in the future.")]
        [ExcludeFromCodeCoverage]
        void OnItemsSourceChanged(IEnumerable oldValue, IEnumerable newValue)
        {
            _items = newValue == null ? null : new List<object>(newValue.Cast<object>().ToList());
            ClearView();
            if (SelectionAdapter != null && !SelectionAdapter.ItemsSource.Equals(_view))
            {
                SelectionAdapter.ItemsSource = _view;
            }
            if (IsDropDownOpen)
            {
                RefreshView();
            }
        }

        [ExcludeFromCodeCoverage]
        void OnAdapterSelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            SelectedItem = _adapter.SelectedItem;
        }

        [ExcludeFromCodeCoverage]
        void OnAdapterSelectionComplete(object sender, RoutedEventArgs e)
        {
            IsDropDownOpen = false;
            UpdateTextCompletion(false);
            TextBox?.Select(TextBox.Text.Length, 0);

            if (TextBox != null)
            {
                Keyboard.Focus(TextBox);
            }
            else
            {
                Focus();
            }
        }

        [ExcludeFromCodeCoverage]
        void OnAdapterSelectionCanceled(object sender, RoutedEventArgs e)
        {
            UpdateTextValue(SearchText);
            UpdateTextCompletion(false);
        }

        [SuppressMessage("Microsoft.Usage", "CA1801:ReviewUnusedParameters", MessageId = "newValue", Justification = "This makes it easy to add validation or other changes in the future.")]
        [ExcludeFromCodeCoverage]
        void OnMaxDropDownHeightChanged(double newValue)
        {
            if (DropDownPopup != null)
            {
                DropDownPopup.MaxDropDownHeight = newValue;
                DropDownPopup.Arrange();
            }
            UpdateVisualState(true);
        }

        void OpenDropDown(bool oldValue, bool newValue)
        {
            if (DropDownPopup != null)
            {
                DropDownPopup.IsOpen = true;
            }
            _popupHasOpened = true;
            OnDropDownOpened(new RoutedPropertyChangedEventArgs<bool>(oldValue, newValue, DropDownOpenedEvent));
        }

        protected void CloseDropDown(bool oldValue, bool newValue)
        {
            if (_popupHasOpened)
            {
                if (SelectionAdapter != null)
                {
                    SelectionAdapter.SelectedItem = null;
                }
                if (DropDownPopup != null)
                {
                    DropDownPopup.IsOpen = false;
                }
                OnDropDownClosed(new RoutedPropertyChangedEventArgs<bool>(oldValue, newValue, DropDownClosedEvent));
            }
        }

        protected override void OnKeyDown(KeyEventArgs e)
        {
            if (e == null)
            {
                throw new ArgumentNullException();
            }

            base.OnKeyDown(e);

            if (e.Handled || !IsEnabled)
            {
                return;
            }
            if (IsDropDownOpen)
            {
                if (SelectionAdapter != null)
                {
                    SelectionAdapter.HandleKeyDown(e);
                    if (e.Handled)
                    {
                        return;
                    }
                }

                switch (e.Key)
                {
                    case Key.F4:
                        IsDropDownOpen = !IsDropDownOpen;
                        e.Handled = true;
                        break;
                    case Key.Enter:
                    case Key.Escape:
                        OnAdapterSelectionComplete(this, new RoutedEventArgs());
                        e.Handled = true;
                        break;
                    default:
                        e.Handled = false;
                        break;
                }
            }
        }

        void IUpdateVisualState.UpdateVisualState(bool useTransitions)
        {
            UpdateVisualState(useTransitions);
        }

        internal virtual void UpdateVisualState(bool useTransitions)
        {
            VisualStateManager.GoToState(this, IsDropDownOpen ? VisualStates.StatePopupOpened : VisualStates.StatePopupClosed, useTransitions);
            Interaction.UpdateVisualStateBase(useTransitions);
        }
    }
}
---- Transformed Tree ----
using System.Collections;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Diagnostics.CodeAnalysis;
using System.Globalization;
using System.Linq;
using System.Windows.Automation.Peers;
using System.Windows.Controls.Primitives;
using System.Windows.Data;
using System.Windows.Input;
using System.Windows.Markup;
using System.Windows.Media;
using System.Windows.Threading;

namespace System.Windows.Controls
{
    [TemplatePart(Name = nameof(SelectionAdapter), Type = typeof(ISelectionAdapter))]
    [TemplatePart(Name = "Selector", Type = typeof(Selector))]
    [TemplatePart(Name = nameof(Text), Type = typeof(TextBox))]
    [TemplatePart(Name = "Popup", Type = typeof(Popup))]
    [StyleTypedProperty(Property = nameof(TextBoxStyle), StyleTargetType = typeof(TextBox))]
    [StyleTypedProperty(Property = nameof(ItemContainerStyle), StyleTargetType = typeof(ListBox))]
    [TemplateVisualState(Name = VisualStates.StateNormal, GroupName = VisualStates.GroupCommon)]
    [TemplateVisualState(Name = VisualStates.StateMouseOver, GroupName = VisualStates.GroupCommon)]
    [TemplateVisualState(Name = VisualStates.StatePressed, GroupName = VisualStates.GroupCommon)]
    [TemplateVisualState(Name = VisualStates.StateDisabled, GroupName = VisualStates.GroupCommon)]
    [TemplateVisualState(Name = VisualStates.StateFocused, GroupName = VisualStates.GroupFocus)]
    [TemplateVisualState(Name = VisualStates.StateUnfocused, GroupName = VisualStates.GroupFocus)]
    [TemplateVisualState(Name = VisualStates.StatePopupClosed, GroupName = VisualStates.GroupPopup)]
    [TemplateVisualState(Name = VisualStates.StatePopupOpened, GroupName = VisualStates.GroupPopup)]
    [TemplateVisualState(Name = VisualStates.StateValid, GroupName = VisualStates.GroupValidation)]
    [TemplateVisualState(Name = VisualStates.StateInvalidFocused, GroupName = VisualStates.GroupValidation)]
    [TemplateVisualState(Name = VisualStates.StateInvalidUnfocused, GroupName = VisualStates.GroupValidation)]
    [SuppressMessage("Microsoft.Maintainability", "CA1506:AvoidExcessiveClassCoupling", Justification = "Large implementation keeps the components contained.")]
    [ContentProperty("ItemsSource")]
    public class AutoCompleteBox : Control, IUpdateVisualState
    {
        List<object> _items;
        ObservableCollection<object> _view;
        int _ignoreTextPropertyChange;
        bool _ignorePropertyChange;
        bool _ignoreTextSelectionChange;
        bool _skipSelectedItemTextUpdate;
        int _textSelectionStart;
        bool _userCalledPopulate;
        bool _popupHasOpened;
        DispatcherTimer _delayTimer;
        bool _allowWrite;
        internal InteractionHelper Interaction { get; set; }
        BindingEvaluator<string> _valueBindingEvaluator;

        public int MinimumPrefixLength
        {
            get => (int)GetValue(MinimumPrefixLengthProperty);
            set => SetValue(MinimumPrefixLengthProperty, value);
        }

        public static readonly DependencyProperty MinimumPrefixLengthProperty =
            DependencyProperty.Register(nameof(MinimumPrefixLength), typeof(int), typeof(AutoCompleteBox), new PropertyMetadata(1, OnMinimumPrefixLengthPropertyChanged));

        [SuppressMessage("Microsoft.Usage", "CA2208:InstantiateArgumentExceptionsCorrectly", Justification = "MinimumPrefixLength is the name of the actual dependency property.")]
        static void OnMinimumPrefixLengthPropertyChanged(DependencyObject d, DependencyPropertyChangedEventArgs e)
        {
            var newValue = (int)e.NewValue;

            if (newValue < 0 && newValue != -1)
            {
                throw new ArgumentOutOfRangeException(nameof(MinimumPrefixLength));
            }
        }

        [ExcludeFromCodeCoverage]
        public int MinimumPopulateDelay
        {
            get => (int)GetValue(MinimumPopulateDelayProperty);
            set => SetValue(MinimumPopulateDelayProperty, value);
        }

        public static readonly DependencyProperty MinimumPopulateDelayProperty =
            DependencyProperty.Register(nameof(MinimumPopulateDelay), typeof(int), typeof(AutoCompleteBox), new PropertyMetadata(OnMinimumPopulateDelayPropertyChanged));

        [SuppressMessage("Microsoft.Usage", "CA2208:InstantiateArgumentExceptionsCorrectly", Justification = "The exception is most likely to be called through the CLR property setter.")]
        [ExcludeFromCodeCoverage]
        static void OnMinimumPopulateDelayPropertyChanged(DependencyObject d, DependencyPropertyChangedEventArgs e)
        {
            if (d is AutoCompleteBox source && source._ignorePropertyChange)
            {
                source._ignorePropertyChange = false;
                return;
            }

            var newValue = (int)e.NewValue;
            if (newValue < 0)
            {
                if (d is AutoCompleteBox source)
                {
                    source._ignorePropertyChange = true;
                }
                d.SetValue(e.Property, e.OldValue);

                throw new ArgumentException(string.Format(CultureInfo.InvariantCulture,
                    Dev2.Runtime.Configuration.Properties.Resources.AutoComplete_OnMinimumPopulateDelayPropertyChanged_InvalidValue, newValue));
            }

            SetupNewDelayTimer(source, newValue);
        }

        private static void SetupNewDelayTimer(AutoCompleteBox source, int newValue)
        {
            if (source?._delayTimer != null)
            {
                source._delayTimer.Stop();

                if (newValue == 0)
                {
                    source._delayTimer = null;
                }
            }

            if (source != null && newValue > 0 && source._delayTimer == null)
            {
                source._delayTimer = new DispatcherTimer();
                source._delayTimer.Tick += source.PopulateDropDown;
            }

            if (source != null && newValue > 0 && source._delayTimer != null)
            {
                source._delayTimer.Interval = TimeSpan.FromMilliseconds(newValue);
            }
        }

        public static readonly DependencyProperty DefaultTextTemplateProperty =
            DependencyProperty.Register(nameof(DefaultTextTemplate), typeof(DataTemplate), typeof(AutoCompleteBox), new UIPropertyMetadata(null));

        [ExcludeFromCodeCoverage]
        public DataTemplate DefaultTextTemplate
        {
            get => (DataTemplate)GetValue(DefaultTextTemplateProperty);
            set => SetValue(DefaultTextTemplateProperty, value);
        }

        public static readonly DependencyProperty DefaultTextProperty =
            DependencyProperty.Register(nameof(DefaultText), typeof(object), typeof(AutoCompleteBox), new UIPropertyMetadata(null));

        public object DefaultText
        {
            get => GetValue(DefaultTextProperty);
            set => SetValue(DefaultTextProperty, value);
        }

        public static readonly DependencyProperty AllowUserInsertLineProperty =
            DependencyProperty.Register(nameof(AllowUserInsertLine), typeof(bool), typeof(AutoCompleteBox), new PropertyMetadata(true));

        public bool AllowUserInsertLine
        {
            get => (bool)GetValue(AllowUserInsertLineProperty);
            set => SetValue(AllowUserInsertLineProperty, value);
        }

        public bool IsTextCompletionEnabled
        {
            get => (bool)GetValue(IsTextCompletionEnabledProperty);
            set => SetValue(IsTextCompletionEnabledProperty, value);
        }

        public static readonly DependencyProperty IsTextCompletionEnabledProperty =
            DependencyProperty.Register(nameof(IsTextCompletionEnabled), typeof(bool), typeof(AutoCompleteBox), new PropertyMetadata(false, null));

        [ExcludeFromCodeCoverage]
        public DataTemplate ItemTemplate
        {
            get => GetValue(ItemTemplateProperty) as DataTemplate;
            set => SetValue(ItemTemplateProperty, value);
        }

        public static readonly DependencyProperty ItemTemplateProperty =
            DependencyProperty.Register(nameof(ItemTemplate), typeof(DataTemplate), typeof(AutoCompleteBox), new PropertyMetadata(null));

        [ExcludeFromCodeCoverage]
        public Style ItemContainerStyle
        {
            get => GetValue(ItemContainerStyleProperty) as Style;
            set => SetValue(ItemContainerStyleProperty, value);
        }

        public static readonly DependencyProperty ItemContainerStyleProperty =
            DependencyProperty.Register(nameof(ItemContainerStyle), typeof(Style), typeof(AutoCompleteBox), new PropertyMetadata(null, null));

        [ExcludeFromCodeCoverage]
        public Style TextBoxStyle
        {
            get => GetValue(TextBoxStyleProperty) as Style;
            set => SetValue(TextBoxStyleProperty, value);
        }

        public static readonly DependencyProperty TextBoxStyleProperty =
            DependencyProperty.Register(nameof(TextBoxStyle), typeof(Style), typeof(AutoCompleteBox), new PropertyMetadata(null));

        [ExcludeFromCodeCoverage]
        public double MaxDropDownHeight
        {
            get => (double)GetValue(MaxDropDownHeightProperty);
            set => SetValue(MaxDropDownHeightProperty, value);
        }

        public static readonly DependencyProperty MaxDropDownHeightProperty =
            DependencyProperty.Register(nameof(MaxDropDownHeight), typeof(double), typeof(AutoCompleteBox), new PropertyMetadata(double.PositiveInfinity, OnMaxDropDownHeightPropertyChanged));

        [SuppressMessage("Microsoft.Usage", "CA2208:InstantiateArgumentExceptionsCorrectly", Justification = "The exception will be called through a CLR setter in most cases.")]
        static void OnMaxDropDownHeightPropertyChanged(DependencyObject d, DependencyPropertyChangedEventArgs e)
        {
            if (d is AutoCompleteBox source && source._ignorePropertyChange)
            {
                source._ignorePropertyChange = false;
                return;
            }

            var newValue = (double)e.NewValue;

            if (newValue < 0)
            {
                if (d is AutoCompleteBox source)
                {
                    source._ignorePropertyChange = true;
                    source.SetValue(e.Property, e.OldValue);
                }

                throw new ArgumentException(string.Format(CultureInfo.InvariantCulture, Dev2.Runtime.Configuration.Properties.Resources.AutoComplete_OnMaxDropDownHeightPropertyChanged_InvalidValue, e.NewValue));
            }

            source?.OnMaxDropDownHeightChanged(newValue);
        }

        public static readonly DependencyProperty IsDropDownOpenProperty =
            DependencyProperty.Register(nameof(IsDropDownOpen), typeof(bool), typeof(AutoCompleteBox), new PropertyMetadata(false, OnIsDropDownOpenPropertyChanged));

        public bool IsDropDownOpen
        {
            get => (bool)GetValue(IsDropDownOpenProperty);
            set => SetValue(IsDropDownOpenProperty, value);
        }

        static void OnIsDropDownOpenPropertyChanged(DependencyObject d, DependencyPropertyChangedEventArgs e)
        {
            if (d is AutoCompleteBox source && source._ignorePropertyChange)
            {
                source._ignorePropertyChange = false;
                return;
            }

            var oldValue = (bool)e.OldValue;
            var newValue = (bool)e.NewValue;

            if (d is AutoCompleteBox source)
            {
                if (newValue)
                {
                    source.TextUpdated(source.Text, true);
                }
                else
                {
                    source.ClosingDropDown(oldValue);
                }

                source.UpdateVisualState(true);
            }
        }

        public IEnumerable ItemsSource
        {
            get => GetValue(ItemsSourceProperty) as IEnumerable;
            set => SetValue(ItemsSourceProperty, value);
        }

        public static readonly DependencyProperty ItemsSourceProperty =
            DependencyProperty.Register(nameof(ItemsSource), typeof(IEnumerable), typeof(AutoCompleteBox), new PropertyMetadata(OnItemsSourcePropertyChanged));

        static void OnItemsSourcePropertyChanged(DependencyObject d, DependencyPropertyChangedEventArgs e)
        {
            var autoComplete = d as AutoCompleteBox;
            autoComplete?.OnItemsSourceChanged((IEnumerable)e.OldValue, (IEnumerable)e.NewValue);
        }

        public object SelectedItem
        {
            get => GetValue(SelectedItemProperty);
            set => SetValue(SelectedItemProperty, value);
        }

        public static readonly DependencyProperty SelectedItemProperty =
            DependencyProperty.Register(nameof(SelectedItem), typeof(object), typeof(AutoCompleteBox), new PropertyMetadata(OnSelectedItemPropertyChanged));

        static void OnSelectedItemPropertyChanged(DependencyObject d, DependencyPropertyChangedEventArgs e)
        {
            if (d is AutoCompleteBox source)
            {
                if (source._ignorePropertyChange)
                {
                    source._ignorePropertyChange = false;
                    return;
                }

                if (source._skipSelectedItemTextUpdate)
                {
                    source._skipSelectedItemTextUpdate = false;
                }
                else
                {
                    source.OnSelectedItemChanged(e.NewValue);
                }
            }

            var removed = new List<object>();
            if (e.OldValue != null)
            {
                removed.Add(e.OldValue);
            }

            var added = new List<object>();
            if (e.NewValue != null)
            {
                added.Add(e.NewValue);
            }

            source?.OnSelectionChanged(new SelectionChangedEventArgs(SelectionChangedEvent, removed, added));
        }

        void OnSelectedItemChanged(object newItem)
        {
            if (CustomSelection)
            {
                return;
            }
            var text = newItem == null ? SearchText : FormatValue(newItem, true);

            UpdateTextValue(text);

            if (TextBox != null && Text != null)
            {
                TextBox.SelectionStart = Text.Length;
            }
        }

        public bool CustomSelection { get; set; }

        public string Text
        {
            get => GetValue(TextProperty) as string;
            set => SetValue(TextProperty, value);
        }

        public static readonly DependencyProperty TextProperty =
            DependencyProperty.Register(nameof(Text), typeof(string), typeof(AutoCompleteBox), new PropertyMetadata(string.Empty, OnTextPropertyChanged));

        static void OnTextPropertyChanged(DependencyObject d, DependencyPropertyChangedEventArgs e)
        {
            var source = d as AutoCompleteBox;
            source?.TextUpdated((string)e.NewValue, false);
        }

        public string SearchText
        {
            get => (string)GetValue(SearchTextProperty);
            private set
            {
                try
                {
                    _allowWrite = true;
                    SetValue(SearchTextProperty, value);
                }
                finally
                {
                    _allowWrite = false;
                }
            }
        }

        public static readonly DependencyProperty SearchTextProperty =
            DependencyProperty.Register(nameof(SearchText), typeof(string), typeof(AutoCompleteBox), new PropertyMetadata(string.Empty, OnSearchTextPropertyChanged));

        static void OnSearchTextPropertyChanged(DependencyObject d, DependencyPropertyChangedEventArgs e)
        {
            if (d is AutoCompleteBox source && source._ignorePropertyChange)
            {
                source._ignorePropertyChange = false;
                return;
            }

            if (d is AutoCompleteBox source && !source._allowWrite)
            {
                source._ignorePropertyChange = true;
                source.SetValue(e.Property, e.OldValue);

                throw new InvalidOperationException(Dev2.Runtime.Configuration.Properties.Resources.AutoComplete_OnSearchTextPropertyChanged_InvalidWrite);
            }
        }

        public AutoCompleteFilterMode FilterMode
        {
            get => (AutoCompleteFilterMode)GetValue(FilterModeProperty);
            set => SetValue(FilterModeProperty, value);
        }

        public static readonly DependencyProperty FilterModeProperty =
            DependencyProperty.Register(nameof(FilterMode), typeof(AutoCompleteFilterMode), typeof(AutoCompleteBox), new PropertyMetadata(AutoCompleteFilterMode.StartsWith, OnFilterModePropertyChanged));

        [SuppressMessage("Microsoft.Usage", "CA2208:InstantiateArgumentExceptionsCorrectly", Justification = "The exception will be thrown when the CLR setter is used in most situations.")]
        [ExcludeFromCodeCoverage]
        static void OnFilterModePropertyChanged(DependencyObject d, DependencyPropertyChangedEventArgs e)
        {
            var mode = (AutoCompleteFilterMode)e.NewValue;

            var modeNotContainingFilterMode = mode != AutoCompleteFilterMode.Contains;
            modeNotContainingFilterMode &= mode != AutoCompleteFilterMode.EqualsCaseSensitive;
            modeNotContainingFilterMode &= mode != AutoCompleteFilterMode.StartsWith;
            modeNotContainingFilterMode &= mode != AutoCompleteFilterMode.Custom;
            modeNotContainingFilterMode &= mode != AutoCompleteFilterMode.None;

            if (modeNotContainingFilterMode)
            {
                source?.SetValue(e.Property, e.OldValue);
                throw new ArgumentException(Dev2.Runtime.Configuration.Properties.Resources.AutoComplete_OnFilterModePropertyChanged_InvalidValue);
            }

            var newValue = (AutoCompleteFilterMode)e.NewValue;

            if (d is AutoCompleteBox source)
            {
                source.TextFilter = AutoCompleteSearch.GetFilter(newValue);
            }
        }

        public AutoCompleteFilterPredicate<object> ItemFilter
        {
            get => GetValue(ItemFilterProperty) as AutoCompleteFilterPredicate<object>;
            set => SetValue(ItemFilterProperty, value);
        }

        public static readonly DependencyProperty ItemFilterProperty =
            DependencyProperty.Register(nameof(ItemFilter), typeof(AutoCompleteFilterPredicate<object>), typeof(AutoCompleteBox), new PropertyMetadata(OnItemFilterPropertyChanged));

        static void OnItemFilterPropertyChanged(DependencyObject d, DependencyPropertyChangedEventArgs e)
        {
            if (e.NewValue is AutoCompleteFilterPredicate<object>)
            {
                if (d is AutoCompleteBox autoCompleteBox)
                {
                    autoCompleteBox.FilterMode = AutoCompleteFilterMode.Custom;
                    autoCompleteBox.TextFilter = null;
                }
                return;
            }

            if (d is AutoCompleteBox autoCompleteBox)
            {
                autoCompleteBox.FilterMode = AutoCompleteFilterMode.None;
            }
        }

        public AutoCompleteFilterPredicate<string> TextFilter
        {
            get => GetValue(TextFilterProperty) as AutoCompleteFilterPredicate<string>;
            set => SetValue(TextFilterProperty, value);
        }

        public static readonly DependencyProperty TextFilterProperty =
            DependencyProperty.Register(nameof(TextFilter), typeof(AutoCompleteFilterPredicate<string>), typeof(AutoCompleteBox), new PropertyMetadata(AutoCompleteSearch.GetFilter(AutoCompleteFilterMode.StartsWith)));

        PopupHelper DropDownPopup { get; set; }
        TextBox _text;
        ISelectionAdapter _adapter;

        public TextBox TextBox
        {
            get => _text;
            set
            {
                if (_text != null)
                {
                    _text.SelectionChanged -= OnTextBoxSelectionChanged;
                    _text.TextChanged -= OnTextBoxTextChanged;
                }
                _text = value;
                if (_text != null)
                {
                    _text.SelectionChanged += OnTextBoxSelectionChanged;
                    _text.TextChanged += OnTextBoxTextChanged;

                    if (Text != null)
                    {
                        UpdateTextValue(Text);
                    }
                }
            }
        }

        protected internal ISelectionAdapter SelectionAdapter
        {
            get => _adapter;
            set
            {
                if (_adapter != null)
                {
                    _adapter.SelectionChanged -= OnAdapterSelectionChanged;
                    _adapter.Commit -= OnAdapterSelectionComplete;
                    _adapter.Cancel -= OnAdapterSelectionCanceled;
                    _adapter.Cancel -= OnAdapterSelectionComplete;
                    _adapter.ItemsSource = null;
                }

                _adapter = value;

                if (_adapter != null)
                {
                    _adapter.SelectionChanged += OnAdapterSelectionChanged;
                    _adapter.Commit += OnAdapterSelectionComplete;
                    _adapter.Cancel += OnAdapterSelectionCanceled;
                    _adapter.Cancel += OnAdapterSelectionComplete;
                    _adapter.ItemsSource = _view;
                }
            }
        }

        public static readonly DependencyProperty HasErrorProperty =
            DependencyProperty.Register(nameof(HasError), typeof(bool), typeof(AutoCompleteBox), new PropertyMetadata(false));

        public bool HasError
        {
            get => (bool)GetValue(HasErrorProperty);
            set => SetValue(HasErrorProperty, value);
        }

        public static readonly RoutedEvent TextChangedEvent = EventManager.RegisterRoutedEvent(nameof(TextChanged), RoutingStrategy.Bubble, typeof(RoutedEventHandler), typeof(AutoCompleteBox));

        public event RoutedEventHandler TextChanged
        {
            add { AddHandler(TextChangedEvent, value); }
            remove { RemoveHandler(TextChangedEvent, value); }
        }

        public static readonly RoutedEvent PopulatingEvent = EventManager.RegisterRoutedEvent(nameof(Populating), RoutingStrategy.Bubble, typeof(PopulatingEventHandler), typeof(AutoCompleteBox));

        public event PopulatingEventHandler Populating
        {
            add { AddHandler(PopulatingEvent, value); }
            remove { RemoveHandler(PopulatingEvent, value); }
        }

        public static readonly RoutedEvent PopulatedEvent = EventManager.RegisterRoutedEvent(nameof(Populated), RoutingStrategy.Bubble, typeof(PopulatedEventHandler), typeof(AutoCompleteBox));

        public event PopulatedEventHandler Populated
        {
            add { AddHandler(PopulatedEvent, value); }
            remove { RemoveHandler(PopulatedEvent, value); }
        }

        public static readonly RoutedEvent DropDownOpeningEvent = EventManager.RegisterRoutedEvent(nameof(DropDownOpening), RoutingStrategy.Bubble, typeof(RoutedPropertyChangingEventHandler<bool>), typeof(AutoCompleteBox));

        public event RoutedPropertyChangingEventHandler<bool> DropDownOpening
        {
            add { AddHandler(PopulatedEvent, value); }
            remove { RemoveHandler(PopulatedEvent, value); }
        }

        public static readonly RoutedEvent DropDownOpenedEvent = EventManager.RegisterRoutedEvent(nameof(DropDownOpened), RoutingStrategy.Bubble, typeof(RoutedPropertyChangedEventHandler<bool>), typeof(AutoCompleteBox));

        public event RoutedPropertyChangedEventHandler<bool> DropDownOpened
        {
            add { AddHandler(DropDownOpenedEvent, value); }
            remove { RemoveHandler(DropDownOpenedEvent, value); }
        }

        public static readonly RoutedEvent DropDownClosingEvent = EventManager.RegisterRoutedEvent(nameof(DropDownClosing), RoutingStrategy.Bubble, typeof(RoutedPropertyChangingEventHandler<bool>), typeof(AutoCompleteBox));

        public event RoutedPropertyChangingEventHandler<bool> DropDownClosing
        {
            add { AddHandler(DropDownClosingEvent, value); }
            remove { RemoveHandler(DropDownClosingEvent, value); }
        }

        public static readonly RoutedEvent DropDownClosedEvent = EventManager.RegisterRoutedEvent(nameof(DropDownClosed), RoutingStrategy.Bubble, typeof(RoutedPropertyChangedEventHandler<bool>), typeof(AutoCompleteBox));

        public event RoutedPropertyChangedEventHandler<bool> DropDownClosed
        {
            add { AddHandler(DropDownClosedEvent, value); }
            remove { RemoveHandler(DropDownClosedEvent, value); }
        }

        public static readonly RoutedEvent SelectionChangedEvent = EventManager.RegisterRoutedEvent(nameof(SelectionChanged), RoutingStrategy.Bubble, typeof(SelectionChangedEventHandler), typeof(AutoCompleteBox));

        public event SelectionChangedEventHandler SelectionChanged
        {
            add { AddHandler(SelectionChangedEvent, value); }
            remove { RemoveHandler(SelectionChangedEvent, value); }
        }

        public Binding ValueMemberBinding
        {
            get => _valueBindingEvaluator?.ValueBinding;
            set => _valueBindingEvaluator = new BindingEvaluator<string>(value);
        }

        public string ValueMemberPath
        {
            get => ValueMemberBinding?.Path.Path;
            set => ValueMemberBinding = value == null ? null : new Binding(value);
        }

        public ObservableCollection<object> View => _view;

        static AutoCompleteBox()
        {
            DefaultStyleKeyProperty.OverrideMetadata(typeof(AutoCompleteBox), new FrameworkPropertyMetadata(typeof(AutoCompleteBox)));
        }

        public AutoCompleteBox()
        {
            IsEnabledChanged += ControlIsEnabledChanged;
            Interaction = new InteractionHelper(this);

            ClearView();
            if (Application.Current != null)
            {
                Style = Application.Current.TryFindResource("AutoCompleteBoxStyle") as Style;
            }
        }

        protected override Size ArrangeOverride(Size arrangeBounds)
        {
            var r = base.ArrangeOverride(arrangeBounds);
            DropDownPopup?.Arrange();
            return r;
        }

        public override void OnApplyTemplate()
        {
            if (TextBox != null)
            {
                TextBox.PreviewKeyDown -= OnTextBoxPreviewKeyDown;
            }

            if (DropDownPopup != null)
            {
                DropDownPopup.Closed -= DropDownPopupClosed;
                DropDownPopup.FocusChanged -= OnDropDownFocusChanged;
                DropDownPopup.UpdateVisualStates -= OnDropDownPopupUpdateVisualStates;
                DropDownPopup.BeforeOnApplyTemplate();
                DropDownPopup = null;
            }

            base.OnApplyTemplate();

            if (GetTemplateChild("Popup") is Popup popup)
            {
                DropDownPopup = new PopupHelper(this, popup) { MaxDropDownHeight = MaxDropDownHeight };
                DropDownPopup.AfterOnApplyTemplate();
                DropDownPopup.Closed += DropDownPopupClosed;
                DropDownPopup.FocusChanged += OnDropDownFocusChanged;
                DropDownPopup.UpdateVisualStates += OnDropDownPopupUpdateVisualStates;
            }
            SelectionAdapter = GetSelectionAdapterPart();
            TextBox = GetTemplateChild("Text") as TextBox;

            if (TextBox != null)
            {
                TextBox.PreviewKeyDown += OnTextBoxPreviewKeyDown;
            }

            Interaction.OnApplyTemplateBase();

            if (IsDropDownOpen && DropDownPopup != null && !DropDownPopup.IsOpen)
            {
                OpeningDropDown(false);
            }
        }

        void OnDropDownPopupUpdateVisualStates(object sender, EventArgs e)
        {
            UpdateVisualState(true);
        }

        void OnDropDownFocusChanged(object sender, EventArgs e)
        {
            FocusChanged(HasFocus());
        }

        void ClosingDropDown(bool oldValue)
        {
            var delayedClosingVisual = false;
            if (DropDownPopup != null)
            {
                delayedClosingVisual = DropDownPopup.UsesClosingVisualState;
            }

            var args = new RoutedPropertyChangingEventArgs<bool>(IsDropDownOpenProperty, oldValue, false, true, DropDownClosingEvent);
            OnDropDownClosing(args);

            if (_view == null || _view.Count == 0)
            {
                delayedClosingVisual = false;
            }

            if (args.Cancel)
            {
                _ignorePropertyChange = true;
                SetValue(IsDropDownOpenProperty, oldValue);
            }
            else
            {
                RaiseExpandCollapseAutomationEvent(oldValue, false);
                if (!delayedClosingVisual)
                {
                    CloseDropDown(oldValue, false);
                }
            }

            UpdateVisualState(true);
        }

        void OpeningDropDown(bool oldValue)
        {
            var args = new RoutedPropertyChangingEventArgs<bool>(IsDropDownOpenProperty, oldValue, true, true, DropDownOpeningEvent);
            OnDropDownOpening(args);

            if (args.Cancel)
            {
                _ignorePropertyChange = true;
                SetValue(IsDropDownOpenProperty, oldValue);
            }
            else
            {
                RaiseExpandCollapseAutomationEvent(oldValue, true);
                OpenDropDown(oldValue, true);
            }

            UpdateVisualState(true);
        }

        void RaiseExpandCollapseAutomationEvent(bool oldValue, bool newValue)
        {
            var peer = UIElementAutomationPeer.FromElement(this) as AutoCompleteBoxAutomationPeer;
            peer?.RaiseExpandCollapseAutomationEvent(oldValue, newValue);
        }

        void OnTextBoxPreviewKeyDown(object sender, KeyEventArgs e)
        {
            OnKeyDown(e);
        }

        void DropDownPopupClosed(object sender, EventArgs e)
        {
            if (IsDropDownOpen)
            {
                IsDropDownOpen = false;
            }

            if (_popupHasOpened)
            {
                OnDropDownClosed(new RoutedPropertyChangedEventArgs<bool>(true, false, DropDownClosedEvent));
            }
        }

        protected override AutomationPeer OnCreateAutomationPeer() => new AutoCompleteBoxAutomationPeer(this);

        void FocusChanged(bool hasFocus)
        {
            if (!hasFocus)
            {
                IsDropDownOpen = false;
                _userCalledPopulate = false;
                TextBox?.Select(TextBox.Text.Length, 0);
            }
        }

        protected bool HasFocus()
        {
            var focused = IsKeyboardFocusWithin ? Keyboard.FocusedElement as DependencyObject : FocusManager.GetFocusedElement(this) as DependencyObject;
            while (focused != null)
            {
                if (ReferenceEquals(focused, this))
                {
                    return true;
                }

                var parent = VisualTreeHelper.GetParent(focused);
                if (parent == null && focused is FrameworkElement element)
                {
                    parent = element.Parent;
                }

                focused = parent;
            }
            return false;
        }

        protected override void OnGotFocus(RoutedEventArgs e)
        {
            base.OnGotFocus(e);
            FocusChanged(HasFocus());
        }

        protected override void OnIsKeyboardFocusWithinChanged(DependencyPropertyChangedEventArgs e)
        {
            base.OnIsKeyboardFocusWithinChanged(e);
            if (!IsKeyboardFocusWithin)
            {
                IsDropDownOpen = false;
            }
        }

        protected override void OnLostFocus(RoutedEventArgs e)
        {
            base.OnLostFocus(e);
            FocusChanged(HasFocus());
        }

        void ControlIsEnabledChanged(object sender, DependencyPropertyChangedEventArgs e)
        {
            var isEnabled = (bool)e.NewValue;
            if (!isEnabled)
            {
                IsDropDownOpen = false;
            }
        }

        [SuppressMessage("Microsoft.Design", "CA1024:UsePropertiesWhereAppropriate", Justification = "Following the GetTemplateChild pattern for the method.")]
        [ExcludeFromCodeCoverage]
        protected virtual ISelectionAdapter GetSelectionAdapterPart()
        {
            ISelectionAdapter adapter = null;
            if (GetTemplateChild("Selector") is Selector selector)
            {
                adapter = selector as ISelectionAdapter ?? new SelectorSelectionAdapter(selector);
            }

            return adapter ?? GetTemplateChild("SelectionAdapter") as ISelectionAdapter;
        }

        [ExcludeFromCodeCoverage]
        void PopulateDropDown(object sender, EventArgs e)
        {
            _delayTimer?.Stop();
            SearchText = Text;

            var populating = new PopulatingEventArgs(SearchText, PopulatingEvent);

            OnPopulating(populating);
            if (!populating.Cancel)
            {
                PopulateComplete();
            }
        }

        protected virtual void OnPopulating(PopulatingEventArgs e)
        {
            RaiseEvent(e);
        }

        [ExcludeFromCodeCoverage]
        protected virtual void OnPopulated(PopulatedEventArgs e)
        {
            RaiseEvent(e);
        }

        [ExcludeFromCodeCoverage]
        protected virtual void OnSelectionChanged(SelectionChangedEventArgs e)
        {
            RaiseEvent(e);

            var box = (AutoCompleteBox)e.Source;
            var innerListBox = (ListBox)box?.Template?.FindName("Selector", box);
            innerListBox?.ScrollIntoView(innerListBox.SelectedItem);

            RaiseEvent(e);
        }

        [ExcludeFromCodeCoverage]
        protected virtual void OnDropDownOpening(RoutedPropertyChangingEventArgs<bool> e)
        {
            RaiseEvent(e);
        }

        [ExcludeFromCodeCoverage]
        protected virtual void OnDropDownOpened(RoutedPropertyChangedEventArgs<bool> e)
        {
            RaiseEvent(e);
        }

        [ExcludeFromCodeCoverage]
        protected virtual void OnDropDownClosing(RoutedPropertyChangingEventArgs<bool> e)
        {
            RaiseEvent(e);
        }

        protected virtual void OnDropDownClosed(RoutedPropertyChangedEventArgs<bool> e)
        {
            RaiseEvent(e);
        }

        string FormatValue(object value, bool clearDataContext)
        {
            var str = FormatValue(value);
            if (clearDataContext)
            {
                _valueBindingEvaluator?.ClearDataContext();
            }
            return str;
        }

        protected virtual string FormatValue(object value)
        {
            if (_valueBindingEvaluator != null)
            {
                return _valueBindingEvaluator.GetDynamicValue(value) ?? string.Empty;
            }

            return value?.ToString() ?? string.Empty;
        }

        protected virtual void OnTextChanged(RoutedEventArgs e)
        {
            RaiseEvent(e);
        }

        void OnTextBoxTextChanged(object sender, TextChangedEventArgs e)
        {
            TextUpdated(_text.Text, true);
        }

        void OnTextBoxSelectionChanged(object sender, RoutedEventArgs e)
        {
            if (_ignoreTextSelectionChange)
            {
                return;
            }

            _textSelectionStart = _text.SelectionStart;
        }

        void UpdateTextValue(string value)
        {
            UpdateTextValue(value, null);
        }

        void UpdateTextValue(string value, bool? userInitiated)
        {
            var textUpdated = false;

            if ((userInitiated is null || userInitiated == true) && Text != value)
            {
                _ignoreTextPropertyChange++;
                Text = value;
                textUpdated = true;
            }

            if (TextBox is null)
            {
                Text = value;
                textUpdated = true;
            }

            var textBoxUpdated = UpdateTextBoxValue(value, userInitiated);

            if (textUpdated || textBoxUpdated)
            {
                OnTextChanged(new RoutedEventArgs(TextChangedEvent));
            }
        }

        private bool UpdateTextBoxValue(string value, bool? userInitiated)
        {
            if ((userInitiated is null || userInitiated == false) && TextBox != null && TextBox.Text != value)
            {
                _ignoreTextPropertyChange++;
                TextBox.Text = value ?? string.Empty;

                if (Text == value || Text is null)
                {
                    return true;
                }
            }
            return false;
        }

        void TextUpdated(string newText, bool userInitiated)
        {
            if (_ignoreTextPropertyChange > 0)
            {
                _ignoreTextPropertyChange--;
                return;
            }

            var text = newText;

            if (text == null)
            {
                text = string.Empty;
            }

            if (IsTextCompletionEnabled && TextBox != null && TextBox.SelectionLength > 0 && TextBox.SelectionStart != TextBox.Text.Length)
            {
                return;
            }

            var populateReady = text.Length >= MinimumPrefixLength && MinimumPrefixLength >= 0;
            _userCalledPopulate = populateReady && userInitiated;

            UpdateTextValue(text, userInitiated);

            if (populateReady)
            {
                PopulateReady();
                return;
            }
            PopulateNotReady();
        }

        private void PopulateReady()
        {
            _ignoreTextSelectionChange = true;

            if (_delayTimer != null)
            {
                _delayTimer.Start();
            }
            else
            {
                PopulateDropDown(this, EventArgs.Empty);
            }
        }

        private void PopulateNotReady()
        {
            SearchText = string.Empty;
            if (SelectedItem != null)
            {
                _skipSelectedItemTextUpdate = true;
            }
            SelectedItem = null;
            if (IsDropDownOpen)
            {
                IsDropDownOpen = false;
            }
        }

        public void PopulateComplete()
        {
            RefreshView();

            var populated = new PopulatedEventArgs(new ReadOnlyCollection<object>(_view), PopulatedEvent);
            OnPopulated(populated);

            if (SelectionAdapter != null && !SelectionAdapter.ItemsSource.Equals(_view))
            {
                SelectionAdapter.ItemsSource = _view;
            }

            var isDropDownOpen = _userCalledPopulate && _view.Count > 0;
            if (isDropDownOpen != IsDropDownOpen)
            {
                _ignorePropertyChange = true;
                IsDropDownOpen = isDropDownOpen;
            }
            if (IsDropDownOpen)
            {
                OpeningDropDown(false);
                DropDownPopup?.Arrange();
            }
            else
            {
                ClosingDropDown(true);
            }

            UpdateTextCompletion(_userCalledPopulate);
        }

        void UpdateTextCompletion(bool userInitiated)
        {
            object newSelectedItem = null;
            var text = Text;
            if (_view.Count > 0)
            {
                if (IsTextCompletionEnabled && TextBox != null && userInitiated)
                {
                    var currentLength = TextBox.Text.Length;
                    var selectionStart = TextBox.SelectionStart;
                    newSelectedItem = UpdateSelection(newSelectedItem, text, currentLength, selectionStart);
                }
                else
                {
                    newSelectedItem = TryGetMatch(text, _view, AutoCompleteSearch.GetFilter(AutoCompleteFilterMode.EqualsCaseSensitive));
                }
            }
            if (SelectedItem != newSelectedItem)
            {
                _skipSelectedItemTextUpdate = true;
            }
            SelectedItem = newSelectedItem;
            if (_ignoreTextSelectionChange)
            {
                _ignoreTextSelectionChange = false;
                if (TextBox != null)
                {
                    _textSelectionStart = TextBox.SelectionStart;
                }
            }
        }

        private object UpdateSelection(object newSelectedItem, string text, int currentLength, int selectionStart)
        {
            var selectedItem = newSelectedItem;
            if (selectionStart == text.Length && selectionStart > _textSelectionStart)
            {
                var top = FilterMode == AutoCompleteFilterMode.StartsWith || FilterMode == AutoCompleteFilterMode.StartsWithCaseSensitive
                    ? _view[0]
                    : TryGetMatch(text, _view, AutoCompleteSearch.GetFilter(AutoCompleteFilterMode.StartsWith));
                if (top != null)
                {
                    selectedItem = top;
                    var topString = FormatValue(top, true);
                    var minLength = Math.Min(topString.Length, Text.Length);
                    if (AutoCompleteSearch.Equals(Text.Substring(0, minLength), topString.Substring(0, minLength)))
                    {
                        UpdateTextValue(topString);
                        TextBox.SelectionStart = currentLength;
                        TextBox.SelectionLength = topString.Length - currentLength;
                    }
                }
            }

            return selectedItem;
        }

        object TryGetMatch(string searchText, ObservableCollection<object> view, AutoCompleteFilterPredicate<string> predicate)
        {
            if (view != null && view.Count > 0)
            {
                return view.FirstOrDefault(o => predicate?.Invoke(searchText, FormatValue(o)) ?? default(bool));
            }

            return null;
        }

        void ClearView()
        {
            if (_view == null)
            {
                _view = new ObservableCollection<object>();
            }
            else
            {
                _view.Clear();
            }
        }

        void RefreshView()
        {
            if (_items == null)
            {
                ClearView();
                return;
            }

            _view.Clear();

            var filteredItems = GetFilteredItems();
            foreach (var item in filteredItems)
            {
                _view.Add(item);
            }

            _valueBindingEvaluator?.ClearDataContext();
        }

        private IEnumerable<object> GetFilteredItems()
        {
            var text = Text ?? string.Empty;
            var stringFiltering = TextFilter != null;
            var objectFiltering = FilterMode == AutoCompleteFilterMode.Custom && TextFilter == null;

            var filteredItems = _items.Where(item =>
            {
                var isAutoCompleteMatch = !(stringFiltering || objectFiltering);
                if (!isAutoCompleteMatch)
                {
                    isAutoCompleteMatch = stringFiltering ? TextFilter?.Invoke(text, FormatValue(item)) ?? default(bool) : ItemFilter?.Invoke(text, item) ?? default(bool);
                }
                return isAutoCompleteMatch;
            });
            return filteredItems;
        }

        [SuppressMessage("Microsoft.Usage", "CA1801:ReviewUnusedParameters", MessageId = "oldValue", Justification = "This makes it easy to add validation or other changes in the future.")]
        [ExcludeFromCodeCoverage]
        void OnItemsSourceChanged(IEnumerable oldValue, IEnumerable newValue)
        {
            _items = newValue == null ? null : new List<object>(newValue.Cast<object>().ToList());
            ClearView();
            if (SelectionAdapter != null && !SelectionAdapter.ItemsSource.Equals(_view))
            {
                SelectionAdapter.ItemsSource = _view;
            }
            if (IsDropDownOpen)
            {
                RefreshView();
            }
        }

        [ExcludeFromCodeCoverage]
        void OnAdapterSelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            SelectedItem = _adapter.SelectedItem;
        }

        [ExcludeFromCodeCoverage]
        void OnAdapterSelectionComplete(object sender, RoutedEventArgs e)
        {
            IsDropDownOpen = false;
            UpdateTextCompletion(false);
            TextBox?.Select(TextBox.Text.Length, 0);

            if (TextBox != null)
            {
                Keyboard.Focus(TextBox);
            }
            else
            {
                Focus();
            }
        }

        [ExcludeFromCodeCoverage]
        void OnAdapterSelectionCanceled(object sender, RoutedEventArgs e)
        {
            UpdateTextValue(SearchText);
            UpdateTextCompletion(false);
        }

        [SuppressMessage("Microsoft.Usage", "CA1801:ReviewUnusedParameters", MessageId = "newValue", Justification = "This makes it easy to add validation or other changes in the future.")]
        [ExcludeFromCodeCoverage]
        void OnMaxDropDownHeightChanged(double newValue)
        {
            if (DropDownPopup != null)
            {
                DropDownPopup.MaxDropDownHeight = newValue;
                DropDownPopup.Arrange();
            }
            UpdateVisualState(true);
        }

        void OpenDropDown(bool oldValue, bool newValue)
        {
            if (DropDownPopup != null)
            {
                DropDownPopup.IsOpen = true;
            }
            _popupHasOpened = true;
            OnDropDownOpened(new RoutedPropertyChangedEventArgs<bool>(oldValue, newValue, DropDownOpenedEvent));
        }

        protected void CloseDropDown(bool oldValue, bool newValue)
        {
            if (_popupHasOpened)
            {
                if (SelectionAdapter != null)
                {
                    SelectionAdapter.SelectedItem = null;
                }
                if (DropDownPopup != null)
                {
                    DropDownPopup.IsOpen = false;
                }
                OnDropDownClosed(new RoutedPropertyChangedEventArgs<bool>(oldValue, newValue, DropDownClosedEvent));
            }
        }

        protected override void OnKeyDown(KeyEventArgs e)
        {
            if (e == null)
            {
                throw new ArgumentNullException();
            }

            base.OnKeyDown(e);

            if (e.Handled || !IsEnabled)
            {
                return;
            }
            if (IsDropDownOpen)
            {
                if (SelectionAdapter != null)
                {
                    SelectionAdapter.HandleKeyDown(e);
                    if (e.Handled)
                    {
                        return;
                    }
                }

                switch (e.Key)
                {
                    case Key.F4:
                        IsDropDownOpen = !IsDropDownOpen;
                        e.Handled = true;
                        break;
                    case Key.Enter:
                    case Key.Escape:
                        OnAdapterSelectionComplete(this, new RoutedEventArgs());
                        e.Handled = true;
                        break;
                    default:
                        e.Handled = false;
                        break;
                }
            }
        }

        void IUpdateVisualState.UpdateVisualState(bool useTransitions)
        {
            UpdateVisualState(useTransitions);
        }

        internal virtual void UpdateVisualState(bool useTransitions)
        {
            VisualStateManager.GoToState(this, IsDropDownOpen ? VisualStates.StatePopupOpened : VisualStates.StatePopupClosed, useTransitions);
            Interaction.UpdateVisualStateBase(useTransitions);
        }
    }
}
---- Semantic diagnostics *before* transformation ----

---- Semantic diagnostics *after* transformation ----
D:\a\1\s\Dev\Dev2.Runtime.Configuration\CustomControls\AutoCompleteBox.cs(106,42): error CS0136: A local or parameter named 'source' cannot be declared in this scope because that name is used in an enclosing local scope to define a local or parameter,D:\a\1\s\Dev\Dev2.Runtime.Configuration\CustomControls\AutoCompleteBox.cs(116,32): error CS0165: Use of unassigned local variable 'source',D:\a\1\s\Dev\Dev2.Runtime.Configuration\CustomControls\AutoCompleteBox.cs(233,42): error CS0136: A local or parameter named 'source' cannot be declared in this scope because that name is used in an enclosing local scope to define a local or parameter,D:\a\1\s\Dev\Dev2.Runtime.Configuration\CustomControls\AutoCompleteBox.cs(242,13): error CS0165: Use of unassigned local variable 'source',D:\a\1\s\Dev\Dev2.Runtime.Configuration\CustomControls\AutoCompleteBox.cs(265,38): error CS0128: A local variable or function named 'source' is already defined in this scope,D:\a\1\s\Dev\Dev2.Runtime.Configuration\CustomControls\AutoCompleteBox.cs(269,21): error CS0165: Use of unassigned local variable 'source',D:\a\1\s\Dev\Dev2.Runtime.Configuration\CustomControls\AutoCompleteBox.cs(336,13): error CS0165: Use of unassigned local variable 'source',D:\a\1\s\Dev\Dev2.Runtime.Configuration\CustomControls\AutoCompleteBox.cs(400,38): error CS0128: A local variable or function named 'source' is already defined in this scope,D:\a\1\s\Dev\Dev2.Runtime.Configuration\CustomControls\AutoCompleteBox.cs(400,49): error CS0165: Use of unassigned local variable 'source',D:\a\1\s\Dev\Dev2.Runtime.Configuration\CustomControls\AutoCompleteBox.cs(432,17): error CS0841: Cannot use local variable 'source' before it is declared,D:\a\1\s\Dev\Dev2.Runtime.Configuration\CustomControls\AutoCompleteBox.cs(457,42): error CS0136: A local or parameter named 'autoCompleteBox' cannot be declared in this scope because that name is used in an enclosing local scope to define a local or parameter
######################################################################


######################################################################
Nr: 13 - UsePatternMatchingRewriterR8
Filepath: D:\a\1\s\Dev\Dev2.CustomControls\Converters\MultipleBoolToEnabledConverter.cs
Description: Error: The created Syntax Tree is semantically incorrect.
------------------------------------------------------------------------
---- Original Tree ----
using System;
using System.Globalization;
using System.Windows.Data;

namespace Dev2.CustomControls.Converters
{
    public class MultipleBoolToEnabledConverter : IMultiValueConverter
    {
        #region Implementation of IMultiValueConverter

        /// <summary>
        ///     Converts source values to a value for the binding target. The data binding engine calls this method when it
        ///     propagates the values from source bindings to the binding target.
        /// </summary>
        /// <returns>
        ///     A converted value.If the method returns null, the valid null value is used.A return value of
        ///     <see cref="T:System.Windows.DependencyProperty" />.<see cref="F:System.Windows.DependencyProperty.UnsetValue" />
        ///     indicates that the converter did not produce a value, and that the binding will use the
        ///     <see cref="P:System.Windows.Data.BindingBase.FallbackValue" /> if it is available, or else will use the default
        ///     value.A return value of <see cref="T:System.Windows.Data.Binding" />.
        ///     <see cref="F:System.Windows.Data.Binding.DoNothing" /> indicates that the binding does not transfer the value or
        ///     use the <see cref="P:System.Windows.Data.BindingBase.FallbackValue" /> or the default value.
        /// </returns>
        /// <param name="values">
        ///     The array of values that the source bindings in the
        ///     <see cref="T:System.Windows.Data.MultiBinding" /> produces. The value
        ///     <see cref="F:System.Windows.DependencyProperty.UnsetValue" /> indicates that the source binding has no value to
        ///     provide for conversion.
        /// </param>
        /// <param name="targetType">The type of the binding target property.</param>
        /// <param name="parameter">The converter parameter to use.</param>
        /// <param name="culture">The culture to use in the converter.</param>
        public object Convert(object[] values, Type targetType, object parameter, CultureInfo culture)
        {
            foreach (object value in values)
            {
                var tmpval = value as bool?;
                if (tmpval != null && !tmpval.GetValueOrDefault())
                {
                    return false;
                }

            }
            return true;
        }

        /// <summary>
        ///     Converts a binding target value to the source binding values.
        /// </summary>
        /// <returns>
        ///     An array of values that have been converted from the target value back to the source values.
        /// </returns>
        /// <param name="value">The value that the binding target produces.</param>
        /// <param name="targetTypes">
        ///     The array of types to convert to. The array length indicates the number and types of values
        ///     that are suggested for the method to return.
        /// </param>
        /// <param name="parameter">The converter parameter to use.</param>
        /// <param name="culture">The culture to use in the converter.</param>
        public object[] ConvertBack(object value, Type[] targetTypes, object parameter, CultureInfo culture) => new object[] { };

        #endregion
    }
}
---- Transformed Tree ----
using System;
using System.Globalization;
using System.Windows.Data;

namespace Dev2.CustomControls.Converters
{
    public class MultipleBoolToEnabledConverter : IMultiValueConverter
    {
        #region Implementation of IMultiValueConverter

        /// <summary>
        ///     Converts source values to a value for the binding target. The data binding engine calls this method when it
        ///     propagates the values from source bindings to the binding target.
        /// </summary>
        /// <returns>
        ///     A converted value.If the method returns null, the valid null value is used.A return value of
        ///     <see cref="T:System.Windows.DependencyProperty" />.<see cref="F:System.Windows.DependencyProperty.UnsetValue" />
        ///     indicates that the converter did not produce a value, and that the binding will use the
        ///     <see cref="P:System.Windows.Data.BindingBase.FallbackValue" /> if it is available, or else will use the default
        ///     value.A return value of <see cref="T:System.Windows.Data.Binding" />.
        ///     <see cref="F:System.Windows.Data.Binding.DoNothing" /> indicates that the binding does not transfer the value or
        ///     use the <see cref="P:System.Windows.Data.BindingBase.FallbackValue" /> or the default value.
        /// </returns>
        /// <param name="values">
        ///     The array of values that the source bindings in the
        ///     <see cref="T:System.Windows.Data.MultiBinding" /> produces. The value
        ///     <see cref="F:System.Windows.DependencyProperty.UnsetValue" /> indicates that the source binding has no value to
        ///     provide for conversion.
        /// </param>
        /// <param name="targetType">The type of the binding target property.</param>
        /// <param name="parameter">The converter parameter to use.</param>
        /// <param name="culture">The culture to use in the converter.</param>
        public object Convert(object[] values, Type targetType, object parameter, CultureInfo culture)
        {
            foreach (object value in values)
            {
                if (value is bool? tmpval && !tmpval.GetValueOrDefault())
                {
                    return false;
                }

            }
            return true;
        }

        /// <summary>
        ///     Converts a binding target value to the source binding values.
        /// </summary>
        /// <returns>
        ///     An array of values that have been converted from the target value back to the source values.
        /// </returns>
        /// <param name="value">The value that the binding target produces.</param>
        /// <param name="targetTypes">
        ///     The array of types to convert to. The array length indicates the number and types of values
        ///     that are suggested for the method to return.
        /// </param>
        /// <param name="parameter">The converter parameter to use.</param>
        /// <param name="culture">The culture to use in the converter.</param>
        public object[] ConvertBack(object value, Type[] targetTypes, object parameter, CultureInfo culture) => new object[] { };

        #endregion
    }
}
---- Semantic diagnostics *before* transformation ----

---- Semantic diagnostics *after* transformation ----
D:\a\1\s\Dev\Dev2.CustomControls\Converters\MultipleBoolToEnabledConverter.cs(48,30): error CS8116: It is not legal to use nullable type 'bool?' in a pattern; use the underlying type 'bool' instead.
######################################################################


######################################################################
Nr: 14 - UsePatternMatchingRewriterR8
Filepath: D:\a\1\s\Dev\Dev2.Runtime.Tests\ESB\Plugin\PluginServiceExecutionFactoryTest.cs
Description: Error: The created Syntax Tree is semantically incorrect.
------------------------------------------------------------------------
---- Original Tree ----
using System;
using System.Linq;
using Dev2.Runtime;
using Dev2.Runtime.ServiceModel.Data;
using Dev2.Runtime.ServiceModel.Esb.Brokers.Plugin;
using DummyNamespaceForTest;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using Newtonsoft.Json;

namespace Dev2.Tests.Runtime.ESB.Plugin
{
    /// <summary>
    /// Summary description for PluginServiceExecutionFactory
    /// </summary>
    [TestClass]
    [TestCategory("Runtime ESB")]
    public class PluginServiceExecutionFactoryTest
    {
        /// <summary>
        ///Gets or sets the test context which provides
        ///information about and functionality for the current test run.
        ///</summary>
        public TestContext TestContext { get; set; }


        [TestMethod]
        [Owner("Travis Frisinger")]
        [TestCategory("PluginServiceExecutionFactory_GetNamespaces")]
        public void PluginRuntimeHandler_GetNamespaces_WhenValidDll_ExpectNamespaces()
        {
            //------------Setup for test--------------------------
            var source = CreatePluginSource();
            //------------Execute Test---------------------------
            //using (Isolated<PluginRuntimeHandler> isolated = new Isolated<PluginRuntimeHandler>())
            {

                var result = PluginServiceExecutionFactory.GetNamespaces(source);
                //------------Assert Results-------------------------
                Assert.IsTrue(result.Count > 0);
            }
        }

        [TestMethod]
        [Owner("Nkosinathi Sangweni")]
        [TestCategory("PluginServiceExecutionFactory_GetNamespaces")]
        public void PluginRuntimeHandler_GetNamespacesWithJsonObjects_WhenValidDll_ExpectNamespaces()
        {
            //------------Setup for test--------------------------
            var source = CreatePluginSource();
            //------------Execute Test---------------------------
            //using (Isolated<PluginRuntimeHandler> isolated = new Isolated<PluginRuntimeHandler>())
            {

                var result = PluginServiceExecutionFactory.GetNamespacesWithJsonObjects(source);
                //------------Assert Results-------------------------
                Assert.IsTrue(result.Count > 0);
            }
        }

        [TestMethod]
        [Owner("Travis Frisinger")]
        [TestCategory("PluginServiceExecutionFactory_GetNamespaces")]
        [ExpectedException(typeof(NullReferenceException))]
        public void PluginRuntimeHandler_GetNamespaces_WhenNullDll_ExpectException()
        {
            //------------Execute Test---------------------------
            PluginServiceExecutionFactory.GetNamespaces(null);
        }

        [TestMethod]
        [Owner("Nkosinathi Sangweni")]
        [TestCategory("PluginServiceExecutionFactory_GetNamespaces")]
        [ExpectedException(typeof(NullReferenceException))]
        public void PluginRuntimeHandler_GetNamespacesWithJsonObjects_WhenNullDll_ExpectException()
        {
            //------------Execute Test---------------------------
            PluginServiceExecutionFactory.GetNamespacesWithJsonObjects(null);
        }


        [TestMethod]
        [Owner("Travis Frisinger")]
        [TestCategory("PluginServiceExecutionFactory_GetMethods")]
        public void PluginRuntimeHandler_GetMethods_WhenValidDll_ExpectValidResults()
        {
            //------------Setup for test--------------------------
            var source = CreatePluginSource();
            var service = CreatePluginService();
            //------------Execute Test---------------------------
            using (Isolated<PluginRuntimeHandler> isolated = new Isolated<PluginRuntimeHandler>())
            {
                var result = PluginServiceExecutionFactory.GetMethods(source.AssemblyLocation, source.AssemblyName, service.Namespace);
                //------------Assert Results-------------------------
                Assert.IsTrue(result.Count > 0);
            }
        }

        [TestMethod]
        [Owner("Nkosinathi Sangweni")]
        [TestCategory("PluginServiceExecutionFactory_GetMethods")]
        public void PluginRuntimeHandler_GetConstructors_WhenValidDll_ExpectValidResults()
        {
            //------------Setup for test--------------------------
            var source = CreatePluginSource();
            var service = CreatePluginService();
            //------------Execute Test---------------------------
            using (Isolated<PluginRuntimeHandler> isolated = new Isolated<PluginRuntimeHandler>())
            {
                var result = PluginServiceExecutionFactory.GetConstructors(source.AssemblyLocation, source.AssemblyName, service.Namespace);
                //------------Assert Results-------------------------
                Assert.IsTrue(result.Count > 0);
            }
        }

        [TestMethod]
        [Owner("Nkosinathi Sangweni")]
        [TestCategory("PluginServiceExecutionFactory_GetMethods")]
        public void PluginRuntimeHandler_GetMethodsWithReturns_WhenValidDll_ExpectValidResults()
        {
            //------------Setup for test--------------------------
            var source = CreatePluginSource();
            var service = CreatePluginService();
            //------------Execute Test---------------------------
            using (Isolated<PluginRuntimeHandler> isolated = new Isolated<PluginRuntimeHandler>())
            {
                var result = PluginServiceExecutionFactory.GetMethodsWithReturns(source.AssemblyLocation, source.AssemblyName, service.Namespace);
                //------------Assert Results-------------------------
                Assert.IsTrue(result.Count > 0);
            }
        }

        [TestMethod]
        [Owner("Nkosinathi Sangweni")]
        [TestCategory("PluginServiceExecutionFactory_GetMethods")]
        public void PluginRuntimeHandler_GetMethodsWithReturns_WhenValidDllMethodIsVoid_ExpectValidResultsWithVoidMethod()
        {
            //------------Setup for test--------------------------
            var source = CreatePluginSource();
            var service = CreatePluginService();
            //------------Execute Test---------------------------
            using (Isolated<PluginRuntimeHandler> isolated = new Isolated<PluginRuntimeHandler>())
            {
                var result = PluginServiceExecutionFactory.GetMethodsWithReturns(source.AssemblyLocation, source.AssemblyName, service.Namespace);
                //------------Assert Results-------------------------
                Assert.IsTrue(result.Count > 0);
                Assert.IsTrue(result.Any(method => method.IsVoid));
            }
        }

        [TestMethod]
        [Owner("Travis Frisinger")]
        [TestCategory("PluginServiceExecutionFactory_InvokePlugin")]
        public void PluginRuntimeHandler_InvokePlugin_WhenValidDll_ExpectValidResults()
        {
            //------------Setup for test--------------------------
            var source = CreatePluginSource();
            var svc = CreatePluginService();



            //------------Execute Test---------------------------
            using (Isolated<PluginRuntimeHandler> isolated = new Isolated<PluginRuntimeHandler>())
            {
                var args = new PluginInvokeArgs
                {
                    AssemblyLocation = source.AssemblyLocation
                    ,
                    AssemblyName = "Foo"
                    ,
                    Fullname = svc.Namespace
                    ,
                    Method = svc.Method.Name
                    ,
                    Parameters = svc.Method.Parameters
                };
                var result = PluginServiceExecutionFactory.InvokePlugin(args);
                //------------Assert Results-------------------------
                var castResult = JsonConvert.DeserializeObject(result.ToString()) as dynamic;
                if (castResult != null)
                {
                    StringAssert.Contains(castResult.Name.ToString(), "test data");
                }
                else
                {
                    Assert.Fail("Failed Conversion for Assert");
                }
            }

        }

        #region Helper Methods

        static PluginSource CreatePluginSource(bool nullLocation = false, bool invalidResourceID = false)
        {
            var type = typeof(DummyClassForPluginTest);
            var assembly = type.Assembly;

            string loc = null;
            if (!nullLocation)
            {
                loc = assembly.Location;
            }

            var resourceID = Guid.Empty;
            if (!invalidResourceID)
            {
                resourceID = Guid.NewGuid();
            }

            return new PluginSource
            {
                AssemblyLocation = loc,
                ResourceID = resourceID,
                ResourceName = "Dummy",
                ResourceType = "PluginSource"
            };
        }

        public static PluginService CreatePluginService()
        {
            return CreatePluginService(new ServiceMethod
            {
                Name = "DummyMethod"
            });
        }

        public static PluginService CreatePluginService(ServiceMethod method)
        {
            var type = typeof(DummyClassForPluginTest);

            var source = CreatePluginSource();
            var service = new PluginService
            {
                ResourceID = Guid.NewGuid(),
                ResourceName = "DummyPluginService",
                ResourceType = "PluginService",
                Namespace = type.FullName,
                Method = method,
                Source = source
            };
            return service;
        }

        #endregion
    }
}

---- Transformed Tree ----
using System;
using System.Linq;
using Dev2.Runtime;
using Dev2.Runtime.ServiceModel.Data;
using Dev2.Runtime.ServiceModel.Esb.Brokers.Plugin;
using DummyNamespaceForTest;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using Newtonsoft.Json;

namespace Dev2.Tests.Runtime.ESB.Plugin
{
    /// <summary>
    /// Summary description for PluginServiceExecutionFactory
    /// </summary>
    [TestClass]
    [TestCategory("Runtime ESB")]
    public class PluginServiceExecutionFactoryTest
    {
        /// <summary>
        ///Gets or sets the test context which provides
        ///information about and functionality for the current test run.
        ///</summary>
        public TestContext TestContext { get; set; }


        [TestMethod]
        [Owner("Travis Frisinger")]
        [TestCategory("PluginServiceExecutionFactory_GetNamespaces")]
        public void PluginRuntimeHandler_GetNamespaces_WhenValidDll_ExpectNamespaces()
        {
            //------------Setup for test--------------------------
            var source = CreatePluginSource();
            //------------Execute Test---------------------------
            //using (Isolated<PluginRuntimeHandler> isolated = new Isolated<PluginRuntimeHandler>())
            {

                var result = PluginServiceExecutionFactory.GetNamespaces(source);
                //------------Assert Results-------------------------
                Assert.IsTrue(result.Count > 0);
            }
        }

        [TestMethod]
        [Owner("Nkosinathi Sangweni")]
        [TestCategory("PluginServiceExecutionFactory_GetNamespaces")]
        public void PluginRuntimeHandler_GetNamespacesWithJsonObjects_WhenValidDll_ExpectNamespaces()
        {
            //------------Setup for test--------------------------
            var source = CreatePluginSource();
            //------------Execute Test---------------------------
            //using (Isolated<PluginRuntimeHandler> isolated = new Isolated<PluginRuntimeHandler>())
            {

                var result = PluginServiceExecutionFactory.GetNamespacesWithJsonObjects(source);
                //------------Assert Results-------------------------
                Assert.IsTrue(result.Count > 0);
            }
        }

        [TestMethod]
        [Owner("Travis Frisinger")]
        [TestCategory("PluginServiceExecutionFactory_GetNamespaces")]
        [ExpectedException(typeof(NullReferenceException))]
        public void PluginRuntimeHandler_GetNamespaces_WhenNullDll_ExpectException()
        {
            //------------Execute Test---------------------------
            PluginServiceExecutionFactory.GetNamespaces(null);
        }

        [TestMethod]
        [Owner("Nkosinathi Sangweni")]
        [TestCategory("PluginServiceExecutionFactory_GetNamespaces")]
        [ExpectedException(typeof(NullReferenceException))]
        public void PluginRuntimeHandler_GetNamespacesWithJsonObjects_WhenNullDll_ExpectException()
        {
            //------------Execute Test---------------------------
            PluginServiceExecutionFactory.GetNamespacesWithJsonObjects(null);
        }


        [TestMethod]
        [Owner("Travis Frisinger")]
        [TestCategory("PluginServiceExecutionFactory_GetMethods")]
        public void PluginRuntimeHandler_GetMethods_WhenValidDll_ExpectValidResults()
        {
            //------------Setup for test--------------------------
            var source = CreatePluginSource();
            var service = CreatePluginService();
            //------------Execute Test---------------------------
            using (Isolated<PluginRuntimeHandler> isolated = new Isolated<PluginRuntimeHandler>())
            {
                var result = PluginServiceExecutionFactory.GetMethods(source.AssemblyLocation, source.AssemblyName, service.Namespace);
                //------------Assert Results-------------------------
                Assert.IsTrue(result.Count > 0);
            }
        }

        [TestMethod]
        [Owner("Nkosinathi Sangweni")]
        [TestCategory("PluginServiceExecutionFactory_GetMethods")]
        public void PluginRuntimeHandler_GetConstructors_WhenValidDll_ExpectValidResults()
        {
            //------------Setup for test--------------------------
            var source = CreatePluginSource();
            var service = CreatePluginService();
            //------------Execute Test---------------------------
            using (Isolated<PluginRuntimeHandler> isolated = new Isolated<PluginRuntimeHandler>())
            {
                var result = PluginServiceExecutionFactory.GetConstructors(source.AssemblyLocation, source.AssemblyName, service.Namespace);
                //------------Assert Results-------------------------
                Assert.IsTrue(result.Count > 0);
            }
        }

        [TestMethod]
        [Owner("Nkosinathi Sangweni")]
        [TestCategory("PluginServiceExecutionFactory_GetMethods")]
        public void PluginRuntimeHandler_GetMethodsWithReturns_WhenValidDll_ExpectValidResults()
        {
            //------------Setup for test--------------------------
            var source = CreatePluginSource();
            var service = CreatePluginService();
            //------------Execute Test---------------------------
            using (Isolated<PluginRuntimeHandler> isolated = new Isolated<PluginRuntimeHandler>())
            {
                var result = PluginServiceExecutionFactory.GetMethodsWithReturns(source.AssemblyLocation, source.AssemblyName, service.Namespace);
                //------------Assert Results-------------------------
                Assert.IsTrue(result.Count > 0);
            }
        }

        [TestMethod]
        [Owner("Nkosinathi Sangweni")]
        [TestCategory("PluginServiceExecutionFactory_GetMethods")]
        public void PluginRuntimeHandler_GetMethodsWithReturns_WhenValidDllMethodIsVoid_ExpectValidResultsWithVoidMethod()
        {
            //------------Setup for test--------------------------
            var source = CreatePluginSource();
            var service = CreatePluginService();
            //------------Execute Test---------------------------
            using (Isolated<PluginRuntimeHandler> isolated = new Isolated<PluginRuntimeHandler>())
            {
                var result = PluginServiceExecutionFactory.GetMethodsWithReturns(source.AssemblyLocation, source.AssemblyName, service.Namespace);
                //------------Assert Results-------------------------
                Assert.IsTrue(result.Count > 0);
                Assert.IsTrue(result.Any(method => method.IsVoid));
            }
        }

        [TestMethod]
        [Owner("Travis Frisinger")]
        [TestCategory("PluginServiceExecutionFactory_InvokePlugin")]
        public void PluginRuntimeHandler_InvokePlugin_WhenValidDll_ExpectValidResults()
        {
            //------------Setup for test--------------------------
            var source = CreatePluginSource();
            var svc = CreatePluginService();



            //------------Execute Test---------------------------
            using (Isolated<PluginRuntimeHandler> isolated = new Isolated<PluginRuntimeHandler>())
            {
                var args = new PluginInvokeArgs
                {
                    AssemblyLocation = source.AssemblyLocation
                    ,
                    AssemblyName = "Foo"
                    ,
                    Fullname = svc.Namespace
                    ,
                    Method = svc.Method.Name
                    ,
                    Parameters = svc.Method.Parameters
                };
                var result = PluginServiceExecutionFactory.InvokePlugin(args);

                //------------Assert Results-------------------------
                if (JsonConvert.DeserializeObject(result.ToString()) is dynamic castResult)
                {
                    StringAssert.Contains(castResult.Name.ToString(), "test data");
                }
                else
                {
                    Assert.Fail("Failed Conversion for Assert");
                }
            }

        }

        #region Helper Methods

        static PluginSource CreatePluginSource(bool nullLocation = false, bool invalidResourceID = false)
        {
            var type = typeof(DummyClassForPluginTest);
            var assembly = type.Assembly;

            string loc = null;
            if (!nullLocation)
            {
                loc = assembly.Location;
            }

            var resourceID = Guid.Empty;
            if (!invalidResourceID)
            {
                resourceID = Guid.NewGuid();
            }

            return new PluginSource
            {
                AssemblyLocation = loc,
                ResourceID = resourceID,
                ResourceName = "Dummy",
                ResourceType = "PluginSource"
            };
        }

        public static PluginService CreatePluginService()
        {
            return CreatePluginService(new ServiceMethod
            {
                Name = "DummyMethod"
            });
        }

        public static PluginService CreatePluginService(ServiceMethod method)
        {
            var type = typeof(DummyClassForPluginTest);

            var source = CreatePluginSource();
            var service = new PluginService
            {
                ResourceID = Guid.NewGuid(),
                ResourceName = "DummyPluginService",
                ResourceType = "PluginService",
                Namespace = type.FullName,
                Method = method,
                Source = source
            };
            return service;
        }

        #endregion
    }
}

---- Semantic diagnostics *before* transformation ----

---- Semantic diagnostics *after* transformation ----
D:\a\1\s\Dev\Dev2.Runtime.Tests\ESB\Plugin\PluginServiceExecutionFactoryTest.cs(189,73): error CS8208: It is not legal to use the type 'dynamic' in a pattern.
######################################################################


######################################################################
Nr: 15 - UsePatternMatchingRewriterR8
Filepath: D:\a\1\s\Dev\Dev2.Activities.Specs\Composition\WorkflowExecutionSteps.cs
Description: Error: The created Syntax Tree is semantically incorrect.
------------------------------------------------------------------------
---- Original Tree ----
using System;
using System.Activities;
using System.Activities.Statements;
using System.Collections.Generic;
using System.Configuration;
using System.Data;
using System.Diagnostics;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading;
using System.Xml;
using System.Xml.Linq;
using Dev2.Activities.DropBox2016.DeleteActivity;
using Dev2.Activities.DropBox2016.DownloadActivity;
using Dev2.Activities.DropBox2016.DropboxFileActivity;
using Dev2.Activities.DropBox2016.UploadActivity;
using Dev2.Activities.RabbitMQ.Consume;
using Dev2.Activities.Scripting;
using Dev2.Activities.RabbitMQ.Publish;
using Dev2.Activities.SelectAndApply;
using Dev2.Activities.Sharepoint;
using Dev2.Activities.Specs.BaseTypes;
using Dev2.Common.Common;
using Dev2.Common.ExtMethods;
using Dev2.Common.Interfaces.Core.DynamicServices;
using Dev2.Common.Interfaces.Diagnostics.Debug;
using Dev2.Common.Interfaces.Enums.Enums;
using Dev2.Common.Interfaces.Explorer;
using Dev2.Communication;
using Dev2.Controller;
using Dev2.Data.ServiceModel;
using Dev2.Data.Util;
using Dev2.Messages;
using Dev2.Network;
using Dev2.Runtime.ServiceModel.Data;
using Dev2.Services;
using Dev2.Services.Security;
using Dev2.Session;
using Dev2.Studio.Core;
using Dev2.Studio.Core.AppResources.Repositories;
using Dev2.Studio.Core.Models;
using Dev2.Studio.Core.Network;
using Dev2.Studio.ViewModels.DataList;
using Dev2.Threading;
using Dev2.TO;
using Dev2.Util;
using Dev2.Utilities;
using FluentAssertions;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using TechTalk.SpecFlow;
using Unlimited.Applications.BusinessDesignStudio.Activities;
using Moq;
using Dev2.Common.Interfaces;
using Dev2.Common.Interfaces.DB;
using Dev2.Common.Interfaces.Enums;
using Dev2.Common.Interfaces.Infrastructure.SharedModels;
using Dev2.Common.Interfaces.Monitoring;
using Dev2.PerformanceCounters.Counters;
using Dev2.PerformanceCounters.Management;
using Dev2.Studio.Core.Factories;
using Dev2.Studio.Interfaces;
using Dev2.Studio.Interfaces.Enums;
using Warewolf.Core;
using Warewolf.Studio.ViewModels;
using Warewolf.Tools.Specs.BaseTypes;
using Dev2.Data.Interfaces.Enums;
using TestingDotnetDllCascading;
using Caliburn.Micro;
using Dev2.Studio.Core.Helpers;
using SecPermissions = Dev2.Common.Interfaces.Security.Permissions;
using Dev2.Common;
using Dev2.Data.Decisions.Operations;
using Dev2.Data.SystemTemplates.Models;
using Dev2.Common.Wrappers;
using Dev2.Common.Interfaces.Wrappers;
using System.Security.Principal;
using Warewolf.Storage;
using WarewolfParserInterop;
using Dev2.Runtime.Hosting;
using Warewolf.UnitTestAttributes;
using Activity = System.Activities.Activity;

namespace Dev2.Activities.Specs.Composition
{
    [Binding]
    public class WorkflowExecutionSteps : RecordSetBases
    {
        readonly ScenarioContext _scenarioContext;
        IDirectory _dirHelper;
        public static Depends _containerOps;

        public WorkflowExecutionSteps(ScenarioContext scenarioContext)
            : base(scenarioContext)
        {
            _scenarioContext = scenarioContext ?? throw new ArgumentNullException(nameof(scenarioContext));
            _commonSteps = new CommonSteps(_scenarioContext);
            AppUsageStats.LocalHost = "http://localhost:3142";
            _dirHelper = new DirectoryWrapper();
        }

        const int EnvironmentConnectionTimeout = 15;

        SubscriptionService<DebugWriterWriteMessage> _debugWriterSubscriptionService;
        SpecExternalProcessExecutor _externalProcessExecutor;
        readonly AutoResetEvent _resetEvt = new AutoResetEvent(false);
        readonly CommonSteps _commonSteps;

        protected override void BuildDataList()
        {
            BuildShapeAndTestData();
        }

        [BeforeScenario]
        public void Setup()
        {
            if (_debugWriterSubscriptionService != null)
            {
                _debugWriterSubscriptionService.Unsubscribe();
                _debugWriterSubscriptionService.Dispose();
            }

            var mockServer = new Mock<IServer>();
            var mockshell = new Mock<IShellViewModel>();
            mockshell.Setup(a => a.ActiveServer).Returns(mockServer.Object);
            mockServer.Setup(a => a.GetServerVersion()).Returns("1.0.0.0");
            CustomContainer.Register(mockServer.Object);
            CustomContainer.Register(mockshell.Object);
            _externalProcessExecutor = new SpecExternalProcessExecutor();
        }

        public void WorkflowIsDeletedAsCleanup()
        {
            TryGetValue("resourcemodel", out IContextualResourceModel resourceModel);
            if (resourceModel != null)
            {
                TryGetValue("environment", out IServer server);
                TryGetValue("resourceRepo", out IResourceRepository repository);
                repository.DeleteResourceFromWorkspace(resourceModel);
                repository.DeleteResource(resourceModel);
            }
        }

        [AfterScenario]
        public void CleanUp()
        {
            _resetEvt?.Close();
            _containerOps?.Dispose();
        }

        [AfterScenario("ResumeWorkflowExecution")]
        public void CleanUpResources()
        {
            WorkflowIsDeletedAsCleanup();
        }
        public void CleanUp_DetailedLogFile()
        {
            WorkflowIsDeletedAsCleanup();
            if (_debugWriterSubscriptionService != null)
            {
                var files = Directory.GetFiles(EnvironmentVariables.DetailLogPath, "*", SearchOption.AllDirectories);

                foreach (var item in files)
                {
                    File.Delete(item);
                }
                _dirHelper.Delete(EnvironmentVariables.DetailLogPath, true);
            }
            _scenarioContext?.Clear();
        }

        [Given(@"Debug states are cleared")]
        public void GivenDebugStatesAreCleared()
        {
            TryGetValue("debugStates", out List<IDebugState> debugStates);
            debugStates?.Clear();
        }

        [Given(@"Debug events are reset")]
        public void GivenDebugEventsAreReset()
        {
            if (_debugWriterSubscriptionService != null)
            {
                _debugWriterSubscriptionService.Unsubscribe();
                _debugWriterSubscriptionService.Dispose();
            }
        }

        [Then(@"the workflow execution has ""(.*)"" error")]
        public void ThenTheWorkflowExecutionHasError(string hasError)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);
            var debugStates = Get<List<IDebugState>>("debugStates").ToList();
            if (hasError == "AN")
            {
                var hasErrorState = debugStates.FirstOrDefault(state => state.HasError);
                Assert.IsNotNull(hasErrorState);
            }
        }

        [Then(@"the ""(.*)"" workflow execution has ""(.*)"" error")]
        public void ThenTheWorkflowExecutionHasError(string workflowName, string hasError)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);
            var debugStates = Get<List<IDebugState>>("debugStates").ToList();

            if (hasError == "AN")
            {
                var innerWfHasErrorState = debugStates.FirstOrDefault(state => state.HasError && state.DisplayName.Equals(workflowName));
                var parentWfhasErrorState = debugStates.FirstOrDefault(state => state.HasError && state.DisplayName.Equals(parentWorkflowName));
                Assert.IsNotNull(innerWfHasErrorState);
                Assert.IsNotNull(parentWfhasErrorState);
            }
        }

        [Given(@"I have a localhost server")]
        public void GivenIHaveAServerAt()
        {
            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();
            for (int count = 0; !environmentModel.IsConnected; count++)
            {
                if (count > 20)
                {
                    throw new Exception("connection to localhost timeout");
                }
                Thread.Sleep(500);
            }
        }


        [Given(@"I have a server at ""(.*)"" with workflow ""(.*)""")]
        public void GivenIHaveAWorkflowOnServer(string serverName, string workflow)
        {
            AppUsageStats.LocalHost = "http://localhost:3142";
            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();
            environmentModel.ResourceRepository.Load(true);

            // connect to the remote environment now
            var remoteServerList = environmentModel.ResourceRepository.FindSourcesByType<Connection>(environmentModel, enSourceType.Dev2Server);

            if (remoteServerList != null && remoteServerList.Count > 0)
            {
                var remoteServer = remoteServerList.FirstOrDefault(r => r.ResourceName == serverName);

                if (remoteServer != null)
                {
                    ServerProxy connection;
                    if (remoteServer.AuthenticationType == AuthenticationType.Windows || remoteServer.AuthenticationType == AuthenticationType.Anonymous)
                    {
                        connection = new ServerProxy(new Uri(remoteServer.WebAddress));
                    }
                    else
                    {
                        //
                        // NOTE: Public needs to drop through to User for the rest of the framework to pick up properly behind the scenes ;)
                        //
                        connection = new ServerProxy(remoteServer.WebAddress, remoteServer.UserName, remoteServer.Password);
                    }

                    var newEnvironment = new Server(remoteServer.ResourceID, connection) { Name = remoteServer.ResourceName };
                    EnsureEnvironmentConnected(newEnvironment, EnvironmentConnectionTimeout);
                    LoadResourcesAndSubscribeToDebugOutput(workflow, newEnvironment);
                }
                else
                {
                    LoadResourcesAndSubscribeToDebugOutput(workflow, environmentModel);
                }
            }
            else
            {
                Assert.Fail($"Server \"{serverName}\" not found");
            }
        }

        void LoadResourcesAndSubscribeToDebugOutput(string workflow, IServer newEnvironment)
        {
            newEnvironment.ForceLoadResources();

            var resourceModel = newEnvironment.ResourceRepository.FindSingle(r => r.ResourceName == workflow);

            _debugWriterSubscriptionService = new SubscriptionService<DebugWriterWriteMessage>(newEnvironment.Connection.ServerEvents);

            _debugWriterSubscriptionService.Subscribe(msg => Append(msg.DebugState));

            Add(workflow, resourceModel);
            Add("parentWorkflowName", workflow);
            Add("environment", newEnvironment);
            Add("resourceRepo", newEnvironment.ResourceRepository);
            Add("debugStates", new List<IDebugState>());
        }

        [BeforeFeature()]
        static void SetUpLocalHost()
        {
            LocalEnvModel = ServerRepository.Instance.Source;
            LocalEnvModel.ConnectAsync().Wait(60000);
            LocalEnvModel.ForceLoadResources();
        }

        public static IServer LocalEnvModel { get; set; }

        [Given("I depend on a valid RabbitMQ server")]
        public void GivenIGetaValidRabbitMQServer() => _containerOps = new Depends(Depends.ContainerType.RabbitMQ, true);

        [Given("I depend on a valid PostgreSQL server")]
        public void GivenIGetaValidPostgreSQLServer() => _containerOps = new Depends(Depends.ContainerType.PostGreSQL, true);

        [Given("I depend on a valid MySQL server")]
        public void GivenIGetaValidMySQLServer() => _containerOps = new Depends(Depends.ContainerType.MySQL, true);

        [Given("I depend on a valid MSSQL server")]
        public void GivenIGetaValidMSSQLServer() => _containerOps = new Depends(Depends.ContainerType.MSSQL, true);

        [Given("I depend on a valid remote Warewolf server")]
        public void GivenIGetaValidRemoteWarewolfServer() => _containerOps = new Depends(Depends.ContainerType.CIRemote, true);

        [Given("I depend on a valid HTTP web server")]
        public void GivenIGetaValidHTTPWebServer() => _containerOps = new Depends(Depends.ContainerType.WebApi, true);

        [Given("I depend on a valid HTTP verbs server")]
        public void GivenIGetaValidHTTPVerbsServer() => _containerOps = new Depends(Depends.ContainerType.HTTPVerbsApi, true);

        [Given(@"I have a workflow ""(.*)""")]
        public void GivenIHaveAWorkflow(string workflowName)
        {
            var resourceId = Guid.NewGuid();
            var environmentModel = LocalEnvModel;
            EnsureEnvironmentConnected(environmentModel, EnvironmentConnectionTimeout);
            // TODO: move this to a spec command something like "I get a valid MySQL host called 'mysqlhost1'"
            if (workflowName == "TestMySqlWFWithMySqlCountries" ||
                workflowName == "TestMySqlWFWithMySqlLastIndex" ||
                workflowName == "TestMySqlWFWithMySqlScalar" ||
                workflowName == "TestMySqlWFWithMySqlStarIndex" ||
                workflowName == "TestMySqlWFWithMySqlIntIndex")
            {
                _containerOps = new Depends(Depends.ContainerType.MySQL, true);
            }
            var resourceModel = new ResourceModel(environmentModel)
            {
                ID = resourceId,
                ResourceName = workflowName,
                Category = "Acceptance Tests\\" + workflowName,
                ResourceType = ResourceType.WorkflowService
            };

            environmentModel.ResourceRepository.Add(resourceModel);
            _debugWriterSubscriptionService = new SubscriptionService<DebugWriterWriteMessage>(environmentModel.Connection.ServerEvents);

            _debugWriterSubscriptionService.Subscribe(msg => Append(msg.DebugState));
            Add("resourcemodel", resourceModel);
            Add(workflowName, resourceModel);
            Add("resourceId", resourceId);
            Add("parentWorkflowName", workflowName);
            Add("environment", environmentModel);
            Add("resourceRepo", environmentModel.ResourceRepository);
            Add("debugStates", new List<IDebugState>());
        }

        [Given(@"I have reset local performance Counters")]
        public void GivenIHaveResetLocalPerformanceCounters()
        {
            try
            {
                try
                {
                    PerformanceCounterCategory.Delete("Warewolf");
                }

                catch (Exception e)
                {
                    Assert.IsNotNull(e);
                }

                var performanceCounterFactory = new PerformanceCounterFactory();

                var register = new WarewolfPerformanceCounterRegister(new List<IPerformanceCounter>
                                                            {   new WarewolfCurrentExecutionsPerformanceCounter(performanceCounterFactory),
                                                                new WarewolfNumberOfErrors(performanceCounterFactory),
                                                                new WarewolfRequestsPerSecondPerformanceCounter(performanceCounterFactory),
                                                                new WarewolfAverageExecutionTimePerformanceCounter(performanceCounterFactory),
                                                                new WarewolfNumberOfAuthErrors(performanceCounterFactory),
                                                                new WarewolfServicesNotFoundCounter(performanceCounterFactory)
                                                            }, new List<IResourcePerformanceCounter>());
                CustomContainer.Register<IWarewolfPerformanceCounterLocater>(new WarewolfPerformanceCounterManager(register.Counters, new List<IResourcePerformanceCounter>(), register, new Mock<IPerformanceCounterPersistence>().Object, performanceCounterFactory));
            }
            catch (Exception ex)
            {
                Assert.Fail("failed to delete existing counters");
            }
        }

        [Then(@"the perfcounter raw values are")]
        public void ThenThePerfcounterRawValuesAre(Table table)
        {
            var performanceCounterCategory = new PerformanceCounterCategory("Warewolf");
            var instanceNames = performanceCounterCategory.GetInstanceNames();
            foreach (var instanceName in instanceNames)
            {
                var counters = performanceCounterCategory.GetCounters(instanceName);
                foreach (var tableRow in table.Rows)
                {
                    foreach (var counter in instanceNames)
                    {
                        var performanceCounter = counters.First(a => a.CounterName == tableRow[0]);
                        if (performanceCounter != null)
                        {
                            using (var cnt = new PerformanceCounter("Warewolf", tableRow[0], counter, true))
                            {
                                if (tableRow[1] == "x")
                                {
                                    Assert.AreNotEqual(cnt.RawValue, 0);
                                }
                                else
                                {
                                    Assert.AreEqual(cnt.RawValue, int.Parse(tableRow[1]));
                                }
                            }
                        }
                    }
                }
            }
        }

        void EnsureEnvironmentConnected(IServer server, int timeout)
        {
            var startTime = DateTime.UtcNow;
            server.ConnectAsync().Wait(60000);

            while (!server.IsConnected && !server.Connection.IsConnected)
            {
                Assert.AreEqual(server.IsConnected, server.Connection.IsConnected);

                var now = DateTime.UtcNow;
                if (now.Subtract(startTime).TotalSeconds > timeout)
                {
                    break;
                }
                Thread.Sleep(GlobalConstants.NetworkTimeOut);
            }

            if (!server.IsConnected && !server.Connection.IsConnected)
            {
                _scenarioContext.Add("ConnectTimeoutCountdown", EnvironmentConnectionTimeout);
                throw new TimeoutException("Connection to Warewolf server \"" + server.Name + "\" timed out.");
            }
        }

        void Add(string key, object value) => _scenarioContext.Add(key, value);

        void Append(IDebugState debugState)
        {
            TryGetValue("debugStates", out List<IDebugState> debugStates);
            TryGetValue("debugStatesDuration", out List<IDebugState> debugStatesDuration);
            TryGetValue("parentWorkflowName", out string workflowName);
            TryGetValue("environment", out IServer server);
            if (debugStatesDuration == null)
            {
                debugStatesDuration = new List<IDebugState>();
                Add("debugStatesDuration", debugStatesDuration);
            }
            if (debugState.WorkspaceID == server.Connection.WorkspaceID || debugState.WorkspaceID == GlobalConstants.ServerWorkspaceID)
            {
                if (debugState.StateType != StateType.Duration)
                {
                    debugStates.Add(debugState);
                }
                else
                {
                    debugStatesDuration.Add(debugState);
                }
            }
            if (debugState.IsFinalStep() && debugState.DisplayName.Equals(workflowName))
            {
                _resetEvt.Set();
            }

        }

        [Then(@"the ""(.*)"" in step (.*) for ""(.*)"" debug inputs as")]
        public void ThenTheInStepForDebugInputsAs(string toolName, int stepNumber, string forEachName, Table table)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);

            var debugStates = Get<List<IDebugState>>("debugStates").ToList();
            var workflowId = debugStates.First(wf => wf.DisplayName.Equals(forEachName)).ID;

            if (parentWorkflowName == forEachName)
            {
                workflowId = Guid.Empty;
            }

            var toolSpecificDebug =
                debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == workflowId && ds.DisplayName.Equals(toolName)).ToList();

            Assert.IsTrue(toolSpecificDebug.Count >= stepNumber);
            var debugToUse = DebugToUse(stepNumber, toolSpecificDebug);

            _commonSteps.ThenTheDebugInputsAs(table, debugToUse.Inputs
                                                    .SelectMany(item => item.ResultsList).ToList());
        }

        [Then(@"the ""(.*)"" in '(.*)' in step (.*) for ""(.*)"" debug inputs as")]
        public void ThenTheInInStepForDebugInputsAs(string toolName, string sequenceName, int stepNumber, string forEachName, Table table)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);

            var debugStates = Get<List<IDebugState>>("debugStates").ToList();
            var workflowId = debugStates.First(wf => wf.DisplayName.Equals(forEachName)).ID;

            if (parentWorkflowName == forEachName)
            {
                workflowId = Guid.Empty;
            }

            var sequenceDebug = debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == workflowId).ToList();
            Assert.IsTrue(sequenceDebug.Count >= stepNumber);

            var sequenceId = sequenceDebug[stepNumber - 1].ID;
            var sequenceIsInForEach = sequenceDebug.Any(state => state.ID == sequenceId);
            Assert.IsTrue(sequenceIsInForEach);

            var toolSpecificDebug =
                debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == sequenceId && ds.DisplayName.Equals(toolName)).ToList();

            _commonSteps.ThenTheDebugInputsAs(table, toolSpecificDebug
                                                    .SelectMany(item => item.Inputs)
                                                    .SelectMany(item => item.ResultsList).ToList());

        }

        [Then(@"the dotnetdll ""(.*)"" in '(.*)' in step (.*) for ""(.*)"" debug inputs as")]
        public void ThenTheInInStepForDotNetDebugInputsAs(string toolName, string sequenceName, int stepNumber, string forEachName, Table table)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);

            var debugStates = Get<List<IDebugState>>("debugStates").ToList();
            var workflowId = debugStates.First(wf => wf.DisplayName.Equals(forEachName)).ID;

            if (parentWorkflowName == forEachName)
            {
                workflowId = Guid.Empty;
            }

            var sequenceDebug = debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == workflowId).ToList();
            Assert.IsTrue(sequenceDebug.Count >= stepNumber);

            var sequenceId = sequenceDebug[stepNumber - 1].ID;
            var sequenceIsInForEach = sequenceDebug.Any(state => state.ID == sequenceId);
            Assert.IsTrue(sequenceIsInForEach);

            var toolSpecificDebug =
                debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == sequenceId && ds.DisplayName.Equals(toolName)).ToList();
            Assert.IsNotNull(toolSpecificDebug);
            var debugState = toolSpecificDebug.FirstOrDefault();
            if (debugState != null)
            {
                for (int index = 0; index < debugState.Inputs.Count; index++)
                {
                    var debugItem = debugState.Inputs[index];
                    var tableRow = table.Rows[index];
                    var variable = tableRow["Variable"];
                    var value = tableRow["value"];
                    var label = tableRow["label"];
                    var operater = tableRow["operater"];
                    var debugItemResult = debugItem.ResultsList.FirstOrDefault();
                    if (debugItemResult != null)
                    {
                        Assert.AreEqual((object)value, debugItemResult.Value);
                        Assert.AreEqual(variable, debugItemResult.Variable);
                        Assert.AreEqual(label, debugItemResult.Label);
                        Assert.AreEqual(operater, debugItemResult.Operator);
                    }
                }
            }
        }

        [Then(@"the dotnetdll ""(.*)"" in ""(.*)"" in step (.*) for ""(.*)"" debug output as")]
        public void ThenTheDotnetdllInInStepForDebugOutputAs(string toolName, string sequenceName, int stepNumber, string forEachName, Table table)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);

            var debugStates = Get<List<IDebugState>>("debugStates").ToList();
            var workflowId = debugStates.First(wf => wf.DisplayName.Equals(forEachName)).ID;

            if (parentWorkflowName == forEachName)
            {
                workflowId = Guid.Empty;
            }

            var sequenceDebug = debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == workflowId).ToList();
            Assert.IsTrue(sequenceDebug.Count >= stepNumber);

            var sequenceId = sequenceDebug[stepNumber - 1].ID;
            var sequenceIsInForEach = sequenceDebug.Any(state => state.ID == sequenceId);
            Assert.IsTrue(sequenceIsInForEach);

            var toolSpecificDebug =
                debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == sequenceId && ds.DisplayName.Equals(toolName)).ToList();
            Assert.IsNotNull(toolSpecificDebug);
            var debugState = toolSpecificDebug.FirstOrDefault();
            if (debugState != null)
            {
                for (int index = 0; index < debugState.Outputs.Count; index++)
                {
                    var debugItem = debugState.Outputs[index];
                    var tableRow = table.Rows[index];
                    var variable = tableRow["Variable"];
                    var value = tableRow["value"];
                    var operater = tableRow["operater"];
                    var debugItemResult = debugItem.ResultsList.FirstOrDefault();
                    if (debugItemResult != null)
                    {
                        Assert.AreEqual((object)value, debugItemResult.Value);
                        Assert.AreEqual(variable, debugItemResult.Variable);
                        Assert.AreEqual(operater, debugItemResult.Operator);
                    }
                }
            }
        }


        [Then(@"the ""(.*)"" in '(.*)' in step (.*) for ""(.*)"" debug outputs as")]
        public void ThenTheInInStepForDebugOutputsAs(string toolName, string sequenceName, int stepNumber, string forEachName, Table table)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);

            var debugStates = Get<List<IDebugState>>("debugStates").ToList();
            var workflowId = debugStates.First(wf => wf.DisplayName.Equals(forEachName)).ID;

            if (parentWorkflowName == forEachName)
            {
                workflowId = Guid.Empty;
            }

            var sequenceDebug = debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == workflowId).ToList();
            Assert.IsTrue(sequenceDebug.Count >= stepNumber);

            var sequenceId = sequenceDebug[stepNumber - 1].ID;
            var sequenceIsInForEach = sequenceDebug.Any(state => state.ID == sequenceId);
            Assert.IsTrue(sequenceIsInForEach);

            var toolSpecificDebug =
                debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == sequenceId && ds.DisplayName.Equals(toolName)).ToList();

            _commonSteps.ThenTheDebugInputsAs(table, toolSpecificDebug
                                                    .SelectMany(item => item.Outputs)
                                                    .SelectMany(item => item.ResultsList).ToList());
        }


        IDebugState DebugToUse(int stepNumber, List<IDebugState> toolSpecificDebug)
        {
            var debugToUse = toolSpecificDebug[stepNumber - 1];
            return debugToUse;
        }




        [Then(@"Workflow ""(.*)"" has errors")]
        public void ThenWorkflowHasErrors(string workFlowName, Table table)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);

            var debugStates = Get<List<IDebugState>>("debugStates").ToList();
            var toolSpecificDebug = debugStates.Last(wf => wf.DisplayName.Equals(workFlowName));
            foreach (var tableRow in table.Rows)
            {
                var strings = toolSpecificDebug.ErrorMessage.Replace("\n", ",").Replace("\r", "").Split(',');
                var predicate = tableRow["Error"];
                var first = strings.First(p => p == predicate);
                Assert.IsFalse(string.IsNullOrEmpty(first));
            }
        }


        [Then(@"the ""(.*)"" in step (.*) for ""(.*)"" debug outputs as")]
        public void ThenTheInStepForDebugOutputsAs(string toolName, int stepNumber, string forEachName, Table table)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);

            var debugStates = Get<List<IDebugState>>("debugStates").ToList();
            var workflowId = debugStates.First(wf => wf.DisplayName.Equals(forEachName)).ID;

            if (parentWorkflowName == forEachName)
            {
                workflowId = Guid.Empty;
            }

            var toolSpecificDebug =
                debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == workflowId && ds.DisplayName.Equals(toolName)).ToList();
            Assert.IsTrue(toolSpecificDebug.Count >= stepNumber);
            var debugToUse = DebugToUse(stepNumber, toolSpecificDebug);


            var outputDebugItems = debugToUse.Outputs
                .SelectMany(s => s.ResultsList).ToList();
            _commonSteps.ThenTheDebugOutputAs(table, outputDebugItems);
        }

        [Given(@"""(.*)"" contains a ""(.*)"" service ""(.*)"" with mappings")]
        public void GivenContainsADatabaseServiceWithMappings(string wf, string serviceType, string serviceName, Table table)
        {
            var environmentModel = ServerRepository.Instance.Source;
            var repository = new ResourceRepository(environmentModel);
            repository.Load(false);
            var resource = repository.FindSingle(r => r.ResourceName.Equals(serviceName), true, true);
            if (resource == null)
            {
                throw new Exception("Local Warewolf service " + serviceName + " not found.");
            }
            var activity = GetServiceActivity(serviceType);
            if (activity != null)
            {
                var outputSb = GetOutputMapping(table, resource);
                var inputSb = GetInputMapping(table, resource);
                var outputMapping = outputSb.ToString();
                var inputMapping = inputSb.ToString();
                resource.Outputs = outputMapping;
                resource.Inputs = inputMapping;
                resource.ResourceType = ResourceType.Service;
                activity.ResourceID = resource.ID;
                activity.ServiceName = resource.ResourceName;
                activity.DisplayName = serviceName;
                activity.OutputMapping = outputMapping;
                activity.InputMapping = inputMapping;

                if (resource.ServerResourceType == "DbService")
                {
                    var xml = resource.ToServiceDefinition(true).ToXElement();
                    var service = new DbService(xml);
                    var source = service.Source as DbSource;
                    Activity updatedActivity = null;
                    switch (serviceType)
                    {
                        case "mysql database":
                            updatedActivity = ActivityUtils.GetDsfMySqlDatabaseActivity((DsfDatabaseActivity)activity, source, service);
                            break;
                        case "sqlserver database":
                            updatedActivity = ActivityUtils.GetDsfSqlServerDatabaseActivity((DsfDatabaseActivity)activity, service, source);
                            break;
                        case "postgresql database":
                            updatedActivity = ActivityUtils.GetDsfPostgreSqlActivity((DsfDatabaseActivity)activity, service, source);
                            break;
                        default:
                            break;
                    }
                    _commonSteps.AddActivityToActivityList(wf, serviceName, updatedActivity);
                }
                else if (resource.ServerResourceType == "WebService")
                {
                    var updatedActivity = new WebGetActivity();
                    var xml = resource.ToServiceDefinition(true).ToXElement();
                    var service = new WebService(xml);
                    var source = service.Source as WebSource;
                    updatedActivity.Headers = new List<INameValue>();
                    service.Headers?.AddRange(service.Headers);
                    updatedActivity.OutputDescription = service.OutputDescription;
                    updatedActivity.QueryString = service.RequestUrl;
                    updatedActivity.Inputs = ActivityUtils.TranslateInputMappingToInputs(inputMapping);
                    updatedActivity.Outputs = ActivityUtils.TranslateOutputMappingToOutputs(outputMapping);
                    updatedActivity.DisplayName = serviceName;
                    if (source != null)
                    {
                        updatedActivity.SourceId = source.ResourceID;
                    }
                    _commonSteps.AddActivityToActivityList(wf, serviceName, updatedActivity);
                }
                else
                {
                    _commonSteps.AddActivityToActivityList(wf, serviceName, activity);
                }
            }
        }

        [Given(@"""(.*)"" contains ""(.*)"" from server ""(.*)"" with mapping as")]
        public void GivenContainsFromServerWithMappingAs(string wf, string remoteWf, string server, Table mappings)
        {
            if (_containerOps == null)
            {
                if (server == "Remote Connection Integration")
                {
                    _containerOps = new Depends(Depends.ContainerType.CIRemote, true);
                }
                else if (remoteWf == "TestSqlReturningXml" || remoteWf == "TestSqlExecutesOnce")
                {
                    _containerOps = new Depends(Depends.ContainerType.MSSQL, true);
                }
                else if (remoteWf == "RabbitMQTest")
                {
                    _containerOps = new Depends(Depends.ContainerType.RabbitMQ, true);
                }
            }

            var localHostEnv = LocalEnvModel;

            EnsureEnvironmentConnected(localHostEnv, EnvironmentConnectionTimeout);

            if (server == "localhost" && remoteWf == "TestmySqlReturningXml")
            {
                _containerOps = new Depends(Depends.ContainerType.MySQL, true);
            }

            var remoteEnvironment = ServerRepository.Instance.FindSingle(model => model.Name == server);
            if (remoteEnvironment == null)
            {
                var environments = ServerRepository.Instance.LookupEnvironments(localHostEnv);
                remoteEnvironment = environments.FirstOrDefault(model => model.Name == server);
            }
            if (remoteEnvironment != null)
            {
                if (server == "Remote Connection Integration")
                {
                    remoteEnvironment.Connection = new ServerProxy(
                        $"http://{_containerOps.Container.IP}:{_containerOps.Container.Port}", "\\","");
                }

                EnsureEnvironmentConnected(remoteEnvironment, EnvironmentConnectionTimeout);
                if (!remoteEnvironment.HasLoadedResources)
                {
                    remoteEnvironment.ForceLoadResources();
                }
                var splitNameAndCat = remoteWf.Split('/');
                var resName = splitNameAndCat[splitNameAndCat.Length - 1];
                var remoteResourceModel = remoteEnvironment.ResourceRepository.FindSingle(model => model.ResourceName == resName
                                                                         || model.Category == remoteWf.Replace('/', '\\'), true);

                if (remoteResourceModel == null)
                {
                    remoteEnvironment.LoadResources();
                    remoteResourceModel = remoteEnvironment.ResourceRepository.FindSingle(model => model.ResourceName == resName
                                                                         || model.Category == remoteWf.Replace('/', '\\'), true);
                }
                if (remoteResourceModel != null)
                {
                    var dataMappingViewModel = GetDataMappingViewModel(remoteResourceModel, mappings);

                    var inputMapping = dataMappingViewModel.GetInputString(dataMappingViewModel.Inputs);
                    var outputMapping = dataMappingViewModel.GetOutputString(dataMappingViewModel.Outputs);

                    var activity = new DsfWorkflowActivity();

                    remoteResourceModel.Outputs = outputMapping;
                    remoteResourceModel.Inputs = inputMapping;
                    var remoteServerId = remoteEnvironment.EnvironmentID;
                    activity.ServiceServer = remoteServerId;
                    activity.EnvironmentID = remoteServerId;

                    activity.IsWorkflow = true;
                    if (remoteServerId != Guid.Empty)
                    {
                        activity.ServiceUri = remoteEnvironment.Connection.AppServerUri.ToString();
                        activity.IsWorkflow = false;
                    }

                    activity.ResourceID = remoteResourceModel.ID;
                    activity.ServiceName = remoteResourceModel.Category;
                    activity.DisplayName = remoteWf;
                    activity.OutputMapping = outputMapping;
                    activity.InputMapping = inputMapping;
                    _commonSteps.AddActivityToActivityList(wf, remoteWf, activity);
                }
                else
                {
                    throw new Exception($"Remote Warewolf service {remoteWf} not found on server {server}.");
                }
            }
            else
            {
                throw new Exception($"Remote server {server} not found");
            }
        }

        DataMappingViewModel GetDataMappingViewModel(IResourceModel remoteResourceModel, Table mappings)
        {
            var webActivity = new WebActivity { ResourceModel = remoteResourceModel as ResourceModel };
            var dataMappingViewModel = new DataMappingViewModel(webActivity);
            foreach (var inputOutputViewModel in dataMappingViewModel.Inputs)
            {
                inputOutputViewModel.Value = "";
                inputOutputViewModel.RecordSetName = "";
                inputOutputViewModel.Name = "";
                inputOutputViewModel.MapsTo = "";
            }

            foreach (var inputOutputViewModel in dataMappingViewModel.Outputs)
            {
                inputOutputViewModel.Value = "";
                inputOutputViewModel.RecordSetName = "";
                inputOutputViewModel.Name = "";
            }
            foreach (var tableRow in mappings.Rows)
            {
                tableRow.TryGetValue("Output from Service", out string output);
                tableRow.TryGetValue("To Variable", out string toVariable);
                if (!string.IsNullOrEmpty(output) && !string.IsNullOrEmpty(toVariable))
                {
                    var inputOutputViewModel = dataMappingViewModel.Outputs.FirstOrDefault(model => model.DisplayName == output);
                    if (inputOutputViewModel != null)
                    {
                        inputOutputViewModel.Value = toVariable;
                        if (DataListUtil.IsValueRecordset(output))
                        {
                            inputOutputViewModel.RecordSetName = DataListUtil.ExtractRecordsetNameFromValue(output);
                            inputOutputViewModel.Name = DataListUtil.ExtractFieldNameFromValue(output);
                        }
                        else
                        {
                            inputOutputViewModel.Name = output;
                        }
                        inputOutputViewModel.RecordSetName = DataListUtil.ExtractRecordsetNameFromValue(output);
                        _commonSteps.AddVariableToVariableList(toVariable);
                    }
                }

                tableRow.TryGetValue("Input to Service", out string input);
                tableRow.TryGetValue("From Variable", out string fromVariable);

                if (!string.IsNullOrEmpty(input) && !string.IsNullOrEmpty(fromVariable))
                {
                    var inputOutputViewModel = dataMappingViewModel.Inputs.FirstOrDefault(model => model.DisplayName == input);
                    if (inputOutputViewModel != null)
                    {
                        inputOutputViewModel.MapsTo = fromVariable;

                        if (DataListUtil.IsValueRecordset(input))
                        {
                            inputOutputViewModel.RecordSetName = DataListUtil.ExtractRecordsetNameFromValue(input);
                            inputOutputViewModel.Name = DataListUtil.ExtractFieldNameFromValue(input);
                        }
                        else
                        {
                            inputOutputViewModel.Name = input;
                        }
                        inputOutputViewModel.Value = input;
                        _commonSteps.AddVariableToVariableList(fromVariable);
                    }
                }

            }
            return dataMappingViewModel;
        }

        DsfActivity GetServiceActivity(string serviceType)
        {
            DsfActivity activity = null;
            switch (serviceType)
            {
                case "mysql database":
                    activity = new DsfDatabaseActivity();
                    break;
                case "sqlserver database":
                    activity = new DsfDatabaseActivity();
                    break;
                case "oracle database":
                    activity = new DsfDatabaseActivity();
                    break;
                case "odbc database":
                    activity = new DsfDatabaseActivity();
                    break;
                case "postgresql database":
                    activity = new DsfDatabaseActivity();
                    break;
                case "plugin":
                    activity = new DsfPluginActivity();
                    break;
                case "workflow":
                    activity = new DsfWorkflowActivity();
                    break;
                default:
                    break;
            }
            return activity;
        }

        StringBuilder GetOutputMapping(Table table, IResourceModel resource)
        {
            var outputSb = new StringBuilder();
            outputSb.Append("<Outputs>");

            foreach (var tableRow in table.Rows)
            {
                var output = tableRow["Output from Service"];
                var toVariable = tableRow["To Variable"];

                _commonSteps.AddVariableToVariableList(toVariable);

                if (resource != null)
                {

                    var outputs = XDocument.Parse(resource.Outputs);

                    string recordsetName;
                    string fieldName;

                    if (DataListUtil.IsValueRecordset(output))
                    {
                        recordsetName = DataListUtil.ExtractRecordsetNameFromValue(output);
                        fieldName = DataListUtil.ExtractFieldNameFromValue(output);
                    }
                    else
                    {
                        recordsetName = fieldName = output;
                    }

                    var element = (from elements in outputs.Descendants("Output")
                                   where string.Equals((string)elements.Attribute("RecordsetAlias"), recordsetName, StringComparison.InvariantCultureIgnoreCase) &&
                                         string.Equals((string)elements.Attribute("OriginalName"), fieldName, StringComparison.InvariantCultureIgnoreCase)
                                   select elements).SingleOrDefault();

                    element?.SetAttributeValue("Value", toVariable);

                    outputSb.Append(element);
                }
            }

            outputSb.Append("</Outputs>");
            return outputSb;
        }

        [Given(@"'(.*)' in ""(.*)"" contains Data Merge ""(.*)"" into ""(.*)"" as")]
        public void GivenInContainsDataMergeIntoAs(string sequenceName, string forEachName, string activityName, string resultVariable, Table table)
        {
            var activity = new DsfDataMergeActivity { Result = resultVariable, DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var variable = tableRow["Variable"];
                var type = tableRow["Type"];
                var at = tableRow["Using"];
                var padding = tableRow["Padding"];
                var alignment = tableRow["Alignment"];

                activity.MergeCollection.Add(new DataMergeDTO(variable, type, at, 1, padding, alignment, true));
            }
            _commonSteps.AddVariableToVariableList(resultVariable);
            AddActivityToSequenceInsideForEach(sequenceName, forEachName, activity);
        }

        void AddActivityToSequenceInsideForEach(string sequenceName, string forEachName, Activity activity)
        {

            var activityList = _commonSteps.GetActivityList();
            if (activityList[forEachName] is DsfForEachActivity forEachActivity)
            {
                if (forEachActivity.DataFunc.Handler is DsfSequenceActivity sequenceActivity && sequenceActivity.DisplayName == sequenceName)
                {
                    sequenceActivity.Activities.Add(activity);
                }
            }
        }

        [Given(@"'(.*)' in ""(.*)"" contains Gather System Info ""(.*)"" as")]
        public void GivenInContainsGatherSystemInfoAs(string sequenceName, string forEachName, string activityName, Table table)
        {
            var activity = new DsfGatherSystemInformationActivity { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var variable = tableRow["Variable"];

                _commonSteps.AddVariableToVariableList(variable);

                var systemInfo = (enTypeOfSystemInformationToGather)Dev2EnumConverter.GetEnumFromStringDiscription(tableRow["Selected"], typeof(enTypeOfSystemInformationToGather));
                activity.SystemInformationCollection.Add(new GatherSystemInformationTO(systemInfo, variable, 1));
            }

            AddActivityToSequenceInsideForEach(sequenceName, forEachName, activity);
        }

        StringBuilder GetInputMapping(Table table, IResourceModel resource)
        {
            var inputSb = new StringBuilder();
            inputSb.Append("<Inputs>");

            foreach (var tableRow in table.Rows)
            {
                var input = tableRow["Input to Service"];
                var fromVariable = tableRow["From Variable"];

                _commonSteps.AddVariableToVariableList(fromVariable);

                if (resource != null)
                {
                    var inputs = XDocument.Parse(resource.Inputs);

                    string recordsetName;
                    XElement element;
                    if (DataListUtil.IsValueRecordset(input))
                    {
                        recordsetName = DataListUtil.ExtractRecordsetNameFromValue(input);
                        var fieldName = DataListUtil.ExtractFieldNameFromValue(input);

                        element = (from elements in inputs.Descendants("Input")
                                   where string.Equals((string)elements.Attribute("Recordset"), recordsetName, StringComparison.InvariantCultureIgnoreCase) &&
                                         string.Equals((string)elements.Attribute("OriginalName"), fieldName, StringComparison.InvariantCultureIgnoreCase)
                                   select elements).SingleOrDefault();

                        element?.SetAttributeValue("Value", fromVariable);

                        inputSb.Append(element);
                    }
                    else
                    {
                        recordsetName = input;

                        element = (from elements in inputs.Descendants("Input")
                                   where string.Equals((string)elements.Attribute("Name"), recordsetName, StringComparison.InvariantCultureIgnoreCase)
                                   select elements).SingleOrDefault();

                        element?.SetAttributeValue("Source", fromVariable);
                    }

                    if (element != null)
                    {
                        inputSb.Append(element);
                    }
                }
            }

            inputSb.Append("</Inputs>");
            return inputSb;
        }

        [When(@"""(.*)"" is the active environment used to execute ""(.*)""")]
        public void WhenIsTheActiveEnvironmentUsedToExecute(string connectionName, string workflowName)
        {
            TryGetValue(workflowName, out IContextualResourceModel resourceModel);
            TryGetValue("environment", out IServer server);
            TryGetValue("resourceRepo", out IResourceRepository repository);

            ExecuteWorkflow(resourceModel);
        }

        [When(@"the workflow is Saved")]
        private IContextualResourceModel SaveTheWorkflow() => SaveAWorkflow(null);

        [When(@"""(.*)"" is Saved")]
        private IContextualResourceModel SaveAWorkflow(string parentName)
        {
            TryGetValue("parentWorkflowName", out string parentWorkflowName);
            var workflowName = string.IsNullOrEmpty(parentWorkflowName) ? parentName : parentWorkflowName;

            Get<List<IDebugState>>("debugStates").Clear();
            BuildDataList();

            var activityList = _commonSteps.GetActivityList();

            var flowSteps = new List<FlowStep>();

            TestStartNode = new FlowStep();
            flowSteps.Add(TestStartNode);
            if (activityList != null)
            {
                foreach (var activity in activityList)
                {
                    if (activity.Value is DsfDecision dec)
                    {
                        var decConfig = Get<(string TrueArm, string FalseArm)>(dec.DisplayName);
                        var trueArmToolName = decConfig.TrueArm;
                        var falseArmToolName = decConfig.FalseArm;
                        dec.TrueArm = new List<IDev2Activity> { activityList.FirstOrDefault(act => act.Key == trueArmToolName).Value as IDev2Activity };
                        dec.FalseArm = new List<IDev2Activity> { activityList.FirstOrDefault(act => act.Key == falseArmToolName).Value as IDev2Activity };
                    }
                    if (TestStartNode.Action == null)
                    {
                        TestStartNode.Action = activity.Value;
                    }
                    else
                    {
                        var flowStep = new FlowStep { Action = activity.Value };
                        flowSteps.Last().Next = flowStep;
                        flowSteps.Add(flowStep);
                    }
                }
            }
            TryGetValue(workflowName, out IContextualResourceModel resourceModel);
            TryGetValue("environment", out IServer server);
            TryGetValue("resourceRepo", out IResourceRepository repository);

            var currentDl = CurrentDl;
            resourceModel.DataList = currentDl.Replace("root", "DataList");
            var helper = new WorkflowHelper();
            var xamlDefinition = helper.GetXamlDefinition(FlowchartActivityBuilder);
            resourceModel.WorkflowXaml = xamlDefinition;

            repository.Save(resourceModel);
            repository.SaveToServer(resourceModel);

            return resourceModel;
        }


        [Given(@"the ""(.*)"" in WorkFlow ""(.*)"" debug inputs as")]
        [When(@"the ""(.*)"" in WorkFlow ""(.*)"" debug inputs as")]
        [Then(@"the ""(.*)"" in WorkFlow ""(.*)"" debug inputs as")]
        public void ThenTheInWorkFlowDebugInputsAs(string toolName, string workflowName, Table table)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);
            var debugStates = Get<List<IDebugState>>("debugStates").ToList();
            var workflowId = Guid.Empty;

            if (parentWorkflowName != workflowName)
            {
                if (toolName != null && workflowName != null)
                {
                    workflowId = debugStates.First(wf => wf.DisplayName.Equals(workflowName)).ID;
                }
                else
                {
                    throw new InvalidOperationException("SpecFlow broke.");
                }
            }

            var toolSpecificDebug =
                debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == workflowId && ds.DisplayName.Equals(toolName)).ToList();

            _commonSteps.ThenTheDebugInputsAs(table, toolSpecificDebug.Distinct()
                                                    .SelectMany(s => s.Inputs)
                                                    .SelectMany(s => s.ResultsList).ToList());
        }

        [Given(@"the tool ""(.*)"" with Guid of ""(.*)"" in WorkFlow ""(.*)"" debug inputs as")]
        [When(@"the tool ""(.*)"" with Guid of ""(.*)"" in WorkFlow ""(.*)"" debug inputs as")]
        [Then(@"the tool ""(.*)"" with Guid of ""(.*)"" in WorkFlow ""(.*)"" debug inputs as")]
        public void ThenTheToolWithGuidOfInWorkFlowDebugInputsAs(string toolName, string toolGuid, string workflowName, Table table)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);
            var debugStates = Get<List<IDebugState>>("debugStates").ToList();
            var workflowId = Guid.Empty;

            if (parentWorkflowName != workflowName)
            {
                if (workflowName != null)
                {
                    workflowId = debugStates.First(wf => wf.DisplayName.Equals(workflowName)).ID;
                }
                else
                {
                    throw new InvalidOperationException("Could not find workflow.");
                }
            }

            var toolSpecificDebug = debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == workflowId &&
                                                            GetMatchingNames(toolName, ds.DisplayName) &&
                                                            ds.ID.Equals(Guid.Parse(toolGuid))).ToList();

            _commonSteps.ThenTheDebugInputsAs(table, toolSpecificDebug.Distinct()
                                                    .SelectMany(s => s.Inputs)
                                                    .SelectMany(s => s.ResultsList).ToList());
        }

        [Then(@"the ""(.*)"" has a start and end duration")]
        public void ThenTheHasAStartAndEndDuration(string workflowName)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);
            var debugStates = Get<List<IDebugState>>("debugStates").ToList();

            var end = debugStates.First(wf => wf.Name.Equals("End"));
            Assert.IsTrue(end.Duration.Ticks > 0, "Workflow debug output end step duration of " + end.Duration.Ticks + " ticks is less than or equal to 0 ticks. All workflows no matter how simple do take some time to execute.");
        }

        [Then(@"""(.*)"" Duration is less or equal to (.*) seconds")]
        [Given(@"""(.*)"" Duration is less or equal to (.*) seconds")]
        [When(@"""(.*)"" Duration is less or equal to (.*) seconds")]
        public void ThenDurationIsLessOrEqualToSeconds(string workflowName, int duration)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);
            var debugStates = Get<List<IDebugState>>("debugStates").ToList();

            var end = debugStates.First(wf => wf.Name.Equals("End"));
            Assert.IsTrue(end.Duration.Ticks > 0);
            var condition = end.Duration.Seconds <= duration;
            Assert.IsTrue(condition);
        }

        [Then(@"""(.*)"" Duration is greater or equal to (.*) seconds")]
        [When(@"""(.*)"" Duration is greater or equal to (.*) seconds")]
        [Given(@"""(.*)"" Duration is greater or equal to (.*) seconds")]
        public void ThenDurationIsGreaterOrEqualToSeconds(string workflowName, int duration)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);
            var debugStates = Get<List<IDebugState>>("debugStates").ToList();
            var end = debugStates.First(wf => wf.Name.Equals("End"));
            Assert.IsTrue(end.Duration.Ticks > 0);
            var condition = end.Duration.Seconds >= duration;
            Assert.IsTrue(condition);
        }




        [Then(@"the nested ""(.*)"" in WorkFlow ""(.*)"" debug inputs as")]
        public void ThenTheNestedInWorkFlowDebugInputsAs(string toolName, string workflowName, Table table)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);
            var debugStates = Get<List<IDebugState>>("debugStates").ToList();

            var toolSpecificDebug =
                debugStates.Where(ds => ds.DisplayName.Equals(toolName)).ToList();

            _commonSteps.ThenTheDebugInputsAs(table, toolSpecificDebug
                                                    .SelectMany(s => s.Inputs)
                                                    .SelectMany(s => s.ResultsList).ToList());
        }

        [Then(@"the ""(.*)"" in WorkFlow ""(.*)"" has  ""(.*)"" nested children")]
        public void ThenTheInWorkFlowHasNestedChildren(string toolName, string workflowName, int count)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);
            var debugStates = Get<List<IDebugState>>("debugStates").ToList();

            var id =
                debugStates.Where(ds => ds.DisplayName.Equals(toolName)).ToList().Select(a => a.ID).First();
            var children = debugStates.Count(a => a.ParentID.GetValueOrDefault() == id);
            Assert.AreEqual(count, children, String.Join(", ", debugStates.Select(val => val.DisplayName)));
        }

        [Then(@"the ""(.*)"" in WorkFlow ""(.*)"" has at least ""(.*)"" nested children")]
        public void ThenTheInWorkFlowHasAtLeastNestedChildren(string toolName, string workflowName, int count)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);
            var debugStates = Get<List<IDebugState>>("debugStates").ToList();

            var id =
                debugStates.Where(ds => ds.DisplayName.Equals(toolName)).ToList().Select(a => a.ID).First();
            var children = debugStates.Count(a => a.ParentID.GetValueOrDefault() == id);
            Assert.IsTrue(children >= count, $"Not enough children nested inside {toolName} in {workflowName}'s debug output");
        }

        [Then(@"each ""(.*)"" contains debug outputs for ""(.*)"" as")]
        public void ThenEachContainsDebugOutputsForAs(string toolName, string nestedToolName, Table table)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);
            var debugStates = Get<List<IDebugState>>("debugStates").ToList();

            var id = debugStates.Where(ds => ds.DisplayName.Equals("DsfActivity")).ToList();
            id.ForEach(x => Assert.AreEqual(1, debugStates.Count(a => a.ParentID.GetValueOrDefault() == x.ID && a.DisplayName == nestedToolName)));
        }

        T Get<T>(string keyName)
        {
            return _scenarioContext.Get<T>(keyName);
        }

        void TryGetValue<T>(string keyName, out T value)
        {
            _scenarioContext.TryGetValue(keyName, out value);
        }

        [Then(@"the ""(.*)"" in Workflow ""(.*)"" has a debug Server Name of """"(.*)""""")]
        public void ThenTheInWorkflowHasADebugServerNameOf(string toolName, string workflowName, string remoteName)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);

            var debugStates = Get<List<IDebugState>>("debugStates").ToList();
            var workflowId = debugStates.First(wf => wf.DisplayName.Equals(workflowName)).ID;

            if (parentWorkflowName == workflowName)
            {
                workflowId = Guid.Empty;
            }

            var toolSpecificDebug =
                debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == workflowId && ds.DisplayName.Equals(toolName)).ToList();

            Assert.IsTrue(toolSpecificDebug.All(a => a.Server == remoteName));
            Assert.IsTrue(debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == workflowId && !ds.DisplayName.Equals(toolName)).All(a => a.Server == "localhost"));
        }

        [Then(@"the ""(.*)"" in Workflow ""(.*)"" debug outputs is")]
        public void ThenTheInWorkflowDebugOutputsIs(string p0, string p1, Table table)
        {
            ThenTheInWorkflowDebugOutputsAs(p0, p1, table);
        }

        [Given(@"the ""(.*)"" in Workflow ""(.*)"" debug outputs as")]
        [When(@"the ""(.*)"" in Workflow ""(.*)"" debug outputs as")]
        [Then(@"the ""(.*)"" in Workflow ""(.*)"" debug outputs as")]
        public void ThenTheInWorkflowDebugOutputsAs(string toolName, string workflowName, Table table)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);

            var debugStates = Get<List<IDebugState>>("debugStates");
            var workflowId = Guid.Empty;

            if (parentWorkflowName != workflowName)
            {
                if (toolName != null && workflowName != null)
                {
                    IDebugState debugState = debugStates.FirstOrDefault(wf => wf.DisplayName.Equals(workflowName));
                    if (debugState != null)
                    {
                        workflowId = debugState.ID;
                    }
                    else
                    {
                        var errors = debugStates.Where(wf => wf.ErrorMessage != "");
                        var errorsMessage = "";
                        if (errors.Any())
                        {
                            errorsMessage = " There were one or more errors found in other tools on the same workflow though: " + string.Join(", ", errors.Select(wf => wf.ErrorMessage).Distinct().ToArray());
                        }
                        Assert.Fail($"Debug output for {toolName} not found in {workflowName}.{errorsMessage}");
                    }
                }
                else
                {
                    throw new InvalidOperationException("SpecFlow broke.");
                }
            }

            var toolSpecificDebug =
                debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == workflowId && ds.DisplayName.Equals(toolName)).ToList();
            if (!toolSpecificDebug.Any())
            {
                toolSpecificDebug =
                debugStates.Where(ds => ds.DisplayName.Equals(toolName)).ToList();
            }
            // Data Merge breaks our debug scheme, it only ever has 1 value, not the expected 2 ;)
            var isDataMergeDebug = toolSpecificDebug.Count == 1 && toolSpecificDebug.Any(t => t.Name == "Data Merge");
            IDebugState outputState;
            if (toolSpecificDebug.Count > 1 && toolSpecificDebug.Any(state => state.StateType == StateType.End))
            {
                outputState = toolSpecificDebug.FirstOrDefault(state => state.StateType == StateType.End);
            }
            else
            {
                outputState = toolSpecificDebug.FirstOrDefault();
            }

            if (outputState?.Outputs != null)
            {
                var SelectResults = outputState.Outputs.SelectMany(s => s.ResultsList);
                if (SelectResults != null && SelectResults.ToList() != null)
                {
                    _commonSteps.ThenTheDebugOutputAs(table, SelectResults.ToList(), isDataMergeDebug);
                    return;
                }
                Assert.Fail(outputState.Outputs.ToList() + " debug outputs found on " + workflowName + " does not include " + toolName + ".");
            }
            Assert.Fail("No debug output found for " + workflowName + ".");
        }


        [Given(@"the ""(.*)"" in Workflow ""(.*)"" unsorted debug outputs as")]
        [When(@"the ""(.*)"" in Workflow ""(.*)"" unsorted debug outputs as")]
        [Then(@"the ""(.*)"" in Workflow ""(.*)"" unsorted debug outputs as")]
        public void ThenTheInWorkflowUnsortedDebugOutputsAs(string toolName, string workflowName, Table table)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);

            var debugStates = Get<List<IDebugState>>("debugStates");
            var workflowId = Guid.Empty;

            if (parentWorkflowName != workflowName)
            {
                if (toolName != null && workflowName != null)
                {
                    IDebugState debugState = debugStates.FirstOrDefault(wf => wf.DisplayName.Equals(workflowName));
                    if (debugState != null)
                    {
                        workflowId = debugState.ID;
                    }
                    else
                    {
                        var errors = debugStates.Where(wf => wf.ErrorMessage != "");
                        var errorsMessage = "";
                        if (errors != null)
                        {
                            errorsMessage = " There were one or more errors found in other tools on the same workflow though: " + string.Join(", ", errors.Select(wf => wf.ErrorMessage).Distinct().ToArray());
                        }
                        Assert.Fail($"Debug output for {toolName} not found in {workflowName}.{errorsMessage}");
                    }
                }
                else
                {
                    throw new InvalidOperationException("SpecFlow broke.");
                }
            }

            var toolSpecificDebug =
                debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == workflowId && ds.DisplayName.Equals(toolName)).ToList();
            if (!toolSpecificDebug.Any())
            {
                toolSpecificDebug =
                debugStates.Where(ds => ds.DisplayName.Equals(toolName)).ToList();
            }
            // Data Merge breaks our debug scheme, it only ever has 1 value, not the expected 2 ;)
            var isDataMergeDebug = toolSpecificDebug.Count == 1 && toolSpecificDebug.Any(t => t.Name == "Data Merge");
            IDebugState outputState;
            if (toolSpecificDebug.Count > 1 && toolSpecificDebug.Any(state => state.StateType == StateType.End))
            {
                outputState = toolSpecificDebug.FirstOrDefault(state => state.StateType == StateType.End);
            }
            else
            {
                outputState = toolSpecificDebug.FirstOrDefault();
            }

            if (outputState?.Outputs != null)
            {
                var SelectResults = outputState.Outputs.SelectMany(s => s.ResultsList);
                if (SelectResults != null && SelectResults.ToList() != null)
                {
                    _commonSteps.ThenTheDebugOutputAs(table, SelectResults.ToList(), isDataMergeDebug, true);
                    return;
                }
                Assert.Fail(outputState.Outputs.ToList() + " debug outputs found on " + workflowName + " does not include " + toolName + ".");
            }
            Assert.Fail("No debug output found for " + workflowName + ".");
        }


        [Then(@"the tool ""(.*)"" with Guid of ""(.*)"" in Workflow ""(.*)"" debug outputs as")]
        public void ThenTheToolWithGuidOfInWorkflowDebugOutputsAs(string toolName, string toolGuid, string workflowName, Table table)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);

            var debugStates = Get<List<IDebugState>>("debugStates");
            var workflowId = Guid.Empty;

            if (parentWorkflowName != workflowName)
            {
                if (workflowName != null)
                {
                    var debugState = debugStates.FirstOrDefault(wf => wf.DisplayName.Equals(workflowName));
                    if (debugState != null)
                    {
                        workflowId = debugState.ID;
                    }
                    else
                    {
                        var errors = debugStates.Where(wf => wf.ErrorMessage != "");
                        var errorsMessage = "";
                        if (errors != null)
                        {
                            errorsMessage = " There were one or more errors found in other tools on the same workflow though: " + string.Join(", ", errors.Select(wf => wf.ErrorMessage).Distinct().ToArray());
                        }
                        Assert.Fail($"Debug output for {toolName} not found in {workflowName}.{errorsMessage}");
                    }
                }
                else
                {
                    throw new InvalidOperationException("Could not find workflow.");
                }
            }

            var toolSpecificDebug = debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == workflowId &&
                                                            GetMatchingNames(toolName, ds.DisplayName) &&
                                                            ds.ID.Equals(Guid.Parse(toolGuid))).ToList();
            if (!toolSpecificDebug.Any())
            {
                toolSpecificDebug = debugStates.Where(ds => ds.DisplayName.Equals(toolName)).ToList();
            }
            // Data Merge breaks our debug scheme, it only ever has 1 value, not the expected 2 ;)
            var isDataMergeDebug = toolSpecificDebug.Count == 1 && toolSpecificDebug.Any(t => t.Name == "Data Merge");
            IDebugState outputState;
            if (toolSpecificDebug.Count > 1 && toolSpecificDebug.Any(state => state.StateType == StateType.End))
            {
                outputState = toolSpecificDebug.FirstOrDefault(state => state.StateType == StateType.End);
            }
            else
            {
                outputState = toolSpecificDebug.FirstOrDefault();
            }

            if (outputState?.Outputs != null)
            {
                var SelectResults = outputState.Outputs.SelectMany(s => s.ResultsList);
                if (SelectResults != null && SelectResults.ToList() != null)
                {
                    _commonSteps.ThenTheDebugOutputAs(table, SelectResults.ToList(), isDataMergeDebug);
                    return;
                }
                Assert.Fail(outputState.Outputs.ToList() + " debug outputs found on " + workflowName + " does not include " + toolName + ".");
            }
            Assert.Fail("No debug output found for " + workflowName + ".");
        }

        [Then(@"the ""(.*)"" in Workflow ""(.*)"" debug output contains as")]
        public void ThenTheInWorkflowDebugOutputContainsAs(string toolName, string workflowName, Table table)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);

            var debugStates = Get<List<IDebugState>>("debugStates");
            var workflowId = Guid.Empty;

            if (parentWorkflowName != workflowName)
            {
                if (toolName != null && workflowName != null)
                {
                    workflowId = debugStates.First(wf => wf.DisplayName.Equals(workflowName)).ID;
                }
                else
                {
                    throw new InvalidOperationException("SpecFlow broke.");
                }
            }

            var toolSpecificDebug =
                debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == workflowId && ds.DisplayName.Equals(toolName)).ToList();
            if (!toolSpecificDebug.Any())
            {
                toolSpecificDebug =
                debugStates.Where(ds => ds.DisplayName.Equals(toolName)).ToList();
            }
            // Data Merge breaks our debug scheme, it only ever has 1 value, not the expected 2 ;)
            var isDataMergeDebug = toolSpecificDebug.Count == 1 && toolSpecificDebug.Any(t => t.Name == "Data Merge");
            var outputState = toolSpecificDebug.FirstOrDefault();
            if (toolSpecificDebug.Count > 1)
            {
                if (toolSpecificDebug.Any(state => state.StateType == StateType.End))
                {
                    outputState = toolSpecificDebug.FirstOrDefault(state => state.StateType == StateType.End);
                }
            }
            var debugItemResults = outputState?.Outputs.SelectMany(s => s.ResultsList).ToList();
            Assert.IsNotNull(debugItemResults);
            Assert.IsTrue(debugItemResults.Any(result => result.Value.Contains("{\r\n  \"Name\": \"Bob\"\r\n}")));
        }

        [Given(@"""(.*)"" contains an SQL Bulk Insert ""(.*)"" using database ""(.*)"" and table ""(.*)"" and KeepIdentity set ""(.*)"" and Result set ""(.*)"" for testing as")]
        [Given(@"""(.*)"" contains an SQL Bulk Insert ""(.*)"" using database ""(.*)"" and table ""(.*)"" and KeepIdentity set ""(.*)"" and Result set ""(.*)"" as")]
        public void GivenContainsAnSQLBulkInsertUsingDatabaseAndTableAndKeepIdentitySetAndResultSetForTestingAs(string workflowName, string activityName, string dbSrcName, string tableName, string keepIdentity, string result, Table table)
        {
            if (dbSrcName == "NewSqlServerSource" || dbSrcName == "NewSqlBulkInsertSource")
            {
                _containerOps = new Depends(Depends.ContainerType.MSSQL, true);
            }
            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();
            var environmentConnection = environmentModel.Connection;
            var controllerFactory = new CommunicationControllerFactory();
            var _proxyLayer = new StudioServerProxy(controllerFactory, environmentConnection);
            var dbSources = _proxyLayer.QueryManagerProxy.FetchDbSources().ToList();
            var dbSource = dbSources.Single(source => source.Name == dbSrcName);

            // extract keepIdentity value ;)
            bool.TryParse(keepIdentity, out bool keepIdentityBool);

            // Configure activity ;)
            var dsfSqlBulkInsert = new DsfSqlBulkInsertActivity
            {
                Result = result
                ,
                DisplayName = activityName
                ,
                TableName = tableName
                ,
                Database = new DbSource
                {
                    ResourceID = dbSource.Id,
                    AuthenticationType = dbSource.AuthenticationType,
                    DatabaseName = dbSrcName,
                },
                KeepIdentity = keepIdentityBool,


            };
            // build input mapping
            var mappings = new List<DataColumnMapping>();

            var pos = 1;

            foreach (var row in table.Rows)

            {
                var outputColumn = row["Column"];
                var inputColumn = row["Mapping"];
                var isNullableStr = row["IsNullable"];
                var dataTypeName = row["DataTypeName"];
                var maxLengthStr = row["MaxLength"];
                var isAutoIncrementStr = row["IsAutoIncrement"];
                bool.TryParse(isNullableStr, out bool isNullable);
                bool.TryParse(isAutoIncrementStr, out bool isAutoIncrement);
                int.TryParse(maxLengthStr, out int maxLength);
                Enum.TryParse(dataTypeName, true, out SqlDbType dataType);

                var mapping = new DataColumnMapping { IndexNumber = pos, InputColumn = inputColumn, OutputColumn = new DbColumn { ColumnName = outputColumn, IsAutoIncrement = isAutoIncrement, IsNullable = isNullable, MaxLength = maxLength, SqlDataType = dataType } };
                mappings.Add(mapping);
                pos++;
            }

            dsfSqlBulkInsert.InputMappings = mappings;
            _commonSteps.AddVariableToVariableList(result);
            _commonSteps.AddActivityToActivityList(workflowName, activityName, dsfSqlBulkInsert);

        }

        [Given(@"""(.*)"" contains an Sort ""(.*)"" as")]
        public void GivenContainsAnSortAs(string parentName, string activityName, Table table)
        {
            var dsfSort = new DsfSortRecordsActivity { DisplayName = activityName, SortField = table.Rows[0][0], SelectedSort = table.Rows[0][1] };
            _commonSteps.AddActivityToActivityList(parentName, activityName, dsfSort);
        }

        [Given(@"""(.*)"" contains a Cmd Script ""(.*)"" ScriptToRun ""(.*)"" and result as ""(.*)""")]
        public void GivenContainsACmdScriptScriptToRunAndResultAs(string parentName, string activityName, string scriptToRun, string Result)
        {
            var commandLineActivity = new DsfExecuteCommandLineActivity
            {
                DisplayName = activityName,
                CommandFileName = scriptToRun,
                CommandResult = Result

            };
            _commonSteps.AddActivityToActivityList(parentName, activityName, commandLineActivity);
        }

        [Given(@"""(.*)"" contains a Java Script ""(.*)"" ScriptToRun ""(.*)"" and result as ""(.*)""")]
        public void GivenContainsAJavaScriptScriptToRunAndResultAs(string parentName, string activityName, string scriptToRun, string Result)
        {
            var dsfJavascriptActivity = new DsfJavascriptActivity
            {
                DisplayName = activityName,
                Result = Result,
                Script = scriptToRun
            };
            _commonSteps.AddActivityToActivityList(parentName, activityName, dsfJavascriptActivity);
        }

        [Given(@"""(.*)"" contains a Python ""(.*)"" ScriptToRun ""(.*)"" and result as ""(.*)""")]
        public void GivenContainsAPythonScriptToRunAndResultAs(string parentName, string activityName, string scriptToRun, string Result)
        {
            var dsfPythonActivity = new DsfPythonActivity
            {
                DisplayName = activityName
                ,
                Result = Result
                ,
                Script = scriptToRun
                ,
                EscapeScript = true
            };
            _commonSteps.AddActivityToActivityList(parentName, activityName, dsfPythonActivity);
        }

        [Given(@"""(.*)"" contains a Ruby ""(.*)"" ScriptToRun ""(.*)"" and result as ""(.*)""")]
        public void GivenContainsARubyScriptToRunAndResultAs(string parentName, string activityName, string scriptToRun, string Result)
        {
            var rubyActivity = new DsfRubyActivity { DisplayName = activityName, Result = Result, Script = scriptToRun };
            _commonSteps.AddActivityToActivityList(parentName, activityName, rubyActivity);
        }

        [Given(@"""(.*)"" contains SharepointDownloadFile ""(.*)"" as")]
        public void GivenContainsSharepointDownloadFileAs(string parentName, string activityName, Table table)
        {
            var server = table.Rows[0]["Server"];
            var result = table.Rows[0]["Result"];
            var serverPath = table.Rows[0]["ServerPathFrom"];
            var serverPathUniqueNameGuid = ScenarioContext.Current.Get<string>("serverPathToUniqueNameGuid");
            serverPath = CommonSteps.AddGuidToPath(serverPath, serverPathUniqueNameGuid);
            var localPath = table.Rows[0]["LocalPathTo"];
            var downLoadActivity = new SharepointFileDownLoadActivity
            {
                DisplayName = activityName
                ,
                SharepointServerResourceId = ConfigurationManager.AppSettings[server].ToGuid()
                ,
                LocalInputPath = localPath
                ,
                ServerInputPath = serverPath
                ,
                Result = result

            };
            _commonSteps.AddVariableToVariableList(result);
            _commonSteps.AddActivityToActivityList(parentName, activityName, downLoadActivity);
        }

        [Given(@"""(.*)"" contains SharepointMoveFile ""(.*)"" as")]
        public void GivenContainsSharepointMoveFileAs(string parentName, string activityName, Table table)
        {
            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();

            var sources = environmentModel.ResourceRepository.FindSourcesByType<SharepointSource>(environmentModel, enSourceType.SharepointServerSource) ?? new List<SharepointSource>();
            var result = table.Rows[0]["Result"];
            var name = table.Rows[0]["Server"];
            var serverPathFrom = table.Rows[0]["ServerPathFrom"];
            var serverPathUniqueNameGuid = ScenarioContext.Current.Get<string>("serverPathToUniqueNameGuid");
            serverPathFrom = CommonSteps.AddGuidToPath(serverPathFrom, serverPathUniqueNameGuid);
            var serverPathTo = table.Rows[0]["ServerPathTo"];
            var sharepointServerResourceId = ConfigurationManager.AppSettings[name].ToGuid();
            var sharepointSource = sources.Single(source => source.ResourceID == sharepointServerResourceId);

            var readFolderItemActivity = new SharepointMoveFileActivity
            {
                DisplayName = activityName,
                SharepointServerResourceId = sharepointSource.ResourceID,
                Result = result,
                ServerInputPathFrom = serverPathFrom,
                ServerInputPathTo = serverPathTo,
                Overwrite = true


            };
            _commonSteps.AddVariableToVariableList(result);
            _commonSteps.AddActivityToActivityList(parentName, activityName, readFolderItemActivity);
        }

        [Given(@"""(.*)"" contains SharepointCopyFile ""(.*)"" as")]
        public void GivenContainsSharepointCopyFileAs(string parentName, string activityName, Table table)
        {
            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();

            var sources = environmentModel.ResourceRepository.FindSourcesByType<SharepointSource>(environmentModel, enSourceType.SharepointServerSource) ?? new List<SharepointSource>();
            var result = table.Rows[0]["Result"];
            var name = table.Rows[0]["Server"];
            var overwrite = table.Rows[0]["Overwrite"];
            var serverPathFrom = table.Rows[0]["ServerPathFrom"];
            var serverPathUniqueNameGuid = ScenarioContext.Current.Get<string>("serverPathToUniqueNameGuid");
            serverPathFrom = CommonSteps.AddGuidToPath(serverPathFrom, serverPathUniqueNameGuid);
            var serverPathTo = table.Rows[0]["ServerPathTo"];
            var sharepointServerResourceId = ConfigurationManager.AppSettings[name].ToGuid();
            var sharepointSource = sources.Single(source => source.ResourceID == sharepointServerResourceId);

            var readFolderItemActivity = new SharepointCopyFileActivity
            {
                DisplayName = activityName,
                SharepointServerResourceId = sharepointSource.ResourceID,
                Result = result,
                ServerInputPathFrom = serverPathFrom,
                ServerInputPathTo = serverPathTo,
                Overwrite = bool.Parse(overwrite)

            };
            _commonSteps.AddVariableToVariableList(result);
            _commonSteps.AddActivityToActivityList(parentName, activityName, readFolderItemActivity);
        }


        [Given(@"""(.*)"" contains SharepointReadListItem ""(.*)"" as")]
        public void GivenContainsSharepointReadListItemAs(string parentName, string activityName, Table table)
        {
            //Load Source based on the name
            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();

            var sharepointList = table.Rows[0]["List"];
            var readListActivity = new SharepointReadListActivity
            {
                DisplayName = activityName
                ,
                SharepointServerResourceId = ConfigurationManager.AppSettings[table.Rows[0]["Server"]].ToGuid()
                ,
                SharepointList = sharepointList

            };
            var sources = environmentModel.ResourceRepository.FindSourcesByType<SharepointSource>(environmentModel, enSourceType.SharepointServerSource) ?? new List<SharepointSource>();
            var sharepointSource = sources.Single(source => source.ResourceID == readListActivity.SharepointServerResourceId);
            var sharepointListTos = environmentModel.ResourceRepository.GetSharepointLists(sharepointSource);
            var sharepointListTo = sharepointListTos.Single(to => to.FullName == sharepointList);
            var sharepointFieldsToKeep = new List<ISharepointFieldTo>()
            {
                new SharepointFieldTo {InternalName = "Title"},
                new SharepointFieldTo {InternalName = "Name"},
                new SharepointFieldTo {InternalName = "IntField"},
                new SharepointFieldTo {InternalName = "CurrencyField"},
                new SharepointFieldTo {InternalName = "DateField"},
                new SharepointFieldTo {InternalName = "DateTimeField"},
                new SharepointFieldTo {InternalName = "BoolField"},
                new SharepointFieldTo {InternalName = "MultilineTextField"},
                new SharepointFieldTo {InternalName = "RequiredField"},
                new SharepointFieldTo {InternalName = "Loc"}
            };
            var asyncWorker = new SynchronousAsyncWorker();
            asyncWorker.Start(() => GetListFields(environmentModel, sharepointSource, sharepointListTo), columnList =>
            {
                if (columnList != null)
                {
                    var fieldMappings = columnList
                    .Where(to => sharepointFieldsToKeep.Any(fieldTo => fieldTo.InternalName == to.InternalName))
                    .Select(mapping =>
                    {

                        var recordsetDisplayValue = DataListUtil.CreateRecordsetDisplayValue(sharepointListTo.FullName.Replace(" ", "").Replace(".", ""), GetValidVariableName(mapping), "*");
                        var sharepointReadListTo = new SharepointReadListTo(DataListUtil.AddBracketsToValueIfNotExist(recordsetDisplayValue), mapping.Name, mapping.InternalName, mapping.Type.ToString()) { IsRequired = mapping.IsRequired };
                        return sharepointReadListTo;
                    }).ToList();
                    if (readListActivity.ReadListItems == null || readListActivity.ReadListItems.Count == 0)
                    {
                        readListActivity.ReadListItems = fieldMappings;
                    }
                    else
                    {
                        foreach (var sharepointReadListTo in fieldMappings)
                        {
                            var listTo = sharepointReadListTo;
                            var readListTo = readListActivity.ReadListItems.FirstOrDefault(to => to.FieldName == listTo.FieldName);
                            if (readListTo == null)
                            {
                                readListActivity.ReadListItems.Add(sharepointReadListTo);
                            }
                        }
                    }

                }
            });

            _commonSteps.AddVariableToVariableList("[[AccTesting().Title]]");
            _commonSteps.AddVariableToVariableList("[[AccTesting().Name]]");
            _commonSteps.AddVariableToVariableList("[[AccTesting().IntField]]");
            _commonSteps.AddVariableToVariableList("[[AccTesting().CurrencyField]]");
            _commonSteps.AddVariableToVariableList("[[AccTesting().DateField]]");
            _commonSteps.AddVariableToVariableList("[[AccTesting().DateTimeField]]");
            _commonSteps.AddVariableToVariableList("[[AccTesting().BoolField]]");
            _commonSteps.AddVariableToVariableList("[[AccTesting().MultilineTextField]]");
            _commonSteps.AddVariableToVariableList("[[AccTesting().Loc]] ");
            _commonSteps.AddVariableToVariableList("[[AccTesting().RequiredField]]");
            _commonSteps.AddActivityToActivityList(parentName, activityName, readListActivity);
        }

        [Given(@"""(.*)"" contains SharepointReadFolder ""(.*)"" as")]
        public void GivenContainsSharepointReadFolderAs(string parentName, string activityName, Table table)
        {
            var server = table.Rows[0]["Server"];
            var result = table.Rows[0]["Result"];
            var readFolderItemActivity = new SharepointReadFolderItemActivity
            {
                DisplayName = activityName
                ,
                SharepointServerResourceId = ConfigurationManager.AppSettings[server].ToGuid()
                ,
                Result = result
                ,
                IsFoldersSelected = true

            };
            _commonSteps.AddVariableToVariableList(result);
            _commonSteps.AddActivityToActivityList(parentName, activityName, readFolderItemActivity);
        }

        [Given(@"""(.*)"" contains SharepointDeleteSingle ""(.*)"" as")]
        public void GivenContainsSharepointDeleteListItemAs(string parentName, string activityName, Table table)
        {
            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();

            var sources = environmentModel.ResourceRepository.FindSourcesByType<SharepointSource>(environmentModel, enSourceType.SharepointServerSource) ?? new List<SharepointSource>();
            var result = table.Rows[0]["Result"];
            var name = table.Rows[0]["Server"];
            var serverPath = table.Rows[0]["ServerPath"];
            if (ScenarioContext.Current.ContainsKey("serverPathToUniqueNameGuid"))
            {
                var serverPathUniqueNameGuid = ScenarioContext.Current.Get<string>("serverPathToUniqueNameGuid");
                serverPath = CommonSteps.AddGuidToPath(serverPath, serverPathUniqueNameGuid);
            }
            var sharepointServerResourceId = ConfigurationManager.AppSettings[name].ToGuid();
            var sharepointSource = sources.Single(source => source.ResourceID == sharepointServerResourceId);

            var deleteListItemActivity = new SharepointDeleteFileActivity
            {
                SharepointServerResourceId = sharepointSource.ResourceID
                ,
                DisplayName = activityName
                ,
                ServerInputPath = serverPath,
                Result = result
            };
            _commonSteps.AddVariableToVariableList(result);
            _commonSteps.AddActivityToActivityList(parentName, activityName, deleteListItemActivity);

        }
        [Given(@"""(.*)"" contains UpdateListItems ""(.*)"" as")]
        public void GivenContainsUpdateListItemsAs(string parentName, string activityName, Table table)
        {
            //Load Source based on the name
            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();

            var sharepointList = table.Rows[0]["List"];
            sharepointList += "_" + ScenarioContext.Current.Get<int>("recordsetNameRandomizer").ToString();
            var result = table.Rows[0]["Result"];
            var createListItemActivity = new SharepointUpdateListItemActivity
            {
                DisplayName = activityName
                ,
                SharepointServerResourceId = ConfigurationManager.AppSettings[table.Rows[0]["Server"]].ToGuid()
                ,
                Result = result
                ,
                SharepointList = sharepointList,

            };
            var sources = environmentModel.ResourceRepository.FindSourcesByType<SharepointSource>(environmentModel, enSourceType.SharepointServerSource) ?? new List<SharepointSource>();
            var sharepointSource = sources.Single(source => source.ResourceID == createListItemActivity.SharepointServerResourceId);
            var sharepointListTos = environmentModel.ResourceRepository.GetSharepointLists(sharepointSource);
            var sharepointListTo = sharepointListTos.Single(to => to.FullName == sharepointList);
            var sharepointFieldsToKeep = new List<ISharepointFieldTo>()
            {
                new SharepointFieldTo() {InternalName = "Title"},
                new SharepointFieldTo() {InternalName = "Name"},
                new SharepointFieldTo() {InternalName = "IntField"},
                new SharepointFieldTo() {InternalName = "CurrencyField"},
                new SharepointFieldTo() {InternalName = "DateField"},
                new SharepointFieldTo() {InternalName = "DateTimeField"},
                new SharepointFieldTo() {InternalName = "BoolField"},
                new SharepointFieldTo() {InternalName = "MultilineTextField"},
                new SharepointFieldTo() {InternalName = "RequiredField"},
                new SharepointFieldTo() {InternalName = "Loc",},
            };
            var asyncWorker = new SynchronousAsyncWorker();
            asyncWorker.Start(() => GetListFields(environmentModel, sharepointSource, sharepointListTo), columnList =>
            {
                if (columnList != null)
                {
                    var fieldMappings = columnList
                    .Where(to => sharepointFieldsToKeep.Any(fieldTo => fieldTo.InternalName == to.InternalName))
                    .Select(mapping =>
                    {
                        var recordsetDisplayValue = DataListUtil.CreateRecordsetDisplayValue(sharepointListTo.FullName.Replace(" ", "").Replace(".", ""), GetValidVariableName(mapping), "*");
                        var sharepointReadListTo = new SharepointReadListTo(DataListUtil.AddBracketsToValueIfNotExist(recordsetDisplayValue), mapping.Name, mapping.InternalName, mapping.Type.ToString()) { IsRequired = mapping.IsRequired };
                        return sharepointReadListTo;
                    }).ToList();
                    if (createListItemActivity.ReadListItems == null || createListItemActivity.ReadListItems.Count == 0)
                    {
                        createListItemActivity.ReadListItems = fieldMappings;
                    }
                    else
                    {
                        foreach (var sharepointReadListTo in fieldMappings)
                        {
                            var listTo = sharepointReadListTo;
                            var readListTo = createListItemActivity.ReadListItems.FirstOrDefault(to => to.FieldName == listTo.FieldName);
                            if (readListTo == null)
                            {
                                createListItemActivity.ReadListItems.Add(sharepointReadListTo);
                            }
                        }
                    }

                }
            });

            _commonSteps.AddActivityToActivityList(parentName, activityName, createListItemActivity);

        }
        [Given(@"""(.*)"" contains CreateListItems ""(.*)"" as")]
        public void GivenContainsCreateListItemsAs(string parentName, string activityName, Table table)
        {
            //Load Source based on the name
            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();

            var sharepointList = table.Rows[0]["List"];
            var result = table.Rows[0]["Result"];
            var createListItemActivity = new SharepointCreateListItemActivity
            {
                DisplayName = activityName
            ,
                SharepointServerResourceId = ConfigurationManager.AppSettings[table.Rows[0]["Server"]].ToGuid(),
                Result = result,
                SharepointList = sharepointList,

            };
            var sources = environmentModel.ResourceRepository.FindSourcesByType<SharepointSource>(environmentModel, enSourceType.SharepointServerSource) ?? new List<SharepointSource>();
            var sharepointSource = sources.Single(source => source.ResourceID == createListItemActivity.SharepointServerResourceId);
            var sharepointListTos = environmentModel.ResourceRepository.GetSharepointLists(sharepointSource);
            var sharepointListTo = sharepointListTos.Single(to => to.FullName == sharepointList);
            var sharepointFieldsToKeep = new List<ISharepointFieldTo>()
            {
                new SharepointFieldTo() {InternalName = "Title"},
                new SharepointFieldTo() {InternalName = "Name"},
                new SharepointFieldTo() {InternalName = "IntField"},
                new SharepointFieldTo() {InternalName = "CurrencyField"},
                new SharepointFieldTo() {InternalName = "DateField"},
                new SharepointFieldTo() {InternalName = "DateTimeField"},
                new SharepointFieldTo() {InternalName = "BoolField"},
                new SharepointFieldTo() {InternalName = "MultilineTextField"},
                new SharepointFieldTo() {InternalName = "RequiredField"},
                new SharepointFieldTo() {InternalName = "Loc",},
            };
            var asyncWorker = new SynchronousAsyncWorker();
            asyncWorker.Start(() => GetListFields(environmentModel, sharepointSource, sharepointListTo), columnList =>
            {
                if (columnList != null)
                {
                    var fieldMappings = columnList
                    .Where(to => sharepointFieldsToKeep.Any(fieldTo => fieldTo.InternalName == to.InternalName))
                    .Select(mapping =>
                    {

                        var recordsetDisplayValue = DataListUtil.CreateRecordsetDisplayValue(sharepointListTo.FullName.Replace(" ", "").Replace(".", ""), GetValidVariableName(mapping), "*");
                        var sharepointReadListTo = new SharepointReadListTo(DataListUtil.AddBracketsToValueIfNotExist(recordsetDisplayValue), mapping.Name, mapping.InternalName, mapping.Type.ToString()) { IsRequired = mapping.IsRequired };
                        return sharepointReadListTo;
                    }).ToList();
                    if (createListItemActivity.ReadListItems == null || createListItemActivity.ReadListItems.Count == 0)
                    {
                        createListItemActivity.ReadListItems = fieldMappings;
                    }
                    else
                    {
                        foreach (var sharepointReadListTo in fieldMappings)
                        {
                            var listTo = sharepointReadListTo;
                            var readListTo = createListItemActivity.ReadListItems.FirstOrDefault(to => to.FieldName == listTo.FieldName);
                            if (readListTo == null)
                            {
                                createListItemActivity.ReadListItems.Add(sharepointReadListTo);
                            }
                        }
                    }

                }
            });

            _commonSteps.AddVariableToVariableList("[[AcceptanceTesting_Create().Title]]");
            _commonSteps.AddVariableToVariableList("[[AcceptanceTesting_Create().Name]]");
            _commonSteps.AddVariableToVariableList("[[AcceptanceTesting_Create().IntField]]");
            _commonSteps.AddVariableToVariableList("[[AcceptanceTesting_Create().CurrencyField]]");
            _commonSteps.AddVariableToVariableList("[[AcceptanceTesting_Create().DateField]]");
            _commonSteps.AddVariableToVariableList("[[AcceptanceTesting_Create().DateTimeField]]");
            _commonSteps.AddVariableToVariableList("[[AcceptanceTesting_Create().BoolField]]");
            _commonSteps.AddVariableToVariableList("[[AcceptanceTesting_Create().MultilineTextField]]");
            _commonSteps.AddVariableToVariableList("[[AcceptanceTesting_Create().Loc]] ");
            _commonSteps.AddVariableToVariableList("[[AcceptanceTesting_Create().RequiredField]]");
            _commonSteps.AddActivityToActivityList(parentName, activityName, createListItemActivity);

        }

        static string GetValidVariableName(ISharepointFieldTo mapping)
        {
            var fixedName = mapping.Name.Replace(" ", "").Replace(".", "").Replace(":", "").Replace(",", "");
            fixedName = XmlConvert.EncodeName(fixedName);
            var startIndexOfEncoding = fixedName.IndexOf("_", StringComparison.OrdinalIgnoreCase);
            var endIndexOfEncoding = fixedName.LastIndexOf("_", StringComparison.OrdinalIgnoreCase);
            if (startIndexOfEncoding > 0 && endIndexOfEncoding > 0)
            {
                fixedName = fixedName.Remove(startIndexOfEncoding - 1, endIndexOfEncoding - startIndexOfEncoding);
            }
            if (fixedName[0] == 'f' || fixedName[0] == '_' || char.IsNumber(fixedName[0]))
            {
                fixedName = fixedName.Remove(0, 1);
            }
            return fixedName;
        }

        List<ISharepointFieldTo> GetListFields(IServer server, ISharepointSource source, SharepointListTo list)
        {
            var columns = server.ResourceRepository.GetSharepointListFields(source, list, true);
            return columns ?? new List<ISharepointFieldTo>();
        }
        [Given(@"""(.*)"" contains SharepointDeleteFile ""(.*)"" as")]
        public void GivenContainsSharepointDeleteFileAs(string parentName, string activityName, Table table)
        {
            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();

            var sources = environmentModel.ResourceRepository.FindSourcesByType<SharepointSource>(environmentModel, enSourceType.SharepointServerSource) ?? new List<SharepointSource>();

            var result = table.Rows[0]["Result"];
            var name = table.Rows[0]["Server"];
            var sharepointList = table.Rows[0]["SharepointList"];
            var sharepointServerResourceId = ConfigurationManager.AppSettings[name].ToGuid();
            var sharepointSource = sources.Single(source => source.ResourceID == sharepointServerResourceId);
            var deleteFileActivity = new SharepointDeleteListItemActivity()
            {
                DisplayName = activityName,
                SharepointServerResourceId = sharepointSource.ResourceID,
                SharepointList = sharepointList,
                DeleteCount = result,
                FilterCriteria = new List<SharepointSearchTo>()
                {
                    new SharepointSearchTo("Title","=",Guid.NewGuid().ToString(),1)
                    {
                        InternalName = "Title"
                    }
                }
                ,
                RequireAllCriteriaToMatch = true

            };

            _commonSteps.AddVariableToVariableList(result);
            _commonSteps.AddActivityToActivityList(parentName, activityName, deleteFileActivity);
        }

        [Given(@"""(.*)"" contains SharepointUploadFile ""(.*)"" as")]
        public void GivenContainsSharepointUploadFileAs(string parentName, string activityName, Table table)
        {
            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();

            var sources = environmentModel.ResourceRepository.FindSourcesByType<SharepointSource>(environmentModel, enSourceType.SharepointServerSource) ?? new List<SharepointSource>();
            var result = table.Rows[0]["Result"];
            var name = table.Rows[0]["Server"];
            var localPathFrom = table.Rows[0]["LocalPathFrom"];
            var serverPathTo = table.Rows[0]["ServerPathTo"];
            var serverPathToUniqueNameGuid = CommonSteps.GetGuid();
            serverPathTo = CommonSteps.AddGuidToPath(serverPathTo, serverPathToUniqueNameGuid);
            ScenarioContext.Current.Add("serverPathToUniqueNameGuid", serverPathToUniqueNameGuid);
            var sharepointServerResourceId = ConfigurationManager.AppSettings[name].ToGuid();
            var sharepointSource = sources.Single(source => source.ResourceID == sharepointServerResourceId);
            var fileUploadActivity = new SharepointFileUploadActivity
            {
                DisplayName = activityName
                ,
                SharepointServerResourceId = sharepointSource.ResourceID
                ,
                Result = result
                ,
                LocalInputPath = localPathFrom
                ,
                ServerInputPath = serverPathTo,

            };
            _commonSteps.AddVariableToVariableList(result);
            _commonSteps.AddActivityToActivityList(parentName, activityName, fileUploadActivity);
        }


        [Given(@"""(.*)"" contains SharepointDelete ""(.*)"" as")]
        public void GivenContainsSharepointDeleteAs(string parentName, string activityName, Table table)
        {
            var sourceName = table.Rows[0]["Source"];
            var list = table.Rows[0]["List"];

            var deleteListItemActivity = new SharepointDeleteListItemActivity
            {
                SharepointServerResourceId = ConfigurationManager.AppSettings[sourceName].ToGuid()
                ,
                DisplayName = activityName
                ,
                SharepointList = list
            };
            _commonSteps.AddActivityToActivityList(parentName, activityName, deleteListItemActivity);
        }

        [Given(@"""(.*)"" contains a Web Delete ""(.*)"" result as ""(.*)""")]
        public void GivenContainsAWebDeleteResultAs(string parentName, string activityName, string result)
        {
            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();
            var environmentConnection = environmentModel.Connection;
            var controllerFactory = new CommunicationControllerFactory();
            var _proxyLayer = new StudioServerProxy(controllerFactory, environmentConnection);
            var mock = new Mock<IShellViewModel>();
            var manageWebServiceModel = new ManageWebServiceModel(
                                                                                    new StudioResourceUpdateManager(controllerFactory, environmentConnection)
                                                                                    , _proxyLayer.QueryManagerProxy
                                                                                    , mock.Object
                                                                                    , environmentModel);
            var pluginSources = _proxyLayer.QueryManagerProxy.FetchWebServiceSources().ToList();
            var a = pluginSources.Single(source => source.Id == "3032b7fd-f12a-4ab8-be7d-2f4705c31317".ToGuid());
            var webServiceDefinition = new WebServiceDefinition()
            {
                Name = "Delete",
                Path = "",
                Source = a,
                Inputs = new List<IServiceInput>(),
                OutputMappings = new List<IServiceOutputMapping>(),
                QueryString = "",
                Id = a.Id,
                Headers = new List<INameValue>(),
                Method = WebRequestMethod.Delete
            };
            var testResult = manageWebServiceModel.TestService(webServiceDefinition);

            var serializer = new Dev2JsonSerializer();

            var dsfWebDeleteActivity = new DsfWebDeleteActivity
            {
                DisplayName = activityName
                ,
                SourceId = a.Id
            };

            RecordsetList recordsetList;
            using (var responseService = serializer.Deserialize<WebService>(testResult))
            {
                recordsetList = responseService.Recordsets;
                if (recordsetList.Any(recordset => recordset.HasErrors))
                {
                    var errorMessage = string.Join(Environment.NewLine, recordsetList.Select(recordset => recordset.ErrorMessage));
                    throw new Exception(errorMessage);
                }
                dsfWebDeleteActivity.OutputDescription = responseService.GetOutputDescription();
            }

            var outputMapping = recordsetList.SelectMany(recordset => recordset.Fields, (recordset, recordsetField) =>
            {
                var serviceOutputMapping = new ServiceOutputMapping(recordsetField.Name, recordsetField.Alias, recordset.Name) { Path = recordsetField.Path };
                return serviceOutputMapping;
            }).Cast<IServiceOutputMapping>().ToList();

            dsfWebDeleteActivity.Outputs = outputMapping;
            dsfWebDeleteActivity.Headers = new List<INameValue>();
            dsfWebDeleteActivity.QueryString = string.Empty;
            _commonSteps.AddActivityToActivityList(parentName, activityName, dsfWebDeleteActivity);
        }

        [Given(@"""(.*)"" contains a Web Post ""(.*)"" result as ""(.*)""")]
        public void GivenContainsAWebPostResultAs(string parentName, string activityName, string result)
        {
            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();
            var environmentConnection = environmentModel.Connection;
            var controllerFactory = new CommunicationControllerFactory();
            var _proxyLayer = new StudioServerProxy(controllerFactory, environmentConnection);
            var mock = new Mock<IShellViewModel>();
            var manageWebServiceModel = new ManageWebServiceModel(
                  new StudioResourceUpdateManager(controllerFactory, environmentConnection)
                  , _proxyLayer.QueryManagerProxy
                  , mock.Object
                  , environmentModel);

            var webSources = _proxyLayer.QueryManagerProxy.FetchWebServiceSources().ToList();
            var a = webSources.Single(source => source.Id == "ab4d5ab5-ad44-421d-8125-adfcc3aa655b".ToGuid());
            var webServiceDefinition = new WebServiceDefinition()
            {
                Name = "Post",
                Path = "",
                Source = a,
                Inputs = new List<IServiceInput>(),
                OutputMappings = new List<IServiceOutputMapping>(),
                QueryString = "",
                Id = a.Id,
                Headers = new List<INameValue>(),
                Method = WebRequestMethod.Post
            };
            var testResult = manageWebServiceModel.TestService(webServiceDefinition);

            var serializer = new Dev2JsonSerializer();

            var dsfWebPostActivity = new DsfWebPostActivity
            {
                DisplayName = activityName
                ,
                PostData = string.Empty
                ,
                SourceId = a.Id
            };

            RecordsetList recordsetList;
            using (var responseService = serializer.Deserialize<WebService>(testResult))
            {
                recordsetList = responseService.Recordsets;
                if (recordsetList.Any(recordset => recordset.HasErrors))
                {
                    var errorMessage = string.Join(Environment.NewLine, recordsetList.Select(recordset => recordset.ErrorMessage));
                    throw new Exception(errorMessage);
                }
                dsfWebPostActivity.OutputDescription = responseService.GetOutputDescription();
            }

            var outputMapping = recordsetList.SelectMany(recordset => recordset.Fields, (recordset, recordsetField) =>
            {
                var serviceOutputMapping = new ServiceOutputMapping(recordsetField.Name, recordsetField.Alias, recordset.Name) { Path = recordsetField.Path };
                return serviceOutputMapping;
            }).Cast<IServiceOutputMapping>().ToList();

            dsfWebPostActivity.Outputs = outputMapping;
            dsfWebPostActivity.Headers = new List<INameValue>();
            dsfWebPostActivity.QueryString = string.Empty;
            _commonSteps.AddActivityToActivityList(parentName, activityName, dsfWebPostActivity);
        }

        [Given(@"""(.*)"" contains a Web Get ""(.*)"" result as ""(.*)""")]
        public void GivenContainsAWebGetResultAs(string parentName, string activityName, string result)
        {
            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();
            var environmentConnection = environmentModel.Connection;
            var controllerFactory = new CommunicationControllerFactory();
            var _proxyLayer = new StudioServerProxy(controllerFactory, environmentConnection);
            var mock = new Mock<IShellViewModel>();
            var manageWebServiceModel = new ManageWebServiceModel(
                                                                                    new StudioResourceUpdateManager(controllerFactory, environmentConnection)
                                                                                    , _proxyLayer.QueryManagerProxy
                                                                                    , mock.Object
                                                                                    , environmentModel);
            var pluginSources = _proxyLayer.QueryManagerProxy.FetchWebServiceSources().ToList();
            var a = pluginSources.Single(source => source.Id == "e541d860-cd10-4aec-b2fe-79eca3c62c25".ToGuid());
            var webServiceDefinition = new WebServiceDefinition()
            {
                Name = "Get",
                Path = "",
                Source = a,
                Inputs = new List<IServiceInput>(),
                OutputMappings = new List<IServiceOutputMapping>(),
                QueryString = "",
                Id = a.Id,
                Headers = new List<INameValue>(),
                Method = WebRequestMethod.Get
            };
            var testResult = manageWebServiceModel.TestService(webServiceDefinition);

            var serializer = new Dev2JsonSerializer();

            var dsfWebGetActivity = new WebGetActivity
            {
                DisplayName = activityName
                ,
                SourceId = a.Id
            };

            RecordsetList recordsetList;
            using (var responseService = serializer.Deserialize<WebService>(testResult))
            {
                recordsetList = responseService.Recordsets;
                if (recordsetList.Any(recordset => recordset.HasErrors))
                {
                    var errorMessage = string.Join(Environment.NewLine, recordsetList.Select(recordset => recordset.ErrorMessage));
                    throw new Exception(errorMessage);
                }
                dsfWebGetActivity.OutputDescription = responseService.GetOutputDescription();
            }

            var outputMapping = recordsetList.SelectMany(recordset => recordset.Fields, (recordset, recordsetField) =>
            {
                var serviceOutputMapping = new ServiceOutputMapping(recordsetField.Name, recordsetField.Alias, recordset.Name) { Path = recordsetField.Path };
                return serviceOutputMapping;
            }).Cast<IServiceOutputMapping>().ToList();

            dsfWebGetActivity.Outputs = outputMapping;
            dsfWebGetActivity.Headers = new List<INameValue>
            {
                new NameValue("Content-Type","text/html")
            };
            dsfWebGetActivity.QueryString = string.Empty;
            _commonSteps.AddVariableToVariableList(result);
            _commonSteps.AddActivityToActivityList(parentName, activityName, dsfWebGetActivity);
        }

        [Given(@"""(.*)"" contains a Web Put ""(.*)"" result as ""(.*)""")]
        public void GivenContainsAWebPutResultAs(string parentName, string activityName, string result)
        {
            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();
            var environmentConnection = environmentModel.Connection;
            var controllerFactory = new CommunicationControllerFactory();
            var _proxyLayer = new StudioServerProxy(controllerFactory, environmentConnection);
            var mock = new Mock<IShellViewModel>();
            var manageWebServiceModel = new ManageWebServiceModel(
                                                                                    new StudioResourceUpdateManager(controllerFactory, environmentConnection)
                                                                                    , _proxyLayer.QueryManagerProxy
                                                                                    , mock.Object
                                                                                    , environmentModel);
            var pluginSources = _proxyLayer.QueryManagerProxy.FetchWebServiceSources().ToList();
            var a = pluginSources.Single(source => source.Id == "0fb49fec-e454-4357-a06f-08f329558b18".ToGuid());
            var webServiceDefinition = new WebServiceDefinition()
            {
                Name = "Put",
                Path = "",
                Source = a,
                Inputs = new List<IServiceInput>(),
                OutputMappings = new List<IServiceOutputMapping>(),
                QueryString = "",
                Id = a.Id,
                Headers = new List<INameValue>(),
                Method = WebRequestMethod.Put
            };
            var testResult = manageWebServiceModel.TestService(webServiceDefinition);

            var serializer = new Dev2JsonSerializer();

            var webPutActivity = new DsfWebPutActivity
            {
                DisplayName = activityName
                ,
                SourceId = a.Id
                ,
                PutData = "{\"Id\":\"\"}"
            };

            RecordsetList recordsetList;
            using (var responseService = serializer.Deserialize<WebService>(testResult))
            {
                recordsetList = responseService.Recordsets;
                if (recordsetList.Any(recordset => recordset.HasErrors))
                {
                    var errorMessage = string.Join(Environment.NewLine, recordsetList.Select(recordset => recordset.ErrorMessage));
                    throw new Exception(errorMessage);
                }
                webPutActivity.OutputDescription = responseService.GetOutputDescription();
            }

            var outputMapping = recordsetList.SelectMany(recordset => recordset.Fields, (recordset, recordsetField) =>
            {
                var serviceOutputMapping = new ServiceOutputMapping(recordsetField.Name, recordsetField.Alias, recordset.Name) { Path = recordsetField.Path };
                return serviceOutputMapping;
            }).Cast<IServiceOutputMapping>().ToList();

            webPutActivity.Outputs = outputMapping;
            webPutActivity.Headers = new List<INameValue>()
            {
                new NameValue("Content-Type","text/html")
            };
            webPutActivity.QueryString = string.Empty;
            _commonSteps.AddVariableToVariableList(result);
            _commonSteps.AddActivityToActivityList(parentName, activityName, webPutActivity);
        }



        [Given(@"""(.*)"" contains an Delete ""(.*)"" as")]

        public void GivenContainsAnDeleteAs(string parentName, string activityName, Table table)

        {
            var del = new DsfPathDelete { InputPath = table.Rows[0][0], Result = table.Rows[0][1], DisplayName = activityName };
            _commonSteps.AddVariableToVariableList(table.Rows[0][1]);
            _commonSteps.AddActivityToActivityList(parentName, activityName, del);
        }

        [Given(@"""(.*)"" contains a Foreach ""(.*)"" as ""(.*)"" executions ""(.*)""")]
        public void GivenContainsAForeachAsExecutions(string parentName, string activityName, string numberOfExecutions, string executionCount)
        {
            Enum.TryParse(numberOfExecutions, true, out enForEachType forEachType);
            var forEach = new DsfForEachActivity { DisplayName = activityName, ForEachType = forEachType };
            switch (forEachType)
            {
                case enForEachType.NumOfExecution:
                    forEach.NumOfExections = executionCount;
                    break;
                case enForEachType.InRecordset:
                    forEach.Recordset = executionCount;
                    break;
                case enForEachType.InRange:
                    break;
                case enForEachType.InCSV:
                    break;
                default:
                    break;
            }
            _commonSteps.AddActivityToActivityList(parentName, activityName, forEach);
            _scenarioContext.Add(activityName, forEach);
        }

        [Given(@"""(.*)"" contains a SelectAndApply ""(.*)"" DataSource ""(.*)"" Alias ""(.*)""")]
        public void GivenContainsASelectAndApplyDataSourceAlias(string parentName, string activityName, string datasource, string alias)
        {
            var selectAndApplyActivity = new DsfSelectAndApplyActivity { DisplayName = activityName, DataSource = datasource, Alias = alias };
            _commonSteps.AddActivityToActivityList(parentName, activityName, selectAndApplyActivity);
            _scenarioContext.Add(activityName, selectAndApplyActivity);
        }


        [Given(@"""(.*)"" contains workflow ""(.*)"" with mapping as")]

        public void GivenContainsWorkflowWithMappingAs(string forEachName, string nestedWF, Table mappings)

        {
            var forEachAct = (DsfForEachActivity)_scenarioContext[forEachName];
            var environmentModel = LocalEnvModel;
            if (!environmentModel.IsConnected)
            {
                environmentModel.Connect();
            }

            var resource = environmentModel.ResourceRepository.Find(a => a.Category == @"Acceptance Testing Resources\" + nestedWF).FirstOrDefault();
            if (resource == null)
            {
                environmentModel.LoadResources();
                resource = environmentModel.ResourceRepository.Find(a => a.Category == @"Acceptance Testing Resources\" + nestedWF).FirstOrDefault();
            }
            if (resource == null)
            {

                throw new ArgumentNullException("resource");

            }
            var dataMappingViewModel = GetDataMappingViewModel(resource, mappings);

            var inputMapping = dataMappingViewModel.GetInputString(dataMappingViewModel.Inputs);
            var outputMapping = dataMappingViewModel.GetOutputString(dataMappingViewModel.Outputs);
            var activity = new DsfActivity
            {

                ServiceName = resource.Category,
                ResourceID = resource.ID,
                EnvironmentID = environmentModel.EnvironmentID,
                UniqueID = resource.ID.ToString(),
                InputMapping = inputMapping,
                OutputMapping = outputMapping


            };

            var activityFunction = new ActivityFunc<string, bool> { Handler = activity, DisplayName = nestedWF };
            forEachAct.DataFunc = activityFunction;
        }


        [Given(@"""(.*)"" contains Find Record Index ""(.*)"" into result as ""(.*)""")]
        public void GivenContainsFindRecordIndexIntoResultAs(string parentName, string activityName, string result, Table table)
        {
            var act = new DsfFindRecordsMultipleCriteriaActivity { DisplayName = activityName, Result = result };
            foreach (var rule in table.Rows)
            {
                act.ResultsCollection.Add(new FindRecordsTO(rule[4], rule[3], 0));
                act.FieldsToSearch = string.IsNullOrEmpty(act.FieldsToSearch) ? rule[1] : "," + rule[1];
                act.RequireAllFieldsToMatch = rule[5].ToUpper().Trim() == "YES";
                act.RequireAllTrue = rule[6].ToUpper().Trim() == "YES";
            }
            _commonSteps.AddActivityToActivityList(parentName, activityName, act);
        }


        [Given(@"""(.*)"" contains Length ""(.*)"" on ""(.*)"" into ""(.*)""")]
        public void GivenContainsLengthOnInto(string parentName, string activityName, string recordSet, string result)
        {
            var len = new DsfRecordsetNullhandlerLengthActivity { DisplayName = activityName, RecordsLength = result, RecordsetName = recordSet };
            _commonSteps.AddActivityToActivityList(parentName, activityName, len);
        }

        public void SaveToWorkspace(IContextualResourceModel resourceModel)
        {
            BuildDataList();

            var activityList = _commonSteps.GetActivityList();

            var flowSteps = new List<FlowStep>();

            TestStartNode = new FlowStep();
            flowSteps.Add(TestStartNode);
            if (activityList != null)
            {
                foreach (var activity in activityList)
                {
                    if (TestStartNode.Action == null)
                    {
                        TestStartNode.Action = activity.Value;
                    }
                    else
                    {
                        var flowStep = new FlowStep { Action = activity.Value };
                        flowSteps.Last().Next = flowStep;
                        flowSteps.Add(flowStep);
                    }
                }
            }
            TryGetValue("environment", out IServer server);
            TryGetValue("resourceRepo", out IResourceRepository repository);

            var currentDl = CurrentDl;
            resourceModel.DataList = currentDl.Replace("root", "DataList");
            var helper = new WorkflowHelper();
            var xamlDefinition = helper.GetXamlDefinition(FlowchartActivityBuilder);
            resourceModel.WorkflowXaml = xamlDefinition;
            repository.Save(resourceModel);
        }

        [When(@"""(.*)"" is executed")]
        public void WhenIsExecuted(string workflowName)
        {
            var resourceModel = SaveAWorkflow(workflowName);
            ExecuteWorkflow(resourceModel);
        }

        [When(@"'(.*)' unsaved WF ""(.*)"" is executed")]
        public void WhenUnsavedWFIsExecuted(int numberToExecute, string unsavedName)
        {
            var unsavedWFs = Get<List<IContextualResourceModel>>("unsavedWFS");
            if (unsavedWFs != null && unsavedWFs.Count > 0)
            {
                var wfs = unsavedWFs.Where(model => model.ResourceName == unsavedName).ToList();
                if (wfs.Count >= numberToExecute)
                {
                    var resourceModel = wfs[numberToExecute - 1];
                    EnsureEnvironmentConnected(resourceModel.Environment, EnvironmentConnectionTimeout);
                    SaveToWorkspace(resourceModel);
                    var debugTo = new DebugTO { XmlData = "<DataList></DataList>", SessionID = Guid.NewGuid(), IsDebugMode = true };
                    var clientContext = resourceModel.Environment.Connection;
                    if (clientContext != null)
                    {
                        var dataList = XElement.Parse(debugTo.XmlData);
                        dataList.Add(new XElement("BDSDebugMode", debugTo.IsDebugMode));
                        dataList.Add(new XElement("DebugSessionID", debugTo.SessionID));
                        dataList.Add(new XElement("EnvironmentID", resourceModel.Environment.EnvironmentID));
                        WebServer.Send(resourceModel, dataList.ToString(), new SynchronousAsyncWorker());
                        _resetEvt.WaitOne(1000);
                    }
                }
            }
        }

        public void ExecuteWorkflow(IContextualResourceModel resourceModel)
        {
            if (resourceModel?.Environment == null)
            {
                return;
            }

            var debugTo = new DebugTO { XmlData = "<DataList></DataList>", SessionID = Guid.NewGuid(), IsDebugMode = true };
            EnsureEnvironmentConnected(resourceModel.Environment, EnvironmentConnectionTimeout);
            var clientContext = resourceModel.Environment.Connection;
            if (clientContext != null)
            {
                var dataList = XElement.Parse(debugTo.XmlData);
                dataList.Add(new XElement("BDSDebugMode", debugTo.IsDebugMode));
                dataList.Add(new XElement("DebugSessionID", debugTo.SessionID));
                dataList.Add(new XElement("EnvironmentID", resourceModel.Environment.EnvironmentID));
                WebServer.Send(resourceModel, dataList.ToString(), new SynchronousAsyncWorker());
                _resetEvt.WaitOne(3000);
            }
        }

        [When(@"workflow ""(.*)"" is saved ""(.*)"" time")]
        [Then(@"workflow ""(.*)"" is saved ""(.*)"" time")]
        [Given(@"workflow ""(.*)"" is saved ""(.*)"" time")]
        public void WhenWorkflowIsSavedTime(string workflowName, int count)
        {
            TryGetValue("SavedId", out Guid id);
            if (id == Guid.Empty)
            {
                id = Guid.NewGuid();
                _scenarioContext.Add("SavedId", id);
            }
            Save(workflowName, count, id);
        }

        [When(@"I reload Server resources")]
        public void WhenIReloadServerResources()
        {
            TryGetValue("environment", out IServer server);
            server.ResourceRepository.Load(true);
        }

        void Save(string workflowName, int count, Guid id)
        {
            BuildDataList();

            var activityList = _commonSteps.GetActivityList();

            var flowSteps = new List<FlowStep>();

            TestStartNode = new FlowStep();
            flowSteps.Add(TestStartNode);

            if (activityList != null)
            {
                foreach (var activity in activityList)
                {
                    if (TestStartNode.Action == null)
                    {
                        TestStartNode.Action = activity.Value;
                    }
                    else
                    {
                        var flowStep = new FlowStep { Action = activity.Value };
                        flowSteps.Last().Next = flowStep;
                        flowSteps.Add(flowStep);
                    }
                }
            }
            TryGetValue(workflowName, out IContextualResourceModel resourceModel);
            TryGetValue("environment", out IServer server);
            TryGetValue("resourceRepo", out IResourceRepository repository);

            var currentDl = CurrentDl;
            resourceModel.DataList = currentDl.Replace("root", "DataList");
            var helper = new WorkflowHelper();
            var xamlDefinition = helper.GetXamlDefinition(FlowchartActivityBuilder);
            resourceModel.WorkflowXaml = xamlDefinition;
            resourceModel.ID = id;

            for (var i = 0; i < count; i++)
            {
                repository.SaveToServer(resourceModel);
            }

        }

        [Given(@"I save workflow ""(.*)""")]
        [When(@"I save workflow ""(.*)""")]
        [Then(@"I save workflow ""(.*)""")]
        void Save(string workflowName)
        {
            BuildDataList();

            var activityList = _commonSteps.GetActivityList();

            var flowSteps = new List<FlowStep>();

            TestStartNode = new FlowStep();
            flowSteps.Add(TestStartNode);

            foreach (var activity in activityList)
            {
                if (TestStartNode.Action == null)
                {
                    TestStartNode.Action = activity.Value;
                }
                else
                {
                    var flowStep = new FlowStep { Action = activity.Value };
                    flowSteps.Last().Next = flowStep;
                    flowSteps.Add(flowStep);
                }
            }
            TryGetValue(workflowName, out IContextualResourceModel resourceModel);
            TryGetValue("environment", out IServer server);
            TryGetValue("resourceRepo", out IResourceRepository repository);

            var currentDl = CurrentDl;
            resourceModel.DataList = currentDl.Replace("root", "DataList");
            var helper = new WorkflowHelper();
            var xamlDefinition = helper.GetXamlDefinition(FlowchartActivityBuilder);
            resourceModel.WorkflowXaml = xamlDefinition;
            repository.SaveToServer(resourceModel);

        }

        [Then(@"workflow ""(.*)"" is deleted as cleanup")]
        public void ThenWorkflowIsDeletedAsCleanup(string workflowName)
        {
            TryGetValue(workflowName, out IContextualResourceModel resourceModel);
            TryGetValue("environment", out IServer server);
            TryGetValue("resourceRepo", out IResourceRepository repository);

            repository.DeleteResourceFromWorkspace(resourceModel);
            repository.DeleteResource(resourceModel);
        }

        [Then(@"the folder ""(.*)"" is deleted from the server as cleanup")]
        public void ThenTheFolderIsDeletedFromTheServerAsCleanup(string shapointLocalFolder)
        {
            var folderToDelete = Path.Combine(EnvironmentVariables.ResourcePath, shapointLocalFolder);
            Directory.Delete(folderToDelete, true);
        }

        [Then(@"workflow ""(.*)"" has ""(.*)"" Versions in explorer")]
        public void ThenWorkflowHasVersionsInExplorer(string workflowName, int numberOfVersions)
        {
            TryGetValue("SavedId", out Guid id);
            TryGetValue(workflowName, out IContextualResourceModel resourceModel);
            TryGetValue("environment", out IServer server);
            TryGetValue("resourceRepo", out IResourceRepository repository);
            var rep = new Studio.Core.VersionManagerProxy(new CommunicationControllerFactory(), server.Connection);
            var versions = rep.GetVersions(id);
            _scenarioContext["Versions"] = versions;
            Assert.AreEqual(numberOfVersions, versions.Count);
        }

        [Then(@"explorer as")]
        public void ThenExplorerAs(Table table)
        {
            var versions = _scenarioContext["Versions"] as IList<IExplorerItem>;
            if (versions == null || versions.Count == table.RowCount)
            {
                Assert.Fail("InvalidVersions");
            }
            else
            {
                for (var i = 0; i < versions.Count; i++)
                {
                    var v1 = table.Rows[i + 1][0].Split(' ');
                    Assert.IsTrue(versions[i].DisplayName.Contains(v1[0]));

                }
            }

        }

        [Given(@"""(.*)"" contains a Sequence ""(.*)"" as")]
        public void GivenContainsASequenceAs(string parentName, string activityName)
        {
            var dsfSequence = new DsfSequenceActivity { DisplayName = activityName };
            _commonSteps.AddActivityToActivityList(parentName, activityName, dsfSequence);
        }

        [Given(@"the workflow contains an Assign ""(.*)"" as")]
        [Then(@"the workflow contains an Assign ""(.*)"" as")]
        public void ThenContainsAnAssignAs(string assignName, Table table)
        {
            TryGetValue("parentWorkflowName", out string parentWorkflowName);
            ThenContainsAnAssignAs(parentWorkflowName, assignName, table);
        }

        [Then(@"I update ""(.*)"" by adding ""(.*)"" as")]
        public void ThenIUpdateByAddingAs(string parentName, string activityName, Table table)
        {
            var assignActivity = new DsfMultiAssignActivity { DisplayName = activityName };

            foreach (var tableRow in table.Rows)
            {
                var value = tableRow["value"];
                var variable = tableRow["variable"];

                value = value.Replace('"', ' ').Trim();

                if (value.StartsWith("="))
                {
                    value = value.Replace("=", "");
                    value = $"!~calculation~!{value}!~~calculation~!";
                }
                _scenarioContext.TryGetValue("fieldCollection", out List<ActivityDTO> fieldCollection);

                _commonSteps.AddVariableToVariableList(variable);

                assignActivity.FieldsCollection.Add(new ActivityDTO(variable, value, 1, true));
            }
            _commonSteps.AddActivityToActivityList(parentName, activityName, assignActivity);
        }


        [Then(@"I update ""(.*)"" inputs in ""(.*)"" as")]
        public void ThenIUpdateInputsInAs(string assignName, string parentName, Table table)
        {
            var assignActivity = _commonSteps.GetActivityList()
                .FirstOrDefault(p => p.Key == assignName)
                .Value as DsfMultiAssignActivity;

            foreach (var tableRow in table.Rows)
            {
                var value = tableRow["value"];
                var variable = tableRow["variable"];
                value = value.Replace('"', ' ').Trim();

                _commonSteps.AddVariableToVariableList(variable);
                assignActivity.FieldsCollection.Add(new ActivityDTO(variable, value, 1, true));
            }
        }

        [Given(@"""(.*)"" contains an Assign ""(.*)"" as")]
        [Then(@"""(.*)"" contains an Assign ""(.*)"" as")]
        public void ThenContainsAnAssignAs(string parentName, string assignName, Table table)
        {
            var assignActivity = new DsfMultiAssignActivity { DisplayName = assignName };

            foreach (var tableRow in table.Rows)
            {
                var value = tableRow["value"];
                var variable = tableRow["variable"];

                value = value.Replace('"', ' ').Trim();

                if (value.StartsWith("="))
                {
                    value = value.Replace("=", "");
                    value = $"!~calculation~!{value}!~~calculation~!";
                }
                if (value.Equals("TestingDotnetDllCascading.Food.ToJson"))
                {
                    var serializer = new Dev2JsonSerializer();
                    var serialize = serializer.Serialize(new Food());
                    value = serialize;
                }

                _scenarioContext.TryGetValue("fieldCollection", out List<ActivityDTO> fieldCollection);

                _commonSteps.AddVariableToVariableList(variable);

                assignActivity.FieldsCollection.Add(new ActivityDTO(variable, value, 1, true));
            }
            _commonSteps.AddActivityToActivityList(parentName, assignName, assignActivity);
        }

        [Given(@"""(.*)"" contains a recordset name randomizing Assign ""(.*)"" as")]
        [Then(@"""(.*)"" contains a recordset name randomizing Assign ""(.*)"" as")]
        public void ThenContainsARecordsetNameRandomizingAssignAs(string parentName, string assignName, Table table)
        {
            var assignActivity = new DsfMultiAssignActivity { DisplayName = assignName };
            var recordsetNameRandomizer = new Random().Next(60) + 1;
            ScenarioContext.Current.Add("recordsetNameRandomizer", recordsetNameRandomizer);

            foreach (var tableRow in table.Rows)
            {
                var value = tableRow["value"];
                var variable = tableRow["variable"];

                var endOfRecordsetName = variable.IndexOf('(');
                variable = variable.Substring(0, endOfRecordsetName) + "_" + recordsetNameRandomizer.ToString() + variable.Substring(endOfRecordsetName, variable.Length - endOfRecordsetName);

                _scenarioContext.TryGetValue("fieldCollection", out List<ActivityDTO> fieldCollection);

                _commonSteps.AddVariableToVariableList(variable);

                assignActivity.FieldsCollection.Add(new ActivityDTO(variable, value, 1, true));
            }
            _commonSteps.AddActivityToActivityList(parentName, assignName, assignActivity);
        }

        [Given(@"""(.*)"" contains an Assign for Json ""(.*)"" as")]
        [Then(@"""(.*)"" contains an Assign for Json ""(.*)"" as")]
        public void GivenContainsAnAssignForJsonAs(string parentName, string assignName, Table table)
        {
            var assignActivity = new DsfMultiAssignActivity { DisplayName = assignName };
            foreach (var tableRow in table.Rows)
            {
                var value = "{\"Name\":\"Bob\"}";
                var variable = tableRow["variable"];

                if (value.StartsWith("="))
                {
                    value = value.Replace("=", "");
                    value = $"!~calculation~!{value}!~~calculation~!";
                }

                _scenarioContext.TryGetValue("fieldCollection", out List<ActivityDTO> fieldCollection);

                _commonSteps.AddVariableToVariableList(variable);

                assignActivity.FieldsCollection.Add(new ActivityDTO(variable, value, 1, true));
            }
            _commonSteps.AddActivityToActivityList(parentName, assignName, assignActivity);
        }

        [Given(@"""(.*)"" contains a DsfRabbitMQPublish ""(.*)"" into ""(.*)""")]
        [Then(@"""(.*)"" contains a DsfRabbitMQPublish ""(.*)"" into ""(.*)""")]
        [When(@"""(.*)"" contains a DsfRabbitMQPublish ""(.*)"" into ""(.*)""")]
        public void GivenContainsADsfRabbitMQPublishInto(string parentName, string rabbitMqname, string result)
        {
            var jsonMsg = new Human().SerializeToJsonStringBuilder().ToString();
            var dsfPublishRabbitMqActivity = new DsfPublishRabbitMQActivity
            {
                RabbitMQSourceResourceId = ConfigurationManager.AppSettings["testRabbitMQSource"].ToGuid()
              ,
                Result = result
              ,
                DisplayName = rabbitMqname,
                Message = jsonMsg
            };
            _commonSteps.AddActivityToActivityList(parentName, rabbitMqname, dsfPublishRabbitMqActivity);
        }

        [Given(@"""(.*)"" contains a RabbitMQPublish ""(.*)"" into ""(.*)""")]
        [Then(@"""(.*)"" contains a RabbitMQPublish ""(.*)"" into ""(.*)""")]
        [When(@"""(.*)"" contains a RabbitMQPublish ""(.*)"" into ""(.*)""")]
        public void GivenContainsARabbitMQPublishInto(string parentName, string rabbitMqname, string result)
        {
            var jsonMsg = new Human().SerializeToJsonStringBuilder().ToString();
            var dsfPublishRabbitMqActivity = new PublishRabbitMQActivity
            {
                RabbitMQSourceResourceId = ConfigurationManager.AppSettings["testRabbitMQSource"].ToGuid()
              ,
                Result = result,
                DisplayName = rabbitMqname,
                Message = jsonMsg
            };
            _commonSteps.AddActivityToActivityList(parentName, rabbitMqname, dsfPublishRabbitMqActivity);
        }

        [Given(@"""(.*)"" contains an DotNet DLL ""(.*)"" as")]
        [Then(@"""(.*)"" contains an DotNet DLL ""(.*)"" as")]
        public void GivenContainsAnDotNetDLLAs(string parentName, string dotNetServiceName, Table table)
        {
            var dsfEnhancedDotNetDllActivity = new DsfEnhancedDotNetDllActivity()
            {
                IsObject = true,
                DisplayName = dotNetServiceName
            };
            var Source = table.Rows[0]["Source"];
            var ClassName = table.Rows[0]["ClassName"];
            var ObjectName = table.Rows[0]["ObjectName"];
            var Action = table.Rows[0]["Action"];
            var ActionOutputVaribale = table.Rows[0]["ActionOutputVaribale"];
            dsfEnhancedDotNetDllActivity.ObjectName = ObjectName;
            var proxy = new StudioServerProxy(new CommunicationControllerFactory(), LocalEnvModel.Connection);
            var pluginSource = proxy.QueryManagerProxy.FetchPluginSources().Single(source => source.Name.Equals(Source, StringComparison.InvariantCultureIgnoreCase));
            var namespaceItems = proxy.QueryManagerProxy.FetchNamespacesWithJsonRetunrs(pluginSource);
            var namespaceItem = namespaceItems.Single(item => item.FullName.Equals(ClassName, StringComparison.CurrentCultureIgnoreCase));
            var pluginActions = proxy.QueryManagerProxy.PluginActionsWithReturns(pluginSource, namespaceItem);
            allPluginActions = pluginActions.ToList();
            var pluginAction = pluginActions.Single(action => action.Method.Equals(Action, StringComparison.InvariantCultureIgnoreCase));
            var pluginConstructors = proxy.QueryManagerProxy.PluginConstructors(pluginSource, namespaceItem);
            const string recNumber = "[[rec(*).number]]";
            foreach (var serviceInput in pluginAction.Inputs)
            {
                serviceInput.Value = recNumber;
            }
            dsfEnhancedDotNetDllActivity.Namespace = namespaceItem;
            dsfEnhancedDotNetDllActivity.SourceId = pluginSource.Id;
            ScenarioContext.Current.Add(dotNetServiceName, dsfEnhancedDotNetDllActivity);
            ScenarioContext.Current.Add("pluginConstructors", pluginConstructors);
            _commonSteps.AddVariableToVariableList(ObjectName);
            _commonSteps.AddVariableToVariableList(ActionOutputVaribale);
            _commonSteps.AddVariableToVariableList(recNumber);
            _commonSteps.AddActivityToActivityList(parentName, dotNetServiceName, dsfEnhancedDotNetDllActivity);
        }

        [Given(@"""(.*)"" contains a DropboxUpload ""(.*)"" Setup as")]
        public void GivenContainsADropboxUploadSetupAs(string parentName, string dotNetServiceName, Table table)
        {
            var uploadActivity = new DsfDropBoxUploadActivity()
            {
                DisplayName = dotNetServiceName,

            };

            var dropBoxSource = GetDropBoxSource();
            uploadActivity.SelectedSource = dropBoxSource;
            var localFile = table.Rows[0]["Local File"];
            var localFileUniqueNameGuid = CommonSteps.GetGuid();
            localFile = CommonSteps.AddGuidToPath(localFile, localFileUniqueNameGuid);
            ScenarioContext.Current.Add("localFileUniqueNameGuid", localFileUniqueNameGuid);
            Console.WriteLine("Generated new local file path as " + localFileUniqueNameGuid + ".");
            var overwriteOrAdd = table.Rows[0]["OverwriteOrAdd"];
            var dropboxFile = table.Rows[0]["DropboxFile"];
            var serverPathToUniqueNameGuid = CommonSteps.GetGuid();
            dropboxFile = CommonSteps.AddGuidToPath(dropboxFile, serverPathToUniqueNameGuid);
            ScenarioContext.Current.Add("serverPathToUniqueNameGuid", serverPathToUniqueNameGuid);
            Console.WriteLine("Generated new server path for dropbox server path as " + serverPathToUniqueNameGuid + ".");
            var result = table.Rows[0]["Result"];
            uploadActivity.FromPath = localFile;
            uploadActivity.OverWriteMode = overwriteOrAdd.ToLower() == "Overwrite".ToLower();
            uploadActivity.ToPath = dropboxFile;

            File.Create(localFile).Close();
            _commonSteps.AddVariableToVariableList(result);
            _commonSteps.AddActivityToActivityList(parentName, dotNetServiceName, uploadActivity);
        }

        [Given(@"""(.*)"" contains a DropboxList ""(.*)"" Setup as")]
        public void GivenContainsADropboxListSetupAs(string parentName, string dotNetServiceName, Table table)
        {
            var listActivity = new DsfDropboxFileListActivity()
            {
                DisplayName = dotNetServiceName,
            };
            var dropBoxSource = GetDropBoxSource();
            listActivity.SelectedSource = dropBoxSource;
            var result = table.Rows[0]["Result"];
            var DropboxFile = table.Rows[0]["DropboxFile"];
            listActivity.ToPath = DropboxFile;
            var read = table.Rows[0]["Read"];
            var loadSubFolders = table.Rows[0]["LoadSubFolders"];
            switch (read)
            {
                case "Files":
                    listActivity.IsFilesSelected = true;
                    break;
                case "Folders":
                    listActivity.IsFoldersSelected = true;
                    break;
                case "All":
                    listActivity.IsFilesAndFoldersSelected = true;
                    break;
                default:
                    break;
            }
            var b = bool.Parse(loadSubFolders);
            listActivity.IsRecursive = b;
            _commonSteps.AddVariableToVariableList(result);
            _commonSteps.AddActivityToActivityList(parentName, dotNetServiceName, listActivity);
        }


        static DropBoxSource GetDropBoxSource()
        {
            var guid = "dc163197-7a76-4f4c-a783-69d6d53b2f3a".ToGuid();
            var resourceList = LocalEnvModel.ResourceRepository.LoadContextualResourceModel(guid);
            var serviceDefinition = resourceList.ToServiceDefinition();
            var dropBoxSource = new DropBoxSource(serviceDefinition.ToXElement());
            return dropBoxSource;
        }

        [Given(@"""(.*)"" contains a DropboxDownLoad ""(.*)"" Setup as")]
        public void GivenContainsADropboxDownLoadSetupAs(string parentName, string dotNetServiceName, Table table)
        {
            var downloadActivity = new DsfDropBoxDownloadActivity()
            {
                DisplayName = dotNetServiceName,

            };
            var dropBoxSource = GetDropBoxSource();
            downloadActivity.SelectedSource = dropBoxSource;
            downloadActivity.FromPath = table.Rows[0]["Local File"];
            var serverPathUniqueNameGuid = ScenarioContext.Current.Get<string>("serverPathToUniqueNameGuid");
            downloadActivity.ToPath = CommonSteps.AddGuidToPath(table.Rows[0]["DropboxFile"], serverPathUniqueNameGuid);
            var overwriteOrAdd = table.Rows[0]["OverwriteOrAdd"];
            downloadActivity.OverwriteFile = overwriteOrAdd.ToLower() == "Overwrite".ToLower();
            var result = table.Rows[0]["Result"];
            _commonSteps.AddVariableToVariableList(result);
            _commonSteps.AddActivityToActivityList(parentName, dotNetServiceName, downloadActivity);
        }

        [Given(@"""(.*)"" contains a DropboxDelete ""(.*)"" Setup as")]
        public void GivenContainsADropboxDeleteSetupAs(string parentName, string dotNetServiceName, Table table)
        {
            var deleteActivity = new DsfDropBoxDeleteActivity()
            {
                DisplayName = dotNetServiceName,

            };
            var dropBoxSource = GetDropBoxSource();
            deleteActivity.SelectedSource = dropBoxSource;
            var dropboxFile = table.Rows[0]["DropboxFile"];
            var serverPathUniqueNameGuid = ScenarioContext.Current.Get<string>("serverPathToUniqueNameGuid");
            dropboxFile = CommonSteps.AddGuidToPath(dropboxFile, serverPathUniqueNameGuid);
            deleteActivity.DeletePath = dropboxFile;
            var result = table.Rows[0]["Result"];
            _commonSteps.AddVariableToVariableList(result);
            _commonSteps.AddActivityToActivityList(parentName, dotNetServiceName, deleteActivity);
        }

        [Given(@"""(.*)"" contains an COM DLL ""(.*)"" as")]
        [Then(@"""(.*)"" contains an COM DLL ""(.*)"" as")]
        public void GivenContainsAnCOMDLLAs(string parentName, string dotNetServiceName, Table table)
        {
            var dsfEnhancedDotNetDllActivity = new DsfComDllActivity()
            {
                DisplayName = dotNetServiceName
            };
            var namespaceSelected = table.Rows[0]["Namespace"];
            var Action = table.Rows[0]["Action"];

            var controllerFactory = new CommunicationControllerFactory();
            var sourceId = "ed7c3655-4922-4f24-9881-83462661832d".ToGuid();
            var environmentConnection = LocalEnvModel.Connection;
            var mock = new Mock<IShellViewModel>();
            var proxy = new StudioServerProxy(controllerFactory, environmentConnection);
            var fetchComPluginSources = proxy.QueryManagerProxy.FetchComPluginSources();
            var pluginSource = fetchComPluginSources.Single(source => source.Id == sourceId);
            var dbServiceModel = new ManageComPluginServiceModel(new StudioResourceUpdateManager(controllerFactory, environmentConnection)
                                                                                   , proxy.QueryManagerProxy
                                                                                   , mock.Object
                                                                                   , new Server(Guid.NewGuid(), environmentConnection));
            var namespaceItems = dbServiceModel.GetNameSpaces(pluginSource);
            var namespaceItem = namespaceItems.Single(item => item?.FullName?.Equals(namespaceSelected, StringComparison.CurrentCultureIgnoreCase) ?? false);
            var pluginActions = dbServiceModel.GetActions(pluginSource, namespaceItem);
            allPluginActions = pluginActions.ToList();
            var pluginAction = pluginActions.First(action => action.Method.Equals(Action, StringComparison.InvariantCultureIgnoreCase));
            var comPluginServiceDefinition = new ComPluginServiceDefinition()
            {
                Action = pluginAction,
                Source = pluginSource,
            };
            var testResult = dbServiceModel.TestService(comPluginServiceDefinition);
            var serializer = new Dev2JsonSerializer();
            var responseService = serializer.Deserialize<RecordsetListWrapper>(testResult);
            if (responseService != null)
            {
                if (responseService.RecordsetList.Any(recordset => recordset.HasErrors))
                {
                    var errorMessage = string.Join(Environment.NewLine, responseService.RecordsetList.Select(recordset => recordset.ErrorMessage));
                    throw new Exception(errorMessage);
                }
                var _recordsetList = responseService.RecordsetList;
                if (_recordsetList.Any(recordset => recordset.HasErrors))
                {
                    var errorMessage = string.Join(Environment.NewLine, _recordsetList.Select(recordset => recordset.ErrorMessage));
                    throw new Exception(errorMessage);
                }
                dsfEnhancedDotNetDllActivity.OutputDescription = responseService.Description;

                var outputMapping = _recordsetList.SelectMany(recordset => recordset.Fields, (recordset, recordsetField) =>
                {
                    var serviceOutputMapping = new ServiceOutputMapping(recordsetField.Name, recordsetField.Alias, recordset.Name) { Path = recordsetField.Path };
                    return serviceOutputMapping;
                }).Cast<IServiceOutputMapping>().ToList();

                dsfEnhancedDotNetDllActivity.Outputs = outputMapping;
            }


            dsfEnhancedDotNetDllActivity.Method = pluginAction;
            dsfEnhancedDotNetDllActivity.Namespace = namespaceItem;
            dsfEnhancedDotNetDllActivity.SourceId = pluginSource.Id;

            _commonSteps.AddActivityToActivityList(parentName, dotNetServiceName, dsfEnhancedDotNetDllActivity);
        }

        List<IPluginAction> allPluginActions { get; set; }
        [Given(@"""(.*)"" constructorinputs (.*) with inputs as")]
        public void GivenConstructorWithInputsAs(string serviceName, int p1, Table table)
        {
            var dsfEnhancedDotNetDllActivity = ScenarioContext.Current.Get<DsfEnhancedDotNetDllActivity>(serviceName);
            var pluginConstructors = ScenarioContext.Current.Get<IList<IPluginConstructor>>("pluginConstructors");
            var pluginConstructor = pluginConstructors.FirstOrDefault(constructor => constructor.Inputs.Count == p1);
            dsfEnhancedDotNetDllActivity.Constructor = pluginConstructor;
            dsfEnhancedDotNetDllActivity.ConstructorInputs = new List<IServiceInput>();
            foreach (var tableRow in table.Rows)
            {
                var inputName = tableRow["parameterName"];
                var value = tableRow["value"];
                var type = tableRow["type"];
                dsfEnhancedDotNetDllActivity.ConstructorInputs.Add(new ServiceInput(inputName, value)
                {
                    TypeName = type
                });
            }
        }

        [Given(@"""(.*)"" service Action ""(.*)"" with inputs and output ""(.*)"" as")]
        public void GivenServiceActionWithInputsAndOutputAs(string serviceName, string action, string outputVar, Table table)
        {
            var dsfEnhancedDotNetDllActivity = ScenarioContext.Current.Get<DsfEnhancedDotNetDllActivity>(serviceName);
            var pluginAction = allPluginActions.Single(action1 => action1.Method == action);
            pluginAction.OutputVariable = outputVar;
            foreach (var tableRow in table.Rows)
            {
                var inputName = tableRow["parameterName"];
                var value = tableRow["value"];
                var serviceInput = pluginAction.Inputs.Single(input => input.Name == inputName);
                serviceInput.Value = value;
            }
            dsfEnhancedDotNetDllActivity.MethodsToRun.Add(pluginAction);
        }

        [Given(@"""(.*)"" contains an Assign Object ""(.*)"" as")]
        [Then(@"""(.*)"" contains an Assign Object ""(.*)"" as")]
        public void GivenContainsAnAssignObjectAs(string parentName, string assignName, Table table)
        {

            var assignActivity = new DsfMultiAssignObjectActivity { DisplayName = assignName };

            foreach (var tableRow in table.Rows)
            {
                var value = tableRow["value"];
                var variable = tableRow["variable"];

                value = value.Replace('"', ' ').Trim();

                if (value.StartsWith("="))
                {
                    value = value.Replace("=", "");
                    value = $"!~calculation~!{value}!~~calculation~!";
                }

                _scenarioContext.TryGetValue("fieldCollection", out List<ActivityDTO> fieldCollection);

                _commonSteps.AddVariableToVariableList(variable);

                assignActivity.FieldsCollection.Add(new AssignObjectDTO(variable, value, 1, true));
            }
            _commonSteps.AddActivityToActivityList(parentName, assignName, assignActivity);
        }

        [When(@"I rollback ""(.*)"" to version ""(.*)""")]
        public void WhenIRollbackToVersion(string workflowName, string version)
        {
            TryGetValue("SavedId", out Guid id);
            TryGetValue(workflowName, out IContextualResourceModel resourceModel);
            TryGetValue("environment", out IServer server);
            TryGetValue("resourceRepo", out IResourceRepository repository);
            var rep = new VersionManagerProxy(new CommunicationControllerFactory(), server.Connection);
            rep.RollbackTo(id, version);
        }

        [When(@"""(.*)"" is executed without saving")]
        public void WhenIsExecutedWithoutSaving(string workflowName)
        {
            TryGetValue(workflowName, out IContextualResourceModel resourceModel);
            TryGetValue("environment", out IServer server);
            TryGetValue("resourceRepo", out IResourceRepository repository);

            var debugStates = Get<List<IDebugState>>("debugStates").ToList();
            debugStates.Clear();

            ExecuteWorkflow(resourceModel);
        }

        [Then(@"I set logging to ""(.*)""")]
        public void ThenISetLoggingTo(string logLevel)
        {
            var allowedLogLevels = new[] { "DEBUG", "NONE" };
            // TODO: refactor null empty checking into extension method
            if (logLevel == null ||
                !allowedLogLevels.Contains(logLevel.ToUpper()))
            {
                return;
            }

            var loggingSettingsTo = new LoggingSettingsTo { FileLoggerLogLevel = logLevel, EventLogLoggerLogLevel = logLevel, FileLoggerLogSize = 200 };
            var controller = new CommunicationControllerFactory().CreateController("LoggingSettingsWriteService");
            var serializer = new Dev2JsonSerializer();
            controller.AddPayloadArgument("LoggingSettings", serializer.SerializeToBuilder(loggingSettingsTo).ToString());
            TryGetValue("environment", out IServer server);
            controller.ExecuteCommand<StringBuilder>(server.Connection, Guid.Empty);
        }

        [When(@"""(.*)"" is executed ""(.*)""")]
        public void WhenIsExecuted(string workflowName, string executionLabel)
        {
            var st = new Stopwatch();
            st.Start();
            WhenIsExecuted(workflowName);
            _scenarioContext.Add(executionLabel, st.ElapsedMilliseconds);
        }

        [Then(@"the delta between ""(.*)"" and ""(.*)"" is less than ""(.*)"" milliseconds")]
        public void ThenTheDeltaBetweenAndIsLessThanMilliseconds(string executionLabelFirst, string executionLabelSecond, int maxDeltaMilliseconds)
        {
            var e1 = Convert.ToInt32(_scenarioContext[executionLabelFirst]);
            var e2 = Convert.ToInt32(_scenarioContext[executionLabelSecond]);
            var d = maxDeltaMilliseconds;
            d.Should().BeGreaterThan(Math.Abs(e1 - e2), $"async logging should not add more than {d} milliseconds to the execution");
        }

        [Given(@"""(.*)"" contains an Unique ""(.*)"" as")]
        public void GivenContainsAnUniqueAs(string parentName, string activityName, Table table)
        {
            var activity = new DsfUniqueActivity { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var inFields = tableRow["In Field(s)"];
                var returnFields = tableRow["Return Fields"];
                var result = tableRow["Result"];


                _commonSteps.AddVariableToVariableList(result);

                activity.Result = result;
                activity.ResultFields = returnFields;
                activity.InFields = inFields;
            }
            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }

        [Given(@"""(.*)"" contains WebRequest ""(.*)"" as")]
        public void GivenContainsWebRequestAs(string parentName, string toolName, Table table)
        {
            var resultVariable = table.Rows[0]["Result"];
            var url = table.Rows[0]["Url"];

            if (url == "http://TFSBLD.premier.local:9810/api/values") {
                url = url.Replace("TFSBLD.premier.local", _containerOps.Container.IP).Replace("9810", _containerOps.Container.Port);
            }

            _commonSteps.AddVariableToVariableList(resultVariable);
            var dsfWebGetRequestActivity = new DsfWebGetRequestActivity
            {
                DisplayName = toolName
                ,
                Url = url
                ,
                Result = resultVariable
            };

            _commonSteps.AddActivityToActivityList(parentName, toolName, dsfWebGetRequestActivity);
        }

        [Given(@"""(.*)"" contains Advanced Recordset ""(.*)"" with Query ""(.*)""")]
        [When(@"""(.*)"" contains Advanced Recordset ""(.*)"" with Query ""(.*)""")]
        [Then(@"""(.*)"" contains Advanced Recordset ""(.*)"" with Query ""(.*)""")]
        public void GivenContainsAdvancedRecordsetWithQuery(string workflow, string toolname, string query, Table table)
        {
            var activity = new AdvancedRecordsetActivity
            {
                DisplayName = toolname,
                SqlQuery = query,
                Outputs = new List<IServiceOutputMapping>(),
                RecordsetName = "TableCopy",
            };
            foreach (var tableRow in table.Rows)
            {
                var output = tableRow["MappedTo"];
                var toVariable = tableRow["MappedFrom"];
                var recSetName = DataListUtil.ExtractRecordsetNameFromValue(toVariable);
                activity.Outputs.Add(new ServiceOutputMapping(output, toVariable, recSetName));
                _commonSteps.AddVariableToVariableList(toVariable);
            }
            _commonSteps.AddActivityToActivityList(workflow, toolname, activity);
        }


        [Given(@"""(.*)"" contains Calculate ""(.*)"" with formula ""(.*)"" into ""(.*)""")]
        public void GivenCalculateWithFormulaInto(string parentName, string activityName, string formula, string resultVariable)
        {
            _commonSteps.AddVariableToVariableList(resultVariable);

            var calculateActivity = new DsfCalculateActivity { Expression = formula, Result = resultVariable, DisplayName = activityName };

            _commonSteps.AddActivityToActivityList(parentName, activityName, calculateActivity);

        }
        [Given(@"""(.*)"" contains XPath \\""(.*)"" with source ""(.*)""")]
        public void GivenContainsXPathWithResultAs(string parentName, string xpathName, string source)
        {
            const string a = "<XPATH-EXAMPLE>  <CUSTOMER id=\"1\" type=\"B\">Mr.  Jones</CUSTOMER><CUSTOMER id=\"2\" type=\"C\">Mr.  Johnson</CUSTOMER></XPATH-EXAMPLE> ";
            var dsfXPathActivity = new DsfXPathActivity
            {

                SourceString = a
                ,
                DisplayName = xpathName
                ,
                ResultsCollection = new List<XPathDTO>
                {
                    new XPathDTO("[[singleValue]]", source, 1, true)
                }
            };
            _commonSteps.AddActivityToActivityList(parentName, xpathName, dsfXPathActivity);
        }

        [Given(@"""(.*)"" contains Aggregate Calculate ""(.*)"" with formula ""(.*)"" into ""(.*)""")]
        public void GivenAggregateCalculateWithFormulaInto(string parentName, string activityName, string formula, string resultVariable)
        {
            _commonSteps.AddVariableToVariableList(resultVariable);

            var calculateActivity = new DsfAggregateCalculateActivity { Expression = formula, Result = resultVariable, DisplayName = activityName };

            _commonSteps.AddActivityToActivityList(parentName, activityName, calculateActivity);

        }

        [Given(@"the workflow contains Count Record ""(.*)"" on ""(.*)"" into ""(.*)""")]
        public void GivenCountOnIntoTheWorkflow(string activityName, string recordSet, string result)
        {
            TryGetValue("parentWorkflowName", out string parentWorkflowName);
            GivenCountOnInto(parentWorkflowName, activityName, recordSet, result);
        }

        [Given(@"""(.*)"" contains Count Record ""(.*)"" on ""(.*)"" into ""(.*)""")]
        public void GivenCountOnInto(string parentName, string activityName, string recordSet, string result)
        {
            _commonSteps.AddVariableToVariableList(result);

            var countRecordsetNullHandlerActivity = new DsfCountRecordsetNullHandlerActivity { CountNumber = result, RecordsetName = recordSet, DisplayName = activityName };

            _commonSteps.AddActivityToActivityList(parentName, activityName, countRecordsetNullHandlerActivity);
        }

        [Given(@"""(.*)"" contains Delete ""(.*)"" as")]
        public void GivenItContainsDeleteAs(string parentName, string activityName, Table table)
        {
            var nullHandlerActivity = new DsfDeleteRecordActivity { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var result = tableRow["result"];
                var variable = tableRow["Variable"];

                _commonSteps.AddVariableToVariableList(result);
                nullHandlerActivity.RecordsetName = variable;
                nullHandlerActivity.Result = result;
            }

            _commonSteps.AddActivityToActivityList(parentName, activityName, nullHandlerActivity);
        }

        [Given(@"""(.*)"" contains NullHandlerDelete ""(.*)"" as")]
        public void GivenContainsNullHandlerDeleteAs(string parentName, string activityName, Table table)
        {
            var nullHandlerActivity = new DsfDeleteRecordNullHandlerActivity { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var result = tableRow["result"];
                var variable = tableRow["Variable"];

                _commonSteps.AddVariableToVariableList(result);
                nullHandlerActivity.RecordsetName = variable;
                nullHandlerActivity.Result = result;
            }

            _commonSteps.AddActivityToActivityList(parentName, activityName, nullHandlerActivity);
        }


        [Given(@"""(.*)"" contains Find Record Index ""(.*)"" search ""(.*)"" and result ""(.*)"" as")]
        public void GivenItContainsFindRecordIndexSearchAndResultAs(string parentName, string activityName, string recsetToSearch, string resultVariable, Table table)
        {
            var result = resultVariable;
            var recset = recsetToSearch;
            _commonSteps.AddVariableToVariableList(result);
            var activity = new DsfFindRecordsMultipleCriteriaActivity { RequireAllFieldsToMatch = false, RequireAllTrue = false, Result = result, FieldsToSearch = recset, DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var matchType = tableRow["Match Type"];
                var matchValue = tableRow["Match"];

                activity.ResultsCollection.Add(new FindRecordsTO(matchValue, matchType, 1, true));
            }

            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }

        [Given(@"""(.*)"" contains find unique ""(.*)"" as")]
        public void GivenItContainFindUniqueAs(string parentName, string activityName, Table table)
        {
            var activity = new DsfUniqueActivity { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var inFields = tableRow["In Fields"];
                var returnFields = tableRow["Return Fields"];
                var result = tableRow["Result"];

                activity.InFields = inFields;
                activity.ResultFields = returnFields;
                activity.Result = result;

                _commonSteps.AddVariableToVariableList(result);
            }
            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }

        [Given(@"""(.*)"" contains case convert ""(.*)"" as")]
        public void GivenItContainsCaseConvertAs(string parentName, string activityName, Table table)
        {
            var activity = new DsfCaseConvertActivity { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var variableToConvert = tableRow["Variable"];
                var conversionType = tableRow["Type"];

                activity.ConvertCollection.Add(new CaseConvertTO(variableToConvert, conversionType, variableToConvert, 1, true));
            }

            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }

        [Given(@"""(.*)"" contains Gather System Info ""(.*)"" as")]
        public void GivenItContainsGatherSystemInfoAs(string parentName, string activityName, Table table)
        {
            var activity = new DsfGatherSystemInformationActivity { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var variable = tableRow["Variable"];

                _commonSteps.AddVariableToVariableList(variable);

                var systemInfo = (enTypeOfSystemInformationToGather)Dev2EnumConverter.GetEnumFromStringDiscription(tableRow["Selected"], typeof(enTypeOfSystemInformationToGather));
                activity.SystemInformationCollection.Add(new GatherSystemInformationTO(systemInfo, variable, 1));
            }

            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }

        [Given(@"""(.*)"" contains Random ""(.*)"" as")]
        public void GivenItContainsRandomAs(string parentName, string activityName, Table table)
        {
            var activity = new DsfRandomActivity { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var type = (enRandomType)Enum.Parse(typeof(enRandomType), tableRow["Type"]);
                var from = tableRow["From"];
                var to = tableRow["To"];
                var result = tableRow["Result"];

                _commonSteps.AddVariableToVariableList(result);

                activity.RandomType = type;
                activity.To = to;
                activity.From = from;
                activity.Result = result;

            }

            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }

        [Given(@"""(.*)"" contains Format Number ""(.*)"" as")]
        public void GivenItContainsFormatNumberAs(string parentName, string activityName, Table table)
        {
            var activity = new DsfNumberFormatActivity { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var number = tableRow["Number"];
                var roundTo = tableRow["Rounding To"];
                var roundingType = tableRow["Rounding Selected"];
                var decimalPlacesToShow = tableRow["Decimal to show"];
                var result = tableRow["Result"];

                _commonSteps.AddVariableToVariableList(result);

                activity.Expression = number;
                activity.RoundingType = roundingType;
                activity.RoundingDecimalPlaces = roundTo;
                activity.DecimalPlacesToShow = decimalPlacesToShow;
                activity.Result = result;

            }

            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }


        [Given(@"""(.*)"" contains Date and Time ""(.*)"" as")]
        public void GivenItContainsDateAndTimeAs(string parentName, string activityName, Table table)
        {
            var activity = new DsfDateTimeActivity { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var input1 = tableRow["Input"];
                var outputFormat = tableRow["Output Format"];
                var inputFormat = tableRow["Input Format"];
                var timeModifierAmount = tableRow["Add Time"];
                var result = tableRow["Result"];

                _commonSteps.AddVariableToVariableList(result);

                activity.DateTime = input1;
                activity.InputFormat = inputFormat;
                activity.OutputFormat = outputFormat;
                activity.TimeModifierAmountDisplay = timeModifierAmount;
                activity.TimeModifierType = "Years";
                activity.Result = result;

            }

            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }


        [Given(@"""(.*)"" contains Date and Time Difference ""(.*)"" as")]
        public void GivenItContainsDateAndTimeDifferenceAs(string parentName, string activityName, Table table)
        {
            var activity = new DsfDateTimeDifferenceActivity { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var input1 = tableRow["Input1"];
                var input2 = tableRow["Input2"];
                var inputFormat = tableRow["Input Format"];
                var output = tableRow["Output In"];
                var result = tableRow["Result"];

                _commonSteps.AddVariableToVariableList(result);

                activity.Input1 = input1;
                activity.Input2 = input2;
                activity.InputFormat = inputFormat;
                activity.OutputType = output;
                activity.Result = result;

            }

            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }


        [Given(@"""(.*)"" contains Data Split ""(.*)"" as")]
        public void GivenItContainsDataSplitAs(string parentName, string activityName, Table table)
        {
            var activity = new DsfDataSplitActivity { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var valueToSplit = string.IsNullOrEmpty(tableRow["String"]) ? "" : tableRow["String"];
                var variable = tableRow["Variable"];
                var type = tableRow["Type"];
                var at = tableRow["At"];
                var include = tableRow["Include"] == "Selected";
                _commonSteps.AddVariableToVariableList(variable);
                if (!string.IsNullOrEmpty(valueToSplit))
                {
                    activity.SourceString = valueToSplit;
                }
                _commonSteps.AddVariableToVariableList(variable);
                activity.ResultsCollection.Add(new DataSplitDTO(variable, type, at, 1, include, true));
            }

            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }

        [Given(@"""(.*)"" contains Replace ""(.*)"" into ""(.*)"" as")]
        public void GivenItContainsReplaceIntoAs(string parentName, string activityName, string resultVariable, Table table)
        {
            var activity = new DsfReplaceActivity { Result = resultVariable, DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var variable = tableRow["In Fields"];
                var find = tableRow["Find"];
                var replaceValue = tableRow["Replace With"];

                activity.FieldsToSearch = variable;
                activity.Find = find;
                activity.ReplaceWith = replaceValue;
            }
            _commonSteps.AddVariableToVariableList(resultVariable);
            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }


        [Given(@"""(.*)"" contains Find Index ""(.*)"" into ""(.*)"" as")]
        public void GivenItContainsFindIndexIntoAs(string parentName, string activityName, string resultVariable, Table table)
        {
            var activity = new DsfIndexActivity { Result = resultVariable, DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var variable = tableRow["In Fields"];
                var index = tableRow["Index"];
                var character = tableRow["Character"];
                var direction = tableRow["Direction"];

                activity.InField = variable;
                activity.Index = index;
                activity.Characters = character;
                activity.Direction = direction;
            }
            _commonSteps.AddVariableToVariableList(resultVariable);
            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }

        [Given(@"""(.*)"" contains an Create ""(.*)"" as")]
        public void GivenContainsAnCreateAs(string parentName, string activityName, Table table)
        {
            var activity = new DsfPathCreate { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var variable = tableRow["File or Folder"];
                var exist = tableRow["If it exits"];
                var userName = tableRow["Username"];
                var password = tableRow["Password"];
                var result = tableRow["Result"];

                activity.Result = result;
                activity.Username = userName;
                activity.Password = password;
                activity.Overwrite = exist == "True";
                activity.OutputPath = variable;

                _commonSteps.AddVariableToVariableList(result);
            }
            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }

        [Given(@"""(.*)"" contains an Rename ""(.*)"" as")]
        public void GivenContainsAnWriteRenameAs(string parentName, string activityName, Table table)
        {
            var activity = new DsfPathRename { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var variable = tableRow["File or Folder"];
                var destination = tableRow["Destination"];
                var exist = tableRow["If it exits"];
                var userName = tableRow["Username"];
                var password = tableRow["Password"];
                var result = tableRow["Result"];

                activity.Result = result;
                activity.Username = userName;
                activity.Password = password;
                activity.Overwrite = exist == "True";
                activity.OutputPath = destination;
                activity.InputPath = variable;

                _commonSteps.AddVariableToVariableList(result);
            }
            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }

        [Given(@"""(.*)"" contains an Zip ""(.*)"" as")]
        public void GivenContainsAnZipAs(string parentName, string activityName, Table table)
        {
            var activity = new DsfZip { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var variable = tableRow["File or Folder"];
                var destination = tableRow["Destination"];
                var exist = tableRow["If it exits"];
                var userName = tableRow["Username"];
                var password = tableRow["Password"];
                var result = tableRow["Result"];

                activity.Result = result;
                activity.Username = userName;
                activity.Password = password;
                activity.Overwrite = exist == "True";
                activity.OutputPath = destination;
                activity.InputPath = variable;

                _commonSteps.AddVariableToVariableList(result);
            }
            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }

        [Given(@"""(.*)"" contains an UnZip ""(.*)"" as")]
        public void GivenContainsAnUnZipAs(string parentName, string activityName, Table table)
        {
            var activity = new DsfUnZip { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var variable = tableRow["File or Folder"];
                var destination = tableRow["Destination"];
                var exist = tableRow["If it exits"];
                var userName = tableRow["Username"];
                var password = tableRow["Password"];
                var result = tableRow["Result"];

                activity.Result = result;
                activity.Username = userName;
                activity.Password = password;
                activity.Overwrite = exist == "True";
                activity.OutputPath = destination;
                activity.InputPath = variable;

                _commonSteps.AddVariableToVariableList(result);
            }
            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }




        [Given(@"""(.*)"" contains an Move ""(.*)"" as")]
        public void GivenContainsAnMoveAs(string parentName, string activityName, Table table)
        {
            var activity = new DsfPathMove { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var source = tableRow["File or Folder"];
                var exist = tableRow["If it exits"];
                var userName = tableRow["Username"];
                var password = tableRow["Password"];
                var result = tableRow["Result"];
                var desc = tableRow["Destination"];

                activity.Result = result;
                activity.Username = userName;
                activity.Password = password;
                activity.Overwrite = exist == "True";
                activity.OutputPath = desc;
                activity.InputPath = source;



                _commonSteps.AddVariableToVariableList(result);
            }
            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }

        [Given(@"""(.*)"" contains an Read Folder ""(.*)"" as")]
        public void GivenContainsAnReadFolderAs(string parentName, string activityName, Table table)
        {
            var activity = new DsfFolderRead { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var source = tableRow["File or Folder"];
                var userName = tableRow["Username"];
                var password = tableRow["Password"];
                var result = tableRow["Result"];
                var isFoldersSelected = tableRow["Folders"];

                activity.Result = result;
                activity.Username = userName;
                activity.Password = password;
                activity.InputPath = source;
                activity.IsFoldersSelected = isFoldersSelected == "True";
                _commonSteps.AddVariableToVariableList(result);
            }
            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }

        [Given(@"I create temp file as ""(.*)""")]
        public void GivenICreateTempFileAs(string fileName)
        {
            using (var sw = File.Create(fileName))
            {
                Assert.IsNotNull(sw);
            }
        }


        [Given(@"I create temp file to read from as ""(.*)""")]
        public void GivenICreateTempFileToReadFromAs(string path)
        {
            using (var sw = File.CreateText(path))
            {
                sw.WriteLine("Hello");
            }
        }

        [Given(@"""(.*)"" contains RabbitMQPublish ""(.*)"" into ""(.*)""")]
        public void GivenContainsRabbitMQPublishInto(string parentName, string activityName, string variable)
        {
            var dsfPublishRabbitMqActivity = new PublishRabbitMQActivity
            {
                RabbitMQSourceResourceId = ConfigurationManager.AppSettings["testRabbitMQSource"].ToGuid(),
                Result = variable,
                DisplayName = activityName
            };
            _commonSteps.AddActivityToActivityList(parentName, activityName, dsfPublishRabbitMqActivity);
        }

        [Given(@"""(.*)"" contains DsfRabbitMQPublish and Queue1 ""(.*)"" into ""(.*)""")]
        public void GivenContainsDsfRabbitandQueue1MQPublishInto(string parentName, string activityName, string variable)
        {
            var dsfPublishRabbitMqActivity = new DsfPublishRabbitMQActivity
            {
                RabbitMQSourceResourceId = ConfigurationManager.AppSettings["testRabbitMQSource"].ToGuid()
                ,
                Result = variable
                ,
                DisplayName = activityName,
                QueueName = "Queue1",
                Message = "msg"
            };
            _commonSteps.AddActivityToActivityList(parentName, activityName, dsfPublishRabbitMqActivity);
        }
        [Given(@"""(.*)"" contains RabbitMQPublish and Queue1 - CorrelationID ""(.*)"" into ""(.*)""")]
        public void GivenContainsRabbitandQueue1MQPublishInto(string parentName, string activityName, string variable)
        {
            var dsfPublishRabbitMqActivity = new PublishRabbitMQActivity
            {
                RabbitMQSourceResourceId = ConfigurationManager.AppSettings["testRabbitMQSource"].ToGuid(),
                Result = variable,
                DisplayName = activityName,
                QueueName = "Queue1",
                Message = "msg"
            };
           // dsfPublishRabbitMqActivity.BasicProperties.CorrelationID = "CorrelationID";
            _commonSteps.AddActivityToActivityList(parentName, activityName, dsfPublishRabbitMqActivity);
        }

        [Given(@"""(.*)"" contains RabbitMQConsume ""(.*)"" into ""(.*)""")]
        public void GivenContainsRabbitMQConsumeInto(string parentName, string activityName, string variable)
        {
            _containerOps = new Depends(Depends.ContainerType.RabbitMQ, true);
            var dsfConsumeRabbitMqActivity = new DsfConsumeRabbitMQActivity
            {
                RabbitMQSourceResourceId = ConfigurationManager.AppSettings["testRabbitMQSource"].ToGuid()

                ,
                Response = variable
                ,
                DisplayName = activityName
            };

            ScenarioContext.Current.Add("RabbitMqTool", dsfConsumeRabbitMqActivity);
            _commonSteps.AddActivityToActivityList(parentName, activityName, dsfConsumeRabbitMqActivity);
        }

        [Given(@"""(.*)"" is object is set to ""(.*)""")]
        public void GivenIsObjectIsSetTo(string toolName, string isObjectString)
        {
            var isObject = bool.Parse(isObjectString);
            var dsfConsumeRabbitMqActivity = ScenarioContext.Current.Get<DsfConsumeRabbitMQActivity>("RabbitMqTool");
            dsfConsumeRabbitMqActivity.IsObject = isObject;
        }

        [Given(@"""(.*)"" objectname as ""(.*)""")]
        public void GivenObjectnameAs(string toolName, string Objectname)
        {
            var dsfConsumeRabbitMqActivity = ScenarioContext.Current.Get<DsfConsumeRabbitMQActivity>("RabbitMqTool");
            dsfConsumeRabbitMqActivity.ObjectName = Objectname;
        }

        [Given(@"Queue Name as ""(.*)""")]
        public void GivenQueueNameAs(string queueName)
        {
            var dsfConsumeRabbitMqActivity = ScenarioContext.Current.Get<DsfConsumeRabbitMQActivity>("RabbitMqTool");
            dsfConsumeRabbitMqActivity.QueueName = queueName;
        }


        [Given(@"""(.*)"" contains RabbitMQConsume ""(.*)"" with timeout (.*) seconds into ""(.*)""")]
        public void GivenContainsRabbitMQConsumeWithTimeoutSecondsInto(string parentName, string activityName, int timeout, string variable)
        {
            _containerOps = new Depends(Depends.ContainerType.RabbitMQ, true);
            var dsfConsumeRabbitMqActivity = new DsfConsumeRabbitMQActivity
            {
                RabbitMQSourceResourceId = ConfigurationManager.AppSettings["testRabbitMQSource"].ToGuid()
                ,
                Response = variable
                ,
                DisplayName = activityName,
                TimeOut = timeout == -1 ? "" : timeout.ToString(),
                QueueName = "Queue1",
            };
            _commonSteps.AddActivityToActivityList(parentName, activityName, dsfConsumeRabbitMqActivity);
        }


        [Given(@"""(.*)"" contains RabbitMQConsume ""(.*)"" and Queue Name '(.*)' into ""(.*)""")]
        public void GivenContainsRabbitMQConsumeAndQueueNameInto(string parentName, string activityName, string queueName, string resultVariable)
        {
            var dsfConsumeRabbitMqActivity = new DsfConsumeRabbitMQActivity
            {
                RabbitMQSourceResourceId = ConfigurationManager.AppSettings["testRabbitMQSource"].ToGuid(),
                Response = resultVariable,
                QueueName = queueName,
                DisplayName = activityName
            };
            _commonSteps.AddActivityToActivityList(parentName, activityName, dsfConsumeRabbitMqActivity);
        }

        [Given(@"""(.*)"" contains an Read File ""(.*)"" as")]
        public void GivenContainsAnReadFileAs(string parentName, string activityName, Table table)
        {

            var activity = new DsfFileRead { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var source = tableRow["File or Folder"];
                var userName = tableRow["Username"];
                var password = tableRow["Password"];
                var result = tableRow["Result"];

                activity.Result = result;
                activity.Username = userName;
                activity.Password = password;
                activity.InputPath = source;
                _commonSteps.AddVariableToVariableList(result);
            }
            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }

        [Given(@"""(.*)"" contains an Write File ""(.*)"" as")]
        public void GivenContainsAnWriteFileAs(string parentName, string activityName, Table table)
        {
            var activity = new DsfFileWrite { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var source = tableRow["File or Folder"];
                var userName = tableRow["Username"];
                var password = tableRow["Password"];
                var result = tableRow["Result"];
                var overWrite = tableRow["If it exits"];

                activity.Result = result;
                activity.Username = userName;
                activity.Password = password;
                activity.OutputPath = source;
                activity.Overwrite = overWrite == "True";
                _commonSteps.AddVariableToVariableList(result);
            }
            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }




        [Given(@"""(.*)"" contains an Delete Folder ""(.*)"" as")]
        public void GivenContainsAnDeleteFolderAs(string parentName, string activityName, Table table)
        {
            var activity = new DsfPathDelete { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var variable = tableRow["Recordset"];
                var result = tableRow["Result"];

                activity.Result = result;
                activity.InputPath = variable;

                _commonSteps.AddVariableToVariableList(result);
            }
            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }

        [Given(@"""(.*)"" contains Data Merge ""(.*)"" into ""(.*)"" as")]
        public void GivenItContainsDataMergeAs(string parentName, string activityName, string resultVariable, Table table)
        {
            var activity = new DsfDataMergeActivity { Result = resultVariable, DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var variable = tableRow["Variable"];
                var type = tableRow["Type"];
                var at = tableRow["Using"];
                var padding = tableRow["Padding"];
                var alignment = tableRow["Alignment"];

                activity.MergeCollection.Add(new DataMergeDTO(variable, type, at, 1, padding, alignment, true));
            }
            _commonSteps.AddVariableToVariableList(resultVariable);
            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }

        [Given(@"""(.*)"" contains Base convert ""(.*)"" as")]
        public void GivenItContainsBaseConvertAs(string parentName, string activityName, Table table)
        {
            var activity = new DsfBaseConvertActivity { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var variableToConvert = tableRow["Variable"];
                var from = tableRow["From"];
                var to = tableRow["To"];

                activity.ConvertCollection.Add(new BaseConvertTO(variableToConvert, from, to, variableToConvert, 1, true));
            }

            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }

        [Given(@"""(.*)"" contains a postgre tool using ""(.*)"" with mappings for testing as")]
        public void GivenContainsAPostgreToolUsingWithMappingsForTestingAs(string parentName, string serviceName, Table table)
        {
            var inputs = GetServiceInputs(table);
            //Load Source based on the name
            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();
            var environmentConnection = environmentModel.Connection;
            var controllerFactory = new CommunicationControllerFactory();
            var _proxyLayer = new StudioServerProxy(controllerFactory, environmentConnection);
            var mock = new Mock<IShellViewModel>();
            var dbServiceModel = new ManageDbServiceModel(new StudioResourceUpdateManager(controllerFactory, environmentConnection)
                                                                                    , _proxyLayer.QueryManagerProxy
                                                                                    , mock.Object
                                                                                    , environmentModel);
            var dbSources = _proxyLayer.QueryManagerProxy.FetchDbSources().ToList();
            var dbSource = dbSources.Single(source => source.Id == "f8b1a579-2394-489e-835e-21b42e304e09".ToGuid());

            var databaseService = new DatabaseService
            {
                Source = dbSource,
                Inputs = inputs,
                Action = new DbAction()
                {
                    Name = serviceName,
                    SourceId = dbSource.Id,
                    Inputs = inputs,
                    ExecuteAction = serviceName
                },
                Name = "tab_val_func"
                ,
                Id = dbSource.Id

            };
            var testResults = dbServiceModel.TestService(databaseService);

            var mappings = new List<IServiceOutputMapping>();

            if (testResults?.Columns.Count > 1)
            {
                var recordsetName = string.IsNullOrEmpty(testResults.TableName) ? serviceName.Replace(".", "_") : testResults.TableName;
                for (int i = 0; i < testResults.Columns.Count; i++)
                {
                    var column = testResults.Columns[i];
                    var dbOutputMapping = new ServiceOutputMapping(column.ToString(), column.ToString().Replace(" ", ""), recordsetName);
                    mappings.Add(dbOutputMapping);
                }
            }



            var postGreActivity = new DsfPostgreSqlActivity
            {
                ProcedureName = serviceName,
                DisplayName = serviceName,
                SourceId = dbSource.Id,
                Outputs = new List<IServiceOutputMapping>(),
                Inputs = new List<IServiceInput>()
            };

            postGreActivity.Inputs = new List<IServiceInput>()
            {
                new ServiceInput("Prefix","K"),
            };
            postGreActivity.Outputs = mappings;
            _commonSteps.AddVariableToVariableList("[[V1]]");
            _commonSteps.AddActivityToActivityList(parentName, serviceName, postGreActivity);
        }


        [Given(@"""(.*)"" contains a postgre tool using ""(.*)"" with mappings as")]
        public void GivenContainsAPostgreToolUsingWithMappingsAs(string parentName, string serviceName, Table table)
        {

            var resourceId = "62652f31-813a-4b97-b488-02e4c16150ff".ToGuid();

            var postGreActivity = new DsfPostgreSqlActivity
            {
                ProcedureName = serviceName,
                DisplayName = serviceName,
                SourceId = resourceId,
                Outputs = new List<IServiceOutputMapping>(),
                Inputs = new List<IServiceInput>()
            };
            foreach (var tableRow in table.Rows)
            {
                var output = tableRow["Output from Service"];
                var toVariable = tableRow["To Variable"];
                var recSetName = DataListUtil.ExtractRecordsetNameFromValue(toVariable);
                postGreActivity.Outputs.Add(new ServiceOutputMapping(output, toVariable, recSetName));
                _commonSteps.AddVariableToVariableList(toVariable);

                var input = tableRow["Input to Service"];
                var fromVariable = tableRow["From Variable"];
                if (!string.IsNullOrEmpty(input))
                {
                    postGreActivity.Inputs.Add(new ServiceInput(input, fromVariable));
                    _commonSteps.AddVariableToVariableList(fromVariable);
                }
            }
            _commonSteps.AddActivityToActivityList(parentName, serviceName, postGreActivity);
        }

        [Given(@"""(.*)"" contains a mysql database service ""(.*)"" with mappings for testing as")]
        public void GivenContainsAMysqlDatabaseServiceWithMappingsfortesting(string parentName, string serviceName, Table table)
        {
            //Load Source based on the name
            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();
            _containerOps = new Depends(Depends.ContainerType.MySQL, true);
            var environmentConnection = environmentModel.Connection;
            var controllerFactory = new CommunicationControllerFactory();
            var _proxyLayer = new StudioServerProxy(controllerFactory, environmentConnection);
            var mock = new Mock<IShellViewModel>();
            var dbServiceModel = new ManageDbServiceModel(new StudioResourceUpdateManager(controllerFactory, environmentConnection)
                                                                                    , _proxyLayer.QueryManagerProxy
                                                                                    , mock.Object
                                                                                    , environmentModel);
            var dbSources = _proxyLayer.QueryManagerProxy.FetchDbSources().ToList();
            var dbSource = dbSources.Single(source => source.Id == "97d6272e-15a1-483f-afdb-a076f602604f".ToGuid());

            var databaseService = new DatabaseService
            {
                Source = dbSource,
                Inputs = new List<IServiceInput>(),
                Action = new DbAction()
                {
                    Name = serviceName,
                    SourceId = dbSource.Id,
                    Inputs = new List<IServiceInput>(),
                    ExecuteAction = serviceName
                },
                Name = serviceName,
                Id = dbSource.Id,

            };
            var testResults = dbServiceModel.TestService(databaseService);



            var mySqlDatabaseActivity = new DsfMySqlDatabaseActivity()
            {
                ProcedureName = serviceName,
                DisplayName = serviceName,
                SourceId = dbSource.Id,
                Outputs = new List<IServiceOutputMapping>(),
                Inputs = databaseService.Inputs
            };

            var mappings = new List<IServiceOutputMapping>();

            if (testResults?.Columns.Count > 1)
            {
                var recordsetName = string.IsNullOrEmpty(testResults.TableName) ? serviceName.Replace(".", "_") : testResults.TableName;
                for (int i = 0; i < testResults.Columns.Count; i++)
                {
                    var column = testResults.Columns[i];
                    var dbOutputMapping = new ServiceOutputMapping(column.ToString(), column.ToString().Replace(" ", ""), recordsetName);
                    mappings.Add(dbOutputMapping);
                }
            }
            mySqlDatabaseActivity.Outputs = mappings;
            mySqlDatabaseActivity.ProcedureName = serviceName;

            _commonSteps.AddVariableToVariableList("[[MySqlEmail(1).name]]");
            _commonSteps.AddVariableToVariableList("[[MySqlEmail(1).email]]");
            _commonSteps.AddActivityToActivityList(parentName, serviceName, mySqlDatabaseActivity);
        }

        [Given(@"""(.*)"" contains a mysql database service ""(.*)""")]
        public void GivenContainsAMysqlDatabaseService(string parentName, string serviceName)
        {
            var mySqlDatabaseActivity = new DsfMySqlDatabaseActivity
            {
                ProcedureName = serviceName,
                DisplayName = serviceName,
                Outputs = new List<IServiceOutputMapping>(),
                Inputs = new List<IServiceInput>(),
                IsEndedOnError = true
            };
            _commonSteps.AddActivityToActivityList(parentName, serviceName, mySqlDatabaseActivity);
        }

        [Given(@"""(.*)"" contains a mysql database service ""(.*)"" with mappings as")]
        public void GivenContainsAMysqlDatabaseServiceWithMappings(string parentName, string serviceName, Table table)
        {

            var mySqlResourceId = "97d6272e-15a1-483f-afdb-a076f602604f".ToGuid();
            var mySqlDatabaseActivity = new DsfMySqlDatabaseActivity
            {
                ProcedureName = serviceName,
                DisplayName = serviceName,
                SourceId = mySqlResourceId,
                Outputs = new List<IServiceOutputMapping>(),
                Inputs = new List<IServiceInput>()
            };
            foreach (var tableRow in table.Rows)
            {
                var output = tableRow["Output from Service"];
                var toVariable = tableRow["To Variable"];
                var recSetName = DataListUtil.ExtractRecordsetNameFromValue(toVariable);
                mySqlDatabaseActivity.Outputs.Add(new ServiceOutputMapping(output, toVariable, recSetName));
                _commonSteps.AddVariableToVariableList(toVariable);

                var input = tableRow["Input to Service"];
                var fromVariable = tableRow["From Variable"];
                if (!string.IsNullOrEmpty(input))
                {
                    mySqlDatabaseActivity.Inputs.Add(new ServiceInput(input, fromVariable));
                    _commonSteps.AddVariableToVariableList(fromVariable);
                }
            }
            _commonSteps.AddActivityToActivityList(parentName, serviceName, mySqlDatabaseActivity);
        }

        [Given(@"""(.*)"" contains a oracle database service ""(.*)"" with mappings as")]
        public void GivenContainsAOracleDatabaseServiceWithMappingsAs(string parentName, string serviceName, Table table)
        {
            var inputs = GetServiceInputs(table);
            //Load Source based on the name
            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();
            var environmentConnection = environmentModel.Connection;
            var controllerFactory = new CommunicationControllerFactory();
            var _proxyLayer = new StudioServerProxy(controllerFactory, environmentConnection);
            var mock = new Mock<IShellViewModel>();
            var dbServiceModel = new ManageDbServiceModel(new StudioResourceUpdateManager(controllerFactory, environmentConnection)
                                                                                    , _proxyLayer.QueryManagerProxy
                                                                                    , mock.Object
                                                                                    , environmentModel);
            var dbSources = _proxyLayer.QueryManagerProxy.FetchDbSources().ToList();
            var dbSource = dbSources.Single(source => source.Id == "b1c12282-1712-419c-9929-5dfe42c90210".ToGuid());

            var databaseService = new DatabaseService
            {
                Source = dbSource,
                Inputs = inputs,
                Action = new DbAction()
                {
                    Name = serviceName,
                    SourceId = dbSource.Id,
                    Inputs = inputs,
                    ExecuteAction = serviceName
                },
                Name = serviceName,
                Id = dbSource.Id,

            };
            var testResults = dbServiceModel.TestService(databaseService);



            var mySqlDatabaseActivity = new DsfSqlServerDatabaseActivity
            {
                ProcedureName = serviceName,
                DisplayName = serviceName,
                SourceId = dbSource.Id,
                Outputs = new List<IServiceOutputMapping>(),
                Inputs = databaseService.Inputs
            };

            var mappings = new List<IServiceOutputMapping>();

            if (testResults?.Columns.Count > 1)
            {
                var recordsetName = string.IsNullOrEmpty(testResults.TableName) ? serviceName.Replace(".", "_") : testResults.TableName;
                for (int i = 0; i < testResults.Columns.Count; i++)
                {
                    var column = testResults.Columns[i];
                    var dbOutputMapping = new ServiceOutputMapping(column.ToString(), column.ToString().Replace(" ", ""), recordsetName);
                    mappings.Add(dbOutputMapping);
                }
            }
            mySqlDatabaseActivity.Outputs = mappings;
            mySqlDatabaseActivity.ProcedureName = serviceName;

            _commonSteps.AddVariableToVariableList("[[HR_GET_EMP_RS(107).MANAGER_ID]]");
            _commonSteps.AddVariableToVariableList("[[HR_GET_EMP_RS(107).DEPARTMENT_ID]]");
            _commonSteps.AddVariableToVariableList("[[HR_GET_EMP_RS(107).EMPLOYEE_ID]]");
            _commonSteps.AddVariableToVariableList("[[HR_GET_EMP_RS(107).FIRST_NAME]]");
            _commonSteps.AddVariableToVariableList("[[HR_GET_EMP_RS(107).LAST_NAME]]");
            _commonSteps.AddVariableToVariableList("[[HR_GET_EMP_RS(107).EMAIL]]");
            _commonSteps.AddVariableToVariableList("[[HR_GET_EMP_RS(107).PHONE_NUMBER]]");
            _commonSteps.AddVariableToVariableList("[[HR_GET_EMP_RS(107).HIRE_DATE]]");
            _commonSteps.AddVariableToVariableList("[[HR_GET_EMP_RS(107).JOB_ID]]");
            _commonSteps.AddVariableToVariableList("[[HR_GET_EMP_RS(107).SALARY]]");
            _commonSteps.AddVariableToVariableList("[[HR_GET_EMP_RS(107).COMMISSION_PCT]]");
            _commonSteps.AddVariableToVariableList("[[HR_GET_EMP_RS(107).MANAGER_ID]]");
            _commonSteps.AddVariableToVariableList("[[HR_GET_EMP_RS(107).DEPARTMENT_ID]]");
            _commonSteps.AddActivityToActivityList(parentName, serviceName, mySqlDatabaseActivity);
        }


        [Given(@"""(.*)"" contains a sqlserver database service ""(.*)"" with mappings for testing as")]
        public void GivenContainsASqlServerDatabaseServiceWithMappingsForTesting(string parentName, string serviceName, Table table)
        {
            _containerOps = new Depends(Depends.ContainerType.MSSQL, true);
            var inputs = GetServiceInputs(table);
            var resourceId = "b9184f70-64ea-4dc5-b23b-02fcd5f91082".ToGuid();
            //Load Source based on the name
            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();
            var environmentConnection = environmentModel.Connection;
            var controllerFactory = new CommunicationControllerFactory();
            var _proxyLayer = new StudioServerProxy(controllerFactory, environmentConnection);
            var mock = new Mock<IShellViewModel>();
            var dbServiceModel = new ManageDbServiceModel(new StudioResourceUpdateManager(controllerFactory, environmentConnection)
                                                                                    , _proxyLayer.QueryManagerProxy
                                                                                    , mock.Object
                                                                                    , environmentModel);
            var dbSources = _proxyLayer.QueryManagerProxy.FetchDbSources().ToList();
            var dbSource = dbSources.Single(source => source.Id == resourceId);
            dbSource.ServerName += "," + _containerOps.Container.Port;
            var databaseService = new DatabaseService
            {
                Source = dbSource,
                Inputs = inputs,
                Action = new DbAction()
                {
                    Name = serviceName,
                    SourceId = dbSource.Id,
                    Inputs = inputs,
                    ExecuteAction = serviceName
                },
                Name = serviceName,
                Id = dbSource.Id
            };
            var testResults = dbServiceModel.TestService(databaseService);

            var mySqlDatabaseActivity = new DsfSqlServerDatabaseActivity
            {
                ProcedureName = serviceName,
                DisplayName = serviceName,
                SourceId = dbSource.Id,
                Outputs = new List<IServiceOutputMapping>(),
                Inputs = databaseService.Inputs
            };

            var mappings = new List<IServiceOutputMapping>();

            if (testResults?.Columns.Count > 1)
            {
                var recordsetName = string.IsNullOrEmpty(testResults.TableName) ? serviceName.Replace(".", "_") : testResults.TableName;
                for (int i = 0; i < testResults.Columns.Count; i++)
                {
                    var column = testResults.Columns[i];
                    var dbOutputMapping = new ServiceOutputMapping(column.ToString(), column.ToString().Replace(" ", ""), recordsetName);
                    mappings.Add(dbOutputMapping);
                }
            }
            mySqlDatabaseActivity.Outputs = mappings;
            mySqlDatabaseActivity.ProcedureName = serviceName;

            _commonSteps.AddVariableToVariableList("[[dbo_Pr_CitiesGetCountries(2).CountryID]]");
            _commonSteps.AddVariableToVariableList("[[dbo_Pr_CitiesGetCountries(2).Description]]");
            _commonSteps.AddActivityToActivityList(parentName, serviceName, mySqlDatabaseActivity);
        }

        static List<IServiceInput> GetServiceInputs(Table table)
        {
            return table.Rows.Select(a => new ServiceInput(a["ParameterName"], a["ParameterValue"]))
                .Cast<IServiceInput>()
                .ToList();
        }

        [Given(@"""(.*)"" contains a sqlserver database service ""(.*)"" with mappings as")]
        public void GivenContainsASqlServerDatabaseServiceWithMappings(string parentName, string serviceName, Table table)
        {
            _containerOps = new Depends(Depends.ContainerType.MSSQL, true);
            var resourceId = "b9184f70-64ea-4dc5-b23b-02fcd5f91082".ToGuid();

            var mySqlDatabaseActivity = new DsfSqlServerDatabaseActivity
            {
                ProcedureName = serviceName,
                DisplayName = serviceName,
                SourceId = resourceId,
                Outputs = new List<IServiceOutputMapping>(),
                Inputs = new List<IServiceInput>()
            };
            foreach (var tableRow in table.Rows)
            {
                var output = tableRow["Output from Service"];
                var toVariable = tableRow["To Variable"];
                var recSetName = DataListUtil.ExtractRecordsetNameFromValue(toVariable);
                mySqlDatabaseActivity.Outputs.Add(new ServiceOutputMapping(output, toVariable, recSetName));
                _commonSteps.AddVariableToVariableList(toVariable);

                var input = tableRow["Input to Service"];
                var fromVariable = tableRow["From Variable"];
                if (!string.IsNullOrEmpty(input))
                {
                    mySqlDatabaseActivity.Inputs.Add(new ServiceInput(input, fromVariable));
                    _commonSteps.AddVariableToVariableList(fromVariable);
                }
            }
            _commonSteps.AddActivityToActivityList(parentName, serviceName, mySqlDatabaseActivity);
        }


        [Given(@"I create a new unsaved workflow with name ""(.*)""")]
        [When(@"I create a new unsaved workflow with name ""(.*)""")]
        [Then(@"I create a new unsaved workflow with name ""(.*)""")]
        public void GivenICreateANewUnsavedWorkflowWithName(string serviceName)
        {
            var environmentModel = ServerRepository.Instance.Source;
            var tempResource = ResourceModelFactory.CreateResourceModel(environmentModel, @"WorkflowService",
                serviceName);
            tempResource.Category = @"Unassigned\" + serviceName;
            tempResource.ResourceName = serviceName;
            tempResource.DisplayName = serviceName;
            tempResource.IsNewWorkflow = true;

            environmentModel.ResourceRepository.Add(tempResource);
            _debugWriterSubscriptionService = new SubscriptionService<DebugWriterWriteMessage>(environmentModel.Connection.ServerEvents);

            _debugWriterSubscriptionService.Subscribe(msg => Append(msg.DebugState));
            if (_scenarioContext.ContainsKey("unsavedWFS"))
            {
                var unsavedWFs = Get<List<IContextualResourceModel>>("unsavedWFS");
                unsavedWFs.Add(tempResource);
            }
            else
            {
                Add("unsavedWFS", new List<IContextualResourceModel> { tempResource });
            }

            environmentModel.ResourceRepository.Add(tempResource);
            _debugWriterSubscriptionService = new SubscriptionService<DebugWriterWriteMessage>(environmentModel.Connection.ServerEvents);

            _debugWriterSubscriptionService.Subscribe(msg => Append(msg.DebugState));
            if (_scenarioContext.ContainsKey(serviceName))
            {
                _scenarioContext[serviceName] = tempResource;
                _scenarioContext["parentWorkflowName"] = serviceName;
                _scenarioContext["environment"] = environmentModel;
                _scenarioContext["resourceRepo"] = environmentModel.ResourceRepository;
                _scenarioContext["debugStates"] = new List<IDebugState>();

            }
            else
            {
                Add(serviceName, tempResource);
                Add("parentWorkflowName", serviceName);
                Add("environment", environmentModel);
                Add("resourceRepo", environmentModel.ResourceRepository);
                Add("debugStates", new List<IDebugState>());
            }
        }

        [When(@"workflow ""(.*)"" merge is opened")]
        public void WhenWorkflowMergeIsOpened(string mergeWfName)
        {
            var environmentModel = ServerRepository.Instance.Source;
            var serverRepository = new Mock<IServerRepository>();
            serverRepository.Setup(p => p.ActiveServer).Returns(new Mock<IServer>().Object);
            serverRepository.Setup(p => p.Source).Returns(new Mock<IServer>().Object);
            var evntArg = new Mock<IEventAggregator>().Object;
            var versionChecker = new Mock<IVersionChecker>().Object;
            var explorer = new Mock<IExplorerViewModel>().Object;
            var viewFact = new Mock<IViewFactory>().Object;
            var versions = _scenarioContext["Versions"] as IList<IExplorerItem>;
            var repo = _scenarioContext.Get<IResourceRepository>("resourceRepo") as ResourceRepository;
            var localResource = repo.LoadContextualResourceModel(versions.First().ResourceId);
            var remoteResource = repo.LoadContextualResourceModel(versions.Last().ResourceId);
            var vm = new Mock<IMergeWorkflowViewModel>();
            var wdvm = new Mock<IMergePreviewWorkflowDesignerViewModel>();
            vm.Setup(p => p.MergePreviewWorkflowDesignerViewModel).Returns(wdvm.Object);
        }

        [Given(@"Public ""(.*)"" Permissions to Execute ""(.*)""")]
        [When(@"Public ""(.*)"" Permissions to Execute ""(.*)""")]
        [Then(@"Public ""(.*)"" Permissions to Execute ""(.*)""")]
        public void GivenPublicPermissionsToExecuteButNotNested(string permited, string resourceName)
        {
            var hasPermissions = !string.IsNullOrEmpty(permited);
            TryGetValue("environment", out IServer environmentModel);
            EnsureEnvironmentConnected(environmentModel);
            var resourceRepository = environmentModel.ResourceRepository;
            var settings = resourceRepository.ReadSettings(environmentModel);
            environmentModel.ForceLoadResources();
            if (hasPermissions)
            {
                AddPermissionsForResource(resourceName, environmentModel, resourceRepository, settings);
            }
        }

        [Given(@"""(.*)"" contains a Decision ""(.*)"" as")]
        public void GivenContainsADecisionAs(string workflowName, string decisionName, Table decisionConfig)
        {
            var activity = new DsfDecision
            {
                DisplayName = decisionName,
                Conditions = new Dev2DecisionStack
                {
                    TheStack = new List<Dev2Decision>()
                }
            };
            foreach (var tableRow in decisionConfig.Rows)
            {
                activity.Conditions.AddModelItem(new Data.SystemTemplates.Models.Dev2Decision
                {
                    Col1 = tableRow["ItemToCheck"],
                    EvaluationFn = DecisionDisplayHelper.GetValue(tableRow["Condition"]),
                    Col2 = tableRow["ValueToCompareTo"]
                });
                Add(decisionName, (TrueArm: tableRow["TrueArmToolName"], FalseArm: tableRow["FalseArmToolName"]));
            }

            _commonSteps.AddActivityToActivityList(workflowName, decisionName, activity);
        }

        [Then(@"the ""(.*)"" number '(.*)' in WorkFlow ""(.*)"" debug inputs as")]
        public void ThenTheNumberInWorkFlowDebugInputsAs(string toolName, int toolNum, string workflowName, Table table)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);

            var debugStates = Get<List<IDebugState>>("debugStates");
            var workflowId = Guid.Empty;

            if (parentWorkflowName != workflowName)
            {
                if (toolName != null && workflowName != null)
                {
                    workflowId = debugStates.First(wf => wf.DisplayName.Equals(workflowName)).ID;
                }
                else
                {
                    throw new InvalidOperationException("SpecFlow broke.");
                }
            }

            var toolSpecificDebug =
                debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == workflowId && ds.DisplayName.Equals(toolName)).Skip(toolNum - 1).ToList();
            if (!toolSpecificDebug.Any())
            {
                toolSpecificDebug =
                debugStates.Where(ds => ds.DisplayName.Equals(toolName)).ToList();
            }
            // Data Merge breaks our debug scheme, it only ever has 1 value, not the expected 2 ;)
            var isDataMergeDebug = toolSpecificDebug.Count == 1 && toolSpecificDebug.Any(t => t.Name == "Data Merge");
            IDebugState inputState;
            if (toolSpecificDebug.Count > 1 && toolSpecificDebug.Any(state => state.StateType == StateType.End))
            {
                inputState = toolSpecificDebug.FirstOrDefault(state => state.StateType == StateType.End);
            }
            else
            {
                inputState = toolSpecificDebug.Skip(toolNum - 1).FirstOrDefault();
            }

            if (inputState?.Inputs != null)
            {
                var SelectResults = inputState.Inputs.SelectMany(s => s.ResultsList);
                if (SelectResults != null && SelectResults.ToList() != null)
                {
                    _commonSteps.ThenTheDebugInputsAs(table, SelectResults.ToList());
                    return;
                }
                Assert.Fail(inputState.Inputs.ToList() + " debug outputs found on " + workflowName + " does not include " + toolName + ".");
            }
            Assert.Fail("No debug input found for " + workflowName + ".");
        }

        [Then(@"the ""(.*)"" number '(.*)' in WorkFlow ""(.*)"" has ""(.*)"" nested children")]
        public void ThenTheNumberInWorkFlowHasNestedChildren(string toolName, int itemNumber, string workflowName, int count)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);
            var debugStates = Get<List<IDebugState>>("debugStates").ToList();

            var id =
                debugStates.Where(ds => ds.DisplayName.Equals(toolName)).Skip(itemNumber - 1).ToList().Select(a => a.ID).First();
            var children = debugStates.Count(a => a.ParentID.GetValueOrDefault() == id);
            Assert.AreEqual(count, children);
        }

        [Then(@"the ""(.*)"" in step (.*) for ""(.*)"" number '(.*)' debug inputs as")]
        public void ThenTheInStepForNumberDebugInputsAs(string toolName, int stepNumber, string forEachName, int itemNumber, Table table)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);

            var debugStates = Get<List<IDebugState>>("debugStates").ToList();
            var workflowId = debugStates.Where(wf => wf.DisplayName.Equals(forEachName)).Skip(itemNumber - 1).First().ID;

            if (parentWorkflowName == forEachName)
            {
                workflowId = Guid.Empty;
            }

            var toolSpecificDebug =
                debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == workflowId && ds.DisplayName.Equals(toolName)).ToList();

            Assert.IsTrue(toolSpecificDebug.Count >= stepNumber);
            var debugToUse = DebugToUse(stepNumber, toolSpecificDebug);

            _commonSteps.ThenTheDebugInputsAs(table, debugToUse.Inputs
                                                    .SelectMany(item => item.ResultsList).ToList());
        }

        [Then(@"the ""(.*)"" in step (.*) for ""(.*)"" number '(.*)' debug outputs as")]
        public void ThenTheInStepForNumberDebugOutputsAs(string toolName, int stepNumber, string forEachName, int itemNumber, Table table)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);

            var debugStates = Get<List<IDebugState>>("debugStates").ToList();
            var workflowId = debugStates.Where(wf => wf.DisplayName.Equals(forEachName)).Skip(itemNumber - 1).First().ID;

            if (parentWorkflowName == forEachName)
            {
                workflowId = Guid.Empty;
            }

            var toolSpecificDebug =
                debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == workflowId && ds.DisplayName.Equals(toolName)).ToList();
            Assert.IsTrue(toolSpecificDebug.Count >= stepNumber);
            var debugToUse = DebugToUse(stepNumber, toolSpecificDebug);


            var outputDebugItems = debugToUse.Outputs
                .SelectMany(s => s.ResultsList).ToList();
            _commonSteps.ThenTheDebugOutputAs(table, outputDebugItems);
        }



        private static void AddPermissionsForResource(string resourceName, IServer environmentModel, IResourceRepository resourceRepository, Data.Settings.Settings settings)
        {
            var resourceModel = resourceRepository.FindSingle(model => model.Category.Equals(resourceName, StringComparison.InvariantCultureIgnoreCase));
            Assert.IsNotNull(resourceModel, "Did not find: " + resourceName);
            settings.Security.WindowsGroupPermissions.RemoveAll(permission => permission.ResourceID == resourceModel.ID);
            var resourcePerm = new WindowsGroupPermission
            {
                WindowsGroup = "Public",
                ResourceID = resourceModel.ID,
                ResourceName = resourceName,
                IsServer = false,
                Permissions = SecPermissions.Execute
            };
            settings.Security.WindowsGroupPermissions.Add(resourcePerm);
            var SettingsWriteResult = resourceRepository.WriteSettings(environmentModel, settings);
            Assert.IsFalse(SettingsWriteResult.HasError, "Cannot setup for security spec.\n Error writing initial resource permissions settings to localhost server.\n" + SettingsWriteResult.Message);
        }

        static void EnsureEnvironmentConnected(IServer server)
        {
            if (!server.IsConnected)
            {
                server.Connect();
            }
        }

        [Given(@"I have server running at ""(.*)""")]
        public void GivenIHaveServerRunningAt(string server)
        {
            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();
            environmentModel.ResourceRepository.Load(true);
            Add("environment", environmentModel);
            Assert.IsNotNull(environmentModel);
            Assert.AreEqual(server, environmentModel.Name);
        }
        [When(@"I resume the workflow ""(.*)"" at ""(.*)"" from version ""(.*)""")]
        public void WhenIResumeTheWorkflowAtFromVersion(string workflow, string activity, string versionNumber)
        {
            var assignActivity = _commonSteps.GetActivityList()
                .FirstOrDefault(p => p.Key == activity)
                .Value as DsfMultiAssignActivity;

            TryGetValue("environment", out IServer environmentModel);

            var resourceModel = environmentModel.ResourceRepository.FindSingle(resource => resource.ResourceName == workflow);
            Assert.IsNotNull(resourceModel);
            var env = new ExecutionEnvironment();
            var serEnv = env.ToJson();
            var msg = environmentModel.ResourceRepository.ResumeWorkflowExecution(resourceModel, serEnv, Guid.Parse(assignActivity.UniqueID), versionNumber, WindowsIdentity.GetCurrent().Name);
            Add("resumeMessage", msg);
        }

        [Given(@"I resume workflow ""(.*)""")]
        [When(@"I resume workflow ""(.*)""")]
        [Then(@"I resume workflow ""(.*)""")]
        public void GivenIResumeWorkflow(string resourceId)
        {
            TryGetValue("environment", out IServer environmentModel);
            var resourceModel = environmentModel.ResourceRepository.FindSingle(resource => resource.ID.ToString() == resourceId);
            Assert.IsNotNull(resourceModel);
            var env = new ExecutionEnvironment();
            env.Assign("[[Name]]", "Bob", 0);
            env.Assign("[[Rec(1).Name]]", "Bob", 0);
            env.Assign("[[Rec(3).SurName]]", "Bob", 0);
            env.Assign("[[Rec(4).Name]]", "Bob", 0);
            env.Assign("[[R(*).FName]]", "Bob", 0);
            env.Assign("[[RecSet().Field]]", "Bob", 0);
            env.Assign("[[RecSet().Field]]", "Jane", 0);
            env.AssignJson(new AssignValue("[[@Person]]", "{\"Name\":\"B\"}"), 0);
            var serEnv = env.ToJson();
            var msg = environmentModel.ResourceRepository.ResumeWorkflowExecution(resourceModel, serEnv, Guid.Parse("670132e7-80d4-4e41-94af-ba4a71b28118"), null,WindowsIdentity.GetCurrent().Name);
            Add("resumeMessage", msg);
        }
        [Then(@"an error ""(.*)""")]
        public void ThenAnError(string message)
        {
            TryGetValue("resumeMessage", out ExecuteMessage executeMessage);
            Assert.IsNotNull(executeMessage);
            Assert.IsTrue(executeMessage.HasError);
            Assert.AreEqual(message, executeMessage.Message.ToString());
        }

        [Then(@"Resume has ""(.*)"" error")]
        public void WhenResumeHasError(string error)
        {
            TryGetValue("resumeMessage", out ExecuteMessage executeMessage);
            if (error == "AN")
            {
                Assert.IsTrue(executeMessage.HasError);
            }
            else
            {
                Assert.IsFalse(executeMessage.HasError);
            }
        }

        [Then(@"Resume message is ""(.*)""")]
        public void ThenResumeMessageIs(string message)
        {
            TryGetValue("resumeMessage", out ExecuteMessage executeMessage);
            Assert.IsNotNull(executeMessage);
            Assert.AreEqual(message, executeMessage.Message.ToString());
        }

        [Then(@"the ""(.*)"" in Workflow ""(.*)"" has an error")]
        public void ThenTheInWorkflowHasAnError(string toolName, string workflow)
        {
            var debugStates = Get<List<IDebugState>>("debugStates");
            var toolSpecificDebug =
                debugStates.Where(ds => ds.DisplayName.Equals(toolName)).ToList();
            Assert.IsFalse(string.IsNullOrEmpty(toolSpecificDebug[0].ErrorMessage));
        }

        [Then(@"execution stopped on error and did not execute ""(.*)""")]
        public void ThenExecutionForStoppedOnErrorAndDidNotExecute(string toolName)
        {
            var debugStates = Get<List<IDebugState>>("debugStates");
            Assert.IsFalse(debugStates.Any(ds => ds.DisplayName.Equals(toolName)));
        }

        [When(@"I startup the mysql container")]
        public void WhenIStartupTheContainer()
        {
            _containerOps = new Depends(Depends.ContainerType.MySQL, true);
        }

        ResourceCatalog ResourceCat { get; set; }
        ActivityParser Parser { get; set; }

        [Given(@"Workflow ""(.*)"" has ""(.*)"" activity")]
        [When(@"Workflow ""(.*)"" has ""(.*)"" activity")]
        [Then(@"Workflow ""(.*)"" has ""(.*)"" activity")]
        public void GivenWorkflowHasActivity(string workflow, string activityName)
        {
            TryGetValue(workflow, out IResourceModel resourceModel);
            var selectedActivity = GetActivity(activityName, resourceModel) as Activity;
            Assert.IsNotNull(selectedActivity, "The tool does not exist on the surface");
            _commonSteps.AddActivityToActivityList(workflow, activityName, selectedActivity);
        }

        private IDev2Activity GetActivity(string activityName, IResourceModel resourceModel)
        {
            ResourceCat = ResourceCat ?? new ResourceCatalog();
            Parser = Parser ?? new ActivityParser();

            var service = ResourceCat.GetService(GlobalConstants.ServerWorkspaceID, resourceModel.ID, resourceModel.ResourceName);
            var sa = service.Actions.FirstOrDefault();
            ResourceCat.MapServiceActionDependencies(GlobalConstants.ServerWorkspaceID, sa);
            var activity = ResourceCat.GetActivity(sa);
            var dev2Act = Parser.Parse(activity);
            var allNodes = Parser.ParseToLinkedFlatList(dev2Act);
            var selectedActivity = allNodes.FirstOrDefault(p => p.GetDisplayName() == activityName);
            return selectedActivity;
        }

        [Given(@"I resume workflow ""(.*)"" at ""(.*)"" tool")]
        [When(@"I resume workflow ""(.*)"" at ""(.*)"" tool")]
        [Then(@"I resume workflow ""(.*)"" at ""(.*)"" tool")]
        public void WhenIResumeWorkflowAtTool(string workflow, string toolToResumeFrom)
        {
            var uniqueId = GetActivityUniqueId(toolToResumeFrom);
            TryGetValue("environment", out IServer environmentModel);
            var resourceModel = environmentModel.ResourceRepository.FindSingle(resource => resource.ResourceName == workflow);
            Assert.IsNotNull(resourceModel);

            _debugWriterSubscriptionService = new SubscriptionService<DebugWriterWriteMessage>(environmentModel.Connection.ServerEvents);

            _debugWriterSubscriptionService.Subscribe(debugMsg => Append(debugMsg.DebugState));

            var env = "{\"Environment\":{\"scalars\":{\"number\":1},\"record_sets\":{},\"json_objects\":{}},\"Errors\":[],\"AllErrors\":[\"Service Execution Error:    at Dev2.Services.Execution.DatabaseServiceExecution.ExecuteService(Int32 update, ErrorResultTO& errors, IOutputFormatter formater) in C:\\\\Repos\\\\Warewolf\\\\Dev\\\\Dev2.Services.Execution\\\\DatabaseServiceExecution.cs:line 104\\r\\n   at Dev2.Services.Execution.ServiceExecutionAbstract`2.ExecuteService(ErrorResultTO& errors, Int32 update, IOutputFormatter formater) in C:\\\\Repos\\\\Warewolf\\\\Dev\\\\Dev2.Services.Execution\\\\ServiceExecutionAbstract.cs:line 372\"]}";
            var msg = environmentModel.ResourceRepository.ResumeWorkflowExecution(resourceModel, env, uniqueId, "",WindowsIdentity.GetCurrent().Name);
            Add("resumeMessage", msg);
        }

        private Guid GetActivityUniqueId(string toolToResumeFrom)
        {
            var activities = _commonSteps.GetActivityList();
            var abstartActivity = activities[toolToResumeFrom] as DsfActivityAbstract<string>;
            if (abstartActivity != null)
            {
                return Guid.Parse(abstartActivity.UniqueID);
            }
            var activity = activities[toolToResumeFrom] as DsfActivity;
            return Guid.Parse(activity.UniqueID);
        }

        [When(@"I select ""(.*)"" Action for ""(.*)"" tool")]
        public void WhenISelectActionForTool(string action, string toolName)
        {
            var activities = _commonSteps.GetActivityList();
            var activity = activities[toolName] as DsfMySqlDatabaseActivity;
            activity.ProcedureName = action;
            activity.Inputs.Add(new ServiceInput("name", "S"));
        }

        [When(@"I select ""(.*)"" for ""(.*)"" as Source")]
        public void WhenISelectForAsSource(string source, string toolName)
        {
            var activities = _commonSteps.GetActivityList();
            var activity = activities[toolName] as DsfMySqlDatabaseActivity;

            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();
            environmentModel.LoadExplorer(true);
            var environmentConnection = environmentModel.Connection;
            var controllerFactory = new CommunicationControllerFactory();
            var _proxyLayer = new StudioServerProxy(controllerFactory, environmentConnection);

            var dbSources = _proxyLayer.QueryManagerProxy.FetchDbSources().ToList();
            var dbSource = dbSources.Single(s => s.Name == source);
            activity.SourceId = dbSource.Id;
        }

        [Given(@"The detailed log file does not exist for ""(.*)""")]
        public void GivenTheDetailedLogFileDoesNotExistFor(string workflowName)
        {
            var detailLogInfo = new DetailLogInfo(workflowName, this);
            detailLogInfo.DeleteIfExists();
            Add($"DetailLogInfo {workflowName}", detailLogInfo);
        }

        [Given(@"The detailed log file does not exist for id ""(.*)"" - ""(.*)""")]
        public void GivenTheDetailedLogFileDoesNotExistForId(string id, string workflowName)
        {
            var detailLogInfo = new DetailLogInfo(workflowName, id);
            detailLogInfo.DeleteIfExists();
            Add($"DetailLogInfo {workflowName}", detailLogInfo);
        }

        [Then(@"The detailed log file is created for ""(.*)""")]
        public void ThenTheDetailedLogFileIsCreatedFor(string workflowName)
        {
            TryGetValue($"DetailLogInfo {workflowName}", out DetailLogInfo detailLogInfo);
            var logFileContent = detailLogInfo.ReadAllText();
            AddLogFileContentToContext(logFileContent);
            Assert.IsTrue(logFileContent.Length > 0);
        }

        [Then(@"The Log file contains Logging for ""(.*)""")]
        public void ThenTheLogFileContainsLoggingFor(string workflowName)
        {
            TryGetValue($"DetailLogInfo {workflowName}", out DetailLogInfo detailLogInfo);
            var logContent = detailLogInfo.ReadAllText();
            Assert.IsTrue(logContent.Contains("header:LogPreExecuteState"));
            Assert.IsTrue(logContent.Contains("header:LogPostExecuteState"));
            Assert.IsTrue(logContent.Contains("header:LogExecuteCompleteState"));
            Assert.IsFalse(logContent.Contains("header:LogStopExecutionState"));
        }

        [Then(@"The Log file contains Logging for stopped ""(.*)""")]
        public void ThenTheLogFileContainsLoggingForStopped(string workflowName)
        {
            TryGetValue($"DetailLogInfo {workflowName}", out DetailLogInfo detailLogInfo);
            var logContent = detailLogInfo.ReadAllText();
            Assert.IsTrue(logContent.Contains("header:LogPreExecuteState"));
            Assert.IsTrue(logContent.Contains("header:LogPostExecuteState"));
            Assert.IsFalse(logContent.Contains("header:LogExecuteCompleteState"));
            Assert.IsTrue(logContent.Contains("header:LogStopExecutionState"));
        }

        [Then(@"The Log file for ""(.*)"" contains additional Logging")]
        public void ThenTheLogFileContainsAdditionalLogging(string workflowName)
        {
            TryGetValue($"DetailLogInfo {workflowName}", out DetailLogInfo detailLogInfo);
            var previousLogFileSize = detailLogInfo.PreviousLength;
            var logContent = detailLogInfo.ReadAllText();
            Assert.IsTrue(logContent.Length > previousLogFileSize);
            var sizeDifference = logContent.Length / (double)previousLogFileSize;
            Assert.IsTrue(sizeDifference > 1.9);
            Assert.IsTrue(sizeDifference < 2.1);
        }

        [Then(@"The Log file for ""(.*)"" contains Logging matching ""(.*)""")]
        public void ThenTheLogFileForContainsLoggingMatching(string workflowName, string searchString)
        {
            TryGetValue($"DetailLogInfo {workflowName}", out DetailLogInfo detailLogInfo);
            var logFileContent = detailLogInfo.ReadAllText();
            AddLogFileContentToContext(logFileContent);
            Assert.IsTrue(logFileContent.Contains(searchString));
        }

        private void AddLogFileContentToContext(string logFileContent)
        {
            TryGetValue("LogFileContent", out string fileContent);
            if (fileContent == null)
            {
                Add("LogFileContent", logFileContent);
            }
            else
            {
                _scenarioContext.Remove("LogFileContent");
                Add("LogFileContent", logFileContent);
            }
        }

        [Then(@"The Log file contains Logging matching ""(.*)""")]
        public void ThenTheLogFileContainsLoggingMatching(string searchString)
        {
            TryGetValue("LogFileContent", out string logFileContent);
            Assert.IsTrue(logFileContent.Contains(searchString), $"detailed log file does not contain {searchString}");
        }
        [DeploymentItem(@"x86\SQLite.Interop.dll")]
        [Given(@"the audit database is empty")]
        public void GivenTheAuditDatabaseIsEmpty()
        {
            //TODO: Fix in new Implementation
            //Dev2StateAuditLogger.ClearAuditLog();
        }

        [Then(@"The audit database has ""(.*)"" search results containing ""(.*)"" with type """"(.*)""Decision""(.*)""Hello World"" as")]
        public void ThenTheAuditDatabaseHasSearchResultsContainingWithTypeDecisionHelloWorldAs(int expectedCount, string searchString, string auditType, string activityName, string workflowName, Table table)
        {
            //TODO: Fix in new Implementation
            //var results = Dev2StateAuditLogger.Query(item =>
            //(workflowName == "" || item.WorkflowName.Equals(workflowName)) &&
            //(auditType == "" || item.AuditType.Equals(auditType)) &&
            //(activityName == "" || (item.PreviousActivity != null && item.PreviousActivity.Contains(activityName))));
            //Assert.AreEqual(expectedCount, results.Count());
            //var prop = table.Rows[0][0];
            //var val = table.Rows[0][1];
            //foreach (var item in results)
            //{
            //    var value = item.GetType().GetProperty(prop).GetValue(item, null);
            //    Assert.AreEqual(val, value);
            //}
        }

        [DeploymentItem(@"x86\SQLite.Interop.dll")]
        [Then(@"The audit database has ""(.*)"" search results containing ""(.*)"" with type ""(.*)"" for ""(.*)"" as")]
        public void ThenTheAuditDatabaseHasSearchResultsContainingWithTypeWithActivityForAs(int expectedCount, string activityName, string auditType, string workflowName, Table table)
        {
            //TODO: correct with new implementation
            //Thread.Sleep(1000);
            //var results = Dev2StateAuditLogger.Query(item =>
            //   (workflowName == "" || item.WorkflowName.Equals(workflowName)) &&
            //   (auditType == "" || item.AuditType.Equals(auditType)) &&
            //   (activityName == "" || (
            //       (item.NextActivity != null && item.NextActivity.Contains(activityName)) ||
            //       (item.NextActivityType != null && item.NextActivityType.Contains(activityName)) ||
            //       (item.PreviousActivity != null && item.PreviousActivity.Contains(activityName)) ||
            //       (item.PreviousActivityType != null && item.PreviousActivityType.Contains(activityName))
            //   ))
            //);
            //   Assert.AreEqual(expectedCount, results.Count(), string.Join(" ", results.Select(entry => entry.WorkflowName + " " + entry.AuditDate + " " + entry.AdditionalDetail).ToList()));

            //if (results.Any() && table.Rows.Count > 0)
            //{
            //    var index = 0;
            //    foreach (var row in table.Rows)
            //    {
            //        var currentResult = results.ToArray()[index];
            //        Assert.AreEqual(row["AuditType"], currentResult.AuditType);
            //        Assert.AreEqual(row["WorkflowName"], currentResult.WorkflowName);
            //        Assert.AreEqual(row["PreviousActivityType"], currentResult.PreviousActivityType ?? "null");
            //        Assert.AreEqual(row["NextActivityType"], currentResult.NextActivityType ?? "null");
            //        index++;
            //    }
            //}
        }

        [DeploymentItem(@"x86\SQLite.Interop.dll")]
        [Then(@"The audit database has ""(.*)"" search results for ""(.*)"" as")]
        public void ThenTheAuditDatabaseHasSearchResultsForAs(int expectedCount, string workflowName, Table table)
        {
            //TODO: This will use the new server
            //var results = Dev2StateAuditLogger.Query(item =>
            //   (workflowName == "" || item.WorkflowName.Equals(workflowName))
            //);
            //Assert.AreEqual(expectedCount, results.Count());
            //if (results.Count() > 0 && table.Rows.Count > 0)
            //{
            //    var index = 0;
            //    foreach (var row in table.Rows)
            //    {
            //        var currentResult = results.ToArray()[index];
            //        Assert.AreEqual(row["WorkflowName"], currentResult.WorkflowName);
            //        Assert.AreEqual(row["AuditType"], currentResult.AuditType);
            //        Assert.AreEqual(row["VersionNumber"], currentResult.VersionNumber ?? "null");
            //        index++;
            //    }
            //}
        }
        [DeploymentItem(@"x86\SQLite.Interop.dll")]
        [Then(@"The audit database has ""(.*)"" search results containing ""(.*)"" with log type ""(.*)"" for ""(.*)""")]
        public void ThenTheLogFileSearchResultsContainFor(int expectedCount, string activityName, string logType, string workflowName)
        {
            //TODO: This will use the new server
            // var results = StateAuditLogger.Query(item =>
            //    (workflowName == "" || item.WorkflowName.Equals(workflowName)) &&
            //    (logType == "" || item.AuditType.Equals(logType)) &&
            //    (activityName == "" || (
            //        (item.NextActivity != null && item.NextActivity.Contains(activityName)) ||
            //        (item.NextActivityType != null && item.NextActivityType.Contains(activityName)) ||
            //        (item.PreviousActivity != null && item.PreviousActivity.Contains(activityName)) ||
            //        (item.PreviousActivityType != null && item.PreviousActivityType.Contains(activityName))
            //    ))
            //);
            // Assert.AreEqual(expectedCount, results.Count());
        }

        private static bool GetMatchingNames(string toolName, string displayName)
        {
            var updateDisplayName = GetMatchingName(displayName);
            var updateToolName = GetMatchingName(toolName);

            return updateDisplayName.Equals(updateToolName);
        }

        private static string GetMatchingName(string name)
        {
            var updateName = name;
            if (name.Contains("("))
            {
                var endIdx = name.IndexOf("(");
                updateName = name.Substring(0, endIdx).TrimEnd();
            }

            return updateName;
        }

        class DetailLogInfo
        {
            readonly IContextualResourceModel _resourceModel;
            readonly string _logFilePath;
            readonly FileWrapper _fileWrapper;
            public int PreviousLength { get; private set; }
            private DetailLogInfo()
            {
                _fileWrapper = new FileWrapper();
            }
            public DetailLogInfo(string workflowName, WorkflowExecutionSteps workflowExecutionSteps)
                : this()
            {
                workflowExecutionSteps.TryGetValue(workflowName, out _resourceModel);
                _logFilePath = Path.Combine(EnvironmentVariables.WorkflowDetailLogPath(_resourceModel.ID, _resourceModel.ResourceName), "Detail.log");
            }
            public DetailLogInfo(string workflowName, string resourceModelId)
                : this()
            {
                _logFilePath = Path.Combine(EnvironmentVariables.WorkflowDetailLogPath(Guid.Parse(resourceModelId), workflowName), "Detail.log");
            }

            internal void DeleteIfExists()
            {
                if (_fileWrapper.Exists(_logFilePath))
                {
                    _fileWrapper.Delete(_logFilePath);
                }
            }

            internal string ReadAllText()
            {
                var result = _fileWrapper.ReadAllText(_logFilePath);
                PreviousLength = result.Length;
                return result;
            }
        }
    }
}

---- Transformed Tree ----
using System;
using System.Activities;
using System.Activities.Statements;
using System.Collections.Generic;
using System.Configuration;
using System.Data;
using System.Diagnostics;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading;
using System.Xml;
using System.Xml.Linq;
using Dev2.Activities.DropBox2016.DeleteActivity;
using Dev2.Activities.DropBox2016.DownloadActivity;
using Dev2.Activities.DropBox2016.DropboxFileActivity;
using Dev2.Activities.DropBox2016.UploadActivity;
using Dev2.Activities.RabbitMQ.Consume;
using Dev2.Activities.Scripting;
using Dev2.Activities.RabbitMQ.Publish;
using Dev2.Activities.SelectAndApply;
using Dev2.Activities.Sharepoint;
using Dev2.Activities.Specs.BaseTypes;
using Dev2.Common.Common;
using Dev2.Common.ExtMethods;
using Dev2.Common.Interfaces.Core.DynamicServices;
using Dev2.Common.Interfaces.Diagnostics.Debug;
using Dev2.Common.Interfaces.Enums.Enums;
using Dev2.Common.Interfaces.Explorer;
using Dev2.Communication;
using Dev2.Controller;
using Dev2.Data.ServiceModel;
using Dev2.Data.Util;
using Dev2.Messages;
using Dev2.Network;
using Dev2.Runtime.ServiceModel.Data;
using Dev2.Services;
using Dev2.Services.Security;
using Dev2.Session;
using Dev2.Studio.Core;
using Dev2.Studio.Core.AppResources.Repositories;
using Dev2.Studio.Core.Models;
using Dev2.Studio.Core.Network;
using Dev2.Studio.ViewModels.DataList;
using Dev2.Threading;
using Dev2.TO;
using Dev2.Util;
using Dev2.Utilities;
using FluentAssertions;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using TechTalk.SpecFlow;
using Unlimited.Applications.BusinessDesignStudio.Activities;
using Moq;
using Dev2.Common.Interfaces;
using Dev2.Common.Interfaces.DB;
using Dev2.Common.Interfaces.Enums;
using Dev2.Common.Interfaces.Infrastructure.SharedModels;
using Dev2.Common.Interfaces.Monitoring;
using Dev2.PerformanceCounters.Counters;
using Dev2.PerformanceCounters.Management;
using Dev2.Studio.Core.Factories;
using Dev2.Studio.Interfaces;
using Dev2.Studio.Interfaces.Enums;
using Warewolf.Core;
using Warewolf.Studio.ViewModels;
using Warewolf.Tools.Specs.BaseTypes;
using Dev2.Data.Interfaces.Enums;
using TestingDotnetDllCascading;
using Caliburn.Micro;
using Dev2.Studio.Core.Helpers;
using SecPermissions = Dev2.Common.Interfaces.Security.Permissions;
using Dev2.Common;
using Dev2.Data.Decisions.Operations;
using Dev2.Data.SystemTemplates.Models;
using Dev2.Common.Wrappers;
using Dev2.Common.Interfaces.Wrappers;
using System.Security.Principal;
using Warewolf.Storage;
using WarewolfParserInterop;
using Dev2.Runtime.Hosting;
using Warewolf.UnitTestAttributes;
using Activity = System.Activities.Activity;

namespace Dev2.Activities.Specs.Composition
{
    [Binding]
    public class WorkflowExecutionSteps : RecordSetBases
    {
        readonly ScenarioContext _scenarioContext;
        IDirectory _dirHelper;
        public static Depends _containerOps;

        public WorkflowExecutionSteps(ScenarioContext scenarioContext)
            : base(scenarioContext)
        {
            _scenarioContext = scenarioContext ?? throw new ArgumentNullException(nameof(scenarioContext));
            _commonSteps = new CommonSteps(_scenarioContext);
            AppUsageStats.LocalHost = "http://localhost:3142";
            _dirHelper = new DirectoryWrapper();
        }

        const int EnvironmentConnectionTimeout = 15;

        SubscriptionService<DebugWriterWriteMessage> _debugWriterSubscriptionService;
        SpecExternalProcessExecutor _externalProcessExecutor;
        readonly AutoResetEvent _resetEvt = new AutoResetEvent(false);
        readonly CommonSteps _commonSteps;

        protected override void BuildDataList()
        {
            BuildShapeAndTestData();
        }

        [BeforeScenario]
        public void Setup()
        {
            if (_debugWriterSubscriptionService != null)
            {
                _debugWriterSubscriptionService.Unsubscribe();
                _debugWriterSubscriptionService.Dispose();
            }

            var mockServer = new Mock<IServer>();
            var mockshell = new Mock<IShellViewModel>();
            mockshell.Setup(a => a.ActiveServer).Returns(mockServer.Object);
            mockServer.Setup(a => a.GetServerVersion()).Returns("1.0.0.0");
            CustomContainer.Register(mockServer.Object);
            CustomContainer.Register(mockshell.Object);
            _externalProcessExecutor = new SpecExternalProcessExecutor();
        }

        public void WorkflowIsDeletedAsCleanup()
        {
            TryGetValue("resourcemodel", out IContextualResourceModel resourceModel);
            if (resourceModel != null)
            {
                TryGetValue("environment", out IServer server);
                TryGetValue("resourceRepo", out IResourceRepository repository);
                repository.DeleteResourceFromWorkspace(resourceModel);
                repository.DeleteResource(resourceModel);
            }
        }

        [AfterScenario]
        public void CleanUp()
        {
            _resetEvt?.Close();
            _containerOps?.Dispose();
        }

        [AfterScenario("ResumeWorkflowExecution")]
        public void CleanUpResources()
        {
            WorkflowIsDeletedAsCleanup();
        }
        public void CleanUp_DetailedLogFile()
        {
            WorkflowIsDeletedAsCleanup();
            if (_debugWriterSubscriptionService != null)
            {
                var files = Directory.GetFiles(EnvironmentVariables.DetailLogPath, "*", SearchOption.AllDirectories);

                foreach (var item in files)
                {
                    File.Delete(item);
                }
                _dirHelper.Delete(EnvironmentVariables.DetailLogPath, true);
            }
            _scenarioContext?.Clear();
        }

        [Given(@"Debug states are cleared")]
        public void GivenDebugStatesAreCleared()
        {
            TryGetValue("debugStates", out List<IDebugState> debugStates);
            debugStates?.Clear();
        }

        [Given(@"Debug events are reset")]
        public void GivenDebugEventsAreReset()
        {
            if (_debugWriterSubscriptionService != null)
            {
                _debugWriterSubscriptionService.Unsubscribe();
                _debugWriterSubscriptionService.Dispose();
            }
        }

        [Then(@"the workflow execution has ""(.*)"" error")]
        public void ThenTheWorkflowExecutionHasError(string hasError)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);
            var debugStates = Get<List<IDebugState>>("debugStates").ToList();
            if (hasError == "AN")
            {
                var hasErrorState = debugStates.FirstOrDefault(state => state.HasError);
                Assert.IsNotNull(hasErrorState);
            }
        }

        [Then(@"the ""(.*)"" workflow execution has ""(.*)"" error")]
        public void ThenTheWorkflowExecutionHasError(string workflowName, string hasError)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);
            var debugStates = Get<List<IDebugState>>("debugStates").ToList();

            if (hasError == "AN")
            {
                var innerWfHasErrorState = debugStates.FirstOrDefault(state => state.HasError && state.DisplayName.Equals(workflowName));
                var parentWfhasErrorState = debugStates.FirstOrDefault(state => state.HasError && state.DisplayName.Equals(parentWorkflowName));
                Assert.IsNotNull(innerWfHasErrorState);
                Assert.IsNotNull(parentWfhasErrorState);
            }
        }

        [Given(@"I have a localhost server")]
        public void GivenIHaveAServerAt()
        {
            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();
            for (int count = 0; !environmentModel.IsConnected; count++)
            {
                if (count > 20)
                {
                    throw new Exception("connection to localhost timeout");
                }
                Thread.Sleep(500);
            }
        }


        [Given(@"I have a server at ""(.*)"" with workflow ""(.*)""")]
        public void GivenIHaveAWorkflowOnServer(string serverName, string workflow)
        {
            AppUsageStats.LocalHost = "http://localhost:3142";
            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();
            environmentModel.ResourceRepository.Load(true);

            // connect to the remote environment now
            var remoteServerList = environmentModel.ResourceRepository.FindSourcesByType<Connection>(environmentModel, enSourceType.Dev2Server);

            if (remoteServerList != null && remoteServerList.Count > 0)
            {
                var remoteServer = remoteServerList.FirstOrDefault(r => r.ResourceName == serverName);

                if (remoteServer != null)
                {
                    ServerProxy connection;
                    if (remoteServer.AuthenticationType == AuthenticationType.Windows || remoteServer.AuthenticationType == AuthenticationType.Anonymous)
                    {
                        connection = new ServerProxy(new Uri(remoteServer.WebAddress));
                    }
                    else
                    {
                        //
                        // NOTE: Public needs to drop through to User for the rest of the framework to pick up properly behind the scenes ;)
                        //
                        connection = new ServerProxy(remoteServer.WebAddress, remoteServer.UserName, remoteServer.Password);
                    }

                    var newEnvironment = new Server(remoteServer.ResourceID, connection) { Name = remoteServer.ResourceName };
                    EnsureEnvironmentConnected(newEnvironment, EnvironmentConnectionTimeout);
                    LoadResourcesAndSubscribeToDebugOutput(workflow, newEnvironment);
                }
                else
                {
                    LoadResourcesAndSubscribeToDebugOutput(workflow, environmentModel);
                }
            }
            else
            {
                Assert.Fail($"Server \"{serverName}\" not found");
            }
        }

        void LoadResourcesAndSubscribeToDebugOutput(string workflow, IServer newEnvironment)
        {
            newEnvironment.ForceLoadResources();

            var resourceModel = newEnvironment.ResourceRepository.FindSingle(r => r.ResourceName == workflow);

            _debugWriterSubscriptionService = new SubscriptionService<DebugWriterWriteMessage>(newEnvironment.Connection.ServerEvents);

            _debugWriterSubscriptionService.Subscribe(msg => Append(msg.DebugState));

            Add(workflow, resourceModel);
            Add("parentWorkflowName", workflow);
            Add("environment", newEnvironment);
            Add("resourceRepo", newEnvironment.ResourceRepository);
            Add("debugStates", new List<IDebugState>());
        }

        [BeforeFeature()]
        static void SetUpLocalHost()
        {
            LocalEnvModel = ServerRepository.Instance.Source;
            LocalEnvModel.ConnectAsync().Wait(60000);
            LocalEnvModel.ForceLoadResources();
        }

        public static IServer LocalEnvModel { get; set; }

        [Given("I depend on a valid RabbitMQ server")]
        public void GivenIGetaValidRabbitMQServer() => _containerOps = new Depends(Depends.ContainerType.RabbitMQ, true);

        [Given("I depend on a valid PostgreSQL server")]
        public void GivenIGetaValidPostgreSQLServer() => _containerOps = new Depends(Depends.ContainerType.PostGreSQL, true);

        [Given("I depend on a valid MySQL server")]
        public void GivenIGetaValidMySQLServer() => _containerOps = new Depends(Depends.ContainerType.MySQL, true);

        [Given("I depend on a valid MSSQL server")]
        public void GivenIGetaValidMSSQLServer() => _containerOps = new Depends(Depends.ContainerType.MSSQL, true);

        [Given("I depend on a valid remote Warewolf server")]
        public void GivenIGetaValidRemoteWarewolfServer() => _containerOps = new Depends(Depends.ContainerType.CIRemote, true);

        [Given("I depend on a valid HTTP web server")]
        public void GivenIGetaValidHTTPWebServer() => _containerOps = new Depends(Depends.ContainerType.WebApi, true);

        [Given("I depend on a valid HTTP verbs server")]
        public void GivenIGetaValidHTTPVerbsServer() => _containerOps = new Depends(Depends.ContainerType.HTTPVerbsApi, true);

        [Given(@"I have a workflow ""(.*)""")]
        public void GivenIHaveAWorkflow(string workflowName)
        {
            var resourceId = Guid.NewGuid();
            var environmentModel = LocalEnvModel;
            EnsureEnvironmentConnected(environmentModel, EnvironmentConnectionTimeout);
            // TODO: move this to a spec command something like "I get a valid MySQL host called 'mysqlhost1'"
            if (workflowName == "TestMySqlWFWithMySqlCountries" ||
                workflowName == "TestMySqlWFWithMySqlLastIndex" ||
                workflowName == "TestMySqlWFWithMySqlScalar" ||
                workflowName == "TestMySqlWFWithMySqlStarIndex" ||
                workflowName == "TestMySqlWFWithMySqlIntIndex")
            {
                _containerOps = new Depends(Depends.ContainerType.MySQL, true);
            }
            var resourceModel = new ResourceModel(environmentModel)
            {
                ID = resourceId,
                ResourceName = workflowName,
                Category = "Acceptance Tests\\" + workflowName,
                ResourceType = ResourceType.WorkflowService
            };

            environmentModel.ResourceRepository.Add(resourceModel);
            _debugWriterSubscriptionService = new SubscriptionService<DebugWriterWriteMessage>(environmentModel.Connection.ServerEvents);

            _debugWriterSubscriptionService.Subscribe(msg => Append(msg.DebugState));
            Add("resourcemodel", resourceModel);
            Add(workflowName, resourceModel);
            Add("resourceId", resourceId);
            Add("parentWorkflowName", workflowName);
            Add("environment", environmentModel);
            Add("resourceRepo", environmentModel.ResourceRepository);
            Add("debugStates", new List<IDebugState>());
        }

        [Given(@"I have reset local performance Counters")]
        public void GivenIHaveResetLocalPerformanceCounters()
        {
            try
            {
                try
                {
                    PerformanceCounterCategory.Delete("Warewolf");
                }

                catch (Exception e)
                {
                    Assert.IsNotNull(e);
                }

                var performanceCounterFactory = new PerformanceCounterFactory();

                var register = new WarewolfPerformanceCounterRegister(new List<IPerformanceCounter>
                                                            {   new WarewolfCurrentExecutionsPerformanceCounter(performanceCounterFactory),
                                                                new WarewolfNumberOfErrors(performanceCounterFactory),
                                                                new WarewolfRequestsPerSecondPerformanceCounter(performanceCounterFactory),
                                                                new WarewolfAverageExecutionTimePerformanceCounter(performanceCounterFactory),
                                                                new WarewolfNumberOfAuthErrors(performanceCounterFactory),
                                                                new WarewolfServicesNotFoundCounter(performanceCounterFactory)
                                                            }, new List<IResourcePerformanceCounter>());
                CustomContainer.Register<IWarewolfPerformanceCounterLocater>(new WarewolfPerformanceCounterManager(register.Counters, new List<IResourcePerformanceCounter>(), register, new Mock<IPerformanceCounterPersistence>().Object, performanceCounterFactory));
            }
            catch (Exception ex)
            {
                Assert.Fail("failed to delete existing counters");
            }
        }

        [Then(@"the perfcounter raw values are")]
        public void ThenThePerfcounterRawValuesAre(Table table)
        {
            var performanceCounterCategory = new PerformanceCounterCategory("Warewolf");
            var instanceNames = performanceCounterCategory.GetInstanceNames();
            foreach (var instanceName in instanceNames)
            {
                var counters = performanceCounterCategory.GetCounters(instanceName);
                foreach (var tableRow in table.Rows)
                {
                    foreach (var counter in instanceNames)
                    {
                        var performanceCounter = counters.First(a => a.CounterName == tableRow[0]);
                        if (performanceCounter != null)
                        {
                            using (var cnt = new PerformanceCounter("Warewolf", tableRow[0], counter, true))
                            {
                                if (tableRow[1] == "x")
                                {
                                    Assert.AreNotEqual(cnt.RawValue, 0);
                                }
                                else
                                {
                                    Assert.AreEqual(cnt.RawValue, int.Parse(tableRow[1]));
                                }
                            }
                        }
                    }
                }
            }
        }

        void EnsureEnvironmentConnected(IServer server, int timeout)
        {
            var startTime = DateTime.UtcNow;
            server.ConnectAsync().Wait(60000);

            while (!server.IsConnected && !server.Connection.IsConnected)
            {
                Assert.AreEqual(server.IsConnected, server.Connection.IsConnected);

                var now = DateTime.UtcNow;
                if (now.Subtract(startTime).TotalSeconds > timeout)
                {
                    break;
                }
                Thread.Sleep(GlobalConstants.NetworkTimeOut);
            }

            if (!server.IsConnected && !server.Connection.IsConnected)
            {
                _scenarioContext.Add("ConnectTimeoutCountdown", EnvironmentConnectionTimeout);
                throw new TimeoutException("Connection to Warewolf server \"" + server.Name + "\" timed out.");
            }
        }

        void Add(string key, object value) => _scenarioContext.Add(key, value);

        void Append(IDebugState debugState)
        {
            TryGetValue("debugStates", out List<IDebugState> debugStates);
            TryGetValue("debugStatesDuration", out List<IDebugState> debugStatesDuration);
            TryGetValue("parentWorkflowName", out string workflowName);
            TryGetValue("environment", out IServer server);
            if (debugStatesDuration == null)
            {
                debugStatesDuration = new List<IDebugState>();
                Add("debugStatesDuration", debugStatesDuration);
            }
            if (debugState.WorkspaceID == server.Connection.WorkspaceID || debugState.WorkspaceID == GlobalConstants.ServerWorkspaceID)
            {
                if (debugState.StateType != StateType.Duration)
                {
                    debugStates.Add(debugState);
                }
                else
                {
                    debugStatesDuration.Add(debugState);
                }
            }
            if (debugState.IsFinalStep() && debugState.DisplayName.Equals(workflowName))
            {
                _resetEvt.Set();
            }

        }

        [Then(@"the ""(.*)"" in step (.*) for ""(.*)"" debug inputs as")]
        public void ThenTheInStepForDebugInputsAs(string toolName, int stepNumber, string forEachName, Table table)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);

            var debugStates = Get<List<IDebugState>>("debugStates").ToList();
            var workflowId = debugStates.First(wf => wf.DisplayName.Equals(forEachName)).ID;

            if (parentWorkflowName == forEachName)
            {
                workflowId = Guid.Empty;
            }

            var toolSpecificDebug =
                debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == workflowId && ds.DisplayName.Equals(toolName)).ToList();

            Assert.IsTrue(toolSpecificDebug.Count >= stepNumber);
            var debugToUse = DebugToUse(stepNumber, toolSpecificDebug);

            _commonSteps.ThenTheDebugInputsAs(table, debugToUse.Inputs
                                                    .SelectMany(item => item.ResultsList).ToList());
        }

        [Then(@"the ""(.*)"" in '(.*)' in step (.*) for ""(.*)"" debug inputs as")]
        public void ThenTheInInStepForDebugInputsAs(string toolName, string sequenceName, int stepNumber, string forEachName, Table table)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);

            var debugStates = Get<List<IDebugState>>("debugStates").ToList();
            var workflowId = debugStates.First(wf => wf.DisplayName.Equals(forEachName)).ID;

            if (parentWorkflowName == forEachName)
            {
                workflowId = Guid.Empty;
            }

            var sequenceDebug = debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == workflowId).ToList();
            Assert.IsTrue(sequenceDebug.Count >= stepNumber);

            var sequenceId = sequenceDebug[stepNumber - 1].ID;
            var sequenceIsInForEach = sequenceDebug.Any(state => state.ID == sequenceId);
            Assert.IsTrue(sequenceIsInForEach);

            var toolSpecificDebug =
                debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == sequenceId && ds.DisplayName.Equals(toolName)).ToList();

            _commonSteps.ThenTheDebugInputsAs(table, toolSpecificDebug
                                                    .SelectMany(item => item.Inputs)
                                                    .SelectMany(item => item.ResultsList).ToList());

        }

        [Then(@"the dotnetdll ""(.*)"" in '(.*)' in step (.*) for ""(.*)"" debug inputs as")]
        public void ThenTheInInStepForDotNetDebugInputsAs(string toolName, string sequenceName, int stepNumber, string forEachName, Table table)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);

            var debugStates = Get<List<IDebugState>>("debugStates").ToList();
            var workflowId = debugStates.First(wf => wf.DisplayName.Equals(forEachName)).ID;

            if (parentWorkflowName == forEachName)
            {
                workflowId = Guid.Empty;
            }

            var sequenceDebug = debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == workflowId).ToList();
            Assert.IsTrue(sequenceDebug.Count >= stepNumber);

            var sequenceId = sequenceDebug[stepNumber - 1].ID;
            var sequenceIsInForEach = sequenceDebug.Any(state => state.ID == sequenceId);
            Assert.IsTrue(sequenceIsInForEach);

            var toolSpecificDebug =
                debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == sequenceId && ds.DisplayName.Equals(toolName)).ToList();
            Assert.IsNotNull(toolSpecificDebug);
            var debugState = toolSpecificDebug.FirstOrDefault();
            if (debugState != null)
            {
                for (int index = 0; index < debugState.Inputs.Count; index++)
                {
                    var debugItem = debugState.Inputs[index];
                    var tableRow = table.Rows[index];
                    var variable = tableRow["Variable"];
                    var value = tableRow["value"];
                    var label = tableRow["label"];
                    var operater = tableRow["operater"];
                    var debugItemResult = debugItem.ResultsList.FirstOrDefault();
                    if (debugItemResult != null)
                    {
                        Assert.AreEqual((object)value, debugItemResult.Value);
                        Assert.AreEqual(variable, debugItemResult.Variable);
                        Assert.AreEqual(label, debugItemResult.Label);
                        Assert.AreEqual(operater, debugItemResult.Operator);
                    }
                }
            }
        }

        [Then(@"the dotnetdll ""(.*)"" in ""(.*)"" in step (.*) for ""(.*)"" debug output as")]
        public void ThenTheDotnetdllInInStepForDebugOutputAs(string toolName, string sequenceName, int stepNumber, string forEachName, Table table)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);

            var debugStates = Get<List<IDebugState>>("debugStates").ToList();
            var workflowId = debugStates.First(wf => wf.DisplayName.Equals(forEachName)).ID;

            if (parentWorkflowName == forEachName)
            {
                workflowId = Guid.Empty;
            }

            var sequenceDebug = debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == workflowId).ToList();
            Assert.IsTrue(sequenceDebug.Count >= stepNumber);

            var sequenceId = sequenceDebug[stepNumber - 1].ID;
            var sequenceIsInForEach = sequenceDebug.Any(state => state.ID == sequenceId);
            Assert.IsTrue(sequenceIsInForEach);

            var toolSpecificDebug =
                debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == sequenceId && ds.DisplayName.Equals(toolName)).ToList();
            Assert.IsNotNull(toolSpecificDebug);
            var debugState = toolSpecificDebug.FirstOrDefault();
            if (debugState != null)
            {
                for (int index = 0; index < debugState.Outputs.Count; index++)
                {
                    var debugItem = debugState.Outputs[index];
                    var tableRow = table.Rows[index];
                    var variable = tableRow["Variable"];
                    var value = tableRow["value"];
                    var operater = tableRow["operater"];
                    var debugItemResult = debugItem.ResultsList.FirstOrDefault();
                    if (debugItemResult != null)
                    {
                        Assert.AreEqual((object)value, debugItemResult.Value);
                        Assert.AreEqual(variable, debugItemResult.Variable);
                        Assert.AreEqual(operater, debugItemResult.Operator);
                    }
                }
            }
        }


        [Then(@"the ""(.*)"" in '(.*)' in step (.*) for ""(.*)"" debug outputs as")]
        public void ThenTheInInStepForDebugOutputsAs(string toolName, string sequenceName, int stepNumber, string forEachName, Table table)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);

            var debugStates = Get<List<IDebugState>>("debugStates").ToList();
            var workflowId = debugStates.First(wf => wf.DisplayName.Equals(forEachName)).ID;

            if (parentWorkflowName == forEachName)
            {
                workflowId = Guid.Empty;
            }

            var sequenceDebug = debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == workflowId).ToList();
            Assert.IsTrue(sequenceDebug.Count >= stepNumber);

            var sequenceId = sequenceDebug[stepNumber - 1].ID;
            var sequenceIsInForEach = sequenceDebug.Any(state => state.ID == sequenceId);
            Assert.IsTrue(sequenceIsInForEach);

            var toolSpecificDebug =
                debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == sequenceId && ds.DisplayName.Equals(toolName)).ToList();

            _commonSteps.ThenTheDebugInputsAs(table, toolSpecificDebug
                                                    .SelectMany(item => item.Outputs)
                                                    .SelectMany(item => item.ResultsList).ToList());
        }


        IDebugState DebugToUse(int stepNumber, List<IDebugState> toolSpecificDebug)
        {
            var debugToUse = toolSpecificDebug[stepNumber - 1];
            return debugToUse;
        }




        [Then(@"Workflow ""(.*)"" has errors")]
        public void ThenWorkflowHasErrors(string workFlowName, Table table)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);

            var debugStates = Get<List<IDebugState>>("debugStates").ToList();
            var toolSpecificDebug = debugStates.Last(wf => wf.DisplayName.Equals(workFlowName));
            foreach (var tableRow in table.Rows)
            {
                var strings = toolSpecificDebug.ErrorMessage.Replace("\n", ",").Replace("\r", "").Split(',');
                var predicate = tableRow["Error"];
                var first = strings.First(p => p == predicate);
                Assert.IsFalse(string.IsNullOrEmpty(first));
            }
        }


        [Then(@"the ""(.*)"" in step (.*) for ""(.*)"" debug outputs as")]
        public void ThenTheInStepForDebugOutputsAs(string toolName, int stepNumber, string forEachName, Table table)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);

            var debugStates = Get<List<IDebugState>>("debugStates").ToList();
            var workflowId = debugStates.First(wf => wf.DisplayName.Equals(forEachName)).ID;

            if (parentWorkflowName == forEachName)
            {
                workflowId = Guid.Empty;
            }

            var toolSpecificDebug =
                debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == workflowId && ds.DisplayName.Equals(toolName)).ToList();
            Assert.IsTrue(toolSpecificDebug.Count >= stepNumber);
            var debugToUse = DebugToUse(stepNumber, toolSpecificDebug);


            var outputDebugItems = debugToUse.Outputs
                .SelectMany(s => s.ResultsList).ToList();
            _commonSteps.ThenTheDebugOutputAs(table, outputDebugItems);
        }

        [Given(@"""(.*)"" contains a ""(.*)"" service ""(.*)"" with mappings")]
        public void GivenContainsADatabaseServiceWithMappings(string wf, string serviceType, string serviceName, Table table)
        {
            var environmentModel = ServerRepository.Instance.Source;
            var repository = new ResourceRepository(environmentModel);
            repository.Load(false);
            var resource = repository.FindSingle(r => r.ResourceName.Equals(serviceName), true, true);
            if (resource == null)
            {
                throw new Exception("Local Warewolf service " + serviceName + " not found.");
            }
            var activity = GetServiceActivity(serviceType);
            if (activity != null)
            {
                var outputSb = GetOutputMapping(table, resource);
                var inputSb = GetInputMapping(table, resource);
                var outputMapping = outputSb.ToString();
                var inputMapping = inputSb.ToString();
                resource.Outputs = outputMapping;
                resource.Inputs = inputMapping;
                resource.ResourceType = ResourceType.Service;
                activity.ResourceID = resource.ID;
                activity.ServiceName = resource.ResourceName;
                activity.DisplayName = serviceName;
                activity.OutputMapping = outputMapping;
                activity.InputMapping = inputMapping;

                if (resource.ServerResourceType == "DbService")
                {
                    var xml = resource.ToServiceDefinition(true).ToXElement();
                    var service = new DbService(xml);
                    Activity updatedActivity = null;
                    switch (serviceType)
                    {
                        case "mysql database":
                            updatedActivity = ActivityUtils.GetDsfMySqlDatabaseActivity((DsfDatabaseActivity)activity, source, service);
                            break;
                        case "sqlserver database":
                            updatedActivity = ActivityUtils.GetDsfSqlServerDatabaseActivity((DsfDatabaseActivity)activity, service, source);
                            break;
                        case "postgresql database":
                            updatedActivity = ActivityUtils.GetDsfPostgreSqlActivity((DsfDatabaseActivity)activity, service, source);
                            break;
                        default:
                            break;
                    }
                    _commonSteps.AddActivityToActivityList(wf, serviceName, updatedActivity);
                }
                else if (resource.ServerResourceType == "WebService")
                {
                    var updatedActivity = new WebGetActivity();
                    var xml = resource.ToServiceDefinition(true).ToXElement();
                    var service = new WebService(xml);
                    updatedActivity.Headers = new List<INameValue>();
                    service.Headers?.AddRange(service.Headers);
                    updatedActivity.OutputDescription = service.OutputDescription;
                    updatedActivity.QueryString = service.RequestUrl;
                    updatedActivity.Inputs = ActivityUtils.TranslateInputMappingToInputs(inputMapping);
                    updatedActivity.Outputs = ActivityUtils.TranslateOutputMappingToOutputs(outputMapping);
                    updatedActivity.DisplayName = serviceName;

                    if (service.Source is DbSource source)
                    {
                        updatedActivity.SourceId = source.ResourceID;
                    }
                    _commonSteps.AddActivityToActivityList(wf, serviceName, updatedActivity);
                }
                else
                {
                    _commonSteps.AddActivityToActivityList(wf, serviceName, activity);
                }
            }
        }

        [Given(@"""(.*)"" contains ""(.*)"" from server ""(.*)"" with mapping as")]
        public void GivenContainsFromServerWithMappingAs(string wf, string remoteWf, string server, Table mappings)
        {
            if (_containerOps == null)
            {
                if (server == "Remote Connection Integration")
                {
                    _containerOps = new Depends(Depends.ContainerType.CIRemote, true);
                }
                else if (remoteWf == "TestSqlReturningXml" || remoteWf == "TestSqlExecutesOnce")
                {
                    _containerOps = new Depends(Depends.ContainerType.MSSQL, true);
                }
                else if (remoteWf == "RabbitMQTest")
                {
                    _containerOps = new Depends(Depends.ContainerType.RabbitMQ, true);
                }
            }

            var localHostEnv = LocalEnvModel;

            EnsureEnvironmentConnected(localHostEnv, EnvironmentConnectionTimeout);

            if (server == "localhost" && remoteWf == "TestmySqlReturningXml")
            {
                _containerOps = new Depends(Depends.ContainerType.MySQL, true);
            }

            var remoteEnvironment = ServerRepository.Instance.FindSingle(model => model.Name == server);
            if (remoteEnvironment == null)
            {
                var environments = ServerRepository.Instance.LookupEnvironments(localHostEnv);
                remoteEnvironment = environments.FirstOrDefault(model => model.Name == server);
            }
            if (remoteEnvironment != null)
            {
                if (server == "Remote Connection Integration")
                {
                    remoteEnvironment.Connection = new ServerProxy(
                        $"http://{_containerOps.Container.IP}:{_containerOps.Container.Port}", "\\","");
                }

                EnsureEnvironmentConnected(remoteEnvironment, EnvironmentConnectionTimeout);
                if (!remoteEnvironment.HasLoadedResources)
                {
                    remoteEnvironment.ForceLoadResources();
                }
                var splitNameAndCat = remoteWf.Split('/');
                var resName = splitNameAndCat[splitNameAndCat.Length - 1];
                var remoteResourceModel = remoteEnvironment.ResourceRepository.FindSingle(model => model.ResourceName == resName
                                                                         || model.Category == remoteWf.Replace('/', '\\'), true);

                if (remoteResourceModel == null)
                {
                    remoteEnvironment.LoadResources();
                    remoteResourceModel = remoteEnvironment.ResourceRepository.FindSingle(model => model.ResourceName == resName
                                                                         || model.Category == remoteWf.Replace('/', '\\'), true);
                }
                if (remoteResourceModel != null)
                {
                    var dataMappingViewModel = GetDataMappingViewModel(remoteResourceModel, mappings);

                    var inputMapping = dataMappingViewModel.GetInputString(dataMappingViewModel.Inputs);
                    var outputMapping = dataMappingViewModel.GetOutputString(dataMappingViewModel.Outputs);

                    var activity = new DsfWorkflowActivity();

                    remoteResourceModel.Outputs = outputMapping;
                    remoteResourceModel.Inputs = inputMapping;
                    var remoteServerId = remoteEnvironment.EnvironmentID;
                    activity.ServiceServer = remoteServerId;
                    activity.EnvironmentID = remoteServerId;

                    activity.IsWorkflow = true;
                    if (remoteServerId != Guid.Empty)
                    {
                        activity.ServiceUri = remoteEnvironment.Connection.AppServerUri.ToString();
                        activity.IsWorkflow = false;
                    }

                    activity.ResourceID = remoteResourceModel.ID;
                    activity.ServiceName = remoteResourceModel.Category;
                    activity.DisplayName = remoteWf;
                    activity.OutputMapping = outputMapping;
                    activity.InputMapping = inputMapping;
                    _commonSteps.AddActivityToActivityList(wf, remoteWf, activity);
                }
                else
                {
                    throw new Exception($"Remote Warewolf service {remoteWf} not found on server {server}.");
                }
            }
            else
            {
                throw new Exception($"Remote server {server} not found");
            }
        }

        DataMappingViewModel GetDataMappingViewModel(IResourceModel remoteResourceModel, Table mappings)
        {
            var webActivity = new WebActivity { ResourceModel = remoteResourceModel as ResourceModel };
            var dataMappingViewModel = new DataMappingViewModel(webActivity);
            foreach (var inputOutputViewModel in dataMappingViewModel.Inputs)
            {
                inputOutputViewModel.Value = "";
                inputOutputViewModel.RecordSetName = "";
                inputOutputViewModel.Name = "";
                inputOutputViewModel.MapsTo = "";
            }

            foreach (var inputOutputViewModel in dataMappingViewModel.Outputs)
            {
                inputOutputViewModel.Value = "";
                inputOutputViewModel.RecordSetName = "";
                inputOutputViewModel.Name = "";
            }
            foreach (var tableRow in mappings.Rows)
            {
                tableRow.TryGetValue("Output from Service", out string output);
                tableRow.TryGetValue("To Variable", out string toVariable);
                if (!string.IsNullOrEmpty(output) && !string.IsNullOrEmpty(toVariable))
                {
                    var inputOutputViewModel = dataMappingViewModel.Outputs.FirstOrDefault(model => model.DisplayName == output);
                    if (inputOutputViewModel != null)
                    {
                        inputOutputViewModel.Value = toVariable;
                        if (DataListUtil.IsValueRecordset(output))
                        {
                            inputOutputViewModel.RecordSetName = DataListUtil.ExtractRecordsetNameFromValue(output);
                            inputOutputViewModel.Name = DataListUtil.ExtractFieldNameFromValue(output);
                        }
                        else
                        {
                            inputOutputViewModel.Name = output;
                        }
                        inputOutputViewModel.RecordSetName = DataListUtil.ExtractRecordsetNameFromValue(output);
                        _commonSteps.AddVariableToVariableList(toVariable);
                    }
                }

                tableRow.TryGetValue("Input to Service", out string input);
                tableRow.TryGetValue("From Variable", out string fromVariable);

                if (!string.IsNullOrEmpty(input) && !string.IsNullOrEmpty(fromVariable))
                {
                    var inputOutputViewModel = dataMappingViewModel.Inputs.FirstOrDefault(model => model.DisplayName == input);
                    if (inputOutputViewModel != null)
                    {
                        inputOutputViewModel.MapsTo = fromVariable;

                        if (DataListUtil.IsValueRecordset(input))
                        {
                            inputOutputViewModel.RecordSetName = DataListUtil.ExtractRecordsetNameFromValue(input);
                            inputOutputViewModel.Name = DataListUtil.ExtractFieldNameFromValue(input);
                        }
                        else
                        {
                            inputOutputViewModel.Name = input;
                        }
                        inputOutputViewModel.Value = input;
                        _commonSteps.AddVariableToVariableList(fromVariable);
                    }
                }

            }
            return dataMappingViewModel;
        }

        DsfActivity GetServiceActivity(string serviceType)
        {
            DsfActivity activity = null;
            switch (serviceType)
            {
                case "mysql database":
                    activity = new DsfDatabaseActivity();
                    break;
                case "sqlserver database":
                    activity = new DsfDatabaseActivity();
                    break;
                case "oracle database":
                    activity = new DsfDatabaseActivity();
                    break;
                case "odbc database":
                    activity = new DsfDatabaseActivity();
                    break;
                case "postgresql database":
                    activity = new DsfDatabaseActivity();
                    break;
                case "plugin":
                    activity = new DsfPluginActivity();
                    break;
                case "workflow":
                    activity = new DsfWorkflowActivity();
                    break;
                default:
                    break;
            }
            return activity;
        }

        StringBuilder GetOutputMapping(Table table, IResourceModel resource)
        {
            var outputSb = new StringBuilder();
            outputSb.Append("<Outputs>");

            foreach (var tableRow in table.Rows)
            {
                var output = tableRow["Output from Service"];
                var toVariable = tableRow["To Variable"];

                _commonSteps.AddVariableToVariableList(toVariable);

                if (resource != null)
                {

                    var outputs = XDocument.Parse(resource.Outputs);

                    string recordsetName;
                    string fieldName;

                    if (DataListUtil.IsValueRecordset(output))
                    {
                        recordsetName = DataListUtil.ExtractRecordsetNameFromValue(output);
                        fieldName = DataListUtil.ExtractFieldNameFromValue(output);
                    }
                    else
                    {
                        recordsetName = fieldName = output;
                    }

                    var element = (from elements in outputs.Descendants("Output")
                                   where string.Equals((string)elements.Attribute("RecordsetAlias"), recordsetName, StringComparison.InvariantCultureIgnoreCase) &&
                                         string.Equals((string)elements.Attribute("OriginalName"), fieldName, StringComparison.InvariantCultureIgnoreCase)
                                   select elements).SingleOrDefault();

                    element?.SetAttributeValue("Value", toVariable);

                    outputSb.Append(element);
                }
            }

            outputSb.Append("</Outputs>");
            return outputSb;
        }

        [Given(@"'(.*)' in ""(.*)"" contains Data Merge ""(.*)"" into ""(.*)"" as")]
        public void GivenInContainsDataMergeIntoAs(string sequenceName, string forEachName, string activityName, string resultVariable, Table table)
        {
            var activity = new DsfDataMergeActivity { Result = resultVariable, DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var variable = tableRow["Variable"];
                var type = tableRow["Type"];
                var at = tableRow["Using"];
                var padding = tableRow["Padding"];
                var alignment = tableRow["Alignment"];

                activity.MergeCollection.Add(new DataMergeDTO(variable, type, at, 1, padding, alignment, true));
            }
            _commonSteps.AddVariableToVariableList(resultVariable);
            AddActivityToSequenceInsideForEach(sequenceName, forEachName, activity);
        }

        void AddActivityToSequenceInsideForEach(string sequenceName, string forEachName, Activity activity)
        {

            var activityList = _commonSteps.GetActivityList();
            if (activityList[forEachName] is DsfForEachActivity forEachActivity)
            {
                if (forEachActivity.DataFunc.Handler is DsfSequenceActivity sequenceActivity && sequenceActivity.DisplayName == sequenceName)
                {
                    sequenceActivity.Activities.Add(activity);
                }
            }
        }

        [Given(@"'(.*)' in ""(.*)"" contains Gather System Info ""(.*)"" as")]
        public void GivenInContainsGatherSystemInfoAs(string sequenceName, string forEachName, string activityName, Table table)
        {
            var activity = new DsfGatherSystemInformationActivity { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var variable = tableRow["Variable"];

                _commonSteps.AddVariableToVariableList(variable);

                var systemInfo = (enTypeOfSystemInformationToGather)Dev2EnumConverter.GetEnumFromStringDiscription(tableRow["Selected"], typeof(enTypeOfSystemInformationToGather));
                activity.SystemInformationCollection.Add(new GatherSystemInformationTO(systemInfo, variable, 1));
            }

            AddActivityToSequenceInsideForEach(sequenceName, forEachName, activity);
        }

        StringBuilder GetInputMapping(Table table, IResourceModel resource)
        {
            var inputSb = new StringBuilder();
            inputSb.Append("<Inputs>");

            foreach (var tableRow in table.Rows)
            {
                var input = tableRow["Input to Service"];
                var fromVariable = tableRow["From Variable"];

                _commonSteps.AddVariableToVariableList(fromVariable);

                if (resource != null)
                {
                    var inputs = XDocument.Parse(resource.Inputs);

                    string recordsetName;
                    XElement element;
                    if (DataListUtil.IsValueRecordset(input))
                    {
                        recordsetName = DataListUtil.ExtractRecordsetNameFromValue(input);
                        var fieldName = DataListUtil.ExtractFieldNameFromValue(input);

                        element = (from elements in inputs.Descendants("Input")
                                   where string.Equals((string)elements.Attribute("Recordset"), recordsetName, StringComparison.InvariantCultureIgnoreCase) &&
                                         string.Equals((string)elements.Attribute("OriginalName"), fieldName, StringComparison.InvariantCultureIgnoreCase)
                                   select elements).SingleOrDefault();

                        element?.SetAttributeValue("Value", fromVariable);

                        inputSb.Append(element);
                    }
                    else
                    {
                        recordsetName = input;

                        element = (from elements in inputs.Descendants("Input")
                                   where string.Equals((string)elements.Attribute("Name"), recordsetName, StringComparison.InvariantCultureIgnoreCase)
                                   select elements).SingleOrDefault();

                        element?.SetAttributeValue("Source", fromVariable);
                    }

                    if (element != null)
                    {
                        inputSb.Append(element);
                    }
                }
            }

            inputSb.Append("</Inputs>");
            return inputSb;
        }

        [When(@"""(.*)"" is the active environment used to execute ""(.*)""")]
        public void WhenIsTheActiveEnvironmentUsedToExecute(string connectionName, string workflowName)
        {
            TryGetValue(workflowName, out IContextualResourceModel resourceModel);
            TryGetValue("environment", out IServer server);
            TryGetValue("resourceRepo", out IResourceRepository repository);

            ExecuteWorkflow(resourceModel);
        }

        [When(@"the workflow is Saved")]
        private IContextualResourceModel SaveTheWorkflow() => SaveAWorkflow(null);

        [When(@"""(.*)"" is Saved")]
        private IContextualResourceModel SaveAWorkflow(string parentName)
        {
            TryGetValue("parentWorkflowName", out string parentWorkflowName);
            var workflowName = string.IsNullOrEmpty(parentWorkflowName) ? parentName : parentWorkflowName;

            Get<List<IDebugState>>("debugStates").Clear();
            BuildDataList();

            var activityList = _commonSteps.GetActivityList();

            var flowSteps = new List<FlowStep>();

            TestStartNode = new FlowStep();
            flowSteps.Add(TestStartNode);
            if (activityList != null)
            {
                foreach (var activity in activityList)
                {
                    if (activity.Value is DsfDecision dec)
                    {
                        var decConfig = Get<(string TrueArm, string FalseArm)>(dec.DisplayName);
                        var trueArmToolName = decConfig.TrueArm;
                        var falseArmToolName = decConfig.FalseArm;
                        dec.TrueArm = new List<IDev2Activity> { activityList.FirstOrDefault(act => act.Key == trueArmToolName).Value as IDev2Activity };
                        dec.FalseArm = new List<IDev2Activity> { activityList.FirstOrDefault(act => act.Key == falseArmToolName).Value as IDev2Activity };
                    }
                    if (TestStartNode.Action == null)
                    {
                        TestStartNode.Action = activity.Value;
                    }
                    else
                    {
                        var flowStep = new FlowStep { Action = activity.Value };
                        flowSteps.Last().Next = flowStep;
                        flowSteps.Add(flowStep);
                    }
                }
            }
            TryGetValue(workflowName, out IContextualResourceModel resourceModel);
            TryGetValue("environment", out IServer server);
            TryGetValue("resourceRepo", out IResourceRepository repository);

            var currentDl = CurrentDl;
            resourceModel.DataList = currentDl.Replace("root", "DataList");
            var helper = new WorkflowHelper();
            var xamlDefinition = helper.GetXamlDefinition(FlowchartActivityBuilder);
            resourceModel.WorkflowXaml = xamlDefinition;

            repository.Save(resourceModel);
            repository.SaveToServer(resourceModel);

            return resourceModel;
        }


        [Given(@"the ""(.*)"" in WorkFlow ""(.*)"" debug inputs as")]
        [When(@"the ""(.*)"" in WorkFlow ""(.*)"" debug inputs as")]
        [Then(@"the ""(.*)"" in WorkFlow ""(.*)"" debug inputs as")]
        public void ThenTheInWorkFlowDebugInputsAs(string toolName, string workflowName, Table table)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);
            var debugStates = Get<List<IDebugState>>("debugStates").ToList();
            var workflowId = Guid.Empty;

            if (parentWorkflowName != workflowName)
            {
                if (toolName != null && workflowName != null)
                {
                    workflowId = debugStates.First(wf => wf.DisplayName.Equals(workflowName)).ID;
                }
                else
                {
                    throw new InvalidOperationException("SpecFlow broke.");
                }
            }

            var toolSpecificDebug =
                debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == workflowId && ds.DisplayName.Equals(toolName)).ToList();

            _commonSteps.ThenTheDebugInputsAs(table, toolSpecificDebug.Distinct()
                                                    .SelectMany(s => s.Inputs)
                                                    .SelectMany(s => s.ResultsList).ToList());
        }

        [Given(@"the tool ""(.*)"" with Guid of ""(.*)"" in WorkFlow ""(.*)"" debug inputs as")]
        [When(@"the tool ""(.*)"" with Guid of ""(.*)"" in WorkFlow ""(.*)"" debug inputs as")]
        [Then(@"the tool ""(.*)"" with Guid of ""(.*)"" in WorkFlow ""(.*)"" debug inputs as")]
        public void ThenTheToolWithGuidOfInWorkFlowDebugInputsAs(string toolName, string toolGuid, string workflowName, Table table)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);
            var debugStates = Get<List<IDebugState>>("debugStates").ToList();
            var workflowId = Guid.Empty;

            if (parentWorkflowName != workflowName)
            {
                if (workflowName != null)
                {
                    workflowId = debugStates.First(wf => wf.DisplayName.Equals(workflowName)).ID;
                }
                else
                {
                    throw new InvalidOperationException("Could not find workflow.");
                }
            }

            var toolSpecificDebug = debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == workflowId &&
                                                            GetMatchingNames(toolName, ds.DisplayName) &&
                                                            ds.ID.Equals(Guid.Parse(toolGuid))).ToList();

            _commonSteps.ThenTheDebugInputsAs(table, toolSpecificDebug.Distinct()
                                                    .SelectMany(s => s.Inputs)
                                                    .SelectMany(s => s.ResultsList).ToList());
        }

        [Then(@"the ""(.*)"" has a start and end duration")]
        public void ThenTheHasAStartAndEndDuration(string workflowName)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);
            var debugStates = Get<List<IDebugState>>("debugStates").ToList();

            var end = debugStates.First(wf => wf.Name.Equals("End"));
            Assert.IsTrue(end.Duration.Ticks > 0, "Workflow debug output end step duration of " + end.Duration.Ticks + " ticks is less than or equal to 0 ticks. All workflows no matter how simple do take some time to execute.");
        }

        [Then(@"""(.*)"" Duration is less or equal to (.*) seconds")]
        [Given(@"""(.*)"" Duration is less or equal to (.*) seconds")]
        [When(@"""(.*)"" Duration is less or equal to (.*) seconds")]
        public void ThenDurationIsLessOrEqualToSeconds(string workflowName, int duration)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);
            var debugStates = Get<List<IDebugState>>("debugStates").ToList();

            var end = debugStates.First(wf => wf.Name.Equals("End"));
            Assert.IsTrue(end.Duration.Ticks > 0);
            var condition = end.Duration.Seconds <= duration;
            Assert.IsTrue(condition);
        }

        [Then(@"""(.*)"" Duration is greater or equal to (.*) seconds")]
        [When(@"""(.*)"" Duration is greater or equal to (.*) seconds")]
        [Given(@"""(.*)"" Duration is greater or equal to (.*) seconds")]
        public void ThenDurationIsGreaterOrEqualToSeconds(string workflowName, int duration)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);
            var debugStates = Get<List<IDebugState>>("debugStates").ToList();
            var end = debugStates.First(wf => wf.Name.Equals("End"));
            Assert.IsTrue(end.Duration.Ticks > 0);
            var condition = end.Duration.Seconds >= duration;
            Assert.IsTrue(condition);
        }




        [Then(@"the nested ""(.*)"" in WorkFlow ""(.*)"" debug inputs as")]
        public void ThenTheNestedInWorkFlowDebugInputsAs(string toolName, string workflowName, Table table)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);
            var debugStates = Get<List<IDebugState>>("debugStates").ToList();

            var toolSpecificDebug =
                debugStates.Where(ds => ds.DisplayName.Equals(toolName)).ToList();

            _commonSteps.ThenTheDebugInputsAs(table, toolSpecificDebug
                                                    .SelectMany(s => s.Inputs)
                                                    .SelectMany(s => s.ResultsList).ToList());
        }

        [Then(@"the ""(.*)"" in WorkFlow ""(.*)"" has  ""(.*)"" nested children")]
        public void ThenTheInWorkFlowHasNestedChildren(string toolName, string workflowName, int count)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);
            var debugStates = Get<List<IDebugState>>("debugStates").ToList();

            var id =
                debugStates.Where(ds => ds.DisplayName.Equals(toolName)).ToList().Select(a => a.ID).First();
            var children = debugStates.Count(a => a.ParentID.GetValueOrDefault() == id);
            Assert.AreEqual(count, children, String.Join(", ", debugStates.Select(val => val.DisplayName)));
        }

        [Then(@"the ""(.*)"" in WorkFlow ""(.*)"" has at least ""(.*)"" nested children")]
        public void ThenTheInWorkFlowHasAtLeastNestedChildren(string toolName, string workflowName, int count)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);
            var debugStates = Get<List<IDebugState>>("debugStates").ToList();

            var id =
                debugStates.Where(ds => ds.DisplayName.Equals(toolName)).ToList().Select(a => a.ID).First();
            var children = debugStates.Count(a => a.ParentID.GetValueOrDefault() == id);
            Assert.IsTrue(children >= count, $"Not enough children nested inside {toolName} in {workflowName}'s debug output");
        }

        [Then(@"each ""(.*)"" contains debug outputs for ""(.*)"" as")]
        public void ThenEachContainsDebugOutputsForAs(string toolName, string nestedToolName, Table table)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);
            var debugStates = Get<List<IDebugState>>("debugStates").ToList();

            var id = debugStates.Where(ds => ds.DisplayName.Equals("DsfActivity")).ToList();
            id.ForEach(x => Assert.AreEqual(1, debugStates.Count(a => a.ParentID.GetValueOrDefault() == x.ID && a.DisplayName == nestedToolName)));
        }

        T Get<T>(string keyName)
        {
            return _scenarioContext.Get<T>(keyName);
        }

        void TryGetValue<T>(string keyName, out T value)
        {
            _scenarioContext.TryGetValue(keyName, out value);
        }

        [Then(@"the ""(.*)"" in Workflow ""(.*)"" has a debug Server Name of """"(.*)""""")]
        public void ThenTheInWorkflowHasADebugServerNameOf(string toolName, string workflowName, string remoteName)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);

            var debugStates = Get<List<IDebugState>>("debugStates").ToList();
            var workflowId = debugStates.First(wf => wf.DisplayName.Equals(workflowName)).ID;

            if (parentWorkflowName == workflowName)
            {
                workflowId = Guid.Empty;
            }

            var toolSpecificDebug =
                debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == workflowId && ds.DisplayName.Equals(toolName)).ToList();

            Assert.IsTrue(toolSpecificDebug.All(a => a.Server == remoteName));
            Assert.IsTrue(debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == workflowId && !ds.DisplayName.Equals(toolName)).All(a => a.Server == "localhost"));
        }

        [Then(@"the ""(.*)"" in Workflow ""(.*)"" debug outputs is")]
        public void ThenTheInWorkflowDebugOutputsIs(string p0, string p1, Table table)
        {
            ThenTheInWorkflowDebugOutputsAs(p0, p1, table);
        }

        [Given(@"the ""(.*)"" in Workflow ""(.*)"" debug outputs as")]
        [When(@"the ""(.*)"" in Workflow ""(.*)"" debug outputs as")]
        [Then(@"the ""(.*)"" in Workflow ""(.*)"" debug outputs as")]
        public void ThenTheInWorkflowDebugOutputsAs(string toolName, string workflowName, Table table)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);

            var debugStates = Get<List<IDebugState>>("debugStates");
            var workflowId = Guid.Empty;

            if (parentWorkflowName != workflowName)
            {
                if (toolName != null && workflowName != null)
                {
                    IDebugState debugState = debugStates.FirstOrDefault(wf => wf.DisplayName.Equals(workflowName));
                    if (debugState != null)
                    {
                        workflowId = debugState.ID;
                    }
                    else
                    {
                        var errors = debugStates.Where(wf => wf.ErrorMessage != "");
                        var errorsMessage = "";
                        if (errors.Any())
                        {
                            errorsMessage = " There were one or more errors found in other tools on the same workflow though: " + string.Join(", ", errors.Select(wf => wf.ErrorMessage).Distinct().ToArray());
                        }
                        Assert.Fail($"Debug output for {toolName} not found in {workflowName}.{errorsMessage}");
                    }
                }
                else
                {
                    throw new InvalidOperationException("SpecFlow broke.");
                }
            }

            var toolSpecificDebug =
                debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == workflowId && ds.DisplayName.Equals(toolName)).ToList();
            if (!toolSpecificDebug.Any())
            {
                toolSpecificDebug =
                debugStates.Where(ds => ds.DisplayName.Equals(toolName)).ToList();
            }
            // Data Merge breaks our debug scheme, it only ever has 1 value, not the expected 2 ;)
            var isDataMergeDebug = toolSpecificDebug.Count == 1 && toolSpecificDebug.Any(t => t.Name == "Data Merge");
            IDebugState outputState;
            if (toolSpecificDebug.Count > 1 && toolSpecificDebug.Any(state => state.StateType == StateType.End))
            {
                outputState = toolSpecificDebug.FirstOrDefault(state => state.StateType == StateType.End);
            }
            else
            {
                outputState = toolSpecificDebug.FirstOrDefault();
            }

            if (outputState?.Outputs != null)
            {
                var SelectResults = outputState.Outputs.SelectMany(s => s.ResultsList);
                if (SelectResults != null && SelectResults.ToList() != null)
                {
                    _commonSteps.ThenTheDebugOutputAs(table, SelectResults.ToList(), isDataMergeDebug);
                    return;
                }
                Assert.Fail(outputState.Outputs.ToList() + " debug outputs found on " + workflowName + " does not include " + toolName + ".");
            }
            Assert.Fail("No debug output found for " + workflowName + ".");
        }


        [Given(@"the ""(.*)"" in Workflow ""(.*)"" unsorted debug outputs as")]
        [When(@"the ""(.*)"" in Workflow ""(.*)"" unsorted debug outputs as")]
        [Then(@"the ""(.*)"" in Workflow ""(.*)"" unsorted debug outputs as")]
        public void ThenTheInWorkflowUnsortedDebugOutputsAs(string toolName, string workflowName, Table table)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);

            var debugStates = Get<List<IDebugState>>("debugStates");
            var workflowId = Guid.Empty;

            if (parentWorkflowName != workflowName)
            {
                if (toolName != null && workflowName != null)
                {
                    IDebugState debugState = debugStates.FirstOrDefault(wf => wf.DisplayName.Equals(workflowName));
                    if (debugState != null)
                    {
                        workflowId = debugState.ID;
                    }
                    else
                    {
                        var errors = debugStates.Where(wf => wf.ErrorMessage != "");
                        var errorsMessage = "";
                        if (errors != null)
                        {
                            errorsMessage = " There were one or more errors found in other tools on the same workflow though: " + string.Join(", ", errors.Select(wf => wf.ErrorMessage).Distinct().ToArray());
                        }
                        Assert.Fail($"Debug output for {toolName} not found in {workflowName}.{errorsMessage}");
                    }
                }
                else
                {
                    throw new InvalidOperationException("SpecFlow broke.");
                }
            }

            var toolSpecificDebug =
                debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == workflowId && ds.DisplayName.Equals(toolName)).ToList();
            if (!toolSpecificDebug.Any())
            {
                toolSpecificDebug =
                debugStates.Where(ds => ds.DisplayName.Equals(toolName)).ToList();
            }
            // Data Merge breaks our debug scheme, it only ever has 1 value, not the expected 2 ;)
            var isDataMergeDebug = toolSpecificDebug.Count == 1 && toolSpecificDebug.Any(t => t.Name == "Data Merge");
            IDebugState outputState;
            if (toolSpecificDebug.Count > 1 && toolSpecificDebug.Any(state => state.StateType == StateType.End))
            {
                outputState = toolSpecificDebug.FirstOrDefault(state => state.StateType == StateType.End);
            }
            else
            {
                outputState = toolSpecificDebug.FirstOrDefault();
            }

            if (outputState?.Outputs != null)
            {
                var SelectResults = outputState.Outputs.SelectMany(s => s.ResultsList);
                if (SelectResults != null && SelectResults.ToList() != null)
                {
                    _commonSteps.ThenTheDebugOutputAs(table, SelectResults.ToList(), isDataMergeDebug, true);
                    return;
                }
                Assert.Fail(outputState.Outputs.ToList() + " debug outputs found on " + workflowName + " does not include " + toolName + ".");
            }
            Assert.Fail("No debug output found for " + workflowName + ".");
        }


        [Then(@"the tool ""(.*)"" with Guid of ""(.*)"" in Workflow ""(.*)"" debug outputs as")]
        public void ThenTheToolWithGuidOfInWorkflowDebugOutputsAs(string toolName, string toolGuid, string workflowName, Table table)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);

            var debugStates = Get<List<IDebugState>>("debugStates");
            var workflowId = Guid.Empty;

            if (parentWorkflowName != workflowName)
            {
                if (workflowName != null)
                {
                    var debugState = debugStates.FirstOrDefault(wf => wf.DisplayName.Equals(workflowName));
                    if (debugState != null)
                    {
                        workflowId = debugState.ID;
                    }
                    else
                    {
                        var errors = debugStates.Where(wf => wf.ErrorMessage != "");
                        var errorsMessage = "";
                        if (errors != null)
                        {
                            errorsMessage = " There were one or more errors found in other tools on the same workflow though: " + string.Join(", ", errors.Select(wf => wf.ErrorMessage).Distinct().ToArray());
                        }
                        Assert.Fail($"Debug output for {toolName} not found in {workflowName}.{errorsMessage}");
                    }
                }
                else
                {
                    throw new InvalidOperationException("Could not find workflow.");
                }
            }

            var toolSpecificDebug = debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == workflowId &&
                                                            GetMatchingNames(toolName, ds.DisplayName) &&
                                                            ds.ID.Equals(Guid.Parse(toolGuid))).ToList();
            if (!toolSpecificDebug.Any())
            {
                toolSpecificDebug = debugStates.Where(ds => ds.DisplayName.Equals(toolName)).ToList();
            }
            // Data Merge breaks our debug scheme, it only ever has 1 value, not the expected 2 ;)
            var isDataMergeDebug = toolSpecificDebug.Count == 1 && toolSpecificDebug.Any(t => t.Name == "Data Merge");
            IDebugState outputState;
            if (toolSpecificDebug.Count > 1 && toolSpecificDebug.Any(state => state.StateType == StateType.End))
            {
                outputState = toolSpecificDebug.FirstOrDefault(state => state.StateType == StateType.End);
            }
            else
            {
                outputState = toolSpecificDebug.FirstOrDefault();
            }

            if (outputState?.Outputs != null)
            {
                var SelectResults = outputState.Outputs.SelectMany(s => s.ResultsList);
                if (SelectResults != null && SelectResults.ToList() != null)
                {
                    _commonSteps.ThenTheDebugOutputAs(table, SelectResults.ToList(), isDataMergeDebug);
                    return;
                }
                Assert.Fail(outputState.Outputs.ToList() + " debug outputs found on " + workflowName + " does not include " + toolName + ".");
            }
            Assert.Fail("No debug output found for " + workflowName + ".");
        }

        [Then(@"the ""(.*)"" in Workflow ""(.*)"" debug output contains as")]
        public void ThenTheInWorkflowDebugOutputContainsAs(string toolName, string workflowName, Table table)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);

            var debugStates = Get<List<IDebugState>>("debugStates");
            var workflowId = Guid.Empty;

            if (parentWorkflowName != workflowName)
            {
                if (toolName != null && workflowName != null)
                {
                    workflowId = debugStates.First(wf => wf.DisplayName.Equals(workflowName)).ID;
                }
                else
                {
                    throw new InvalidOperationException("SpecFlow broke.");
                }
            }

            var toolSpecificDebug =
                debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == workflowId && ds.DisplayName.Equals(toolName)).ToList();
            if (!toolSpecificDebug.Any())
            {
                toolSpecificDebug =
                debugStates.Where(ds => ds.DisplayName.Equals(toolName)).ToList();
            }
            // Data Merge breaks our debug scheme, it only ever has 1 value, not the expected 2 ;)
            var isDataMergeDebug = toolSpecificDebug.Count == 1 && toolSpecificDebug.Any(t => t.Name == "Data Merge");
            var outputState = toolSpecificDebug.FirstOrDefault();
            if (toolSpecificDebug.Count > 1)
            {
                if (toolSpecificDebug.Any(state => state.StateType == StateType.End))
                {
                    outputState = toolSpecificDebug.FirstOrDefault(state => state.StateType == StateType.End);
                }
            }
            var debugItemResults = outputState?.Outputs.SelectMany(s => s.ResultsList).ToList();
            Assert.IsNotNull(debugItemResults);
            Assert.IsTrue(debugItemResults.Any(result => result.Value.Contains("{\r\n  \"Name\": \"Bob\"\r\n}")));
        }

        [Given(@"""(.*)"" contains an SQL Bulk Insert ""(.*)"" using database ""(.*)"" and table ""(.*)"" and KeepIdentity set ""(.*)"" and Result set ""(.*)"" for testing as")]
        [Given(@"""(.*)"" contains an SQL Bulk Insert ""(.*)"" using database ""(.*)"" and table ""(.*)"" and KeepIdentity set ""(.*)"" and Result set ""(.*)"" as")]
        public void GivenContainsAnSQLBulkInsertUsingDatabaseAndTableAndKeepIdentitySetAndResultSetForTestingAs(string workflowName, string activityName, string dbSrcName, string tableName, string keepIdentity, string result, Table table)
        {
            if (dbSrcName == "NewSqlServerSource" || dbSrcName == "NewSqlBulkInsertSource")
            {
                _containerOps = new Depends(Depends.ContainerType.MSSQL, true);
            }
            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();
            var environmentConnection = environmentModel.Connection;
            var controllerFactory = new CommunicationControllerFactory();
            var _proxyLayer = new StudioServerProxy(controllerFactory, environmentConnection);
            var dbSources = _proxyLayer.QueryManagerProxy.FetchDbSources().ToList();
            var dbSource = dbSources.Single(source => source.Name == dbSrcName);

            // extract keepIdentity value ;)
            bool.TryParse(keepIdentity, out bool keepIdentityBool);

            // Configure activity ;)
            var dsfSqlBulkInsert = new DsfSqlBulkInsertActivity
            {
                Result = result
                ,
                DisplayName = activityName
                ,
                TableName = tableName
                ,
                Database = new DbSource
                {
                    ResourceID = dbSource.Id,
                    AuthenticationType = dbSource.AuthenticationType,
                    DatabaseName = dbSrcName,
                },
                KeepIdentity = keepIdentityBool,


            };
            // build input mapping
            var mappings = new List<DataColumnMapping>();

            var pos = 1;

            foreach (var row in table.Rows)

            {
                var outputColumn = row["Column"];
                var inputColumn = row["Mapping"];
                var isNullableStr = row["IsNullable"];
                var dataTypeName = row["DataTypeName"];
                var maxLengthStr = row["MaxLength"];
                var isAutoIncrementStr = row["IsAutoIncrement"];
                bool.TryParse(isNullableStr, out bool isNullable);
                bool.TryParse(isAutoIncrementStr, out bool isAutoIncrement);
                int.TryParse(maxLengthStr, out int maxLength);
                Enum.TryParse(dataTypeName, true, out SqlDbType dataType);

                var mapping = new DataColumnMapping { IndexNumber = pos, InputColumn = inputColumn, OutputColumn = new DbColumn { ColumnName = outputColumn, IsAutoIncrement = isAutoIncrement, IsNullable = isNullable, MaxLength = maxLength, SqlDataType = dataType } };
                mappings.Add(mapping);
                pos++;
            }

            dsfSqlBulkInsert.InputMappings = mappings;
            _commonSteps.AddVariableToVariableList(result);
            _commonSteps.AddActivityToActivityList(workflowName, activityName, dsfSqlBulkInsert);

        }

        [Given(@"""(.*)"" contains an Sort ""(.*)"" as")]
        public void GivenContainsAnSortAs(string parentName, string activityName, Table table)
        {
            var dsfSort = new DsfSortRecordsActivity { DisplayName = activityName, SortField = table.Rows[0][0], SelectedSort = table.Rows[0][1] };
            _commonSteps.AddActivityToActivityList(parentName, activityName, dsfSort);
        }

        [Given(@"""(.*)"" contains a Cmd Script ""(.*)"" ScriptToRun ""(.*)"" and result as ""(.*)""")]
        public void GivenContainsACmdScriptScriptToRunAndResultAs(string parentName, string activityName, string scriptToRun, string Result)
        {
            var commandLineActivity = new DsfExecuteCommandLineActivity
            {
                DisplayName = activityName,
                CommandFileName = scriptToRun,
                CommandResult = Result

            };
            _commonSteps.AddActivityToActivityList(parentName, activityName, commandLineActivity);
        }

        [Given(@"""(.*)"" contains a Java Script ""(.*)"" ScriptToRun ""(.*)"" and result as ""(.*)""")]
        public void GivenContainsAJavaScriptScriptToRunAndResultAs(string parentName, string activityName, string scriptToRun, string Result)
        {
            var dsfJavascriptActivity = new DsfJavascriptActivity
            {
                DisplayName = activityName,
                Result = Result,
                Script = scriptToRun
            };
            _commonSteps.AddActivityToActivityList(parentName, activityName, dsfJavascriptActivity);
        }

        [Given(@"""(.*)"" contains a Python ""(.*)"" ScriptToRun ""(.*)"" and result as ""(.*)""")]
        public void GivenContainsAPythonScriptToRunAndResultAs(string parentName, string activityName, string scriptToRun, string Result)
        {
            var dsfPythonActivity = new DsfPythonActivity
            {
                DisplayName = activityName
                ,
                Result = Result
                ,
                Script = scriptToRun
                ,
                EscapeScript = true
            };
            _commonSteps.AddActivityToActivityList(parentName, activityName, dsfPythonActivity);
        }

        [Given(@"""(.*)"" contains a Ruby ""(.*)"" ScriptToRun ""(.*)"" and result as ""(.*)""")]
        public void GivenContainsARubyScriptToRunAndResultAs(string parentName, string activityName, string scriptToRun, string Result)
        {
            var rubyActivity = new DsfRubyActivity { DisplayName = activityName, Result = Result, Script = scriptToRun };
            _commonSteps.AddActivityToActivityList(parentName, activityName, rubyActivity);
        }

        [Given(@"""(.*)"" contains SharepointDownloadFile ""(.*)"" as")]
        public void GivenContainsSharepointDownloadFileAs(string parentName, string activityName, Table table)
        {
            var server = table.Rows[0]["Server"];
            var result = table.Rows[0]["Result"];
            var serverPath = table.Rows[0]["ServerPathFrom"];
            var serverPathUniqueNameGuid = ScenarioContext.Current.Get<string>("serverPathToUniqueNameGuid");
            serverPath = CommonSteps.AddGuidToPath(serverPath, serverPathUniqueNameGuid);
            var localPath = table.Rows[0]["LocalPathTo"];
            var downLoadActivity = new SharepointFileDownLoadActivity
            {
                DisplayName = activityName
                ,
                SharepointServerResourceId = ConfigurationManager.AppSettings[server].ToGuid()
                ,
                LocalInputPath = localPath
                ,
                ServerInputPath = serverPath
                ,
                Result = result

            };
            _commonSteps.AddVariableToVariableList(result);
            _commonSteps.AddActivityToActivityList(parentName, activityName, downLoadActivity);
        }

        [Given(@"""(.*)"" contains SharepointMoveFile ""(.*)"" as")]
        public void GivenContainsSharepointMoveFileAs(string parentName, string activityName, Table table)
        {
            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();

            var sources = environmentModel.ResourceRepository.FindSourcesByType<SharepointSource>(environmentModel, enSourceType.SharepointServerSource) ?? new List<SharepointSource>();
            var result = table.Rows[0]["Result"];
            var name = table.Rows[0]["Server"];
            var serverPathFrom = table.Rows[0]["ServerPathFrom"];
            var serverPathUniqueNameGuid = ScenarioContext.Current.Get<string>("serverPathToUniqueNameGuid");
            serverPathFrom = CommonSteps.AddGuidToPath(serverPathFrom, serverPathUniqueNameGuid);
            var serverPathTo = table.Rows[0]["ServerPathTo"];
            var sharepointServerResourceId = ConfigurationManager.AppSettings[name].ToGuid();
            var sharepointSource = sources.Single(source => source.ResourceID == sharepointServerResourceId);

            var readFolderItemActivity = new SharepointMoveFileActivity
            {
                DisplayName = activityName,
                SharepointServerResourceId = sharepointSource.ResourceID,
                Result = result,
                ServerInputPathFrom = serverPathFrom,
                ServerInputPathTo = serverPathTo,
                Overwrite = true


            };
            _commonSteps.AddVariableToVariableList(result);
            _commonSteps.AddActivityToActivityList(parentName, activityName, readFolderItemActivity);
        }

        [Given(@"""(.*)"" contains SharepointCopyFile ""(.*)"" as")]
        public void GivenContainsSharepointCopyFileAs(string parentName, string activityName, Table table)
        {
            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();

            var sources = environmentModel.ResourceRepository.FindSourcesByType<SharepointSource>(environmentModel, enSourceType.SharepointServerSource) ?? new List<SharepointSource>();
            var result = table.Rows[0]["Result"];
            var name = table.Rows[0]["Server"];
            var overwrite = table.Rows[0]["Overwrite"];
            var serverPathFrom = table.Rows[0]["ServerPathFrom"];
            var serverPathUniqueNameGuid = ScenarioContext.Current.Get<string>("serverPathToUniqueNameGuid");
            serverPathFrom = CommonSteps.AddGuidToPath(serverPathFrom, serverPathUniqueNameGuid);
            var serverPathTo = table.Rows[0]["ServerPathTo"];
            var sharepointServerResourceId = ConfigurationManager.AppSettings[name].ToGuid();
            var sharepointSource = sources.Single(source => source.ResourceID == sharepointServerResourceId);

            var readFolderItemActivity = new SharepointCopyFileActivity
            {
                DisplayName = activityName,
                SharepointServerResourceId = sharepointSource.ResourceID,
                Result = result,
                ServerInputPathFrom = serverPathFrom,
                ServerInputPathTo = serverPathTo,
                Overwrite = bool.Parse(overwrite)

            };
            _commonSteps.AddVariableToVariableList(result);
            _commonSteps.AddActivityToActivityList(parentName, activityName, readFolderItemActivity);
        }


        [Given(@"""(.*)"" contains SharepointReadListItem ""(.*)"" as")]
        public void GivenContainsSharepointReadListItemAs(string parentName, string activityName, Table table)
        {
            //Load Source based on the name
            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();

            var sharepointList = table.Rows[0]["List"];
            var readListActivity = new SharepointReadListActivity
            {
                DisplayName = activityName
                ,
                SharepointServerResourceId = ConfigurationManager.AppSettings[table.Rows[0]["Server"]].ToGuid()
                ,
                SharepointList = sharepointList

            };
            var sources = environmentModel.ResourceRepository.FindSourcesByType<SharepointSource>(environmentModel, enSourceType.SharepointServerSource) ?? new List<SharepointSource>();
            var sharepointSource = sources.Single(source => source.ResourceID == readListActivity.SharepointServerResourceId);
            var sharepointListTos = environmentModel.ResourceRepository.GetSharepointLists(sharepointSource);
            var sharepointListTo = sharepointListTos.Single(to => to.FullName == sharepointList);
            var sharepointFieldsToKeep = new List<ISharepointFieldTo>()
            {
                new SharepointFieldTo {InternalName = "Title"},
                new SharepointFieldTo {InternalName = "Name"},
                new SharepointFieldTo {InternalName = "IntField"},
                new SharepointFieldTo {InternalName = "CurrencyField"},
                new SharepointFieldTo {InternalName = "DateField"},
                new SharepointFieldTo {InternalName = "DateTimeField"},
                new SharepointFieldTo {InternalName = "BoolField"},
                new SharepointFieldTo {InternalName = "MultilineTextField"},
                new SharepointFieldTo {InternalName = "RequiredField"},
                new SharepointFieldTo {InternalName = "Loc"}
            };
            var asyncWorker = new SynchronousAsyncWorker();
            asyncWorker.Start(() => GetListFields(environmentModel, sharepointSource, sharepointListTo), columnList =>
            {
                if (columnList != null)
                {
                    var fieldMappings = columnList
                    .Where(to => sharepointFieldsToKeep.Any(fieldTo => fieldTo.InternalName == to.InternalName))
                    .Select(mapping =>
                    {

                        var recordsetDisplayValue = DataListUtil.CreateRecordsetDisplayValue(sharepointListTo.FullName.Replace(" ", "").Replace(".", ""), GetValidVariableName(mapping), "*");
                        var sharepointReadListTo = new SharepointReadListTo(DataListUtil.AddBracketsToValueIfNotExist(recordsetDisplayValue), mapping.Name, mapping.InternalName, mapping.Type.ToString()) { IsRequired = mapping.IsRequired };
                        return sharepointReadListTo;
                    }).ToList();
                    if (readListActivity.ReadListItems == null || readListActivity.ReadListItems.Count == 0)
                    {
                        readListActivity.ReadListItems = fieldMappings;
                    }
                    else
                    {
                        foreach (var sharepointReadListTo in fieldMappings)
                        {
                            var listTo = sharepointReadListTo;
                            var readListTo = readListActivity.ReadListItems.FirstOrDefault(to => to.FieldName == listTo.FieldName);
                            if (readListTo == null)
                            {
                                readListActivity.ReadListItems.Add(sharepointReadListTo);
                            }
                        }
                    }

                }
            });

            _commonSteps.AddVariableToVariableList("[[AccTesting().Title]]");
            _commonSteps.AddVariableToVariableList("[[AccTesting().Name]]");
            _commonSteps.AddVariableToVariableList("[[AccTesting().IntField]]");
            _commonSteps.AddVariableToVariableList("[[AccTesting().CurrencyField]]");
            _commonSteps.AddVariableToVariableList("[[AccTesting().DateField]]");
            _commonSteps.AddVariableToVariableList("[[AccTesting().DateTimeField]]");
            _commonSteps.AddVariableToVariableList("[[AccTesting().BoolField]]");
            _commonSteps.AddVariableToVariableList("[[AccTesting().MultilineTextField]]");
            _commonSteps.AddVariableToVariableList("[[AccTesting().Loc]] ");
            _commonSteps.AddVariableToVariableList("[[AccTesting().RequiredField]]");
            _commonSteps.AddActivityToActivityList(parentName, activityName, readListActivity);
        }

        [Given(@"""(.*)"" contains SharepointReadFolder ""(.*)"" as")]
        public void GivenContainsSharepointReadFolderAs(string parentName, string activityName, Table table)
        {
            var server = table.Rows[0]["Server"];
            var result = table.Rows[0]["Result"];
            var readFolderItemActivity = new SharepointReadFolderItemActivity
            {
                DisplayName = activityName
                ,
                SharepointServerResourceId = ConfigurationManager.AppSettings[server].ToGuid()
                ,
                Result = result
                ,
                IsFoldersSelected = true

            };
            _commonSteps.AddVariableToVariableList(result);
            _commonSteps.AddActivityToActivityList(parentName, activityName, readFolderItemActivity);
        }

        [Given(@"""(.*)"" contains SharepointDeleteSingle ""(.*)"" as")]
        public void GivenContainsSharepointDeleteListItemAs(string parentName, string activityName, Table table)
        {
            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();

            var sources = environmentModel.ResourceRepository.FindSourcesByType<SharepointSource>(environmentModel, enSourceType.SharepointServerSource) ?? new List<SharepointSource>();
            var result = table.Rows[0]["Result"];
            var name = table.Rows[0]["Server"];
            var serverPath = table.Rows[0]["ServerPath"];
            if (ScenarioContext.Current.ContainsKey("serverPathToUniqueNameGuid"))
            {
                var serverPathUniqueNameGuid = ScenarioContext.Current.Get<string>("serverPathToUniqueNameGuid");
                serverPath = CommonSteps.AddGuidToPath(serverPath, serverPathUniqueNameGuid);
            }
            var sharepointServerResourceId = ConfigurationManager.AppSettings[name].ToGuid();
            var sharepointSource = sources.Single(source => source.ResourceID == sharepointServerResourceId);

            var deleteListItemActivity = new SharepointDeleteFileActivity
            {
                SharepointServerResourceId = sharepointSource.ResourceID
                ,
                DisplayName = activityName
                ,
                ServerInputPath = serverPath,
                Result = result
            };
            _commonSteps.AddVariableToVariableList(result);
            _commonSteps.AddActivityToActivityList(parentName, activityName, deleteListItemActivity);

        }
        [Given(@"""(.*)"" contains UpdateListItems ""(.*)"" as")]
        public void GivenContainsUpdateListItemsAs(string parentName, string activityName, Table table)
        {
            //Load Source based on the name
            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();

            var sharepointList = table.Rows[0]["List"];
            sharepointList += "_" + ScenarioContext.Current.Get<int>("recordsetNameRandomizer").ToString();
            var result = table.Rows[0]["Result"];
            var createListItemActivity = new SharepointUpdateListItemActivity
            {
                DisplayName = activityName
                ,
                SharepointServerResourceId = ConfigurationManager.AppSettings[table.Rows[0]["Server"]].ToGuid()
                ,
                Result = result
                ,
                SharepointList = sharepointList,

            };
            var sources = environmentModel.ResourceRepository.FindSourcesByType<SharepointSource>(environmentModel, enSourceType.SharepointServerSource) ?? new List<SharepointSource>();
            var sharepointSource = sources.Single(source => source.ResourceID == createListItemActivity.SharepointServerResourceId);
            var sharepointListTos = environmentModel.ResourceRepository.GetSharepointLists(sharepointSource);
            var sharepointListTo = sharepointListTos.Single(to => to.FullName == sharepointList);
            var sharepointFieldsToKeep = new List<ISharepointFieldTo>()
            {
                new SharepointFieldTo() {InternalName = "Title"},
                new SharepointFieldTo() {InternalName = "Name"},
                new SharepointFieldTo() {InternalName = "IntField"},
                new SharepointFieldTo() {InternalName = "CurrencyField"},
                new SharepointFieldTo() {InternalName = "DateField"},
                new SharepointFieldTo() {InternalName = "DateTimeField"},
                new SharepointFieldTo() {InternalName = "BoolField"},
                new SharepointFieldTo() {InternalName = "MultilineTextField"},
                new SharepointFieldTo() {InternalName = "RequiredField"},
                new SharepointFieldTo() {InternalName = "Loc",},
            };
            var asyncWorker = new SynchronousAsyncWorker();
            asyncWorker.Start(() => GetListFields(environmentModel, sharepointSource, sharepointListTo), columnList =>
            {
                if (columnList != null)
                {
                    var fieldMappings = columnList
                    .Where(to => sharepointFieldsToKeep.Any(fieldTo => fieldTo.InternalName == to.InternalName))
                    .Select(mapping =>
                    {
                        var recordsetDisplayValue = DataListUtil.CreateRecordsetDisplayValue(sharepointListTo.FullName.Replace(" ", "").Replace(".", ""), GetValidVariableName(mapping), "*");
                        var sharepointReadListTo = new SharepointReadListTo(DataListUtil.AddBracketsToValueIfNotExist(recordsetDisplayValue), mapping.Name, mapping.InternalName, mapping.Type.ToString()) { IsRequired = mapping.IsRequired };
                        return sharepointReadListTo;
                    }).ToList();
                    if (createListItemActivity.ReadListItems == null || createListItemActivity.ReadListItems.Count == 0)
                    {
                        createListItemActivity.ReadListItems = fieldMappings;
                    }
                    else
                    {
                        foreach (var sharepointReadListTo in fieldMappings)
                        {
                            var listTo = sharepointReadListTo;
                            var readListTo = createListItemActivity.ReadListItems.FirstOrDefault(to => to.FieldName == listTo.FieldName);
                            if (readListTo == null)
                            {
                                createListItemActivity.ReadListItems.Add(sharepointReadListTo);
                            }
                        }
                    }

                }
            });

            _commonSteps.AddActivityToActivityList(parentName, activityName, createListItemActivity);

        }
        [Given(@"""(.*)"" contains CreateListItems ""(.*)"" as")]
        public void GivenContainsCreateListItemsAs(string parentName, string activityName, Table table)
        {
            //Load Source based on the name
            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();

            var sharepointList = table.Rows[0]["List"];
            var result = table.Rows[0]["Result"];
            var createListItemActivity = new SharepointCreateListItemActivity
            {
                DisplayName = activityName
            ,
                SharepointServerResourceId = ConfigurationManager.AppSettings[table.Rows[0]["Server"]].ToGuid(),
                Result = result,
                SharepointList = sharepointList,

            };
            var sources = environmentModel.ResourceRepository.FindSourcesByType<SharepointSource>(environmentModel, enSourceType.SharepointServerSource) ?? new List<SharepointSource>();
            var sharepointSource = sources.Single(source => source.ResourceID == createListItemActivity.SharepointServerResourceId);
            var sharepointListTos = environmentModel.ResourceRepository.GetSharepointLists(sharepointSource);
            var sharepointListTo = sharepointListTos.Single(to => to.FullName == sharepointList);
            var sharepointFieldsToKeep = new List<ISharepointFieldTo>()
            {
                new SharepointFieldTo() {InternalName = "Title"},
                new SharepointFieldTo() {InternalName = "Name"},
                new SharepointFieldTo() {InternalName = "IntField"},
                new SharepointFieldTo() {InternalName = "CurrencyField"},
                new SharepointFieldTo() {InternalName = "DateField"},
                new SharepointFieldTo() {InternalName = "DateTimeField"},
                new SharepointFieldTo() {InternalName = "BoolField"},
                new SharepointFieldTo() {InternalName = "MultilineTextField"},
                new SharepointFieldTo() {InternalName = "RequiredField"},
                new SharepointFieldTo() {InternalName = "Loc",},
            };
            var asyncWorker = new SynchronousAsyncWorker();
            asyncWorker.Start(() => GetListFields(environmentModel, sharepointSource, sharepointListTo), columnList =>
            {
                if (columnList != null)
                {
                    var fieldMappings = columnList
                    .Where(to => sharepointFieldsToKeep.Any(fieldTo => fieldTo.InternalName == to.InternalName))
                    .Select(mapping =>
                    {

                        var recordsetDisplayValue = DataListUtil.CreateRecordsetDisplayValue(sharepointListTo.FullName.Replace(" ", "").Replace(".", ""), GetValidVariableName(mapping), "*");
                        var sharepointReadListTo = new SharepointReadListTo(DataListUtil.AddBracketsToValueIfNotExist(recordsetDisplayValue), mapping.Name, mapping.InternalName, mapping.Type.ToString()) { IsRequired = mapping.IsRequired };
                        return sharepointReadListTo;
                    }).ToList();
                    if (createListItemActivity.ReadListItems == null || createListItemActivity.ReadListItems.Count == 0)
                    {
                        createListItemActivity.ReadListItems = fieldMappings;
                    }
                    else
                    {
                        foreach (var sharepointReadListTo in fieldMappings)
                        {
                            var listTo = sharepointReadListTo;
                            var readListTo = createListItemActivity.ReadListItems.FirstOrDefault(to => to.FieldName == listTo.FieldName);
                            if (readListTo == null)
                            {
                                createListItemActivity.ReadListItems.Add(sharepointReadListTo);
                            }
                        }
                    }

                }
            });

            _commonSteps.AddVariableToVariableList("[[AcceptanceTesting_Create().Title]]");
            _commonSteps.AddVariableToVariableList("[[AcceptanceTesting_Create().Name]]");
            _commonSteps.AddVariableToVariableList("[[AcceptanceTesting_Create().IntField]]");
            _commonSteps.AddVariableToVariableList("[[AcceptanceTesting_Create().CurrencyField]]");
            _commonSteps.AddVariableToVariableList("[[AcceptanceTesting_Create().DateField]]");
            _commonSteps.AddVariableToVariableList("[[AcceptanceTesting_Create().DateTimeField]]");
            _commonSteps.AddVariableToVariableList("[[AcceptanceTesting_Create().BoolField]]");
            _commonSteps.AddVariableToVariableList("[[AcceptanceTesting_Create().MultilineTextField]]");
            _commonSteps.AddVariableToVariableList("[[AcceptanceTesting_Create().Loc]] ");
            _commonSteps.AddVariableToVariableList("[[AcceptanceTesting_Create().RequiredField]]");
            _commonSteps.AddActivityToActivityList(parentName, activityName, createListItemActivity);

        }

        static string GetValidVariableName(ISharepointFieldTo mapping)
        {
            var fixedName = mapping.Name.Replace(" ", "").Replace(".", "").Replace(":", "").Replace(",", "");
            fixedName = XmlConvert.EncodeName(fixedName);
            var startIndexOfEncoding = fixedName.IndexOf("_", StringComparison.OrdinalIgnoreCase);
            var endIndexOfEncoding = fixedName.LastIndexOf("_", StringComparison.OrdinalIgnoreCase);
            if (startIndexOfEncoding > 0 && endIndexOfEncoding > 0)
            {
                fixedName = fixedName.Remove(startIndexOfEncoding - 1, endIndexOfEncoding - startIndexOfEncoding);
            }
            if (fixedName[0] == 'f' || fixedName[0] == '_' || char.IsNumber(fixedName[0]))
            {
                fixedName = fixedName.Remove(0, 1);
            }
            return fixedName;
        }

        List<ISharepointFieldTo> GetListFields(IServer server, ISharepointSource source, SharepointListTo list)
        {
            var columns = server.ResourceRepository.GetSharepointListFields(source, list, true);
            return columns ?? new List<ISharepointFieldTo>();
        }
        [Given(@"""(.*)"" contains SharepointDeleteFile ""(.*)"" as")]
        public void GivenContainsSharepointDeleteFileAs(string parentName, string activityName, Table table)
        {
            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();

            var sources = environmentModel.ResourceRepository.FindSourcesByType<SharepointSource>(environmentModel, enSourceType.SharepointServerSource) ?? new List<SharepointSource>();

            var result = table.Rows[0]["Result"];
            var name = table.Rows[0]["Server"];
            var sharepointList = table.Rows[0]["SharepointList"];
            var sharepointServerResourceId = ConfigurationManager.AppSettings[name].ToGuid();
            var sharepointSource = sources.Single(source => source.ResourceID == sharepointServerResourceId);
            var deleteFileActivity = new SharepointDeleteListItemActivity()
            {
                DisplayName = activityName,
                SharepointServerResourceId = sharepointSource.ResourceID,
                SharepointList = sharepointList,
                DeleteCount = result,
                FilterCriteria = new List<SharepointSearchTo>()
                {
                    new SharepointSearchTo("Title","=",Guid.NewGuid().ToString(),1)
                    {
                        InternalName = "Title"
                    }
                }
                ,
                RequireAllCriteriaToMatch = true

            };

            _commonSteps.AddVariableToVariableList(result);
            _commonSteps.AddActivityToActivityList(parentName, activityName, deleteFileActivity);
        }

        [Given(@"""(.*)"" contains SharepointUploadFile ""(.*)"" as")]
        public void GivenContainsSharepointUploadFileAs(string parentName, string activityName, Table table)
        {
            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();

            var sources = environmentModel.ResourceRepository.FindSourcesByType<SharepointSource>(environmentModel, enSourceType.SharepointServerSource) ?? new List<SharepointSource>();
            var result = table.Rows[0]["Result"];
            var name = table.Rows[0]["Server"];
            var localPathFrom = table.Rows[0]["LocalPathFrom"];
            var serverPathTo = table.Rows[0]["ServerPathTo"];
            var serverPathToUniqueNameGuid = CommonSteps.GetGuid();
            serverPathTo = CommonSteps.AddGuidToPath(serverPathTo, serverPathToUniqueNameGuid);
            ScenarioContext.Current.Add("serverPathToUniqueNameGuid", serverPathToUniqueNameGuid);
            var sharepointServerResourceId = ConfigurationManager.AppSettings[name].ToGuid();
            var sharepointSource = sources.Single(source => source.ResourceID == sharepointServerResourceId);
            var fileUploadActivity = new SharepointFileUploadActivity
            {
                DisplayName = activityName
                ,
                SharepointServerResourceId = sharepointSource.ResourceID
                ,
                Result = result
                ,
                LocalInputPath = localPathFrom
                ,
                ServerInputPath = serverPathTo,

            };
            _commonSteps.AddVariableToVariableList(result);
            _commonSteps.AddActivityToActivityList(parentName, activityName, fileUploadActivity);
        }


        [Given(@"""(.*)"" contains SharepointDelete ""(.*)"" as")]
        public void GivenContainsSharepointDeleteAs(string parentName, string activityName, Table table)
        {
            var sourceName = table.Rows[0]["Source"];
            var list = table.Rows[0]["List"];

            var deleteListItemActivity = new SharepointDeleteListItemActivity
            {
                SharepointServerResourceId = ConfigurationManager.AppSettings[sourceName].ToGuid()
                ,
                DisplayName = activityName
                ,
                SharepointList = list
            };
            _commonSteps.AddActivityToActivityList(parentName, activityName, deleteListItemActivity);
        }

        [Given(@"""(.*)"" contains a Web Delete ""(.*)"" result as ""(.*)""")]
        public void GivenContainsAWebDeleteResultAs(string parentName, string activityName, string result)
        {
            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();
            var environmentConnection = environmentModel.Connection;
            var controllerFactory = new CommunicationControllerFactory();
            var _proxyLayer = new StudioServerProxy(controllerFactory, environmentConnection);
            var mock = new Mock<IShellViewModel>();
            var manageWebServiceModel = new ManageWebServiceModel(
                                                                                    new StudioResourceUpdateManager(controllerFactory, environmentConnection)
                                                                                    , _proxyLayer.QueryManagerProxy
                                                                                    , mock.Object
                                                                                    , environmentModel);
            var pluginSources = _proxyLayer.QueryManagerProxy.FetchWebServiceSources().ToList();
            var a = pluginSources.Single(source => source.Id == "3032b7fd-f12a-4ab8-be7d-2f4705c31317".ToGuid());
            var webServiceDefinition = new WebServiceDefinition()
            {
                Name = "Delete",
                Path = "",
                Source = a,
                Inputs = new List<IServiceInput>(),
                OutputMappings = new List<IServiceOutputMapping>(),
                QueryString = "",
                Id = a.Id,
                Headers = new List<INameValue>(),
                Method = WebRequestMethod.Delete
            };
            var testResult = manageWebServiceModel.TestService(webServiceDefinition);

            var serializer = new Dev2JsonSerializer();

            var dsfWebDeleteActivity = new DsfWebDeleteActivity
            {
                DisplayName = activityName
                ,
                SourceId = a.Id
            };

            RecordsetList recordsetList;
            using (var responseService = serializer.Deserialize<WebService>(testResult))
            {
                recordsetList = responseService.Recordsets;
                if (recordsetList.Any(recordset => recordset.HasErrors))
                {
                    var errorMessage = string.Join(Environment.NewLine, recordsetList.Select(recordset => recordset.ErrorMessage));
                    throw new Exception(errorMessage);
                }
                dsfWebDeleteActivity.OutputDescription = responseService.GetOutputDescription();
            }

            var outputMapping = recordsetList.SelectMany(recordset => recordset.Fields, (recordset, recordsetField) =>
            {
                var serviceOutputMapping = new ServiceOutputMapping(recordsetField.Name, recordsetField.Alias, recordset.Name) { Path = recordsetField.Path };
                return serviceOutputMapping;
            }).Cast<IServiceOutputMapping>().ToList();

            dsfWebDeleteActivity.Outputs = outputMapping;
            dsfWebDeleteActivity.Headers = new List<INameValue>();
            dsfWebDeleteActivity.QueryString = string.Empty;
            _commonSteps.AddActivityToActivityList(parentName, activityName, dsfWebDeleteActivity);
        }

        [Given(@"""(.*)"" contains a Web Post ""(.*)"" result as ""(.*)""")]
        public void GivenContainsAWebPostResultAs(string parentName, string activityName, string result)
        {
            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();
            var environmentConnection = environmentModel.Connection;
            var controllerFactory = new CommunicationControllerFactory();
            var _proxyLayer = new StudioServerProxy(controllerFactory, environmentConnection);
            var mock = new Mock<IShellViewModel>();
            var manageWebServiceModel = new ManageWebServiceModel(
                  new StudioResourceUpdateManager(controllerFactory, environmentConnection)
                  , _proxyLayer.QueryManagerProxy
                  , mock.Object
                  , environmentModel);

            var webSources = _proxyLayer.QueryManagerProxy.FetchWebServiceSources().ToList();
            var a = webSources.Single(source => source.Id == "ab4d5ab5-ad44-421d-8125-adfcc3aa655b".ToGuid());
            var webServiceDefinition = new WebServiceDefinition()
            {
                Name = "Post",
                Path = "",
                Source = a,
                Inputs = new List<IServiceInput>(),
                OutputMappings = new List<IServiceOutputMapping>(),
                QueryString = "",
                Id = a.Id,
                Headers = new List<INameValue>(),
                Method = WebRequestMethod.Post
            };
            var testResult = manageWebServiceModel.TestService(webServiceDefinition);

            var serializer = new Dev2JsonSerializer();

            var dsfWebPostActivity = new DsfWebPostActivity
            {
                DisplayName = activityName
                ,
                PostData = string.Empty
                ,
                SourceId = a.Id
            };

            RecordsetList recordsetList;
            using (var responseService = serializer.Deserialize<WebService>(testResult))
            {
                recordsetList = responseService.Recordsets;
                if (recordsetList.Any(recordset => recordset.HasErrors))
                {
                    var errorMessage = string.Join(Environment.NewLine, recordsetList.Select(recordset => recordset.ErrorMessage));
                    throw new Exception(errorMessage);
                }
                dsfWebPostActivity.OutputDescription = responseService.GetOutputDescription();
            }

            var outputMapping = recordsetList.SelectMany(recordset => recordset.Fields, (recordset, recordsetField) =>
            {
                var serviceOutputMapping = new ServiceOutputMapping(recordsetField.Name, recordsetField.Alias, recordset.Name) { Path = recordsetField.Path };
                return serviceOutputMapping;
            }).Cast<IServiceOutputMapping>().ToList();

            dsfWebPostActivity.Outputs = outputMapping;
            dsfWebPostActivity.Headers = new List<INameValue>();
            dsfWebPostActivity.QueryString = string.Empty;
            _commonSteps.AddActivityToActivityList(parentName, activityName, dsfWebPostActivity);
        }

        [Given(@"""(.*)"" contains a Web Get ""(.*)"" result as ""(.*)""")]
        public void GivenContainsAWebGetResultAs(string parentName, string activityName, string result)
        {
            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();
            var environmentConnection = environmentModel.Connection;
            var controllerFactory = new CommunicationControllerFactory();
            var _proxyLayer = new StudioServerProxy(controllerFactory, environmentConnection);
            var mock = new Mock<IShellViewModel>();
            var manageWebServiceModel = new ManageWebServiceModel(
                                                                                    new StudioResourceUpdateManager(controllerFactory, environmentConnection)
                                                                                    , _proxyLayer.QueryManagerProxy
                                                                                    , mock.Object
                                                                                    , environmentModel);
            var pluginSources = _proxyLayer.QueryManagerProxy.FetchWebServiceSources().ToList();
            var a = pluginSources.Single(source => source.Id == "e541d860-cd10-4aec-b2fe-79eca3c62c25".ToGuid());
            var webServiceDefinition = new WebServiceDefinition()
            {
                Name = "Get",
                Path = "",
                Source = a,
                Inputs = new List<IServiceInput>(),
                OutputMappings = new List<IServiceOutputMapping>(),
                QueryString = "",
                Id = a.Id,
                Headers = new List<INameValue>(),
                Method = WebRequestMethod.Get
            };
            var testResult = manageWebServiceModel.TestService(webServiceDefinition);

            var serializer = new Dev2JsonSerializer();

            var dsfWebGetActivity = new WebGetActivity
            {
                DisplayName = activityName
                ,
                SourceId = a.Id
            };

            RecordsetList recordsetList;
            using (var responseService = serializer.Deserialize<WebService>(testResult))
            {
                recordsetList = responseService.Recordsets;
                if (recordsetList.Any(recordset => recordset.HasErrors))
                {
                    var errorMessage = string.Join(Environment.NewLine, recordsetList.Select(recordset => recordset.ErrorMessage));
                    throw new Exception(errorMessage);
                }
                dsfWebGetActivity.OutputDescription = responseService.GetOutputDescription();
            }

            var outputMapping = recordsetList.SelectMany(recordset => recordset.Fields, (recordset, recordsetField) =>
            {
                var serviceOutputMapping = new ServiceOutputMapping(recordsetField.Name, recordsetField.Alias, recordset.Name) { Path = recordsetField.Path };
                return serviceOutputMapping;
            }).Cast<IServiceOutputMapping>().ToList();

            dsfWebGetActivity.Outputs = outputMapping;
            dsfWebGetActivity.Headers = new List<INameValue>
            {
                new NameValue("Content-Type","text/html")
            };
            dsfWebGetActivity.QueryString = string.Empty;
            _commonSteps.AddVariableToVariableList(result);
            _commonSteps.AddActivityToActivityList(parentName, activityName, dsfWebGetActivity);
        }

        [Given(@"""(.*)"" contains a Web Put ""(.*)"" result as ""(.*)""")]
        public void GivenContainsAWebPutResultAs(string parentName, string activityName, string result)
        {
            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();
            var environmentConnection = environmentModel.Connection;
            var controllerFactory = new CommunicationControllerFactory();
            var _proxyLayer = new StudioServerProxy(controllerFactory, environmentConnection);
            var mock = new Mock<IShellViewModel>();
            var manageWebServiceModel = new ManageWebServiceModel(
                                                                                    new StudioResourceUpdateManager(controllerFactory, environmentConnection)
                                                                                    , _proxyLayer.QueryManagerProxy
                                                                                    , mock.Object
                                                                                    , environmentModel);
            var pluginSources = _proxyLayer.QueryManagerProxy.FetchWebServiceSources().ToList();
            var a = pluginSources.Single(source => source.Id == "0fb49fec-e454-4357-a06f-08f329558b18".ToGuid());
            var webServiceDefinition = new WebServiceDefinition()
            {
                Name = "Put",
                Path = "",
                Source = a,
                Inputs = new List<IServiceInput>(),
                OutputMappings = new List<IServiceOutputMapping>(),
                QueryString = "",
                Id = a.Id,
                Headers = new List<INameValue>(),
                Method = WebRequestMethod.Put
            };
            var testResult = manageWebServiceModel.TestService(webServiceDefinition);

            var serializer = new Dev2JsonSerializer();

            var webPutActivity = new DsfWebPutActivity
            {
                DisplayName = activityName
                ,
                SourceId = a.Id
                ,
                PutData = "{\"Id\":\"\"}"
            };

            RecordsetList recordsetList;
            using (var responseService = serializer.Deserialize<WebService>(testResult))
            {
                recordsetList = responseService.Recordsets;
                if (recordsetList.Any(recordset => recordset.HasErrors))
                {
                    var errorMessage = string.Join(Environment.NewLine, recordsetList.Select(recordset => recordset.ErrorMessage));
                    throw new Exception(errorMessage);
                }
                webPutActivity.OutputDescription = responseService.GetOutputDescription();
            }

            var outputMapping = recordsetList.SelectMany(recordset => recordset.Fields, (recordset, recordsetField) =>
            {
                var serviceOutputMapping = new ServiceOutputMapping(recordsetField.Name, recordsetField.Alias, recordset.Name) { Path = recordsetField.Path };
                return serviceOutputMapping;
            }).Cast<IServiceOutputMapping>().ToList();

            webPutActivity.Outputs = outputMapping;
            webPutActivity.Headers = new List<INameValue>()
            {
                new NameValue("Content-Type","text/html")
            };
            webPutActivity.QueryString = string.Empty;
            _commonSteps.AddVariableToVariableList(result);
            _commonSteps.AddActivityToActivityList(parentName, activityName, webPutActivity);
        }



        [Given(@"""(.*)"" contains an Delete ""(.*)"" as")]

        public void GivenContainsAnDeleteAs(string parentName, string activityName, Table table)

        {
            var del = new DsfPathDelete { InputPath = table.Rows[0][0], Result = table.Rows[0][1], DisplayName = activityName };
            _commonSteps.AddVariableToVariableList(table.Rows[0][1]);
            _commonSteps.AddActivityToActivityList(parentName, activityName, del);
        }

        [Given(@"""(.*)"" contains a Foreach ""(.*)"" as ""(.*)"" executions ""(.*)""")]
        public void GivenContainsAForeachAsExecutions(string parentName, string activityName, string numberOfExecutions, string executionCount)
        {
            Enum.TryParse(numberOfExecutions, true, out enForEachType forEachType);
            var forEach = new DsfForEachActivity { DisplayName = activityName, ForEachType = forEachType };
            switch (forEachType)
            {
                case enForEachType.NumOfExecution:
                    forEach.NumOfExections = executionCount;
                    break;
                case enForEachType.InRecordset:
                    forEach.Recordset = executionCount;
                    break;
                case enForEachType.InRange:
                    break;
                case enForEachType.InCSV:
                    break;
                default:
                    break;
            }
            _commonSteps.AddActivityToActivityList(parentName, activityName, forEach);
            _scenarioContext.Add(activityName, forEach);
        }

        [Given(@"""(.*)"" contains a SelectAndApply ""(.*)"" DataSource ""(.*)"" Alias ""(.*)""")]
        public void GivenContainsASelectAndApplyDataSourceAlias(string parentName, string activityName, string datasource, string alias)
        {
            var selectAndApplyActivity = new DsfSelectAndApplyActivity { DisplayName = activityName, DataSource = datasource, Alias = alias };
            _commonSteps.AddActivityToActivityList(parentName, activityName, selectAndApplyActivity);
            _scenarioContext.Add(activityName, selectAndApplyActivity);
        }


        [Given(@"""(.*)"" contains workflow ""(.*)"" with mapping as")]

        public void GivenContainsWorkflowWithMappingAs(string forEachName, string nestedWF, Table mappings)

        {
            var forEachAct = (DsfForEachActivity)_scenarioContext[forEachName];
            var environmentModel = LocalEnvModel;
            if (!environmentModel.IsConnected)
            {
                environmentModel.Connect();
            }

            var resource = environmentModel.ResourceRepository.Find(a => a.Category == @"Acceptance Testing Resources\" + nestedWF).FirstOrDefault();
            if (resource == null)
            {
                environmentModel.LoadResources();
                resource = environmentModel.ResourceRepository.Find(a => a.Category == @"Acceptance Testing Resources\" + nestedWF).FirstOrDefault();
            }
            if (resource == null)
            {

                throw new ArgumentNullException("resource");

            }
            var dataMappingViewModel = GetDataMappingViewModel(resource, mappings);

            var inputMapping = dataMappingViewModel.GetInputString(dataMappingViewModel.Inputs);
            var outputMapping = dataMappingViewModel.GetOutputString(dataMappingViewModel.Outputs);
            var activity = new DsfActivity
            {

                ServiceName = resource.Category,
                ResourceID = resource.ID,
                EnvironmentID = environmentModel.EnvironmentID,
                UniqueID = resource.ID.ToString(),
                InputMapping = inputMapping,
                OutputMapping = outputMapping


            };

            var activityFunction = new ActivityFunc<string, bool> { Handler = activity, DisplayName = nestedWF };
            forEachAct.DataFunc = activityFunction;
        }


        [Given(@"""(.*)"" contains Find Record Index ""(.*)"" into result as ""(.*)""")]
        public void GivenContainsFindRecordIndexIntoResultAs(string parentName, string activityName, string result, Table table)
        {
            var act = new DsfFindRecordsMultipleCriteriaActivity { DisplayName = activityName, Result = result };
            foreach (var rule in table.Rows)
            {
                act.ResultsCollection.Add(new FindRecordsTO(rule[4], rule[3], 0));
                act.FieldsToSearch = string.IsNullOrEmpty(act.FieldsToSearch) ? rule[1] : "," + rule[1];
                act.RequireAllFieldsToMatch = rule[5].ToUpper().Trim() == "YES";
                act.RequireAllTrue = rule[6].ToUpper().Trim() == "YES";
            }
            _commonSteps.AddActivityToActivityList(parentName, activityName, act);
        }


        [Given(@"""(.*)"" contains Length ""(.*)"" on ""(.*)"" into ""(.*)""")]
        public void GivenContainsLengthOnInto(string parentName, string activityName, string recordSet, string result)
        {
            var len = new DsfRecordsetNullhandlerLengthActivity { DisplayName = activityName, RecordsLength = result, RecordsetName = recordSet };
            _commonSteps.AddActivityToActivityList(parentName, activityName, len);
        }

        public void SaveToWorkspace(IContextualResourceModel resourceModel)
        {
            BuildDataList();

            var activityList = _commonSteps.GetActivityList();

            var flowSteps = new List<FlowStep>();

            TestStartNode = new FlowStep();
            flowSteps.Add(TestStartNode);
            if (activityList != null)
            {
                foreach (var activity in activityList)
                {
                    if (TestStartNode.Action == null)
                    {
                        TestStartNode.Action = activity.Value;
                    }
                    else
                    {
                        var flowStep = new FlowStep { Action = activity.Value };
                        flowSteps.Last().Next = flowStep;
                        flowSteps.Add(flowStep);
                    }
                }
            }
            TryGetValue("environment", out IServer server);
            TryGetValue("resourceRepo", out IResourceRepository repository);

            var currentDl = CurrentDl;
            resourceModel.DataList = currentDl.Replace("root", "DataList");
            var helper = new WorkflowHelper();
            var xamlDefinition = helper.GetXamlDefinition(FlowchartActivityBuilder);
            resourceModel.WorkflowXaml = xamlDefinition;
            repository.Save(resourceModel);
        }

        [When(@"""(.*)"" is executed")]
        public void WhenIsExecuted(string workflowName)
        {
            var resourceModel = SaveAWorkflow(workflowName);
            ExecuteWorkflow(resourceModel);
        }

        [When(@"'(.*)' unsaved WF ""(.*)"" is executed")]
        public void WhenUnsavedWFIsExecuted(int numberToExecute, string unsavedName)
        {
            var unsavedWFs = Get<List<IContextualResourceModel>>("unsavedWFS");
            if (unsavedWFs != null && unsavedWFs.Count > 0)
            {
                var wfs = unsavedWFs.Where(model => model.ResourceName == unsavedName).ToList();
                if (wfs.Count >= numberToExecute)
                {
                    var resourceModel = wfs[numberToExecute - 1];
                    EnsureEnvironmentConnected(resourceModel.Environment, EnvironmentConnectionTimeout);
                    SaveToWorkspace(resourceModel);
                    var debugTo = new DebugTO { XmlData = "<DataList></DataList>", SessionID = Guid.NewGuid(), IsDebugMode = true };
                    var clientContext = resourceModel.Environment.Connection;
                    if (clientContext != null)
                    {
                        var dataList = XElement.Parse(debugTo.XmlData);
                        dataList.Add(new XElement("BDSDebugMode", debugTo.IsDebugMode));
                        dataList.Add(new XElement("DebugSessionID", debugTo.SessionID));
                        dataList.Add(new XElement("EnvironmentID", resourceModel.Environment.EnvironmentID));
                        WebServer.Send(resourceModel, dataList.ToString(), new SynchronousAsyncWorker());
                        _resetEvt.WaitOne(1000);
                    }
                }
            }
        }

        public void ExecuteWorkflow(IContextualResourceModel resourceModel)
        {
            if (resourceModel?.Environment == null)
            {
                return;
            }

            var debugTo = new DebugTO { XmlData = "<DataList></DataList>", SessionID = Guid.NewGuid(), IsDebugMode = true };
            EnsureEnvironmentConnected(resourceModel.Environment, EnvironmentConnectionTimeout);
            var clientContext = resourceModel.Environment.Connection;
            if (clientContext != null)
            {
                var dataList = XElement.Parse(debugTo.XmlData);
                dataList.Add(new XElement("BDSDebugMode", debugTo.IsDebugMode));
                dataList.Add(new XElement("DebugSessionID", debugTo.SessionID));
                dataList.Add(new XElement("EnvironmentID", resourceModel.Environment.EnvironmentID));
                WebServer.Send(resourceModel, dataList.ToString(), new SynchronousAsyncWorker());
                _resetEvt.WaitOne(3000);
            }
        }

        [When(@"workflow ""(.*)"" is saved ""(.*)"" time")]
        [Then(@"workflow ""(.*)"" is saved ""(.*)"" time")]
        [Given(@"workflow ""(.*)"" is saved ""(.*)"" time")]
        public void WhenWorkflowIsSavedTime(string workflowName, int count)
        {
            TryGetValue("SavedId", out Guid id);
            if (id == Guid.Empty)
            {
                id = Guid.NewGuid();
                _scenarioContext.Add("SavedId", id);
            }
            Save(workflowName, count, id);
        }

        [When(@"I reload Server resources")]
        public void WhenIReloadServerResources()
        {
            TryGetValue("environment", out IServer server);
            server.ResourceRepository.Load(true);
        }

        void Save(string workflowName, int count, Guid id)
        {
            BuildDataList();

            var activityList = _commonSteps.GetActivityList();

            var flowSteps = new List<FlowStep>();

            TestStartNode = new FlowStep();
            flowSteps.Add(TestStartNode);

            if (activityList != null)
            {
                foreach (var activity in activityList)
                {
                    if (TestStartNode.Action == null)
                    {
                        TestStartNode.Action = activity.Value;
                    }
                    else
                    {
                        var flowStep = new FlowStep { Action = activity.Value };
                        flowSteps.Last().Next = flowStep;
                        flowSteps.Add(flowStep);
                    }
                }
            }
            TryGetValue(workflowName, out IContextualResourceModel resourceModel);
            TryGetValue("environment", out IServer server);
            TryGetValue("resourceRepo", out IResourceRepository repository);

            var currentDl = CurrentDl;
            resourceModel.DataList = currentDl.Replace("root", "DataList");
            var helper = new WorkflowHelper();
            var xamlDefinition = helper.GetXamlDefinition(FlowchartActivityBuilder);
            resourceModel.WorkflowXaml = xamlDefinition;
            resourceModel.ID = id;

            for (var i = 0; i < count; i++)
            {
                repository.SaveToServer(resourceModel);
            }

        }

        [Given(@"I save workflow ""(.*)""")]
        [When(@"I save workflow ""(.*)""")]
        [Then(@"I save workflow ""(.*)""")]
        void Save(string workflowName)
        {
            BuildDataList();

            var activityList = _commonSteps.GetActivityList();

            var flowSteps = new List<FlowStep>();

            TestStartNode = new FlowStep();
            flowSteps.Add(TestStartNode);

            foreach (var activity in activityList)
            {
                if (TestStartNode.Action == null)
                {
                    TestStartNode.Action = activity.Value;
                }
                else
                {
                    var flowStep = new FlowStep { Action = activity.Value };
                    flowSteps.Last().Next = flowStep;
                    flowSteps.Add(flowStep);
                }
            }
            TryGetValue(workflowName, out IContextualResourceModel resourceModel);
            TryGetValue("environment", out IServer server);
            TryGetValue("resourceRepo", out IResourceRepository repository);

            var currentDl = CurrentDl;
            resourceModel.DataList = currentDl.Replace("root", "DataList");
            var helper = new WorkflowHelper();
            var xamlDefinition = helper.GetXamlDefinition(FlowchartActivityBuilder);
            resourceModel.WorkflowXaml = xamlDefinition;
            repository.SaveToServer(resourceModel);

        }

        [Then(@"workflow ""(.*)"" is deleted as cleanup")]
        public void ThenWorkflowIsDeletedAsCleanup(string workflowName)
        {
            TryGetValue(workflowName, out IContextualResourceModel resourceModel);
            TryGetValue("environment", out IServer server);
            TryGetValue("resourceRepo", out IResourceRepository repository);

            repository.DeleteResourceFromWorkspace(resourceModel);
            repository.DeleteResource(resourceModel);
        }

        [Then(@"the folder ""(.*)"" is deleted from the server as cleanup")]
        public void ThenTheFolderIsDeletedFromTheServerAsCleanup(string shapointLocalFolder)
        {
            var folderToDelete = Path.Combine(EnvironmentVariables.ResourcePath, shapointLocalFolder);
            Directory.Delete(folderToDelete, true);
        }

        [Then(@"workflow ""(.*)"" has ""(.*)"" Versions in explorer")]
        public void ThenWorkflowHasVersionsInExplorer(string workflowName, int numberOfVersions)
        {
            TryGetValue("SavedId", out Guid id);
            TryGetValue(workflowName, out IContextualResourceModel resourceModel);
            TryGetValue("environment", out IServer server);
            TryGetValue("resourceRepo", out IResourceRepository repository);
            var rep = new Studio.Core.VersionManagerProxy(new CommunicationControllerFactory(), server.Connection);
            var versions = rep.GetVersions(id);
            _scenarioContext["Versions"] = versions;
            Assert.AreEqual(numberOfVersions, versions.Count);
        }

        [Then(@"explorer as")]
        public void ThenExplorerAs(Table table)
        {
            var versions = _scenarioContext["Versions"] as IList<IExplorerItem>;
            if (versions == null || versions.Count == table.RowCount)
            {
                Assert.Fail("InvalidVersions");
            }
            else
            {
                for (var i = 0; i < versions.Count; i++)
                {
                    var v1 = table.Rows[i + 1][0].Split(' ');
                    Assert.IsTrue(versions[i].DisplayName.Contains(v1[0]));

                }
            }

        }

        [Given(@"""(.*)"" contains a Sequence ""(.*)"" as")]
        public void GivenContainsASequenceAs(string parentName, string activityName)
        {
            var dsfSequence = new DsfSequenceActivity { DisplayName = activityName };
            _commonSteps.AddActivityToActivityList(parentName, activityName, dsfSequence);
        }

        [Given(@"the workflow contains an Assign ""(.*)"" as")]
        [Then(@"the workflow contains an Assign ""(.*)"" as")]
        public void ThenContainsAnAssignAs(string assignName, Table table)
        {
            TryGetValue("parentWorkflowName", out string parentWorkflowName);
            ThenContainsAnAssignAs(parentWorkflowName, assignName, table);
        }

        [Then(@"I update ""(.*)"" by adding ""(.*)"" as")]
        public void ThenIUpdateByAddingAs(string parentName, string activityName, Table table)
        {
            var assignActivity = new DsfMultiAssignActivity { DisplayName = activityName };

            foreach (var tableRow in table.Rows)
            {
                var value = tableRow["value"];
                var variable = tableRow["variable"];

                value = value.Replace('"', ' ').Trim();

                if (value.StartsWith("="))
                {
                    value = value.Replace("=", "");
                    value = $"!~calculation~!{value}!~~calculation~!";
                }
                _scenarioContext.TryGetValue("fieldCollection", out List<ActivityDTO> fieldCollection);

                _commonSteps.AddVariableToVariableList(variable);

                assignActivity.FieldsCollection.Add(new ActivityDTO(variable, value, 1, true));
            }
            _commonSteps.AddActivityToActivityList(parentName, activityName, assignActivity);
        }


        [Then(@"I update ""(.*)"" inputs in ""(.*)"" as")]
        public void ThenIUpdateInputsInAs(string assignName, string parentName, Table table)
        {
            var assignActivity = _commonSteps.GetActivityList()
                .FirstOrDefault(p => p.Key == assignName)
                .Value as DsfMultiAssignActivity;

            foreach (var tableRow in table.Rows)
            {
                var value = tableRow["value"];
                var variable = tableRow["variable"];
                value = value.Replace('"', ' ').Trim();

                _commonSteps.AddVariableToVariableList(variable);
                assignActivity.FieldsCollection.Add(new ActivityDTO(variable, value, 1, true));
            }
        }

        [Given(@"""(.*)"" contains an Assign ""(.*)"" as")]
        [Then(@"""(.*)"" contains an Assign ""(.*)"" as")]
        public void ThenContainsAnAssignAs(string parentName, string assignName, Table table)
        {
            var assignActivity = new DsfMultiAssignActivity { DisplayName = assignName };

            foreach (var tableRow in table.Rows)
            {
                var value = tableRow["value"];
                var variable = tableRow["variable"];

                value = value.Replace('"', ' ').Trim();

                if (value.StartsWith("="))
                {
                    value = value.Replace("=", "");
                    value = $"!~calculation~!{value}!~~calculation~!";
                }
                if (value.Equals("TestingDotnetDllCascading.Food.ToJson"))
                {
                    var serializer = new Dev2JsonSerializer();
                    var serialize = serializer.Serialize(new Food());
                    value = serialize;
                }

                _scenarioContext.TryGetValue("fieldCollection", out List<ActivityDTO> fieldCollection);

                _commonSteps.AddVariableToVariableList(variable);

                assignActivity.FieldsCollection.Add(new ActivityDTO(variable, value, 1, true));
            }
            _commonSteps.AddActivityToActivityList(parentName, assignName, assignActivity);
        }

        [Given(@"""(.*)"" contains a recordset name randomizing Assign ""(.*)"" as")]
        [Then(@"""(.*)"" contains a recordset name randomizing Assign ""(.*)"" as")]
        public void ThenContainsARecordsetNameRandomizingAssignAs(string parentName, string assignName, Table table)
        {
            var assignActivity = new DsfMultiAssignActivity { DisplayName = assignName };
            var recordsetNameRandomizer = new Random().Next(60) + 1;
            ScenarioContext.Current.Add("recordsetNameRandomizer", recordsetNameRandomizer);

            foreach (var tableRow in table.Rows)
            {
                var value = tableRow["value"];
                var variable = tableRow["variable"];

                var endOfRecordsetName = variable.IndexOf('(');
                variable = variable.Substring(0, endOfRecordsetName) + "_" + recordsetNameRandomizer.ToString() + variable.Substring(endOfRecordsetName, variable.Length - endOfRecordsetName);

                _scenarioContext.TryGetValue("fieldCollection", out List<ActivityDTO> fieldCollection);

                _commonSteps.AddVariableToVariableList(variable);

                assignActivity.FieldsCollection.Add(new ActivityDTO(variable, value, 1, true));
            }
            _commonSteps.AddActivityToActivityList(parentName, assignName, assignActivity);
        }

        [Given(@"""(.*)"" contains an Assign for Json ""(.*)"" as")]
        [Then(@"""(.*)"" contains an Assign for Json ""(.*)"" as")]
        public void GivenContainsAnAssignForJsonAs(string parentName, string assignName, Table table)
        {
            var assignActivity = new DsfMultiAssignActivity { DisplayName = assignName };
            foreach (var tableRow in table.Rows)
            {
                var value = "{\"Name\":\"Bob\"}";
                var variable = tableRow["variable"];

                if (value.StartsWith("="))
                {
                    value = value.Replace("=", "");
                    value = $"!~calculation~!{value}!~~calculation~!";
                }

                _scenarioContext.TryGetValue("fieldCollection", out List<ActivityDTO> fieldCollection);

                _commonSteps.AddVariableToVariableList(variable);

                assignActivity.FieldsCollection.Add(new ActivityDTO(variable, value, 1, true));
            }
            _commonSteps.AddActivityToActivityList(parentName, assignName, assignActivity);
        }

        [Given(@"""(.*)"" contains a DsfRabbitMQPublish ""(.*)"" into ""(.*)""")]
        [Then(@"""(.*)"" contains a DsfRabbitMQPublish ""(.*)"" into ""(.*)""")]
        [When(@"""(.*)"" contains a DsfRabbitMQPublish ""(.*)"" into ""(.*)""")]
        public void GivenContainsADsfRabbitMQPublishInto(string parentName, string rabbitMqname, string result)
        {
            var jsonMsg = new Human().SerializeToJsonStringBuilder().ToString();
            var dsfPublishRabbitMqActivity = new DsfPublishRabbitMQActivity
            {
                RabbitMQSourceResourceId = ConfigurationManager.AppSettings["testRabbitMQSource"].ToGuid()
              ,
                Result = result
              ,
                DisplayName = rabbitMqname,
                Message = jsonMsg
            };
            _commonSteps.AddActivityToActivityList(parentName, rabbitMqname, dsfPublishRabbitMqActivity);
        }

        [Given(@"""(.*)"" contains a RabbitMQPublish ""(.*)"" into ""(.*)""")]
        [Then(@"""(.*)"" contains a RabbitMQPublish ""(.*)"" into ""(.*)""")]
        [When(@"""(.*)"" contains a RabbitMQPublish ""(.*)"" into ""(.*)""")]
        public void GivenContainsARabbitMQPublishInto(string parentName, string rabbitMqname, string result)
        {
            var jsonMsg = new Human().SerializeToJsonStringBuilder().ToString();
            var dsfPublishRabbitMqActivity = new PublishRabbitMQActivity
            {
                RabbitMQSourceResourceId = ConfigurationManager.AppSettings["testRabbitMQSource"].ToGuid()
              ,
                Result = result,
                DisplayName = rabbitMqname,
                Message = jsonMsg
            };
            _commonSteps.AddActivityToActivityList(parentName, rabbitMqname, dsfPublishRabbitMqActivity);
        }

        [Given(@"""(.*)"" contains an DotNet DLL ""(.*)"" as")]
        [Then(@"""(.*)"" contains an DotNet DLL ""(.*)"" as")]
        public void GivenContainsAnDotNetDLLAs(string parentName, string dotNetServiceName, Table table)
        {
            var dsfEnhancedDotNetDllActivity = new DsfEnhancedDotNetDllActivity()
            {
                IsObject = true,
                DisplayName = dotNetServiceName
            };
            var Source = table.Rows[0]["Source"];
            var ClassName = table.Rows[0]["ClassName"];
            var ObjectName = table.Rows[0]["ObjectName"];
            var Action = table.Rows[0]["Action"];
            var ActionOutputVaribale = table.Rows[0]["ActionOutputVaribale"];
            dsfEnhancedDotNetDllActivity.ObjectName = ObjectName;
            var proxy = new StudioServerProxy(new CommunicationControllerFactory(), LocalEnvModel.Connection);
            var pluginSource = proxy.QueryManagerProxy.FetchPluginSources().Single(source => source.Name.Equals(Source, StringComparison.InvariantCultureIgnoreCase));
            var namespaceItems = proxy.QueryManagerProxy.FetchNamespacesWithJsonRetunrs(pluginSource);
            var namespaceItem = namespaceItems.Single(item => item.FullName.Equals(ClassName, StringComparison.CurrentCultureIgnoreCase));
            var pluginActions = proxy.QueryManagerProxy.PluginActionsWithReturns(pluginSource, namespaceItem);
            allPluginActions = pluginActions.ToList();
            var pluginAction = pluginActions.Single(action => action.Method.Equals(Action, StringComparison.InvariantCultureIgnoreCase));
            var pluginConstructors = proxy.QueryManagerProxy.PluginConstructors(pluginSource, namespaceItem);
            const string recNumber = "[[rec(*).number]]";
            foreach (var serviceInput in pluginAction.Inputs)
            {
                serviceInput.Value = recNumber;
            }
            dsfEnhancedDotNetDllActivity.Namespace = namespaceItem;
            dsfEnhancedDotNetDllActivity.SourceId = pluginSource.Id;
            ScenarioContext.Current.Add(dotNetServiceName, dsfEnhancedDotNetDllActivity);
            ScenarioContext.Current.Add("pluginConstructors", pluginConstructors);
            _commonSteps.AddVariableToVariableList(ObjectName);
            _commonSteps.AddVariableToVariableList(ActionOutputVaribale);
            _commonSteps.AddVariableToVariableList(recNumber);
            _commonSteps.AddActivityToActivityList(parentName, dotNetServiceName, dsfEnhancedDotNetDllActivity);
        }

        [Given(@"""(.*)"" contains a DropboxUpload ""(.*)"" Setup as")]
        public void GivenContainsADropboxUploadSetupAs(string parentName, string dotNetServiceName, Table table)
        {
            var uploadActivity = new DsfDropBoxUploadActivity()
            {
                DisplayName = dotNetServiceName,

            };

            var dropBoxSource = GetDropBoxSource();
            uploadActivity.SelectedSource = dropBoxSource;
            var localFile = table.Rows[0]["Local File"];
            var localFileUniqueNameGuid = CommonSteps.GetGuid();
            localFile = CommonSteps.AddGuidToPath(localFile, localFileUniqueNameGuid);
            ScenarioContext.Current.Add("localFileUniqueNameGuid", localFileUniqueNameGuid);
            Console.WriteLine("Generated new local file path as " + localFileUniqueNameGuid + ".");
            var overwriteOrAdd = table.Rows[0]["OverwriteOrAdd"];
            var dropboxFile = table.Rows[0]["DropboxFile"];
            var serverPathToUniqueNameGuid = CommonSteps.GetGuid();
            dropboxFile = CommonSteps.AddGuidToPath(dropboxFile, serverPathToUniqueNameGuid);
            ScenarioContext.Current.Add("serverPathToUniqueNameGuid", serverPathToUniqueNameGuid);
            Console.WriteLine("Generated new server path for dropbox server path as " + serverPathToUniqueNameGuid + ".");
            var result = table.Rows[0]["Result"];
            uploadActivity.FromPath = localFile;
            uploadActivity.OverWriteMode = overwriteOrAdd.ToLower() == "Overwrite".ToLower();
            uploadActivity.ToPath = dropboxFile;

            File.Create(localFile).Close();
            _commonSteps.AddVariableToVariableList(result);
            _commonSteps.AddActivityToActivityList(parentName, dotNetServiceName, uploadActivity);
        }

        [Given(@"""(.*)"" contains a DropboxList ""(.*)"" Setup as")]
        public void GivenContainsADropboxListSetupAs(string parentName, string dotNetServiceName, Table table)
        {
            var listActivity = new DsfDropboxFileListActivity()
            {
                DisplayName = dotNetServiceName,
            };
            var dropBoxSource = GetDropBoxSource();
            listActivity.SelectedSource = dropBoxSource;
            var result = table.Rows[0]["Result"];
            var DropboxFile = table.Rows[0]["DropboxFile"];
            listActivity.ToPath = DropboxFile;
            var read = table.Rows[0]["Read"];
            var loadSubFolders = table.Rows[0]["LoadSubFolders"];
            switch (read)
            {
                case "Files":
                    listActivity.IsFilesSelected = true;
                    break;
                case "Folders":
                    listActivity.IsFoldersSelected = true;
                    break;
                case "All":
                    listActivity.IsFilesAndFoldersSelected = true;
                    break;
                default:
                    break;
            }
            var b = bool.Parse(loadSubFolders);
            listActivity.IsRecursive = b;
            _commonSteps.AddVariableToVariableList(result);
            _commonSteps.AddActivityToActivityList(parentName, dotNetServiceName, listActivity);
        }


        static DropBoxSource GetDropBoxSource()
        {
            var guid = "dc163197-7a76-4f4c-a783-69d6d53b2f3a".ToGuid();
            var resourceList = LocalEnvModel.ResourceRepository.LoadContextualResourceModel(guid);
            var serviceDefinition = resourceList.ToServiceDefinition();
            var dropBoxSource = new DropBoxSource(serviceDefinition.ToXElement());
            return dropBoxSource;
        }

        [Given(@"""(.*)"" contains a DropboxDownLoad ""(.*)"" Setup as")]
        public void GivenContainsADropboxDownLoadSetupAs(string parentName, string dotNetServiceName, Table table)
        {
            var downloadActivity = new DsfDropBoxDownloadActivity()
            {
                DisplayName = dotNetServiceName,

            };
            var dropBoxSource = GetDropBoxSource();
            downloadActivity.SelectedSource = dropBoxSource;
            downloadActivity.FromPath = table.Rows[0]["Local File"];
            var serverPathUniqueNameGuid = ScenarioContext.Current.Get<string>("serverPathToUniqueNameGuid");
            downloadActivity.ToPath = CommonSteps.AddGuidToPath(table.Rows[0]["DropboxFile"], serverPathUniqueNameGuid);
            var overwriteOrAdd = table.Rows[0]["OverwriteOrAdd"];
            downloadActivity.OverwriteFile = overwriteOrAdd.ToLower() == "Overwrite".ToLower();
            var result = table.Rows[0]["Result"];
            _commonSteps.AddVariableToVariableList(result);
            _commonSteps.AddActivityToActivityList(parentName, dotNetServiceName, downloadActivity);
        }

        [Given(@"""(.*)"" contains a DropboxDelete ""(.*)"" Setup as")]
        public void GivenContainsADropboxDeleteSetupAs(string parentName, string dotNetServiceName, Table table)
        {
            var deleteActivity = new DsfDropBoxDeleteActivity()
            {
                DisplayName = dotNetServiceName,

            };
            var dropBoxSource = GetDropBoxSource();
            deleteActivity.SelectedSource = dropBoxSource;
            var dropboxFile = table.Rows[0]["DropboxFile"];
            var serverPathUniqueNameGuid = ScenarioContext.Current.Get<string>("serverPathToUniqueNameGuid");
            dropboxFile = CommonSteps.AddGuidToPath(dropboxFile, serverPathUniqueNameGuid);
            deleteActivity.DeletePath = dropboxFile;
            var result = table.Rows[0]["Result"];
            _commonSteps.AddVariableToVariableList(result);
            _commonSteps.AddActivityToActivityList(parentName, dotNetServiceName, deleteActivity);
        }

        [Given(@"""(.*)"" contains an COM DLL ""(.*)"" as")]
        [Then(@"""(.*)"" contains an COM DLL ""(.*)"" as")]
        public void GivenContainsAnCOMDLLAs(string parentName, string dotNetServiceName, Table table)
        {
            var dsfEnhancedDotNetDllActivity = new DsfComDllActivity()
            {
                DisplayName = dotNetServiceName
            };
            var namespaceSelected = table.Rows[0]["Namespace"];
            var Action = table.Rows[0]["Action"];

            var controllerFactory = new CommunicationControllerFactory();
            var sourceId = "ed7c3655-4922-4f24-9881-83462661832d".ToGuid();
            var environmentConnection = LocalEnvModel.Connection;
            var mock = new Mock<IShellViewModel>();
            var proxy = new StudioServerProxy(controllerFactory, environmentConnection);
            var fetchComPluginSources = proxy.QueryManagerProxy.FetchComPluginSources();
            var pluginSource = fetchComPluginSources.Single(source => source.Id == sourceId);
            var dbServiceModel = new ManageComPluginServiceModel(new StudioResourceUpdateManager(controllerFactory, environmentConnection)
                                                                                   , proxy.QueryManagerProxy
                                                                                   , mock.Object
                                                                                   , new Server(Guid.NewGuid(), environmentConnection));
            var namespaceItems = dbServiceModel.GetNameSpaces(pluginSource);
            var namespaceItem = namespaceItems.Single(item => item?.FullName?.Equals(namespaceSelected, StringComparison.CurrentCultureIgnoreCase) ?? false);
            var pluginActions = dbServiceModel.GetActions(pluginSource, namespaceItem);
            allPluginActions = pluginActions.ToList();
            var pluginAction = pluginActions.First(action => action.Method.Equals(Action, StringComparison.InvariantCultureIgnoreCase));
            var comPluginServiceDefinition = new ComPluginServiceDefinition()
            {
                Action = pluginAction,
                Source = pluginSource,
            };
            var testResult = dbServiceModel.TestService(comPluginServiceDefinition);
            var serializer = new Dev2JsonSerializer();
            var responseService = serializer.Deserialize<RecordsetListWrapper>(testResult);
            if (responseService != null)
            {
                if (responseService.RecordsetList.Any(recordset => recordset.HasErrors))
                {
                    var errorMessage = string.Join(Environment.NewLine, responseService.RecordsetList.Select(recordset => recordset.ErrorMessage));
                    throw new Exception(errorMessage);
                }
                var _recordsetList = responseService.RecordsetList;
                if (_recordsetList.Any(recordset => recordset.HasErrors))
                {
                    var errorMessage = string.Join(Environment.NewLine, _recordsetList.Select(recordset => recordset.ErrorMessage));
                    throw new Exception(errorMessage);
                }
                dsfEnhancedDotNetDllActivity.OutputDescription = responseService.Description;

                var outputMapping = _recordsetList.SelectMany(recordset => recordset.Fields, (recordset, recordsetField) =>
                {
                    var serviceOutputMapping = new ServiceOutputMapping(recordsetField.Name, recordsetField.Alias, recordset.Name) { Path = recordsetField.Path };
                    return serviceOutputMapping;
                }).Cast<IServiceOutputMapping>().ToList();

                dsfEnhancedDotNetDllActivity.Outputs = outputMapping;
            }


            dsfEnhancedDotNetDllActivity.Method = pluginAction;
            dsfEnhancedDotNetDllActivity.Namespace = namespaceItem;
            dsfEnhancedDotNetDllActivity.SourceId = pluginSource.Id;

            _commonSteps.AddActivityToActivityList(parentName, dotNetServiceName, dsfEnhancedDotNetDllActivity);
        }

        List<IPluginAction> allPluginActions { get; set; }
        [Given(@"""(.*)"" constructorinputs (.*) with inputs as")]
        public void GivenConstructorWithInputsAs(string serviceName, int p1, Table table)
        {
            var dsfEnhancedDotNetDllActivity = ScenarioContext.Current.Get<DsfEnhancedDotNetDllActivity>(serviceName);
            var pluginConstructors = ScenarioContext.Current.Get<IList<IPluginConstructor>>("pluginConstructors");
            var pluginConstructor = pluginConstructors.FirstOrDefault(constructor => constructor.Inputs.Count == p1);
            dsfEnhancedDotNetDllActivity.Constructor = pluginConstructor;
            dsfEnhancedDotNetDllActivity.ConstructorInputs = new List<IServiceInput>();
            foreach (var tableRow in table.Rows)
            {
                var inputName = tableRow["parameterName"];
                var value = tableRow["value"];
                var type = tableRow["type"];
                dsfEnhancedDotNetDllActivity.ConstructorInputs.Add(new ServiceInput(inputName, value)
                {
                    TypeName = type
                });
            }
        }

        [Given(@"""(.*)"" service Action ""(.*)"" with inputs and output ""(.*)"" as")]
        public void GivenServiceActionWithInputsAndOutputAs(string serviceName, string action, string outputVar, Table table)
        {
            var dsfEnhancedDotNetDllActivity = ScenarioContext.Current.Get<DsfEnhancedDotNetDllActivity>(serviceName);
            var pluginAction = allPluginActions.Single(action1 => action1.Method == action);
            pluginAction.OutputVariable = outputVar;
            foreach (var tableRow in table.Rows)
            {
                var inputName = tableRow["parameterName"];
                var value = tableRow["value"];
                var serviceInput = pluginAction.Inputs.Single(input => input.Name == inputName);
                serviceInput.Value = value;
            }
            dsfEnhancedDotNetDllActivity.MethodsToRun.Add(pluginAction);
        }

        [Given(@"""(.*)"" contains an Assign Object ""(.*)"" as")]
        [Then(@"""(.*)"" contains an Assign Object ""(.*)"" as")]
        public void GivenContainsAnAssignObjectAs(string parentName, string assignName, Table table)
        {

            var assignActivity = new DsfMultiAssignObjectActivity { DisplayName = assignName };

            foreach (var tableRow in table.Rows)
            {
                var value = tableRow["value"];
                var variable = tableRow["variable"];

                value = value.Replace('"', ' ').Trim();

                if (value.StartsWith("="))
                {
                    value = value.Replace("=", "");
                    value = $"!~calculation~!{value}!~~calculation~!";
                }

                _scenarioContext.TryGetValue("fieldCollection", out List<ActivityDTO> fieldCollection);

                _commonSteps.AddVariableToVariableList(variable);

                assignActivity.FieldsCollection.Add(new AssignObjectDTO(variable, value, 1, true));
            }
            _commonSteps.AddActivityToActivityList(parentName, assignName, assignActivity);
        }

        [When(@"I rollback ""(.*)"" to version ""(.*)""")]
        public void WhenIRollbackToVersion(string workflowName, string version)
        {
            TryGetValue("SavedId", out Guid id);
            TryGetValue(workflowName, out IContextualResourceModel resourceModel);
            TryGetValue("environment", out IServer server);
            TryGetValue("resourceRepo", out IResourceRepository repository);
            var rep = new VersionManagerProxy(new CommunicationControllerFactory(), server.Connection);
            rep.RollbackTo(id, version);
        }

        [When(@"""(.*)"" is executed without saving")]
        public void WhenIsExecutedWithoutSaving(string workflowName)
        {
            TryGetValue(workflowName, out IContextualResourceModel resourceModel);
            TryGetValue("environment", out IServer server);
            TryGetValue("resourceRepo", out IResourceRepository repository);

            var debugStates = Get<List<IDebugState>>("debugStates").ToList();
            debugStates.Clear();

            ExecuteWorkflow(resourceModel);
        }

        [Then(@"I set logging to ""(.*)""")]
        public void ThenISetLoggingTo(string logLevel)
        {
            var allowedLogLevels = new[] { "DEBUG", "NONE" };
            // TODO: refactor null empty checking into extension method
            if (logLevel == null ||
                !allowedLogLevels.Contains(logLevel.ToUpper()))
            {
                return;
            }

            var loggingSettingsTo = new LoggingSettingsTo { FileLoggerLogLevel = logLevel, EventLogLoggerLogLevel = logLevel, FileLoggerLogSize = 200 };
            var controller = new CommunicationControllerFactory().CreateController("LoggingSettingsWriteService");
            var serializer = new Dev2JsonSerializer();
            controller.AddPayloadArgument("LoggingSettings", serializer.SerializeToBuilder(loggingSettingsTo).ToString());
            TryGetValue("environment", out IServer server);
            controller.ExecuteCommand<StringBuilder>(server.Connection, Guid.Empty);
        }

        [When(@"""(.*)"" is executed ""(.*)""")]
        public void WhenIsExecuted(string workflowName, string executionLabel)
        {
            var st = new Stopwatch();
            st.Start();
            WhenIsExecuted(workflowName);
            _scenarioContext.Add(executionLabel, st.ElapsedMilliseconds);
        }

        [Then(@"the delta between ""(.*)"" and ""(.*)"" is less than ""(.*)"" milliseconds")]
        public void ThenTheDeltaBetweenAndIsLessThanMilliseconds(string executionLabelFirst, string executionLabelSecond, int maxDeltaMilliseconds)
        {
            var e1 = Convert.ToInt32(_scenarioContext[executionLabelFirst]);
            var e2 = Convert.ToInt32(_scenarioContext[executionLabelSecond]);
            var d = maxDeltaMilliseconds;
            d.Should().BeGreaterThan(Math.Abs(e1 - e2), $"async logging should not add more than {d} milliseconds to the execution");
        }

        [Given(@"""(.*)"" contains an Unique ""(.*)"" as")]
        public void GivenContainsAnUniqueAs(string parentName, string activityName, Table table)
        {
            var activity = new DsfUniqueActivity { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var inFields = tableRow["In Field(s)"];
                var returnFields = tableRow["Return Fields"];
                var result = tableRow["Result"];


                _commonSteps.AddVariableToVariableList(result);

                activity.Result = result;
                activity.ResultFields = returnFields;
                activity.InFields = inFields;
            }
            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }

        [Given(@"""(.*)"" contains WebRequest ""(.*)"" as")]
        public void GivenContainsWebRequestAs(string parentName, string toolName, Table table)
        {
            var resultVariable = table.Rows[0]["Result"];
            var url = table.Rows[0]["Url"];

            if (url == "http://TFSBLD.premier.local:9810/api/values") {
                url = url.Replace("TFSBLD.premier.local", _containerOps.Container.IP).Replace("9810", _containerOps.Container.Port);
            }

            _commonSteps.AddVariableToVariableList(resultVariable);
            var dsfWebGetRequestActivity = new DsfWebGetRequestActivity
            {
                DisplayName = toolName
                ,
                Url = url
                ,
                Result = resultVariable
            };

            _commonSteps.AddActivityToActivityList(parentName, toolName, dsfWebGetRequestActivity);
        }

        [Given(@"""(.*)"" contains Advanced Recordset ""(.*)"" with Query ""(.*)""")]
        [When(@"""(.*)"" contains Advanced Recordset ""(.*)"" with Query ""(.*)""")]
        [Then(@"""(.*)"" contains Advanced Recordset ""(.*)"" with Query ""(.*)""")]
        public void GivenContainsAdvancedRecordsetWithQuery(string workflow, string toolname, string query, Table table)
        {
            var activity = new AdvancedRecordsetActivity
            {
                DisplayName = toolname,
                SqlQuery = query,
                Outputs = new List<IServiceOutputMapping>(),
                RecordsetName = "TableCopy",
            };
            foreach (var tableRow in table.Rows)
            {
                var output = tableRow["MappedTo"];
                var toVariable = tableRow["MappedFrom"];
                var recSetName = DataListUtil.ExtractRecordsetNameFromValue(toVariable);
                activity.Outputs.Add(new ServiceOutputMapping(output, toVariable, recSetName));
                _commonSteps.AddVariableToVariableList(toVariable);
            }
            _commonSteps.AddActivityToActivityList(workflow, toolname, activity);
        }


        [Given(@"""(.*)"" contains Calculate ""(.*)"" with formula ""(.*)"" into ""(.*)""")]
        public void GivenCalculateWithFormulaInto(string parentName, string activityName, string formula, string resultVariable)
        {
            _commonSteps.AddVariableToVariableList(resultVariable);

            var calculateActivity = new DsfCalculateActivity { Expression = formula, Result = resultVariable, DisplayName = activityName };

            _commonSteps.AddActivityToActivityList(parentName, activityName, calculateActivity);

        }
        [Given(@"""(.*)"" contains XPath \\""(.*)"" with source ""(.*)""")]
        public void GivenContainsXPathWithResultAs(string parentName, string xpathName, string source)
        {
            const string a = "<XPATH-EXAMPLE>  <CUSTOMER id=\"1\" type=\"B\">Mr.  Jones</CUSTOMER><CUSTOMER id=\"2\" type=\"C\">Mr.  Johnson</CUSTOMER></XPATH-EXAMPLE> ";
            var dsfXPathActivity = new DsfXPathActivity
            {

                SourceString = a
                ,
                DisplayName = xpathName
                ,
                ResultsCollection = new List<XPathDTO>
                {
                    new XPathDTO("[[singleValue]]", source, 1, true)
                }
            };
            _commonSteps.AddActivityToActivityList(parentName, xpathName, dsfXPathActivity);
        }

        [Given(@"""(.*)"" contains Aggregate Calculate ""(.*)"" with formula ""(.*)"" into ""(.*)""")]
        public void GivenAggregateCalculateWithFormulaInto(string parentName, string activityName, string formula, string resultVariable)
        {
            _commonSteps.AddVariableToVariableList(resultVariable);

            var calculateActivity = new DsfAggregateCalculateActivity { Expression = formula, Result = resultVariable, DisplayName = activityName };

            _commonSteps.AddActivityToActivityList(parentName, activityName, calculateActivity);

        }

        [Given(@"the workflow contains Count Record ""(.*)"" on ""(.*)"" into ""(.*)""")]
        public void GivenCountOnIntoTheWorkflow(string activityName, string recordSet, string result)
        {
            TryGetValue("parentWorkflowName", out string parentWorkflowName);
            GivenCountOnInto(parentWorkflowName, activityName, recordSet, result);
        }

        [Given(@"""(.*)"" contains Count Record ""(.*)"" on ""(.*)"" into ""(.*)""")]
        public void GivenCountOnInto(string parentName, string activityName, string recordSet, string result)
        {
            _commonSteps.AddVariableToVariableList(result);

            var countRecordsetNullHandlerActivity = new DsfCountRecordsetNullHandlerActivity { CountNumber = result, RecordsetName = recordSet, DisplayName = activityName };

            _commonSteps.AddActivityToActivityList(parentName, activityName, countRecordsetNullHandlerActivity);
        }

        [Given(@"""(.*)"" contains Delete ""(.*)"" as")]
        public void GivenItContainsDeleteAs(string parentName, string activityName, Table table)
        {
            var nullHandlerActivity = new DsfDeleteRecordActivity { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var result = tableRow["result"];
                var variable = tableRow["Variable"];

                _commonSteps.AddVariableToVariableList(result);
                nullHandlerActivity.RecordsetName = variable;
                nullHandlerActivity.Result = result;
            }

            _commonSteps.AddActivityToActivityList(parentName, activityName, nullHandlerActivity);
        }

        [Given(@"""(.*)"" contains NullHandlerDelete ""(.*)"" as")]
        public void GivenContainsNullHandlerDeleteAs(string parentName, string activityName, Table table)
        {
            var nullHandlerActivity = new DsfDeleteRecordNullHandlerActivity { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var result = tableRow["result"];
                var variable = tableRow["Variable"];

                _commonSteps.AddVariableToVariableList(result);
                nullHandlerActivity.RecordsetName = variable;
                nullHandlerActivity.Result = result;
            }

            _commonSteps.AddActivityToActivityList(parentName, activityName, nullHandlerActivity);
        }


        [Given(@"""(.*)"" contains Find Record Index ""(.*)"" search ""(.*)"" and result ""(.*)"" as")]
        public void GivenItContainsFindRecordIndexSearchAndResultAs(string parentName, string activityName, string recsetToSearch, string resultVariable, Table table)
        {
            var result = resultVariable;
            var recset = recsetToSearch;
            _commonSteps.AddVariableToVariableList(result);
            var activity = new DsfFindRecordsMultipleCriteriaActivity { RequireAllFieldsToMatch = false, RequireAllTrue = false, Result = result, FieldsToSearch = recset, DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var matchType = tableRow["Match Type"];
                var matchValue = tableRow["Match"];

                activity.ResultsCollection.Add(new FindRecordsTO(matchValue, matchType, 1, true));
            }

            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }

        [Given(@"""(.*)"" contains find unique ""(.*)"" as")]
        public void GivenItContainFindUniqueAs(string parentName, string activityName, Table table)
        {
            var activity = new DsfUniqueActivity { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var inFields = tableRow["In Fields"];
                var returnFields = tableRow["Return Fields"];
                var result = tableRow["Result"];

                activity.InFields = inFields;
                activity.ResultFields = returnFields;
                activity.Result = result;

                _commonSteps.AddVariableToVariableList(result);
            }
            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }

        [Given(@"""(.*)"" contains case convert ""(.*)"" as")]
        public void GivenItContainsCaseConvertAs(string parentName, string activityName, Table table)
        {
            var activity = new DsfCaseConvertActivity { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var variableToConvert = tableRow["Variable"];
                var conversionType = tableRow["Type"];

                activity.ConvertCollection.Add(new CaseConvertTO(variableToConvert, conversionType, variableToConvert, 1, true));
            }

            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }

        [Given(@"""(.*)"" contains Gather System Info ""(.*)"" as")]
        public void GivenItContainsGatherSystemInfoAs(string parentName, string activityName, Table table)
        {
            var activity = new DsfGatherSystemInformationActivity { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var variable = tableRow["Variable"];

                _commonSteps.AddVariableToVariableList(variable);

                var systemInfo = (enTypeOfSystemInformationToGather)Dev2EnumConverter.GetEnumFromStringDiscription(tableRow["Selected"], typeof(enTypeOfSystemInformationToGather));
                activity.SystemInformationCollection.Add(new GatherSystemInformationTO(systemInfo, variable, 1));
            }

            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }

        [Given(@"""(.*)"" contains Random ""(.*)"" as")]
        public void GivenItContainsRandomAs(string parentName, string activityName, Table table)
        {
            var activity = new DsfRandomActivity { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var type = (enRandomType)Enum.Parse(typeof(enRandomType), tableRow["Type"]);
                var from = tableRow["From"];
                var to = tableRow["To"];
                var result = tableRow["Result"];

                _commonSteps.AddVariableToVariableList(result);

                activity.RandomType = type;
                activity.To = to;
                activity.From = from;
                activity.Result = result;

            }

            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }

        [Given(@"""(.*)"" contains Format Number ""(.*)"" as")]
        public void GivenItContainsFormatNumberAs(string parentName, string activityName, Table table)
        {
            var activity = new DsfNumberFormatActivity { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var number = tableRow["Number"];
                var roundTo = tableRow["Rounding To"];
                var roundingType = tableRow["Rounding Selected"];
                var decimalPlacesToShow = tableRow["Decimal to show"];
                var result = tableRow["Result"];

                _commonSteps.AddVariableToVariableList(result);

                activity.Expression = number;
                activity.RoundingType = roundingType;
                activity.RoundingDecimalPlaces = roundTo;
                activity.DecimalPlacesToShow = decimalPlacesToShow;
                activity.Result = result;

            }

            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }


        [Given(@"""(.*)"" contains Date and Time ""(.*)"" as")]
        public void GivenItContainsDateAndTimeAs(string parentName, string activityName, Table table)
        {
            var activity = new DsfDateTimeActivity { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var input1 = tableRow["Input"];
                var outputFormat = tableRow["Output Format"];
                var inputFormat = tableRow["Input Format"];
                var timeModifierAmount = tableRow["Add Time"];
                var result = tableRow["Result"];

                _commonSteps.AddVariableToVariableList(result);

                activity.DateTime = input1;
                activity.InputFormat = inputFormat;
                activity.OutputFormat = outputFormat;
                activity.TimeModifierAmountDisplay = timeModifierAmount;
                activity.TimeModifierType = "Years";
                activity.Result = result;

            }

            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }


        [Given(@"""(.*)"" contains Date and Time Difference ""(.*)"" as")]
        public void GivenItContainsDateAndTimeDifferenceAs(string parentName, string activityName, Table table)
        {
            var activity = new DsfDateTimeDifferenceActivity { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var input1 = tableRow["Input1"];
                var input2 = tableRow["Input2"];
                var inputFormat = tableRow["Input Format"];
                var output = tableRow["Output In"];
                var result = tableRow["Result"];

                _commonSteps.AddVariableToVariableList(result);

                activity.Input1 = input1;
                activity.Input2 = input2;
                activity.InputFormat = inputFormat;
                activity.OutputType = output;
                activity.Result = result;

            }

            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }


        [Given(@"""(.*)"" contains Data Split ""(.*)"" as")]
        public void GivenItContainsDataSplitAs(string parentName, string activityName, Table table)
        {
            var activity = new DsfDataSplitActivity { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var valueToSplit = string.IsNullOrEmpty(tableRow["String"]) ? "" : tableRow["String"];
                var variable = tableRow["Variable"];
                var type = tableRow["Type"];
                var at = tableRow["At"];
                var include = tableRow["Include"] == "Selected";
                _commonSteps.AddVariableToVariableList(variable);
                if (!string.IsNullOrEmpty(valueToSplit))
                {
                    activity.SourceString = valueToSplit;
                }
                _commonSteps.AddVariableToVariableList(variable);
                activity.ResultsCollection.Add(new DataSplitDTO(variable, type, at, 1, include, true));
            }

            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }

        [Given(@"""(.*)"" contains Replace ""(.*)"" into ""(.*)"" as")]
        public void GivenItContainsReplaceIntoAs(string parentName, string activityName, string resultVariable, Table table)
        {
            var activity = new DsfReplaceActivity { Result = resultVariable, DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var variable = tableRow["In Fields"];
                var find = tableRow["Find"];
                var replaceValue = tableRow["Replace With"];

                activity.FieldsToSearch = variable;
                activity.Find = find;
                activity.ReplaceWith = replaceValue;
            }
            _commonSteps.AddVariableToVariableList(resultVariable);
            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }


        [Given(@"""(.*)"" contains Find Index ""(.*)"" into ""(.*)"" as")]
        public void GivenItContainsFindIndexIntoAs(string parentName, string activityName, string resultVariable, Table table)
        {
            var activity = new DsfIndexActivity { Result = resultVariable, DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var variable = tableRow["In Fields"];
                var index = tableRow["Index"];
                var character = tableRow["Character"];
                var direction = tableRow["Direction"];

                activity.InField = variable;
                activity.Index = index;
                activity.Characters = character;
                activity.Direction = direction;
            }
            _commonSteps.AddVariableToVariableList(resultVariable);
            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }

        [Given(@"""(.*)"" contains an Create ""(.*)"" as")]
        public void GivenContainsAnCreateAs(string parentName, string activityName, Table table)
        {
            var activity = new DsfPathCreate { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var variable = tableRow["File or Folder"];
                var exist = tableRow["If it exits"];
                var userName = tableRow["Username"];
                var password = tableRow["Password"];
                var result = tableRow["Result"];

                activity.Result = result;
                activity.Username = userName;
                activity.Password = password;
                activity.Overwrite = exist == "True";
                activity.OutputPath = variable;

                _commonSteps.AddVariableToVariableList(result);
            }
            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }

        [Given(@"""(.*)"" contains an Rename ""(.*)"" as")]
        public void GivenContainsAnWriteRenameAs(string parentName, string activityName, Table table)
        {
            var activity = new DsfPathRename { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var variable = tableRow["File or Folder"];
                var destination = tableRow["Destination"];
                var exist = tableRow["If it exits"];
                var userName = tableRow["Username"];
                var password = tableRow["Password"];
                var result = tableRow["Result"];

                activity.Result = result;
                activity.Username = userName;
                activity.Password = password;
                activity.Overwrite = exist == "True";
                activity.OutputPath = destination;
                activity.InputPath = variable;

                _commonSteps.AddVariableToVariableList(result);
            }
            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }

        [Given(@"""(.*)"" contains an Zip ""(.*)"" as")]
        public void GivenContainsAnZipAs(string parentName, string activityName, Table table)
        {
            var activity = new DsfZip { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var variable = tableRow["File or Folder"];
                var destination = tableRow["Destination"];
                var exist = tableRow["If it exits"];
                var userName = tableRow["Username"];
                var password = tableRow["Password"];
                var result = tableRow["Result"];

                activity.Result = result;
                activity.Username = userName;
                activity.Password = password;
                activity.Overwrite = exist == "True";
                activity.OutputPath = destination;
                activity.InputPath = variable;

                _commonSteps.AddVariableToVariableList(result);
            }
            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }

        [Given(@"""(.*)"" contains an UnZip ""(.*)"" as")]
        public void GivenContainsAnUnZipAs(string parentName, string activityName, Table table)
        {
            var activity = new DsfUnZip { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var variable = tableRow["File or Folder"];
                var destination = tableRow["Destination"];
                var exist = tableRow["If it exits"];
                var userName = tableRow["Username"];
                var password = tableRow["Password"];
                var result = tableRow["Result"];

                activity.Result = result;
                activity.Username = userName;
                activity.Password = password;
                activity.Overwrite = exist == "True";
                activity.OutputPath = destination;
                activity.InputPath = variable;

                _commonSteps.AddVariableToVariableList(result);
            }
            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }




        [Given(@"""(.*)"" contains an Move ""(.*)"" as")]
        public void GivenContainsAnMoveAs(string parentName, string activityName, Table table)
        {
            var activity = new DsfPathMove { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var source = tableRow["File or Folder"];
                var exist = tableRow["If it exits"];
                var userName = tableRow["Username"];
                var password = tableRow["Password"];
                var result = tableRow["Result"];
                var desc = tableRow["Destination"];

                activity.Result = result;
                activity.Username = userName;
                activity.Password = password;
                activity.Overwrite = exist == "True";
                activity.OutputPath = desc;
                activity.InputPath = source;



                _commonSteps.AddVariableToVariableList(result);
            }
            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }

        [Given(@"""(.*)"" contains an Read Folder ""(.*)"" as")]
        public void GivenContainsAnReadFolderAs(string parentName, string activityName, Table table)
        {
            var activity = new DsfFolderRead { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var source = tableRow["File or Folder"];
                var userName = tableRow["Username"];
                var password = tableRow["Password"];
                var result = tableRow["Result"];
                var isFoldersSelected = tableRow["Folders"];

                activity.Result = result;
                activity.Username = userName;
                activity.Password = password;
                activity.InputPath = source;
                activity.IsFoldersSelected = isFoldersSelected == "True";
                _commonSteps.AddVariableToVariableList(result);
            }
            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }

        [Given(@"I create temp file as ""(.*)""")]
        public void GivenICreateTempFileAs(string fileName)
        {
            using (var sw = File.Create(fileName))
            {
                Assert.IsNotNull(sw);
            }
        }


        [Given(@"I create temp file to read from as ""(.*)""")]
        public void GivenICreateTempFileToReadFromAs(string path)
        {
            using (var sw = File.CreateText(path))
            {
                sw.WriteLine("Hello");
            }
        }

        [Given(@"""(.*)"" contains RabbitMQPublish ""(.*)"" into ""(.*)""")]
        public void GivenContainsRabbitMQPublishInto(string parentName, string activityName, string variable)
        {
            var dsfPublishRabbitMqActivity = new PublishRabbitMQActivity
            {
                RabbitMQSourceResourceId = ConfigurationManager.AppSettings["testRabbitMQSource"].ToGuid(),
                Result = variable,
                DisplayName = activityName
            };
            _commonSteps.AddActivityToActivityList(parentName, activityName, dsfPublishRabbitMqActivity);
        }

        [Given(@"""(.*)"" contains DsfRabbitMQPublish and Queue1 ""(.*)"" into ""(.*)""")]
        public void GivenContainsDsfRabbitandQueue1MQPublishInto(string parentName, string activityName, string variable)
        {
            var dsfPublishRabbitMqActivity = new DsfPublishRabbitMQActivity
            {
                RabbitMQSourceResourceId = ConfigurationManager.AppSettings["testRabbitMQSource"].ToGuid()
                ,
                Result = variable
                ,
                DisplayName = activityName,
                QueueName = "Queue1",
                Message = "msg"
            };
            _commonSteps.AddActivityToActivityList(parentName, activityName, dsfPublishRabbitMqActivity);
        }
        [Given(@"""(.*)"" contains RabbitMQPublish and Queue1 - CorrelationID ""(.*)"" into ""(.*)""")]
        public void GivenContainsRabbitandQueue1MQPublishInto(string parentName, string activityName, string variable)
        {
            var dsfPublishRabbitMqActivity = new PublishRabbitMQActivity
            {
                RabbitMQSourceResourceId = ConfigurationManager.AppSettings["testRabbitMQSource"].ToGuid(),
                Result = variable,
                DisplayName = activityName,
                QueueName = "Queue1",
                Message = "msg"
            };
           // dsfPublishRabbitMqActivity.BasicProperties.CorrelationID = "CorrelationID";
            _commonSteps.AddActivityToActivityList(parentName, activityName, dsfPublishRabbitMqActivity);
        }

        [Given(@"""(.*)"" contains RabbitMQConsume ""(.*)"" into ""(.*)""")]
        public void GivenContainsRabbitMQConsumeInto(string parentName, string activityName, string variable)
        {
            _containerOps = new Depends(Depends.ContainerType.RabbitMQ, true);
            var dsfConsumeRabbitMqActivity = new DsfConsumeRabbitMQActivity
            {
                RabbitMQSourceResourceId = ConfigurationManager.AppSettings["testRabbitMQSource"].ToGuid()

                ,
                Response = variable
                ,
                DisplayName = activityName
            };

            ScenarioContext.Current.Add("RabbitMqTool", dsfConsumeRabbitMqActivity);
            _commonSteps.AddActivityToActivityList(parentName, activityName, dsfConsumeRabbitMqActivity);
        }

        [Given(@"""(.*)"" is object is set to ""(.*)""")]
        public void GivenIsObjectIsSetTo(string toolName, string isObjectString)
        {
            var isObject = bool.Parse(isObjectString);
            var dsfConsumeRabbitMqActivity = ScenarioContext.Current.Get<DsfConsumeRabbitMQActivity>("RabbitMqTool");
            dsfConsumeRabbitMqActivity.IsObject = isObject;
        }

        [Given(@"""(.*)"" objectname as ""(.*)""")]
        public void GivenObjectnameAs(string toolName, string Objectname)
        {
            var dsfConsumeRabbitMqActivity = ScenarioContext.Current.Get<DsfConsumeRabbitMQActivity>("RabbitMqTool");
            dsfConsumeRabbitMqActivity.ObjectName = Objectname;
        }

        [Given(@"Queue Name as ""(.*)""")]
        public void GivenQueueNameAs(string queueName)
        {
            var dsfConsumeRabbitMqActivity = ScenarioContext.Current.Get<DsfConsumeRabbitMQActivity>("RabbitMqTool");
            dsfConsumeRabbitMqActivity.QueueName = queueName;
        }


        [Given(@"""(.*)"" contains RabbitMQConsume ""(.*)"" with timeout (.*) seconds into ""(.*)""")]
        public void GivenContainsRabbitMQConsumeWithTimeoutSecondsInto(string parentName, string activityName, int timeout, string variable)
        {
            _containerOps = new Depends(Depends.ContainerType.RabbitMQ, true);
            var dsfConsumeRabbitMqActivity = new DsfConsumeRabbitMQActivity
            {
                RabbitMQSourceResourceId = ConfigurationManager.AppSettings["testRabbitMQSource"].ToGuid()
                ,
                Response = variable
                ,
                DisplayName = activityName,
                TimeOut = timeout == -1 ? "" : timeout.ToString(),
                QueueName = "Queue1",
            };
            _commonSteps.AddActivityToActivityList(parentName, activityName, dsfConsumeRabbitMqActivity);
        }


        [Given(@"""(.*)"" contains RabbitMQConsume ""(.*)"" and Queue Name '(.*)' into ""(.*)""")]
        public void GivenContainsRabbitMQConsumeAndQueueNameInto(string parentName, string activityName, string queueName, string resultVariable)
        {
            var dsfConsumeRabbitMqActivity = new DsfConsumeRabbitMQActivity
            {
                RabbitMQSourceResourceId = ConfigurationManager.AppSettings["testRabbitMQSource"].ToGuid(),
                Response = resultVariable,
                QueueName = queueName,
                DisplayName = activityName
            };
            _commonSteps.AddActivityToActivityList(parentName, activityName, dsfConsumeRabbitMqActivity);
        }

        [Given(@"""(.*)"" contains an Read File ""(.*)"" as")]
        public void GivenContainsAnReadFileAs(string parentName, string activityName, Table table)
        {

            var activity = new DsfFileRead { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var source = tableRow["File or Folder"];
                var userName = tableRow["Username"];
                var password = tableRow["Password"];
                var result = tableRow["Result"];

                activity.Result = result;
                activity.Username = userName;
                activity.Password = password;
                activity.InputPath = source;
                _commonSteps.AddVariableToVariableList(result);
            }
            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }

        [Given(@"""(.*)"" contains an Write File ""(.*)"" as")]
        public void GivenContainsAnWriteFileAs(string parentName, string activityName, Table table)
        {
            var activity = new DsfFileWrite { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var source = tableRow["File or Folder"];
                var userName = tableRow["Username"];
                var password = tableRow["Password"];
                var result = tableRow["Result"];
                var overWrite = tableRow["If it exits"];

                activity.Result = result;
                activity.Username = userName;
                activity.Password = password;
                activity.OutputPath = source;
                activity.Overwrite = overWrite == "True";
                _commonSteps.AddVariableToVariableList(result);
            }
            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }




        [Given(@"""(.*)"" contains an Delete Folder ""(.*)"" as")]
        public void GivenContainsAnDeleteFolderAs(string parentName, string activityName, Table table)
        {
            var activity = new DsfPathDelete { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var variable = tableRow["Recordset"];
                var result = tableRow["Result"];

                activity.Result = result;
                activity.InputPath = variable;

                _commonSteps.AddVariableToVariableList(result);
            }
            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }

        [Given(@"""(.*)"" contains Data Merge ""(.*)"" into ""(.*)"" as")]
        public void GivenItContainsDataMergeAs(string parentName, string activityName, string resultVariable, Table table)
        {
            var activity = new DsfDataMergeActivity { Result = resultVariable, DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var variable = tableRow["Variable"];
                var type = tableRow["Type"];
                var at = tableRow["Using"];
                var padding = tableRow["Padding"];
                var alignment = tableRow["Alignment"];

                activity.MergeCollection.Add(new DataMergeDTO(variable, type, at, 1, padding, alignment, true));
            }
            _commonSteps.AddVariableToVariableList(resultVariable);
            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }

        [Given(@"""(.*)"" contains Base convert ""(.*)"" as")]
        public void GivenItContainsBaseConvertAs(string parentName, string activityName, Table table)
        {
            var activity = new DsfBaseConvertActivity { DisplayName = activityName };
            foreach (var tableRow in table.Rows)
            {
                var variableToConvert = tableRow["Variable"];
                var from = tableRow["From"];
                var to = tableRow["To"];

                activity.ConvertCollection.Add(new BaseConvertTO(variableToConvert, from, to, variableToConvert, 1, true));
            }

            _commonSteps.AddActivityToActivityList(parentName, activityName, activity);
        }

        [Given(@"""(.*)"" contains a postgre tool using ""(.*)"" with mappings for testing as")]
        public void GivenContainsAPostgreToolUsingWithMappingsForTestingAs(string parentName, string serviceName, Table table)
        {
            var inputs = GetServiceInputs(table);
            //Load Source based on the name
            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();
            var environmentConnection = environmentModel.Connection;
            var controllerFactory = new CommunicationControllerFactory();
            var _proxyLayer = new StudioServerProxy(controllerFactory, environmentConnection);
            var mock = new Mock<IShellViewModel>();
            var dbServiceModel = new ManageDbServiceModel(new StudioResourceUpdateManager(controllerFactory, environmentConnection)
                                                                                    , _proxyLayer.QueryManagerProxy
                                                                                    , mock.Object
                                                                                    , environmentModel);
            var dbSources = _proxyLayer.QueryManagerProxy.FetchDbSources().ToList();
            var dbSource = dbSources.Single(source => source.Id == "f8b1a579-2394-489e-835e-21b42e304e09".ToGuid());

            var databaseService = new DatabaseService
            {
                Source = dbSource,
                Inputs = inputs,
                Action = new DbAction()
                {
                    Name = serviceName,
                    SourceId = dbSource.Id,
                    Inputs = inputs,
                    ExecuteAction = serviceName
                },
                Name = "tab_val_func"
                ,
                Id = dbSource.Id

            };
            var testResults = dbServiceModel.TestService(databaseService);

            var mappings = new List<IServiceOutputMapping>();

            if (testResults?.Columns.Count > 1)
            {
                var recordsetName = string.IsNullOrEmpty(testResults.TableName) ? serviceName.Replace(".", "_") : testResults.TableName;
                for (int i = 0; i < testResults.Columns.Count; i++)
                {
                    var column = testResults.Columns[i];
                    var dbOutputMapping = new ServiceOutputMapping(column.ToString(), column.ToString().Replace(" ", ""), recordsetName);
                    mappings.Add(dbOutputMapping);
                }
            }



            var postGreActivity = new DsfPostgreSqlActivity
            {
                ProcedureName = serviceName,
                DisplayName = serviceName,
                SourceId = dbSource.Id,
                Outputs = new List<IServiceOutputMapping>(),
                Inputs = new List<IServiceInput>()
            };

            postGreActivity.Inputs = new List<IServiceInput>()
            {
                new ServiceInput("Prefix","K"),
            };
            postGreActivity.Outputs = mappings;
            _commonSteps.AddVariableToVariableList("[[V1]]");
            _commonSteps.AddActivityToActivityList(parentName, serviceName, postGreActivity);
        }


        [Given(@"""(.*)"" contains a postgre tool using ""(.*)"" with mappings as")]
        public void GivenContainsAPostgreToolUsingWithMappingsAs(string parentName, string serviceName, Table table)
        {

            var resourceId = "62652f31-813a-4b97-b488-02e4c16150ff".ToGuid();

            var postGreActivity = new DsfPostgreSqlActivity
            {
                ProcedureName = serviceName,
                DisplayName = serviceName,
                SourceId = resourceId,
                Outputs = new List<IServiceOutputMapping>(),
                Inputs = new List<IServiceInput>()
            };
            foreach (var tableRow in table.Rows)
            {
                var output = tableRow["Output from Service"];
                var toVariable = tableRow["To Variable"];
                var recSetName = DataListUtil.ExtractRecordsetNameFromValue(toVariable);
                postGreActivity.Outputs.Add(new ServiceOutputMapping(output, toVariable, recSetName));
                _commonSteps.AddVariableToVariableList(toVariable);

                var input = tableRow["Input to Service"];
                var fromVariable = tableRow["From Variable"];
                if (!string.IsNullOrEmpty(input))
                {
                    postGreActivity.Inputs.Add(new ServiceInput(input, fromVariable));
                    _commonSteps.AddVariableToVariableList(fromVariable);
                }
            }
            _commonSteps.AddActivityToActivityList(parentName, serviceName, postGreActivity);
        }

        [Given(@"""(.*)"" contains a mysql database service ""(.*)"" with mappings for testing as")]
        public void GivenContainsAMysqlDatabaseServiceWithMappingsfortesting(string parentName, string serviceName, Table table)
        {
            //Load Source based on the name
            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();
            _containerOps = new Depends(Depends.ContainerType.MySQL, true);
            var environmentConnection = environmentModel.Connection;
            var controllerFactory = new CommunicationControllerFactory();
            var _proxyLayer = new StudioServerProxy(controllerFactory, environmentConnection);
            var mock = new Mock<IShellViewModel>();
            var dbServiceModel = new ManageDbServiceModel(new StudioResourceUpdateManager(controllerFactory, environmentConnection)
                                                                                    , _proxyLayer.QueryManagerProxy
                                                                                    , mock.Object
                                                                                    , environmentModel);
            var dbSources = _proxyLayer.QueryManagerProxy.FetchDbSources().ToList();
            var dbSource = dbSources.Single(source => source.Id == "97d6272e-15a1-483f-afdb-a076f602604f".ToGuid());

            var databaseService = new DatabaseService
            {
                Source = dbSource,
                Inputs = new List<IServiceInput>(),
                Action = new DbAction()
                {
                    Name = serviceName,
                    SourceId = dbSource.Id,
                    Inputs = new List<IServiceInput>(),
                    ExecuteAction = serviceName
                },
                Name = serviceName,
                Id = dbSource.Id,

            };
            var testResults = dbServiceModel.TestService(databaseService);



            var mySqlDatabaseActivity = new DsfMySqlDatabaseActivity()
            {
                ProcedureName = serviceName,
                DisplayName = serviceName,
                SourceId = dbSource.Id,
                Outputs = new List<IServiceOutputMapping>(),
                Inputs = databaseService.Inputs
            };

            var mappings = new List<IServiceOutputMapping>();

            if (testResults?.Columns.Count > 1)
            {
                var recordsetName = string.IsNullOrEmpty(testResults.TableName) ? serviceName.Replace(".", "_") : testResults.TableName;
                for (int i = 0; i < testResults.Columns.Count; i++)
                {
                    var column = testResults.Columns[i];
                    var dbOutputMapping = new ServiceOutputMapping(column.ToString(), column.ToString().Replace(" ", ""), recordsetName);
                    mappings.Add(dbOutputMapping);
                }
            }
            mySqlDatabaseActivity.Outputs = mappings;
            mySqlDatabaseActivity.ProcedureName = serviceName;

            _commonSteps.AddVariableToVariableList("[[MySqlEmail(1).name]]");
            _commonSteps.AddVariableToVariableList("[[MySqlEmail(1).email]]");
            _commonSteps.AddActivityToActivityList(parentName, serviceName, mySqlDatabaseActivity);
        }

        [Given(@"""(.*)"" contains a mysql database service ""(.*)""")]
        public void GivenContainsAMysqlDatabaseService(string parentName, string serviceName)
        {
            var mySqlDatabaseActivity = new DsfMySqlDatabaseActivity
            {
                ProcedureName = serviceName,
                DisplayName = serviceName,
                Outputs = new List<IServiceOutputMapping>(),
                Inputs = new List<IServiceInput>(),
                IsEndedOnError = true
            };
            _commonSteps.AddActivityToActivityList(parentName, serviceName, mySqlDatabaseActivity);
        }

        [Given(@"""(.*)"" contains a mysql database service ""(.*)"" with mappings as")]
        public void GivenContainsAMysqlDatabaseServiceWithMappings(string parentName, string serviceName, Table table)
        {

            var mySqlResourceId = "97d6272e-15a1-483f-afdb-a076f602604f".ToGuid();
            var mySqlDatabaseActivity = new DsfMySqlDatabaseActivity
            {
                ProcedureName = serviceName,
                DisplayName = serviceName,
                SourceId = mySqlResourceId,
                Outputs = new List<IServiceOutputMapping>(),
                Inputs = new List<IServiceInput>()
            };
            foreach (var tableRow in table.Rows)
            {
                var output = tableRow["Output from Service"];
                var toVariable = tableRow["To Variable"];
                var recSetName = DataListUtil.ExtractRecordsetNameFromValue(toVariable);
                mySqlDatabaseActivity.Outputs.Add(new ServiceOutputMapping(output, toVariable, recSetName));
                _commonSteps.AddVariableToVariableList(toVariable);

                var input = tableRow["Input to Service"];
                var fromVariable = tableRow["From Variable"];
                if (!string.IsNullOrEmpty(input))
                {
                    mySqlDatabaseActivity.Inputs.Add(new ServiceInput(input, fromVariable));
                    _commonSteps.AddVariableToVariableList(fromVariable);
                }
            }
            _commonSteps.AddActivityToActivityList(parentName, serviceName, mySqlDatabaseActivity);
        }

        [Given(@"""(.*)"" contains a oracle database service ""(.*)"" with mappings as")]
        public void GivenContainsAOracleDatabaseServiceWithMappingsAs(string parentName, string serviceName, Table table)
        {
            var inputs = GetServiceInputs(table);
            //Load Source based on the name
            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();
            var environmentConnection = environmentModel.Connection;
            var controllerFactory = new CommunicationControllerFactory();
            var _proxyLayer = new StudioServerProxy(controllerFactory, environmentConnection);
            var mock = new Mock<IShellViewModel>();
            var dbServiceModel = new ManageDbServiceModel(new StudioResourceUpdateManager(controllerFactory, environmentConnection)
                                                                                    , _proxyLayer.QueryManagerProxy
                                                                                    , mock.Object
                                                                                    , environmentModel);
            var dbSources = _proxyLayer.QueryManagerProxy.FetchDbSources().ToList();
            var dbSource = dbSources.Single(source => source.Id == "b1c12282-1712-419c-9929-5dfe42c90210".ToGuid());

            var databaseService = new DatabaseService
            {
                Source = dbSource,
                Inputs = inputs,
                Action = new DbAction()
                {
                    Name = serviceName,
                    SourceId = dbSource.Id,
                    Inputs = inputs,
                    ExecuteAction = serviceName
                },
                Name = serviceName,
                Id = dbSource.Id,

            };
            var testResults = dbServiceModel.TestService(databaseService);



            var mySqlDatabaseActivity = new DsfSqlServerDatabaseActivity
            {
                ProcedureName = serviceName,
                DisplayName = serviceName,
                SourceId = dbSource.Id,
                Outputs = new List<IServiceOutputMapping>(),
                Inputs = databaseService.Inputs
            };

            var mappings = new List<IServiceOutputMapping>();

            if (testResults?.Columns.Count > 1)
            {
                var recordsetName = string.IsNullOrEmpty(testResults.TableName) ? serviceName.Replace(".", "_") : testResults.TableName;
                for (int i = 0; i < testResults.Columns.Count; i++)
                {
                    var column = testResults.Columns[i];
                    var dbOutputMapping = new ServiceOutputMapping(column.ToString(), column.ToString().Replace(" ", ""), recordsetName);
                    mappings.Add(dbOutputMapping);
                }
            }
            mySqlDatabaseActivity.Outputs = mappings;
            mySqlDatabaseActivity.ProcedureName = serviceName;

            _commonSteps.AddVariableToVariableList("[[HR_GET_EMP_RS(107).MANAGER_ID]]");
            _commonSteps.AddVariableToVariableList("[[HR_GET_EMP_RS(107).DEPARTMENT_ID]]");
            _commonSteps.AddVariableToVariableList("[[HR_GET_EMP_RS(107).EMPLOYEE_ID]]");
            _commonSteps.AddVariableToVariableList("[[HR_GET_EMP_RS(107).FIRST_NAME]]");
            _commonSteps.AddVariableToVariableList("[[HR_GET_EMP_RS(107).LAST_NAME]]");
            _commonSteps.AddVariableToVariableList("[[HR_GET_EMP_RS(107).EMAIL]]");
            _commonSteps.AddVariableToVariableList("[[HR_GET_EMP_RS(107).PHONE_NUMBER]]");
            _commonSteps.AddVariableToVariableList("[[HR_GET_EMP_RS(107).HIRE_DATE]]");
            _commonSteps.AddVariableToVariableList("[[HR_GET_EMP_RS(107).JOB_ID]]");
            _commonSteps.AddVariableToVariableList("[[HR_GET_EMP_RS(107).SALARY]]");
            _commonSteps.AddVariableToVariableList("[[HR_GET_EMP_RS(107).COMMISSION_PCT]]");
            _commonSteps.AddVariableToVariableList("[[HR_GET_EMP_RS(107).MANAGER_ID]]");
            _commonSteps.AddVariableToVariableList("[[HR_GET_EMP_RS(107).DEPARTMENT_ID]]");
            _commonSteps.AddActivityToActivityList(parentName, serviceName, mySqlDatabaseActivity);
        }


        [Given(@"""(.*)"" contains a sqlserver database service ""(.*)"" with mappings for testing as")]
        public void GivenContainsASqlServerDatabaseServiceWithMappingsForTesting(string parentName, string serviceName, Table table)
        {
            _containerOps = new Depends(Depends.ContainerType.MSSQL, true);
            var inputs = GetServiceInputs(table);
            var resourceId = "b9184f70-64ea-4dc5-b23b-02fcd5f91082".ToGuid();
            //Load Source based on the name
            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();
            var environmentConnection = environmentModel.Connection;
            var controllerFactory = new CommunicationControllerFactory();
            var _proxyLayer = new StudioServerProxy(controllerFactory, environmentConnection);
            var mock = new Mock<IShellViewModel>();
            var dbServiceModel = new ManageDbServiceModel(new StudioResourceUpdateManager(controllerFactory, environmentConnection)
                                                                                    , _proxyLayer.QueryManagerProxy
                                                                                    , mock.Object
                                                                                    , environmentModel);
            var dbSources = _proxyLayer.QueryManagerProxy.FetchDbSources().ToList();
            var dbSource = dbSources.Single(source => source.Id == resourceId);
            dbSource.ServerName += "," + _containerOps.Container.Port;
            var databaseService = new DatabaseService
            {
                Source = dbSource,
                Inputs = inputs,
                Action = new DbAction()
                {
                    Name = serviceName,
                    SourceId = dbSource.Id,
                    Inputs = inputs,
                    ExecuteAction = serviceName
                },
                Name = serviceName,
                Id = dbSource.Id
            };
            var testResults = dbServiceModel.TestService(databaseService);

            var mySqlDatabaseActivity = new DsfSqlServerDatabaseActivity
            {
                ProcedureName = serviceName,
                DisplayName = serviceName,
                SourceId = dbSource.Id,
                Outputs = new List<IServiceOutputMapping>(),
                Inputs = databaseService.Inputs
            };

            var mappings = new List<IServiceOutputMapping>();

            if (testResults?.Columns.Count > 1)
            {
                var recordsetName = string.IsNullOrEmpty(testResults.TableName) ? serviceName.Replace(".", "_") : testResults.TableName;
                for (int i = 0; i < testResults.Columns.Count; i++)
                {
                    var column = testResults.Columns[i];
                    var dbOutputMapping = new ServiceOutputMapping(column.ToString(), column.ToString().Replace(" ", ""), recordsetName);
                    mappings.Add(dbOutputMapping);
                }
            }
            mySqlDatabaseActivity.Outputs = mappings;
            mySqlDatabaseActivity.ProcedureName = serviceName;

            _commonSteps.AddVariableToVariableList("[[dbo_Pr_CitiesGetCountries(2).CountryID]]");
            _commonSteps.AddVariableToVariableList("[[dbo_Pr_CitiesGetCountries(2).Description]]");
            _commonSteps.AddActivityToActivityList(parentName, serviceName, mySqlDatabaseActivity);
        }

        static List<IServiceInput> GetServiceInputs(Table table)
        {
            return table.Rows.Select(a => new ServiceInput(a["ParameterName"], a["ParameterValue"]))
                .Cast<IServiceInput>()
                .ToList();
        }

        [Given(@"""(.*)"" contains a sqlserver database service ""(.*)"" with mappings as")]
        public void GivenContainsASqlServerDatabaseServiceWithMappings(string parentName, string serviceName, Table table)
        {
            _containerOps = new Depends(Depends.ContainerType.MSSQL, true);
            var resourceId = "b9184f70-64ea-4dc5-b23b-02fcd5f91082".ToGuid();

            var mySqlDatabaseActivity = new DsfSqlServerDatabaseActivity
            {
                ProcedureName = serviceName,
                DisplayName = serviceName,
                SourceId = resourceId,
                Outputs = new List<IServiceOutputMapping>(),
                Inputs = new List<IServiceInput>()
            };
            foreach (var tableRow in table.Rows)
            {
                var output = tableRow["Output from Service"];
                var toVariable = tableRow["To Variable"];
                var recSetName = DataListUtil.ExtractRecordsetNameFromValue(toVariable);
                mySqlDatabaseActivity.Outputs.Add(new ServiceOutputMapping(output, toVariable, recSetName));
                _commonSteps.AddVariableToVariableList(toVariable);

                var input = tableRow["Input to Service"];
                var fromVariable = tableRow["From Variable"];
                if (!string.IsNullOrEmpty(input))
                {
                    mySqlDatabaseActivity.Inputs.Add(new ServiceInput(input, fromVariable));
                    _commonSteps.AddVariableToVariableList(fromVariable);
                }
            }
            _commonSteps.AddActivityToActivityList(parentName, serviceName, mySqlDatabaseActivity);
        }


        [Given(@"I create a new unsaved workflow with name ""(.*)""")]
        [When(@"I create a new unsaved workflow with name ""(.*)""")]
        [Then(@"I create a new unsaved workflow with name ""(.*)""")]
        public void GivenICreateANewUnsavedWorkflowWithName(string serviceName)
        {
            var environmentModel = ServerRepository.Instance.Source;
            var tempResource = ResourceModelFactory.CreateResourceModel(environmentModel, @"WorkflowService",
                serviceName);
            tempResource.Category = @"Unassigned\" + serviceName;
            tempResource.ResourceName = serviceName;
            tempResource.DisplayName = serviceName;
            tempResource.IsNewWorkflow = true;

            environmentModel.ResourceRepository.Add(tempResource);
            _debugWriterSubscriptionService = new SubscriptionService<DebugWriterWriteMessage>(environmentModel.Connection.ServerEvents);

            _debugWriterSubscriptionService.Subscribe(msg => Append(msg.DebugState));
            if (_scenarioContext.ContainsKey("unsavedWFS"))
            {
                var unsavedWFs = Get<List<IContextualResourceModel>>("unsavedWFS");
                unsavedWFs.Add(tempResource);
            }
            else
            {
                Add("unsavedWFS", new List<IContextualResourceModel> { tempResource });
            }

            environmentModel.ResourceRepository.Add(tempResource);
            _debugWriterSubscriptionService = new SubscriptionService<DebugWriterWriteMessage>(environmentModel.Connection.ServerEvents);

            _debugWriterSubscriptionService.Subscribe(msg => Append(msg.DebugState));
            if (_scenarioContext.ContainsKey(serviceName))
            {
                _scenarioContext[serviceName] = tempResource;
                _scenarioContext["parentWorkflowName"] = serviceName;
                _scenarioContext["environment"] = environmentModel;
                _scenarioContext["resourceRepo"] = environmentModel.ResourceRepository;
                _scenarioContext["debugStates"] = new List<IDebugState>();

            }
            else
            {
                Add(serviceName, tempResource);
                Add("parentWorkflowName", serviceName);
                Add("environment", environmentModel);
                Add("resourceRepo", environmentModel.ResourceRepository);
                Add("debugStates", new List<IDebugState>());
            }
        }

        [When(@"workflow ""(.*)"" merge is opened")]
        public void WhenWorkflowMergeIsOpened(string mergeWfName)
        {
            var environmentModel = ServerRepository.Instance.Source;
            var serverRepository = new Mock<IServerRepository>();
            serverRepository.Setup(p => p.ActiveServer).Returns(new Mock<IServer>().Object);
            serverRepository.Setup(p => p.Source).Returns(new Mock<IServer>().Object);
            var evntArg = new Mock<IEventAggregator>().Object;
            var versionChecker = new Mock<IVersionChecker>().Object;
            var explorer = new Mock<IExplorerViewModel>().Object;
            var viewFact = new Mock<IViewFactory>().Object;
            var versions = _scenarioContext["Versions"] as IList<IExplorerItem>;
            var repo = _scenarioContext.Get<IResourceRepository>("resourceRepo") as ResourceRepository;
            var localResource = repo.LoadContextualResourceModel(versions.First().ResourceId);
            var remoteResource = repo.LoadContextualResourceModel(versions.Last().ResourceId);
            var vm = new Mock<IMergeWorkflowViewModel>();
            var wdvm = new Mock<IMergePreviewWorkflowDesignerViewModel>();
            vm.Setup(p => p.MergePreviewWorkflowDesignerViewModel).Returns(wdvm.Object);
        }

        [Given(@"Public ""(.*)"" Permissions to Execute ""(.*)""")]
        [When(@"Public ""(.*)"" Permissions to Execute ""(.*)""")]
        [Then(@"Public ""(.*)"" Permissions to Execute ""(.*)""")]
        public void GivenPublicPermissionsToExecuteButNotNested(string permited, string resourceName)
        {
            var hasPermissions = !string.IsNullOrEmpty(permited);
            TryGetValue("environment", out IServer environmentModel);
            EnsureEnvironmentConnected(environmentModel);
            var resourceRepository = environmentModel.ResourceRepository;
            var settings = resourceRepository.ReadSettings(environmentModel);
            environmentModel.ForceLoadResources();
            if (hasPermissions)
            {
                AddPermissionsForResource(resourceName, environmentModel, resourceRepository, settings);
            }
        }

        [Given(@"""(.*)"" contains a Decision ""(.*)"" as")]
        public void GivenContainsADecisionAs(string workflowName, string decisionName, Table decisionConfig)
        {
            var activity = new DsfDecision
            {
                DisplayName = decisionName,
                Conditions = new Dev2DecisionStack
                {
                    TheStack = new List<Dev2Decision>()
                }
            };
            foreach (var tableRow in decisionConfig.Rows)
            {
                activity.Conditions.AddModelItem(new Data.SystemTemplates.Models.Dev2Decision
                {
                    Col1 = tableRow["ItemToCheck"],
                    EvaluationFn = DecisionDisplayHelper.GetValue(tableRow["Condition"]),
                    Col2 = tableRow["ValueToCompareTo"]
                });
                Add(decisionName, (TrueArm: tableRow["TrueArmToolName"], FalseArm: tableRow["FalseArmToolName"]));
            }

            _commonSteps.AddActivityToActivityList(workflowName, decisionName, activity);
        }

        [Then(@"the ""(.*)"" number '(.*)' in WorkFlow ""(.*)"" debug inputs as")]
        public void ThenTheNumberInWorkFlowDebugInputsAs(string toolName, int toolNum, string workflowName, Table table)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);

            var debugStates = Get<List<IDebugState>>("debugStates");
            var workflowId = Guid.Empty;

            if (parentWorkflowName != workflowName)
            {
                if (toolName != null && workflowName != null)
                {
                    workflowId = debugStates.First(wf => wf.DisplayName.Equals(workflowName)).ID;
                }
                else
                {
                    throw new InvalidOperationException("SpecFlow broke.");
                }
            }

            var toolSpecificDebug =
                debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == workflowId && ds.DisplayName.Equals(toolName)).Skip(toolNum - 1).ToList();
            if (!toolSpecificDebug.Any())
            {
                toolSpecificDebug =
                debugStates.Where(ds => ds.DisplayName.Equals(toolName)).ToList();
            }
            // Data Merge breaks our debug scheme, it only ever has 1 value, not the expected 2 ;)
            var isDataMergeDebug = toolSpecificDebug.Count == 1 && toolSpecificDebug.Any(t => t.Name == "Data Merge");
            IDebugState inputState;
            if (toolSpecificDebug.Count > 1 && toolSpecificDebug.Any(state => state.StateType == StateType.End))
            {
                inputState = toolSpecificDebug.FirstOrDefault(state => state.StateType == StateType.End);
            }
            else
            {
                inputState = toolSpecificDebug.Skip(toolNum - 1).FirstOrDefault();
            }

            if (inputState?.Inputs != null)
            {
                var SelectResults = inputState.Inputs.SelectMany(s => s.ResultsList);
                if (SelectResults != null && SelectResults.ToList() != null)
                {
                    _commonSteps.ThenTheDebugInputsAs(table, SelectResults.ToList());
                    return;
                }
                Assert.Fail(inputState.Inputs.ToList() + " debug outputs found on " + workflowName + " does not include " + toolName + ".");
            }
            Assert.Fail("No debug input found for " + workflowName + ".");
        }

        [Then(@"the ""(.*)"" number '(.*)' in WorkFlow ""(.*)"" has ""(.*)"" nested children")]
        public void ThenTheNumberInWorkFlowHasNestedChildren(string toolName, int itemNumber, string workflowName, int count)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);
            var debugStates = Get<List<IDebugState>>("debugStates").ToList();

            var id =
                debugStates.Where(ds => ds.DisplayName.Equals(toolName)).Skip(itemNumber - 1).ToList().Select(a => a.ID).First();
            var children = debugStates.Count(a => a.ParentID.GetValueOrDefault() == id);
            Assert.AreEqual(count, children);
        }

        [Then(@"the ""(.*)"" in step (.*) for ""(.*)"" number '(.*)' debug inputs as")]
        public void ThenTheInStepForNumberDebugInputsAs(string toolName, int stepNumber, string forEachName, int itemNumber, Table table)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);

            var debugStates = Get<List<IDebugState>>("debugStates").ToList();
            var workflowId = debugStates.Where(wf => wf.DisplayName.Equals(forEachName)).Skip(itemNumber - 1).First().ID;

            if (parentWorkflowName == forEachName)
            {
                workflowId = Guid.Empty;
            }

            var toolSpecificDebug =
                debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == workflowId && ds.DisplayName.Equals(toolName)).ToList();

            Assert.IsTrue(toolSpecificDebug.Count >= stepNumber);
            var debugToUse = DebugToUse(stepNumber, toolSpecificDebug);

            _commonSteps.ThenTheDebugInputsAs(table, debugToUse.Inputs
                                                    .SelectMany(item => item.ResultsList).ToList());
        }

        [Then(@"the ""(.*)"" in step (.*) for ""(.*)"" number '(.*)' debug outputs as")]
        public void ThenTheInStepForNumberDebugOutputsAs(string toolName, int stepNumber, string forEachName, int itemNumber, Table table)
        {
            TryGetValue("activityList", out Dictionary<string, Activity> activityList);
            TryGetValue("parentWorkflowName", out string parentWorkflowName);

            var debugStates = Get<List<IDebugState>>("debugStates").ToList();
            var workflowId = debugStates.Where(wf => wf.DisplayName.Equals(forEachName)).Skip(itemNumber - 1).First().ID;

            if (parentWorkflowName == forEachName)
            {
                workflowId = Guid.Empty;
            }

            var toolSpecificDebug =
                debugStates.Where(ds => ds.ParentID.GetValueOrDefault() == workflowId && ds.DisplayName.Equals(toolName)).ToList();
            Assert.IsTrue(toolSpecificDebug.Count >= stepNumber);
            var debugToUse = DebugToUse(stepNumber, toolSpecificDebug);


            var outputDebugItems = debugToUse.Outputs
                .SelectMany(s => s.ResultsList).ToList();
            _commonSteps.ThenTheDebugOutputAs(table, outputDebugItems);
        }



        private static void AddPermissionsForResource(string resourceName, IServer environmentModel, IResourceRepository resourceRepository, Data.Settings.Settings settings)
        {
            var resourceModel = resourceRepository.FindSingle(model => model.Category.Equals(resourceName, StringComparison.InvariantCultureIgnoreCase));
            Assert.IsNotNull(resourceModel, "Did not find: " + resourceName);
            settings.Security.WindowsGroupPermissions.RemoveAll(permission => permission.ResourceID == resourceModel.ID);
            var resourcePerm = new WindowsGroupPermission
            {
                WindowsGroup = "Public",
                ResourceID = resourceModel.ID,
                ResourceName = resourceName,
                IsServer = false,
                Permissions = SecPermissions.Execute
            };
            settings.Security.WindowsGroupPermissions.Add(resourcePerm);
            var SettingsWriteResult = resourceRepository.WriteSettings(environmentModel, settings);
            Assert.IsFalse(SettingsWriteResult.HasError, "Cannot setup for security spec.\n Error writing initial resource permissions settings to localhost server.\n" + SettingsWriteResult.Message);
        }

        static void EnsureEnvironmentConnected(IServer server)
        {
            if (!server.IsConnected)
            {
                server.Connect();
            }
        }

        [Given(@"I have server running at ""(.*)""")]
        public void GivenIHaveServerRunningAt(string server)
        {
            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();
            environmentModel.ResourceRepository.Load(true);
            Add("environment", environmentModel);
            Assert.IsNotNull(environmentModel);
            Assert.AreEqual(server, environmentModel.Name);
        }
        [When(@"I resume the workflow ""(.*)"" at ""(.*)"" from version ""(.*)""")]
        public void WhenIResumeTheWorkflowAtFromVersion(string workflow, string activity, string versionNumber)
        {
            var assignActivity = _commonSteps.GetActivityList()
                .FirstOrDefault(p => p.Key == activity)
                .Value as DsfMultiAssignActivity;

            TryGetValue("environment", out IServer environmentModel);

            var resourceModel = environmentModel.ResourceRepository.FindSingle(resource => resource.ResourceName == workflow);
            Assert.IsNotNull(resourceModel);
            var env = new ExecutionEnvironment();
            var serEnv = env.ToJson();
            var msg = environmentModel.ResourceRepository.ResumeWorkflowExecution(resourceModel, serEnv, Guid.Parse(assignActivity.UniqueID), versionNumber, WindowsIdentity.GetCurrent().Name);
            Add("resumeMessage", msg);
        }

        [Given(@"I resume workflow ""(.*)""")]
        [When(@"I resume workflow ""(.*)""")]
        [Then(@"I resume workflow ""(.*)""")]
        public void GivenIResumeWorkflow(string resourceId)
        {
            TryGetValue("environment", out IServer environmentModel);
            var resourceModel = environmentModel.ResourceRepository.FindSingle(resource => resource.ID.ToString() == resourceId);
            Assert.IsNotNull(resourceModel);
            var env = new ExecutionEnvironment();
            env.Assign("[[Name]]", "Bob", 0);
            env.Assign("[[Rec(1).Name]]", "Bob", 0);
            env.Assign("[[Rec(3).SurName]]", "Bob", 0);
            env.Assign("[[Rec(4).Name]]", "Bob", 0);
            env.Assign("[[R(*).FName]]", "Bob", 0);
            env.Assign("[[RecSet().Field]]", "Bob", 0);
            env.Assign("[[RecSet().Field]]", "Jane", 0);
            env.AssignJson(new AssignValue("[[@Person]]", "{\"Name\":\"B\"}"), 0);
            var serEnv = env.ToJson();
            var msg = environmentModel.ResourceRepository.ResumeWorkflowExecution(resourceModel, serEnv, Guid.Parse("670132e7-80d4-4e41-94af-ba4a71b28118"), null,WindowsIdentity.GetCurrent().Name);
            Add("resumeMessage", msg);
        }
        [Then(@"an error ""(.*)""")]
        public void ThenAnError(string message)
        {
            TryGetValue("resumeMessage", out ExecuteMessage executeMessage);
            Assert.IsNotNull(executeMessage);
            Assert.IsTrue(executeMessage.HasError);
            Assert.AreEqual(message, executeMessage.Message.ToString());
        }

        [Then(@"Resume has ""(.*)"" error")]
        public void WhenResumeHasError(string error)
        {
            TryGetValue("resumeMessage", out ExecuteMessage executeMessage);
            if (error == "AN")
            {
                Assert.IsTrue(executeMessage.HasError);
            }
            else
            {
                Assert.IsFalse(executeMessage.HasError);
            }
        }

        [Then(@"Resume message is ""(.*)""")]
        public void ThenResumeMessageIs(string message)
        {
            TryGetValue("resumeMessage", out ExecuteMessage executeMessage);
            Assert.IsNotNull(executeMessage);
            Assert.AreEqual(message, executeMessage.Message.ToString());
        }

        [Then(@"the ""(.*)"" in Workflow ""(.*)"" has an error")]
        public void ThenTheInWorkflowHasAnError(string toolName, string workflow)
        {
            var debugStates = Get<List<IDebugState>>("debugStates");
            var toolSpecificDebug =
                debugStates.Where(ds => ds.DisplayName.Equals(toolName)).ToList();
            Assert.IsFalse(string.IsNullOrEmpty(toolSpecificDebug[0].ErrorMessage));
        }

        [Then(@"execution stopped on error and did not execute ""(.*)""")]
        public void ThenExecutionForStoppedOnErrorAndDidNotExecute(string toolName)
        {
            var debugStates = Get<List<IDebugState>>("debugStates");
            Assert.IsFalse(debugStates.Any(ds => ds.DisplayName.Equals(toolName)));
        }

        [When(@"I startup the mysql container")]
        public void WhenIStartupTheContainer()
        {
            _containerOps = new Depends(Depends.ContainerType.MySQL, true);
        }

        ResourceCatalog ResourceCat { get; set; }
        ActivityParser Parser { get; set; }

        [Given(@"Workflow ""(.*)"" has ""(.*)"" activity")]
        [When(@"Workflow ""(.*)"" has ""(.*)"" activity")]
        [Then(@"Workflow ""(.*)"" has ""(.*)"" activity")]
        public void GivenWorkflowHasActivity(string workflow, string activityName)
        {
            TryGetValue(workflow, out IResourceModel resourceModel);
            var selectedActivity = GetActivity(activityName, resourceModel) as Activity;
            Assert.IsNotNull(selectedActivity, "The tool does not exist on the surface");
            _commonSteps.AddActivityToActivityList(workflow, activityName, selectedActivity);
        }

        private IDev2Activity GetActivity(string activityName, IResourceModel resourceModel)
        {
            ResourceCat = ResourceCat ?? new ResourceCatalog();
            Parser = Parser ?? new ActivityParser();

            var service = ResourceCat.GetService(GlobalConstants.ServerWorkspaceID, resourceModel.ID, resourceModel.ResourceName);
            var sa = service.Actions.FirstOrDefault();
            ResourceCat.MapServiceActionDependencies(GlobalConstants.ServerWorkspaceID, sa);
            var activity = ResourceCat.GetActivity(sa);
            var dev2Act = Parser.Parse(activity);
            var allNodes = Parser.ParseToLinkedFlatList(dev2Act);
            var selectedActivity = allNodes.FirstOrDefault(p => p.GetDisplayName() == activityName);
            return selectedActivity;
        }

        [Given(@"I resume workflow ""(.*)"" at ""(.*)"" tool")]
        [When(@"I resume workflow ""(.*)"" at ""(.*)"" tool")]
        [Then(@"I resume workflow ""(.*)"" at ""(.*)"" tool")]
        public void WhenIResumeWorkflowAtTool(string workflow, string toolToResumeFrom)
        {
            var uniqueId = GetActivityUniqueId(toolToResumeFrom);
            TryGetValue("environment", out IServer environmentModel);
            var resourceModel = environmentModel.ResourceRepository.FindSingle(resource => resource.ResourceName == workflow);
            Assert.IsNotNull(resourceModel);

            _debugWriterSubscriptionService = new SubscriptionService<DebugWriterWriteMessage>(environmentModel.Connection.ServerEvents);

            _debugWriterSubscriptionService.Subscribe(debugMsg => Append(debugMsg.DebugState));

            var env = "{\"Environment\":{\"scalars\":{\"number\":1},\"record_sets\":{},\"json_objects\":{}},\"Errors\":[],\"AllErrors\":[\"Service Execution Error:    at Dev2.Services.Execution.DatabaseServiceExecution.ExecuteService(Int32 update, ErrorResultTO& errors, IOutputFormatter formater) in C:\\\\Repos\\\\Warewolf\\\\Dev\\\\Dev2.Services.Execution\\\\DatabaseServiceExecution.cs:line 104\\r\\n   at Dev2.Services.Execution.ServiceExecutionAbstract`2.ExecuteService(ErrorResultTO& errors, Int32 update, IOutputFormatter formater) in C:\\\\Repos\\\\Warewolf\\\\Dev\\\\Dev2.Services.Execution\\\\ServiceExecutionAbstract.cs:line 372\"]}";
            var msg = environmentModel.ResourceRepository.ResumeWorkflowExecution(resourceModel, env, uniqueId, "",WindowsIdentity.GetCurrent().Name);
            Add("resumeMessage", msg);
        }

        private Guid GetActivityUniqueId(string toolToResumeFrom)
        {
            var activities = _commonSteps.GetActivityList();

            if (activities[toolToResumeFrom] is DsfActivityAbstract<string> abstartActivity)
            {
                return Guid.Parse(abstartActivity.UniqueID);
            }
            var activity = activities[toolToResumeFrom] as DsfActivity;
            return Guid.Parse(activity.UniqueID);
        }

        [When(@"I select ""(.*)"" Action for ""(.*)"" tool")]
        public void WhenISelectActionForTool(string action, string toolName)
        {
            var activities = _commonSteps.GetActivityList();
            var activity = activities[toolName] as DsfMySqlDatabaseActivity;
            activity.ProcedureName = action;
            activity.Inputs.Add(new ServiceInput("name", "S"));
        }

        [When(@"I select ""(.*)"" for ""(.*)"" as Source")]
        public void WhenISelectForAsSource(string source, string toolName)
        {
            var activities = _commonSteps.GetActivityList();
            var activity = activities[toolName] as DsfMySqlDatabaseActivity;

            var environmentModel = ServerRepository.Instance.Source;
            environmentModel.Connect();
            environmentModel.LoadExplorer(true);
            var environmentConnection = environmentModel.Connection;
            var controllerFactory = new CommunicationControllerFactory();
            var _proxyLayer = new StudioServerProxy(controllerFactory, environmentConnection);

            var dbSources = _proxyLayer.QueryManagerProxy.FetchDbSources().ToList();
            var dbSource = dbSources.Single(s => s.Name == source);
            activity.SourceId = dbSource.Id;
        }

        [Given(@"The detailed log file does not exist for ""(.*)""")]
        public void GivenTheDetailedLogFileDoesNotExistFor(string workflowName)
        {
            var detailLogInfo = new DetailLogInfo(workflowName, this);
            detailLogInfo.DeleteIfExists();
            Add($"DetailLogInfo {workflowName}", detailLogInfo);
        }

        [Given(@"The detailed log file does not exist for id ""(.*)"" - ""(.*)""")]
        public void GivenTheDetailedLogFileDoesNotExistForId(string id, string workflowName)
        {
            var detailLogInfo = new DetailLogInfo(workflowName, id);
            detailLogInfo.DeleteIfExists();
            Add($"DetailLogInfo {workflowName}", detailLogInfo);
        }

        [Then(@"The detailed log file is created for ""(.*)""")]
        public void ThenTheDetailedLogFileIsCreatedFor(string workflowName)
        {
            TryGetValue($"DetailLogInfo {workflowName}", out DetailLogInfo detailLogInfo);
            var logFileContent = detailLogInfo.ReadAllText();
            AddLogFileContentToContext(logFileContent);
            Assert.IsTrue(logFileContent.Length > 0);
        }

        [Then(@"The Log file contains Logging for ""(.*)""")]
        public void ThenTheLogFileContainsLoggingFor(string workflowName)
        {
            TryGetValue($"DetailLogInfo {workflowName}", out DetailLogInfo detailLogInfo);
            var logContent = detailLogInfo.ReadAllText();
            Assert.IsTrue(logContent.Contains("header:LogPreExecuteState"));
            Assert.IsTrue(logContent.Contains("header:LogPostExecuteState"));
            Assert.IsTrue(logContent.Contains("header:LogExecuteCompleteState"));
            Assert.IsFalse(logContent.Contains("header:LogStopExecutionState"));
        }

        [Then(@"The Log file contains Logging for stopped ""(.*)""")]
        public void ThenTheLogFileContainsLoggingForStopped(string workflowName)
        {
            TryGetValue($"DetailLogInfo {workflowName}", out DetailLogInfo detailLogInfo);
            var logContent = detailLogInfo.ReadAllText();
            Assert.IsTrue(logContent.Contains("header:LogPreExecuteState"));
            Assert.IsTrue(logContent.Contains("header:LogPostExecuteState"));
            Assert.IsFalse(logContent.Contains("header:LogExecuteCompleteState"));
            Assert.IsTrue(logContent.Contains("header:LogStopExecutionState"));
        }

        [Then(@"The Log file for ""(.*)"" contains additional Logging")]
        public void ThenTheLogFileContainsAdditionalLogging(string workflowName)
        {
            TryGetValue($"DetailLogInfo {workflowName}", out DetailLogInfo detailLogInfo);
            var previousLogFileSize = detailLogInfo.PreviousLength;
            var logContent = detailLogInfo.ReadAllText();
            Assert.IsTrue(logContent.Length > previousLogFileSize);
            var sizeDifference = logContent.Length / (double)previousLogFileSize;
            Assert.IsTrue(sizeDifference > 1.9);
            Assert.IsTrue(sizeDifference < 2.1);
        }

        [Then(@"The Log file for ""(.*)"" contains Logging matching ""(.*)""")]
        public void ThenTheLogFileForContainsLoggingMatching(string workflowName, string searchString)
        {
            TryGetValue($"DetailLogInfo {workflowName}", out DetailLogInfo detailLogInfo);
            var logFileContent = detailLogInfo.ReadAllText();
            AddLogFileContentToContext(logFileContent);
            Assert.IsTrue(logFileContent.Contains(searchString));
        }

        private void AddLogFileContentToContext(string logFileContent)
        {
            TryGetValue("LogFileContent", out string fileContent);
            if (fileContent == null)
            {
                Add("LogFileContent", logFileContent);
            }
            else
            {
                _scenarioContext.Remove("LogFileContent");
                Add("LogFileContent", logFileContent);
            }
        }

        [Then(@"The Log file contains Logging matching ""(.*)""")]
        public void ThenTheLogFileContainsLoggingMatching(string searchString)
        {
            TryGetValue("LogFileContent", out string logFileContent);
            Assert.IsTrue(logFileContent.Contains(searchString), $"detailed log file does not contain {searchString}");
        }
        [DeploymentItem(@"x86\SQLite.Interop.dll")]
        [Given(@"the audit database is empty")]
        public void GivenTheAuditDatabaseIsEmpty()
        {
            //TODO: Fix in new Implementation
            //Dev2StateAuditLogger.ClearAuditLog();
        }

        [Then(@"The audit database has ""(.*)"" search results containing ""(.*)"" with type """"(.*)""Decision""(.*)""Hello World"" as")]
        public void ThenTheAuditDatabaseHasSearchResultsContainingWithTypeDecisionHelloWorldAs(int expectedCount, string searchString, string auditType, string activityName, string workflowName, Table table)
        {
            //TODO: Fix in new Implementation
            //var results = Dev2StateAuditLogger.Query(item =>
            //(workflowName == "" || item.WorkflowName.Equals(workflowName)) &&
            //(auditType == "" || item.AuditType.Equals(auditType)) &&
            //(activityName == "" || (item.PreviousActivity != null && item.PreviousActivity.Contains(activityName))));
            //Assert.AreEqual(expectedCount, results.Count());
            //var prop = table.Rows[0][0];
            //var val = table.Rows[0][1];
            //foreach (var item in results)
            //{
            //    var value = item.GetType().GetProperty(prop).GetValue(item, null);
            //    Assert.AreEqual(val, value);
            //}
        }

        [DeploymentItem(@"x86\SQLite.Interop.dll")]
        [Then(@"The audit database has ""(.*)"" search results containing ""(.*)"" with type ""(.*)"" for ""(.*)"" as")]
        public void ThenTheAuditDatabaseHasSearchResultsContainingWithTypeWithActivityForAs(int expectedCount, string activityName, string auditType, string workflowName, Table table)
        {
            //TODO: correct with new implementation
            //Thread.Sleep(1000);
            //var results = Dev2StateAuditLogger.Query(item =>
            //   (workflowName == "" || item.WorkflowName.Equals(workflowName)) &&
            //   (auditType == "" || item.AuditType.Equals(auditType)) &&
            //   (activityName == "" || (
            //       (item.NextActivity != null && item.NextActivity.Contains(activityName)) ||
            //       (item.NextActivityType != null && item.NextActivityType.Contains(activityName)) ||
            //       (item.PreviousActivity != null && item.PreviousActivity.Contains(activityName)) ||
            //       (item.PreviousActivityType != null && item.PreviousActivityType.Contains(activityName))
            //   ))
            //);
            //   Assert.AreEqual(expectedCount, results.Count(), string.Join(" ", results.Select(entry => entry.WorkflowName + " " + entry.AuditDate + " " + entry.AdditionalDetail).ToList()));

            //if (results.Any() && table.Rows.Count > 0)
            //{
            //    var index = 0;
            //    foreach (var row in table.Rows)
            //    {
            //        var currentResult = results.ToArray()[index];
            //        Assert.AreEqual(row["AuditType"], currentResult.AuditType);
            //        Assert.AreEqual(row["WorkflowName"], currentResult.WorkflowName);
            //        Assert.AreEqual(row["PreviousActivityType"], currentResult.PreviousActivityType ?? "null");
            //        Assert.AreEqual(row["NextActivityType"], currentResult.NextActivityType ?? "null");
            //        index++;
            //    }
            //}
        }

        [DeploymentItem(@"x86\SQLite.Interop.dll")]
        [Then(@"The audit database has ""(.*)"" search results for ""(.*)"" as")]
        public void ThenTheAuditDatabaseHasSearchResultsForAs(int expectedCount, string workflowName, Table table)
        {
            //TODO: This will use the new server
            //var results = Dev2StateAuditLogger.Query(item =>
            //   (workflowName == "" || item.WorkflowName.Equals(workflowName))
            //);
            //Assert.AreEqual(expectedCount, results.Count());
            //if (results.Count() > 0 && table.Rows.Count > 0)
            //{
            //    var index = 0;
            //    foreach (var row in table.Rows)
            //    {
            //        var currentResult = results.ToArray()[index];
            //        Assert.AreEqual(row["WorkflowName"], currentResult.WorkflowName);
            //        Assert.AreEqual(row["AuditType"], currentResult.AuditType);
            //        Assert.AreEqual(row["VersionNumber"], currentResult.VersionNumber ?? "null");
            //        index++;
            //    }
            //}
        }
        [DeploymentItem(@"x86\SQLite.Interop.dll")]
        [Then(@"The audit database has ""(.*)"" search results containing ""(.*)"" with log type ""(.*)"" for ""(.*)""")]
        public void ThenTheLogFileSearchResultsContainFor(int expectedCount, string activityName, string logType, string workflowName)
        {
            //TODO: This will use the new server
            // var results = StateAuditLogger.Query(item =>
            //    (workflowName == "" || item.WorkflowName.Equals(workflowName)) &&
            //    (logType == "" || item.AuditType.Equals(logType)) &&
            //    (activityName == "" || (
            //        (item.NextActivity != null && item.NextActivity.Contains(activityName)) ||
            //        (item.NextActivityType != null && item.NextActivityType.Contains(activityName)) ||
            //        (item.PreviousActivity != null && item.PreviousActivity.Contains(activityName)) ||
            //        (item.PreviousActivityType != null && item.PreviousActivityType.Contains(activityName))
            //    ))
            //);
            // Assert.AreEqual(expectedCount, results.Count());
        }

        private static bool GetMatchingNames(string toolName, string displayName)
        {
            var updateDisplayName = GetMatchingName(displayName);
            var updateToolName = GetMatchingName(toolName);

            return updateDisplayName.Equals(updateToolName);
        }

        private static string GetMatchingName(string name)
        {
            var updateName = name;
            if (name.Contains("("))
            {
                var endIdx = name.IndexOf("(");
                updateName = name.Substring(0, endIdx).TrimEnd();
            }

            return updateName;
        }

        class DetailLogInfo
        {
            readonly IContextualResourceModel _resourceModel;
            readonly string _logFilePath;
            readonly FileWrapper _fileWrapper;
            public int PreviousLength { get; private set; }
            private DetailLogInfo()
            {
                _fileWrapper = new FileWrapper();
            }
            public DetailLogInfo(string workflowName, WorkflowExecutionSteps workflowExecutionSteps)
                : this()
            {
                workflowExecutionSteps.TryGetValue(workflowName, out _resourceModel);
                _logFilePath = Path.Combine(EnvironmentVariables.WorkflowDetailLogPath(_resourceModel.ID, _resourceModel.ResourceName), "Detail.log");
            }
            public DetailLogInfo(string workflowName, string resourceModelId)
                : this()
            {
                _logFilePath = Path.Combine(EnvironmentVariables.WorkflowDetailLogPath(Guid.Parse(resourceModelId), workflowName), "Detail.log");
            }

            internal void DeleteIfExists()
            {
                if (_fileWrapper.Exists(_logFilePath))
                {
                    _fileWrapper.Delete(_logFilePath);
                }
            }

            internal string ReadAllText()
            {
                var result = _fileWrapper.ReadAllText(_logFilePath);
                PreviousLength = result.Length;
                return result;
            }
        }
    }
}

---- Semantic diagnostics *before* transformation ----

---- Semantic diagnostics *after* transformation ----
D:\a\1\s\Dev\Dev2.Activities.Specs\Composition\WorkflowExecutionSteps.cs(758,120): error CS0103: The name 'source' does not exist in the current context,D:\a\1\s\Dev\Dev2.Activities.Specs\Composition\WorkflowExecutionSteps.cs(761,133): error CS0103: The name 'source' does not exist in the current context,D:\a\1\s\Dev\Dev2.Activities.Specs\Composition\WorkflowExecutionSteps.cs(764,126): error CS0103: The name 'source' does not exist in the current context
######################################################################


######################################################################
Nr: 16 - UsePatternMatchingRewriterR8
Filepath: D:\a\1\s\Dev\Dev2.Studio.Core\AppResources\Converters\StringToIntInRangeConverter.cs
Description: Error: The created Syntax Tree is semantically incorrect.
------------------------------------------------------------------------
---- Original Tree ----
using System;
using System.Globalization;
using System.Windows.Data;

namespace Dev2.Studio.Core.AppResources.Converters
{
    public class StringToIntInRangeConverter : IValueConverter
    {
        public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        {
            var intValue = value as int?;
            if (intValue != null && intValue == 0)
            {
                return string.Empty;
            }
            var parameterString = parameter as string;
            if (!string.IsNullOrWhiteSpace(parameterString))
            {
                var stringValue = parameterString.Split('-');
                var minValue = int.Parse(stringValue[0]);
                var maxValue = int.Parse(stringValue[1]);
                if (intValue >= minValue && intValue <= maxValue)
                {
                    return value;
                }
                if (intValue > minValue || intValue > maxValue)
                {
                    return value;
                }
            }
            return value;
        }

        public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
        {
            const int intValue = 0;
            var stringValue = value as string;
            if (string.IsNullOrWhiteSpace(stringValue))
            {
                return intValue;
            }

            return value;
        }
    }
}

---- Transformed Tree ----
using System;
using System.Globalization;
using System.Windows.Data;

namespace Dev2.Studio.Core.AppResources.Converters
{
    public class StringToIntInRangeConverter : IValueConverter
    {
        public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        {
            if (value is int? intValue && intValue == 0)
            {
                return string.Empty;
            }
            var parameterString = parameter as string;
            if (!string.IsNullOrWhiteSpace(parameterString))
            {
                var stringValue = parameterString.Split('-');
                var minValue = int.Parse(stringValue[0]);
                var maxValue = int.Parse(stringValue[1]);
                if (intValue >= minValue && intValue <= maxValue)
                {
                    return value;
                }
                if (intValue > minValue || intValue > maxValue)
                {
                    return value;
                }
            }
            return value;
        }

        public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
        {
            const int intValue = 0;
            var stringValue = value as string;
            if (string.IsNullOrWhiteSpace(stringValue))
            {
                return intValue;
            }

            return value;
        }
    }
}

---- Semantic diagnostics *before* transformation ----

---- Semantic diagnostics *after* transformation ----
D:\a\1\s\Dev\Dev2.Studio.Core\AppResources\Converters\StringToIntInRangeConverter.cs(11,26): error CS8116: It is not legal to use nullable type 'int?' in a pattern; use the underlying type 'int' instead.,D:\a\1\s\Dev\Dev2.Studio.Core\AppResources\Converters\StringToIntInRangeConverter.cs(21,21): error CS0165: Use of unassigned local variable 'intValue'
######################################################################


######################################################################
Nr: 17 - UsePatternMatchingRewriterR8
Filepath: D:\a\1\s\Dev\Dev2.Studio.Core\AppResources\Converters\MultipleBoolToVisibilityValueConverter.cs
Description: Error: The created Syntax Tree is semantically incorrect.
------------------------------------------------------------------------
---- Original Tree ----
using System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using System.Windows;
using System.Windows.Data;


namespace Dev2.Studio.Core.AppResources.Converters
{
    public class MultipleBoolToVisibilityValueConverter : IMultiValueConverter
    {
        #region Implementation of IMultiValueConverter

        /// <summary>
        /// Converts source values to a value for the binding target. The data binding engine calls this method when it propagates the values from source bindings to the binding target.
        /// </summary>
        /// <returns>
        /// A converted value.If the method returns null, the valid null value is used.A return value of <see cref="T:System.Windows.DependencyProperty"/>.<see cref="F:System.Windows.DependencyProperty.UnsetValue"/> indicates that the converter did not produce a value, and that the binding will use the <see cref="P:System.Windows.Data.BindingBase.FallbackValue"/> if it is available, or else will use the default value.A return value of <see cref="T:System.Windows.Data.Binding"/>.<see cref="F:System.Windows.Data.Binding.DoNothing"/> indicates that the binding does not transfer the value or use the <see cref="P:System.Windows.Data.BindingBase.FallbackValue"/> or the default value.
        /// </returns>
        /// <param name="values">The array of values that the source bindings in the <see cref="T:System.Windows.Data.MultiBinding"/> produces. The value <see cref="F:System.Windows.DependencyProperty.UnsetValue"/> indicates that the source binding has no value to provide for conversion.</param><param name="targetType">The type of the binding target property.</param><param name="parameter">The converter parameter to use.</param><param name="culture">The culture to use in the converter.</param>
        public object Convert(object[] values, Type targetType, object parameter, CultureInfo culture)
        {
            var boolValues = new List<bool>();

            foreach (object value in values)
            {
                var item = value as bool?;
                if (item != null)
                {
                    boolValues.Add(item.GetValueOrDefault());
                }
            }

            if(boolValues.Any(c => !c))
            {
                return Visibility.Collapsed;
            }

            return Visibility.Visible;
        }

        /// <summary>
        /// Converts a binding target value to the source binding values.
        /// </summary>
        /// <returns>
        /// An array of values that have been converted from the target value back to the source values.
        /// </returns>
        /// <param name="value">The value that the binding target produces.</param><param name="targetTypes">The array of types to convert to. The array length indicates the number and types of values that are suggested for the method to return.</param><param name="parameter">The converter parameter to use.</param><param name="culture">The culture to use in the converter.</param>
        public object[] ConvertBack(object value, Type[] targetTypes, object parameter, CultureInfo culture) => new object[] { };

        #endregion
    }
}

---- Transformed Tree ----
using System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using System.Windows;
using System.Windows.Data;


namespace Dev2.Studio.Core.AppResources.Converters
{
    public class MultipleBoolToVisibilityValueConverter : IMultiValueConverter
    {
        #region Implementation of IMultiValueConverter

        /// <summary>
        /// Converts source values to a value for the binding target. The data binding engine calls this method when it propagates the values from source bindings to the binding target.
        /// </summary>
        /// <returns>
        /// A converted value.If the method returns null, the valid null value is used.A return value of <see cref="T:System.Windows.DependencyProperty"/>.<see cref="F:System.Windows.DependencyProperty.UnsetValue"/> indicates that the converter did not produce a value, and that the binding will use the <see cref="P:System.Windows.Data.BindingBase.FallbackValue"/> if it is available, or else will use the default value.A return value of <see cref="T:System.Windows.Data.Binding"/>.<see cref="F:System.Windows.Data.Binding.DoNothing"/> indicates that the binding does not transfer the value or use the <see cref="P:System.Windows.Data.BindingBase.FallbackValue"/> or the default value.
        /// </returns>
        /// <param name="values">The array of values that the source bindings in the <see cref="T:System.Windows.Data.MultiBinding"/> produces. The value <see cref="F:System.Windows.DependencyProperty.UnsetValue"/> indicates that the source binding has no value to provide for conversion.</param><param name="targetType">The type of the binding target property.</param><param name="parameter">The converter parameter to use.</param><param name="culture">The culture to use in the converter.</param>
        public object Convert(object[] values, Type targetType, object parameter, CultureInfo culture)
        {
            var boolValues = new List<bool>();

            foreach (object value in values)
            {
                if (value is bool? item)
                {
                    boolValues.Add(item.GetValueOrDefault());
                }
            }

            if(boolValues.Any(c => !c))
            {
                return Visibility.Collapsed;
            }

            return Visibility.Visible;
        }

        /// <summary>
        /// Converts a binding target value to the source binding values.
        /// </summary>
        /// <returns>
        /// An array of values that have been converted from the target value back to the source values.
        /// </returns>
        /// <param name="value">The value that the binding target produces.</param><param name="targetTypes">The array of types to convert to. The array length indicates the number and types of values that are suggested for the method to return.</param><param name="parameter">The converter parameter to use.</param><param name="culture">The culture to use in the converter.</param>
        public object[] ConvertBack(object value, Type[] targetTypes, object parameter, CultureInfo culture) => new object[] { };

        #endregion
    }
}

---- Semantic diagnostics *before* transformation ----

---- Semantic diagnostics *after* transformation ----
D:\a\1\s\Dev\Dev2.Studio.Core\AppResources\Converters\MultipleBoolToVisibilityValueConverter.cs(39,30): error CS8116: It is not legal to use nullable type 'bool?' in a pattern; use the underlying type 'bool' instead.
######################################################################


######################################################################
Nr: 18 - UsePatternMatchingRewriterR8
Filepath: D:\a\1\s\Dev\Warewolf.Studio.ViewModels\ServiceTestViewModel.cs
Description: Error: The created Syntax Tree is semantically incorrect.
------------------------------------------------------------------------
---- Original Tree ----
using System;
using System.Activities;
using System.Activities.Presentation.Model;
using System.Activities.Statements;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.ComponentModel;
using System.Linq;
using System.Reflection;
using System.Text.RegularExpressions;
using System.Windows;
using System.Windows.Input;
using System.Windows.Media;
using Caliburn.Micro;
using Dev2;
using Dev2.Activities;
using Dev2.Activities.SelectAndApply;
using Dev2.Common;
using Dev2.Common.Common;
using Dev2.Common.Interfaces;
using Dev2.Common.Interfaces.Diagnostics.Debug;
using Dev2.Common.Interfaces.Studio.Controller;
using Dev2.Common.Interfaces.Threading;
using Dev2.Common.Interfaces.Toolbox;
using Dev2.Communication;
using Dev2.Data;
using Dev2.Data.ServiceModel.Messages;
using Dev2.Data.SystemTemplates.Models;
using Dev2.Runtime.ServiceModel.Data;
using Dev2.Studio.Core;
using Dev2.Studio.Core.Activities.Utils;
using Dev2.Studio.Core.Messages;
using Dev2.Studio.Core.Network;
using Dev2.Studio.Interfaces;
using Microsoft.Practices.Prism.Commands;
using Microsoft.Practices.Prism.Mvvm;
using Unlimited.Applications.BusinessDesignStudio.Activities;
using Warewolf.Core;
using Warewolf.Resource.Errors;

namespace Warewolf.Studio.ViewModels
{
    public class ServiceTestViewModel : BindableBase, IServiceTestViewModel
    {
        readonly IExternalProcessExecutor _processExecutor;
        private IServiceTestModel _selectedServiceTest;
        private string _runAllTestsUrl;
        private string _runAllCoverageUrl;
        private string _testPassingResult;
        ObservableCollection<IServiceTestModel> _tests;
        private string _displayName;
        public IPopupController PopupController { get; }
        private string _errorMessage;
        private readonly IShellViewModel _shellViewModel;
        IContextualResourceModel _resourceModel;
        private string _serverName;
        private IWorkflowDesignerViewModel _workflowDesignerViewModel;
        readonly IEnumerable<Type> _types;
        
        public ServiceTestViewModel(IContextualResourceModel resourceModel, IAsyncWorker asyncWorker, IEventAggregator eventPublisher, IExternalProcessExecutor processExecutor, IWorkflowDesignerViewModel workflowDesignerViewModel, IPopupController popupController, IMessage msg, IEnumerable<Type> currentDomainTypes)
            : this(resourceModel, asyncWorker, eventPublisher, processExecutor, workflowDesignerViewModel, popupController)
        {
            _types = currentDomainTypes;
            PrePopulateTestsUsingDebugAsync(msg);
        }
        
        public ServiceTestViewModel(IContextualResourceModel resourceModel, IAsyncWorker asyncWorker, IEventAggregator eventPublisher, IExternalProcessExecutor processExecutor, IWorkflowDesignerViewModel workflowDesignerViewModel, IPopupController popupController, IMessage msg)
            : this(resourceModel, asyncWorker, eventPublisher, processExecutor, workflowDesignerViewModel, popupController)
        {
            _types = AppDomain.CurrentDomain.GetAssemblies().SelectMany(x => x.GetTypes());
            PrePopulateTestsUsingDebugAsync(msg);
        }

        public ServiceTestViewModel(IContextualResourceModel resourceModel, IAsyncWorker asyncWorker, IEventAggregator eventPublisher, IExternalProcessExecutor processExecutor, IWorkflowDesignerViewModel workflowDesignerViewModel, IPopupController popupController)
        {
            _processExecutor = processExecutor;
            AsyncWorker = asyncWorker;
            EventPublisher = eventPublisher;
            ResourceModel = resourceModel ?? throw new ArgumentNullException(nameof(resourceModel));
            ResourceModel.Environment.IsConnectedChanged += (sender, args) =>
            {
                ViewModelUtils.RaiseCanExecuteChanged(DeleteTestCommand);
                RefreshCommands();
            };

            ResourceModel.Environment.Connection.ReceivedResourceAffectedMessage += OnReceivedResourceAffectedMessage;
            SetServerName(resourceModel);
            DisplayName = resourceModel.DisplayName + " - Tests" + _serverName;

            ServiceTestCommandHandler = new ServiceTestCommandHandlerModel();
            PopupController = popupController;
            _shellViewModel = CustomContainer.Get<IShellViewModel>();
            RunAllTestsInBrowserCommand = new DelegateCommand(RunAllTestsInBrowser, IsServerConnected);
            RunAllTestCoverageInBrowserCommand = new DelegateCommand(RunAllCoverageInBrowser, IsServerConnected);
            RunAllTestsCommand = new DelegateCommand(RunAllTests, IsServerConnected);
            RunSelectedTestInBrowserCommand = new DelegateCommand(RunSelectedTestInBrowser, () => CanRunSelectedTestInBrowser);
            RunSelectedTestCommand = new DelegateCommand(RunSelectedTest, () => CanRunSelectedTest);
            StopTestCommand = new DelegateCommand(StopTest, () => CanStopTest);
            CreateTestCommand = new DelegateCommand(() => CreateTests());
            DeleteTestCommand = new DelegateCommand<IServiceTestModel>(DeleteTest, CanDeleteTest);
            DeleteTestStepCommand = new DelegateCommand<IServiceTestStep>(DeleteTestStep);
            DuplicateTestCommand = new DelegateCommand(DuplicateTest, () => CanDuplicateTest);
            RunAllTestsUrl = resourceModel.GetWorkflowUri("", UrlType.Tests)?.ToString();
            RunAllCoverageUrl = resourceModel.GetWorkflowUri("", UrlType.Coverage)?.ToString();

            UpdateHelpDescriptor(Resources.Languages.HelpText.ServiceTestGenericHelpText);

            WorkflowDesignerViewModel = workflowDesignerViewModel;
            WorkflowDesignerViewModel.IsTestView = true;
            WorkflowDesignerViewModel.ItemSelectedAction = ItemSelectedAction;
            IsLoading = true;
            if (Tests == null)
            {
                PrePopulateTestsUsingDebugAsync(null);
            }
        }

        public bool IsLoading
        {
            get => _isLoading;
            set
            {
                _isLoading = value;
                OnPropertyChanged(() => IsLoading);
            }
        }

        private void PrePopulateTestsUsingDebugAsync(IMessage msg)
        {
            AsyncWorker.Start(GetTests, models =>
            {
                var dummyTest = new DummyServiceTest(CreateTests) {TestName = "Create a new test."};
                models.Add(dummyTest);
                SelectedServiceTest = dummyTest;
                Tests = models;
                if (msg != null)
                {
                    if (msg is NewTestFromDebugMessage test)
                    {
                        var newTest = test;
                        if (newTest.RootItems == null)
                        {
                            throw new ArgumentNullException(nameof(newTest.RootItems));
                        }

                        PrePopulateTestsUsingDebug(newTest.RootItems);
                    }
                    else
                    {
                        throw new ArgumentException("expected " + nameof(NewTestFromDebugMessage) + " but got " +
                                                    msg.GetType().Name);
                    }
                }

                IsLoading = false;
            }, OnError);
        }

        public void PrePopulateTestsUsingDebug(List<IDebugTreeViewItemViewModel> models)
        {
            CreateTests(true);
            if (_canAddFromDebug)
            {
                WorkflowDesignerViewModel?.UpdateWorkflowInputDataViewModel(ResourceModel);
                AddFromDebug(models);
            }
        }

        private void AddFromDebug(IEnumerable<IDebugTreeViewItemViewModel> models)
        {
            foreach (var debugState in models)
            {
                if (debugState is DebugStateTreeViewItemViewModel debugItem && debugItem.Parent == null)
                {
                    if (debugItem.Content == null)
                    {
                        continue;
                    }
                    ValidateAddStepType(debugState, debugItem.Content);
                }
            }
        }

        void ValidateAddStepType(IDebugTreeViewItemViewModel debugState, IDebugState debugItemContent)
        {
            if (debugItemContent.ActivityType == ActivityType.Workflow && debugItemContent.OriginatingResourceID == ResourceModel.ID)
            {
                ProcessInputsAndOutputs(debugItemContent);
                UpdateInputValues(debugItemContent);
            }
            else if (debugItemContent.ActivityType == ActivityType.Workflow && debugItemContent.ActualType == nameof(DsfActivity))
            {
                AddStepFromDebug(debugState, debugItemContent);
            }
            else
            {
                if (debugItemContent.ActivityType != ActivityType.Workflow && debugItemContent.ActualType != nameof(DsfCommentActivity))
                {
                    ProcessRegularDebugItem(debugItemContent, debugState);
                }
            }
        }

        private void UpdateInputValues(IDebugState debugItemContent)
        {
            foreach (var item in debugItemContent.Inputs)
            {
                foreach (var res in item?.ResultsList)
                {
                    var variable = res?.Variable?.Replace("[[", "");
                    variable = variable?.Replace("]]", "");
                    var inputsValue = WorkflowDesignerViewModel?.GetWorkflowInputs(variable);
                    if (res != null)
                    {
                        res.Value = inputsValue;
                    }
                }
            }
        }

        private void ProcessRegularDebugItem(IDebugState debugItemContent, IDebugTreeViewItemViewModel debugState)
        {
            var actualType = debugItemContent.ActualType;
            if (actualType == nameof(DsfDecision) || actualType == nameof(TestMockDecisionStep))
            {
                DecisionFromDebug(debugState, debugItemContent);
            }
            else if (actualType == nameof(DsfSwitch) || actualType == nameof(TestMockSwitchStep))
            {
                SwitchFromDebug(debugState, debugItemContent);
            }
            else if (actualType == nameof(DsfEnhancedDotNetDllActivity))
            {
                EnhancedDotNetDllFromDebug(debugState, debugItemContent);
            }
            else
            {
                AddStepFromDebug(debugState, debugItemContent);
            }
        }

        void EnhancedDotNetDllFromDebug(IDebugTreeViewItemViewModel debugState, IDebugState debugItemContent)
        {
            var exists = FindExistingStep(debugItemContent.ID.ToString());
            IServiceTestStep serviceTestStep = null;
            if (exists == null)
            {
                serviceTestStep = SelectedServiceTest.AddDebugItemTestStep(debugItemContent, new ObservableCollection<IServiceTestOutput>());

                if (serviceTestStep != null)
                {
                    SetStepIcon(serviceTestStep.ActivityType, serviceTestStep);
                }
            }

            if (debugState.Children != null && debugState.Children.Count > 0)
            {
                AddChildren(debugState, serviceTestStep);
            }
        }

        void SwitchFromDebug(IDebugTreeViewItemViewModel itemContent, IDebugState debugItemContent)
        {
            var processFlowSwitch = ProcessFlowSwitch(WorkflowDesignerViewModel.GetModelItem(debugItemContent.WorkSurfaceMappingId, debugItemContent.ParentID.GetValueOrDefault()));
            if (processFlowSwitch != null)
            {
                if (debugItemContent?.Outputs.Count > 0 && debugItemContent.Outputs[0].ResultsList?.Count > 0)
                {
                    processFlowSwitch.StepOutputs[0].Value = debugItemContent.Outputs[0].ResultsList[0].Value;
                }

                var debugStateActivityTypeName = itemContent.ActivityTypeName;
                if (debugStateActivityTypeName == nameof(TestMockSwitchStep))
                {
                    processFlowSwitch.MockSelected = true;
                    processFlowSwitch.AssertSelected = false;
                    processFlowSwitch.StepOutputs[0].Value = debugItemContent.AssertResultList[0].ResultsList[0].Value;
                }
            }
        }

        void DecisionFromDebug(IDebugTreeViewItemViewModel itemContent, IDebugState debugItemContent)
        {
            var processFlowDecision = ProcessFlowDecision(WorkflowDesignerViewModel.GetModelItem(debugItemContent.WorkSurfaceMappingId, debugItemContent.ParentID.GetValueOrDefault()));
            if (processFlowDecision != null)
            {
                if (debugItemContent?.Outputs.Count > 0 && debugItemContent.Outputs[0].ResultsList?.Count > 0)
                {
                    processFlowDecision.StepOutputs[0].Value = debugItemContent.Outputs[0].ResultsList[0].Value;
                }
                var debugStateActivityTypeName = itemContent.ActivityTypeName;
                if (debugStateActivityTypeName == nameof(TestMockDecisionStep))
                {
                    processFlowDecision.MockSelected = true;
                    processFlowDecision.AssertSelected = false;
                    processFlowDecision.StepOutputs[0].Value = debugItemContent.AssertResultList[0].ResultsList[0].Value;
                }
            }
        }

        void ProcessInputsAndOutputs(IDebugState debugItemContent)
        {
            if (debugItemContent.StateType == StateType.Start)
            {
                SetInputs(debugItemContent);
            }
            else
            {
                if (debugItemContent.StateType == StateType.End)
                {
                    SetOutputs(debugItemContent);
                }
            }
        }

        void AddStepFromDebug(IDebugTreeViewItemViewModel debugState, IDebugState debugItemContent)
        {
            if (debugState.Children != null && debugState.Children.Count > 0)
            {
                AddChildDebugItems(debugItemContent, debugState, null);
            }
            else
            {
                var outputs = debugItemContent.Outputs;
                var exists = FindExistingStep(debugItemContent.ID.ToString());
                if (exists == null)
                {
                    var serviceTestStep = SelectedServiceTest.AddDebugItemTestStep(debugItemContent, new ObservableCollection<IServiceTestOutput>());
                    var hasOutputs = outputs?.Select(item => item.ResultsList).All(list => list.Count > 0);
                    var debugStateActivityTypeName = debugState.ActivityTypeName;

                    if (outputs?.Count > 0 && hasOutputs.HasValue && hasOutputs.Value)
                    {
                        AddOutputs(outputs, serviceTestStep);
                    }
                    else
                    {
                        SetStepOutputs(serviceTestStep, debugStateActivityTypeName);
                    }
                    if (serviceTestStep != null)
                    {
                        SetMockTestStep(debugItemContent, serviceTestStep, debugStateActivityTypeName);
                        SetStepIcon(serviceTestStep.ActivityType, serviceTestStep);
                    }
                }
            }
        }

        void SetMockTestStep(IDebugState debugItemContent, IServiceTestStep serviceTestStep, string debugStateActivityTypeName)
        {
            if (debugStateActivityTypeName == nameof(TestMockStep))
            {
                var model = WorkflowDesignerViewModel.GetModelItem(debugItemContent.WorkSurfaceMappingId, debugItemContent.ID);
                var val = model.GetCurrentValue();
                serviceTestStep.MockSelected = true;
                serviceTestStep.AssertSelected = false;
                serviceTestStep.Type = StepType.Mock;
                serviceTestStep.ActivityType = val.GetType().Name;
            }
        }

        void SetStepOutputs(IServiceTestStep serviceTestStep, string debugStateActivityTypeName)
        {
            var type = _types?.FirstOrDefault(x => x.Name == debugStateActivityTypeName);
            if (type == null) return;
            var act = Activator.CreateInstance(type) as IDev2Activity;
            if (serviceTestStep != null)
            {
                serviceTestStep.StepOutputs = AddOutputs(act?.GetOutputs(), serviceTestStep).ToObservableCollection();
            }
        }

        void AddChildDebugItems(IDebugState debugItemContent, IDebugTreeViewItemViewModel debugState, IServiceTestStep parent)
        {
            if (NullParent(debugItemContent, ref parent))
            {
                return;
            }

            if (parent.ActivityType == nameof(DsfForEachActivity))
            {
                ForEachParent(debugItemContent, debugState, parent);
            }
            else if (parent.ActivityType == nameof(GateActivity))
            {
                GateParent(debugItemContent, debugState, parent);
            }
            else if (parent.ActivityType == nameof(SuspendExecutionActivity))
            {
                SuspendExecutionParent(debugItemContent, debugState, parent);
            }
            else if (parent.ActivityType == nameof(DsfSequenceActivity))
            {
                var model = WorkflowDesignerViewModel.GetModelItem(debugItemContent.WorkSurfaceMappingId, debugItemContent.ID);
                if (model?.GetCurrentValue() is DsfSequenceActivity sequence)
                {
                    parent.ActivityID = Guid.Parse(sequence.UniqueID);
                    AddChildren(debugState, parent);
                }
            }
            else
            {
                AddNotContainerActivityType(debugState, parent);
            }
            while (parent != null)
            {
                var child = parent;
                if (child.Parent == null)
                {
                    var exists = FindExistingStep(child.ActivityID.ToString());
                    if (exists == null)
                    {
                        SelectedServiceTest.TestSteps.Add(child);
                    }
                }
                parent = child.Parent;
            }
        }

        void AddNotContainerActivityType(IDebugTreeViewItemViewModel debugState, IServiceTestStep parent)
        {
            if (parent.ActivityType == nameof(DsfActivity))
            {
                if (debugState is DebugStateTreeViewItemViewModel childItem)
                {
                    var content = childItem.Content;
                    var outputs = content.Outputs;
                    AddOutputs(outputs, parent);
                    SetStepIcon(parent.ActivityType, parent);
                }
            }
            else
            {
                AddChildren(debugState, parent);
            }
        }

        void GateParent(IDebugState debugItemContent, IDebugTreeViewItemViewModel debugState, IServiceTestStep parent)
        {
            var model = WorkflowDesignerViewModel?.GetModelItem(debugItemContent.WorkSurfaceMappingId, debugItemContent.ID);
            if (model?.GetCurrentValue() is GateActivity gateActivity && debugState.Children.LastOrDefault() is DebugStateTreeViewItemViewModel childItem)
            {
                var act = gateActivity.DataFunc.Handler as IDev2Activity;
                if (act != null)
                {
                    var guid = Guid.Parse(act.UniqueID);
                    childItem.Content.ID = guid;
                }

                var childItemContent = childItem.Content;
                var outputs = childItemContent.Outputs;

                var exists = parent.Children.FirstOrDefault(a => a.ActivityID == childItemContent.ID);
                if (exists == null)
                {
                    AddGateChildStep(parent, childItem, act, childItemContent, outputs);
                }
            }
        }

        void AddGateChildStep(IServiceTestStep parent, DebugStateTreeViewItemViewModel childItem, IDev2Activity act, IDebugState childItemContent, List<IDebugItem> outputs)
        {
            var childStep = CreateAssertChildStep(parent, childItemContent, childItemContent.ID);
            if (outputs.Count > 0)
            {
                AddOutputs(outputs, childStep);
            }
            else
            {
                AddOutputs(act?.GetOutputs(), childStep);
            }
            SetStepIcon(childStep.ActivityType, childStep);
            parent.Children.Add(childStep);
            if (childItem.Children?.Count > 0)
            {
                AddChildDebugItems(childItemContent, childItem, childStep);
            }
        }

        void SuspendExecutionParent(IDebugState debugItemContent, IDebugTreeViewItemViewModel debugState, IServiceTestStep parent)
        {
            var model = WorkflowDesignerViewModel?.GetModelItem(debugItemContent.WorkSurfaceMappingId, debugItemContent.ID);
            if (model?.GetCurrentValue() is SuspendExecutionActivity suspendExecutionActivity && debugState.Children.LastOrDefault() is DebugStateTreeViewItemViewModel childItem)
            {
                var act = suspendExecutionActivity.SaveDataFunc.Handler as IDev2Activity;
                if (act != null)
                {
                    var guid = Guid.Parse(act.UniqueID);
                    childItem.Content.ID = guid;
                }

                var childItemContent = childItem.Content;
                var outputs = childItemContent.Outputs;

                var exists = parent.Children.FirstOrDefault(a => a.ActivityID == childItemContent.ID);
                if (exists == null)
                {
                    AddSuspendExecutionChildStep(parent, childItem, act, childItemContent, outputs);
                }
            }
        }

        void AddSuspendExecutionChildStep(IServiceTestStep parent, IDebugTreeViewItemViewModel childItem, IDev2Activity act, IDebugState childItemContent, List<IDebugItem> outputs)
        {
            var childStep = CreateAssertChildStep(parent, childItemContent, childItemContent.ID);
            if (outputs.Count > 0)
            {
                AddOutputs(outputs, childStep);
            }
            else
            {
                AddOutputs(act?.GetOutputs(), childStep);
            }
            SetStepIcon(childStep.ActivityType, childStep);
            parent.Children.Add(childStep);
            if (childItem.Children?.Count > 0)
            {
                AddChildDebugItems(childItemContent, childItem, childStep);
            }
        }

        void ForEachParent(IDebugState debugItemContent, IDebugTreeViewItemViewModel debugState, IServiceTestStep parent)
        {
            var model = WorkflowDesignerViewModel?.GetModelItem(debugItemContent.WorkSurfaceMappingId, debugItemContent.ID);
            if (model?.GetCurrentValue() is DsfForEachActivity forEach && debugState.Children.LastOrDefault() is DebugStateTreeViewItemViewModel childItem)
            {
                var act = forEach.DataFunc.Handler as IDev2Activity;
                if (act != null)
                {
                    var guid = Guid.Parse(act.UniqueID);
                    childItem.Content.ID = guid;
                }

                var childItemContent = childItem.Content;
                var outputs = childItemContent.Outputs;

                var exists = parent.Children.FirstOrDefault(a => a.ActivityID == childItemContent.ID);
                if (exists == null)
                {
                    AddForEachChildStep(parent, childItem, act, childItemContent, outputs);
                }
            }
        }

        void AddForEachChildStep(IServiceTestStep parent, DebugStateTreeViewItemViewModel childItem, IDev2Activity act, IDebugState childItemContent, List<IDebugItem> outputs)
        {
            var childStep = CreateAssertChildStep(parent, childItemContent, childItemContent.ID);
            if (outputs.Count > 0)
            {
                AddOutputs(outputs, childStep);
            }
            else
            {
                AddOutputs(act?.GetOutputs(), childStep);
            }
            SetStepIcon(childStep.ActivityType, childStep);
            parent.Children.Add(childStep);
            if (childItem.Children?.Count > 0)
            {
                AddChildDebugItems(childItemContent, childItem, childStep);
            }
        }

        static IServiceTestStep CreateAssertChildStep(IServiceTestStep parent, IDebugState childItemContent, Guid childItemContentId)
        {
            var serviceTestOutputs = new ObservableCollection<IServiceTestOutput>();
            var childStep = new ServiceTestStep(childItemContentId, childItemContent.ActualType, serviceTestOutputs, StepType.Assert)
            {
                StepDescription = childItemContent.DisplayName,
                Parent = parent,
                Type = StepType.Assert
            };
            return childStep;
        }

        bool NullParent(IDebugState debugItemContent, ref IServiceTestStep parent)
        {
            if (parent == null)
            {
                var testStep = new ServiceTestStep(debugItemContent.ID, "", new ObservableCollection<IServiceTestOutput>(), StepType.Assert)
                {
                    StepDescription = debugItemContent.DisplayName,
                    Parent = null
                };

                var seqTypeName = nameof(DsfSequenceActivity);
                var forEachTypeName = nameof(DsfForEachActivity);
                var selectApplyTypeName = nameof(DsfSelectAndApplyActivity);
                var suspendTypeName = nameof(SuspendExecutionActivity);
                var serviceName = nameof(DsfActivity);
                var actualType = debugItemContent.ActualType;
                if (actualType == seqTypeName)
                {
                    SetStepIcon(typeof(DsfSequenceActivity), testStep);
                    testStep.ActivityType = seqTypeName;
                    testStep.ActivityID = debugItemContent.WorkSurfaceMappingId;
                    parent = testStep;
                }
                else if (actualType == forEachTypeName)
                {
                    SetStepIcon(typeof(DsfForEachActivity), testStep);
                    testStep.ActivityType = forEachTypeName;
                    testStep.ActivityID = debugItemContent.WorkSurfaceMappingId;
                    parent = testStep;
                }
                else if (actualType == selectApplyTypeName)
                {
                    SetStepIcon(typeof(DsfSelectAndApplyActivity), testStep);
                    testStep.ActivityType = selectApplyTypeName;
                    testStep.ActivityID = debugItemContent.WorkSurfaceMappingId;
                    parent = testStep;
                }
                else if (actualType == suspendTypeName)
                {
                    SetStepIcon(typeof(SuspendExecutionActivity), testStep);
                    testStep.ActivityType = selectApplyTypeName;
                    testStep.ActivityID = debugItemContent.WorkSurfaceMappingId;
                    parent = testStep;
                }
                else if (actualType == serviceName)
                {
                    SetStepIcon(typeof(DsfActivity), testStep);
                    testStep.ActivityType = serviceName;
                    parent = testStep;
                }
                else
                {
                    return true;
                }
            }
            return false;
        }

        void AddChildren(IDebugTreeViewItemViewModel debugState, IServiceTestStep parent)
        {
            foreach (var debugTreeViewItemViewModel in debugState.Children)
            {
                if (debugTreeViewItemViewModel is DebugStateTreeViewItemViewModel childItem && childItem.ActivityTypeName != "DsfSelectAndApplyActivity")
                {
                    var childItemContent = childItem.Content;
                    var outputs = childItemContent.Outputs;

                    var contentId = childItemContent.ID;
                    if (childItemContent.ActualType == "DsfActivity")
                    {
                        contentId = childItemContent.WorkSurfaceMappingId;
                    }

                    var exists = parent.Children.FirstOrDefault(a => a.ActivityID == contentId);
                    if (exists == null)
                    {
                        AddNewDebugStateChild(parent, childItem, childItemContent, outputs, contentId);
                    }
                    else
                    {
                        AddExistingDebugState(childItem, outputs, exists);
                    }
                }
            }
        }

        void AddExistingDebugState(DebugStateTreeViewItemViewModel childItem, List<IDebugItem> outputs, IServiceTestStep exists)
        {
            if (exists is ServiceTestStep serviceTestStep)
            {
                if (outputs.Count > 0)
                {
                    AddOutputs(outputs, serviceTestStep);
                }
                else
                {
                    var type = _types?.FirstOrDefault(x => x.Name == childItem.ActivityTypeName);
                    if (type == null) return;
                    var act = Activator.CreateInstance(type) as IDev2Activity;
                    serviceTestStep.StepOutputs = AddOutputs(act?.GetOutputs(), serviceTestStep).ToObservableCollection();
                }
            }
        }

        void AddNewDebugStateChild(IServiceTestStep parent, DebugStateTreeViewItemViewModel childItem, IDebugState childItemContent, List<IDebugItem> outputs, Guid contentId)
        {
            var childStep = CreateAssertChildStep(parent, childItemContent, contentId);
            if (outputs.Count > 0)
            {
                AddOutputs(outputs, childStep);
            }
            else
            {
                var type = _types?.FirstOrDefault(x => x.Name == childItem.ActivityTypeName);
                if (type != null)
                {
                    var act = Activator.CreateInstance(type) as IDev2Activity;
                    childStep.StepOutputs = AddOutputs(act?.GetOutputs(), childStep).ToObservableCollection();
                }
            }
            SetStepIcon(childStep.ActivityType, childStep);
            if (!(childStep.StepOutputs?.Count > 0)) return;
            parent.Children.Add(childStep);
            if (childItem.Children?.Count > 0)
            {
                AddChildDebugItems(childItemContent, childItem, childStep);
            }
        }

        void AddOutputs(List<IDebugItem> outputs, IServiceTestStep serviceTestStep)
        {
            var serviceTestOutputs = new ObservableCollection<IServiceTestOutput>();
            if (outputs == null || outputs.Count < 1)
            {
                serviceTestOutputs.Add(new ServiceTestOutput("", "", "", "")
                {
                    AssertOp = "",
                    AddStepOutputRow = s => { serviceTestStep?.AddNewOutput(s); }
                });
                serviceTestStep.StepOutputs = serviceTestOutputs;
                return;
            }
            foreach (var output in outputs)
            {
                AddOutput(output, serviceTestStep, serviceTestOutputs);
            }
            serviceTestStep.StepOutputs = serviceTestOutputs;
        }

        void AddOutput(IDebugItem output, IServiceTestStep serviceTestStep, ObservableCollection<IServiceTestOutput> serviceTestOutputs)
        {
            var actualOutputs = output.ResultsList.Where(result => result.Type == DebugItemResultType.Variable);
            foreach (var debugItemResult in actualOutputs)
            {
                var variable = debugItemResult.Variable;
                var value = debugItemResult.Value;
                var assertOp = "=";
                if (debugItemResult.MoreLink != null)
                {
                    if (serviceTestStep.ActivityType == nameof(DsfEnhancedDotNetDllActivity))
                    {
                        var realValue = WebClient.DownloadString(debugItemResult.MoreLink);
                        value = realValue.TrimEnd(Environment.NewLine.ToCharArray());
                    }
                    else
                    {
                        assertOp = "Contains";
                    }
                }
                var serviceTestOutput = new ServiceTestOutput(variable ?? "", value, "", "")
                {
                    AssertOp = assertOp,
                    AddStepOutputRow = s => { serviceTestStep?.AddNewOutput(s); }
                };
                serviceTestOutputs.Add(serviceTestOutput);
            }
        }

        void SetInputs(IDebugState inputState)
        {
            if (inputState != null)
            {
                foreach (var debugItem in inputState.Inputs)
                {
                    var variable = debugItem.ResultsList.First().Variable.Replace("[[", "").Replace("]]", "");
                    var value = debugItem.ResultsList.First().Value;
                    var serviceTestInput = SelectedServiceTest?.Inputs?.FirstOrDefault(input => input.Variable.Equals(variable));
                    if (serviceTestInput != null)
                    {
                        serviceTestInput.Value = value;
                    }
                }
            }
        }

        public IWarewolfWebClient WebClient
        {
            private get => _webClient ?? CustomContainer.Get<IWarewolfWebClient>();
            set => _webClient = value;
        }

        void SetOutputs(IDebugState outPutState)
        {
            var dataList = new DataListModel();
            dataList.Create(ResourceModel.DataList, ResourceModel.DataList);
            if (outPutState == null)
            {
                return;
            }
            var outPuts = new ObservableCollection<IServiceTestOutput>();
            foreach (var debugItem in outPutState.Outputs)
            {
                foreach (var debugItemResult in debugItem.ResultsList)
                {
                    SetResultListOutputs(outPutState, dataList, outPuts, debugItemResult);
                }
            }
            SelectedServiceTest.Outputs = outPuts;
            SelectedServiceTest.ErrorExpected = outPutState.HasError;
            SelectedServiceTest.NoErrorExpected = !outPutState.HasError;
            SelectedServiceTest.ErrorContainsText = outPutState.ErrorMessage;
        }

        void SetResultListOutputs(IDebugState outPutState, DataListModel dataList, ObservableCollection<IServiceTestOutput> outPuts, IDebugItemResult debugItemResult)
        {
            var variable = debugItemResult.Variable.Replace("[[", "").Replace("]]", "");
            var value = debugItemResult.Value;
            var serviceTestOutput = new ServiceTestOutput(variable, value, "", "");
            var output = serviceTestOutput;
            serviceTestOutput.AddNewAction = () => ((ServiceTestModel)SelectedServiceTest).AddRow(output, dataList);

            if (!string.IsNullOrEmpty(debugItemResult.MoreLink))
            {
                if (outPutState.ActualType == nameof(DsfEnhancedDotNetDllActivity))
                {
                    var realValue = WebClient.DownloadString(debugItemResult.MoreLink);
                    value = realValue.TrimEnd(Environment.NewLine.ToCharArray());
                }
                else
                {
                    serviceTestOutput.AssertOp = "Contains";
                }
            }
            serviceTestOutput.Value = value;
            outPuts.Add(serviceTestOutput);
        }

        static void OnError(Exception exception)
        {
            Dev2Logger.Error(exception, GlobalConstants.WarewolfError);
            throw exception;
        }

        void ItemSelectedAction(ModelItem modelItem)
        {
            if (modelItem == null)
            {
                return;
            }

            var itemType = GetInnerItemType(modelItem);
            if (itemType == typeof(Flowchart) || itemType == typeof(ActivityBuilder))
            {
                return;
            }
            if (itemType == typeof(DsfForEachActivity))
            {
                ProcessForEach(modelItem);
            }
            else if (itemType == typeof(DsfSelectAndApplyActivity))
            {
                ProcessSelectAndApply(modelItem);
            }
            else if (itemType == typeof(DsfSequenceActivity))
            {
                ProcessSequence(modelItem);
            }
            else if (itemType == typeof(GateActivity))
            {
                ProcessGate(modelItem);
            }
            else if (itemType == typeof(SuspendExecutionActivity))
            {
                ProcessSuspendExecution(modelItem);
            }
            else if (itemType == typeof(DsfEnhancedDotNetDllActivity))
            {
                ProcessEnhancedDotNetDll(modelItem);
            }
            else if (itemType == typeof(FlowSwitch<string>))
            {
                ProcessFlowSwitch(modelItem);
            }
            else if (itemType == typeof(DsfSwitch))
            {
                ProcessSwitch(modelItem);
            }
            else if (itemType == typeof(FlowDecision))
            {
                ProcessFlowDecision(modelItem);
            }
            else if (itemType == typeof(DsfDecision))
            {
                ProcessDecision(modelItem);
            }
            else
            {
                ProcessActivity(modelItem);
            }
        }

        static Type GetInnerItemType(ModelItem modelItem)
        {
            var itemType = modelItem.ItemType;
            if (modelItem.Content?.Value != null && itemType == typeof(FlowStep))
            {
                itemType = modelItem.Content.Value.ItemType;
            }
            return itemType;
        }

        void ProcessSequence(ModelItem modelItem)
        {
            var sequence = GetCurrentActivity<DsfSequenceActivity>(modelItem);
            var testStep = BuildParentsFromModelItem(modelItem);
            if (testStep != null)
            {
                AddSequence(sequence, testStep, testStep.Children);
                if (FindExistingStep(testStep.ActivityID.ToString()) == null)
                {
                    SelectedServiceTest.TestSteps.Add(testStep);
                }
            }
            else
            {
                AddSequence(sequence, null, SelectedServiceTest.TestSteps);
            }
        }

        void ProcessGate(ModelItem modelItem)
        {
            var gateActivity = GetCurrentActivity<GateActivity>(modelItem);
            AddGate(gateActivity, null, SelectedServiceTest.TestSteps);
        }

        void ProcessSuspendExecution(ModelItem modelItem)
        {
            var suspendExecutionActivity = GetCurrentActivity<SuspendExecutionActivity>(modelItem);
            AddSuspendExecution(suspendExecutionActivity, null, SelectedServiceTest.TestSteps);
        }

        void ProcessEnhancedDotNetDll(ModelItem modelItem)
        {
            var dotNetDllActivity = GetCurrentActivity<DsfEnhancedDotNetDllActivity>(modelItem);
            var buildParentsFromModelItem = BuildParentsFromModelItem(modelItem);
            if (buildParentsFromModelItem != null)
            {
                AddEnhancedDotNetDll(dotNetDllActivity, buildParentsFromModelItem, buildParentsFromModelItem.Children);
                if (FindExistingStep(buildParentsFromModelItem.ActivityID.ToString()) == null)
                {
                    SelectedServiceTest.TestSteps.Add(buildParentsFromModelItem);
                }
            }
            else
            {
                AddEnhancedDotNetDll(dotNetDllActivity, null, SelectedServiceTest.TestSteps);
            }
        }

        static T GetCurrentActivity<T>(ModelItem modelItem) where T : class
        {
            var activity = modelItem.GetCurrentValue() as T;
            if (activity == null && modelItem.Content?.Value != null)
            {
                activity = modelItem.Content.Value.GetCurrentValue() as T;
            }
            return activity;
        }

        void ProcessForEach(ModelItem modelItem)
        {
            var forEachActivity = GetCurrentActivity<DsfForEachActivity>(modelItem);
            AddForEach(forEachActivity, null, SelectedServiceTest.TestSteps);
        }

        void AddForEach(DsfForEachActivity forEachActivity, IServiceTestStep parent, ObservableCollection<IServiceTestStep> serviceTestSteps)
        {
            if (forEachActivity == null)
            {
                return;
            }
            var uniqueId = forEachActivity.UniqueID;
            var exists = serviceTestSteps.FirstOrDefault(a => a.ActivityID.ToString() == uniqueId);

            var type = typeof(DsfForEachActivity);
            var testStep = CreateMockChildStep(Guid.Parse(uniqueId), parent, type.Name, forEachActivity.DisplayName);
            SetStepIcon(type, testStep);
            var activity = forEachActivity.DataFunc.Handler;
            var act = activity as DsfNativeActivity<string>;
            var workFlowService = activity as DsfActivity;
            if (act != null)
            {
                if (act.GetType() == typeof(DsfSequenceActivity))
                {
                    AddSequence(act as DsfSequenceActivity, testStep, testStep.Children);
                }
                else
                {
                    AddChildActivity(act, testStep);
                }
            }
            else
            {
                if (activity.GetType() == typeof(DsfSelectAndApplyActivity))
                {
                    AddSelectAndApply(activity as DsfSelectAndApplyActivity, testStep, testStep.Children);
                }
                else
                {
                    if (activity.GetType() == type)
                    {
                        AddForEach(activity as DsfForEachActivity, testStep, testStep.Children);
                    }
                }
            }

            if (workFlowService != null)
            {
                AddChildActivity(workFlowService, testStep);
            }
            if (exists == null)
            {
                serviceTestSteps.Add(testStep);
            }
        }

        static IServiceTestStep CreateMockChildStep(Guid uniqueId, IServiceTestStep parent, string typeName, string displayName) => new ServiceTestStep(uniqueId, typeName, new ObservableCollection<IServiceTestOutput>(), StepType.Mock)
        {
            StepDescription = displayName,
            Parent = parent
        };

        void ProcessSelectAndApply(ModelItem modelItem)
        {
            var selectAndApplyActivity = GetCurrentActivity<DsfSelectAndApplyActivity>(modelItem);
            AddSelectAndApply(selectAndApplyActivity, null, SelectedServiceTest.TestSteps);
        }

        void AddSelectAndApply(DsfSelectAndApplyActivity selectApplyActivity, IServiceTestStep parent, ObservableCollection<IServiceTestStep> serviceTestSteps)
        {
            if (selectApplyActivity == null)
            {
                return;
            }
            var uniqueId = selectApplyActivity.UniqueID;
            var exists = serviceTestSteps.FirstOrDefault(a => a.ActivityID.ToString() == uniqueId);

            var type = typeof(DsfSelectAndApplyActivity);
            var testStep = CreateMockChildStep(Guid.Parse(uniqueId), parent, type.Name, selectApplyActivity.DisplayName);
            SetStepIcon(type, testStep);
            var activity = selectApplyActivity.ApplyActivityFunc.Handler;
            var act = activity as DsfNativeActivity<string>;
            var workFlowService = activity as DsfActivity;
            if (act != null)
            {
                if (act.GetType() == typeof(DsfSequenceActivity))
                {
                    AddSequence(act as DsfSequenceActivity, testStep, testStep.Children);
                }
                else
                {
                    AddChildActivity(act, testStep);
                }
            }
            else
            {
                if (activity != null && activity.GetType() == typeof(DsfForEachActivity))
                {
                    AddForEach(activity as DsfForEachActivity, testStep, testStep.Children);
                }
                else
                {
                    if (activity != null && activity.GetType() == typeof(DsfSelectAndApplyActivity))
                    {
                        AddSelectAndApply(activity as DsfSelectAndApplyActivity, testStep, testStep.Children);
                    }
                }
            }
            if (workFlowService != null)
            {
                AddChildActivity(workFlowService, testStep);
            }
            if (exists == null)
            {
                serviceTestSteps.Add(testStep);
            }
            else
            {
                AddMissingChild(serviceTestSteps, testStep);
            }
        }

        void AddSequence(DsfSequenceActivity sequence, IServiceTestStep parent, ObservableCollection<IServiceTestStep> serviceTestSteps)
        {
            if (sequence is null)
            {
                return;
            }
            var uniqueId = sequence.UniqueID;
            var exists = serviceTestSteps.FirstOrDefault(a => a.ActivityID.ToString() == uniqueId);

            var type = typeof(DsfSequenceActivity);
            var testStep = CreateMockChildStep(Guid.Parse(uniqueId), parent, type.Name, sequence.DisplayName);
            SetStepIcon(type, testStep);
            foreach (var activity in sequence.Activities)
            {
                AddSequenceActivity(testStep, activity);
            }
            if (exists == null)
            {
                serviceTestSteps.Add(testStep);
            }
            else
            {
                AddMissingChild(serviceTestSteps, testStep);
            }
        }

        void AddSequenceActivity(IServiceTestStep testStep, Activity activity)
        {
            if (activity is DsfNativeActivity<string> act)
            {
                if (act.GetType() == typeof(DsfSequenceActivity))
                {
                    AddSequence(act as DsfSequenceActivity, testStep, testStep.Children);
                }
                else
                {
                    AddChildActivity(act, testStep);
                }
            }
            else
            {
                if (activity is DsfNativeActivity<bool> act2)
                {
                    AddChildActivity(act2, testStep);
                }
                if (activity.GetType() == typeof(DsfForEachActivity))
                {
                    AddForEach(activity as DsfForEachActivity, testStep, testStep.Children);
                }
                else
                {
                    if (activity.GetType() == typeof(DsfSelectAndApplyActivity))
                    {
                        AddSelectAndApply(activity as DsfSelectAndApplyActivity, testStep, testStep.Children);
                    }
                }
            }
        }

        void AddGate(GateActivity gateActivity, IServiceTestStep parent, ObservableCollection<IServiceTestStep> serviceTestSteps)
        {
            if (gateActivity == null)
            {
                return;
            }
            var uniqueId = gateActivity.UniqueID;
            var exists = serviceTestSteps.FirstOrDefault(a => a.ActivityID.ToString() == uniqueId);

            var type = typeof(GateActivity);
            var testStep = CreateMockChildStep(Guid.Parse(uniqueId), parent, type.Name, gateActivity.DisplayName);
            SetStepIcon(type, testStep);
            var activity = gateActivity.DataFunc.Handler;
            var act = activity as DsfNativeActivity<string>;
            var workFlowService = activity as DsfActivity;
            if (act != null)
            {
                if (act.GetType() == typeof(DsfSequenceActivity))
                {
                    AddSequence(act as DsfSequenceActivity, testStep, testStep.Children);
                }
                else
                {
                    AddChildActivity(act, testStep);
                }
            }
            else
            {
                if (activity?.GetType() == typeof(DsfSelectAndApplyActivity))
                {
                    AddSelectAndApply(activity as DsfSelectAndApplyActivity, testStep, testStep.Children);
                }
                else
                {
                    if (activity?.GetType() == type)
                    {
                        AddGate(activity as GateActivity, testStep, testStep.Children);
                    }
                }
            }

            if (workFlowService != null)
            {
                AddChildActivity(workFlowService, testStep);
            }
            if (exists == null)
            {
                serviceTestSteps.Add(testStep);
            }
        }

        void AddSuspendExecution(SuspendExecutionActivity suspendExecutionActivity, IServiceTestStep parent, ICollection<IServiceTestStep> serviceTestSteps)
        {
            if (suspendExecutionActivity == null)
            {
                return;
            }
            var uniqueId = suspendExecutionActivity.UniqueID;
            var exists = serviceTestSteps.FirstOrDefault(a => a.ActivityID.ToString() == uniqueId);

            var type = typeof(SuspendExecutionActivity);
            var testStep = CreateMockChildStep(Guid.Parse(uniqueId), parent, type.Name, suspendExecutionActivity.DisplayName);
            SetStepIcon(type, testStep);
            var activity = suspendExecutionActivity.SaveDataFunc.Handler;
            var act = activity as DsfNativeActivity<string>;
            var workFlowService = activity as DsfActivity;
            if (act != null)
            {
                if (act.GetType() == typeof(DsfSequenceActivity))
                {
                    AddSequence(act as DsfSequenceActivity, testStep, testStep.Children);
                }
                else
                {
                    AddChildActivity(act, testStep);
                }
            }
            else
            {
                if (activity?.GetType() == typeof(DsfSelectAndApplyActivity))
                {
                    AddSelectAndApply(activity as DsfSelectAndApplyActivity, testStep, testStep.Children);
                }
                else
                {
                    if (activity?.GetType() == type)
                    {
                        AddSuspendExecution(activity as SuspendExecutionActivity, testStep, testStep.Children);
                    }
                }
            }

            if (workFlowService != null)
            {
                AddChildActivity(workFlowService, testStep);
            }
            if (exists == null)
            {
                serviceTestSteps.Add(testStep);
            }
        }

        void AddEnhancedDotNetDll(DsfEnhancedDotNetDllActivity dotNetDllActivity, IServiceTestStep parent, ObservableCollection<IServiceTestStep> serviceTestSteps)
        {
            if (dotNetDllActivity == null)
            {
                return;
            }
            var uniqueId = dotNetDllActivity.UniqueID;
            var exists = serviceTestSteps.FirstOrDefault(a => a.ActivityID.ToString() == uniqueId);

            var type = typeof(DsfEnhancedDotNetDllActivity);
            var testStep = CreateMockChildStep(Guid.Parse(uniqueId), parent, type.Name, dotNetDllActivity.DisplayName);
            SetStepIcon(type, testStep);
            if (exists == null)
            {
                serviceTestSteps.Add(testStep);
                AddEnhancedDotNetDllConstructor(dotNetDllActivity, testStep);
                foreach (var pluginAction in dotNetDllActivity.MethodsToRun)
                {
                    if (!pluginAction.IsVoid)
                    {
                        AddEnhancedDotNetDllMethod(pluginAction, testStep);
                    }
                }
            }
            else
            {
                AddMissingChild(serviceTestSteps, exists);
                var constructorStepExists = exists.Children.FirstOrDefault(step => step.ActivityID == dotNetDllActivity.Constructor.ID);
                if (constructorStepExists == null)
                {
                    AddEnhancedDotNetDllConstructor(dotNetDllActivity, exists);
                }
                foreach (var pluginAction in dotNetDllActivity.MethodsToRun)
                {
                    AddEnhancedDotNetDllMethodChild(pluginAction, exists);
                }
            }
        }

        void AddEnhancedDotNetDllMethodChild(IPluginAction pluginAction, IServiceTestStep exists)
        {
            if (!pluginAction.IsVoid)
            {
                var actionExists = exists.Children.FirstOrDefault(step => step.ActivityID == pluginAction.ID);
                if (actionExists != null)
                {
                    AddEnhancedDotNetDllMethod(pluginAction, exists);
                }
            }
        }

        static void AddMissingChild(ObservableCollection<IServiceTestStep> serviceTestSteps, IServiceTestStep testStep)
        {
            if (serviceTestSteps.Count < 1)
            {
                return;
            }
            foreach (var serviceTestStep in serviceTestSteps)
            {
                if (serviceTestStep.ActivityID != testStep.ActivityID)
                {
                    continue;
                }
                AddMissingChild(serviceTestStep, testStep);
            }
        }

        static void AddMissingChild(IServiceTestStep serviceTestStep, IServiceTestStep testStep)
        {
            if (serviceTestStep.Children.Count == testStep.Children.Count)
            {
                foreach (var child in testStep.Children)
                {
                    AddMissingChild(serviceTestStep.Children, child);
                }
            }
            else
            {
                foreach (var child in testStep.Children)
                {
                    AddMissingChild(serviceTestStep, testStep, child);
                }
            }
        }

        static void AddMissingChild(IServiceTestStep serviceTestStep, IServiceTestStep testStep, IServiceTestStep child)
        {
            var testSteps = serviceTestStep.Children.Where(a => a.ActivityID == child.ActivityID);
            if (!testSteps.Any())
            {
                var indexOf = testStep.Children.IndexOf(child);
                child.Parent = serviceTestStep;
                serviceTestStep.Children.Insert(indexOf, child);
            }
        }

        void AddChildActivity<T>(DsfNativeActivity<T> act, IServiceTestStep testStep)
        {
            var outputs = act.GetOutputs();
            if (outputs != null && outputs.Count > 0)
            {
                var serviceTestStep = CreateMockChildStep(Guid.Parse(act.UniqueID), testStep, act.GetType().Name, act.DisplayName);
                var serviceTestOutputs = outputs.Select(output => new ServiceTestOutput(output, "", "", "")
                {
                    HasOptionsForValue = false,
                    AddStepOutputRow = serviceTestStep.AddNewOutput
                }).Cast<IServiceTestOutput>().ToObservableCollection();
                serviceTestStep.StepOutputs = serviceTestOutputs;
                SetStepIcon(act.GetType(), serviceTestStep);
                testStep.Children.Add(serviceTestStep);
            }
        }

        void AddEnhancedDotNetDllConstructor(DsfEnhancedDotNetDllActivity dotNetConstructor, IServiceTestStep testStep)
        {
            var serviceTestStep = CreateMockChildStep(dotNetConstructor.Constructor.ID, testStep, testStep.ActivityType, dotNetConstructor.Constructor.ConstructorName);
            var serviceOutputs = new ObservableCollection<IServiceTestOutput>
            {
                new ServiceTestOutput(dotNetConstructor.ObjectName ?? "", "", "", "")
            };
            serviceTestStep.StepOutputs = serviceOutputs;
            SetStepIcon(testStep.ActivityType, serviceTestStep);
            testStep.Children.Insert(0, serviceTestStep);
        }

        void AddEnhancedDotNetDllMethod(IPluginAction pluginAction, IServiceTestStep testStep)
        {
            var serviceTestStep = CreateMockChildStep(pluginAction.ID, testStep, testStep.ActivityType, pluginAction.Method);
            var serviceOutputs = new ObservableCollection<IServiceTestOutput>
            {
                new ServiceTestOutput(pluginAction.OutputVariable ?? "", "", "", "")
            };
            serviceTestStep.StepOutputs = serviceOutputs;
            SetStepIcon(testStep.ActivityType, serviceTestStep);
            testStep.Children.Add(serviceTestStep);
        }

        void ProcessSwitch(ModelItem modelItem)
        {
            var cases = modelItem.GetProperty("Switches") as Dictionary<string, IDev2Activity>;
            var defaultCase = modelItem.GetProperty("Default") as List<IDev2Activity>;
            var uniqueId = modelItem.GetProperty("UniqueID").ToString();
            var exists = SelectedServiceTest.TestSteps.FirstOrDefault(a => a.ActivityID.ToString() == uniqueId);

            if (exists == null && SelectedServiceTest != null)
            {
                var switchOptions = cases?.Select(pair => pair.Key).ToList();
                if (defaultCase != null)
                {
                    switchOptions?.Insert(0, "Default");
                }
                var serviceTestOutputs = new ObservableCollection<IServiceTestOutput>();
                var serviceTestOutput = new ServiceTestOutput(GlobalConstants.ArmResultText, "", "", "")
                {
                    HasOptionsForValue = true,
                    OptionsForValue = switchOptions
                };
                serviceTestOutputs.Add(serviceTestOutput);
                if (SelectedServiceTest.AddTestStep(uniqueId, modelItem.GetProperty("DisplayName").ToString(), nameof(DsfSwitch), serviceTestOutputs) is ServiceTestStep serviceTestStep)
                {
                    SetStepIcon(typeof(DsfSwitch), serviceTestStep);
                }
            }
        }

        IServiceTestStep ProcessFlowSwitch(ModelItem modelItem)
        {
            if (modelItem == null)
            {
                return null;
            }
            var condition = modelItem.GetProperty("Expression");
            var activity = (DsfFlowNodeActivity<string>)condition;
            var flowSwitch = GetCurrentActivity<FlowSwitch<string>>(modelItem);
            if (flowSwitch == null)
            {
                var modelItemParent = modelItem.Parent;
                if (modelItemParent != null)
                {
                    flowSwitch = GetCurrentActivity<FlowSwitch<string>>(modelItemParent);
                    condition = modelItemParent.GetProperty("Expression");
                }
                activity = (DsfFlowNodeActivity<string>)condition;
            }
            if (flowSwitch != null)
            {
                var uniqueId = activity.UniqueID;
                var exists = SelectedServiceTest.TestSteps.FirstOrDefault(a => a.ActivityID.ToString() == uniqueId);

                if (exists == null && SelectedServiceTest != null)
                {
                    return CreateFlowSwitchTestStep(flowSwitch, uniqueId);
                }
            }
            return null;
        }

        IServiceTestStep CreateFlowSwitchTestStep(FlowSwitch<string> flowSwitch, string uniqueId)
        {
            var switchOptions = flowSwitch.Cases?.Select(pair => pair.Key).ToList();
            if (flowSwitch.Default != null)
            {
                switchOptions?.Insert(0, "Default");
            }
            var serviceTestOutputs = new ObservableCollection<IServiceTestOutput>();
            var serviceTestOutput = new ServiceTestOutput(GlobalConstants.ArmResultText, "", "", "")
            {
                HasOptionsForValue = true,
                OptionsForValue = switchOptions
            };
            serviceTestOutputs.Add(serviceTestOutput);
            var serviceTestStep = SelectedServiceTest.AddTestStep(uniqueId, flowSwitch.DisplayName, nameof(DsfSwitch), serviceTestOutputs);
            if (serviceTestStep != null)
            {
                SetStepIcon(typeof(DsfSwitch), serviceTestStep);
            }

            return serviceTestStep;
        }

        void ProcessActivity(ModelItem modelItem)
        {
            var step = BuildParentsFromModelItem(modelItem);
            if (step != null)
            {
                if (step.Parent == null)
                {
                    ProcessStepActivity(step);
                }
                else
                {
                    ProcessParentsActivities(step);
                }
            }
            else
            {
                var computedValue = modelItem.GetCurrentValue();
                var boolAct = computedValue as DsfActivityAbstract<bool>;
                var activityUniqueId = boolAct?.UniqueID;
                var activityDisplayName = boolAct?.DisplayName;
                var type = computedValue.GetType();
                var serviceTestOutputs = new ObservableCollection<IServiceTestOutput>();
                var alreadyAdded = CheckForExists(activityUniqueId, new List<string>(), activityDisplayName, type);
                if (alreadyAdded == null && activityUniqueId != null && type == typeof(DsfActivity))
                {
                    var testStep = CreateMockChildStep(Guid.Parse(activityUniqueId), null, type.Name, activityDisplayName);
                    serviceTestOutputs.Add(new ServiceTestOutput("", "", "", "")
                    {
                        AssertOp = "",
                        AddStepOutputRow = testStep.AddNewOutput,
                        IsSearchCriteriaEnabled = true
                    });
                    testStep.StepOutputs = serviceTestOutputs;
                    SelectedServiceTest.TestSteps.Add(testStep);
                    SetStepIcon(type, testStep);
                }
            }
        }

        void ProcessStepActivity(IServiceTestStep step)
        {
            var exists = FindExistingStep(step.ActivityID.ToString());
            if (exists == null)
            {
                SelectedServiceTest.TestSteps.Add(step);
            }
        }

        void ProcessParentsActivities(IServiceTestStep step)
        {
            var parent = step.Parent;
            while (parent != null)
            {
                var child = parent;
                if (child.Parent == null)
                {
                    var exists = FindExistingStep(step.ActivityID.ToString());
                    if (exists == null)
                    {
                        SelectedServiceTest.TestSteps.Add(child);
                    }
                }
                parent = child.Parent;
            }
        }

        IServiceTestStep BuildParentsFromModelItem(ModelItem modelItem)
        {
            var computedValue = modelItem.GetCurrentValue();
            if (computedValue is FlowStep && modelItem.Content?.Value != null)
            {
                computedValue = modelItem.Content.Value.GetCurrentValue();
            }
            var dsfActivityAbstract = computedValue as DsfActivityAbstract<string>;

            var activityUniqueId = dsfActivityAbstract?.UniqueID;
            var activityDisplayName = dsfActivityAbstract?.DisplayName;
            var outputs = dsfActivityAbstract?.GetOutputs();

            if (dsfActivityAbstract == null)
            {
                var boolAct = computedValue as DsfActivityAbstract<bool>;

                activityUniqueId = boolAct?.UniqueID;
                activityDisplayName = boolAct?.DisplayName;
                outputs = boolAct?.GetOutputs();
            }

            var type = computedValue.GetType();
            var item = modelItem.Parent;

            if (item != null && (item.ItemType != typeof(Flowchart) || item.ItemType == typeof(ActivityBuilder)))
            {
                var parentComputedValue = item.GetCurrentValue();
                if (parentComputedValue is FlowStep)
                {
                    var parentFlowStepUniqueId = GetParentFlowStepUniqueId(computedValue, item, ref parentComputedValue);
                    if (parentFlowStepUniqueId == activityUniqueId)
                    {
                        parentComputedValue = item.Content.Value.GetCurrentValue();
                    }
                    var parentActivityAbstract = parentComputedValue as DsfActivityAbstract<string>;
                    var parentActivityUniqueId = parentActivityAbstract?.UniqueID;
                    if (parentActivityAbstract == null)
                    {
                        var boolParentAct = computedValue as DsfActivityAbstract<bool>;
                        parentActivityUniqueId = boolParentAct?.UniqueID;
                    }
                    if (parentActivityUniqueId == activityUniqueId)
                    {
                        return CheckForExists(activityUniqueId, outputs, activityDisplayName, type);
                    }
                }

                if (outputs != null && outputs.Count > 0 && ServiceTestStepWithOutputs(activityUniqueId, activityDisplayName, outputs, type, item, out IServiceTestStep serviceTestStep) && ServiceTestStepWithOutputs(activityUniqueId, activityDisplayName, outputs, type, item, out IServiceTestStep testStep))
                {
                    return testStep;
                }

                if (ServiceTestStepGetParentType(item, out var serviceTestStep1))
                {
                    return serviceTestStep1;
                }
                return BuildParentsFromModelItem(item);
            }
            return CheckForExists(activityUniqueId, outputs, activityDisplayName, type);
        }

        static string GetParentFlowStepUniqueId(object computedValue, ModelItem item, ref object parentComputedValue)
        {
            if (item.Content?.Value != null)
            {
                parentComputedValue = item.Content.Value.GetCurrentValue();
            }
            var parentActivityAbstract = parentComputedValue as DsfActivityAbstract<string>;
            var parentActivityUniqueId = parentActivityAbstract?.UniqueID;
            if (parentActivityAbstract == null)
            {
                var boolParentAct = computedValue as DsfActivityAbstract<bool>;
                parentActivityUniqueId = boolParentAct?.UniqueID;
            }

            return parentActivityUniqueId;
        }

        IServiceTestStep CheckForExists(string activityUniqueId, List<string> outputs, string activityDisplayName, Type type)
        {
            var exists = FindExistingStep(activityUniqueId);
            if (exists == null && outputs != null && outputs.Count > 0)
            {
                var serviceTestStep = SelectedServiceTest.AddTestStep(activityUniqueId, activityDisplayName, type.Name, new ObservableCollection<IServiceTestOutput>());

                var serviceTestOutputs = outputs.Select(output =>
                {
                    return new ServiceTestOutput(output ?? "", "", "", "")
                    {
                        HasOptionsForValue = false,
                        AddStepOutputRow = s => { serviceTestStep?.AddNewOutput(s); }
                    };
                }).Cast<IServiceTestOutput>().ToList();
                if (serviceTestStep != null)
                {
                    serviceTestStep.StepOutputs = serviceTestOutputs.ToObservableCollection();
                    SetStepIcon(type, serviceTestStep);

                    return serviceTestStep;
                }
            }
            return exists;
        }

        bool ServiceTestStepWithOutputs(string uniqueId, string displayName, List<string> outputs, Type type, ModelItem item, out IServiceTestStep serviceTestStep)
        {
            var exists = FindExistingStep(uniqueId);
            if (exists == null)
            {
                var step = CreateServiceTestStep(Guid.Parse(uniqueId), displayName, type, new List<IServiceTestOutput>());
                var serviceTestOutputs = AddOutputsIfHasVariable(outputs, step);
                step.StepOutputs = serviceTestOutputs.ToObservableCollection();
                SetParentChild(item, step);
                {
                    serviceTestStep = step;
                    return true;
                }
            }
            serviceTestStep = null;
            return false;
        }

        static List<IServiceTestOutput> AddOutputsIfHasVariable(List<string> outputs, IServiceTestStep step)
        {
            var serviceTestOutputs =
                outputs.Select(output => new ServiceTestOutput(output ?? "", "", "", "")
                {
                    HasOptionsForValue = false,
                    AddStepOutputRow = step.AddNewOutput
                }).Cast<IServiceTestOutput>().ToList();
            return serviceTestOutputs;
        }

        static List<IServiceTestOutput> AddOutputs(List<string> outputs, IServiceTestStep step)
        {
            if (outputs == null || outputs.Count == 0)
            {
                return new List<IServiceTestOutput>
                {
                    new ServiceTestOutput("", "", "", "")
                    {
                        HasOptionsForValue = false,
                        AddStepOutputRow = step.AddNewOutput
                    }
                };
            }
            var serviceTestOutputs =
                outputs.Select(output => new ServiceTestOutput(output ?? "", "", "", "")
                {
                    HasOptionsForValue = false,
                    AddStepOutputRow = step.AddNewOutput
                }).Cast<IServiceTestOutput>().ToList();
            return serviceTestOutputs;
        }

        IServiceTestStep FindExistingStep(string uniqueId)
        {
            var exists = SelectedServiceTest.TestSteps.Flatten(step => step.Children).FirstOrDefault(a => a.ActivityID.ToString() == uniqueId);
            return exists;
        }

        bool ServiceTestStepGetParentType(ModelItem item, out IServiceTestStep serviceTestStep)
        {
            Type activityType = null;
            var uniqueId = string.Empty;
            var displayName = string.Empty;
            if (item.ItemType == typeof(DsfSequenceActivity))
            {
                if (item.GetCurrentValue() is DsfSequenceActivity act)
                {
                    uniqueId = act.UniqueID;
                    activityType = typeof(DsfSequenceActivity);
                    displayName = act.DisplayName;
                }
            }
            else if (item.ItemType == typeof(DsfForEachActivity))
            {
                if (item.GetCurrentValue() is DsfForEachActivity act)
                {
                    uniqueId = act.UniqueID;
                    activityType = typeof(DsfForEachActivity);
                    displayName = act.DisplayName;
                }
            }
            else if (item.ItemType == typeof(SuspendExecutionActivity))
            {
                if (item.GetCurrentValue() is SuspendExecutionActivity act)
                {
                    uniqueId = act.UniqueID;
                    activityType = typeof(SuspendExecutionActivity);
                    displayName = act.DisplayName;
                }
            }
            else
            {
                if (item.ItemType == typeof(DsfSelectAndApplyActivity) && item.GetCurrentValue() is DsfSelectAndApplyActivity act)
                {
                    uniqueId = act.UniqueID;
                    activityType = typeof(DsfSelectAndApplyActivity);
                    displayName = act.DisplayName;
                }
            }
            if (!string.IsNullOrWhiteSpace(uniqueId))
            {
                var exists = FindExistingStep(uniqueId);
                if (exists == null)
                {
                    var step = CreateServiceTestStep(Guid.Parse(uniqueId), displayName, activityType, new List<IServiceTestOutput>());
                    SetParentChild(item, step);
                    {
                        serviceTestStep = step;
                        return true;
                    }
                }
                serviceTestStep = SelectedServiceTest.TestSteps.Flatten(step => step.Children).FirstOrDefault(a => a.ActivityID.ToString() == uniqueId);
                return true;
            }
            serviceTestStep = null;
            return false;
        }

        IServiceTestStep CreateServiceTestStep(Guid uniqueId, string displayName, Type type, List<IServiceTestOutput> serviceTestOutputs)
        {
            var step = new ServiceTestStep(uniqueId, type.Name, serviceTestOutputs.ToObservableCollection(), StepType.Assert)
            {
                StepDescription = displayName
            };
            SetStepIcon(type, step);
            return step;
        }

        void SetParentChild(ModelItem item, IServiceTestStep step)
        {
            var parent = BuildParentsFromModelItem(item);
            if (parent != null)
            {
                step.Parent = parent;
                parent.Children.Add(step);
            }
        }

        void SetStepIcon(Type type, IServiceTestStep serviceTestStep)
        {
            SetStepIcon(type?.Name, serviceTestStep);
        }

        void SetStepIcon(string typeName, IServiceTestStep serviceTestStep)
        {
            if (string.IsNullOrEmpty(typeName) || serviceTestStep == null)
            {
                return;
            }
            var actTypeName = typeName;
            if (actTypeName == "DsfActivity")
            {
                if (serviceTestStep is ServiceTestStep serviceStep)
                {
                    serviceStep.StepIcon = Application.Current?.TryFindResource("Explorer-WorkflowService") as ImageSource;
                }
                return;
            }
            if (typeName == "DsfDecision" || typeName == "FlowDecision")
            {
                actTypeName = "DsfFlowDecisionActivity";
            }
            if (typeName == "DsfSwitch")
            {
                actTypeName = "DsfFlowSwitchActivity";
            }
            var type = _types?.FirstOrDefault(x => x.Name == actTypeName);
            if (type == null || !type.GetCustomAttributes().Any(a => a is ToolDescriptorInfo)) return;
            var desc = GetDescriptorFromAttribute(type);
            if (serviceTestStep is ServiceTestStep serviceStepAsTestStep)
            {
                serviceStepAsTestStep.StepIcon = Application.Current?.TryFindResource(desc.Icon) as ImageSource;
            }
        }

        static IToolDescriptor GetDescriptorFromAttribute(Type type)
        {
            var info = type.GetCustomAttributes(typeof(ToolDescriptorInfo)).First() as ToolDescriptorInfo;
            return new ToolDescriptor(info.Id, info.Designer, new WarewolfType(type.FullName, type.Assembly.GetName().Version, type.Assembly.Location), info.Name, info.Icon, type.Assembly.GetName().Version, true, info.Category, ToolType.Native, info.IconUri, info.FilterTag, info.ResourceToolTip, info.ResourceHelpText);
        }

        void ProcessDecision(ModelItem modelItem)
        {
            if (modelItem == null)
            {
                return;
            }
            var dds = modelItem.GetProperty("Conditions") as Dev2DecisionStack;
            var uniqueId = modelItem.GetProperty("UniqueID").ToString();
            var exists = SelectedServiceTest.TestSteps.FirstOrDefault(a => a.ActivityID.ToString() == uniqueId);

            if (exists == null && SelectedServiceTest != null)
            {
                var serviceTestOutputs = new ObservableCollection<IServiceTestOutput>();
                if (dds != null)
                {
                    var serviceTestOutput = new ServiceTestOutput(GlobalConstants.ArmResultText, "", "", "")
                    {
                        HasOptionsForValue = true,
                        OptionsForValue = new List<string> { dds.TrueArmText, dds.FalseArmText }
                    };
                    serviceTestOutputs.Add(serviceTestOutput);
                }
                if (SelectedServiceTest.AddTestStep(uniqueId, modelItem.GetProperty("DisplayName").ToString(), nameof(DsfDecision), serviceTestOutputs) is ServiceTestStep serviceTestStep)
                {
                    SetStepIcon(typeof(DsfDecision), serviceTestStep);
                }
            }
        }

        IServiceTestStep ProcessFlowDecision(ModelItem modelItem)
        {
            if (modelItem == null)
            {
                return null;
            }
            var condition = modelItem.GetProperty("Condition");
            string expression;
            string uniqueId;
            var activity = (DsfFlowNodeActivity<bool>)condition;
            if (activity != null)
            {
                uniqueId = activity.UniqueID;
                expression = activity.ExpressionText;
            }
            else
            {
                expression = modelItem.GetProperty("ExpressionText") as string;
                uniqueId = modelItem.GetProperty("UniqueID") as string;
            }
            if (!string.IsNullOrEmpty(expression))
            {
                var eval = Dev2DecisionStack.ExtractModelFromWorkflowPersistedData(expression);

                if (!string.IsNullOrEmpty(eval))
                {
                    var ser = new Dev2JsonSerializer();
                    var dds = ser.Deserialize<Dev2DecisionStack>(eval);

                    var exists = SelectedServiceTest.TestSteps?.FirstOrDefault(a => a.ActivityID.ToString() == uniqueId);

                    if (exists == null && SelectedServiceTest != null)
                    {
                        var serviceTestOutputs = new ObservableCollection<IServiceTestOutput>();
                        var serviceTestOutput = new ServiceTestOutput(GlobalConstants.ArmResultText, "", "", "")
                        {
                            HasOptionsForValue = true,
                            OptionsForValue = new List<string> { dds.TrueArmText, dds.FalseArmText }
                        };
                        serviceTestOutputs.Add(serviceTestOutput);
                        var serviceTestStep = SelectedServiceTest.AddTestStep(uniqueId, dds.DisplayText, nameof(DsfDecision), serviceTestOutputs);
                        SetStepIcon(typeof(DsfDecision), serviceTestStep);
                        return serviceTestStep;
                    }
                }
            }
            return null;
        }

        void SetServerName(IContextualResourceModel resourceModel)
        {
            if (resourceModel.Environment == null || resourceModel.Environment.IsLocalHost)
            {
                _serverName = string.Empty;
            }
            else
            {
                if (!resourceModel.Environment.IsLocalHost)
                {
                    _serverName = " - " + resourceModel.Environment.Name;
                }
            }
        }

        void OnReceivedResourceAffectedMessage(Guid resourceId, CompileMessageList changeList)
        {
            if (resourceId == ResourceModel.ID)
            {
                IsLoading = true;
                AsyncWorker.Start(() =>
                {
                    var contextModel = ResourceModel?.Environment?.ResourceRepository?.LoadContextualResourceModel(resourceId);
                    _resourceModel = contextModel;
                    return GetTests();
                }, models =>
                {
                    var dummyTest = new DummyServiceTest(CreateTests) { TestName = "Create a new test." };
                    models.Add(dummyTest);
                    var testName = SelectedServiceTest?.TestName;
                    SelectedServiceTest = dummyTest;
                    Tests = models;
                    SelectedServiceTest = _tests.FirstOrDefault(model => model.TestName == testName);
                    var mainViewModel = CustomContainer.Get<IShellViewModel>();
                    WorkflowDesignerViewModel = mainViewModel?.CreateNewDesigner(ResourceModel);
                    if (WorkflowDesignerViewModel != null)
                    {
                        WorkflowDesignerViewModel.ItemSelectedAction = ItemSelectedAction;
                    }
                    IsLoading = false;
                });
            }
        }

        bool IsServerConnected() => ResourceModel.Environment.IsConnected;

        void StopTest()
        {
            SelectedServiceTest.IsTestRunning = false;
            SelectedServiceTest.TestPending = true;
            ServiceTestCommandHandler.StopTest(ResourceModel);
        }

        void RunSelectedTestInBrowser()
        {
            var runSelectedTestUrl = GetWebRunUrlForTest(SelectedServiceTest);
            ServiceTestCommandHandler.RunSelectedTestInBrowser(runSelectedTestUrl, _processExecutor);
        }

        void RunSelectedTest()
        {
            if (SelectedServiceTest != null)
            {
                if (SelectedServiceTest.IsDirty)
                {
                    if (ShowPopupWhenDuplicates())
                    {
                        return;
                    }
                    Save(new List<IServiceTestModel> { SelectedServiceTest });
                    if (IsResourceDeleted)
                    {
                        return;
                    }
                }
                ServiceTestCommandHandler.RunSelectedTest(SelectedServiceTest, ResourceModel, AsyncWorker);
                ViewModelUtils.RaiseCanExecuteChanged(StopTestCommand);
            }
        }

        void RunAllTestsInBrowser()
        {
            ServiceTestCommandHandler.RunAllTestsInBrowser(IsDirty, RunAllTestsUrl, _processExecutor);
        }

        private void RunAllCoverageInBrowser()
        {
            ServiceTestCommandHandler.RunAllTestCoverageInBrowser(IsDirty, RunAllCoverageUrl, _processExecutor);
        }

        void RunAllTests()
        {
            ServiceTestCommandHandler.RunAllTestsCommand(IsDirty, RealTests().Where(model => model.Enabled), ResourceModel, AsyncWorker);
            SelectedServiceTest = null;
        }

        void DuplicateTest()
        {
            var testNumber = GetNewTestNumber(SelectedServiceTest.TestName);
            var duplicateTest = ServiceTestCommandHandler.DuplicateTest(SelectedServiceTest, testNumber);
            AddAndSelectTest(duplicateTest);
            foreach (var testStep in duplicateTest.TestSteps)
            {
                var typeName = testStep.ActivityType;
                SetStepIcon(typeName, testStep);
            }
        }

        bool CanDeleteTest(IServiceTestModel selectedTestModel) => GetPermissions() && selectedTestModel != null && !selectedTestModel.Enabled && IsServerConnected();

        IAsyncWorker AsyncWorker { get; }
        IEventAggregator EventPublisher { get; }

        void CreateTests(bool isFromDebug = false)
        {
            _canAddFromDebug = true;
            SelectedServiceTest = null;
            if (IsDirty)
            {
                PopupController?.Show(Resources.Languages.Core.ServiceTestSaveEditedTestsMessage, Resources.Languages.Core.ServiceTestSaveEditedTestsHeader, MessageBoxButton.OK, MessageBoxImage.Error, null, false, true, false, false, false, false);
                _canAddFromDebug = false;
                return;
            }

            var testNumber = GetNewTestNumber("Test");
            var testModel = ServiceTestCommandHandler.CreateTest(ResourceModel, testNumber, isFromDebug);
            AddAndSelectTest(testModel);
        }

        bool _canAddFromDebug;
        bool _isLoading;
        bool _isValid;
        bool _dirty;
        IWarewolfWebClient _webClient;

        int GetNewTestNumber(string testName)
        {
            var counter = 1;
            var fullName = testName + " " + counter;

            while (Contains(fullName))
            {
                counter++;
                fullName = testName + " " + counter;
            }

            return counter;
        }

        bool Contains(string nameToCheck)
        {
            var serviceTestModel = RealTests().FirstOrDefault(a => a.TestName.Contains(nameToCheck));
            return serviceTestModel != null;
        }

        void SetDuplicateTestTooltip()
        {
            if (SelectedServiceTest != null)
            {
                SelectedServiceTest.DuplicateTestTooltip = SelectedServiceTest.NewTest ? Resources.Languages.Tooltips.ServiceTestNewTestDisabledDuplicateSelectedTestTooltip : CanDuplicateTest ? Resources.Languages.Tooltips.ServiceTestDuplicateSelectedTestTooltip : Resources.Languages.Tooltips.ServiceTestDisabledDuplicateSelectedTestTooltip;
            }
        }

        void AddAndSelectTest(IServiceTestModel testModel)
        {
            var index = _tests.Count - 1;
            if (index >= 0)
            {
                _tests.Insert(index, testModel);
            }
            else
            {
                _tests.Add(testModel);
            }
            SelectedServiceTest = testModel;
            var isDirty = IsDirty;
            SetDisplayName(isDirty);
        }

        bool CanStopTest => SelectedServiceTest != null && SelectedServiceTest.IsTestRunning;
        bool CanRunSelectedTestInBrowser => SelectedServiceTest != null && !SelectedServiceTest.IsDirty && IsServerConnected();
        bool CanRunSelectedTest => GetPermissions() && IsServerConnected();
        bool CanDuplicateTest => GetPermissions() && SelectedServiceTest != null && !SelectedServiceTest.NewTest;

        public bool CanSave { get; set; }

        bool IsResourceDeleted { get; set; }

        static bool GetPermissions() => true;

        bool IsValidName()
        {
            if (SelectedServiceTest != null)
            {
                var name = SelectedServiceTest.TestName;
                ErrorMessage = string.Empty;
                if (string.IsNullOrEmpty(name))
                {
                    ErrorMessage = string.Format(ErrorResource.CannotBeNull, "'name'");
                }
                else if (NameHasInvalidCharacters(name))
                {
                    ErrorMessage = string.Format(ErrorResource.ContainsInvalidCharecters, "'name'");
                }
                else
                {
                    if (name.Trim() != name)
                    {
                        ErrorMessage = string.Format(ErrorResource.ContainsLeadingOrTrailingWhitespace, "'name'");
                    }
                }

                return string.IsNullOrEmpty(ErrorMessage);
            }
            return true;
        }

        bool AllNamesValid(IEnumerable<string> testNames)
        {
            foreach (var name in testNames)
            {
                ErrorMessage = string.Empty;
                if (string.IsNullOrEmpty(name))
                {
                    ErrorMessage = string.Format(ErrorResource.CannotBeNull, "'name'");
                    var popupController = CustomContainer.Get<IPopupController>();
                    popupController?.Show(Resources.Languages.Core.ServiceTestEmptyTestNameHeader, "Empty Test Name"
                        , MessageBoxButton.OK, MessageBoxImage.Error, null,
                        false, true, false, false, false, false);
                    return false;
                }
                else if (NameHasInvalidCharacters(name))
                {
                    ErrorMessage = string.Format(ErrorResource.ContainsInvalidCharecters, "'name'");
                    return false;
                }
                else if (name.Trim() != name)
                {
                    ErrorMessage = string.Format(ErrorResource.ContainsLeadingOrTrailingWhitespace, "'name'");
                    return false;
                }
                else
                {
                    continue;
                }
            }
            return true;
        }
        static bool NameHasInvalidCharacters(string name) => Regex.IsMatch(name, @"[^a-zA-Z0-9._\s-]");

        public string ErrorMessage
        {
            get => _errorMessage;
            set
            {
                _errorMessage = value;
                OnPropertyChanged(() => ErrorMessage);
            }
        }

        public IWorkflowDesignerViewModel WorkflowDesignerViewModel
        {
            get => _workflowDesignerViewModel;
            set
            {
                _workflowDesignerViewModel = value;
                OnPropertyChanged(() => WorkflowDesignerViewModel);
            }
        }

        public bool IsDirty
        {
            get
            {
                try
                {
                    if (_tests == null || _tests.Count <= 1)
                    {
                        return false;
                    }
                    var isDirty = _tests.Any(resource => resource.IsDirty || resource.NewTest);

                    var isConnected = ResourceModel.Environment.Connection.IsConnected;
                    _dirty = isDirty && isConnected;
                    _isValid = IsValidName();
                    CanSave = _isValid && _dirty;
                    SetDisplayName(_dirty);
                    return _dirty;
                }
                catch (Exception)
                {
                    return false;
                }
            }
        }

        public Guid ResourceID => ResourceModel?.ID ?? Guid.Empty;

        public void Save()
        {
            try
            {
                if (ShowPopupWhenDuplicates())
                {
                    return;
                }

                var serviceTestModels = RealTests().Where(a => a.IsDirty).ToList();
                Save(serviceTestModels);
                UpdateTestsFromResourceUpdate();
            }
            catch (Exception ex)
            {
                Dev2Logger.Error("Service test save error.", ex, GlobalConstants.WarewolfError);
            }
            finally
            {
                var isDirty = IsDirty;
                SetDisplayName(isDirty);
            }
        }

        void Save(List<IServiceTestModel> serviceTestModels)
        {
            if (!AllNamesValid(Tests.Select(p => p.TestName).ToList()))
            {
                return;
            }
            MarkPending(serviceTestModels);
            var serviceTestModelTos = serviceTestModels.Select(CreateServiceTestModelTo).ToList();

            var result = ResourceModel.Environment.ResourceRepository.SaveTests(ResourceModel, serviceTestModelTos);
            switch (result.Result)
            {
                case SaveResult.Success:
                    MarkTestsAsNotNew();
                    SetSelectedTestUrl();
                    break;
                case SaveResult.ResourceDeleted:
                    PopupController?.Show(Resources.Languages.Core.ServiceTestResourceDeletedMessage, Resources.Languages.Core.ServiceTestResourceDeletedHeader, MessageBoxButton.OK, MessageBoxImage.Error, null, false, true, false, false, false, false);
                    _shellViewModel.CloseResourceTestView(ResourceModel.ID, ResourceModel.ServerID, ResourceModel.Environment.EnvironmentID);
                    IsResourceDeleted = true;
                    break;
                case SaveResult.ResourceUpdated:
                    UpdateTestsFromResourceUpdate();
                    break;
                default:
                    throw new ArgumentOutOfRangeException();
            }
        }

        static void MarkPending(List<IServiceTestModel> serviceTestModels)
        {
            foreach (var serviceTestModel in serviceTestModels)
            {
                serviceTestModel.TestPending = true;
                if (serviceTestModel.TestSteps != null)
                {
                    MarkTestStepsPending(serviceTestModel);
                }

                if (serviceTestModel.Outputs == null)
                {
                    continue;
                }

                foreach (var testOutput in serviceTestModel.Outputs.OfType<ServiceTestOutput>())
                {
                    testOutput.TestPending = true;
                    if (testOutput.Result != null)
                    {
                        testOutput.Result.RunTestResult = RunResult.TestPending;
                    }
                }
            }
        }

        static void MarkTestStepsPending(IServiceTestModel serviceTestModel)
        {
            foreach (var serviceTestStep in serviceTestModel.TestSteps)
            {
                MarkChildrenPending(serviceTestStep);
                if (serviceTestStep.Children == null)
                {
                    continue;
                }

                var testSteps = serviceTestStep.Children.Flatten(step => step.Children);
                foreach (var testStep in testSteps)
                {
                    MarkChildrenPending(testStep);
                }
            }
        }

        static void MarkChildrenPending(IServiceTestStep serviceTestStep)
        {
            if (serviceTestStep is ServiceTestStep step)
            {
                step.TestPending = true;
                if (step.Result != null)
                {
                    step.Result.RunTestResult = RunResult.TestPending;
                }

                if (step.StepOutputs == null)
                {
                    return;
                }
                MarkStepOutputsPending(step);
            }
        }

        static void MarkStepOutputsPending(IServiceTestStep step)
        {
            foreach (var serviceTestOutput in step.StepOutputs)
            {
                if (serviceTestOutput is ServiceTestOutput stepOutput)
                {
                    stepOutput.TestPending = true;
                    if (stepOutput.Result != null)
                    {
                        stepOutput.Result.RunTestResult = RunResult.TestPending;
                    }
                }
            }
        }

        static IServiceTestModelTO CreateServiceTestModelTo(IServiceTestModel model) => new ServiceTestModelTO
        {
            TestName = model.TestName,
            ResourceId = model.ParentId,
            AuthenticationType = model.AuthenticationType,
            Enabled = model.Enabled,
            ErrorExpected = model.ErrorExpected,
            NoErrorExpected = model.NoErrorExpected,
            ErrorContainsText = model.ErrorContainsText,
            TestSteps = model.TestSteps?.Select(step => CreateServiceTestStepTo(step, null)).ToList() ?? new List<IServiceTestStep>(),
            Inputs = model.Inputs?.Select(CreateServiceTestInputsTo).ToList() ?? new List<IServiceTestInput>(),
            Outputs = model.Outputs?.Select(CreateServiceTestOutputTo).ToList() ?? new List<IServiceTestOutput>(),
            LastRunDate = model.LastRunDate,
            OldTestName = model.OldTestName,
            Password = model.Password,
            IsDirty = model.IsDirty,
            TestPending = model.TestPending,
            UserName = model.UserName,
            TestFailing = model.TestFailing,
            TestInvalid = model.TestInvalid,
            TestPassed = model.TestPassed
        };

        static IServiceTestOutput CreateServiceTestOutputTo(IServiceTestOutput output) => new ServiceTestOutputTO
        {
            Variable = output.Variable,
            Value = output.Value,
            From = output.From,
            To = output.To,
            AssertOp = output.AssertOp,
            HasOptionsForValue = output.HasOptionsForValue,
            OptionsForValue = output.OptionsForValue
        };

        static IServiceTestInput CreateServiceTestInputsTo(IServiceTestInput input) => new ServiceTestInputTO
        {
            Variable = input.Variable,
            Value = input.Value,
            EmptyIsNull = input.EmptyIsNull
        };

        static IServiceTestStep CreateServiceTestStepTo(IServiceTestStep step, IServiceTestStep parent)
        {
            var serviceTestStepTo = new ServiceTestStepTO(step.ActivityID, step.ActivityType, step.StepOutputs.Select(CreateServiceTestStepOutputsTo).ToObservableCollection(), step.Type)
            {
                Children = new ObservableCollection<IServiceTestStep>(),
                Parent = parent,
                StepDescription = step.StepDescription
            };
            if (step.Children != null)
            {
                foreach (var serviceTestStep in step.Children)
                {
                    serviceTestStepTo.Children.Add(CreateServiceTestStepTo(serviceTestStep, serviceTestStepTo));
                }
            }
            return serviceTestStepTo;
        }

        static IServiceTestOutput CreateServiceTestStepOutputsTo(IServiceTestOutput output) => new ServiceTestOutputTO
        {
            Variable = output.Variable,
            Value = output.Value,
            From = output.From,
            To = output.To,
            AssertOp = output.AssertOp,
            HasOptionsForValue = output.HasOptionsForValue,
            OptionsForValue = output.OptionsForValue
        };

        void UpdateTestsFromResourceUpdate()
        {
            foreach (var serviceTestModel in Tests)
            {
                var runSelectedTestUrl = GetWebRunUrlForTest(serviceTestModel);
                serviceTestModel.RunSelectedTestUrl = runSelectedTestUrl;
            }
        }

        string GetWebRunUrlForTest(IServiceTestModel serviceTestModel)
        {
            var runSelectedTestUrl = ResourceModel.GetWorkflowUri("", UrlType.Tests) + "/" + serviceTestModel.TestName;
            if (serviceTestModel.AuthenticationType == AuthenticationType.Public)
            {
                runSelectedTestUrl = runSelectedTestUrl.Replace("/secure/", "/public/");
            }
            return runSelectedTestUrl;
        }

        bool ShowPopupWhenDuplicates()
        {
            if (HasDuplicates())
            {
                ShowDuplicatePopup();
                return true;
            }
            return false;
        }

        public void ShowDuplicatePopup()
        {
            PopupController?.Show(Resources.Languages.Core.ServiceTestDuplicateTestNameMessage, Resources.Languages.Core.ServiceTestDuplicateTestNameHeader, MessageBoxButton.OK, MessageBoxImage.Error, null, false, true, false, false, false, false);
        }

        public void RefreshCommands()
        {
            ViewModelUtils.RaiseCanExecuteChanged(RunAllTestsCommand);
            ViewModelUtils.RaiseCanExecuteChanged(RunAllTestsInBrowserCommand);
            ViewModelUtils.RaiseCanExecuteChanged(RunSelectedTestCommand);
            ViewModelUtils.RaiseCanExecuteChanged(RunSelectedTestInBrowserCommand);
            _dirty = IsDirty;
            OnPropertyChanged(() => IsDirty);
            OnPropertyChanged(() => DisplayName);
            SetDisplayName(_dirty);
        }

        public bool HasDuplicates() => RealTests().ToList().GroupBy(x => x.TestName).Where(group => @group.Count() > 1).Select(group => @group.Key).Any();

        void SetSelectedTestUrl()
        {
            var runSelectedTestUrl = GetWebRunUrlForTest(SelectedServiceTest);
            SelectedServiceTest.RunSelectedTestUrl = runSelectedTestUrl;
        }

        void MarkTestsAsNotNew()
        {
            foreach (var model in _tests.Where(model => model.NewTest))
            {
                model.NewTest = false;
            }
            foreach (var model in RealTests())
            {
                var clone = model.Clone();
                model.SetItem(clone);
                model.ResetOldTestName();
            }
        }

        public IContextualResourceModel ResourceModel
        {
            get => _resourceModel;
            private set => _resourceModel = value;
        }

        public IServiceTestModel SelectedServiceTest
        {
            get => _selectedServiceTest;
            set
            {
                if (value == null)
                {
                    if (_selectedServiceTest != null)
                    {
                        _selectedServiceTest.PropertyChanged -= ActionsForPropChanges;
                    }

                    _selectedServiceTest = null;
                    EventPublisher.Publish(new DebugOutputMessage(new List<IDebugState>()));
                    OnPropertyChanged(() => SelectedServiceTest);
                    return;
                }
                if (Equals(_selectedServiceTest, value) || value.IsNewTest)
                {
                    return;
                }
                if (_selectedServiceTest != null)
                {
                    _selectedServiceTest.PropertyChanged -= ActionsForPropChanges;
                }

                _selectedServiceTest = value;
                _selectedServiceTest.IsTestLoading = true;
                _selectedServiceTest.PropertyChanged += ActionsForPropChanges;

                var serviceTestSteps = _selectedServiceTest?.TestSteps?.Flatten(step => step.Children ?? new ObservableCollection<IServiceTestStep>());
                if (serviceTestSteps != null)
                {
                    foreach (var serviceTestOutput in serviceTestSteps.Where(serviceTestStep => serviceTestStep?.StepOutputs != null).SelectMany(serviceTestStep => serviceTestStep.StepOutputs))
                    {
                        ((ServiceTestOutput)serviceTestOutput).PropertyChanged += OnStepOutputPropertyChanges;
                    }
                }
                SetSelectedTestUrl();
                SetDuplicateTestTooltip();
                OnPropertyChanged(() => SelectedServiceTest);
                EventPublisher.Publish(new DebugOutputMessage(_selectedServiceTest?.DebugForTest ?? new List<IDebugState>()));
                if (_selectedServiceTest != null)
                {
                    _selectedServiceTest.IsTestLoading = false;
                }
            }
        }

        void OnStepOutputPropertyChanges(object sender, PropertyChangedEventArgs e)
        {
            ViewModelUtils.RaiseCanExecuteChanged(RunSelectedTestInBrowserCommand);
            _dirty = IsDirty;
            OnPropertyChanged(() => IsDirty);
        }

        void ActionsForPropChanges(object sender, PropertyChangedEventArgs e)
        {
            if (e.PropertyName == "Enabled")
            {
                ViewModelUtils.RaiseCanExecuteChanged(DeleteTestCommand);
            }
            if (e.PropertyName == "IsDirty")
            {
                ViewModelUtils.RaiseCanExecuteChanged(RunSelectedTestInBrowserCommand);
                _dirty = IsDirty;
                OnPropertyChanged(() => IsDirty);
            }
            if (e.PropertyName == "Inputs" || e.PropertyName == "Outputs")
            {
                ViewModelUtils.RaiseCanExecuteChanged(RunSelectedTestInBrowserCommand);
            }
            if (e.PropertyName == "RunSelectedTestUrl")
            {
                ViewModelUtils.RaiseCanExecuteChanged(RunSelectedTestInBrowserCommand);
            }
            if (e.PropertyName == "DebugForTest")
            {
                EventPublisher.Publish(new DebugOutputMessage(SelectedServiceTest?.DebugForTest ?? new List<IDebugState>()));
            }
            if (e.PropertyName == "TestName")
            {
                _dirty = IsDirty;
                OnPropertyChanged(() => IsDirty);
            }
            ViewModelUtils.RaiseCanExecuteChanged(DuplicateTestCommand);
        }

        void SetDisplayName(bool isDirty)
        {
            if (isDirty)
            {
                if (!DisplayName.EndsWith(" *"))
                {
                    DisplayName += " *";
                }
            }
            else
            {
                DisplayName = _displayName.Replace("*", "").TrimEnd(' ');
            }
        }

        public IServiceTestCommandHandler ServiceTestCommandHandler { get; set; }

        public string RunAllTestsUrl
        {
            get => _runAllTestsUrl;
            set
            {
                _runAllTestsUrl = value;
                OnPropertyChanged(() => RunAllTestsUrl);
            }
        }

        public string RunAllCoverageUrl
        {
            get => _runAllCoverageUrl;
            set
            {
                _runAllCoverageUrl = value;
                OnPropertyChanged(() => RunAllCoverageUrl);
            }
        }

        public string TestPassingResult
        {
            get => _testPassingResult;
            set
            {
                _testPassingResult = value;
                OnPropertyChanged(() => TestPassingResult);
            }
        }

        IEnumerable<IServiceTestModel> RealTests() => _tests.Where(model => model.GetType() != typeof(DummyServiceTest)).ToObservableCollection();

        public ObservableCollection<IServiceTestModel> Tests
        {
            get => _tests;
            set
            {
                _tests = value;
                OnPropertyChanged(() => Tests);
            }
        }

        void DeleteTest(IServiceTestModel test)
        {
            if (test == null)
            {
                return;
            }

            var nameOfItemBeingDeleted = test.NameForDisplay.Replace("*", "").TrimEnd(' ');
            if (PopupController.ShowDeleteConfirmation(nameOfItemBeingDeleted) == MessageBoxResult.Yes)
            {
                try
                {
                    if (!test.IsNewTest)
                    {
                        ResourceModel.Environment.ResourceRepository.DeleteResourceTest(ResourceModel.ID, test.TestName);
                    }
                    _tests.Remove(test);
                    OnPropertyChanged(() => Tests);
                    SelectedServiceTest = null;
                    if (Tests.Count == 1 && Tests.Single().GetType() == typeof(DummyServiceTest))
                    {
                        CanSave = false;
                    }
                }
                catch (Exception ex)
                {
                    Dev2Logger.Error("IServiceTestModelTO DeleteTest(IServiceTestModel model)", ex, GlobalConstants.WarewolfError);
                }
            }
            if (_tests.Count == 1 && _tests.Single().GetType() == typeof(DummyServiceTest))
            {
                CanSave = false;
            }
        }

        void DeleteTestStep(IServiceTestStep testStep)
        {
            if (testStep == null)
            {
                return;
            }

            DeleteStep(testStep, SelectedServiceTest.TestSteps);
        }

        static void DeleteStep(IServiceTestStep testStep, ObservableCollection<IServiceTestStep> serviceTestSteps)
        {
            if (serviceTestSteps.Contains(testStep))
            {
                serviceTestSteps.Remove(testStep);
            }
            else
            {
                var foundParentStep = serviceTestSteps.FirstOrDefault(step => step.ActivityID == testStep.Parent?.ActivityID);
                foundParentStep?.Children?.Remove(testStep);
            }
        }

        ObservableCollection<IServiceTestModel> GetTests()
        {
            try
            {
                var serviceTestModels = new List<ServiceTestModel>();
                var loadResourceTests = ResourceModel.Environment.ResourceRepository.LoadResourceTests(ResourceModel.ID);
                if (loadResourceTests != null)
                {
                    foreach (var test in loadResourceTests)
                    {
                        var serviceTestModel = ToServiceTestModel(test);
                        serviceTestModel.Item = (ServiceTestModel)serviceTestModel.Clone();
                        serviceTestModels.Add(serviceTestModel);
                    }
                }
                return serviceTestModels.ToObservableCollection<IServiceTestModel>();
            }
            catch (Exception)
            {
                return new ObservableCollection<IServiceTestModel>();
            }
        }

        public ServiceTestModel ToServiceTestModel(IServiceTestModelTO to)
        {
            var serviceTestModel = new ServiceTestModel(ResourceModel.ID)
            {
                OldTestName = to.TestName,
                TestName = to.TestName,
                IsTestRunning = false,
                NameForDisplay = to.TestName,
                UserName = to.UserName,
                AuthenticationType = to.AuthenticationType,
                Enabled = to.Enabled,
                ErrorExpected = to.ErrorExpected,
                NoErrorExpected = to.NoErrorExpected,
                ErrorContainsText = to.ErrorContainsText,
                LastRunDate = to.LastRunDate,
                TestInvalid = to.TestInvalid,
                TestPending = to.TestPending,
                TestFailing = to.TestFailing,
                TestPassed = to.TestPassed,
                Password = to.Password,
                ParentId = to.ResourceId,
                TestSteps = to.TestSteps?.Select(step => CreateServiceTestStep(step) as IServiceTestStep).ToObservableCollection(),
                Inputs = to.Inputs?.Select(CreateInput).ToObservableCollection(),
                Outputs = to.Outputs?.Select(CreateOutput).ToObservableCollection()
            };
            return serviceTestModel;
        }

        static IServiceTestOutput CreateOutput(IServiceTestOutput output)
        {
            var serviceTestOutput = new ServiceTestOutput(output.Variable, output.Value, output.From, output.To) as IServiceTestOutput;
            serviceTestOutput.AssertOp = output.AssertOp;
            serviceTestOutput.Result = output.Result;
            return serviceTestOutput;
        }

        static IServiceTestInput CreateInput(IServiceTestInput input)
        {
            var serviceTestInput = new ServiceTestInput(input.Variable, input.Value) as IServiceTestInput;
            serviceTestInput.EmptyIsNull = input.EmptyIsNull;
            return serviceTestInput;
        }

        IServiceTestStep CreateServiceTestStep(IServiceTestStep step)
        {
            var testStep = new ServiceTestStep(step.ActivityID, step.ActivityType, new ObservableCollection<IServiceTestOutput>(), step.Type)
            {
                Children = new ObservableCollection<IServiceTestStep>(),
                Parent = step.Parent,
                StepDescription = step.StepDescription,
                Result = step.Result
            };
            testStep.StepOutputs = CreateServiceTestOutputFromStep(step.StepOutputs, testStep);
            if (testStep.MockSelected)
            {
                testStep.TestPending = false;
                testStep.TestPassed = false;
                testStep.TestFailing = false;
                testStep.TestInvalid = false;
            }
            SetStepIcon(testStep.ActivityType, testStep);

            if (step.Children != null)
            {
                foreach (var serviceTestStep in step.Children)
                {
                    testStep.Children.Add(CreateServiceTestStep(serviceTestStep));
                }
            }
            return testStep;
        }

        static ObservableCollection<IServiceTestOutput> CreateServiceTestOutputFromStep(ObservableCollection<IServiceTestOutput> stepStepOutputs, IServiceTestStep testStep)
        {
            var stepOutputs = new ObservableCollection<IServiceTestOutput>();
            foreach (var serviceTestOutput in stepStepOutputs)
            {
                var testOutput = new ServiceTestOutput(serviceTestOutput.Variable, serviceTestOutput.Value, serviceTestOutput.From, serviceTestOutput.To)
                {
                    AddStepOutputRow = testStep.AddNewOutput,
                    AssertOp = serviceTestOutput.AssertOp,
                    HasOptionsForValue = serviceTestOutput.HasOptionsForValue,
                    OptionsForValue = serviceTestOutput.OptionsForValue,
                    Result = serviceTestOutput.Result
                };
                if (testStep.MockSelected)
                {
                    testOutput.TestPending = false;
                    testOutput.TestPassed = false;
                    testOutput.TestFailing = false;
                    testOutput.TestInvalid = false;
                }

                stepOutputs.Add(testOutput);
            }
            return stepOutputs;
        }

        public ICommand DeleteTestCommand { get; set; }
        public ICommand DeleteTestStepCommand { get; set; }
        public ICommand DuplicateTestCommand { get; set; }
        public ICommand RunAllTestsInBrowserCommand { get; set; }
        public ICommand RunAllTestCoverageInBrowserCommand { get; set; }
        public ICommand RunAllTestsCommand { get; set; }
        public ICommand RunSelectedTestInBrowserCommand { get; set; }
        public ICommand RunSelectedTestCommand { get; set; }
        public ICommand StopTestCommand { get; set; }
        public ICommand CreateTestCommand { get; set; }

        public string DisplayName
        {
            get => _displayName;
            set
            {
                _displayName = value;
                OnPropertyChanged(() => DisplayName);
            }
        }

        public void Dispose()
        {
            if (ResourceModel?.Environment?.Connection != null)
            {
                ResourceModel.Environment.Connection.ReceivedResourceAffectedMessage -= OnReceivedResourceAffectedMessage;
            }
        }

        public void UpdateHelpDescriptor(string helpText)
        {
            var mainViewModel = CustomContainer.Get<IShellViewModel>();
            mainViewModel?.HelpViewModel?.UpdateHelpText(helpText);
        }
    }
}

---- Transformed Tree ----
using System;
using System.Activities;
using System.Activities.Presentation.Model;
using System.Activities.Statements;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.ComponentModel;
using System.Linq;
using System.Reflection;
using System.Text.RegularExpressions;
using System.Windows;
using System.Windows.Input;
using System.Windows.Media;
using Caliburn.Micro;
using Dev2;
using Dev2.Activities;
using Dev2.Activities.SelectAndApply;
using Dev2.Common;
using Dev2.Common.Common;
using Dev2.Common.Interfaces;
using Dev2.Common.Interfaces.Diagnostics.Debug;
using Dev2.Common.Interfaces.Studio.Controller;
using Dev2.Common.Interfaces.Threading;
using Dev2.Common.Interfaces.Toolbox;
using Dev2.Communication;
using Dev2.Data;
using Dev2.Data.ServiceModel.Messages;
using Dev2.Data.SystemTemplates.Models;
using Dev2.Runtime.ServiceModel.Data;
using Dev2.Studio.Core;
using Dev2.Studio.Core.Activities.Utils;
using Dev2.Studio.Core.Messages;
using Dev2.Studio.Core.Network;
using Dev2.Studio.Interfaces;
using Microsoft.Practices.Prism.Commands;
using Microsoft.Practices.Prism.Mvvm;
using Unlimited.Applications.BusinessDesignStudio.Activities;
using Warewolf.Core;
using Warewolf.Resource.Errors;

namespace Warewolf.Studio.ViewModels
{
    public class ServiceTestViewModel : BindableBase, IServiceTestViewModel
    {
        readonly IExternalProcessExecutor _processExecutor;
        private IServiceTestModel _selectedServiceTest;
        private string _runAllTestsUrl;
        private string _runAllCoverageUrl;
        private string _testPassingResult;
        ObservableCollection<IServiceTestModel> _tests;
        private string _displayName;
        public IPopupController PopupController { get; }
        private string _errorMessage;
        private readonly IShellViewModel _shellViewModel;
        IContextualResourceModel _resourceModel;
        private string _serverName;
        private IWorkflowDesignerViewModel _workflowDesignerViewModel;
        readonly IEnumerable<Type> _types;
        
        public ServiceTestViewModel(IContextualResourceModel resourceModel, IAsyncWorker asyncWorker, IEventAggregator eventPublisher, IExternalProcessExecutor processExecutor, IWorkflowDesignerViewModel workflowDesignerViewModel, IPopupController popupController, IMessage msg, IEnumerable<Type> currentDomainTypes)
            : this(resourceModel, asyncWorker, eventPublisher, processExecutor, workflowDesignerViewModel, popupController)
        {
            _types = currentDomainTypes;
            PrePopulateTestsUsingDebugAsync(msg);
        }
        
        public ServiceTestViewModel(IContextualResourceModel resourceModel, IAsyncWorker asyncWorker, IEventAggregator eventPublisher, IExternalProcessExecutor processExecutor, IWorkflowDesignerViewModel workflowDesignerViewModel, IPopupController popupController, IMessage msg)
            : this(resourceModel, asyncWorker, eventPublisher, processExecutor, workflowDesignerViewModel, popupController)
        {
            _types = AppDomain.CurrentDomain.GetAssemblies().SelectMany(x => x.GetTypes());
            PrePopulateTestsUsingDebugAsync(msg);
        }

        public ServiceTestViewModel(IContextualResourceModel resourceModel, IAsyncWorker asyncWorker, IEventAggregator eventPublisher, IExternalProcessExecutor processExecutor, IWorkflowDesignerViewModel workflowDesignerViewModel, IPopupController popupController)
        {
            _processExecutor = processExecutor;
            AsyncWorker = asyncWorker;
            EventPublisher = eventPublisher;
            ResourceModel = resourceModel ?? throw new ArgumentNullException(nameof(resourceModel));
            ResourceModel.Environment.IsConnectedChanged += (sender, args) =>
            {
                ViewModelUtils.RaiseCanExecuteChanged(DeleteTestCommand);
                RefreshCommands();
            };

            ResourceModel.Environment.Connection.ReceivedResourceAffectedMessage += OnReceivedResourceAffectedMessage;
            SetServerName(resourceModel);
            DisplayName = resourceModel.DisplayName + " - Tests" + _serverName;

            ServiceTestCommandHandler = new ServiceTestCommandHandlerModel();
            PopupController = popupController;
            _shellViewModel = CustomContainer.Get<IShellViewModel>();
            RunAllTestsInBrowserCommand = new DelegateCommand(RunAllTestsInBrowser, IsServerConnected);
            RunAllTestCoverageInBrowserCommand = new DelegateCommand(RunAllCoverageInBrowser, IsServerConnected);
            RunAllTestsCommand = new DelegateCommand(RunAllTests, IsServerConnected);
            RunSelectedTestInBrowserCommand = new DelegateCommand(RunSelectedTestInBrowser, () => CanRunSelectedTestInBrowser);
            RunSelectedTestCommand = new DelegateCommand(RunSelectedTest, () => CanRunSelectedTest);
            StopTestCommand = new DelegateCommand(StopTest, () => CanStopTest);
            CreateTestCommand = new DelegateCommand(() => CreateTests());
            DeleteTestCommand = new DelegateCommand<IServiceTestModel>(DeleteTest, CanDeleteTest);
            DeleteTestStepCommand = new DelegateCommand<IServiceTestStep>(DeleteTestStep);
            DuplicateTestCommand = new DelegateCommand(DuplicateTest, () => CanDuplicateTest);
            RunAllTestsUrl = resourceModel.GetWorkflowUri("", UrlType.Tests)?.ToString();
            RunAllCoverageUrl = resourceModel.GetWorkflowUri("", UrlType.Coverage)?.ToString();

            UpdateHelpDescriptor(Resources.Languages.HelpText.ServiceTestGenericHelpText);

            WorkflowDesignerViewModel = workflowDesignerViewModel;
            WorkflowDesignerViewModel.IsTestView = true;
            WorkflowDesignerViewModel.ItemSelectedAction = ItemSelectedAction;
            IsLoading = true;
            if (Tests == null)
            {
                PrePopulateTestsUsingDebugAsync(null);
            }
        }

        public bool IsLoading
        {
            get => _isLoading;
            set
            {
                _isLoading = value;
                OnPropertyChanged(() => IsLoading);
            }
        }

        private void PrePopulateTestsUsingDebugAsync(IMessage msg)
        {
            AsyncWorker.Start(GetTests, models =>
            {
                var dummyTest = new DummyServiceTest(CreateTests) {TestName = "Create a new test."};
                models.Add(dummyTest);
                SelectedServiceTest = dummyTest;
                Tests = models;
                if (msg != null)
                {
                    if (msg is NewTestFromDebugMessage test)
                    {
                        var newTest = test;
                        if (newTest.RootItems == null)
                        {
                            throw new ArgumentNullException(nameof(newTest.RootItems));
                        }

                        PrePopulateTestsUsingDebug(newTest.RootItems);
                    }
                    else
                    {
                        throw new ArgumentException("expected " + nameof(NewTestFromDebugMessage) + " but got " +
                                                    msg.GetType().Name);
                    }
                }

                IsLoading = false;
            }, OnError);
        }

        public void PrePopulateTestsUsingDebug(List<IDebugTreeViewItemViewModel> models)
        {
            CreateTests(true);
            if (_canAddFromDebug)
            {
                WorkflowDesignerViewModel?.UpdateWorkflowInputDataViewModel(ResourceModel);
                AddFromDebug(models);
            }
        }

        private void AddFromDebug(IEnumerable<IDebugTreeViewItemViewModel> models)
        {
            foreach (var debugState in models)
            {
                if (debugState is DebugStateTreeViewItemViewModel debugItem && debugItem.Parent == null)
                {
                    if (debugItem.Content == null)
                    {
                        continue;
                    }
                    ValidateAddStepType(debugState, debugItem.Content);
                }
            }
        }

        void ValidateAddStepType(IDebugTreeViewItemViewModel debugState, IDebugState debugItemContent)
        {
            if (debugItemContent.ActivityType == ActivityType.Workflow && debugItemContent.OriginatingResourceID == ResourceModel.ID)
            {
                ProcessInputsAndOutputs(debugItemContent);
                UpdateInputValues(debugItemContent);
            }
            else if (debugItemContent.ActivityType == ActivityType.Workflow && debugItemContent.ActualType == nameof(DsfActivity))
            {
                AddStepFromDebug(debugState, debugItemContent);
            }
            else
            {
                if (debugItemContent.ActivityType != ActivityType.Workflow && debugItemContent.ActualType != nameof(DsfCommentActivity))
                {
                    ProcessRegularDebugItem(debugItemContent, debugState);
                }
            }
        }

        private void UpdateInputValues(IDebugState debugItemContent)
        {
            foreach (var item in debugItemContent.Inputs)
            {
                foreach (var res in item?.ResultsList)
                {
                    var variable = res?.Variable?.Replace("[[", "");
                    variable = variable?.Replace("]]", "");
                    var inputsValue = WorkflowDesignerViewModel?.GetWorkflowInputs(variable);
                    if (res != null)
                    {
                        res.Value = inputsValue;
                    }
                }
            }
        }

        private void ProcessRegularDebugItem(IDebugState debugItemContent, IDebugTreeViewItemViewModel debugState)
        {
            var actualType = debugItemContent.ActualType;
            if (actualType == nameof(DsfDecision) || actualType == nameof(TestMockDecisionStep))
            {
                DecisionFromDebug(debugState, debugItemContent);
            }
            else if (actualType == nameof(DsfSwitch) || actualType == nameof(TestMockSwitchStep))
            {
                SwitchFromDebug(debugState, debugItemContent);
            }
            else if (actualType == nameof(DsfEnhancedDotNetDllActivity))
            {
                EnhancedDotNetDllFromDebug(debugState, debugItemContent);
            }
            else
            {
                AddStepFromDebug(debugState, debugItemContent);
            }
        }

        void EnhancedDotNetDllFromDebug(IDebugTreeViewItemViewModel debugState, IDebugState debugItemContent)
        {
            var exists = FindExistingStep(debugItemContent.ID.ToString());
            IServiceTestStep serviceTestStep = null;
            if (exists == null)
            {
                serviceTestStep = SelectedServiceTest.AddDebugItemTestStep(debugItemContent, new ObservableCollection<IServiceTestOutput>());

                if (serviceTestStep != null)
                {
                    SetStepIcon(serviceTestStep.ActivityType, serviceTestStep);
                }
            }

            if (debugState.Children != null && debugState.Children.Count > 0)
            {
                AddChildren(debugState, serviceTestStep);
            }
        }

        void SwitchFromDebug(IDebugTreeViewItemViewModel itemContent, IDebugState debugItemContent)
        {
            var processFlowSwitch = ProcessFlowSwitch(WorkflowDesignerViewModel.GetModelItem(debugItemContent.WorkSurfaceMappingId, debugItemContent.ParentID.GetValueOrDefault()));
            if (processFlowSwitch != null)
            {
                if (debugItemContent?.Outputs.Count > 0 && debugItemContent.Outputs[0].ResultsList?.Count > 0)
                {
                    processFlowSwitch.StepOutputs[0].Value = debugItemContent.Outputs[0].ResultsList[0].Value;
                }

                var debugStateActivityTypeName = itemContent.ActivityTypeName;
                if (debugStateActivityTypeName == nameof(TestMockSwitchStep))
                {
                    processFlowSwitch.MockSelected = true;
                    processFlowSwitch.AssertSelected = false;
                    processFlowSwitch.StepOutputs[0].Value = debugItemContent.AssertResultList[0].ResultsList[0].Value;
                }
            }
        }

        void DecisionFromDebug(IDebugTreeViewItemViewModel itemContent, IDebugState debugItemContent)
        {
            var processFlowDecision = ProcessFlowDecision(WorkflowDesignerViewModel.GetModelItem(debugItemContent.WorkSurfaceMappingId, debugItemContent.ParentID.GetValueOrDefault()));
            if (processFlowDecision != null)
            {
                if (debugItemContent?.Outputs.Count > 0 && debugItemContent.Outputs[0].ResultsList?.Count > 0)
                {
                    processFlowDecision.StepOutputs[0].Value = debugItemContent.Outputs[0].ResultsList[0].Value;
                }
                var debugStateActivityTypeName = itemContent.ActivityTypeName;
                if (debugStateActivityTypeName == nameof(TestMockDecisionStep))
                {
                    processFlowDecision.MockSelected = true;
                    processFlowDecision.AssertSelected = false;
                    processFlowDecision.StepOutputs[0].Value = debugItemContent.AssertResultList[0].ResultsList[0].Value;
                }
            }
        }

        void ProcessInputsAndOutputs(IDebugState debugItemContent)
        {
            if (debugItemContent.StateType == StateType.Start)
            {
                SetInputs(debugItemContent);
            }
            else
            {
                if (debugItemContent.StateType == StateType.End)
                {
                    SetOutputs(debugItemContent);
                }
            }
        }

        void AddStepFromDebug(IDebugTreeViewItemViewModel debugState, IDebugState debugItemContent)
        {
            if (debugState.Children != null && debugState.Children.Count > 0)
            {
                AddChildDebugItems(debugItemContent, debugState, null);
            }
            else
            {
                var outputs = debugItemContent.Outputs;
                var exists = FindExistingStep(debugItemContent.ID.ToString());
                if (exists == null)
                {
                    var serviceTestStep = SelectedServiceTest.AddDebugItemTestStep(debugItemContent, new ObservableCollection<IServiceTestOutput>());
                    var hasOutputs = outputs?.Select(item => item.ResultsList).All(list => list.Count > 0);
                    var debugStateActivityTypeName = debugState.ActivityTypeName;

                    if (outputs?.Count > 0 && hasOutputs.HasValue && hasOutputs.Value)
                    {
                        AddOutputs(outputs, serviceTestStep);
                    }
                    else
                    {
                        SetStepOutputs(serviceTestStep, debugStateActivityTypeName);
                    }
                    if (serviceTestStep != null)
                    {
                        SetMockTestStep(debugItemContent, serviceTestStep, debugStateActivityTypeName);
                        SetStepIcon(serviceTestStep.ActivityType, serviceTestStep);
                    }
                }
            }
        }

        void SetMockTestStep(IDebugState debugItemContent, IServiceTestStep serviceTestStep, string debugStateActivityTypeName)
        {
            if (debugStateActivityTypeName == nameof(TestMockStep))
            {
                var model = WorkflowDesignerViewModel.GetModelItem(debugItemContent.WorkSurfaceMappingId, debugItemContent.ID);
                var val = model.GetCurrentValue();
                serviceTestStep.MockSelected = true;
                serviceTestStep.AssertSelected = false;
                serviceTestStep.Type = StepType.Mock;
                serviceTestStep.ActivityType = val.GetType().Name;
            }
        }

        void SetStepOutputs(IServiceTestStep serviceTestStep, string debugStateActivityTypeName)
        {
            var type = _types?.FirstOrDefault(x => x.Name == debugStateActivityTypeName);
            if (type == null) return;
            var act = Activator.CreateInstance(type) as IDev2Activity;
            if (serviceTestStep != null)
            {
                serviceTestStep.StepOutputs = AddOutputs(act?.GetOutputs(), serviceTestStep).ToObservableCollection();
            }
        }

        void AddChildDebugItems(IDebugState debugItemContent, IDebugTreeViewItemViewModel debugState, IServiceTestStep parent)
        {
            if (NullParent(debugItemContent, ref parent))
            {
                return;
            }

            if (parent.ActivityType == nameof(DsfForEachActivity))
            {
                ForEachParent(debugItemContent, debugState, parent);
            }
            else if (parent.ActivityType == nameof(GateActivity))
            {
                GateParent(debugItemContent, debugState, parent);
            }
            else if (parent.ActivityType == nameof(SuspendExecutionActivity))
            {
                SuspendExecutionParent(debugItemContent, debugState, parent);
            }
            else if (parent.ActivityType == nameof(DsfSequenceActivity))
            {
                var model = WorkflowDesignerViewModel.GetModelItem(debugItemContent.WorkSurfaceMappingId, debugItemContent.ID);
                if (model?.GetCurrentValue() is DsfSequenceActivity sequence)
                {
                    parent.ActivityID = Guid.Parse(sequence.UniqueID);
                    AddChildren(debugState, parent);
                }
            }
            else
            {
                AddNotContainerActivityType(debugState, parent);
            }
            while (parent != null)
            {
                var child = parent;
                if (child.Parent == null)
                {
                    var exists = FindExistingStep(child.ActivityID.ToString());
                    if (exists == null)
                    {
                        SelectedServiceTest.TestSteps.Add(child);
                    }
                }
                parent = child.Parent;
            }
        }

        void AddNotContainerActivityType(IDebugTreeViewItemViewModel debugState, IServiceTestStep parent)
        {
            if (parent.ActivityType == nameof(DsfActivity))
            {
                if (debugState is DebugStateTreeViewItemViewModel childItem)
                {
                    var content = childItem.Content;
                    var outputs = content.Outputs;
                    AddOutputs(outputs, parent);
                    SetStepIcon(parent.ActivityType, parent);
                }
            }
            else
            {
                AddChildren(debugState, parent);
            }
        }

        void GateParent(IDebugState debugItemContent, IDebugTreeViewItemViewModel debugState, IServiceTestStep parent)
        {
            var model = WorkflowDesignerViewModel?.GetModelItem(debugItemContent.WorkSurfaceMappingId, debugItemContent.ID);
            if (model?.GetCurrentValue() is GateActivity gateActivity && debugState.Children.LastOrDefault() is DebugStateTreeViewItemViewModel childItem)
            {
                if (gateActivity.DataFunc.Handler is IDev2Activity act)
                {
                    var guid = Guid.Parse(act.UniqueID);
                    childItem.Content.ID = guid;
                }

                var childItemContent = childItem.Content;
                var outputs = childItemContent.Outputs;

                var exists = parent.Children.FirstOrDefault(a => a.ActivityID == childItemContent.ID);
                if (exists == null)
                {
                    AddGateChildStep(parent, childItem, act, childItemContent, outputs);
                }
            }
        }

        void AddGateChildStep(IServiceTestStep parent, DebugStateTreeViewItemViewModel childItem, IDev2Activity act, IDebugState childItemContent, List<IDebugItem> outputs)
        {
            var childStep = CreateAssertChildStep(parent, childItemContent, childItemContent.ID);
            if (outputs.Count > 0)
            {
                AddOutputs(outputs, childStep);
            }
            else
            {
                AddOutputs(act?.GetOutputs(), childStep);
            }
            SetStepIcon(childStep.ActivityType, childStep);
            parent.Children.Add(childStep);
            if (childItem.Children?.Count > 0)
            {
                AddChildDebugItems(childItemContent, childItem, childStep);
            }
        }

        void SuspendExecutionParent(IDebugState debugItemContent, IDebugTreeViewItemViewModel debugState, IServiceTestStep parent)
        {
            var model = WorkflowDesignerViewModel?.GetModelItem(debugItemContent.WorkSurfaceMappingId, debugItemContent.ID);
            if (model?.GetCurrentValue() is SuspendExecutionActivity suspendExecutionActivity && debugState.Children.LastOrDefault() is DebugStateTreeViewItemViewModel childItem)
            {
                if (suspendExecutionActivity.SaveDataFunc.Handler is IDev2Activity act)
                {
                    var guid = Guid.Parse(act.UniqueID);
                    childItem.Content.ID = guid;
                }

                var childItemContent = childItem.Content;
                var outputs = childItemContent.Outputs;

                var exists = parent.Children.FirstOrDefault(a => a.ActivityID == childItemContent.ID);
                if (exists == null)
                {
                    AddSuspendExecutionChildStep(parent, childItem, act, childItemContent, outputs);
                }
            }
        }

        void AddSuspendExecutionChildStep(IServiceTestStep parent, IDebugTreeViewItemViewModel childItem, IDev2Activity act, IDebugState childItemContent, List<IDebugItem> outputs)
        {
            var childStep = CreateAssertChildStep(parent, childItemContent, childItemContent.ID);
            if (outputs.Count > 0)
            {
                AddOutputs(outputs, childStep);
            }
            else
            {
                AddOutputs(act?.GetOutputs(), childStep);
            }
            SetStepIcon(childStep.ActivityType, childStep);
            parent.Children.Add(childStep);
            if (childItem.Children?.Count > 0)
            {
                AddChildDebugItems(childItemContent, childItem, childStep);
            }
        }

        void ForEachParent(IDebugState debugItemContent, IDebugTreeViewItemViewModel debugState, IServiceTestStep parent)
        {
            var model = WorkflowDesignerViewModel?.GetModelItem(debugItemContent.WorkSurfaceMappingId, debugItemContent.ID);
            if (model?.GetCurrentValue() is DsfForEachActivity forEach && debugState.Children.LastOrDefault() is DebugStateTreeViewItemViewModel childItem)
            {
                if (forEach.DataFunc.Handler is IDev2Activity act)
                {
                    var guid = Guid.Parse(act.UniqueID);
                    childItem.Content.ID = guid;
                }

                var childItemContent = childItem.Content;
                var outputs = childItemContent.Outputs;

                var exists = parent.Children.FirstOrDefault(a => a.ActivityID == childItemContent.ID);
                if (exists == null)
                {
                    AddForEachChildStep(parent, childItem, act, childItemContent, outputs);
                }
            }
        }

        void AddForEachChildStep(IServiceTestStep parent, DebugStateTreeViewItemViewModel childItem, IDev2Activity act, IDebugState childItemContent, List<IDebugItem> outputs)
        {
            var childStep = CreateAssertChildStep(parent, childItemContent, childItemContent.ID);
            if (outputs.Count > 0)
            {
                AddOutputs(outputs, childStep);
            }
            else
            {
                AddOutputs(act?.GetOutputs(), childStep);
            }
            SetStepIcon(childStep.ActivityType, childStep);
            parent.Children.Add(childStep);
            if (childItem.Children?.Count > 0)
            {
                AddChildDebugItems(childItemContent, childItem, childStep);
            }
        }

        static IServiceTestStep CreateAssertChildStep(IServiceTestStep parent, IDebugState childItemContent, Guid childItemContentId)
        {
            var serviceTestOutputs = new ObservableCollection<IServiceTestOutput>();
            var childStep = new ServiceTestStep(childItemContentId, childItemContent.ActualType, serviceTestOutputs, StepType.Assert)
            {
                StepDescription = childItemContent.DisplayName,
                Parent = parent,
                Type = StepType.Assert
            };
            return childStep;
        }

        bool NullParent(IDebugState debugItemContent, ref IServiceTestStep parent)
        {
            if (parent == null)
            {
                var testStep = new ServiceTestStep(debugItemContent.ID, "", new ObservableCollection<IServiceTestOutput>(), StepType.Assert)
                {
                    StepDescription = debugItemContent.DisplayName,
                    Parent = null
                };

                var seqTypeName = nameof(DsfSequenceActivity);
                var forEachTypeName = nameof(DsfForEachActivity);
                var selectApplyTypeName = nameof(DsfSelectAndApplyActivity);
                var suspendTypeName = nameof(SuspendExecutionActivity);
                var serviceName = nameof(DsfActivity);
                var actualType = debugItemContent.ActualType;
                if (actualType == seqTypeName)
                {
                    SetStepIcon(typeof(DsfSequenceActivity), testStep);
                    testStep.ActivityType = seqTypeName;
                    testStep.ActivityID = debugItemContent.WorkSurfaceMappingId;
                    parent = testStep;
                }
                else if (actualType == forEachTypeName)
                {
                    SetStepIcon(typeof(DsfForEachActivity), testStep);
                    testStep.ActivityType = forEachTypeName;
                    testStep.ActivityID = debugItemContent.WorkSurfaceMappingId;
                    parent = testStep;
                }
                else if (actualType == selectApplyTypeName)
                {
                    SetStepIcon(typeof(DsfSelectAndApplyActivity), testStep);
                    testStep.ActivityType = selectApplyTypeName;
                    testStep.ActivityID = debugItemContent.WorkSurfaceMappingId;
                    parent = testStep;
                }
                else if (actualType == suspendTypeName)
                {
                    SetStepIcon(typeof(SuspendExecutionActivity), testStep);
                    testStep.ActivityType = selectApplyTypeName;
                    testStep.ActivityID = debugItemContent.WorkSurfaceMappingId;
                    parent = testStep;
                }
                else if (actualType == serviceName)
                {
                    SetStepIcon(typeof(DsfActivity), testStep);
                    testStep.ActivityType = serviceName;
                    parent = testStep;
                }
                else
                {
                    return true;
                }
            }
            return false;
        }

        void AddChildren(IDebugTreeViewItemViewModel debugState, IServiceTestStep parent)
        {
            foreach (var debugTreeViewItemViewModel in debugState.Children)
            {
                if (debugTreeViewItemViewModel is DebugStateTreeViewItemViewModel childItem && childItem.ActivityTypeName != "DsfSelectAndApplyActivity")
                {
                    var childItemContent = childItem.Content;
                    var outputs = childItemContent.Outputs;

                    var contentId = childItemContent.ID;
                    if (childItemContent.ActualType == "DsfActivity")
                    {
                        contentId = childItemContent.WorkSurfaceMappingId;
                    }

                    var exists = parent.Children.FirstOrDefault(a => a.ActivityID == contentId);
                    if (exists == null)
                    {
                        AddNewDebugStateChild(parent, childItem, childItemContent, outputs, contentId);
                    }
                    else
                    {
                        AddExistingDebugState(childItem, outputs, exists);
                    }
                }
            }
        }

        void AddExistingDebugState(DebugStateTreeViewItemViewModel childItem, List<IDebugItem> outputs, IServiceTestStep exists)
        {
            if (exists is ServiceTestStep serviceTestStep)
            {
                if (outputs.Count > 0)
                {
                    AddOutputs(outputs, serviceTestStep);
                }
                else
                {
                    var type = _types?.FirstOrDefault(x => x.Name == childItem.ActivityTypeName);
                    if (type == null) return;
                    var act = Activator.CreateInstance(type) as IDev2Activity;
                    serviceTestStep.StepOutputs = AddOutputs(act?.GetOutputs(), serviceTestStep).ToObservableCollection();
                }
            }
        }

        void AddNewDebugStateChild(IServiceTestStep parent, DebugStateTreeViewItemViewModel childItem, IDebugState childItemContent, List<IDebugItem> outputs, Guid contentId)
        {
            var childStep = CreateAssertChildStep(parent, childItemContent, contentId);
            if (outputs.Count > 0)
            {
                AddOutputs(outputs, childStep);
            }
            else
            {
                var type = _types?.FirstOrDefault(x => x.Name == childItem.ActivityTypeName);
                if (type != null)
                {
                    var act = Activator.CreateInstance(type) as IDev2Activity;
                    childStep.StepOutputs = AddOutputs(act?.GetOutputs(), childStep).ToObservableCollection();
                }
            }
            SetStepIcon(childStep.ActivityType, childStep);
            if (!(childStep.StepOutputs?.Count > 0)) return;
            parent.Children.Add(childStep);
            if (childItem.Children?.Count > 0)
            {
                AddChildDebugItems(childItemContent, childItem, childStep);
            }
        }

        void AddOutputs(List<IDebugItem> outputs, IServiceTestStep serviceTestStep)
        {
            var serviceTestOutputs = new ObservableCollection<IServiceTestOutput>();
            if (outputs == null || outputs.Count < 1)
            {
                serviceTestOutputs.Add(new ServiceTestOutput("", "", "", "")
                {
                    AssertOp = "",
                    AddStepOutputRow = s => { serviceTestStep?.AddNewOutput(s); }
                });
                serviceTestStep.StepOutputs = serviceTestOutputs;
                return;
            }
            foreach (var output in outputs)
            {
                AddOutput(output, serviceTestStep, serviceTestOutputs);
            }
            serviceTestStep.StepOutputs = serviceTestOutputs;
        }

        void AddOutput(IDebugItem output, IServiceTestStep serviceTestStep, ObservableCollection<IServiceTestOutput> serviceTestOutputs)
        {
            var actualOutputs = output.ResultsList.Where(result => result.Type == DebugItemResultType.Variable);
            foreach (var debugItemResult in actualOutputs)
            {
                var variable = debugItemResult.Variable;
                var value = debugItemResult.Value;
                var assertOp = "=";
                if (debugItemResult.MoreLink != null)
                {
                    if (serviceTestStep.ActivityType == nameof(DsfEnhancedDotNetDllActivity))
                    {
                        var realValue = WebClient.DownloadString(debugItemResult.MoreLink);
                        value = realValue.TrimEnd(Environment.NewLine.ToCharArray());
                    }
                    else
                    {
                        assertOp = "Contains";
                    }
                }
                var serviceTestOutput = new ServiceTestOutput(variable ?? "", value, "", "")
                {
                    AssertOp = assertOp,
                    AddStepOutputRow = s => { serviceTestStep?.AddNewOutput(s); }
                };
                serviceTestOutputs.Add(serviceTestOutput);
            }
        }

        void SetInputs(IDebugState inputState)
        {
            if (inputState != null)
            {
                foreach (var debugItem in inputState.Inputs)
                {
                    var variable = debugItem.ResultsList.First().Variable.Replace("[[", "").Replace("]]", "");
                    var value = debugItem.ResultsList.First().Value;
                    var serviceTestInput = SelectedServiceTest?.Inputs?.FirstOrDefault(input => input.Variable.Equals(variable));
                    if (serviceTestInput != null)
                    {
                        serviceTestInput.Value = value;
                    }
                }
            }
        }

        public IWarewolfWebClient WebClient
        {
            private get => _webClient ?? CustomContainer.Get<IWarewolfWebClient>();
            set => _webClient = value;
        }

        void SetOutputs(IDebugState outPutState)
        {
            var dataList = new DataListModel();
            dataList.Create(ResourceModel.DataList, ResourceModel.DataList);
            if (outPutState == null)
            {
                return;
            }
            var outPuts = new ObservableCollection<IServiceTestOutput>();
            foreach (var debugItem in outPutState.Outputs)
            {
                foreach (var debugItemResult in debugItem.ResultsList)
                {
                    SetResultListOutputs(outPutState, dataList, outPuts, debugItemResult);
                }
            }
            SelectedServiceTest.Outputs = outPuts;
            SelectedServiceTest.ErrorExpected = outPutState.HasError;
            SelectedServiceTest.NoErrorExpected = !outPutState.HasError;
            SelectedServiceTest.ErrorContainsText = outPutState.ErrorMessage;
        }

        void SetResultListOutputs(IDebugState outPutState, DataListModel dataList, ObservableCollection<IServiceTestOutput> outPuts, IDebugItemResult debugItemResult)
        {
            var variable = debugItemResult.Variable.Replace("[[", "").Replace("]]", "");
            var value = debugItemResult.Value;
            var serviceTestOutput = new ServiceTestOutput(variable, value, "", "");
            var output = serviceTestOutput;
            serviceTestOutput.AddNewAction = () => ((ServiceTestModel)SelectedServiceTest).AddRow(output, dataList);

            if (!string.IsNullOrEmpty(debugItemResult.MoreLink))
            {
                if (outPutState.ActualType == nameof(DsfEnhancedDotNetDllActivity))
                {
                    var realValue = WebClient.DownloadString(debugItemResult.MoreLink);
                    value = realValue.TrimEnd(Environment.NewLine.ToCharArray());
                }
                else
                {
                    serviceTestOutput.AssertOp = "Contains";
                }
            }
            serviceTestOutput.Value = value;
            outPuts.Add(serviceTestOutput);
        }

        static void OnError(Exception exception)
        {
            Dev2Logger.Error(exception, GlobalConstants.WarewolfError);
            throw exception;
        }

        void ItemSelectedAction(ModelItem modelItem)
        {
            if (modelItem == null)
            {
                return;
            }

            var itemType = GetInnerItemType(modelItem);
            if (itemType == typeof(Flowchart) || itemType == typeof(ActivityBuilder))
            {
                return;
            }
            if (itemType == typeof(DsfForEachActivity))
            {
                ProcessForEach(modelItem);
            }
            else if (itemType == typeof(DsfSelectAndApplyActivity))
            {
                ProcessSelectAndApply(modelItem);
            }
            else if (itemType == typeof(DsfSequenceActivity))
            {
                ProcessSequence(modelItem);
            }
            else if (itemType == typeof(GateActivity))
            {
                ProcessGate(modelItem);
            }
            else if (itemType == typeof(SuspendExecutionActivity))
            {
                ProcessSuspendExecution(modelItem);
            }
            else if (itemType == typeof(DsfEnhancedDotNetDllActivity))
            {
                ProcessEnhancedDotNetDll(modelItem);
            }
            else if (itemType == typeof(FlowSwitch<string>))
            {
                ProcessFlowSwitch(modelItem);
            }
            else if (itemType == typeof(DsfSwitch))
            {
                ProcessSwitch(modelItem);
            }
            else if (itemType == typeof(FlowDecision))
            {
                ProcessFlowDecision(modelItem);
            }
            else if (itemType == typeof(DsfDecision))
            {
                ProcessDecision(modelItem);
            }
            else
            {
                ProcessActivity(modelItem);
            }
        }

        static Type GetInnerItemType(ModelItem modelItem)
        {
            var itemType = modelItem.ItemType;
            if (modelItem.Content?.Value != null && itemType == typeof(FlowStep))
            {
                itemType = modelItem.Content.Value.ItemType;
            }
            return itemType;
        }

        void ProcessSequence(ModelItem modelItem)
        {
            var sequence = GetCurrentActivity<DsfSequenceActivity>(modelItem);
            var testStep = BuildParentsFromModelItem(modelItem);
            if (testStep != null)
            {
                AddSequence(sequence, testStep, testStep.Children);
                if (FindExistingStep(testStep.ActivityID.ToString()) == null)
                {
                    SelectedServiceTest.TestSteps.Add(testStep);
                }
            }
            else
            {
                AddSequence(sequence, null, SelectedServiceTest.TestSteps);
            }
        }

        void ProcessGate(ModelItem modelItem)
        {
            var gateActivity = GetCurrentActivity<GateActivity>(modelItem);
            AddGate(gateActivity, null, SelectedServiceTest.TestSteps);
        }

        void ProcessSuspendExecution(ModelItem modelItem)
        {
            var suspendExecutionActivity = GetCurrentActivity<SuspendExecutionActivity>(modelItem);
            AddSuspendExecution(suspendExecutionActivity, null, SelectedServiceTest.TestSteps);
        }

        void ProcessEnhancedDotNetDll(ModelItem modelItem)
        {
            var dotNetDllActivity = GetCurrentActivity<DsfEnhancedDotNetDllActivity>(modelItem);
            var buildParentsFromModelItem = BuildParentsFromModelItem(modelItem);
            if (buildParentsFromModelItem != null)
            {
                AddEnhancedDotNetDll(dotNetDllActivity, buildParentsFromModelItem, buildParentsFromModelItem.Children);
                if (FindExistingStep(buildParentsFromModelItem.ActivityID.ToString()) == null)
                {
                    SelectedServiceTest.TestSteps.Add(buildParentsFromModelItem);
                }
            }
            else
            {
                AddEnhancedDotNetDll(dotNetDllActivity, null, SelectedServiceTest.TestSteps);
            }
        }

        static T GetCurrentActivity<T>(ModelItem modelItem) where T : class
        {
            var activity = modelItem.GetCurrentValue() as T;
            if (activity == null && modelItem.Content?.Value != null)
            {
                activity = modelItem.Content.Value.GetCurrentValue() as T;
            }
            return activity;
        }

        void ProcessForEach(ModelItem modelItem)
        {
            var forEachActivity = GetCurrentActivity<DsfForEachActivity>(modelItem);
            AddForEach(forEachActivity, null, SelectedServiceTest.TestSteps);
        }

        void AddForEach(DsfForEachActivity forEachActivity, IServiceTestStep parent, ObservableCollection<IServiceTestStep> serviceTestSteps)
        {
            if (forEachActivity == null)
            {
                return;
            }
            var uniqueId = forEachActivity.UniqueID;
            var exists = serviceTestSteps.FirstOrDefault(a => a.ActivityID.ToString() == uniqueId);

            var type = typeof(DsfForEachActivity);
            var testStep = CreateMockChildStep(Guid.Parse(uniqueId), parent, type.Name, forEachActivity.DisplayName);
            SetStepIcon(type, testStep);
            var activity = forEachActivity.DataFunc.Handler;

            if (activity is DsfNativeActivity<string> act)
            {
                if (act.GetType() == typeof(DsfSequenceActivity))
                {
                    AddSequence(act as DsfSequenceActivity, testStep, testStep.Children);
                }
                else
                {
                    AddChildActivity(act, testStep);
                }
            }
            else
            {
                if (activity.GetType() == typeof(DsfSelectAndApplyActivity))
                {
                    AddSelectAndApply(activity as DsfSelectAndApplyActivity, testStep, testStep.Children);
                }
                else
                {
                    if (activity.GetType() == type)
                    {
                        AddForEach(activity as DsfForEachActivity, testStep, testStep.Children);
                    }
                }
            }

            if (activity is DsfActivity workFlowService)
            {
                AddChildActivity(workFlowService, testStep);
            }
            if (exists == null)
            {
                serviceTestSteps.Add(testStep);
            }
        }

        static IServiceTestStep CreateMockChildStep(Guid uniqueId, IServiceTestStep parent, string typeName, string displayName) => new ServiceTestStep(uniqueId, typeName, new ObservableCollection<IServiceTestOutput>(), StepType.Mock)
        {
            StepDescription = displayName,
            Parent = parent
        };

        void ProcessSelectAndApply(ModelItem modelItem)
        {
            var selectAndApplyActivity = GetCurrentActivity<DsfSelectAndApplyActivity>(modelItem);
            AddSelectAndApply(selectAndApplyActivity, null, SelectedServiceTest.TestSteps);
        }

        void AddSelectAndApply(DsfSelectAndApplyActivity selectApplyActivity, IServiceTestStep parent, ObservableCollection<IServiceTestStep> serviceTestSteps)
        {
            if (selectApplyActivity == null)
            {
                return;
            }
            var uniqueId = selectApplyActivity.UniqueID;
            var exists = serviceTestSteps.FirstOrDefault(a => a.ActivityID.ToString() == uniqueId);

            var type = typeof(DsfSelectAndApplyActivity);
            var testStep = CreateMockChildStep(Guid.Parse(uniqueId), parent, type.Name, selectApplyActivity.DisplayName);
            SetStepIcon(type, testStep);
            var activity = selectApplyActivity.ApplyActivityFunc.Handler;

            if (activity is DsfNativeActivity<string> act)
            {
                if (act.GetType() == typeof(DsfSequenceActivity))
                {
                    AddSequence(act as DsfSequenceActivity, testStep, testStep.Children);
                }
                else
                {
                    AddChildActivity(act, testStep);
                }
            }
            else
            {
                if (activity != null && activity.GetType() == typeof(DsfForEachActivity))
                {
                    AddForEach(activity as DsfForEachActivity, testStep, testStep.Children);
                }
                else
                {
                    if (activity != null && activity.GetType() == typeof(DsfSelectAndApplyActivity))
                    {
                        AddSelectAndApply(activity as DsfSelectAndApplyActivity, testStep, testStep.Children);
                    }
                }
            }

            if (activity is DsfActivity workFlowService)
            {
                AddChildActivity(workFlowService, testStep);
            }
            if (exists == null)
            {
                serviceTestSteps.Add(testStep);
            }
            else
            {
                AddMissingChild(serviceTestSteps, testStep);
            }
        }

        void AddSequence(DsfSequenceActivity sequence, IServiceTestStep parent, ObservableCollection<IServiceTestStep> serviceTestSteps)
        {
            if (sequence is null)
            {
                return;
            }
            var uniqueId = sequence.UniqueID;
            var exists = serviceTestSteps.FirstOrDefault(a => a.ActivityID.ToString() == uniqueId);

            var type = typeof(DsfSequenceActivity);
            var testStep = CreateMockChildStep(Guid.Parse(uniqueId), parent, type.Name, sequence.DisplayName);
            SetStepIcon(type, testStep);
            foreach (var activity in sequence.Activities)
            {
                AddSequenceActivity(testStep, activity);
            }
            if (exists == null)
            {
                serviceTestSteps.Add(testStep);
            }
            else
            {
                AddMissingChild(serviceTestSteps, testStep);
            }
        }

        void AddSequenceActivity(IServiceTestStep testStep, Activity activity)
        {
            if (activity is DsfNativeActivity<string> act)
            {
                if (act.GetType() == typeof(DsfSequenceActivity))
                {
                    AddSequence(act as DsfSequenceActivity, testStep, testStep.Children);
                }
                else
                {
                    AddChildActivity(act, testStep);
                }
            }
            else
            {
                if (activity is DsfNativeActivity<bool> act2)
                {
                    AddChildActivity(act2, testStep);
                }
                if (activity.GetType() == typeof(DsfForEachActivity))
                {
                    AddForEach(activity as DsfForEachActivity, testStep, testStep.Children);
                }
                else
                {
                    if (activity.GetType() == typeof(DsfSelectAndApplyActivity))
                    {
                        AddSelectAndApply(activity as DsfSelectAndApplyActivity, testStep, testStep.Children);
                    }
                }
            }
        }

        void AddGate(GateActivity gateActivity, IServiceTestStep parent, ObservableCollection<IServiceTestStep> serviceTestSteps)
        {
            if (gateActivity == null)
            {
                return;
            }
            var uniqueId = gateActivity.UniqueID;
            var exists = serviceTestSteps.FirstOrDefault(a => a.ActivityID.ToString() == uniqueId);

            var type = typeof(GateActivity);
            var testStep = CreateMockChildStep(Guid.Parse(uniqueId), parent, type.Name, gateActivity.DisplayName);
            SetStepIcon(type, testStep);
            var activity = gateActivity.DataFunc.Handler;

            if (activity is DsfNativeActivity<string> act)
            {
                if (act.GetType() == typeof(DsfSequenceActivity))
                {
                    AddSequence(act as DsfSequenceActivity, testStep, testStep.Children);
                }
                else
                {
                    AddChildActivity(act, testStep);
                }
            }
            else
            {
                if (activity?.GetType() == typeof(DsfSelectAndApplyActivity))
                {
                    AddSelectAndApply(activity as DsfSelectAndApplyActivity, testStep, testStep.Children);
                }
                else
                {
                    if (activity?.GetType() == type)
                    {
                        AddGate(activity as GateActivity, testStep, testStep.Children);
                    }
                }
            }

            if (activity is DsfActivity workFlowService)
            {
                AddChildActivity(workFlowService, testStep);
            }
            if (exists == null)
            {
                serviceTestSteps.Add(testStep);
            }
        }

        void AddSuspendExecution(SuspendExecutionActivity suspendExecutionActivity, IServiceTestStep parent, ICollection<IServiceTestStep> serviceTestSteps)
        {
            if (suspendExecutionActivity == null)
            {
                return;
            }
            var uniqueId = suspendExecutionActivity.UniqueID;
            var exists = serviceTestSteps.FirstOrDefault(a => a.ActivityID.ToString() == uniqueId);

            var type = typeof(SuspendExecutionActivity);
            var testStep = CreateMockChildStep(Guid.Parse(uniqueId), parent, type.Name, suspendExecutionActivity.DisplayName);
            SetStepIcon(type, testStep);
            var activity = suspendExecutionActivity.SaveDataFunc.Handler;

            if (activity is DsfNativeActivity<string> act)
            {
                if (act.GetType() == typeof(DsfSequenceActivity))
                {
                    AddSequence(act as DsfSequenceActivity, testStep, testStep.Children);
                }
                else
                {
                    AddChildActivity(act, testStep);
                }
            }
            else
            {
                if (activity?.GetType() == typeof(DsfSelectAndApplyActivity))
                {
                    AddSelectAndApply(activity as DsfSelectAndApplyActivity, testStep, testStep.Children);
                }
                else
                {
                    if (activity?.GetType() == type)
                    {
                        AddSuspendExecution(activity as SuspendExecutionActivity, testStep, testStep.Children);
                    }
                }
            }

            if (activity is DsfActivity workFlowService)
            {
                AddChildActivity(workFlowService, testStep);
            }
            if (exists == null)
            {
                serviceTestSteps.Add(testStep);
            }
        }

        void AddEnhancedDotNetDll(DsfEnhancedDotNetDllActivity dotNetDllActivity, IServiceTestStep parent, ObservableCollection<IServiceTestStep> serviceTestSteps)
        {
            if (dotNetDllActivity == null)
            {
                return;
            }
            var uniqueId = dotNetDllActivity.UniqueID;
            var exists = serviceTestSteps.FirstOrDefault(a => a.ActivityID.ToString() == uniqueId);

            var type = typeof(DsfEnhancedDotNetDllActivity);
            var testStep = CreateMockChildStep(Guid.Parse(uniqueId), parent, type.Name, dotNetDllActivity.DisplayName);
            SetStepIcon(type, testStep);
            if (exists == null)
            {
                serviceTestSteps.Add(testStep);
                AddEnhancedDotNetDllConstructor(dotNetDllActivity, testStep);
                foreach (var pluginAction in dotNetDllActivity.MethodsToRun)
                {
                    if (!pluginAction.IsVoid)
                    {
                        AddEnhancedDotNetDllMethod(pluginAction, testStep);
                    }
                }
            }
            else
            {
                AddMissingChild(serviceTestSteps, exists);
                var constructorStepExists = exists.Children.FirstOrDefault(step => step.ActivityID == dotNetDllActivity.Constructor.ID);
                if (constructorStepExists == null)
                {
                    AddEnhancedDotNetDllConstructor(dotNetDllActivity, exists);
                }
                foreach (var pluginAction in dotNetDllActivity.MethodsToRun)
                {
                    AddEnhancedDotNetDllMethodChild(pluginAction, exists);
                }
            }
        }

        void AddEnhancedDotNetDllMethodChild(IPluginAction pluginAction, IServiceTestStep exists)
        {
            if (!pluginAction.IsVoid)
            {
                var actionExists = exists.Children.FirstOrDefault(step => step.ActivityID == pluginAction.ID);
                if (actionExists != null)
                {
                    AddEnhancedDotNetDllMethod(pluginAction, exists);
                }
            }
        }

        static void AddMissingChild(ObservableCollection<IServiceTestStep> serviceTestSteps, IServiceTestStep testStep)
        {
            if (serviceTestSteps.Count < 1)
            {
                return;
            }
            foreach (var serviceTestStep in serviceTestSteps)
            {
                if (serviceTestStep.ActivityID != testStep.ActivityID)
                {
                    continue;
                }
                AddMissingChild(serviceTestStep, testStep);
            }
        }

        static void AddMissingChild(IServiceTestStep serviceTestStep, IServiceTestStep testStep)
        {
            if (serviceTestStep.Children.Count == testStep.Children.Count)
            {
                foreach (var child in testStep.Children)
                {
                    AddMissingChild(serviceTestStep.Children, child);
                }
            }
            else
            {
                foreach (var child in testStep.Children)
                {
                    AddMissingChild(serviceTestStep, testStep, child);
                }
            }
        }

        static void AddMissingChild(IServiceTestStep serviceTestStep, IServiceTestStep testStep, IServiceTestStep child)
        {
            var testSteps = serviceTestStep.Children.Where(a => a.ActivityID == child.ActivityID);
            if (!testSteps.Any())
            {
                var indexOf = testStep.Children.IndexOf(child);
                child.Parent = serviceTestStep;
                serviceTestStep.Children.Insert(indexOf, child);
            }
        }

        void AddChildActivity<T>(DsfNativeActivity<T> act, IServiceTestStep testStep)
        {
            var outputs = act.GetOutputs();
            if (outputs != null && outputs.Count > 0)
            {
                var serviceTestStep = CreateMockChildStep(Guid.Parse(act.UniqueID), testStep, act.GetType().Name, act.DisplayName);
                var serviceTestOutputs = outputs.Select(output => new ServiceTestOutput(output, "", "", "")
                {
                    HasOptionsForValue = false,
                    AddStepOutputRow = serviceTestStep.AddNewOutput
                }).Cast<IServiceTestOutput>().ToObservableCollection();
                serviceTestStep.StepOutputs = serviceTestOutputs;
                SetStepIcon(act.GetType(), serviceTestStep);
                testStep.Children.Add(serviceTestStep);
            }
        }

        void AddEnhancedDotNetDllConstructor(DsfEnhancedDotNetDllActivity dotNetConstructor, IServiceTestStep testStep)
        {
            var serviceTestStep = CreateMockChildStep(dotNetConstructor.Constructor.ID, testStep, testStep.ActivityType, dotNetConstructor.Constructor.ConstructorName);
            var serviceOutputs = new ObservableCollection<IServiceTestOutput>
            {
                new ServiceTestOutput(dotNetConstructor.ObjectName ?? "", "", "", "")
            };
            serviceTestStep.StepOutputs = serviceOutputs;
            SetStepIcon(testStep.ActivityType, serviceTestStep);
            testStep.Children.Insert(0, serviceTestStep);
        }

        void AddEnhancedDotNetDllMethod(IPluginAction pluginAction, IServiceTestStep testStep)
        {
            var serviceTestStep = CreateMockChildStep(pluginAction.ID, testStep, testStep.ActivityType, pluginAction.Method);
            var serviceOutputs = new ObservableCollection<IServiceTestOutput>
            {
                new ServiceTestOutput(pluginAction.OutputVariable ?? "", "", "", "")
            };
            serviceTestStep.StepOutputs = serviceOutputs;
            SetStepIcon(testStep.ActivityType, serviceTestStep);
            testStep.Children.Add(serviceTestStep);
        }

        void ProcessSwitch(ModelItem modelItem)
        {
            var cases = modelItem.GetProperty("Switches") as Dictionary<string, IDev2Activity>;
            var uniqueId = modelItem.GetProperty("UniqueID").ToString();
            var exists = SelectedServiceTest.TestSteps.FirstOrDefault(a => a.ActivityID.ToString() == uniqueId);

            if (exists == null && SelectedServiceTest != null)
            {
                var switchOptions = cases?.Select(pair => pair.Key).ToList();

                if (modelItem.GetProperty("Default") is List<IDev2Activity> defaultCase)
                {
                    switchOptions?.Insert(0, "Default");
                }
                var serviceTestOutputs = new ObservableCollection<IServiceTestOutput>();
                var serviceTestOutput = new ServiceTestOutput(GlobalConstants.ArmResultText, "", "", "")
                {
                    HasOptionsForValue = true,
                    OptionsForValue = switchOptions
                };
                serviceTestOutputs.Add(serviceTestOutput);
                if (SelectedServiceTest.AddTestStep(uniqueId, modelItem.GetProperty("DisplayName").ToString(), nameof(DsfSwitch), serviceTestOutputs) is ServiceTestStep serviceTestStep)
                {
                    SetStepIcon(typeof(DsfSwitch), serviceTestStep);
                }
            }
        }

        IServiceTestStep ProcessFlowSwitch(ModelItem modelItem)
        {
            if (modelItem == null)
            {
                return null;
            }
            var condition = modelItem.GetProperty("Expression");
            var activity = (DsfFlowNodeActivity<string>)condition;
            var flowSwitch = GetCurrentActivity<FlowSwitch<string>>(modelItem);
            if (flowSwitch == null)
            {
                var modelItemParent = modelItem.Parent;
                if (modelItemParent != null)
                {
                    flowSwitch = GetCurrentActivity<FlowSwitch<string>>(modelItemParent);
                    condition = modelItemParent.GetProperty("Expression");
                }
                activity = (DsfFlowNodeActivity<string>)condition;
            }
            if (flowSwitch != null)
            {
                var uniqueId = activity.UniqueID;
                var exists = SelectedServiceTest.TestSteps.FirstOrDefault(a => a.ActivityID.ToString() == uniqueId);

                if (exists == null && SelectedServiceTest != null)
                {
                    return CreateFlowSwitchTestStep(flowSwitch, uniqueId);
                }
            }
            return null;
        }

        IServiceTestStep CreateFlowSwitchTestStep(FlowSwitch<string> flowSwitch, string uniqueId)
        {
            var switchOptions = flowSwitch.Cases?.Select(pair => pair.Key).ToList();
            if (flowSwitch.Default != null)
            {
                switchOptions?.Insert(0, "Default");
            }
            var serviceTestOutputs = new ObservableCollection<IServiceTestOutput>();
            var serviceTestOutput = new ServiceTestOutput(GlobalConstants.ArmResultText, "", "", "")
            {
                HasOptionsForValue = true,
                OptionsForValue = switchOptions
            };
            serviceTestOutputs.Add(serviceTestOutput);
            var serviceTestStep = SelectedServiceTest.AddTestStep(uniqueId, flowSwitch.DisplayName, nameof(DsfSwitch), serviceTestOutputs);
            if (serviceTestStep != null)
            {
                SetStepIcon(typeof(DsfSwitch), serviceTestStep);
            }

            return serviceTestStep;
        }

        void ProcessActivity(ModelItem modelItem)
        {
            var step = BuildParentsFromModelItem(modelItem);
            if (step != null)
            {
                if (step.Parent == null)
                {
                    ProcessStepActivity(step);
                }
                else
                {
                    ProcessParentsActivities(step);
                }
            }
            else
            {
                var computedValue = modelItem.GetCurrentValue();
                var boolAct = computedValue as DsfActivityAbstract<bool>;
                var activityUniqueId = boolAct?.UniqueID;
                var activityDisplayName = boolAct?.DisplayName;
                var type = computedValue.GetType();
                var serviceTestOutputs = new ObservableCollection<IServiceTestOutput>();
                var alreadyAdded = CheckForExists(activityUniqueId, new List<string>(), activityDisplayName, type);
                if (alreadyAdded == null && activityUniqueId != null && type == typeof(DsfActivity))
                {
                    var testStep = CreateMockChildStep(Guid.Parse(activityUniqueId), null, type.Name, activityDisplayName);
                    serviceTestOutputs.Add(new ServiceTestOutput("", "", "", "")
                    {
                        AssertOp = "",
                        AddStepOutputRow = testStep.AddNewOutput,
                        IsSearchCriteriaEnabled = true
                    });
                    testStep.StepOutputs = serviceTestOutputs;
                    SelectedServiceTest.TestSteps.Add(testStep);
                    SetStepIcon(type, testStep);
                }
            }
        }

        void ProcessStepActivity(IServiceTestStep step)
        {
            var exists = FindExistingStep(step.ActivityID.ToString());
            if (exists == null)
            {
                SelectedServiceTest.TestSteps.Add(step);
            }
        }

        void ProcessParentsActivities(IServiceTestStep step)
        {
            var parent = step.Parent;
            while (parent != null)
            {
                var child = parent;
                if (child.Parent == null)
                {
                    var exists = FindExistingStep(step.ActivityID.ToString());
                    if (exists == null)
                    {
                        SelectedServiceTest.TestSteps.Add(child);
                    }
                }
                parent = child.Parent;
            }
        }

        IServiceTestStep BuildParentsFromModelItem(ModelItem modelItem)
        {
            var computedValue = modelItem.GetCurrentValue();
            if (computedValue is FlowStep && modelItem.Content?.Value != null)
            {
                computedValue = modelItem.Content.Value.GetCurrentValue();
            }
            var dsfActivityAbstract = computedValue as DsfActivityAbstract<string>;

            var activityUniqueId = dsfActivityAbstract?.UniqueID;
            var activityDisplayName = dsfActivityAbstract?.DisplayName;
            var outputs = dsfActivityAbstract?.GetOutputs();

            if (dsfActivityAbstract == null)
            {
                var boolAct = computedValue as DsfActivityAbstract<bool>;

                activityUniqueId = boolAct?.UniqueID;
                activityDisplayName = boolAct?.DisplayName;
                outputs = boolAct?.GetOutputs();
            }

            var type = computedValue.GetType();
            var item = modelItem.Parent;

            if (item != null && (item.ItemType != typeof(Flowchart) || item.ItemType == typeof(ActivityBuilder)))
            {
                var parentComputedValue = item.GetCurrentValue();
                if (parentComputedValue is FlowStep)
                {
                    var parentFlowStepUniqueId = GetParentFlowStepUniqueId(computedValue, item, ref parentComputedValue);
                    if (parentFlowStepUniqueId == activityUniqueId)
                    {
                        parentComputedValue = item.Content.Value.GetCurrentValue();
                    }
                    var parentActivityAbstract = parentComputedValue as DsfActivityAbstract<string>;
                    var parentActivityUniqueId = parentActivityAbstract?.UniqueID;
                    if (parentActivityAbstract == null)
                    {
                        var boolParentAct = computedValue as DsfActivityAbstract<bool>;
                        parentActivityUniqueId = boolParentAct?.UniqueID;
                    }
                    if (parentActivityUniqueId == activityUniqueId)
                    {
                        return CheckForExists(activityUniqueId, outputs, activityDisplayName, type);
                    }
                }

                if (outputs != null && outputs.Count > 0 && ServiceTestStepWithOutputs(activityUniqueId, activityDisplayName, outputs, type, item, out IServiceTestStep serviceTestStep) && ServiceTestStepWithOutputs(activityUniqueId, activityDisplayName, outputs, type, item, out IServiceTestStep testStep))
                {
                    return testStep;
                }

                if (ServiceTestStepGetParentType(item, out var serviceTestStep1))
                {
                    return serviceTestStep1;
                }
                return BuildParentsFromModelItem(item);
            }
            return CheckForExists(activityUniqueId, outputs, activityDisplayName, type);
        }

        static string GetParentFlowStepUniqueId(object computedValue, ModelItem item, ref object parentComputedValue)
        {
            if (item.Content?.Value != null)
            {
                parentComputedValue = item.Content.Value.GetCurrentValue();
            }
            var parentActivityAbstract = parentComputedValue as DsfActivityAbstract<string>;
            var parentActivityUniqueId = parentActivityAbstract?.UniqueID;
            if (parentActivityAbstract == null)
            {
                var boolParentAct = computedValue as DsfActivityAbstract<bool>;
                parentActivityUniqueId = boolParentAct?.UniqueID;
            }

            return parentActivityUniqueId;
        }

        IServiceTestStep CheckForExists(string activityUniqueId, List<string> outputs, string activityDisplayName, Type type)
        {
            var exists = FindExistingStep(activityUniqueId);
            if (exists == null && outputs != null && outputs.Count > 0)
            {
                var serviceTestStep = SelectedServiceTest.AddTestStep(activityUniqueId, activityDisplayName, type.Name, new ObservableCollection<IServiceTestOutput>());

                var serviceTestOutputs = outputs.Select(output =>
                {
                    return new ServiceTestOutput(output ?? "", "", "", "")
                    {
                        HasOptionsForValue = false,
                        AddStepOutputRow = s => { serviceTestStep?.AddNewOutput(s); }
                    };
                }).Cast<IServiceTestOutput>().ToList();
                if (serviceTestStep != null)
                {
                    serviceTestStep.StepOutputs = serviceTestOutputs.ToObservableCollection();
                    SetStepIcon(type, serviceTestStep);

                    return serviceTestStep;
                }
            }
            return exists;
        }

        bool ServiceTestStepWithOutputs(string uniqueId, string displayName, List<string> outputs, Type type, ModelItem item, out IServiceTestStep serviceTestStep)
        {
            var exists = FindExistingStep(uniqueId);
            if (exists == null)
            {
                var step = CreateServiceTestStep(Guid.Parse(uniqueId), displayName, type, new List<IServiceTestOutput>());
                var serviceTestOutputs = AddOutputsIfHasVariable(outputs, step);
                step.StepOutputs = serviceTestOutputs.ToObservableCollection();
                SetParentChild(item, step);
                {
                    serviceTestStep = step;
                    return true;
                }
            }
            serviceTestStep = null;
            return false;
        }

        static List<IServiceTestOutput> AddOutputsIfHasVariable(List<string> outputs, IServiceTestStep step)
        {
            var serviceTestOutputs =
                outputs.Select(output => new ServiceTestOutput(output ?? "", "", "", "")
                {
                    HasOptionsForValue = false,
                    AddStepOutputRow = step.AddNewOutput
                }).Cast<IServiceTestOutput>().ToList();
            return serviceTestOutputs;
        }

        static List<IServiceTestOutput> AddOutputs(List<string> outputs, IServiceTestStep step)
        {
            if (outputs == null || outputs.Count == 0)
            {
                return new List<IServiceTestOutput>
                {
                    new ServiceTestOutput("", "", "", "")
                    {
                        HasOptionsForValue = false,
                        AddStepOutputRow = step.AddNewOutput
                    }
                };
            }
            var serviceTestOutputs =
                outputs.Select(output => new ServiceTestOutput(output ?? "", "", "", "")
                {
                    HasOptionsForValue = false,
                    AddStepOutputRow = step.AddNewOutput
                }).Cast<IServiceTestOutput>().ToList();
            return serviceTestOutputs;
        }

        IServiceTestStep FindExistingStep(string uniqueId)
        {
            var exists = SelectedServiceTest.TestSteps.Flatten(step => step.Children).FirstOrDefault(a => a.ActivityID.ToString() == uniqueId);
            return exists;
        }

        bool ServiceTestStepGetParentType(ModelItem item, out IServiceTestStep serviceTestStep)
        {
            Type activityType = null;
            var uniqueId = string.Empty;
            var displayName = string.Empty;
            if (item.ItemType == typeof(DsfSequenceActivity))
            {
                if (item.GetCurrentValue() is DsfSequenceActivity act)
                {
                    uniqueId = act.UniqueID;
                    activityType = typeof(DsfSequenceActivity);
                    displayName = act.DisplayName;
                }
            }
            else if (item.ItemType == typeof(DsfForEachActivity))
            {
                if (item.GetCurrentValue() is DsfForEachActivity act)
                {
                    uniqueId = act.UniqueID;
                    activityType = typeof(DsfForEachActivity);
                    displayName = act.DisplayName;
                }
            }
            else if (item.ItemType == typeof(SuspendExecutionActivity))
            {
                if (item.GetCurrentValue() is SuspendExecutionActivity act)
                {
                    uniqueId = act.UniqueID;
                    activityType = typeof(SuspendExecutionActivity);
                    displayName = act.DisplayName;
                }
            }
            else
            {
                if (item.ItemType == typeof(DsfSelectAndApplyActivity) && item.GetCurrentValue() is DsfSelectAndApplyActivity act)
                {
                    uniqueId = act.UniqueID;
                    activityType = typeof(DsfSelectAndApplyActivity);
                    displayName = act.DisplayName;
                }
            }
            if (!string.IsNullOrWhiteSpace(uniqueId))
            {
                var exists = FindExistingStep(uniqueId);
                if (exists == null)
                {
                    var step = CreateServiceTestStep(Guid.Parse(uniqueId), displayName, activityType, new List<IServiceTestOutput>());
                    SetParentChild(item, step);
                    {
                        serviceTestStep = step;
                        return true;
                    }
                }
                serviceTestStep = SelectedServiceTest.TestSteps.Flatten(step => step.Children).FirstOrDefault(a => a.ActivityID.ToString() == uniqueId);
                return true;
            }
            serviceTestStep = null;
            return false;
        }

        IServiceTestStep CreateServiceTestStep(Guid uniqueId, string displayName, Type type, List<IServiceTestOutput> serviceTestOutputs)
        {
            var step = new ServiceTestStep(uniqueId, type.Name, serviceTestOutputs.ToObservableCollection(), StepType.Assert)
            {
                StepDescription = displayName
            };
            SetStepIcon(type, step);
            return step;
        }

        void SetParentChild(ModelItem item, IServiceTestStep step)
        {
            var parent = BuildParentsFromModelItem(item);
            if (parent != null)
            {
                step.Parent = parent;
                parent.Children.Add(step);
            }
        }

        void SetStepIcon(Type type, IServiceTestStep serviceTestStep)
        {
            SetStepIcon(type?.Name, serviceTestStep);
        }

        void SetStepIcon(string typeName, IServiceTestStep serviceTestStep)
        {
            if (string.IsNullOrEmpty(typeName) || serviceTestStep == null)
            {
                return;
            }
            var actTypeName = typeName;
            if (actTypeName == "DsfActivity")
            {
                if (serviceTestStep is ServiceTestStep serviceStep)
                {
                    serviceStep.StepIcon = Application.Current?.TryFindResource("Explorer-WorkflowService") as ImageSource;
                }
                return;
            }
            if (typeName == "DsfDecision" || typeName == "FlowDecision")
            {
                actTypeName = "DsfFlowDecisionActivity";
            }
            if (typeName == "DsfSwitch")
            {
                actTypeName = "DsfFlowSwitchActivity";
            }
            var type = _types?.FirstOrDefault(x => x.Name == actTypeName);
            if (type == null || !type.GetCustomAttributes().Any(a => a is ToolDescriptorInfo)) return;
            var desc = GetDescriptorFromAttribute(type);
            if (serviceTestStep is ServiceTestStep serviceStepAsTestStep)
            {
                serviceStepAsTestStep.StepIcon = Application.Current?.TryFindResource(desc.Icon) as ImageSource;
            }
        }

        static IToolDescriptor GetDescriptorFromAttribute(Type type)
        {
            var info = type.GetCustomAttributes(typeof(ToolDescriptorInfo)).First() as ToolDescriptorInfo;
            return new ToolDescriptor(info.Id, info.Designer, new WarewolfType(type.FullName, type.Assembly.GetName().Version, type.Assembly.Location), info.Name, info.Icon, type.Assembly.GetName().Version, true, info.Category, ToolType.Native, info.IconUri, info.FilterTag, info.ResourceToolTip, info.ResourceHelpText);
        }

        void ProcessDecision(ModelItem modelItem)
        {
            if (modelItem == null)
            {
                return;
            }
            var uniqueId = modelItem.GetProperty("UniqueID").ToString();
            var exists = SelectedServiceTest.TestSteps.FirstOrDefault(a => a.ActivityID.ToString() == uniqueId);

            if (exists == null && SelectedServiceTest != null)
            {
                var serviceTestOutputs = new ObservableCollection<IServiceTestOutput>();

                if (modelItem.GetProperty("Conditions") is Dev2DecisionStack dds)
                {
                    var serviceTestOutput = new ServiceTestOutput(GlobalConstants.ArmResultText, "", "", "")
                    {
                        HasOptionsForValue = true,
                        OptionsForValue = new List<string> { dds.TrueArmText, dds.FalseArmText }
                    };
                    serviceTestOutputs.Add(serviceTestOutput);
                }
                if (SelectedServiceTest.AddTestStep(uniqueId, modelItem.GetProperty("DisplayName").ToString(), nameof(DsfDecision), serviceTestOutputs) is ServiceTestStep serviceTestStep)
                {
                    SetStepIcon(typeof(DsfDecision), serviceTestStep);
                }
            }
        }

        IServiceTestStep ProcessFlowDecision(ModelItem modelItem)
        {
            if (modelItem == null)
            {
                return null;
            }
            var condition = modelItem.GetProperty("Condition");
            string expression;
            string uniqueId;
            var activity = (DsfFlowNodeActivity<bool>)condition;
            if (activity != null)
            {
                uniqueId = activity.UniqueID;
                expression = activity.ExpressionText;
            }
            else
            {
                expression = modelItem.GetProperty("ExpressionText") as string;
                uniqueId = modelItem.GetProperty("UniqueID") as string;
            }
            if (!string.IsNullOrEmpty(expression))
            {
                var eval = Dev2DecisionStack.ExtractModelFromWorkflowPersistedData(expression);

                if (!string.IsNullOrEmpty(eval))
                {
                    var ser = new Dev2JsonSerializer();
                    var dds = ser.Deserialize<Dev2DecisionStack>(eval);

                    var exists = SelectedServiceTest.TestSteps?.FirstOrDefault(a => a.ActivityID.ToString() == uniqueId);

                    if (exists == null && SelectedServiceTest != null)
                    {
                        var serviceTestOutputs = new ObservableCollection<IServiceTestOutput>();
                        var serviceTestOutput = new ServiceTestOutput(GlobalConstants.ArmResultText, "", "", "")
                        {
                            HasOptionsForValue = true,
                            OptionsForValue = new List<string> { dds.TrueArmText, dds.FalseArmText }
                        };
                        serviceTestOutputs.Add(serviceTestOutput);
                        var serviceTestStep = SelectedServiceTest.AddTestStep(uniqueId, dds.DisplayText, nameof(DsfDecision), serviceTestOutputs);
                        SetStepIcon(typeof(DsfDecision), serviceTestStep);
                        return serviceTestStep;
                    }
                }
            }
            return null;
        }

        void SetServerName(IContextualResourceModel resourceModel)
        {
            if (resourceModel.Environment == null || resourceModel.Environment.IsLocalHost)
            {
                _serverName = string.Empty;
            }
            else
            {
                if (!resourceModel.Environment.IsLocalHost)
                {
                    _serverName = " - " + resourceModel.Environment.Name;
                }
            }
        }

        void OnReceivedResourceAffectedMessage(Guid resourceId, CompileMessageList changeList)
        {
            if (resourceId == ResourceModel.ID)
            {
                IsLoading = true;
                AsyncWorker.Start(() =>
                {
                    var contextModel = ResourceModel?.Environment?.ResourceRepository?.LoadContextualResourceModel(resourceId);
                    _resourceModel = contextModel;
                    return GetTests();
                }, models =>
                {
                    var dummyTest = new DummyServiceTest(CreateTests) { TestName = "Create a new test." };
                    models.Add(dummyTest);
                    var testName = SelectedServiceTest?.TestName;
                    SelectedServiceTest = dummyTest;
                    Tests = models;
                    SelectedServiceTest = _tests.FirstOrDefault(model => model.TestName == testName);
                    var mainViewModel = CustomContainer.Get<IShellViewModel>();
                    WorkflowDesignerViewModel = mainViewModel?.CreateNewDesigner(ResourceModel);
                    if (WorkflowDesignerViewModel != null)
                    {
                        WorkflowDesignerViewModel.ItemSelectedAction = ItemSelectedAction;
                    }
                    IsLoading = false;
                });
            }
        }

        bool IsServerConnected() => ResourceModel.Environment.IsConnected;

        void StopTest()
        {
            SelectedServiceTest.IsTestRunning = false;
            SelectedServiceTest.TestPending = true;
            ServiceTestCommandHandler.StopTest(ResourceModel);
        }

        void RunSelectedTestInBrowser()
        {
            var runSelectedTestUrl = GetWebRunUrlForTest(SelectedServiceTest);
            ServiceTestCommandHandler.RunSelectedTestInBrowser(runSelectedTestUrl, _processExecutor);
        }

        void RunSelectedTest()
        {
            if (SelectedServiceTest != null)
            {
                if (SelectedServiceTest.IsDirty)
                {
                    if (ShowPopupWhenDuplicates())
                    {
                        return;
                    }
                    Save(new List<IServiceTestModel> { SelectedServiceTest });
                    if (IsResourceDeleted)
                    {
                        return;
                    }
                }
                ServiceTestCommandHandler.RunSelectedTest(SelectedServiceTest, ResourceModel, AsyncWorker);
                ViewModelUtils.RaiseCanExecuteChanged(StopTestCommand);
            }
        }

        void RunAllTestsInBrowser()
        {
            ServiceTestCommandHandler.RunAllTestsInBrowser(IsDirty, RunAllTestsUrl, _processExecutor);
        }

        private void RunAllCoverageInBrowser()
        {
            ServiceTestCommandHandler.RunAllTestCoverageInBrowser(IsDirty, RunAllCoverageUrl, _processExecutor);
        }

        void RunAllTests()
        {
            ServiceTestCommandHandler.RunAllTestsCommand(IsDirty, RealTests().Where(model => model.Enabled), ResourceModel, AsyncWorker);
            SelectedServiceTest = null;
        }

        void DuplicateTest()
        {
            var testNumber = GetNewTestNumber(SelectedServiceTest.TestName);
            var duplicateTest = ServiceTestCommandHandler.DuplicateTest(SelectedServiceTest, testNumber);
            AddAndSelectTest(duplicateTest);
            foreach (var testStep in duplicateTest.TestSteps)
            {
                var typeName = testStep.ActivityType;
                SetStepIcon(typeName, testStep);
            }
        }

        bool CanDeleteTest(IServiceTestModel selectedTestModel) => GetPermissions() && selectedTestModel != null && !selectedTestModel.Enabled && IsServerConnected();

        IAsyncWorker AsyncWorker { get; }
        IEventAggregator EventPublisher { get; }

        void CreateTests(bool isFromDebug = false)
        {
            _canAddFromDebug = true;
            SelectedServiceTest = null;
            if (IsDirty)
            {
                PopupController?.Show(Resources.Languages.Core.ServiceTestSaveEditedTestsMessage, Resources.Languages.Core.ServiceTestSaveEditedTestsHeader, MessageBoxButton.OK, MessageBoxImage.Error, null, false, true, false, false, false, false);
                _canAddFromDebug = false;
                return;
            }

            var testNumber = GetNewTestNumber("Test");
            var testModel = ServiceTestCommandHandler.CreateTest(ResourceModel, testNumber, isFromDebug);
            AddAndSelectTest(testModel);
        }

        bool _canAddFromDebug;
        bool _isLoading;
        bool _isValid;
        bool _dirty;
        IWarewolfWebClient _webClient;

        int GetNewTestNumber(string testName)
        {
            var counter = 1;
            var fullName = testName + " " + counter;

            while (Contains(fullName))
            {
                counter++;
                fullName = testName + " " + counter;
            }

            return counter;
        }

        bool Contains(string nameToCheck)
        {
            var serviceTestModel = RealTests().FirstOrDefault(a => a.TestName.Contains(nameToCheck));
            return serviceTestModel != null;
        }

        void SetDuplicateTestTooltip()
        {
            if (SelectedServiceTest != null)
            {
                SelectedServiceTest.DuplicateTestTooltip = SelectedServiceTest.NewTest ? Resources.Languages.Tooltips.ServiceTestNewTestDisabledDuplicateSelectedTestTooltip : CanDuplicateTest ? Resources.Languages.Tooltips.ServiceTestDuplicateSelectedTestTooltip : Resources.Languages.Tooltips.ServiceTestDisabledDuplicateSelectedTestTooltip;
            }
        }

        void AddAndSelectTest(IServiceTestModel testModel)
        {
            var index = _tests.Count - 1;
            if (index >= 0)
            {
                _tests.Insert(index, testModel);
            }
            else
            {
                _tests.Add(testModel);
            }
            SelectedServiceTest = testModel;
            var isDirty = IsDirty;
            SetDisplayName(isDirty);
        }

        bool CanStopTest => SelectedServiceTest != null && SelectedServiceTest.IsTestRunning;
        bool CanRunSelectedTestInBrowser => SelectedServiceTest != null && !SelectedServiceTest.IsDirty && IsServerConnected();
        bool CanRunSelectedTest => GetPermissions() && IsServerConnected();
        bool CanDuplicateTest => GetPermissions() && SelectedServiceTest != null && !SelectedServiceTest.NewTest;

        public bool CanSave { get; set; }

        bool IsResourceDeleted { get; set; }

        static bool GetPermissions() => true;

        bool IsValidName()
        {
            if (SelectedServiceTest != null)
            {
                var name = SelectedServiceTest.TestName;
                ErrorMessage = string.Empty;
                if (string.IsNullOrEmpty(name))
                {
                    ErrorMessage = string.Format(ErrorResource.CannotBeNull, "'name'");
                }
                else if (NameHasInvalidCharacters(name))
                {
                    ErrorMessage = string.Format(ErrorResource.ContainsInvalidCharecters, "'name'");
                }
                else
                {
                    if (name.Trim() != name)
                    {
                        ErrorMessage = string.Format(ErrorResource.ContainsLeadingOrTrailingWhitespace, "'name'");
                    }
                }

                return string.IsNullOrEmpty(ErrorMessage);
            }
            return true;
        }

        bool AllNamesValid(IEnumerable<string> testNames)
        {
            foreach (var name in testNames)
            {
                ErrorMessage = string.Empty;
                if (string.IsNullOrEmpty(name))
                {
                    ErrorMessage = string.Format(ErrorResource.CannotBeNull, "'name'");
                    var popupController = CustomContainer.Get<IPopupController>();
                    popupController?.Show(Resources.Languages.Core.ServiceTestEmptyTestNameHeader, "Empty Test Name"
                        , MessageBoxButton.OK, MessageBoxImage.Error, null,
                        false, true, false, false, false, false);
                    return false;
                }
                else if (NameHasInvalidCharacters(name))
                {
                    ErrorMessage = string.Format(ErrorResource.ContainsInvalidCharecters, "'name'");
                    return false;
                }
                else if (name.Trim() != name)
                {
                    ErrorMessage = string.Format(ErrorResource.ContainsLeadingOrTrailingWhitespace, "'name'");
                    return false;
                }
                else
                {
                    continue;
                }
            }
            return true;
        }
        static bool NameHasInvalidCharacters(string name) => Regex.IsMatch(name, @"[^a-zA-Z0-9._\s-]");

        public string ErrorMessage
        {
            get => _errorMessage;
            set
            {
                _errorMessage = value;
                OnPropertyChanged(() => ErrorMessage);
            }
        }

        public IWorkflowDesignerViewModel WorkflowDesignerViewModel
        {
            get => _workflowDesignerViewModel;
            set
            {
                _workflowDesignerViewModel = value;
                OnPropertyChanged(() => WorkflowDesignerViewModel);
            }
        }

        public bool IsDirty
        {
            get
            {
                try
                {
                    if (_tests == null || _tests.Count <= 1)
                    {
                        return false;
                    }
                    var isDirty = _tests.Any(resource => resource.IsDirty || resource.NewTest);

                    var isConnected = ResourceModel.Environment.Connection.IsConnected;
                    _dirty = isDirty && isConnected;
                    _isValid = IsValidName();
                    CanSave = _isValid && _dirty;
                    SetDisplayName(_dirty);
                    return _dirty;
                }
                catch (Exception)
                {
                    return false;
                }
            }
        }

        public Guid ResourceID => ResourceModel?.ID ?? Guid.Empty;

        public void Save()
        {
            try
            {
                if (ShowPopupWhenDuplicates())
                {
                    return;
                }

                var serviceTestModels = RealTests().Where(a => a.IsDirty).ToList();
                Save(serviceTestModels);
                UpdateTestsFromResourceUpdate();
            }
            catch (Exception ex)
            {
                Dev2Logger.Error("Service test save error.", ex, GlobalConstants.WarewolfError);
            }
            finally
            {
                var isDirty = IsDirty;
                SetDisplayName(isDirty);
            }
        }

        void Save(List<IServiceTestModel> serviceTestModels)
        {
            if (!AllNamesValid(Tests.Select(p => p.TestName).ToList()))
            {
                return;
            }
            MarkPending(serviceTestModels);
            var serviceTestModelTos = serviceTestModels.Select(CreateServiceTestModelTo).ToList();

            var result = ResourceModel.Environment.ResourceRepository.SaveTests(ResourceModel, serviceTestModelTos);
            switch (result.Result)
            {
                case SaveResult.Success:
                    MarkTestsAsNotNew();
                    SetSelectedTestUrl();
                    break;
                case SaveResult.ResourceDeleted:
                    PopupController?.Show(Resources.Languages.Core.ServiceTestResourceDeletedMessage, Resources.Languages.Core.ServiceTestResourceDeletedHeader, MessageBoxButton.OK, MessageBoxImage.Error, null, false, true, false, false, false, false);
                    _shellViewModel.CloseResourceTestView(ResourceModel.ID, ResourceModel.ServerID, ResourceModel.Environment.EnvironmentID);
                    IsResourceDeleted = true;
                    break;
                case SaveResult.ResourceUpdated:
                    UpdateTestsFromResourceUpdate();
                    break;
                default:
                    throw new ArgumentOutOfRangeException();
            }
        }

        static void MarkPending(List<IServiceTestModel> serviceTestModels)
        {
            foreach (var serviceTestModel in serviceTestModels)
            {
                serviceTestModel.TestPending = true;
                if (serviceTestModel.TestSteps != null)
                {
                    MarkTestStepsPending(serviceTestModel);
                }

                if (serviceTestModel.Outputs == null)
                {
                    continue;
                }

                foreach (var testOutput in serviceTestModel.Outputs.OfType<ServiceTestOutput>())
                {
                    testOutput.TestPending = true;
                    if (testOutput.Result != null)
                    {
                        testOutput.Result.RunTestResult = RunResult.TestPending;
                    }
                }
            }
        }

        static void MarkTestStepsPending(IServiceTestModel serviceTestModel)
        {
            foreach (var serviceTestStep in serviceTestModel.TestSteps)
            {
                MarkChildrenPending(serviceTestStep);
                if (serviceTestStep.Children == null)
                {
                    continue;
                }

                var testSteps = serviceTestStep.Children.Flatten(step => step.Children);
                foreach (var testStep in testSteps)
                {
                    MarkChildrenPending(testStep);
                }
            }
        }

        static void MarkChildrenPending(IServiceTestStep serviceTestStep)
        {
            if (serviceTestStep is ServiceTestStep step)
            {
                step.TestPending = true;
                if (step.Result != null)
                {
                    step.Result.RunTestResult = RunResult.TestPending;
                }

                if (step.StepOutputs == null)
                {
                    return;
                }
                MarkStepOutputsPending(step);
            }
        }

        static void MarkStepOutputsPending(IServiceTestStep step)
        {
            foreach (var serviceTestOutput in step.StepOutputs)
            {
                if (serviceTestOutput is ServiceTestOutput stepOutput)
                {
                    stepOutput.TestPending = true;
                    if (stepOutput.Result != null)
                    {
                        stepOutput.Result.RunTestResult = RunResult.TestPending;
                    }
                }
            }
        }

        static IServiceTestModelTO CreateServiceTestModelTo(IServiceTestModel model) => new ServiceTestModelTO
        {
            TestName = model.TestName,
            ResourceId = model.ParentId,
            AuthenticationType = model.AuthenticationType,
            Enabled = model.Enabled,
            ErrorExpected = model.ErrorExpected,
            NoErrorExpected = model.NoErrorExpected,
            ErrorContainsText = model.ErrorContainsText,
            TestSteps = model.TestSteps?.Select(step => CreateServiceTestStepTo(step, null)).ToList() ?? new List<IServiceTestStep>(),
            Inputs = model.Inputs?.Select(CreateServiceTestInputsTo).ToList() ?? new List<IServiceTestInput>(),
            Outputs = model.Outputs?.Select(CreateServiceTestOutputTo).ToList() ?? new List<IServiceTestOutput>(),
            LastRunDate = model.LastRunDate,
            OldTestName = model.OldTestName,
            Password = model.Password,
            IsDirty = model.IsDirty,
            TestPending = model.TestPending,
            UserName = model.UserName,
            TestFailing = model.TestFailing,
            TestInvalid = model.TestInvalid,
            TestPassed = model.TestPassed
        };

        static IServiceTestOutput CreateServiceTestOutputTo(IServiceTestOutput output) => new ServiceTestOutputTO
        {
            Variable = output.Variable,
            Value = output.Value,
            From = output.From,
            To = output.To,
            AssertOp = output.AssertOp,
            HasOptionsForValue = output.HasOptionsForValue,
            OptionsForValue = output.OptionsForValue
        };

        static IServiceTestInput CreateServiceTestInputsTo(IServiceTestInput input) => new ServiceTestInputTO
        {
            Variable = input.Variable,
            Value = input.Value,
            EmptyIsNull = input.EmptyIsNull
        };

        static IServiceTestStep CreateServiceTestStepTo(IServiceTestStep step, IServiceTestStep parent)
        {
            var serviceTestStepTo = new ServiceTestStepTO(step.ActivityID, step.ActivityType, step.StepOutputs.Select(CreateServiceTestStepOutputsTo).ToObservableCollection(), step.Type)
            {
                Children = new ObservableCollection<IServiceTestStep>(),
                Parent = parent,
                StepDescription = step.StepDescription
            };
            if (step.Children != null)
            {
                foreach (var serviceTestStep in step.Children)
                {
                    serviceTestStepTo.Children.Add(CreateServiceTestStepTo(serviceTestStep, serviceTestStepTo));
                }
            }
            return serviceTestStepTo;
        }

        static IServiceTestOutput CreateServiceTestStepOutputsTo(IServiceTestOutput output) => new ServiceTestOutputTO
        {
            Variable = output.Variable,
            Value = output.Value,
            From = output.From,
            To = output.To,
            AssertOp = output.AssertOp,
            HasOptionsForValue = output.HasOptionsForValue,
            OptionsForValue = output.OptionsForValue
        };

        void UpdateTestsFromResourceUpdate()
        {
            foreach (var serviceTestModel in Tests)
            {
                var runSelectedTestUrl = GetWebRunUrlForTest(serviceTestModel);
                serviceTestModel.RunSelectedTestUrl = runSelectedTestUrl;
            }
        }

        string GetWebRunUrlForTest(IServiceTestModel serviceTestModel)
        {
            var runSelectedTestUrl = ResourceModel.GetWorkflowUri("", UrlType.Tests) + "/" + serviceTestModel.TestName;
            if (serviceTestModel.AuthenticationType == AuthenticationType.Public)
            {
                runSelectedTestUrl = runSelectedTestUrl.Replace("/secure/", "/public/");
            }
            return runSelectedTestUrl;
        }

        bool ShowPopupWhenDuplicates()
        {
            if (HasDuplicates())
            {
                ShowDuplicatePopup();
                return true;
            }
            return false;
        }

        public void ShowDuplicatePopup()
        {
            PopupController?.Show(Resources.Languages.Core.ServiceTestDuplicateTestNameMessage, Resources.Languages.Core.ServiceTestDuplicateTestNameHeader, MessageBoxButton.OK, MessageBoxImage.Error, null, false, true, false, false, false, false);
        }

        public void RefreshCommands()
        {
            ViewModelUtils.RaiseCanExecuteChanged(RunAllTestsCommand);
            ViewModelUtils.RaiseCanExecuteChanged(RunAllTestsInBrowserCommand);
            ViewModelUtils.RaiseCanExecuteChanged(RunSelectedTestCommand);
            ViewModelUtils.RaiseCanExecuteChanged(RunSelectedTestInBrowserCommand);
            _dirty = IsDirty;
            OnPropertyChanged(() => IsDirty);
            OnPropertyChanged(() => DisplayName);
            SetDisplayName(_dirty);
        }

        public bool HasDuplicates() => RealTests().ToList().GroupBy(x => x.TestName).Where(group => @group.Count() > 1).Select(group => @group.Key).Any();

        void SetSelectedTestUrl()
        {
            var runSelectedTestUrl = GetWebRunUrlForTest(SelectedServiceTest);
            SelectedServiceTest.RunSelectedTestUrl = runSelectedTestUrl;
        }

        void MarkTestsAsNotNew()
        {
            foreach (var model in _tests.Where(model => model.NewTest))
            {
                model.NewTest = false;
            }
            foreach (var model in RealTests())
            {
                var clone = model.Clone();
                model.SetItem(clone);
                model.ResetOldTestName();
            }
        }

        public IContextualResourceModel ResourceModel
        {
            get => _resourceModel;
            private set => _resourceModel = value;
        }

        public IServiceTestModel SelectedServiceTest
        {
            get => _selectedServiceTest;
            set
            {
                if (value == null)
                {
                    if (_selectedServiceTest != null)
                    {
                        _selectedServiceTest.PropertyChanged -= ActionsForPropChanges;
                    }

                    _selectedServiceTest = null;
                    EventPublisher.Publish(new DebugOutputMessage(new List<IDebugState>()));
                    OnPropertyChanged(() => SelectedServiceTest);
                    return;
                }
                if (Equals(_selectedServiceTest, value) || value.IsNewTest)
                {
                    return;
                }
                if (_selectedServiceTest != null)
                {
                    _selectedServiceTest.PropertyChanged -= ActionsForPropChanges;
                }

                _selectedServiceTest = value;
                _selectedServiceTest.IsTestLoading = true;
                _selectedServiceTest.PropertyChanged += ActionsForPropChanges;

                var serviceTestSteps = _selectedServiceTest?.TestSteps?.Flatten(step => step.Children ?? new ObservableCollection<IServiceTestStep>());
                if (serviceTestSteps != null)
                {
                    foreach (var serviceTestOutput in serviceTestSteps.Where(serviceTestStep => serviceTestStep?.StepOutputs != null).SelectMany(serviceTestStep => serviceTestStep.StepOutputs))
                    {
                        ((ServiceTestOutput)serviceTestOutput).PropertyChanged += OnStepOutputPropertyChanges;
                    }
                }
                SetSelectedTestUrl();
                SetDuplicateTestTooltip();
                OnPropertyChanged(() => SelectedServiceTest);
                EventPublisher.Publish(new DebugOutputMessage(_selectedServiceTest?.DebugForTest ?? new List<IDebugState>()));
                if (_selectedServiceTest != null)
                {
                    _selectedServiceTest.IsTestLoading = false;
                }
            }
        }

        void OnStepOutputPropertyChanges(object sender, PropertyChangedEventArgs e)
        {
            ViewModelUtils.RaiseCanExecuteChanged(RunSelectedTestInBrowserCommand);
            _dirty = IsDirty;
            OnPropertyChanged(() => IsDirty);
        }

        void ActionsForPropChanges(object sender, PropertyChangedEventArgs e)
        {
            if (e.PropertyName == "Enabled")
            {
                ViewModelUtils.RaiseCanExecuteChanged(DeleteTestCommand);
            }
            if (e.PropertyName == "IsDirty")
            {
                ViewModelUtils.RaiseCanExecuteChanged(RunSelectedTestInBrowserCommand);
                _dirty = IsDirty;
                OnPropertyChanged(() => IsDirty);
            }
            if (e.PropertyName == "Inputs" || e.PropertyName == "Outputs")
            {
                ViewModelUtils.RaiseCanExecuteChanged(RunSelectedTestInBrowserCommand);
            }
            if (e.PropertyName == "RunSelectedTestUrl")
            {
                ViewModelUtils.RaiseCanExecuteChanged(RunSelectedTestInBrowserCommand);
            }
            if (e.PropertyName == "DebugForTest")
            {
                EventPublisher.Publish(new DebugOutputMessage(SelectedServiceTest?.DebugForTest ?? new List<IDebugState>()));
            }
            if (e.PropertyName == "TestName")
            {
                _dirty = IsDirty;
                OnPropertyChanged(() => IsDirty);
            }
            ViewModelUtils.RaiseCanExecuteChanged(DuplicateTestCommand);
        }

        void SetDisplayName(bool isDirty)
        {
            if (isDirty)
            {
                if (!DisplayName.EndsWith(" *"))
                {
                    DisplayName += " *";
                }
            }
            else
            {
                DisplayName = _displayName.Replace("*", "").TrimEnd(' ');
            }
        }

        public IServiceTestCommandHandler ServiceTestCommandHandler { get; set; }

        public string RunAllTestsUrl
        {
            get => _runAllTestsUrl;
            set
            {
                _runAllTestsUrl = value;
                OnPropertyChanged(() => RunAllTestsUrl);
            }
        }

        public string RunAllCoverageUrl
        {
            get => _runAllCoverageUrl;
            set
            {
                _runAllCoverageUrl = value;
                OnPropertyChanged(() => RunAllCoverageUrl);
            }
        }

        public string TestPassingResult
        {
            get => _testPassingResult;
            set
            {
                _testPassingResult = value;
                OnPropertyChanged(() => TestPassingResult);
            }
        }

        IEnumerable<IServiceTestModel> RealTests() => _tests.Where(model => model.GetType() != typeof(DummyServiceTest)).ToObservableCollection();

        public ObservableCollection<IServiceTestModel> Tests
        {
            get => _tests;
            set
            {
                _tests = value;
                OnPropertyChanged(() => Tests);
            }
        }

        void DeleteTest(IServiceTestModel test)
        {
            if (test == null)
            {
                return;
            }

            var nameOfItemBeingDeleted = test.NameForDisplay.Replace("*", "").TrimEnd(' ');
            if (PopupController.ShowDeleteConfirmation(nameOfItemBeingDeleted) == MessageBoxResult.Yes)
            {
                try
                {
                    if (!test.IsNewTest)
                    {
                        ResourceModel.Environment.ResourceRepository.DeleteResourceTest(ResourceModel.ID, test.TestName);
                    }
                    _tests.Remove(test);
                    OnPropertyChanged(() => Tests);
                    SelectedServiceTest = null;
                    if (Tests.Count == 1 && Tests.Single().GetType() == typeof(DummyServiceTest))
                    {
                        CanSave = false;
                    }
                }
                catch (Exception ex)
                {
                    Dev2Logger.Error("IServiceTestModelTO DeleteTest(IServiceTestModel model)", ex, GlobalConstants.WarewolfError);
                }
            }
            if (_tests.Count == 1 && _tests.Single().GetType() == typeof(DummyServiceTest))
            {
                CanSave = false;
            }
        }

        void DeleteTestStep(IServiceTestStep testStep)
        {
            if (testStep == null)
            {
                return;
            }

            DeleteStep(testStep, SelectedServiceTest.TestSteps);
        }

        static void DeleteStep(IServiceTestStep testStep, ObservableCollection<IServiceTestStep> serviceTestSteps)
        {
            if (serviceTestSteps.Contains(testStep))
            {
                serviceTestSteps.Remove(testStep);
            }
            else
            {
                var foundParentStep = serviceTestSteps.FirstOrDefault(step => step.ActivityID == testStep.Parent?.ActivityID);
                foundParentStep?.Children?.Remove(testStep);
            }
        }

        ObservableCollection<IServiceTestModel> GetTests()
        {
            try
            {
                var serviceTestModels = new List<ServiceTestModel>();
                var loadResourceTests = ResourceModel.Environment.ResourceRepository.LoadResourceTests(ResourceModel.ID);
                if (loadResourceTests != null)
                {
                    foreach (var test in loadResourceTests)
                    {
                        var serviceTestModel = ToServiceTestModel(test);
                        serviceTestModel.Item = (ServiceTestModel)serviceTestModel.Clone();
                        serviceTestModels.Add(serviceTestModel);
                    }
                }
                return serviceTestModels.ToObservableCollection<IServiceTestModel>();
            }
            catch (Exception)
            {
                return new ObservableCollection<IServiceTestModel>();
            }
        }

        public ServiceTestModel ToServiceTestModel(IServiceTestModelTO to)
        {
            var serviceTestModel = new ServiceTestModel(ResourceModel.ID)
            {
                OldTestName = to.TestName,
                TestName = to.TestName,
                IsTestRunning = false,
                NameForDisplay = to.TestName,
                UserName = to.UserName,
                AuthenticationType = to.AuthenticationType,
                Enabled = to.Enabled,
                ErrorExpected = to.ErrorExpected,
                NoErrorExpected = to.NoErrorExpected,
                ErrorContainsText = to.ErrorContainsText,
                LastRunDate = to.LastRunDate,
                TestInvalid = to.TestInvalid,
                TestPending = to.TestPending,
                TestFailing = to.TestFailing,
                TestPassed = to.TestPassed,
                Password = to.Password,
                ParentId = to.ResourceId,
                TestSteps = to.TestSteps?.Select(step => CreateServiceTestStep(step) as IServiceTestStep).ToObservableCollection(),
                Inputs = to.Inputs?.Select(CreateInput).ToObservableCollection(),
                Outputs = to.Outputs?.Select(CreateOutput).ToObservableCollection()
            };
            return serviceTestModel;
        }

        static IServiceTestOutput CreateOutput(IServiceTestOutput output)
        {
            var serviceTestOutput = new ServiceTestOutput(output.Variable, output.Value, output.From, output.To) as IServiceTestOutput;
            serviceTestOutput.AssertOp = output.AssertOp;
            serviceTestOutput.Result = output.Result;
            return serviceTestOutput;
        }

        static IServiceTestInput CreateInput(IServiceTestInput input)
        {
            var serviceTestInput = new ServiceTestInput(input.Variable, input.Value) as IServiceTestInput;
            serviceTestInput.EmptyIsNull = input.EmptyIsNull;
            return serviceTestInput;
        }

        IServiceTestStep CreateServiceTestStep(IServiceTestStep step)
        {
            var testStep = new ServiceTestStep(step.ActivityID, step.ActivityType, new ObservableCollection<IServiceTestOutput>(), step.Type)
            {
                Children = new ObservableCollection<IServiceTestStep>(),
                Parent = step.Parent,
                StepDescription = step.StepDescription,
                Result = step.Result
            };
            testStep.StepOutputs = CreateServiceTestOutputFromStep(step.StepOutputs, testStep);
            if (testStep.MockSelected)
            {
                testStep.TestPending = false;
                testStep.TestPassed = false;
                testStep.TestFailing = false;
                testStep.TestInvalid = false;
            }
            SetStepIcon(testStep.ActivityType, testStep);

            if (step.Children != null)
            {
                foreach (var serviceTestStep in step.Children)
                {
                    testStep.Children.Add(CreateServiceTestStep(serviceTestStep));
                }
            }
            return testStep;
        }

        static ObservableCollection<IServiceTestOutput> CreateServiceTestOutputFromStep(ObservableCollection<IServiceTestOutput> stepStepOutputs, IServiceTestStep testStep)
        {
            var stepOutputs = new ObservableCollection<IServiceTestOutput>();
            foreach (var serviceTestOutput in stepStepOutputs)
            {
                var testOutput = new ServiceTestOutput(serviceTestOutput.Variable, serviceTestOutput.Value, serviceTestOutput.From, serviceTestOutput.To)
                {
                    AddStepOutputRow = testStep.AddNewOutput,
                    AssertOp = serviceTestOutput.AssertOp,
                    HasOptionsForValue = serviceTestOutput.HasOptionsForValue,
                    OptionsForValue = serviceTestOutput.OptionsForValue,
                    Result = serviceTestOutput.Result
                };
                if (testStep.MockSelected)
                {
                    testOutput.TestPending = false;
                    testOutput.TestPassed = false;
                    testOutput.TestFailing = false;
                    testOutput.TestInvalid = false;
                }

                stepOutputs.Add(testOutput);
            }
            return stepOutputs;
        }

        public ICommand DeleteTestCommand { get; set; }
        public ICommand DeleteTestStepCommand { get; set; }
        public ICommand DuplicateTestCommand { get; set; }
        public ICommand RunAllTestsInBrowserCommand { get; set; }
        public ICommand RunAllTestCoverageInBrowserCommand { get; set; }
        public ICommand RunAllTestsCommand { get; set; }
        public ICommand RunSelectedTestInBrowserCommand { get; set; }
        public ICommand RunSelectedTestCommand { get; set; }
        public ICommand StopTestCommand { get; set; }
        public ICommand CreateTestCommand { get; set; }

        public string DisplayName
        {
            get => _displayName;
            set
            {
                _displayName = value;
                OnPropertyChanged(() => DisplayName);
            }
        }

        public void Dispose()
        {
            if (ResourceModel?.Environment?.Connection != null)
            {
                ResourceModel.Environment.Connection.ReceivedResourceAffectedMessage -= OnReceivedResourceAffectedMessage;
            }
        }

        public void UpdateHelpDescriptor(string helpText)
        {
            var mainViewModel = CustomContainer.Get<IShellViewModel>();
            mainViewModel?.HelpViewModel?.UpdateHelpText(helpText);
        }
    }
}

---- Semantic diagnostics *before* transformation ----

---- Semantic diagnostics *after* transformation ----
D:\a\1\s\Dev\Warewolf.Studio.ViewModels\ServiceTestViewModel.cs(465,57): error CS0165: Use of unassigned local variable 'act',D:\a\1\s\Dev\Warewolf.Studio.ViewModels\ServiceTestViewModel.cs(506,69): error CS0165: Use of unassigned local variable 'act',D:\a\1\s\Dev\Warewolf.Studio.ViewModels\ServiceTestViewModel.cs(547,60): error CS0165: Use of unassigned local variable 'act'
######################################################################


######################################################################
Nr: 19 - UsePatternMatchingRewriterR8
Filepath: D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs
Description: Error: The created Syntax Tree is semantically incorrect.
------------------------------------------------------------------------
---- Original Tree ----
using System;
using System.ComponentModel;
using System.Diagnostics;
using System.Linq;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Navigation;
using Warewolf.Studio.Core;
using Warewolf.Studio.ViewModels;

namespace Warewolf.Studio.Views
{
    public partial class MessageBoxView
    {
        readonly Grid _blackoutGrid = new Grid();
        bool _openDependencyGraph;
        public bool OpenDependencyGraph => _openDependencyGraph;

        public MessageBoxView()
        {
            InitializeComponent();
            PopupViewManageEffects.AddBlackOutEffect(_blackoutGrid);
        }

        void MessageBoxView_OnClosing(object sender, CancelEventArgs e)
        {
            PopupViewManageEffects.RemoveBlackOutEffect(_blackoutGrid);
        }

        void BtnDependencies_OnClick(object sender, RoutedEventArgs e)
        {
            _openDependencyGraph = true;
            DialogResult = false;
        }

        void Hyperlink_OnRequestNavigate(object sender, RequestNavigateEventArgs e)
        {
            if (sender is Hyperlink resourcePath)
            {
                var listStrLineElements = resourcePath.NavigateUri.OriginalString.Split(new[] { "\r\n" }, StringSplitOptions.RemoveEmptyEntries).ToList();

                for (int i = 1; i < listStrLineElements.Count; i++)
                {
                    Process.Start("explorer.exe", "/select," + listStrLineElements[i]);
                }
            }
        }

        void MessageBoxView_OnLoaded(object sender, RoutedEventArgs e)
        {
            var messageBoxViewModel = DataContext as MessageBoxViewModel;
            if (messageBoxViewModel != null && messageBoxViewModel.IsYesButtonVisible)
            {
                BtnYesCommand.Focusable = true;
                BtnYesCommand.Focus();
            }
            if (messageBoxViewModel != null && messageBoxViewModel.IsOkButtonVisible)
            {
                BtnOkCommand.Focusable = true;
                BtnOkCommand.Focus();
            }
        }

        void MessageBoxView_OnKeyDown(object sender, KeyEventArgs e)
        {
            if (e.Key == Key.Escape)
            {
                Close();
            }
        }

#pragma warning disable S1541 // Methods and properties should not be too complex
        void MessageBoxView_OnPreviewKeyDown(object sender, KeyEventArgs e)
#pragma warning restore S1541 // Methods and properties should not be too complex
        {
            if ((Keyboard.Modifiers == (ModifierKeys.Alt | ModifierKeys.Control)) && (e.Key == Key.F4) && Application.Current != null)
            {
                CloseAllWindows();
            }

            if (e.Key == Key.Escape)
            {
                var messageBoxViewModel = DataContext as MessageBoxViewModel;
                if (messageBoxViewModel != null && messageBoxViewModel.IsYesButtonVisible)
                {
                    BtnYesCommand.Focusable = false;
                    BtnYesCommand.Focus();
                }
                if (messageBoxViewModel != null && messageBoxViewModel.IsOkButtonVisible)
                {
                    BtnOkCommand.Focusable = false;
                    BtnOkCommand.Focus();
                }
                if (messageBoxViewModel != null && messageBoxViewModel.IsCancelButtonVisible)
                {
                    BtnCancelCommand.Focusable = true;
                    BtnCancelCommand.Focus();
                }
                if (messageBoxViewModel != null && messageBoxViewModel.IsNoButtonVisible)
                {
                    BtnNoCommand.Focusable = true;
                    BtnNoCommand.Focus();
                }
            }
        }

        private static void CloseAllWindows()
        {
            var windowCollection = Application.Current.Windows;
            foreach (var window in windowCollection)
            {
                if (window is Window window1 && window1.Name != "MainViewWindow")
                {
                    window1.Close();
                }
            }
        }

        void BtnDeleteAll_OnClick(object sender, RoutedEventArgs e)
        {
            if (DataContext is MessageBoxViewModel messageBoxViewModel)
            {
                messageBoxViewModel.IsDeleteAnywaySelected = true;
            }
            DialogResult = false;
        }
    }
}

---- Transformed Tree ----
using System;
using System.ComponentModel;
using System.Diagnostics;
using System.Linq;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Navigation;
using Warewolf.Studio.Core;
using Warewolf.Studio.ViewModels;

namespace Warewolf.Studio.Views
{
    public partial class MessageBoxView
    {
        readonly Grid _blackoutGrid = new Grid();
        bool _openDependencyGraph;
        public bool OpenDependencyGraph => _openDependencyGraph;

        public MessageBoxView()
        {
            InitializeComponent();
            PopupViewManageEffects.AddBlackOutEffect(_blackoutGrid);
        }

        void MessageBoxView_OnClosing(object sender, CancelEventArgs e)
        {
            PopupViewManageEffects.RemoveBlackOutEffect(_blackoutGrid);
        }

        void BtnDependencies_OnClick(object sender, RoutedEventArgs e)
        {
            _openDependencyGraph = true;
            DialogResult = false;
        }

        void Hyperlink_OnRequestNavigate(object sender, RequestNavigateEventArgs e)
        {
            if (sender is Hyperlink resourcePath)
            {
                var listStrLineElements = resourcePath.NavigateUri.OriginalString.Split(new[] { "\r\n" }, StringSplitOptions.RemoveEmptyEntries).ToList();

                for (int i = 1; i < listStrLineElements.Count; i++)
                {
                    Process.Start("explorer.exe", "/select," + listStrLineElements[i]);
                }
            }
        }

        void MessageBoxView_OnLoaded(object sender, RoutedEventArgs e)
        {
            if (DataContext is MessageBoxViewModel messageBoxViewModel && messageBoxViewModel.IsYesButtonVisible)
            {
                BtnYesCommand.Focusable = true;
                BtnYesCommand.Focus();
            }

            if (DataContext is MessageBoxViewModel messageBoxViewModel && messageBoxViewModel.IsOkButtonVisible)
            {
                BtnOkCommand.Focusable = true;
                BtnOkCommand.Focus();
            }
        }

        void MessageBoxView_OnKeyDown(object sender, KeyEventArgs e)
        {
            if (e.Key == Key.Escape)
            {
                Close();
            }
        }

#pragma warning disable S1541 // Methods and properties should not be too complex
        void MessageBoxView_OnPreviewKeyDown(object sender, KeyEventArgs e)
#pragma warning restore S1541 // Methods and properties should not be too complex
        {
            if ((Keyboard.Modifiers == (ModifierKeys.Alt | ModifierKeys.Control)) && (e.Key == Key.F4) && Application.Current != null)
            {
                CloseAllWindows();
            }

            if (e.Key == Key.Escape)
            {
                if (DataContext is MessageBoxViewModel messageBoxViewModel && messageBoxViewModel.IsYesButtonVisible)
                {
                    BtnYesCommand.Focusable = false;
                    BtnYesCommand.Focus();
                }

                if (DataContext is MessageBoxViewModel messageBoxViewModel && messageBoxViewModel.IsOkButtonVisible)
                {
                    BtnOkCommand.Focusable = false;
                    BtnOkCommand.Focus();
                }

                if (DataContext is MessageBoxViewModel messageBoxViewModel && messageBoxViewModel.IsCancelButtonVisible)
                {
                    BtnCancelCommand.Focusable = true;
                    BtnCancelCommand.Focus();
                }

                if (DataContext is MessageBoxViewModel messageBoxViewModel && messageBoxViewModel.IsNoButtonVisible)
                {
                    BtnNoCommand.Focusable = true;
                    BtnNoCommand.Focus();
                }
            }
        }

        private static void CloseAllWindows()
        {
            var windowCollection = Application.Current.Windows;
            foreach (var window in windowCollection)
            {
                if (window is Window window1 && window1.Name != "MainViewWindow")
                {
                    window1.Close();
                }
            }
        }

        void BtnDeleteAll_OnClick(object sender, RoutedEventArgs e)
        {
            if (DataContext is MessageBoxViewModel messageBoxViewModel)
            {
                messageBoxViewModel.IsDeleteAnywaySelected = true;
            }
            DialogResult = false;
        }
    }
}

---- Semantic diagnostics *before* transformation ----
D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(24,13): error CS0103: The name 'InitializeComponent' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(36,13): error CS0103: The name 'DialogResult' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(54,39): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(57,17): error CS0103: The name 'BtnYesCommand' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(58,17): error CS0103: The name 'BtnYesCommand' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(62,17): error CS0103: The name 'BtnOkCommand' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(63,17): error CS0103: The name 'BtnOkCommand' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(71,17): error CS0103: The name 'Close' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(86,43): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(89,21): error CS0103: The name 'BtnYesCommand' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(90,21): error CS0103: The name 'BtnYesCommand' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(94,21): error CS0103: The name 'BtnOkCommand' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(95,21): error CS0103: The name 'BtnOkCommand' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(99,21): error CS0103: The name 'BtnCancelCommand' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(100,21): error CS0103: The name 'BtnCancelCommand' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(104,21): error CS0103: The name 'BtnNoCommand' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(105,21): error CS0103: The name 'BtnNoCommand' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(124,17): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(128,13): error CS0103: The name 'DialogResult' does not exist in the current context
---- Semantic diagnostics *after* transformation ----
D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(24,13): error CS0103: The name 'InitializeComponent' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(36,13): error CS0103: The name 'DialogResult' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(54,17): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(56,17): error CS0103: The name 'BtnYesCommand' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(57,17): error CS0103: The name 'BtnYesCommand' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(60,17): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(60,52): error CS0128: A local variable or function named 'messageBoxViewModel' is already defined in this scope,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(62,17): error CS0103: The name 'BtnOkCommand' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(63,17): error CS0103: The name 'BtnOkCommand' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(60,75): error CS0165: Use of unassigned local variable 'messageBoxViewModel',D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(71,17): error CS0103: The name 'Close' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(86,21): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(88,21): error CS0103: The name 'BtnYesCommand' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(89,21): error CS0103: The name 'BtnYesCommand' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(92,21): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(92,56): error CS0128: A local variable or function named 'messageBoxViewModel' is already defined in this scope,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(94,21): error CS0103: The name 'BtnOkCommand' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(95,21): error CS0103: The name 'BtnOkCommand' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(98,21): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(98,56): error CS0128: A local variable or function named 'messageBoxViewModel' is already defined in this scope,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(100,21): error CS0103: The name 'BtnCancelCommand' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(101,21): error CS0103: The name 'BtnCancelCommand' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(104,21): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(104,56): error CS0128: A local variable or function named 'messageBoxViewModel' is already defined in this scope,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(106,21): error CS0103: The name 'BtnNoCommand' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(107,21): error CS0103: The name 'BtnNoCommand' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(92,79): error CS0165: Use of unassigned local variable 'messageBoxViewModel',D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(126,17): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\MessageBoxView.xaml.cs(130,13): error CS0103: The name 'DialogResult' does not exist in the current context
######################################################################


######################################################################
Nr: 20 - UsePatternMatchingRewriterR8
Filepath: D:\a\1\s\Dev\Warewolf.Studio.Views\ServiceTestView.xaml.cs
Description: Error: The created Syntax Tree is semantically incorrect.
------------------------------------------------------------------------
---- Original Tree ----
using System.Activities.Presentation;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Controls.Primitives;
using System.Windows.Input;
using System.Windows.Media;
using Dev2.Studio.Interfaces;
using Dev2.UI;
using Microsoft.Practices.Prism.Mvvm;
using Warewolf.Studio.ViewModels;

namespace Warewolf.Studio.Views
{
    public partial class ServiceTestView : IView
    {
        public ServiceTestView()
        {
            InitializeComponent();
            WorkflowControl.PreviewMouseLeftButtonUp += WorkflowDesignerViewPreviewMouseUp;
            PreviewDragOver += DropPointOnDragEnter;
            PreviewDrop += DropPointOnDragEnter;
        }

        void DropPointOnDragEnter(object sender, DragEventArgs e)
        {
            if (sender != null)
            {
                e.Effects = DragDropEffects.None;
                e.Handled = true;
            }
        }

        void WorkflowDesignerViewPreviewMouseUp(object sender, MouseButtonEventArgs e)
        {
            if (e.ChangedButton == MouseButton.Left)
            {
                InvokeParentModelItem(e.OriginalSource as DependencyObject);
            }
        }

        void InvokeParentModelItem(DependencyObject node)
        {
            while (node != null)
            {
                if (node is WorkflowViewElement)
                {
                    var dt = DataContext as ServiceTestViewModel;
                    var wd = dt?.WorkflowDesignerViewModel;
                    var designer = node as WorkflowViewElement;
                    var modelItem = designer.ModelItem;
                    if (wd != null && wd.IsTestView && modelItem != null)
                    {
                        wd.ItemSelectedAction?.Invoke(modelItem);
                    }
                    break;
                }
                node = node is Visual ? VisualTreeHelper.GetParent(node) : null;
            }
        }

        void ToggleButton_OnChecked(object sender, RoutedEventArgs e)
        {

            if (sender is ToggleButton control)
            {
                RefreshCommands(e);
            }
        }

        void RefreshCommands(RoutedEventArgs e)
        {
            var serviceTestViewModel = DataContext as IServiceTestViewModel;
            serviceTestViewModel?.RefreshCommands();
            e.Handled = true;
        }

        void SelectedTestCheckBox_OnPreviewMouseLeftButtonDown(object sender, MouseButtonEventArgs e)
        {
            if (sender is CheckBox cb)
            {
                var item = cb.DataContext;
                TestsListbox.SelectedItem = item;
            }
        }

        void SelectedTestRunTestButton_OnPreviewMouseLeftButtonDown(object sender, MouseButtonEventArgs e)
        {
            if (sender is Button btn)
            {
                var item = btn.DataContext;
                TestsListbox.SelectedItem = item;
            }
        }

        void MainGrid_OnMouseLeftButtonUp(object sender, MouseButtonEventArgs e)
        {
            var serviceTestViewModel = DataContext as IServiceTestViewModel;
            serviceTestViewModel?.UpdateHelpDescriptor(Studio.Resources.Languages.HelpText.ServiceTestGenericHelpText);
            e.Handled = true;
        }

        void ListBoxItemGrid_OnMouseLeftButtonUp(object sender, MouseButtonEventArgs e)
        {
            var serviceTestViewModel = DataContext as IServiceTestViewModel;
            serviceTestViewModel?.UpdateHelpDescriptor(Studio.Resources.Languages.HelpText.ServiceTestSelectedTestHelpText);
            e.Handled = true;
        }

        void AutoCompleteBox_OnTextChanged(object sender, RoutedEventArgs e)
        {
            var textBox = sender as IntellisenseTextBox;
            if (textBox != null)
            {
                RefreshCommands(e);
            }

            if (textBox == null && sender is TextBox box)
            {
                RefreshCommands(e);
            }
        }

        void Selector_OnSelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            var routedEventArgs = new RoutedEventArgs(e.RoutedEvent);
            RefreshCommands(routedEventArgs);
            e.Handled = true;
        }
    }
}

---- Transformed Tree ----
using System.Activities.Presentation;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Controls.Primitives;
using System.Windows.Input;
using System.Windows.Media;
using Dev2.Studio.Interfaces;
using Dev2.UI;
using Microsoft.Practices.Prism.Mvvm;
using Warewolf.Studio.ViewModels;

namespace Warewolf.Studio.Views
{
    public partial class ServiceTestView : IView
    {
        public ServiceTestView()
        {
            InitializeComponent();
            WorkflowControl.PreviewMouseLeftButtonUp += WorkflowDesignerViewPreviewMouseUp;
            PreviewDragOver += DropPointOnDragEnter;
            PreviewDrop += DropPointOnDragEnter;
        }

        void DropPointOnDragEnter(object sender, DragEventArgs e)
        {
            if (sender != null)
            {
                e.Effects = DragDropEffects.None;
                e.Handled = true;
            }
        }

        void WorkflowDesignerViewPreviewMouseUp(object sender, MouseButtonEventArgs e)
        {
            if (e.ChangedButton == MouseButton.Left)
            {
                InvokeParentModelItem(e.OriginalSource as DependencyObject);
            }
        }

        void InvokeParentModelItem(DependencyObject node)
        {
            while (node != null)
            {
                if (node is WorkflowViewElement)
                {
                    var dt = DataContext as ServiceTestViewModel;
                    var wd = dt?.WorkflowDesignerViewModel;
                    var designer = node as WorkflowViewElement;
                    var modelItem = designer.ModelItem;
                    if (wd != null && wd.IsTestView && modelItem != null)
                    {
                        wd.ItemSelectedAction?.Invoke(modelItem);
                    }
                    break;
                }
                node = node is Visual ? VisualTreeHelper.GetParent(node) : null;
            }
        }

        void ToggleButton_OnChecked(object sender, RoutedEventArgs e)
        {

            if (sender is ToggleButton control)
            {
                RefreshCommands(e);
            }
        }

        void RefreshCommands(RoutedEventArgs e)
        {
            var serviceTestViewModel = DataContext as IServiceTestViewModel;
            serviceTestViewModel?.RefreshCommands();
            e.Handled = true;
        }

        void SelectedTestCheckBox_OnPreviewMouseLeftButtonDown(object sender, MouseButtonEventArgs e)
        {
            if (sender is CheckBox cb)
            {
                var item = cb.DataContext;
                TestsListbox.SelectedItem = item;
            }
        }

        void SelectedTestRunTestButton_OnPreviewMouseLeftButtonDown(object sender, MouseButtonEventArgs e)
        {
            if (sender is Button btn)
            {
                var item = btn.DataContext;
                TestsListbox.SelectedItem = item;
            }
        }

        void MainGrid_OnMouseLeftButtonUp(object sender, MouseButtonEventArgs e)
        {
            var serviceTestViewModel = DataContext as IServiceTestViewModel;
            serviceTestViewModel?.UpdateHelpDescriptor(Studio.Resources.Languages.HelpText.ServiceTestGenericHelpText);
            e.Handled = true;
        }

        void ListBoxItemGrid_OnMouseLeftButtonUp(object sender, MouseButtonEventArgs e)
        {
            var serviceTestViewModel = DataContext as IServiceTestViewModel;
            serviceTestViewModel?.UpdateHelpDescriptor(Studio.Resources.Languages.HelpText.ServiceTestSelectedTestHelpText);
            e.Handled = true;
        }

        void AutoCompleteBox_OnTextChanged(object sender, RoutedEventArgs e)
        {
            if (sender is IntellisenseTextBox textBox)
            {
                RefreshCommands(e);
            }

            if (textBox == null && sender is TextBox box)
            {
                RefreshCommands(e);
            }
        }

        void Selector_OnSelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            var routedEventArgs = new RoutedEventArgs(e.RoutedEvent);
            RefreshCommands(routedEventArgs);
            e.Handled = true;
        }
    }
}

---- Semantic diagnostics *before* transformation ----
D:\a\1\s\Dev\Warewolf.Studio.Views\ServiceTestView.xaml.cs(15,44): error CS0535: 'ServiceTestView' does not implement interface member 'IView.DataContext',D:\a\1\s\Dev\Warewolf.Studio.Views\ServiceTestView.xaml.cs(19,13): error CS0103: The name 'InitializeComponent' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\ServiceTestView.xaml.cs(20,13): error CS0103: The name 'WorkflowControl' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\ServiceTestView.xaml.cs(21,13): error CS0103: The name 'PreviewDragOver' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\ServiceTestView.xaml.cs(22,13): error CS0103: The name 'PreviewDrop' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\ServiceTestView.xaml.cs(48,30): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\ServiceTestView.xaml.cs(73,40): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\ServiceTestView.xaml.cs(83,17): error CS0103: The name 'TestsListbox' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\ServiceTestView.xaml.cs(92,17): error CS0103: The name 'TestsListbox' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\ServiceTestView.xaml.cs(98,40): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\ServiceTestView.xaml.cs(105,40): error CS0103: The name 'DataContext' does not exist in the current context
---- Semantic diagnostics *after* transformation ----
D:\a\1\s\Dev\Warewolf.Studio.Views\ServiceTestView.xaml.cs(15,44): error CS0535: 'ServiceTestView' does not implement interface member 'IView.DataContext',D:\a\1\s\Dev\Warewolf.Studio.Views\ServiceTestView.xaml.cs(19,13): error CS0103: The name 'InitializeComponent' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\ServiceTestView.xaml.cs(20,13): error CS0103: The name 'WorkflowControl' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\ServiceTestView.xaml.cs(21,13): error CS0103: The name 'PreviewDragOver' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\ServiceTestView.xaml.cs(22,13): error CS0103: The name 'PreviewDrop' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\ServiceTestView.xaml.cs(48,30): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\ServiceTestView.xaml.cs(73,40): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\ServiceTestView.xaml.cs(83,17): error CS0103: The name 'TestsListbox' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\ServiceTestView.xaml.cs(92,17): error CS0103: The name 'TestsListbox' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\ServiceTestView.xaml.cs(98,40): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\ServiceTestView.xaml.cs(105,40): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Warewolf.Studio.Views\ServiceTestView.xaml.cs(117,17): error CS0165: Use of unassigned local variable 'textBox'
######################################################################


######################################################################
Nr: 21 - UsePatternMatchingRewriterR8
Filepath: D:\a\1\s\Dev\Dev2.Studio\AppResources\Behaviors\TabGroupPaneBindingBehavior.cs
Description: Error: The created Syntax Tree is semantically incorrect.
------------------------------------------------------------------------
---- Original Tree ----
using System.Collections.Generic;
using System.Linq;
using System.Windows;
using System.Windows.Input;
using System.Windows.Interactivity;
using Dev2.Studio.Core.AppResources.ExtensionMethods;
using Dev2.Studio.ViewModels;
using Dev2.Studio.ViewModels.WorkSurface;
using Infragistics.Windows.DockManager;


namespace Dev2.Studio.AppResources.Behaviors
{
    public class TabGroupPaneBindingBehavior : Behavior<TabGroupPane>
    {
        #region Private Methods
        
        List<TabGroupPane> GetAllTabGroupPanes()
        {
            _tabGroupPanes = new List<TabGroupPane>();
            _tabGroupPanes.AddRange(DocumentHost.GetDescendents().OfType<TabGroupPane>());
            return _tabGroupPanes;
        }

        #endregion Private Methods


        #region DocumentHost

        // Using a DependencyProperty as the backing store for ItemTemplate.  This enables animation, styling, binding, etc...
        public static readonly DependencyProperty DocumentHostProperty =
            DependencyProperty.Register("DocumentHost", typeof(DocumentContentHost), typeof(TabGroupPaneBindingBehavior), new PropertyMetadata(null, DocumentHostChangedCallback));

        public DocumentContentHost DocumentHost
        {
            get => (DocumentContentHost)GetValue(DocumentHostProperty);
            set => SetValue(DocumentHostProperty, value);
        }

        static void DocumentHostChangedCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e)
        {
            if (!(dependencyObject is TabGroupPaneBindingBehavior itemsControlBindingBehavior))
            {
                return;
            }

            if (e.NewValue is DocumentContentHost newValue)
            {
                newValue.ActiveDocumentChanged -= itemsControlBindingBehavior.DocumentHostOnActiveDocumentChanged;
                newValue.ActiveDocumentChanged += itemsControlBindingBehavior.DocumentHostOnActiveDocumentChanged;
                newValue.PreviewMouseLeftButtonDown -= itemsControlBindingBehavior.NewValueOnPreviewMouseLeftButtonDown;
                newValue.PreviewMouseLeftButtonDown += itemsControlBindingBehavior.NewValueOnPreviewMouseLeftButtonDown;
            }
        }

        void NewValueOnPreviewMouseLeftButtonDown(object sender, MouseButtonEventArgs mouseButtonEventArgs)
        {
            var host = sender as DocumentContentHost;
            var workSurfaceContextViewModel = host?.ActiveDocument?.DataContext as WorkSurfaceContextViewModel;

            if (_shellViewModel != null && _shellViewModel.ActiveItem != workSurfaceContextViewModel)
            {
                _shellViewModel.ActiveItem = workSurfaceContextViewModel;
            }
        }

        #endregion DocumentHost

        static List<TabGroupPane> _tabGroupPanes;
        ShellViewModel _shellViewModel;

        void ActiveItemChanged(IWorkSurfaceContextViewModel workSurfaceContextViewModel)
        {
            if (_tabGroupPanes == null || _tabGroupPanes.Count <= 0)
            {
                _tabGroupPanes = GetAllTabGroupPanes();
            }

            SetActivePane(workSurfaceContextViewModel);
        }


        static void GotFocusHandler(object sender, RoutedEventArgs routedEventArgs)
        {
            RefreshActiveEnvironment(sender);
            routedEventArgs.Handled = true;
        }

        static void RefreshActiveEnvironment(object sender)
        {
            var frameworkElement = sender as FrameworkElement;
            var vm = frameworkElement?.DataContext as ShellViewModel;
            vm?.RefreshActiveServer();
        }

        #region Event Handlers

        void DocumentHostOnActiveDocumentChanged(object sender, RoutedPropertyChangedEventArgs<ContentPane> routedPropertyChangedEventArgs)
        {
            if (DocumentHost?.DataContext is ShellViewModel mainViewModel)
            {
                if (_shellViewModel == null)
                {
                    _shellViewModel = mainViewModel;
                    _shellViewModel.ActiveItemChanged = ActiveItemChanged;
                }

                var workSurfaceContextViewModel = routedPropertyChangedEventArgs.NewValue?.DataContext as WorkSurfaceContextViewModel;
                _shellViewModel.ActiveItemChanged = null;
                _shellViewModel.ActiveItem = workSurfaceContextViewModel;
                if (workSurfaceContextViewModel != null)
                {
                    _shellViewModel.PersistTabs();
                }
                _shellViewModel.ActiveItemChanged = ActiveItemChanged;
            }
        }

        static void SetActivePane(IWorkSurfaceContextViewModel newValue)
        {
            if (_tabGroupPanes != null && _tabGroupPanes.Count > 0)
            {
                var tabGroupPane = _tabGroupPanes[0];

                foreach (var item in from object item in tabGroupPane.Items
                                     let frameworkElement = item as FrameworkElement
                                     where frameworkElement != null && frameworkElement.DataContext == newValue
                                     select item)
                {
                    if (tabGroupPane.SelectedItem != item)
                    {
                        tabGroupPane.SelectedItem = item;
                        break;
                    }
                }
                FocusManager.AddGotFocusHandler(tabGroupPane, GotFocusHandler);
            }
        }

        #endregion Event Handlers
    }
}

---- Transformed Tree ----
using System.Collections.Generic;
using System.Linq;
using System.Windows;
using System.Windows.Input;
using System.Windows.Interactivity;
using Dev2.Studio.Core.AppResources.ExtensionMethods;
using Dev2.Studio.ViewModels;
using Dev2.Studio.ViewModels.WorkSurface;
using Infragistics.Windows.DockManager;


namespace Dev2.Studio.AppResources.Behaviors
{
    public class TabGroupPaneBindingBehavior : Behavior<TabGroupPane>
    {
        #region Private Methods
        
        List<TabGroupPane> GetAllTabGroupPanes()
        {
            _tabGroupPanes = new List<TabGroupPane>();
            _tabGroupPanes.AddRange(DocumentHost.GetDescendents().OfType<TabGroupPane>());
            return _tabGroupPanes;
        }

        #endregion Private Methods


        #region DocumentHost

        // Using a DependencyProperty as the backing store for ItemTemplate.  This enables animation, styling, binding, etc...
        public static readonly DependencyProperty DocumentHostProperty =
            DependencyProperty.Register("DocumentHost", typeof(DocumentContentHost), typeof(TabGroupPaneBindingBehavior), new PropertyMetadata(null, DocumentHostChangedCallback));

        public DocumentContentHost DocumentHost
        {
            get => (DocumentContentHost)GetValue(DocumentHostProperty);
            set => SetValue(DocumentHostProperty, value);
        }

        static void DocumentHostChangedCallback(DependencyObject dependencyObject, DependencyPropertyChangedEventArgs e)
        {
            if (!(dependencyObject is TabGroupPaneBindingBehavior itemsControlBindingBehavior))
            {
                return;
            }

            if (e.NewValue is DocumentContentHost newValue)
            {
                newValue.ActiveDocumentChanged -= itemsControlBindingBehavior.DocumentHostOnActiveDocumentChanged;
                newValue.ActiveDocumentChanged += itemsControlBindingBehavior.DocumentHostOnActiveDocumentChanged;
                newValue.PreviewMouseLeftButtonDown -= itemsControlBindingBehavior.NewValueOnPreviewMouseLeftButtonDown;
                newValue.PreviewMouseLeftButtonDown += itemsControlBindingBehavior.NewValueOnPreviewMouseLeftButtonDown;
            }
        }

        void NewValueOnPreviewMouseLeftButtonDown(object sender, MouseButtonEventArgs mouseButtonEventArgs)
        {
            var host = sender as DocumentContentHost;
            var workSurfaceContextViewModel = host?.ActiveDocument?.DataContext as WorkSurfaceContextViewModel;

            if (_shellViewModel != null && _shellViewModel.ActiveItem != workSurfaceContextViewModel)
            {
                _shellViewModel.ActiveItem = workSurfaceContextViewModel;
            }
        }

        #endregion DocumentHost

        static List<TabGroupPane> _tabGroupPanes;
        ShellViewModel _shellViewModel;

        void ActiveItemChanged(IWorkSurfaceContextViewModel workSurfaceContextViewModel)
        {
            if (_tabGroupPanes == null || _tabGroupPanes.Count <= 0)
            {
                _tabGroupPanes = GetAllTabGroupPanes();
            }

            SetActivePane(workSurfaceContextViewModel);
        }


        static void GotFocusHandler(object sender, RoutedEventArgs routedEventArgs)
        {
            RefreshActiveEnvironment(sender);
            routedEventArgs.Handled = true;
        }

        static void RefreshActiveEnvironment(object sender)
        {
            var frameworkElement = sender as FrameworkElement;
            var vm = frameworkElement?.DataContext as ShellViewModel;
            vm?.RefreshActiveServer();
        }

        #region Event Handlers

        void DocumentHostOnActiveDocumentChanged(object sender, RoutedPropertyChangedEventArgs<ContentPane> routedPropertyChangedEventArgs)
        {
            if (DocumentHost?.DataContext is ShellViewModel mainViewModel)
            {
                if (_shellViewModel == null)
                {
                    _shellViewModel = mainViewModel;
                    _shellViewModel.ActiveItemChanged = ActiveItemChanged;
                }
                _shellViewModel.ActiveItemChanged = null;
                _shellViewModel.ActiveItem = workSurfaceContextViewModel;

                if (routedPropertyChangedEventArgs.NewValue?.DataContext is WorkSurfaceContextViewModel workSurfaceContextViewModel)
                {
                    _shellViewModel.PersistTabs();
                }
                _shellViewModel.ActiveItemChanged = ActiveItemChanged;
            }
        }

        static void SetActivePane(IWorkSurfaceContextViewModel newValue)
        {
            if (_tabGroupPanes != null && _tabGroupPanes.Count > 0)
            {
                var tabGroupPane = _tabGroupPanes[0];

                foreach (var item in from object item in tabGroupPane.Items
                                     let frameworkElement = item as FrameworkElement
                                     where frameworkElement != null && frameworkElement.DataContext == newValue
                                     select item)
                {
                    if (tabGroupPane.SelectedItem != item)
                    {
                        tabGroupPane.SelectedItem = item;
                        break;
                    }
                }
                FocusManager.AddGotFocusHandler(tabGroupPane, GotFocusHandler);
            }
        }

        #endregion Event Handlers
    }
}

---- Semantic diagnostics *before* transformation ----

---- Semantic diagnostics *after* transformation ----
D:\a\1\s\Dev\Dev2.Studio\AppResources\Behaviors\TabGroupPaneBindingBehavior.cs(119,46): error CS0841: Cannot use local variable 'workSurfaceContextViewModel' before it is declared
######################################################################


######################################################################
Nr: 22 - UsePatternMatchingRewriterR8
Filepath: D:\a\1\s\Dev\Dev2.Studio\Dock\ContentPaneFactory.cs
Description: Error: The created Syntax Tree is semantically incorrect.
------------------------------------------------------------------------
---- Original Tree ----
using System;
using System.Collections;
using System.ComponentModel;
using System.Diagnostics;
using System.Linq;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Input;
using Caliburn.Micro;
using Dev2.Studio.Interfaces;
using Dev2.Studio.ViewModels;
using Dev2.Studio.ViewModels.Workflow;
using Dev2.Studio.ViewModels.WorkSurface;
using Dev2.Workspaces;
using Infragistics;
using Infragistics.Windows.DockManager;
using Infragistics.Windows.DockManager.Events;


namespace Dev2.Studio.Dock
{
    public class ContentPaneFactory : ContainerFactory
    {
        DependencyObject _target;

        static ContentPaneFactory()
        {
            ContainerTypeProperty.OverrideMetadata(typeof(ContentPaneFactory), new FrameworkPropertyMetadata(typeof(ContentPane)));
        }
        
        protected override void ClearContainerForItem(DependencyObject container, object item)
        {
            if (container is ContentPane pane)
            {
                pane.Closed -= OnPaneClosed;
                pane.Closing -= OnPaneClosing;
            }

            base.ClearContainerForItem(container, item);
        }
        
        protected sealed override void OnItemInserted(DependencyObject container, object item, int index)
        {
            AddPane((ContentPane)container);
        }
        
        protected sealed override void OnItemMoved(DependencyObject container, object item, int oldIndex, int newIndex)
        {
        }
        
        protected sealed override void OnItemRemoved(DependencyObject container, object oldItem)
        {
            RemovePane((ContentPane)container);
        }
        
        protected override void PrepareContainerForItem(DependencyObject container, object item)
        {
             BindingHelper.BindPath(container, item, HeaderPath, HeaderedContentControl.HeaderProperty);
            BindingHelper.BindPath(container, item, ContentPath, ContentControl.ContentProperty);
            BindingHelper.BindPath(container, item, TabHeaderPath, ContentPane.TabHeaderProperty);

            base.PrepareContainerForItem(container, item);

            var pane = container as ContentPane;

            SetTabName(pane, item);
            
            if(pane != null)
            {
                pane.PreviewLostKeyboardFocus += pane_PreviewLostKeyboardFocus;
                pane.PreviewGotKeyboardFocus += pane_PreviewLostKeyboardFocus;
                pane.PreviewMouseDown+=PaneOnPreviewMouseDown;
                pane.Closed += OnPaneClosed;
                pane.Closing += OnPaneClosing;
                
                if (item is WorkSurfaceContextViewModel model)
                {
                    var vm = model;
                    vm.Deactivated += ViewModelDeactivated;
                }


                if (RemoveItemOnClose)
                {
                    var cv = CollectionViewSource.GetDefaultView(ItemsSource) as IEditableCollectionView;

                    pane.CloseAction = PaneCloseAction.RemovePane;

                    if(null == cv || !cv.CanRemove)
                    {
                        pane.AllowClose = false;
                    }
                }
            }
        }

        void PaneOnPreviewMouseDown(object sender, MouseButtonEventArgs mouseButtonEventArgs)
        {
            var mvm = Application.Current.MainWindow.DataContext as ShellViewModel;
            if (mvm?.ActiveItem != null)
            {
                var item = sender as ContentPane;
                var workSurfaceContextViewModel = item?.DataContext as WorkSurfaceContextViewModel;
                if (mvm.ActiveItem != workSurfaceContextViewModel)
                {
                    mvm.ActiveItem = workSurfaceContextViewModel;
                }
            }
        }

        void pane_PreviewLostKeyboardFocus(object sender, KeyboardFocusChangedEventArgs e)
        {

            if (sender is ContentPane contentPane)
            {
                var tabGroupPane = contentPane.Parent as TabGroupPane;
                var splitPane = tabGroupPane?.Parent as SplitPane;
                if (splitPane?.Parent is PaneToolWindow paneToolWindow && string.IsNullOrWhiteSpace(paneToolWindow.Title))
                {
                    var hasMainWindow = Application.Current != null && Application.Current.MainWindow != null;
                    if (hasMainWindow && Application.Current.MainWindow.DataContext != null && Application.Current.MainWindow.DataContext is ShellViewModel mainViewModel)
                    {
                        paneToolWindow.Title = mainViewModel.DisplayName;
                    }
                }
            }
        }

        void ViewModelDeactivated(object sender, DeactivationEventArgs e)
        {
            if (e.WasClosed && _target is TabGroupPane container && sender is WorkSurfaceContextViewModel model)
            {
                var toRemove = container.Items.Cast<ContentPane>().ToList()
                    .FirstOrDefault(p => p.Content != null && p.Content == model.WorkSurfaceViewModel);

                if (toRemove != null)
                {
                    RemovePane(toRemove);
                }
                if (toRemove != null &&
                    Application.Current != null &&
                    !Application.Current.Dispatcher.HasShutdownStarted)
                {
                    container.Items.Remove(toRemove);
                }
            }


        }

        void SetTabName(ContentPane pane, object item)
        {
            if (item is WorkSurfaceContextViewModel model)
            {
                var vm = model;
                pane.Name = vm.WorkSurfaceKey.ToString();
            }
            else
            {
                pane.Name = item.ToString();
            }
        }

        protected sealed override void ValidateContainerType(Type elementType)
        {
            if(!typeof(ContentPane).IsAssignableFrom(elementType))
            {
                throw new ArgumentException("ContainerType must be a ContentPane or a derived class.");
            }
            base.ValidateContainerType(elementType);
        }
        public static readonly DependencyProperty ContentPathProperty = DependencyProperty.Register("ContentPath",
            typeof(string), typeof(ContentPaneFactory), new FrameworkPropertyMetadata(null));
        
        [Description("Returns or sets the path to the property on the underlying item that should be used to provide the Content for the ContentPane.")]
        [Category("Behavior")]
        [Bindable(true)]
        public string ContentPath
        {
            get
            {
                return (string)GetValue(ContentPathProperty);
            }
            set
            {
                SetValue(ContentPathProperty, value);
            }
        }
        
        public static readonly DependencyProperty HeaderPathProperty = DependencyProperty.Register("HeaderPath",
            typeof(string), typeof(ContentPaneFactory), new FrameworkPropertyMetadata(null));
        
        [Description("Returns or sets the path to the property on the underlying item that should be used to provide the Header for the ContentPane.")]
        [Category("Behavior")]
        [Bindable(true)]
        public string HeaderPath
        {
            get
            {
                return (string)GetValue(HeaderPathProperty);
            }
            set
            {
                SetValue(HeaderPathProperty, value);
            }
        }
        
        public static readonly DependencyProperty PaneFactoryProperty =
            DependencyProperty.RegisterAttached("PaneFactory", typeof(ContentPaneFactory), typeof(ContentPaneFactory),
                new FrameworkPropertyMetadata(null,
                    OnPaneFactoryChanged));

        [AttachedPropertyBrowsableForType(typeof(DocumentContentHost))]
        [AttachedPropertyBrowsableForType(typeof(TabGroupPane))]
        [AttachedPropertyBrowsableForType(typeof(SplitPane))]
        public static ContentPaneFactory GetPaneFactory(DependencyObject d) => (ContentPaneFactory)d.GetValue(PaneFactoryProperty);

        public static void SetPaneFactory(DependencyObject d, ContentPaneFactory value)
        {
            d.SetValue(PaneFactoryProperty, value);
        }

        static void OnPaneFactoryChanged(DependencyObject d, DependencyPropertyChangedEventArgs e)
        {
            if (d is DocumentContentHost || d is TabGroupPane || d is SplitPane)
            {
                var oldFactory = (ContentPaneFactory)e.OldValue;
                var newFactory = (ContentPaneFactory)e.NewValue;

                if (oldFactory != null && oldFactory.Equals(newFactory))
                {
                    return;
                }

                if (oldFactory != null)
                {
                    oldFactory._target = null;

                    foreach (var o in oldFactory.GetElements())
                    {
                        var cp = (ContentPane)o;
                        oldFactory.RemovePane(cp);
                    }
                }

                if (newFactory != null)
                {
                    newFactory._target = d;

                    foreach (var o in newFactory.GetElements())
                    {
                        var cp = (ContentPane)o;
                        newFactory.AddPane(cp);
                    }
                }
            }
        }

        public static readonly DependencyProperty RemoveItemOnCloseProperty = DependencyProperty.Register("RemoveItemOnClose",
            typeof(bool), typeof(ContentPaneFactory), new FrameworkPropertyMetadata(KnownBoxes.TrueBox));
        
        [Description("Returns or sets a boolean indicating whether to remove the item when the pane was closed.")]
        [Category("Behavior")]
        [Bindable(true)]
        public bool RemoveItemOnClose
        {
            get
            {
                return (bool)GetValue(RemoveItemOnCloseProperty);
            }
            set
            {
                SetValue(RemoveItemOnCloseProperty, value);
            }
        }
        
        public static readonly DependencyProperty TabHeaderPathProperty = DependencyProperty.Register("TabHeaderPath",
            typeof(string), typeof(ContentPaneFactory), new FrameworkPropertyMetadata(null));
        
        [Description("Returns or sets the path to the property on the underlying item that should be used to provide the TabHeader for the ContentPane.")]
        [Category("Behavior")]
        [Bindable(true)]
        public string TabHeaderPath
        {
            get
            {
                return (string)GetValue(TabHeaderPathProperty);
            }
            set
            {
                SetValue(TabHeaderPathProperty, value);
            }
        }
        
        protected virtual void AddPane(ContentPane pane)
        {
            if (_target is DocumentContentHost host)
            {
                var sibling = GetSiblingDocument();
                TabGroupPane tgp = null;

                if (sibling != null)
                {
                    tgp = LogicalTreeHelper.GetParent(sibling) as TabGroupPane;
                    Debug.Assert(null != tgp, "Expected all documents to be within a tab group pane.");
                }

                if (null == tgp)
                {
                    var sp = new SplitPane();
                    tgp = new TabGroupPane { Name = "Z" + Guid.NewGuid().ToString("N") };
                    sp.Panes.Add(tgp);
                    var dch = host;
                    dch.Panes.Add(sp);
                }

                tgp.Items.Add(pane);
                RaiseInitializeContentPane(pane);
            }
            else
            {
                IList targetCollection = null;

                Debug.Assert(_target == null || !string.IsNullOrEmpty((string)_target.GetValue(FrameworkElement.NameProperty)),
                    "The Name should be set so the container will not be removed when all the panes have been moved elsewhere. Otherwise new panes may not be displayed.");

                if (_target is SplitPane splitPane)
                {
                    targetCollection = splitPane.Panes;
                }
                else
                {
                    if (_target is TabGroupPane target)
                    {
                        targetCollection = target.Items;
                    }
                }

                if (null != targetCollection)
                {
                    targetCollection.Add(pane);

                    RaiseInitializeContentPane(pane);
                }
            }
        }

        ContentPane GetSiblingDocument()
        {
            var dch = _target as DocumentContentHost;

            if (dch == null)
            {
                return null;
            }

            if (null != dch.ActiveDocument)
            {
                return dch.ActiveDocument;
            }

            var dm = XamDockManager.GetDockManager(dch);

            if (dm == null)
            {
                return null;
            }

            ContentPane firstDocument = null;

            foreach (ContentPane cp in dm.GetPanes(PaneNavigationOrder.VisibleOrder))
            {
                if (cp.PaneLocation != PaneLocation.Document)
                {
                    continue;
                }

                if (firstDocument == null)
                {
                    firstDocument = cp;
                }

                if (cp.Visibility != Visibility.Visible)
                {
                    continue;
                }

                return cp;
            }

            return firstDocument;
        }

        public void OnPaneClosing(object sender, PaneClosingEventArgs e)
        {
            if (sender is ContentPane contentPane)
            {
                var pane = contentPane;

                if (pane.DataContext is WorkSurfaceContextViewModel model)
                {
                    CloseCurrentWorkSurfaceWorkflowDesignerViewModel(e, model);
                }
            }
        }

        static void CloseCurrentWorkSurfaceWorkflowDesignerViewModel(PaneClosingEventArgs e, WorkSurfaceContextViewModel model)
        {
            var workflowVm = model.WorkSurfaceViewModel as IWorkflowDesignerViewModel;
            var resource = workflowVm?.ResourceModel;

            if (resource != null && !resource.IsWorkflowSaved)
            {
                CloseCurrent(e, model);
            }
            else
            {
                if (model.WorkSurfaceViewModel is IStudioTab sourceView)
                {
                    CloseCurrent(e, model);
                }
            }
        }

        static void CloseCurrent(PaneClosingEventArgs e, WorkSurfaceContextViewModel model)
        {
            var vm = model;
            vm.TryClose();
            if (vm.Parent is ShellViewModel mainVm && !mainVm.CloseCurrent)
            {
                e.Cancel = true;
            }

        }


        void OnPaneClosed(object sender, PaneClosedEventArgs e)
        {
            if (sender is ContentPane pane && IsContainerInUse(pane) && pane.CloseAction == PaneCloseAction.RemovePane)
            {
                var cv = CollectionViewSource.GetDefaultView(ItemsSource) as IEditableCollectionView;

                Debug.Assert(cv != null && cv.CanRemove, "The ContentPane is being removed from the XamDockManager but it is still referenced by the source collection and it is not possible to remove it from the source collection.");

                if (cv != null && cv.CanRemove)
                {
                    var dataItem = GetItemForContainer(pane);
                    cv.Remove(dataItem);
                    var item = pane.Content as WorkflowDesignerViewModel;
                    if (item?.ResourceModel != null)
                    {
                        WorkspaceItemRepository.Instance.Remove(item.ResourceModel);
                    }

                    item?.RemoveUnsavedWorkflowName(item.DisplayName);
                }
            }
        }

        void RaiseInitializeContentPane(ContentPane pane)
        {
            if (null == _target)
            {
                return;
            }

            var args = new InitializeContentPaneEventArgs(pane) { RoutedEvent = InitializeContentPaneEvent };
            UiElementHelper.RaiseEvent(_target, args);
        }

        protected virtual void RemovePane(ContentPane cp)
        {
            var closeProp = ContentPane.CloseActionProperty;
            if (cp == null)
            {
                return;
            }

            var oldValue = cp.ReadLocalValue(closeProp);
            BindingExpressionBase oldExpression = cp.GetBindingExpression(closeProp);

            cp.CloseAction = PaneCloseAction.RemovePane;
            
            if(oldExpression != null)
            {
                cp.SetBinding(closeProp, oldExpression.ParentBindingBase);
            }
            else if(oldValue == DependencyProperty.UnsetValue)
            {
                cp.ClearValue(closeProp);
            }
            else
            {
                cp.SetValue(closeProp, oldValue);
            }
            cp.PreviewMouseDown -= PaneOnPreviewMouseDown;
        }
        
        public static readonly RoutedEvent InitializeContentPaneEvent = EventManager.RegisterRoutedEvent("InitializeContentPane",
            RoutingStrategy.Direct, typeof(EventHandler<InitializeContentPaneEventArgs>), typeof(ContentPaneFactory));


    }
    
    public class InitializeContentPaneEventArgs : RoutedEventArgs
    {
        readonly ContentPane _pane;
        
        public InitializeContentPaneEventArgs(ContentPane pane)
        {
            _pane = pane ?? throw new ArgumentNullException(nameof(pane));
        }
                
        public ContentPane Pane => _pane;
    }
}

---- Transformed Tree ----
using System;
using System.Collections;
using System.ComponentModel;
using System.Diagnostics;
using System.Linq;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Input;
using Caliburn.Micro;
using Dev2.Studio.Interfaces;
using Dev2.Studio.ViewModels;
using Dev2.Studio.ViewModels.Workflow;
using Dev2.Studio.ViewModels.WorkSurface;
using Dev2.Workspaces;
using Infragistics;
using Infragistics.Windows.DockManager;
using Infragistics.Windows.DockManager.Events;


namespace Dev2.Studio.Dock
{
    public class ContentPaneFactory : ContainerFactory
    {
        DependencyObject _target;

        static ContentPaneFactory()
        {
            ContainerTypeProperty.OverrideMetadata(typeof(ContentPaneFactory), new FrameworkPropertyMetadata(typeof(ContentPane)));
        }
        
        protected override void ClearContainerForItem(DependencyObject container, object item)
        {
            if (container is ContentPane pane)
            {
                pane.Closed -= OnPaneClosed;
                pane.Closing -= OnPaneClosing;
            }

            base.ClearContainerForItem(container, item);
        }
        
        protected sealed override void OnItemInserted(DependencyObject container, object item, int index)
        {
            AddPane((ContentPane)container);
        }
        
        protected sealed override void OnItemMoved(DependencyObject container, object item, int oldIndex, int newIndex)
        {
        }
        
        protected sealed override void OnItemRemoved(DependencyObject container, object oldItem)
        {
            RemovePane((ContentPane)container);
        }
        
        protected override void PrepareContainerForItem(DependencyObject container, object item)
        {
             BindingHelper.BindPath(container, item, HeaderPath, HeaderedContentControl.HeaderProperty);
            BindingHelper.BindPath(container, item, ContentPath, ContentControl.ContentProperty);
            BindingHelper.BindPath(container, item, TabHeaderPath, ContentPane.TabHeaderProperty);

            base.PrepareContainerForItem(container, item);

            var pane = container as ContentPane;

            SetTabName(pane, item);
            
            if(pane != null)
            {
                pane.PreviewLostKeyboardFocus += pane_PreviewLostKeyboardFocus;
                pane.PreviewGotKeyboardFocus += pane_PreviewLostKeyboardFocus;
                pane.PreviewMouseDown+=PaneOnPreviewMouseDown;
                pane.Closed += OnPaneClosed;
                pane.Closing += OnPaneClosing;
                
                if (item is WorkSurfaceContextViewModel model)
                {
                    var vm = model;
                    vm.Deactivated += ViewModelDeactivated;
                }


                if (RemoveItemOnClose)
                {
                    var cv = CollectionViewSource.GetDefaultView(ItemsSource) as IEditableCollectionView;

                    pane.CloseAction = PaneCloseAction.RemovePane;

                    if(null == cv || !cv.CanRemove)
                    {
                        pane.AllowClose = false;
                    }
                }
            }
        }

        void PaneOnPreviewMouseDown(object sender, MouseButtonEventArgs mouseButtonEventArgs)
        {
            var mvm = Application.Current.MainWindow.DataContext as ShellViewModel;
            if (mvm?.ActiveItem != null)
            {
                var item = sender as ContentPane;
                var workSurfaceContextViewModel = item?.DataContext as WorkSurfaceContextViewModel;
                if (mvm.ActiveItem != workSurfaceContextViewModel)
                {
                    mvm.ActiveItem = workSurfaceContextViewModel;
                }
            }
        }

        void pane_PreviewLostKeyboardFocus(object sender, KeyboardFocusChangedEventArgs e)
        {

            if (sender is ContentPane contentPane)
            {
                var tabGroupPane = contentPane.Parent as TabGroupPane;
                var splitPane = tabGroupPane?.Parent as SplitPane;
                if (splitPane?.Parent is PaneToolWindow paneToolWindow && string.IsNullOrWhiteSpace(paneToolWindow.Title))
                {
                    var hasMainWindow = Application.Current != null && Application.Current.MainWindow != null;
                    if (hasMainWindow && Application.Current.MainWindow.DataContext != null && Application.Current.MainWindow.DataContext is ShellViewModel mainViewModel)
                    {
                        paneToolWindow.Title = mainViewModel.DisplayName;
                    }
                }
            }
        }

        void ViewModelDeactivated(object sender, DeactivationEventArgs e)
        {
            if (e.WasClosed && _target is TabGroupPane container && sender is WorkSurfaceContextViewModel model)
            {
                var toRemove = container.Items.Cast<ContentPane>().ToList()
                    .FirstOrDefault(p => p.Content != null && p.Content == model.WorkSurfaceViewModel);

                if (toRemove != null)
                {
                    RemovePane(toRemove);
                }
                if (toRemove != null &&
                    Application.Current != null &&
                    !Application.Current.Dispatcher.HasShutdownStarted)
                {
                    container.Items.Remove(toRemove);
                }
            }


        }

        void SetTabName(ContentPane pane, object item)
        {
            if (item is WorkSurfaceContextViewModel model)
            {
                var vm = model;
                pane.Name = vm.WorkSurfaceKey.ToString();
            }
            else
            {
                pane.Name = item.ToString();
            }
        }

        protected sealed override void ValidateContainerType(Type elementType)
        {
            if(!typeof(ContentPane).IsAssignableFrom(elementType))
            {
                throw new ArgumentException("ContainerType must be a ContentPane or a derived class.");
            }
            base.ValidateContainerType(elementType);
        }
        public static readonly DependencyProperty ContentPathProperty = DependencyProperty.Register("ContentPath",
            typeof(string), typeof(ContentPaneFactory), new FrameworkPropertyMetadata(null));
        
        [Description("Returns or sets the path to the property on the underlying item that should be used to provide the Content for the ContentPane.")]
        [Category("Behavior")]
        [Bindable(true)]
        public string ContentPath
        {
            get
            {
                return (string)GetValue(ContentPathProperty);
            }
            set
            {
                SetValue(ContentPathProperty, value);
            }
        }
        
        public static readonly DependencyProperty HeaderPathProperty = DependencyProperty.Register("HeaderPath",
            typeof(string), typeof(ContentPaneFactory), new FrameworkPropertyMetadata(null));
        
        [Description("Returns or sets the path to the property on the underlying item that should be used to provide the Header for the ContentPane.")]
        [Category("Behavior")]
        [Bindable(true)]
        public string HeaderPath
        {
            get
            {
                return (string)GetValue(HeaderPathProperty);
            }
            set
            {
                SetValue(HeaderPathProperty, value);
            }
        }
        
        public static readonly DependencyProperty PaneFactoryProperty =
            DependencyProperty.RegisterAttached("PaneFactory", typeof(ContentPaneFactory), typeof(ContentPaneFactory),
                new FrameworkPropertyMetadata(null,
                    OnPaneFactoryChanged));

        [AttachedPropertyBrowsableForType(typeof(DocumentContentHost))]
        [AttachedPropertyBrowsableForType(typeof(TabGroupPane))]
        [AttachedPropertyBrowsableForType(typeof(SplitPane))]
        public static ContentPaneFactory GetPaneFactory(DependencyObject d) => (ContentPaneFactory)d.GetValue(PaneFactoryProperty);

        public static void SetPaneFactory(DependencyObject d, ContentPaneFactory value)
        {
            d.SetValue(PaneFactoryProperty, value);
        }

        static void OnPaneFactoryChanged(DependencyObject d, DependencyPropertyChangedEventArgs e)
        {
            if (d is DocumentContentHost || d is TabGroupPane || d is SplitPane)
            {
                var oldFactory = (ContentPaneFactory)e.OldValue;
                var newFactory = (ContentPaneFactory)e.NewValue;

                if (oldFactory != null && oldFactory.Equals(newFactory))
                {
                    return;
                }

                if (oldFactory != null)
                {
                    oldFactory._target = null;

                    foreach (var o in oldFactory.GetElements())
                    {
                        var cp = (ContentPane)o;
                        oldFactory.RemovePane(cp);
                    }
                }

                if (newFactory != null)
                {
                    newFactory._target = d;

                    foreach (var o in newFactory.GetElements())
                    {
                        var cp = (ContentPane)o;
                        newFactory.AddPane(cp);
                    }
                }
            }
        }

        public static readonly DependencyProperty RemoveItemOnCloseProperty = DependencyProperty.Register("RemoveItemOnClose",
            typeof(bool), typeof(ContentPaneFactory), new FrameworkPropertyMetadata(KnownBoxes.TrueBox));
        
        [Description("Returns or sets a boolean indicating whether to remove the item when the pane was closed.")]
        [Category("Behavior")]
        [Bindable(true)]
        public bool RemoveItemOnClose
        {
            get
            {
                return (bool)GetValue(RemoveItemOnCloseProperty);
            }
            set
            {
                SetValue(RemoveItemOnCloseProperty, value);
            }
        }
        
        public static readonly DependencyProperty TabHeaderPathProperty = DependencyProperty.Register("TabHeaderPath",
            typeof(string), typeof(ContentPaneFactory), new FrameworkPropertyMetadata(null));
        
        [Description("Returns or sets the path to the property on the underlying item that should be used to provide the TabHeader for the ContentPane.")]
        [Category("Behavior")]
        [Bindable(true)]
        public string TabHeaderPath
        {
            get
            {
                return (string)GetValue(TabHeaderPathProperty);
            }
            set
            {
                SetValue(TabHeaderPathProperty, value);
            }
        }
        
        protected virtual void AddPane(ContentPane pane)
        {
            if (_target is DocumentContentHost host)
            {
                var sibling = GetSiblingDocument();
                TabGroupPane tgp = null;

                if (sibling != null)
                {
                    tgp = LogicalTreeHelper.GetParent(sibling) as TabGroupPane;
                    Debug.Assert(null != tgp, "Expected all documents to be within a tab group pane.");
                }

                if (null == tgp)
                {
                    var sp = new SplitPane();
                    tgp = new TabGroupPane { Name = "Z" + Guid.NewGuid().ToString("N") };
                    sp.Panes.Add(tgp);
                    var dch = host;
                    dch.Panes.Add(sp);
                }

                tgp.Items.Add(pane);
                RaiseInitializeContentPane(pane);
            }
            else
            {
                IList targetCollection = null;

                Debug.Assert(_target == null || !string.IsNullOrEmpty((string)_target.GetValue(FrameworkElement.NameProperty)),
                    "The Name should be set so the container will not be removed when all the panes have been moved elsewhere. Otherwise new panes may not be displayed.");

                if (_target is SplitPane splitPane)
                {
                    targetCollection = splitPane.Panes;
                }
                else
                {
                    if (_target is TabGroupPane target)
                    {
                        targetCollection = target.Items;
                    }
                }

                if (null != targetCollection)
                {
                    targetCollection.Add(pane);

                    RaiseInitializeContentPane(pane);
                }
            }
        }

        ContentPane GetSiblingDocument()
        {
            var dch = _target as DocumentContentHost;

            if (dch == null)
            {
                return null;
            }

            if (null != dch.ActiveDocument)
            {
                return dch.ActiveDocument;
            }

            var dm = XamDockManager.GetDockManager(dch);

            if (dm == null)
            {
                return null;
            }

            ContentPane firstDocument = null;

            foreach (ContentPane cp in dm.GetPanes(PaneNavigationOrder.VisibleOrder))
            {
                if (cp.PaneLocation != PaneLocation.Document)
                {
                    continue;
                }

                if (firstDocument == null)
                {
                    firstDocument = cp;
                }

                if (cp.Visibility != Visibility.Visible)
                {
                    continue;
                }

                return cp;
            }

            return firstDocument;
        }

        public void OnPaneClosing(object sender, PaneClosingEventArgs e)
        {
            if (sender is ContentPane contentPane)
            {
                var pane = contentPane;

                if (pane.DataContext is WorkSurfaceContextViewModel model)
                {
                    CloseCurrentWorkSurfaceWorkflowDesignerViewModel(e, model);
                }
            }
        }

        static void CloseCurrentWorkSurfaceWorkflowDesignerViewModel(PaneClosingEventArgs e, WorkSurfaceContextViewModel model)
        {
            var workflowVm = model.WorkSurfaceViewModel as IWorkflowDesignerViewModel;
            var resource = workflowVm?.ResourceModel;

            if (resource != null && !resource.IsWorkflowSaved)
            {
                CloseCurrent(e, model);
            }
            else
            {
                if (model.WorkSurfaceViewModel is IStudioTab sourceView)
                {
                    CloseCurrent(e, model);
                }
            }
        }

        static void CloseCurrent(PaneClosingEventArgs e, WorkSurfaceContextViewModel model)
        {
            var vm = model;
            vm.TryClose();
            if (vm.Parent is ShellViewModel mainVm && !mainVm.CloseCurrent)
            {
                e.Cancel = true;
            }

        }


        void OnPaneClosed(object sender, PaneClosedEventArgs e)
        {
            if (sender is ContentPane pane && IsContainerInUse(pane) && pane.CloseAction == PaneCloseAction.RemovePane)
            {

                Debug.Assert(CollectionViewSource.GetDefaultView(ItemsSource) is IEditableCollectionView cv && cv.CanRemove, "The ContentPane is being removed from the XamDockManager but it is still referenced by the source collection and it is not possible to remove it from the source collection.");

                if (CollectionViewSource.GetDefaultView(ItemsSource) is IEditableCollectionView cv && cv.CanRemove)
                {
                    var dataItem = GetItemForContainer(pane);
                    cv.Remove(dataItem);
                    var item = pane.Content as WorkflowDesignerViewModel;
                    if (item?.ResourceModel != null)
                    {
                        WorkspaceItemRepository.Instance.Remove(item.ResourceModel);
                    }

                    item?.RemoveUnsavedWorkflowName(item.DisplayName);
                }
            }
        }

        void RaiseInitializeContentPane(ContentPane pane)
        {
            if (null == _target)
            {
                return;
            }

            var args = new InitializeContentPaneEventArgs(pane) { RoutedEvent = InitializeContentPaneEvent };
            UiElementHelper.RaiseEvent(_target, args);
        }

        protected virtual void RemovePane(ContentPane cp)
        {
            var closeProp = ContentPane.CloseActionProperty;
            if (cp == null)
            {
                return;
            }

            var oldValue = cp.ReadLocalValue(closeProp);
            BindingExpressionBase oldExpression = cp.GetBindingExpression(closeProp);

            cp.CloseAction = PaneCloseAction.RemovePane;
            
            if(oldExpression != null)
            {
                cp.SetBinding(closeProp, oldExpression.ParentBindingBase);
            }
            else if(oldValue == DependencyProperty.UnsetValue)
            {
                cp.ClearValue(closeProp);
            }
            else
            {
                cp.SetValue(closeProp, oldValue);
            }
            cp.PreviewMouseDown -= PaneOnPreviewMouseDown;
        }
        
        public static readonly RoutedEvent InitializeContentPaneEvent = EventManager.RegisterRoutedEvent("InitializeContentPane",
            RoutingStrategy.Direct, typeof(EventHandler<InitializeContentPaneEventArgs>), typeof(ContentPaneFactory));


    }
    
    public class InitializeContentPaneEventArgs : RoutedEventArgs
    {
        readonly ContentPane _pane;
        
        public InitializeContentPaneEventArgs(ContentPane pane)
        {
            _pane = pane ?? throw new ArgumentNullException(nameof(pane));
        }
                
        public ContentPane Pane => _pane;
    }
}

---- Semantic diagnostics *before* transformation ----

---- Semantic diagnostics *after* transformation ----
D:\a\1\s\Dev\Dev2.Studio\Dock\ContentPaneFactory.cs(456,97): error CS0128: A local variable or function named 'cv' is already defined in this scope,D:\a\1\s\Dev\Dev2.Studio\Dock\ContentPaneFactory.cs(456,103): error CS0165: Use of unassigned local variable 'cv'
######################################################################


######################################################################
Nr: 23 - UsePatternMatchingRewriterR8
Filepath: D:\a\1\s\Dev\Dev2.Studio\Factory\WorkSurfaceContextFactory.cs
Description: Error: The created Syntax Tree is semantically incorrect.
------------------------------------------------------------------------
---- Original Tree ----
using System;
using Dev2.Common.ExtMethods;
using Dev2.Common.Interfaces.Studio.Controller;
using Dev2.Common.Interfaces.Threading;
using Dev2.Factory;
using Dev2.Services.Events;
using Dev2.Settings;
using Dev2.Studio.AppResources.Comparers;
using Dev2.Studio.Interfaces;
using Dev2.Studio.Interfaces.Enums;
using Dev2.Studio.ViewModels.Help;
using Dev2.Studio.ViewModels.Workflow;
using Dev2.Studio.ViewModels.WorkSurface;
using Dev2.Threading;
using Dev2.Triggers;
using Dev2.Utilities;

namespace Dev2.Studio.Factory
{
    public static class WorkSurfaceContextFactory
    {
        public static WorkSurfaceContextViewModel CreateResourceViewModel(IContextualResourceModel resourceModel) => CreateResourceViewModel(resourceModel, true, CustomContainer.Get<IPopupController>(), new AsyncWorker());
        public static WorkSurfaceContextViewModel CreateResourceViewModel(IContextualResourceModel resourceModel, bool createDesigner, IPopupController popupController, IAsyncWorker asyncWorker)
        {
            var key = WorkSurfaceKeyFactory.CreateKey(resourceModel);

            var workSurfaceVm = new WorkflowDesignerViewModel(EventPublishers.Aggregator, resourceModel, new WorkflowHelper(), popupController, asyncWorker, createDesigner);

            var contextVm = new WorkSurfaceContextViewModel(key, workSurfaceVm)
                {
                    DataListViewModel = DataListViewModelFactory.CreateDataListViewModel(resourceModel)
                };

            return contextVm;
        }


        /// <summary>
        /// Creates the work surface context view model, only use for surfaces that are unique per context.
        /// </summary>
        /// <typeparam name="T"></typeparam>
        /// <param name="vm">The vm.</param>
        /// <param name="workSurfaceContext">The work surface context.</param>
        /// <returns></returns>
        /// <author>Jurie.smit</author>
        /// <date>3/6/2013</date>
        static WorkSurfaceContextViewModel CreateUniqueWorkSurfaceContextViewModel<T>
            (T vm, WorkSurfaceContext workSurfaceContext)
            where T : IWorkSurfaceViewModel
        {

            var key = WorkSurfaceKeyFactory.CreateKey(workSurfaceContext) as WorkSurfaceKey;
            if (vm is HelpViewModel && key != null)
            {
                key.ResourceID = Guid.Empty;
            }
            if (vm is TriggersViewModel || vm is SettingsViewModel)
            {
                key = WorkSurfaceKeyFactory.CreateEnvKey(workSurfaceContext, CustomContainer.Get<IShellViewModel>().ActiveServer.EnvironmentID) as WorkSurfaceKey;
            }

            return CreateWorkSurfaceContextViewModel(vm, workSurfaceContext, key);
        }

        static WorkSurfaceContextViewModel CreateWorkSurfaceContextViewModel<T>(T vm,
                                                                                        WorkSurfaceContext workSurfaceContext,
                                                                                        WorkSurfaceKey key)
            where T : IWorkSurfaceViewModel
        {
            var context = new WorkSurfaceContextViewModel(key, vm);

            if (!(vm is TriggersViewModel) && !(vm is SettingsViewModel))
            {
                vm.DisplayName = workSurfaceContext.GetDescription();
            }

            vm.WorkSurfaceContext = workSurfaceContext;
            return context;
        }

        public static WorkSurfaceContextViewModel Create<T>(WorkSurfaceContext workSurfaceContext, out T vmr)
            where T : IWorkSurfaceViewModel
        {
            var vm = Activator.CreateInstance<T>();
            var context = CreateUniqueWorkSurfaceContextViewModel(vm, workSurfaceContext);

            vmr = vm;
            return context;
        }
    }
}

---- Transformed Tree ----
using System;
using Dev2.Common.ExtMethods;
using Dev2.Common.Interfaces.Studio.Controller;
using Dev2.Common.Interfaces.Threading;
using Dev2.Factory;
using Dev2.Services.Events;
using Dev2.Settings;
using Dev2.Studio.AppResources.Comparers;
using Dev2.Studio.Interfaces;
using Dev2.Studio.Interfaces.Enums;
using Dev2.Studio.ViewModels.Help;
using Dev2.Studio.ViewModels.Workflow;
using Dev2.Studio.ViewModels.WorkSurface;
using Dev2.Threading;
using Dev2.Triggers;
using Dev2.Utilities;

namespace Dev2.Studio.Factory
{
    public static class WorkSurfaceContextFactory
    {
        public static WorkSurfaceContextViewModel CreateResourceViewModel(IContextualResourceModel resourceModel) => CreateResourceViewModel(resourceModel, true, CustomContainer.Get<IPopupController>(), new AsyncWorker());
        public static WorkSurfaceContextViewModel CreateResourceViewModel(IContextualResourceModel resourceModel, bool createDesigner, IPopupController popupController, IAsyncWorker asyncWorker)
        {
            var key = WorkSurfaceKeyFactory.CreateKey(resourceModel);

            var workSurfaceVm = new WorkflowDesignerViewModel(EventPublishers.Aggregator, resourceModel, new WorkflowHelper(), popupController, asyncWorker, createDesigner);

            var contextVm = new WorkSurfaceContextViewModel(key, workSurfaceVm)
                {
                    DataListViewModel = DataListViewModelFactory.CreateDataListViewModel(resourceModel)
                };

            return contextVm;
        }


        /// <summary>
        /// Creates the work surface context view model, only use for surfaces that are unique per context.
        /// </summary>
        /// <typeparam name="T"></typeparam>
        /// <param name="vm">The vm.</param>
        /// <param name="workSurfaceContext">The work surface context.</param>
        /// <returns></returns>
        /// <author>Jurie.smit</author>
        /// <date>3/6/2013</date>
        static WorkSurfaceContextViewModel CreateUniqueWorkSurfaceContextViewModel<T>
            (T vm, WorkSurfaceContext workSurfaceContext)
            where T : IWorkSurfaceViewModel
        {
            if (vm is HelpViewModel && WorkSurfaceKeyFactory.CreateKey(workSurfaceContext) is WorkSurfaceKey key)
            {
                key.ResourceID = Guid.Empty;
            }
            if (vm is TriggersViewModel || vm is SettingsViewModel)
            {
                key = WorkSurfaceKeyFactory.CreateEnvKey(workSurfaceContext, CustomContainer.Get<IShellViewModel>().ActiveServer.EnvironmentID) as WorkSurfaceKey;
            }

            return CreateWorkSurfaceContextViewModel(vm, workSurfaceContext, key);
        }

        static WorkSurfaceContextViewModel CreateWorkSurfaceContextViewModel<T>(T vm,
                                                                                        WorkSurfaceContext workSurfaceContext,
                                                                                        WorkSurfaceKey key)
            where T : IWorkSurfaceViewModel
        {
            var context = new WorkSurfaceContextViewModel(key, vm);

            if (!(vm is TriggersViewModel) && !(vm is SettingsViewModel))
            {
                vm.DisplayName = workSurfaceContext.GetDescription();
            }

            vm.WorkSurfaceContext = workSurfaceContext;
            return context;
        }

        public static WorkSurfaceContextViewModel Create<T>(WorkSurfaceContext workSurfaceContext, out T vmr)
            where T : IWorkSurfaceViewModel
        {
            var vm = Activator.CreateInstance<T>();
            var context = CreateUniqueWorkSurfaceContextViewModel(vm, workSurfaceContext);

            vmr = vm;
            return context;
        }
    }
}

---- Semantic diagnostics *before* transformation ----

---- Semantic diagnostics *after* transformation ----
D:\a\1\s\Dev\Dev2.Studio\Factory\WorkSurfaceContextFactory.cs(70,78): error CS0165: Use of unassigned local variable 'key'
######################################################################


######################################################################
Nr: 24 - UsePatternMatchingRewriterR8
Filepath: D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs
Description: Error: The created Syntax Tree is semantically incorrect.
------------------------------------------------------------------------
---- Original Tree ----
using System;
using System.Collections.Generic;
using System.Windows;
using System.Windows.Automation;
using System.Windows.Controls;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Threading;
using System.Xml;
using Dev2.Data.Interfaces;
using Dev2.Studio.Interfaces;
using Dev2.Studio.ViewModels.Workflow;
using Dev2.UI;
using ICSharpCode.AvalonEdit;
using ICSharpCode.AvalonEdit.Folding;
using ICSharpCode.AvalonEdit.Highlighting;
using ICSharpCode.AvalonEdit.Indentation;
using Infragistics.Controls.Grids;
using Infragistics.Controls.Grids.Primitives;
using Newtonsoft.Json;
using Warewolf.Studio.Core;


namespace Dev2.Studio.Views.Workflow
{
    /// <summary>
    /// Interaction logic for WorkflowInputDataWindow.xaml
    /// </summary>
    public partial class WorkflowInputDataView
    {
        public WorkflowInputDataView()
        {
            InitializeComponent();
            SetUpTextEditor();
            PopupViewManageEffects.AddBlackOutEffect(_blackoutGrid);
            _currentTab = InputTab.Grid;
        }

        TextEditor _editor;
        TextEditor _jsonEditor;
        AbstractFoldingStrategy _foldingStrategy;
        FoldingManager _foldingManager;
        DispatcherTimer _foldingUpdateTimer;
        readonly Grid _blackoutGrid = new Grid();
        InputTab _currentTab;

        void SetUpTextEditor()
        {
            _editor = new TextEditor { SyntaxHighlighting = HighlightingManager.Instance.GetDefinition("XML"), ShowLineNumbers = true, VerticalScrollBarVisibility = ScrollBarVisibility.Auto, HorizontalScrollBarVisibility = ScrollBarVisibility.Auto };
            _editor.SetValue(AutomationProperties.AutomationIdProperty, "UI_XMLEditor_AutoID");

            _jsonEditor = new TextEditor { SyntaxHighlighting = HighlightingManager.Instance.GetDefinition("JavaScript"), ShowLineNumbers = true, VerticalScrollBarVisibility = ScrollBarVisibility.Auto, HorizontalScrollBarVisibility = ScrollBarVisibility.Auto };
            _jsonEditor.SetValue(AutomationProperties.AutomationIdProperty, "UI_JsonEditor_AutoID");

            _foldingStrategy = new XmlFoldingStrategy();
            _foldingManager = FoldingManager.Install(_editor.TextArea);
            _editor.TextArea.IndentationStrategy = new DefaultIndentationStrategy();
            _jsonEditor.TextArea.IndentationStrategy = new DefaultIndentationStrategy();
            _editor.Document.UpdateFinished += XmlOutputDocument_UpdateFinished;
            _jsonEditor.Document.UpdateFinished += JsonOutputDocument_UpdateFinished;
            _foldingUpdateTimer = new DispatcherTimer { Interval = TimeSpan.FromSeconds(2) };
            _foldingUpdateTimer.Tick += OnFoldingUpdateTimerOnTick;
            _foldingUpdateTimer.Start();
        }

        void OnFoldingUpdateTimerOnTick(object sender, EventArgs e)
        {
            if (_foldingStrategy != null && _foldingManager != null && !string.IsNullOrEmpty(_editor.Document.Text))
            {
                _foldingStrategy.UpdateFoldings(_foldingManager, _editor.Document);
            }

        }

        void ShowDataInOutputWindow(string input)
        {
            _editor.Text = input;
            XmlOutput.Content = _editor;
        }

        void ShowDataInJsonOutputWindow(WorkflowInputDataViewModel vm, string input)
        {
            if (!string.IsNullOrEmpty(input))
            {
                var xml = new XmlDocument();

                try
                {
                    xml.LoadXml(input);
                }
                catch (Exception ex)
                {
                    vm.ShowInvalidDataPopupMessage();
                }

                if (xml.FirstChild != null)
                {
                    var json = JsonConvert.SerializeXmlNode(xml.FirstChild, Newtonsoft.Json.Formatting.Indented, true);
                    _jsonEditor.Text = json;
                }
                else
                {
                    _jsonEditor.Text = vm.JsonData;
                }

                JsonOutput.Content = _jsonEditor;
            }
        }

        void TryShowDataInOutputWindow(WorkflowInputDataViewModel vm)
        {
            if (_currentTab == InputTab.Grid)
            {
                try
                {
                    vm.SetXmlData();
                    ShowDataInOutputWindow(vm.XmlData);
                }
                catch
                {
                    vm.ShowInvalidDataPopupMessage();
                }
            }
            if (_currentTab == InputTab.Json)
            {
                try
                {
                    vm.XmlData = GetXmlDataFromJson();
                    vm.SetWorkflowInputData();
                    vm.SetXmlData();
                    ShowDataInOutputWindow(vm.XmlData);
                }
                catch
                {
                    vm.ShowInvalidDataPopupMessage();
                }
            }
        }

        void TextBoxTextChanged(object sender, RoutedEventArgs routedEventArgs)
        {
            if (routedEventArgs.OriginalSource is IntellisenseTextBox tb)
            {
                var dli = tb.DataContext as IDataListItem;
                var vm = DataContext as WorkflowInputDataViewModel;
                vm?.AddRow(dli);
            }
        }

        void TryChangeTab(object sender, SelectionChangedEventArgs e)
        {
            if (e.Source is TabControl ctrl)
            {
                var tabCtrl = ctrl;
                var tabItem = tabCtrl.SelectedItem as TabItem;
                if (DataContext is WorkflowInputDataViewModel vm)
                {
                    vm.IsInError = false;
                    if (tabItem != null && tabItem.Header.ToString() == "XML")
                    {
                        TryShowDataInOutputWindow(vm);
                        _currentTab = InputTab.Xml;
                    }
                    else if (tabItem != null && tabItem.Header.ToString() == "JSON")
                    {
                        SetCurrentTabToJson(vm);
                    }
                    else
                    {
                        TryChangeTab(vm);
                    }
                }
            }
        }

        void TryChangeTab(WorkflowInputDataViewModel vm)
        {
            try
            {
                var xmlData = _editor.Text;
                if (_currentTab == InputTab.Json)
                {
                    xmlData = GetXmlDataFromJson();
                }
                vm.XmlData = xmlData;
                vm.SetWorkflowInputData();
                _currentTab = InputTab.Grid;
            }
            catch (Exception ex)
            {
                vm.IsInError = true;
            }
        }

        private void SetCurrentTabToJson(WorkflowInputDataViewModel vm)
        {
            string input = string.Empty;

            if (_currentTab == InputTab.Grid)
            {
                vm.SetXmlData();
                if (vm.XmlData != null)
                {
                    input = vm.XmlData;
                }
            }
            if (_currentTab == InputTab.Xml && !string.IsNullOrEmpty(_editor.Text))
            {
                input = _editor.Text;
            }

            ShowDataInJsonOutputWindow(vm, input);
            _currentTab = InputTab.Json;
        }

        string GetXmlDataFromJson()
        {
            try
            {
                var xmlDocument = JsonConvert.DeserializeXmlNode(_jsonEditor.Text == "\"\"" ? "" : _jsonEditor.Text, "DataList",true);
                return xmlDocument == null ? String.Empty : xmlDocument.InnerXml;
            }
            catch (Exception)
            {
                var vm = DataContext as WorkflowInputDataViewModel;
                vm?.ShowInvalidDataPopupMessage();
            }
            return _editor.Text;
        }

        void MenuItemAddRow(object sender, RoutedEventArgs e)
        {

            if (DataContext is WorkflowInputDataViewModel vm && vm.AddBlankRow(DataListInputs.ActiveItem as IDataListItem, out int indexToSelect))
            {
                DataListInputs.ActiveItem = indexToSelect;
                Dispatcher.BeginInvoke(new Action(FocusOnAddition), DispatcherPriority.ApplicationIdle);
            }
        }

        void FocusOnAddition()
        {
            try
            {
                var row = GetSelectedRow(DataListInputs);
                if (row != null)
                {
                    var intelbox = FindByName("txtValue", row) as IntellisenseTextBox;
                    intelbox?.Focus();
                }
            }
            catch (Exception)
            {
                //
            }
        }

        void MenuItemDeleteRow(object sender, RoutedEventArgs e)
        {
            if (DataContext is WorkflowInputDataViewModel vm && vm.RemoveRow(DataListInputs.ActiveItem as IDataListItem, out int indexToSelect))
            {
                DataListInputs.ActiveItem = indexToSelect;
            }
        }

        void IntellisenseTextBoxPreviewKeyDown(object sender, KeyEventArgs e)
        {
            var vm = DataContext as WorkflowInputDataViewModel;

            if (e.KeyboardDevice.Modifiers == ModifierKeys.Shift && e.KeyboardDevice.IsKeyDown(Key.Insert))
            {
                InsertEmptyRow();
                e.Handled = true;
            }
            else
            {
                if (e.KeyboardDevice.Modifiers == ModifierKeys.Shift && e.Key == Key.Delete)
                {
                    DeleteLastRow();
                    e.Handled = true;
                }
            }
            if ((e.KeyboardDevice.Modifiers == ModifierKeys.Shift && (e.KeyboardDevice.IsKeyDown(Key.Tab) || e.Key == Key.Tab)) || e.KeyboardDevice.IsKeyDown(Key.Up))
            {
                MoveToPreviousRow(vm);
                e.Handled = true;
            }
            else
            {
                if (e.KeyboardDevice.IsKeyDown(Key.Tab) || e.KeyboardDevice.IsKeyDown(Key.Down))
                {
                    MoveToNextRow(vm);
                    e.Handled = true;
                }
            }
        }

        void MoveToNextRow(WorkflowInputDataViewModel vm)
        {
            var itemToSelect = vm?.GetNextRow(DataListInputs.ActiveItem as IDataListItem);
            if(itemToSelect != null)
            {
                DataListInputs.ActiveItem = itemToSelect;
                FocusOnAddition();
            }
        }

        void MoveToPreviousRow(WorkflowInputDataViewModel vm)
        {
            var itemToSelect = vm?.GetPreviousRow(DataListInputs.ActiveItem as IDataListItem);
            if(itemToSelect != null)
            {
                DataListInputs.ActiveItem = itemToSelect;
                FocusOnAddition();
            }
        }

        void GridPreviewKeyDown(object sender, KeyEventArgs e)
        {
            UIElement keyboardFocus = Keyboard.FocusedElement as TextBox;
            if (e.KeyboardDevice.IsKeyDown(Key.LeftShift) && e.KeyboardDevice.IsKeyDown(Key.Tab))
            {
                keyboardFocus?.MoveFocus(new TraversalRequest(FocusNavigationDirection.Previous));
            }
            if (e.KeyboardDevice.IsKeyDown(Key.Tab))
            {
                var vm = DataContext as WorkflowInputDataViewModel;
                var itemToSelect = vm?.GetNextRow(DataListInputs.ActiveItem as IDataListItem);
                if (itemToSelect != null)
                {
                    DataListInputs.ActiveItem = itemToSelect;
                    FocusOnAddition();
                }
            }
        }

        static FrameworkElement FindByName(string name, FrameworkElement root)
        {
            if (root != null)
            {
                var tree = new Stack<FrameworkElement>();
                tree.Push(root);
                while (tree.Count > 0)
                {
                    var current = tree.Pop();
                    if (current.Name == name)
                    {
                        return current;
                    }

                    var count = VisualTreeHelper.GetChildrenCount(current);
                    for (var supplierCounter = 0; supplierCounter < count; ++supplierCounter)
                    {
                        tree = TreePushChild(tree, current, supplierCounter);
                    }
                }
            }
            return null;
        }

        static Stack<FrameworkElement> TreePushChild(Stack<FrameworkElement> tree, FrameworkElement current, int supplierCounter)
        {
            var child = VisualTreeHelper.GetChild(current, supplierCounter);
            if (child is FrameworkElement item)
            {
                tree.Push(item);
            }
            return tree;
        }

        static CellsPanel GetSelectedRow(XamGrid grid)
        {
            var row = grid.ActiveCell?.Row;
            return row?.Control;
        }

        void ExecuteClicked(object sender, RoutedEventArgs e)
        {
            var tabItem = TabItems.SelectedItem as TabItem;
            if (DataContext is WorkflowInputDataViewModel vm)
            {
                vm.IsInError = false;
                if (tabItem != null)
                {
                    TrySetWorkflowInputData(tabItem, vm);
                }
            }
            DestroyTimer();
        }

        void TrySetWorkflowInputData(TabItem tabItem, WorkflowInputDataViewModel vm)
        {
            if (tabItem.Header.ToString() == "XML")
            {
                try
                {
                    vm.XmlData = _editor.Text;
                    vm.SetWorkflowInputData();
                }
                catch (Exception ex)
                {
                    vm.IsInError = true;
                }
            }
            else if (tabItem.Header.ToString() == "JSON")
            {
                vm.XmlData = GetXmlDataFromJson();
                vm.SetWorkflowInputData();
            }
            else
            {
                vm.SetXmlData();
            }
        }

        void DestroyTimer()
        {
            if (_foldingUpdateTimer != null)
            {
                _foldingUpdateTimer.Tick -= OnFoldingUpdateTimerOnTick;
                _foldingUpdateTimer.Stop();
                _foldingUpdateTimer = null;
            }
        }

        void CancelClicked(object sender, RoutedEventArgs e)
        {
            DestroyTimer();
        }

        void WorkflowInputDataView_OnMouseDown(object sender, MouseButtonEventArgs e)
        {
            if (Mouse.LeftButton == MouseButtonState.Pressed)
            {
                DragMove();
            }
        }

        void WorkflowInputDataView_OnClosed(object sender, EventArgs e)
        {
            PopupViewManageEffects.RemoveBlackOutEffect(_blackoutGrid);
        }

        void WorkflowInputDataView_OnPreviewKeyDown(object sender, KeyEventArgs e)
        {
        }

        void InsertEmptyRow()
        {
            if (DataContext is WorkflowInputDataViewModel vm && vm.AddBlankRow(DataListInputs.ActiveItem as IDataListItem, out int indexToSelect))
            {
                DataListInputs.ActiveItem = indexToSelect;
                Dispatcher.BeginInvoke(new Action(FocusOnAddition), DispatcherPriority.ApplicationIdle);
            }
        }

        void DeleteLastRow()
        {
            if (DataContext is WorkflowInputDataViewModel vm && vm.RemoveRow(DataListInputs.ActiveItem as IDataListItem, out int indexToSelect))
            {
                DataListInputs.ActiveItem = indexToSelect;
            }
        }

        void DataListInputs_OnLoaded(object sender, RoutedEventArgs e)
        {
            if(DataListInputs?.Rows != null && DataListInputs.Rows.Count > 0)
            {
                var cellBaseCollection = DataListInputs.Rows[0].Cells;
                if(cellBaseCollection != null)
                {
                    var selectedCell = (Cell)cellBaseCollection[1];
                    DataListInputs.ActiveCell = selectedCell;
                }
            }
            FocusOnAddition();
        }

        void WorkflowInputDataView_OnKeyUp(object sender, KeyEventArgs e)
        {
            if ((Keyboard.Modifiers == (ModifierKeys.Alt | ModifierKeys.Control)) && (e.Key == Key.F4))
            {
                var mainViewModel = CustomContainer.Get<IShellViewModel>();
                mainViewModel?.ResetMainView();
            }
        }

        private void XmlOutputDocument_UpdateFinished(object sender, EventArgs e)
        {
            var vm = DataContext as WorkflowInputDataViewModel;

            try
            {
                if (vm.CheckHasUnicodeInWorkflowInputData(_editor.Text))
                {
                    ShowDataInOutputWindow(vm.XmlData);
                    return;
                }

                vm.IsInError = false;
                vm.XmlData = _editor.Text;
                vm.SetWorkflowInputData();
            }
            catch (Exception ex)
            {
                vm.IsInError = true;
            }
        }

        private void JsonOutputDocument_UpdateFinished(object sender, EventArgs e)
        {
            var vm = DataContext as WorkflowInputDataViewModel;

            vm.XmlData = GetXmlDataFromJson();
            if (vm.CheckHasUnicodeInWorkflowInputData(vm.XmlData))
            {
                ShowDataInJsonOutputWindow(vm, vm.XmlData);
                return;
            }

            vm.IsInError = false;
            vm.SetWorkflowInputData();
        }
    }

    public enum InputTab
    {
        Grid,
        Xml,
        Json
    }
}

---- Transformed Tree ----
using System;
using System.Collections.Generic;
using System.Windows;
using System.Windows.Automation;
using System.Windows.Controls;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Threading;
using System.Xml;
using Dev2.Data.Interfaces;
using Dev2.Studio.Interfaces;
using Dev2.Studio.ViewModels.Workflow;
using Dev2.UI;
using ICSharpCode.AvalonEdit;
using ICSharpCode.AvalonEdit.Folding;
using ICSharpCode.AvalonEdit.Highlighting;
using ICSharpCode.AvalonEdit.Indentation;
using Infragistics.Controls.Grids;
using Infragistics.Controls.Grids.Primitives;
using Newtonsoft.Json;
using Warewolf.Studio.Core;


namespace Dev2.Studio.Views.Workflow
{
    /// <summary>
    /// Interaction logic for WorkflowInputDataWindow.xaml
    /// </summary>
    public partial class WorkflowInputDataView
    {
        public WorkflowInputDataView()
        {
            InitializeComponent();
            SetUpTextEditor();
            PopupViewManageEffects.AddBlackOutEffect(_blackoutGrid);
            _currentTab = InputTab.Grid;
        }

        TextEditor _editor;
        TextEditor _jsonEditor;
        AbstractFoldingStrategy _foldingStrategy;
        FoldingManager _foldingManager;
        DispatcherTimer _foldingUpdateTimer;
        readonly Grid _blackoutGrid = new Grid();
        InputTab _currentTab;

        void SetUpTextEditor()
        {
            _editor = new TextEditor { SyntaxHighlighting = HighlightingManager.Instance.GetDefinition("XML"), ShowLineNumbers = true, VerticalScrollBarVisibility = ScrollBarVisibility.Auto, HorizontalScrollBarVisibility = ScrollBarVisibility.Auto };
            _editor.SetValue(AutomationProperties.AutomationIdProperty, "UI_XMLEditor_AutoID");

            _jsonEditor = new TextEditor { SyntaxHighlighting = HighlightingManager.Instance.GetDefinition("JavaScript"), ShowLineNumbers = true, VerticalScrollBarVisibility = ScrollBarVisibility.Auto, HorizontalScrollBarVisibility = ScrollBarVisibility.Auto };
            _jsonEditor.SetValue(AutomationProperties.AutomationIdProperty, "UI_JsonEditor_AutoID");

            _foldingStrategy = new XmlFoldingStrategy();
            _foldingManager = FoldingManager.Install(_editor.TextArea);
            _editor.TextArea.IndentationStrategy = new DefaultIndentationStrategy();
            _jsonEditor.TextArea.IndentationStrategy = new DefaultIndentationStrategy();
            _editor.Document.UpdateFinished += XmlOutputDocument_UpdateFinished;
            _jsonEditor.Document.UpdateFinished += JsonOutputDocument_UpdateFinished;
            _foldingUpdateTimer = new DispatcherTimer { Interval = TimeSpan.FromSeconds(2) };
            _foldingUpdateTimer.Tick += OnFoldingUpdateTimerOnTick;
            _foldingUpdateTimer.Start();
        }

        void OnFoldingUpdateTimerOnTick(object sender, EventArgs e)
        {
            if (_foldingStrategy != null && _foldingManager != null && !string.IsNullOrEmpty(_editor.Document.Text))
            {
                _foldingStrategy.UpdateFoldings(_foldingManager, _editor.Document);
            }

        }

        void ShowDataInOutputWindow(string input)
        {
            _editor.Text = input;
            XmlOutput.Content = _editor;
        }

        void ShowDataInJsonOutputWindow(WorkflowInputDataViewModel vm, string input)
        {
            if (!string.IsNullOrEmpty(input))
            {
                var xml = new XmlDocument();

                try
                {
                    xml.LoadXml(input);
                }
                catch (Exception ex)
                {
                    vm.ShowInvalidDataPopupMessage();
                }

                if (xml.FirstChild != null)
                {
                    var json = JsonConvert.SerializeXmlNode(xml.FirstChild, Newtonsoft.Json.Formatting.Indented, true);
                    _jsonEditor.Text = json;
                }
                else
                {
                    _jsonEditor.Text = vm.JsonData;
                }

                JsonOutput.Content = _jsonEditor;
            }
        }

        void TryShowDataInOutputWindow(WorkflowInputDataViewModel vm)
        {
            if (_currentTab == InputTab.Grid)
            {
                try
                {
                    vm.SetXmlData();
                    ShowDataInOutputWindow(vm.XmlData);
                }
                catch
                {
                    vm.ShowInvalidDataPopupMessage();
                }
            }
            if (_currentTab == InputTab.Json)
            {
                try
                {
                    vm.XmlData = GetXmlDataFromJson();
                    vm.SetWorkflowInputData();
                    vm.SetXmlData();
                    ShowDataInOutputWindow(vm.XmlData);
                }
                catch
                {
                    vm.ShowInvalidDataPopupMessage();
                }
            }
        }

        void TextBoxTextChanged(object sender, RoutedEventArgs routedEventArgs)
        {
            if (routedEventArgs.OriginalSource is IntellisenseTextBox tb)
            {
                var dli = tb.DataContext as IDataListItem;
                var vm = DataContext as WorkflowInputDataViewModel;
                vm?.AddRow(dli);
            }
        }

        void TryChangeTab(object sender, SelectionChangedEventArgs e)
        {
            if (e.Source is TabControl ctrl)
            {
                var tabCtrl = ctrl;
                if (DataContext is WorkflowInputDataViewModel vm)
                {
                    vm.IsInError = false;

                    if (tabCtrl.SelectedItem is TabItem tabItem && tabItem.Header.ToString() == "XML")
                    {
                        TryShowDataInOutputWindow(vm);
                        _currentTab = InputTab.Xml;
                    }
                    else if (tabCtrl.SelectedItem is TabItem tabItem && tabItem.Header.ToString() == "JSON")
                    {
                        SetCurrentTabToJson(vm);
                    }
                    else
                    {
                        TryChangeTab(vm);
                    }
                }
            }
        }

        void TryChangeTab(WorkflowInputDataViewModel vm)
        {
            try
            {
                var xmlData = _editor.Text;
                if (_currentTab == InputTab.Json)
                {
                    xmlData = GetXmlDataFromJson();
                }
                vm.XmlData = xmlData;
                vm.SetWorkflowInputData();
                _currentTab = InputTab.Grid;
            }
            catch (Exception ex)
            {
                vm.IsInError = true;
            }
        }

        private void SetCurrentTabToJson(WorkflowInputDataViewModel vm)
        {
            string input = string.Empty;

            if (_currentTab == InputTab.Grid)
            {
                vm.SetXmlData();
                if (vm.XmlData != null)
                {
                    input = vm.XmlData;
                }
            }
            if (_currentTab == InputTab.Xml && !string.IsNullOrEmpty(_editor.Text))
            {
                input = _editor.Text;
            }

            ShowDataInJsonOutputWindow(vm, input);
            _currentTab = InputTab.Json;
        }

        string GetXmlDataFromJson()
        {
            try
            {
                var xmlDocument = JsonConvert.DeserializeXmlNode(_jsonEditor.Text == "\"\"" ? "" : _jsonEditor.Text, "DataList",true);
                return xmlDocument == null ? String.Empty : xmlDocument.InnerXml;
            }
            catch (Exception)
            {
                var vm = DataContext as WorkflowInputDataViewModel;
                vm?.ShowInvalidDataPopupMessage();
            }
            return _editor.Text;
        }

        void MenuItemAddRow(object sender, RoutedEventArgs e)
        {

            if (DataContext is WorkflowInputDataViewModel vm && vm.AddBlankRow(DataListInputs.ActiveItem as IDataListItem, out int indexToSelect))
            {
                DataListInputs.ActiveItem = indexToSelect;
                Dispatcher.BeginInvoke(new Action(FocusOnAddition), DispatcherPriority.ApplicationIdle);
            }
        }

        void FocusOnAddition()
        {
            try
            {
                var row = GetSelectedRow(DataListInputs);
                if (row != null)
                {
                    var intelbox = FindByName("txtValue", row) as IntellisenseTextBox;
                    intelbox?.Focus();
                }
            }
            catch (Exception)
            {
                //
            }
        }

        void MenuItemDeleteRow(object sender, RoutedEventArgs e)
        {
            if (DataContext is WorkflowInputDataViewModel vm && vm.RemoveRow(DataListInputs.ActiveItem as IDataListItem, out int indexToSelect))
            {
                DataListInputs.ActiveItem = indexToSelect;
            }
        }

        void IntellisenseTextBoxPreviewKeyDown(object sender, KeyEventArgs e)
        {
            var vm = DataContext as WorkflowInputDataViewModel;

            if (e.KeyboardDevice.Modifiers == ModifierKeys.Shift && e.KeyboardDevice.IsKeyDown(Key.Insert))
            {
                InsertEmptyRow();
                e.Handled = true;
            }
            else
            {
                if (e.KeyboardDevice.Modifiers == ModifierKeys.Shift && e.Key == Key.Delete)
                {
                    DeleteLastRow();
                    e.Handled = true;
                }
            }
            if ((e.KeyboardDevice.Modifiers == ModifierKeys.Shift && (e.KeyboardDevice.IsKeyDown(Key.Tab) || e.Key == Key.Tab)) || e.KeyboardDevice.IsKeyDown(Key.Up))
            {
                MoveToPreviousRow(vm);
                e.Handled = true;
            }
            else
            {
                if (e.KeyboardDevice.IsKeyDown(Key.Tab) || e.KeyboardDevice.IsKeyDown(Key.Down))
                {
                    MoveToNextRow(vm);
                    e.Handled = true;
                }
            }
        }

        void MoveToNextRow(WorkflowInputDataViewModel vm)
        {
            var itemToSelect = vm?.GetNextRow(DataListInputs.ActiveItem as IDataListItem);
            if(itemToSelect != null)
            {
                DataListInputs.ActiveItem = itemToSelect;
                FocusOnAddition();
            }
        }

        void MoveToPreviousRow(WorkflowInputDataViewModel vm)
        {
            var itemToSelect = vm?.GetPreviousRow(DataListInputs.ActiveItem as IDataListItem);
            if(itemToSelect != null)
            {
                DataListInputs.ActiveItem = itemToSelect;
                FocusOnAddition();
            }
        }

        void GridPreviewKeyDown(object sender, KeyEventArgs e)
        {
            UIElement keyboardFocus = Keyboard.FocusedElement as TextBox;
            if (e.KeyboardDevice.IsKeyDown(Key.LeftShift) && e.KeyboardDevice.IsKeyDown(Key.Tab))
            {
                keyboardFocus?.MoveFocus(new TraversalRequest(FocusNavigationDirection.Previous));
            }
            if (e.KeyboardDevice.IsKeyDown(Key.Tab))
            {
                var vm = DataContext as WorkflowInputDataViewModel;
                var itemToSelect = vm?.GetNextRow(DataListInputs.ActiveItem as IDataListItem);
                if (itemToSelect != null)
                {
                    DataListInputs.ActiveItem = itemToSelect;
                    FocusOnAddition();
                }
            }
        }

        static FrameworkElement FindByName(string name, FrameworkElement root)
        {
            if (root != null)
            {
                var tree = new Stack<FrameworkElement>();
                tree.Push(root);
                while (tree.Count > 0)
                {
                    var current = tree.Pop();
                    if (current.Name == name)
                    {
                        return current;
                    }

                    var count = VisualTreeHelper.GetChildrenCount(current);
                    for (var supplierCounter = 0; supplierCounter < count; ++supplierCounter)
                    {
                        tree = TreePushChild(tree, current, supplierCounter);
                    }
                }
            }
            return null;
        }

        static Stack<FrameworkElement> TreePushChild(Stack<FrameworkElement> tree, FrameworkElement current, int supplierCounter)
        {
            var child = VisualTreeHelper.GetChild(current, supplierCounter);
            if (child is FrameworkElement item)
            {
                tree.Push(item);
            }
            return tree;
        }

        static CellsPanel GetSelectedRow(XamGrid grid)
        {
            var row = grid.ActiveCell?.Row;
            return row?.Control;
        }

        void ExecuteClicked(object sender, RoutedEventArgs e)
        {
            if (DataContext is WorkflowInputDataViewModel vm)
            {
                vm.IsInError = false;

                if (TabItems.SelectedItem is TabItem tabItem)
                {
                    TrySetWorkflowInputData(tabItem, vm);
                }
            }
            DestroyTimer();
        }

        void TrySetWorkflowInputData(TabItem tabItem, WorkflowInputDataViewModel vm)
        {
            if (tabItem.Header.ToString() == "XML")
            {
                try
                {
                    vm.XmlData = _editor.Text;
                    vm.SetWorkflowInputData();
                }
                catch (Exception ex)
                {
                    vm.IsInError = true;
                }
            }
            else if (tabItem.Header.ToString() == "JSON")
            {
                vm.XmlData = GetXmlDataFromJson();
                vm.SetWorkflowInputData();
            }
            else
            {
                vm.SetXmlData();
            }
        }

        void DestroyTimer()
        {
            if (_foldingUpdateTimer != null)
            {
                _foldingUpdateTimer.Tick -= OnFoldingUpdateTimerOnTick;
                _foldingUpdateTimer.Stop();
                _foldingUpdateTimer = null;
            }
        }

        void CancelClicked(object sender, RoutedEventArgs e)
        {
            DestroyTimer();
        }

        void WorkflowInputDataView_OnMouseDown(object sender, MouseButtonEventArgs e)
        {
            if (Mouse.LeftButton == MouseButtonState.Pressed)
            {
                DragMove();
            }
        }

        void WorkflowInputDataView_OnClosed(object sender, EventArgs e)
        {
            PopupViewManageEffects.RemoveBlackOutEffect(_blackoutGrid);
        }

        void WorkflowInputDataView_OnPreviewKeyDown(object sender, KeyEventArgs e)
        {
        }

        void InsertEmptyRow()
        {
            if (DataContext is WorkflowInputDataViewModel vm && vm.AddBlankRow(DataListInputs.ActiveItem as IDataListItem, out int indexToSelect))
            {
                DataListInputs.ActiveItem = indexToSelect;
                Dispatcher.BeginInvoke(new Action(FocusOnAddition), DispatcherPriority.ApplicationIdle);
            }
        }

        void DeleteLastRow()
        {
            if (DataContext is WorkflowInputDataViewModel vm && vm.RemoveRow(DataListInputs.ActiveItem as IDataListItem, out int indexToSelect))
            {
                DataListInputs.ActiveItem = indexToSelect;
            }
        }

        void DataListInputs_OnLoaded(object sender, RoutedEventArgs e)
        {
            if(DataListInputs?.Rows != null && DataListInputs.Rows.Count > 0)
            {
                var cellBaseCollection = DataListInputs.Rows[0].Cells;
                if(cellBaseCollection != null)
                {
                    var selectedCell = (Cell)cellBaseCollection[1];
                    DataListInputs.ActiveCell = selectedCell;
                }
            }
            FocusOnAddition();
        }

        void WorkflowInputDataView_OnKeyUp(object sender, KeyEventArgs e)
        {
            if ((Keyboard.Modifiers == (ModifierKeys.Alt | ModifierKeys.Control)) && (e.Key == Key.F4))
            {
                var mainViewModel = CustomContainer.Get<IShellViewModel>();
                mainViewModel?.ResetMainView();
            }
        }

        private void XmlOutputDocument_UpdateFinished(object sender, EventArgs e)
        {
            var vm = DataContext as WorkflowInputDataViewModel;

            try
            {
                if (vm.CheckHasUnicodeInWorkflowInputData(_editor.Text))
                {
                    ShowDataInOutputWindow(vm.XmlData);
                    return;
                }

                vm.IsInError = false;
                vm.XmlData = _editor.Text;
                vm.SetWorkflowInputData();
            }
            catch (Exception ex)
            {
                vm.IsInError = true;
            }
        }

        private void JsonOutputDocument_UpdateFinished(object sender, EventArgs e)
        {
            var vm = DataContext as WorkflowInputDataViewModel;

            vm.XmlData = GetXmlDataFromJson();
            if (vm.CheckHasUnicodeInWorkflowInputData(vm.XmlData))
            {
                ShowDataInJsonOutputWindow(vm, vm.XmlData);
                return;
            }

            vm.IsInError = false;
            vm.SetWorkflowInputData();
        }
    }

    public enum InputTab
    {
        Grid,
        Xml,
        Json
    }
}

---- Semantic diagnostics *before* transformation ----
D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(44,13): error CS0103: The name 'InitializeComponent' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(89,13): error CS0103: The name 'XmlOutput' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(117,17): error CS0103: The name 'JsonOutput' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(156,26): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(167,21): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(236,26): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(245,17): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(245,80): error CS0103: The name 'DataListInputs' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(247,17): error CS0103: The name 'DataListInputs' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(248,17): error CS0120: An object reference is required for the non-static field, method, or property 'Dispatcher.BeginInvoke(Delegate, params object[])',D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(256,42): error CS0103: The name 'DataListInputs' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(271,17): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(271,78): error CS0103: The name 'DataListInputs' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(273,17): error CS0103: The name 'DataListInputs' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(279,22): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(311,47): error CS0103: The name 'DataListInputs' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(314,17): error CS0103: The name 'DataListInputs' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(321,51): error CS0103: The name 'DataListInputs' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(324,17): error CS0103: The name 'DataListInputs' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(338,26): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(339,51): error CS0103: The name 'DataListInputs' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(342,21): error CS0103: The name 'DataListInputs' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(390,27): error CS0103: The name 'TabItems' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(391,17): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(446,17): error CS0103: The name 'DragMove' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(461,17): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(461,80): error CS0103: The name 'DataListInputs' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(463,17): error CS0103: The name 'DataListInputs' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(464,17): error CS0120: An object reference is required for the non-static field, method, or property 'Dispatcher.BeginInvoke(Delegate, params object[])',D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(470,17): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(470,78): error CS0103: The name 'DataListInputs' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(472,17): error CS0103: The name 'DataListInputs' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(478,16): error CS0103: The name 'DataListInputs' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(478,48): error CS0103: The name 'DataListInputs' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(480,42): error CS0103: The name 'DataListInputs' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(484,21): error CS0103: The name 'DataListInputs' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(501,22): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(523,22): error CS0103: The name 'DataContext' does not exist in the current context
---- Semantic diagnostics *after* transformation ----
D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(44,13): error CS0103: The name 'InitializeComponent' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(89,13): error CS0103: The name 'XmlOutput' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(117,17): error CS0103: The name 'JsonOutput' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(156,26): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(166,21): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(175,62): error CS0136: A local or parameter named 'tabItem' cannot be declared in this scope because that name is used in an enclosing local scope to define a local or parameter,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(236,26): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(245,17): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(245,80): error CS0103: The name 'DataListInputs' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(247,17): error CS0103: The name 'DataListInputs' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(248,17): error CS0120: An object reference is required for the non-static field, method, or property 'Dispatcher.BeginInvoke(Delegate, params object[])',D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(256,42): error CS0103: The name 'DataListInputs' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(271,17): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(271,78): error CS0103: The name 'DataListInputs' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(273,17): error CS0103: The name 'DataListInputs' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(279,22): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(311,47): error CS0103: The name 'DataListInputs' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(314,17): error CS0103: The name 'DataListInputs' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(321,51): error CS0103: The name 'DataListInputs' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(324,17): error CS0103: The name 'DataListInputs' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(338,26): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(339,51): error CS0103: The name 'DataListInputs' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(342,21): error CS0103: The name 'DataListInputs' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(390,17): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(394,21): error CS0103: The name 'TabItems' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(446,17): error CS0103: The name 'DragMove' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(461,17): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(461,80): error CS0103: The name 'DataListInputs' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(463,17): error CS0103: The name 'DataListInputs' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(464,17): error CS0120: An object reference is required for the non-static field, method, or property 'Dispatcher.BeginInvoke(Delegate, params object[])',D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(470,17): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(470,78): error CS0103: The name 'DataListInputs' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(472,17): error CS0103: The name 'DataListInputs' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(478,16): error CS0103: The name 'DataListInputs' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(478,48): error CS0103: The name 'DataListInputs' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(480,42): error CS0103: The name 'DataListInputs' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(484,21): error CS0103: The name 'DataListInputs' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(501,22): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\Workflow\WorkflowInputDataView.xaml.cs(523,22): error CS0103: The name 'DataContext' does not exist in the current context
######################################################################


######################################################################
Nr: 25 - UsePatternMatchingRewriterR8
Filepath: D:\a\1\s\Dev\Dev2.Studio\ViewModels\Workflow\WorkflowDesignerViewModel.cs
Description: Error: The created Syntax Tree is semantically incorrect.
------------------------------------------------------------------------
---- Original Tree ----
using Caliburn.Micro;
using Dev2.Activities.Designers2.Core;
using Dev2.Common;
using Dev2.Common.Common;
using Dev2.Common.Interfaces.Core.Collections;
using Dev2.Common.Interfaces.Enums;
using Dev2.Common.Interfaces.Infrastructure;
using Dev2.Common.Interfaces.Infrastructure.Providers.Errors;
using Dev2.Common.Interfaces.Security;
using Dev2.Common.Interfaces.Studio.Controller;
using Dev2.Common.Interfaces.Threading;
using Dev2.CustomControls.Utils;
using Dev2.Data.Interfaces;
using Dev2.Data.SystemTemplates.Models;
using Dev2.Data.Util;
using Dev2.DataList.Contract;
using Dev2.Diagnostics;
using Dev2.Dialogs;
using Dev2.Factories;
using Dev2.Factory;
using Dev2.Instrumentation;
using Dev2.Messages;
using Dev2.Runtime.Configuration.ViewModels.Base;
using Dev2.Services.Events;
using Dev2.Studio.ActivityDesigners;
using Dev2.Studio.AppResources.AttachedProperties;
using Dev2.Studio.AppResources.ExtensionMethods;
using Dev2.Studio.Controller;
using Dev2.Studio.Core;
using Dev2.Studio.Core.Activities.Services;
using Dev2.Studio.Core.Activities.Utils;
using Dev2.Studio.Core.AppResources.DependencyInjection.EqualityComparers;
using Dev2.Studio.Core.AppResources.ExtensionMethods;
using Dev2.Studio.Core.Factories;
using Dev2.Studio.Core.Messages;
using Dev2.Studio.Core.Network;
using Dev2.Studio.Core.Utils;
using Dev2.Studio.Enums;
using Dev2.Studio.Factory;
using Dev2.Studio.Interfaces;
using Dev2.Studio.Interfaces.DataList;
using Dev2.Studio.Interfaces.Enums;
using Dev2.Studio.ViewModels.Diagnostics;
using Dev2.Studio.ViewModels.WorkSurface;
using Dev2.Threading;
using Dev2.Utilities;
using Dev2.Utils;
using Dev2.ViewModels.Workflow;
using Dev2.Workspaces;
using Newtonsoft.Json;
using System;
using System.Activities;
using System.Activities.Core.Presentation;
using System.Activities.Presentation;
using System.Activities.Presentation.Metadata;
using System.Activities.Presentation.Model;
using System.Activities.Presentation.Services;
using System.Activities.Presentation.View;
using System.Activities.Statements;
using System.Collections.Generic;
using System.ComponentModel;
using System.Linq;
using System.Reflection;
using System.Runtime.Versioning;
using System.Text;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Threading;
using System.Xaml;
using System.Xml.Linq;
using Unlimited.Applications.BusinessDesignStudio.Activities;
using Warewolf.Studio.ViewModels;
using Dev2.ViewModels.Merge;
using Dev2.Communication;
using System.IO;
using Dev2.Common.Interfaces;
using Dev2.Activities.Designers2.Gate;
using Dev2.Activities;
using Warewolf.Data;
using Warewolf.Data.Options;
using StringExtension = Dev2.Common.ExtMethods.StringExtension;

namespace Dev2.Studio.ViewModels.Workflow
{
    public class FromToolBox
    {
    }

    public class WorkflowDesignerViewModel : BaseWorkSurfaceViewModel,
                                             IHandle<AddStringListToDataListMessage>,
                                             IHandle<EditActivityMessage>,
                                             IHandle<SaveUnsavedWorkflowMessage>,
                                             IWorkflowDesignerViewModel
    {
        static readonly Type[] DecisionSwitchTypes = { typeof(FlowSwitch<string>), typeof(FlowDecision) };

        protected readonly IDesignerManagementService _designerManagementService;
        readonly IWorkflowHelper _workflowHelper;
        DelegateCommand _collapseAllCommand;

        protected dynamic DataObject { get; set; }
        List<ModelItem> _selectedDebugItems = new List<ModelItem>();
        DelegateCommand _expandAllCommand;

        protected ModelService _modelService;
        IContextualResourceModel _resourceModel;

        protected Dictionary<IDataListVerifyPart, string> _uniqueWorkflowParts;

        protected WorkflowDesigner _wd;
        DesignerMetadata _wdMeta;

        VirtualizedContainerService _virtualizedContainerService;
        MethodInfo _virtualizedContainerServicePopulateAllMethod;

        readonly StudioSubscriptionService<DebugSelectionChangedEventArgs> _debugSelectionChangedService = new StudioSubscriptionService<DebugSelectionChangedEventArgs>();

        readonly IApplicationTracker _applicationTracker;
        public bool IsStartNodeErrorMessageSet { get; set; }

        protected IWorkflowDesignerWrapper _workflowDesignerHelper;

        public WorkflowDesignerViewModel(IContextualResourceModel resource)
            : this(resource, true)
        {
        }

        public WorkflowDesignerViewModel(IContextualResourceModel resource, bool createDesigner)
            : this(resource, new WorkflowHelper(), createDesigner)
        {
        }

        public WorkflowDesignerViewModel(IContextualResourceModel resource, IWorkflowHelper workflowHelper, bool createDesigner)
            : this(EventPublishers.Aggregator, resource, workflowHelper, createDesigner)
        {
        }

        WorkflowDesignerViewModel(IEventAggregator eventPublisher, IContextualResourceModel resource, IWorkflowHelper workflowHelper, bool createDesigner)
            : this(eventPublisher, resource, workflowHelper,
                CustomContainer.Get<IPopupController>(), new AsyncWorker(), createDesigner)
        {
        }

        public WorkflowDesignerViewModel(IWorkflowDesignerWrapper workflowDesignerHelper, IEventAggregator eventPublisher, IContextualResourceModel resource, IWorkflowHelper workflowHelper, IPopupController popupController, IAsyncWorker asyncWorker, bool createDesigner, bool liteInit)
            : this(eventPublisher, resource, workflowHelper, popupController, asyncWorker, createDesigner, liteInit)
        {
            _workflowDesignerHelper = workflowDesignerHelper;
        }

        public WorkflowDesignerViewModel(IEventAggregator eventPublisher, IContextualResourceModel resource, IWorkflowHelper workflowHelper, IPopupController popupController, IAsyncWorker asyncWorker, bool createDesigner)
            : this(eventPublisher, resource, workflowHelper, popupController, asyncWorker, createDesigner, false)
        {
        }

        public WorkflowDesignerViewModel(IEventAggregator eventPublisher, IContextualResourceModel resource, IWorkflowHelper workflowHelper, IPopupController popupController, IAsyncWorker asyncWorker, bool createDesigner, bool liteInit)
            : base(eventPublisher)
        {
            VerifyArgument.IsNotNull("workflowHelper", workflowHelper);
            VerifyArgument.IsNotNull("popupController", popupController);
            VerifyArgument.IsNotNull("asyncWorker", asyncWorker);
            _workflowHelper = workflowHelper;
            _resourceModel = resource;
            _resourceModel.OnDataListChanged += FireWdChanged;
            _resourceModel.OnResourceSaved += UpdateOriginalDataList;
            _asyncWorker = asyncWorker;
            CanViewWorkflowLink = true;

            PopUp = popupController;

            if (_resourceModel.DataList != null)
            {
                SetOriginalDataList(_resourceModel);
            }
            _designerManagementService = new DesignerManagementService(resource, _resourceModel.Environment.ResourceRepository);
            if (createDesigner)
            {
                ActivityDesignerHelper.AddDesignerAttributes(this, liteInit);
            }
            UpdateWorkflowInputDataViewModel(_resourceModel);
            UpdateWorkflowLink();
            DataListViewModel = DataListViewModelFactory.CreateDataListViewModel(_resourceModel);
            DebugOutputViewModel = new DebugOutputViewModel(_resourceModel.Environment.Connection.ServerEvents, CustomContainer.Get<IServerRepository>(), new DebugOutputFilterStrategy(), ResourceModel);
            _firstWorkflowChange = true;
            _workflowDesignerHelper = new WorkflowDesignerWrapper();
            _applicationTracker = CustomContainer.Get<IApplicationTracker>();
            _shellViewModel = GetShellViewModel();
        }

        private static IShellViewModel GetShellViewModel()
        {
            IShellViewModel shellViewModel;
            try
            {
                if (Application.Current?.MainWindow?.DataContext is IShellViewModel tmpShellViewModel)
                {
                    return tmpShellViewModel;
                }
            }
            catch
            {
            }
            return CustomContainer.Get<IShellViewModel>();
        }

        public void SetPermission(Permissions permission)
        {
            SetNonePermissions();

            if (permission.HasFlag(Permissions.View))
            {
                SetViewPermissions();
            }
            if (permission.HasFlag(Permissions.Execute))
            {
                SetExecutePermissions();
            }
            if (permission.HasFlag(Permissions.Contribute))
            {
                SetContributePermissions();
            }
            if (permission.HasFlag(Permissions.Administrator))
            {
                SetAdministratorPermissions();
            }
        }

        void SetExecutePermissions()
        {
            CanDebugInputs = true;
            CanDebugStudio = true;
            CanDebugBrowser = true;
            CanRunAllTests = !ResourceModel.IsNewWorkflow;
            CanViewOpenAPI = !ResourceModel.IsNewWorkflow;
            CanCopyUrl = !ResourceModel.IsNewWorkflow;
        }

        void SetViewPermissions()
        {
            CanViewOpenAPI = !ResourceModel.IsVersionResource;
            CanCopyUrl = !ResourceModel.IsVersionResource;
        }

        void SetNonePermissions()
        {
            CanDebugInputs = false;
            CanDebugStudio = false;
            CanDebugBrowser = false;
            CanCreateSchedule = false;
            CanCreateQueueEvent = false;
            CanCreateTest = false;
            CanRunAllTests = false;
            CanDuplicate = false;
            CanDeploy = false;
            CanMerge = false;
            CanShowDependencies = false;
            CanViewOpenAPI = false;
            CanCopyUrl = false;
        }

        void SetAdministratorPermissions()
        {
            CanDebugInputs = true;
            CanDebugStudio = true;
            CanDebugBrowser = true;
            CanCreateSchedule = !ResourceModel.IsNewWorkflow;
            CanCreateQueueEvent = !ResourceModel.IsNewWorkflow;
            CanCreateTest = !ResourceModel.IsNewWorkflow;
            CanRunAllTests = !ResourceModel.IsNewWorkflow;
            CanDuplicate = !ResourceModel.IsNewWorkflow;
            CanDeploy = !ResourceModel.IsNewWorkflow;
            CanMerge = !ResourceModel.IsNewWorkflow;
            CanShowDependencies = !ResourceModel.IsNewWorkflow;
            CanViewOpenAPI = !ResourceModel.IsNewWorkflow;
            CanCopyUrl = !ResourceModel.IsNewWorkflow;
        }

        void SetContributePermissions()
        {
            CanDebugInputs = true;
            CanDebugStudio = true;
            CanDebugBrowser = true;
            CanCreateSchedule = !ResourceModel.IsNewWorkflow;
            CanCreateQueueEvent = !ResourceModel.IsNewWorkflow;
            CanCreateTest = !ResourceModel.IsNewWorkflow;
            CanRunAllTests = !ResourceModel.IsNewWorkflow;
            CanDuplicate = !ResourceModel.IsNewWorkflow;
            CanDeploy = !ResourceModel.IsNewWorkflow;
            CanMerge = !ResourceModel.IsNewWorkflow;
            CanShowDependencies = !ResourceModel.IsNewWorkflow;
            CanViewOpenAPI = !ResourceModel.IsNewWorkflow;
            CanCopyUrl = !ResourceModel.IsNewWorkflow;
        }

        public bool CanCopyUrl
        {
            get => _canCopyUrl;
            set
            {
                _canCopyUrl = value;
                CopyUrlTooltip = ResourceModel.IsNewWorkflow ? Warewolf.Studio.Resources.Languages.Tooltips.DisabledToolTip : _canCopyUrl ? Warewolf.Studio.Resources.Languages.Tooltips.CopyUrlToolTip : Warewolf.Studio.Resources.Languages.Tooltips.NoPermissionsToolTip;
                OnPropertyChanged("CanCopyUrl");
            }
        }

        public string CopyUrlTooltip
        {
            get => _copyUrlTooltip;
            set
            {
                _copyUrlTooltip = value;
                OnPropertyChanged("CopyUrlTooltip");
            }
        }

        public bool CanViewOpenAPI
        {
            get => _canViewOpenAPI;
            set
            {
                _canViewOpenAPI = value;
                ViewOpenAPITooltip = ResourceModel.IsNewWorkflow ? Warewolf.Studio.Resources.Languages.Tooltips.DisabledToolTip : _canViewOpenAPI ? Warewolf.Studio.Resources.Languages.Tooltips.ViewOpenAPIToolTip : Warewolf.Studio.Resources.Languages.Tooltips.NoPermissionsToolTip;
                OnPropertyChanged("CanViewOpenAPI");
            }
        }

        public string ViewOpenAPITooltip
        {
            get => _viewOpenAPITooltip;
            set
            {
                _viewOpenAPITooltip = value;
                OnPropertyChanged("ViewOpenAPITooltip");
            }
        }

        public bool CanShowDependencies
        {
            get => _canShowDependencies;
            set
            {
                _canShowDependencies = value;
                ShowDependenciesTooltip = ResourceModel.IsNewWorkflow ? Warewolf.Studio.Resources.Languages.Tooltips.DisabledToolTip : _canShowDependencies ? Warewolf.Studio.Resources.Languages.Tooltips.DependenciesToolTip : Warewolf.Studio.Resources.Languages.Tooltips.NoPermissionsToolTip;
                OnPropertyChanged("CanShowDependencies");
            }
        }

        public string ShowDependenciesTooltip
        {
            get => _showDependenciesTooltip;
            set
            {
                _showDependenciesTooltip = value;
                OnPropertyChanged("ShowDependenciesTooltip");
            }
        }

        public bool CanDeploy
        {
            get => _canDeploy;
            set
            {
                _canDeploy = value;
                DeployTooltip = ResourceModel.IsNewWorkflow ? Warewolf.Studio.Resources.Languages.Tooltips.DisabledToolTip : _canDeploy ? Warewolf.Studio.Resources.Languages.Tooltips.DeployToolTip : Warewolf.Studio.Resources.Languages.Tooltips.NoPermissionsToolTip;
                OnPropertyChanged("CanDeploy");
            }
        }

        public bool CanMerge
        {
            get
            {
                if (ResourceModel.IsVersionResource || (GetVersionHistory() != null && _canMerge))
                {
                    return true;
                }

                return false;
            }
            set
            {
                _canMerge = value;
                MergeTooltip = Warewolf.Studio.Resources.Languages.Tooltips.ViewMergeTooltip;
                OnPropertyChanged("CanMerge");
            }
        }

        ICollection<IVersionInfo> GetVersionHistory()
        {
            var versionInfos = Server?.ExplorerRepository?.GetVersions(ResourceModel.ID);
            if (versionInfos?.Count <= 0)
            {
                return null;
            }

            return versionInfos;
        }

        public string DeployTooltip
        {
            get => _deployTooltip;
            set
            {
                _deployTooltip = value;
                OnPropertyChanged("DeployTooltip");
            }
        }

        public string MergeTooltip
        {
            get => _mergeTooltip;
            set
            {
                _mergeTooltip = value;
                OnPropertyChanged("MergeTooltip");
            }
        }

        public bool CanDuplicate
        {
            get => _canDuplicate;
            set
            {
                _canDuplicate = value;
                DuplicateTooltip = ResourceModel.IsNewWorkflow ? Warewolf.Studio.Resources.Languages.Tooltips.DisabledToolTip : _canDuplicate ? Warewolf.Studio.Resources.Languages.Tooltips.DuplicateToolTip : Warewolf.Studio.Resources.Languages.Tooltips.NoPermissionsToolTip;
                OnPropertyChanged("CanDuplicate");
            }
        }

        public string DuplicateTooltip
        {
            get => _duplicateTooltip;
            set
            {
                _duplicateTooltip = value;
                OnPropertyChanged("DuplicateTooltip");
            }
        }

        public bool CanRunAllTests
        {
            get => _canRunAllTests;
            set
            {
                _canRunAllTests = value;
                RunAllTestsTooltip = ResourceModel.IsNewWorkflow ? Warewolf.Studio.Resources.Languages.Tooltips.DisabledToolTip : _canRunAllTests ? Warewolf.Studio.Resources.Languages.Tooltips.RunAllTestsToolTip : Warewolf.Studio.Resources.Languages.Tooltips.NoPermissionsToolTip;
                RunCoverageTooltip = ResourceModel.IsNewWorkflow ? Warewolf.Studio.Resources.Languages.Tooltips.DisabledToolTip : _canRunAllTests ? Warewolf.Studio.Resources.Languages.Tooltips.RunCoverageToolTip : Warewolf.Studio.Resources.Languages.Tooltips.NoPermissionsToolTip;
                OnPropertyChanged("CanRunAllTests");
            }
        }

        public string RunAllTestsTooltip
        {
            get => _runAllTestsTooltip;
            set
            {
                _runAllTestsTooltip = value;
                OnPropertyChanged("RunAllTestsTooltip");
            }
        }
        
        public string RunCoverageTooltip
        {
            get => _runCoverageTooltip;
            set
            {
                _runCoverageTooltip = value;
                OnPropertyChanged(nameof(RunCoverageTooltip));
            }
        }

        public bool CanCreateTest
        {
            get => _canCreateTest;
            set
            {
                _canCreateTest = value;
                CreateTestTooltip = ResourceModel.IsNewWorkflow ? Warewolf.Studio.Resources.Languages.Tooltips.DisabledToolTip : _canCreateTest ? Warewolf.Studio.Resources.Languages.Tooltips.TestEditorToolTip : Warewolf.Studio.Resources.Languages.Tooltips.NoPermissionsToolTip;
                OnPropertyChanged("CanCreateTest");
            }
        }

        public string CreateTestTooltip
        {
            get => _createTestTooltip;
            set
            {
                _createTestTooltip = value;
                OnPropertyChanged("CreateTestTooltip");
            }
        }

        public bool CanCreateSchedule
        {
            get => _canCreateSchedule;
            set
            {
                _canCreateSchedule = value;
                ScheduleTooltip = ResourceModel.IsNewWorkflow ? Warewolf.Studio.Resources.Languages.Tooltips.DisabledToolTip : _canCreateSchedule ? Warewolf.Studio.Resources.Languages.Tooltips.ScheduleToolTip : Warewolf.Studio.Resources.Languages.Tooltips.NoPermissionsToolTip;
                OnPropertyChanged("CanCreateSchedule");
            }
        }

        public string ScheduleTooltip
        {
            get => _scheduleTooltip;
            set
            {
                _scheduleTooltip = value;
                OnPropertyChanged("ScheduleTooltip");
            }
        }

        public bool CanCreateQueueEvent
        {
            get => _canCreateQueueEvent;
            set
            {
                _canCreateQueueEvent = value;
                QueueEventTooltip = ResourceModel.IsNewWorkflow ? Warewolf.Studio.Resources.Languages.Tooltips.DisabledToolTip : _canCreateSchedule ? Warewolf.Studio.Resources.Languages.Tooltips.QueueEventToolTip : Warewolf.Studio.Resources.Languages.Tooltips.NoPermissionsToolTip;
                OnPropertyChanged("CanCreateQueueEvent");
            }
        }

        public string QueueEventTooltip
        {
            get => _queueEventTooltip;
            set
            {
                _queueEventTooltip = value;
                OnPropertyChanged("QueueEventTooltip");
            }
        }

        public bool CanDebugBrowser
        {
            get => _debugBrowser;
            set
            {
                _debugBrowser = value;
                DebugBrowserTooltip = ResourceModel.IsNewWorkflow ? Warewolf.Studio.Resources.Languages.Tooltips.DisabledToolTip : _debugBrowser ? Warewolf.Studio.Resources.Languages.Tooltips.StartNodeDebugBrowserToolTip : Warewolf.Studio.Resources.Languages.Tooltips.NoPermissionsToolTip;
                OnPropertyChanged("CanDebugBrowser");
            }
        }

        public string DebugBrowserTooltip
        {
            get => _debugBrowserTooltip;
            set
            {
                _debugBrowserTooltip = value;
                OnPropertyChanged("DebugBrowserTooltip");
            }
        }

        public bool CanDebugStudio
        {
            get => _canDebugStudio;
            set
            {
                _canDebugStudio = value;
                DebugStudioTooltip = ResourceModel.IsNewWorkflow ? Warewolf.Studio.Resources.Languages.Tooltips.DisabledToolTip : _canDebugStudio ? Warewolf.Studio.Resources.Languages.Tooltips.StartNodeDebugStudioToolTip : Warewolf.Studio.Resources.Languages.Tooltips.NoPermissionsToolTip;
                OnPropertyChanged("CanDebugStudio");
            }
        }

        public string DebugStudioTooltip
        {
            get => _debugStudioTooltip;
            set
            {
                _debugStudioTooltip = value;
                OnPropertyChanged("DebugStudioTooltip");
            }
        }

        public bool CanDebugInputs
        {
            get => _canDebugInputs;
            set
            {
                _canDebugInputs = value;
                DebugInputsTooltip = ResourceModel.IsNewWorkflow ? Warewolf.Studio.Resources.Languages.Tooltips.DisabledToolTip : _canDebugInputs ? Warewolf.Studio.Resources.Languages.Tooltips.StartNodeDebugInputsToolTip : Warewolf.Studio.Resources.Languages.Tooltips.NoPermissionsToolTip;
                OnPropertyChanged("CanDebugInputs");
            }
        }

        public string DebugInputsTooltip
        {
            get => _debugInputsTooltip;
            set
            {
                _debugInputsTooltip = value;
                OnPropertyChanged("DebugInputsTooltip");
            }
        }

        void SetOriginalDataList(IContextualResourceModel contextualResourceModel)
        {
            if (!string.IsNullOrEmpty(contextualResourceModel.DataList))
            {
                _originalDataList = contextualResourceModel.DataList.Replace("<DataList>", "").Replace("</DataList>", "").Replace(Environment.NewLine, "").Trim();
            }
        }

        void UpdateOriginalDataList(IContextualResourceModel obj)
        {
            if (obj.IsWorkflowSaved)
            {
                SetOriginalDataList(obj);
            }
        }

        public DebugOutputViewModel DebugOutputViewModel
        {
            get => _debugOutputViewModel;
            set => _debugOutputViewModel = value;
        }

        public IDataListViewModel DataListViewModel
        {
            get => _dataListViewModel;
            set
            {
                _dataListViewModel = value;
                NotifyOfPropertyChange(() => DataListViewModel);
            }
        }

        public override bool HasVariables => true;
        public override bool HasDebugOutput => true;

        public override bool CanSave => ResourceModel.IsAuthorized(AuthorizationContext.Contribute);

        protected virtual bool IsDesignerViewVisible => DesignerView != null && DesignerView.IsVisible;

#pragma warning disable 108,114

        public string DisplayName
#pragma warning restore 108,114
        {
            get
            {
                var displayName = ResourceModel.UserPermissions == Permissions.View ?
                    $"{ResourceHelper.GetDisplayName(ResourceModel)} [READONLY]"
                    : ResourceHelper.GetDisplayName(ResourceModel);
                return displayName;
            }
        }
        
        public string GetAndUpdateWorkflowLinkWithWorkspaceID()
        {
            UpdateWorkflowLink();
            return _workflowLinkWithWid;
        }

        public void UpdateWorkflowLink()
        {
            if (_workflowInputDataViewModel != null)
            {
                if (!string.IsNullOrEmpty(_resourceModel.DataList))
                {
                    _workflowInputDataViewModel.DebugTo.DataList = _resourceModel.DataList;
                }
                _workflowLink = "";
                _workflowInputDataViewModel.LoadWorkflowInputs();
                _workflowInputDataViewModel.SetXmlData(true);
                var buildWebPayLoad = _workflowInputDataViewModel.BuildInputDataList();

                var uri = _resourceModel.GetWorkflowUri(buildWebPayLoad, UrlType.Json, true);
                if (uri != null) {
                    _workflowLinkWithWid = uri.ToString();
                    var startIndex = _workflowLinkWithWid.IndexOf("&wid", StringComparison.InvariantCultureIgnoreCase);
                    if (startIndex != -1)
                    {
                        _workflowLink = _workflowLinkWithWid.Remove(startIndex);
                    }
                }
            }
            NotifyOfPropertyChange(() => DisplayWorkflowLink);
        }

        public string GetWorkflowInputs(string field)
        {
            var workflowInputDataViewModel = _workflowInputDataViewModel as WorkflowInputDataViewModel;
            var inputsValue = workflowInputDataViewModel?.WorkflowInputs?.FirstOrDefault(o => o.Field == field);
            return inputsValue?.Value;
        }

        public string DisplayWorkflowLink
        {
            get
            {
                return _workflowLink;
            }
            private set
            {
                _workflowLink = value;
            }
        }

        public Visibility WorkflowLinkVisible => _resourceModel.IsVersionResource ? Visibility.Hidden : Visibility.Visible;
        public bool CanViewWorkflowLink { get; set; }

        public IPopupController PopUp { get; set; }
        
        public virtual object SelectedModelItem => _wd?.Context?.Items.GetValue<Selection>().SelectedObjects.FirstOrDefault();

        public IContextualResourceModel ResourceModel
        {
            get => _resourceModel;
            set => _resourceModel = value;
        }

        public string WorkflowName => _resourceModel.ResourceName;

        public WorkflowDesigner Designer => _wd;

        public UIElement DesignerView => _wd?.View;

        public StringBuilder DesignerText => ServiceDefinition;

        public StringBuilder ServiceDefinition => _workflowHelper.SerializeWorkflow(_modelService);

        public ICommand CollapseAllCommand => _collapseAllCommand ?? (_collapseAllCommand = new DelegateCommand(param =>
        {
            var val = Convert.ToBoolean(param);
            if (val)
            {
                _designerManagementService.RequestCollapseAll();
            }
            else
            {
                _designerManagementService.RequestRestoreAll();
            }
        }));

        public ICommand ExpandAllCommand => _expandAllCommand ?? (_expandAllCommand = new DelegateCommand(param =>
        {
            var val = Convert.ToBoolean(param);
            if (val)
            {
                _designerManagementService.RequestExpandAll();
            }
            else
            {
                _designerManagementService.RequestRestoreAll();
            }
        }));

        public ICommand OpenWorkflowLinkCommand
        {
            get
            {
                return _openWorkflowLinkCommand ?? (_openWorkflowLinkCommand = new DelegateCommand(param =>
                {
                    if (!string.IsNullOrEmpty(_workflowLink))
                    {
                        if (_applicationTracker != null)
                        {
                            _applicationTracker.TrackEvent(Warewolf.Studio.Resources.Languages.TrackEventMenu.EventCategory,
                                                                Warewolf.Studio.Resources.Languages.TrackEventMenu.LinkUrl);
                        }
                        SaveToWorkspace();
                        if (_workflowInputDataViewModel.WorkflowInputCount == 0)
                        {
                            PopUp.ShowNoInputsSelectedWhenClickLink();
                        }
                        try
                        {
                            OpenLinkInBrowser();
                        }
                        catch (Exception e)
                        {
                            Dev2Logger.Error("OpenWorkflowLinkCommand", e, GlobalConstants.WarewolfError);
                        }
                    }
                }));
            }
        }

        public ICommand NewServiceCommand => _newServiceCommand ?? (_newServiceCommand = new DelegateCommand(param =>
        {
            if (Application.Current != null && Application.Current.Dispatcher != null && Application.Current.Dispatcher.CheckAccess() && Application.Current.MainWindow != null)
            {
                var mvm = Application.Current.MainWindow.DataContext as ShellViewModel;
                if (mvm?.ActiveItem != null)
                {
                    mvm.NewService("");
                }
            }
        }));

        public ICommand DebugInputsCommand => _debugInputsCommand ?? (_debugInputsCommand = new DelegateCommand(param =>
        {
            if (Application.Current != null && Application.Current.Dispatcher != null && Application.Current.Dispatcher.CheckAccess() && Application.Current.MainWindow != null)
            {
                var mvm = Application.Current.MainWindow.DataContext as ShellViewModel;
                if (mvm?.ActiveItem != null)
                {
                    mvm.DebugCommand.Execute(mvm.ActiveItem);
                }
            }
        }));

        public ICommand DebugStudioCommand => _debugStudioCommand ?? (_debugStudioCommand = new DelegateCommand(param =>
        {
            if (Application.Current != null && Application.Current.Dispatcher != null && Application.Current.Dispatcher.CheckAccess() && Application.Current.MainWindow != null)
            {
                var mvm = Application.Current.MainWindow.DataContext as ShellViewModel;
                if (mvm?.ActiveItem != null)
                {
                    mvm.QuickDebugCommand.Execute(mvm.ActiveItem);
                }
            }
        }));

        public ICommand DebugBrowserCommand => _debugBrowserCommand ?? (_debugBrowserCommand = new DelegateCommand(param =>
        {
            OpenLinkInBrowser();
        }));

        static void OpenLinkInBrowser()
        {
            if (Application.Current != null && Application.Current.Dispatcher != null && Application.Current.Dispatcher.CheckAccess() && Application.Current.MainWindow != null)
            {
                var mvm = Application.Current.MainWindow.DataContext as ShellViewModel;
                if (mvm?.ActiveItem != null)
                {
                    mvm.QuickViewInBrowserCommand.Execute(mvm.ActiveItem);
                }
            }
        }

        public ICommand ScheduleCommand => _scheduleCommand ?? (_scheduleCommand = new DelegateCommand(param =>
        {
            if (Application.Current != null && Application.Current.Dispatcher != null && Application.Current.Dispatcher.CheckAccess() && Application.Current.MainWindow != null)
            {
                var mvm = Application.Current.MainWindow.DataContext as ShellViewModel;
                if (mvm?.ActiveItem != null)
                {
                    mvm.CreateNewSchedule(mvm.ActiveItem.ContextualResourceModel.ID);
                }
            }
        }));

        public ICommand QueueEventCommand => _queueEventCommand ?? (_queueEventCommand = new DelegateCommand(param =>
        {
            if (Application.Current != null && Application.Current.Dispatcher != null && Application.Current.Dispatcher.CheckAccess() && Application.Current.MainWindow != null)
            {
                var mvm = Application.Current.MainWindow.DataContext as ShellViewModel;
                if (mvm?.ActiveItem != null)
                {
                    mvm.CreateNewQueueEvent(mvm.ActiveItem.ContextualResourceModel.ID);
                }
            }
        }));

        public ICommand TestEditorCommand => _testEditorCommand ?? (_testEditorCommand = new DelegateCommand(param =>
        {
            if (Application.Current != null && Application.Current.Dispatcher != null && Application.Current.Dispatcher.CheckAccess() && Application.Current.MainWindow != null)
            {
                var mvm = Application.Current.MainWindow.DataContext as ShellViewModel;
                if (mvm?.ActiveItem != null)
                {
                    mvm.CreateTest(mvm.ActiveItem.ContextualResourceModel.ID);
                }
            }
        }));

        public ICommand DuplicateCommand => _duplicateCommand ?? (_duplicateCommand = new DelegateCommand(param =>
        {
            if (Application.Current != null && Application.Current.Dispatcher != null && Application.Current.Dispatcher.CheckAccess() && Application.Current.MainWindow != null)
            {
                var mvm = Application.Current.MainWindow.DataContext as ShellViewModel;
                if (mvm?.ActiveItem != null)
                {
                    IExplorerItemViewModel explorerItem = null;
                    var environmentViewModels = mvm.ExplorerViewModel.Environments.Where(a => a.ResourceId == mvm.ActiveServer.EnvironmentID);
                    foreach (var environmentViewModel in environmentViewModels)
                    {
                        explorerItem = environmentViewModel.Children.Flatten(model => model.Children).FirstOrDefault(c => c.ResourceId == mvm.ActiveItem.ContextualResourceModel.ID);
                    }

                    if (explorerItem != null)
                    {
                        mvm.DuplicateResource(explorerItem);
                    }
                }
            }
        }));

        public ICommand DeployCommand => _deployCommand ?? (_deployCommand = new DelegateCommand(param =>
        {
            if (Application.Current != null && Application.Current.Dispatcher != null && Application.Current.Dispatcher.CheckAccess() && Application.Current.MainWindow != null)
            {
                var mvm = Application.Current.MainWindow.DataContext as ShellViewModel;
                if (mvm?.ActiveItem != null)
                {
                    var explorerItem = GetSelected(mvm);
                    if (explorerItem != null)
                    {
                        mvm.AddDeploySurface(explorerItem.AsList().Union(new[] { explorerItem }));
                    }
                }
            }
        }));

        public ICommand MergeCommand => _mergeCommand ?? (_mergeCommand = new DelegateCommand(param =>
        {
            if (Application.Current?.Dispatcher == null || !Application.Current.Dispatcher.CheckAccess() || Application.Current?.MainWindow == null)
            {
                return;
            }
            MergeWorkflow();
        }));

        public IShellViewModel ShellViewModel => _shellViewModel ?? CustomContainer.Get<IShellViewModel>();
        
        private static void MergeWorkflow()
        {
            var shellViewModel = Application.Current.MainWindow.DataContext as ShellViewModel;
            if (shellViewModel?.ActiveItem == null)
            {
                return;
            }

            var explorerItem = shellViewModel.ActiveItem.ContextualResourceModel.IsVersionResource
                             ? GetMergeResourceVersion(shellViewModel)
                             : GetMergeCurrentResource(shellViewModel);

            if (explorerItem == null)
            {
                return;
            }
            shellViewModel.OpenMergeDialogView(explorerItem);
        }

        private static IExplorerItemViewModel GetMergeResourceVersion(ShellViewModel shellViewModel)
        {
            var resourceId = shellViewModel.ActiveItem.ContextualResourceModel.OriginalId;
            var environmentViewModel = shellViewModel.ExplorerViewModel.Environments.FirstOrDefault(a => a.ResourceId == shellViewModel.ActiveServer.EnvironmentID);
            return environmentViewModel?.UnfilteredChildren?.Flatten(model => model.UnfilteredChildren).FirstOrDefault(c => c.ResourceId == resourceId);
        }

        private static IExplorerItemViewModel GetMergeCurrentResource(ShellViewModel shellViewModel)
        {
            var resourceId = shellViewModel.ActiveItem.ContextualResourceModel.ID;
            var environmentViewModel = shellViewModel.ExplorerViewModel.Environments.FirstOrDefault(a => a.ResourceId == shellViewModel.ActiveServer.EnvironmentID);
            return environmentViewModel?.UnfilteredChildren?.Flatten(model => model.UnfilteredChildren).Where(a => !a.IsVersion).FirstOrDefault(c => c.ResourceId == resourceId);
        }

        static IExplorerItemViewModel GetSelected(ShellViewModel mvm)
        {
            IExplorerItemViewModel explorerItem = null;
            if (mvm?.ActiveServer != null)
            {
                var environmentViewModels = mvm.ExplorerViewModel.Environments.Where(a => a.ResourceId == mvm.ActiveServer.EnvironmentID);
                foreach (var environmentViewModel in environmentViewModels)
                {
                    explorerItem =
                        environmentViewModel.UnfilteredChildren.Flatten(model => model.UnfilteredChildren)
                            .FirstOrDefault(c => c.ResourceId == mvm.ActiveItem.ContextualResourceModel.ID);
                }
            }
            return explorerItem;
        }

        public ICommand ShowDependenciesCommand => _showDependenciesCommand ?? (_showDependenciesCommand = new DelegateCommand(param =>
        {
            if (Application.Current != null && Application.Current.Dispatcher != null && Application.Current.Dispatcher.CheckAccess() && Application.Current.MainWindow != null)
            {
                var mvm = Application.Current.MainWindow.DataContext as ShellViewModel;
                var explorerItem = GetSelected(mvm);
                if (explorerItem != null)
                {
                    mvm.ShowDependencies(mvm.ActiveItem.ContextualResourceModel.ID, mvm.ActiveServer, explorerItem.IsSource || explorerItem.IsServer);
                }
            }
        }));

        public ICommand ViewOpenAPICommand => _viewOpenAPICommand ?? (_viewOpenAPICommand = new DelegateCommand(param =>
        {
            if (Application.Current != null && Application.Current.Dispatcher != null && Application.Current.Dispatcher.CheckAccess() && Application.Current.MainWindow != null)
            {
                var mvm = Application.Current.MainWindow.DataContext as ShellViewModel;
                if (mvm?.ActiveItem != null)
                {
                    mvm.ViewOpenAPI(mvm.ActiveItem.ContextualResourceModel.ResourceName, mvm.ActiveItem.ContextualResourceModel.ResourceName, mvm.ActiveServer.Connection.WebServerUri);
                }
            }
        }));

        public ICommand CopyUrlCommand => _copyUrlCommand ?? (_copyUrlCommand = new DelegateCommand(param =>
        {
            Clipboard.SetText(_workflowLink);
        }));
        
        protected ModelItem PerformAddItems(ModelItem addedItem)


        {
            var mi = addedItem;
            var computedValue = mi.Content?.ComputedValue;

            //Track added items when dragged on design surface
            if (computedValue != null && computedValue.GetType() != typeof(DsfActivity))
            {
                _applicationTracker?.TrackCustomEvent(Warewolf.Studio.Resources.Languages.TrackEventWorkflowTabs.EventCategory, Warewolf.Studio.Resources.Languages.TrackEventWorkflowTabs.ItemDragged, computedValue.ToString());
            }
            if (computedValue == null && (mi.ItemType == typeof(DsfFlowDecisionActivity) ||
                                          mi.ItemType == typeof(DsfFlowSwitchActivity)))
            {
                computedValue = mi.Source?.Value?.Source?.ComputedValue;
            }
            if (computedValue is IDev2Activity act)
            {
                if (_isPaste || string.IsNullOrEmpty(act.UniqueID))
                {
                    act.UniqueID = Guid.NewGuid().ToString();
                }
                _modelItems = _modelService.Find(_modelService.Root, typeof(IDev2Activity));
            }
            if (computedValue is Activity)
            {
                _activityCollection = _modelService.Find(_modelService.Root, typeof(Activity));
            }

            if (mi.ItemType == typeof(FlowSwitch<string>))
            {
                InitializeFlowSwitch(mi);
            }
            else if (mi.ItemType == typeof(FlowDecision))
            {
                InitializeFlowDecision(mi);
                _applicationTracker?.TrackCustomEvent(Warewolf.Studio.Resources.Languages.TrackEventWorkflowTabs.EventCategory, Warewolf.Studio.Resources.Languages.TrackEventWorkflowTabs.ItemDragged, mi.ItemType.Name);
            }
            else if (mi.ItemType == typeof(FlowStep))
            {
                InitializeFlowStep(mi);
            }
            else
            {
                AddSwitch(mi);
            }
            _isPaste = false;
            return addedItem;
        }

        void AddSwitch(ModelItem mi)
        {
            if (mi.Parent?.Parent?.Parent != null && mi.Parent.Parent.Parent.ItemType == typeof(FlowSwitch<string>))
            {
                var activityExpression = mi.Parent.Parent.Parent.Properties["Expression"];
                if (activityExpression != null)
                {
                    var switchExpressionValue = SwitchExpressionValue(activityExpression);
                    var modelProperty = mi.Properties["Key"];
                    if (modelProperty?.Value != null && (FlowController.OldSwitchValue == null || string.IsNullOrWhiteSpace(FlowController.OldSwitchValue)))
                    {
                        FlowController.ConfigureSwitchCaseExpression(new ConfigureCaseExpressionMessage { ModelItem = mi, ExpressionText = switchExpressionValue, Server = _resourceModel.Environment, IsPaste = _isPaste });
                    }
                }
            }
        }
        
        static string SwitchExpressionValue(ModelProperty activityExpression)
        {
            var tmpModelItem = activityExpression.Value;
            var switchExpressionValue = string.Empty;
            var tmpProperty = tmpModelItem?.Properties["ExpressionText"];
            var tmp = tmpProperty?.Value?.ToString();

            if (!string.IsNullOrEmpty(tmp))
            {
                var start = tmp.IndexOf("(", StringComparison.Ordinal);
                var end = tmp.IndexOf(",", StringComparison.Ordinal);

                if (start < end && start >= 0)
                {
                    start += 2;
                    end -= 1;
                    switchExpressionValue = tmp.Substring(start, (end - start));
                }
            }
            return switchExpressionValue;
        }

        void InitializeFlowStep(ModelItem mi)
        {
            // PBI 9135 - 2013.07.15 - TWR - Changed to "as" check so that database activity also flows through this
            var modelProperty1 = mi.Properties["Action"];
            InitialiseWithAction(modelProperty1);
        }

        void InitialiseWithAction(ModelProperty modelProperty1)
        {
            if (modelProperty1?.ComputedValue is DsfActivity droppedActivity)
            {
                if (!string.IsNullOrEmpty(droppedActivity.ServiceName))
                {
                    InitialiseWithoutServiceName(modelProperty1, droppedActivity);
                }
                else
                {
                    InitialiseWithDataObject(droppedActivity);
                }
            }
        }

        void InitialiseWithDataObject(DsfActivity droppedActivity)
        {
            if (DataObject != null)
            {
                if (DataObject is ExplorerItemViewModel viewModel)
                {
                    var serverRepository = CustomContainer.Get<IServerRepository>();
                    var server = serverRepository.FindSingle(c => c.EnvironmentID == viewModel.Server.EnvironmentID);
                    serverRepository.ActiveServer = server;
                    var theResource = server?.ResourceRepository.LoadContextualResourceModel(viewModel.ResourceId);

                    if (theResource != null)
                    {
                        DsfActivity d = DsfActivityFactory.CreateDsfActivity(theResource, droppedActivity, true, serverRepository, _resourceModel.Environment.IsLocalHostCheck());
                        TrackAction(theResource);

                        UpdateForRemote(d, theResource);
                    }
                }
                DataObject = null;
            }
        }

        void TrackAction(IContextualResourceModel theResource)
        {
            if (_applicationTracker != null)
            {
                if (theResource.DisplayName == "Hello World")
                {
                    //track hello world dragged
                    _applicationTracker.TrackCustomEvent(Warewolf.Studio.Resources.Languages.TrackEventWorkflowTabs.EventCategory,
                                       Warewolf.Studio.Resources.Languages.TrackEventWorkflowTabs.HelloWorld, theResource.DisplayName);
                }
                else if (theResource.Category != null && theResource.Category.StartsWith("Examples"))
                {
                    //track examples actitvity dragged
                    _applicationTracker.TrackCustomEvent(Warewolf.Studio.Resources.Languages.TrackEventWorkflowTabs.EventCategory,
                                        Warewolf.Studio.Resources.Languages.TrackEventWorkflowTabs.Examples, theResource.DisplayName);
                }
                else
                {
                    // other than above
                    _applicationTracker.TrackCustomEvent(Warewolf.Studio.Resources.Languages.TrackEventWorkflowTabs.EventCategory,
                                        Warewolf.Studio.Resources.Languages.TrackEventWorkflowTabs.ItemDragged, theResource.DisplayName);
                }
            }
        }

        public ResourceType ResourceType
        {
            get
            {
                if (ResourceModel != null)
                {
                    return ResourceModel.ResourceType;
                }
                return ResourceType.Unknown;
            }
        }

        void InitialiseWithoutServiceName(ModelProperty modelProperty1, DsfActivity droppedActivity)
        {
            var activity = droppedActivity;
            var serverRepository = CustomContainer.Get<IServerRepository>();
            var server = CustomContainer.Get<IServerRepository>().ActiveServer;
            var resourceId = Guid.Parse(activity.ResourceID.Expression.ToString());
            var resource = server.ResourceRepository.LoadContextualResourceModel(resourceId);
            var displayName = resource != null ? resource.DisplayName : activity.DisplayName;

            droppedActivity = DsfActivityFactory.CreateDsfActivity(resource, droppedActivity, false, serverRepository, _resourceModel.Environment.IsLocalHostCheck());
            WorkflowDesignerUtils.CheckIfRemoteWorkflowAndSetProperties(droppedActivity, resource, serverRepository.ActiveServer);
            modelProperty1.SetValue(droppedActivity);
            _applicationTracker?.TrackCustomEvent(Warewolf.Studio.Resources.Languages.TrackEventWorkflowTabs.EventCategory, Warewolf.Studio.Resources.Languages.TrackEventWorkflowTabs.ItemDragged, displayName);
        }

        void InitializeFlowSwitch(ModelItem mi)
        {
            // Travis.Frisinger : 28.01.2013 - Switch Amendments
            Dev2Logger.Info("Publish message of type - " + typeof(ConfigureSwitchExpressionMessage), "Warewolf Info");
            _expressionString = FlowController.ConfigureSwitchExpression(new ConfigureSwitchExpressionMessage { ModelItem = mi, Server = _resourceModel.Environment, IsNew = true, IsPaste = _isPaste });
            AddMissingWithNoPopUpAndFindUnusedDataListItemsImpl(false);
        }

        void InitializeFlowDecision(ModelItem mi)
        {
            Dev2Logger.Info("Publish message of type - " + typeof(ConfigureDecisionExpressionMessage), "Warewolf Info");
            var modelProperty = mi.Properties["Action"];

            InitialiseWithAction(modelProperty);
            _expressionString = FlowController.ConfigureDecisionExpression(new ConfigureDecisionExpressionMessage { ModelItem = mi, Server = _resourceModel.Environment, IsNew = true, IsPaste = _isPaste });
            AddMissingWithNoPopUpAndFindUnusedDataListItemsImpl(false);
        }

        void EditActivity(ModelItem modelItem, Guid parentEnvironmentID)
        {
            if (Designer == null)
            {
                return;
            }
            var modelService = Designer.Context.Services.GetService<ModelService>();
            if (modelService.Root == modelItem.Root && (modelItem.ItemType == typeof(DsfActivity) || modelItem.ItemType.BaseType == typeof(DsfActivity)))
            {
                var resourceID = ModelItemUtils.TryGetResourceID(modelItem);
                var shellViewModel = CustomContainer.Get<IShellViewModel>();
                shellViewModel.OpenResource(resourceID, parentEnvironmentID, shellViewModel.ActiveServer);
            }
        }

        static ModelItem RecursiveForEachCheck(dynamic activity)
        {
            var innerAct = activity.DataFunc.Handler as ModelItem;
            if (innerAct != null)
            {
                if (innerAct.ItemType == typeof(DsfForEachActivity))
                {
                    innerAct = RecursiveForEachCheck(innerAct);
                }
            }
            return innerAct;
        }
        
        void PreventCommandFromBeingExecuted(CanExecuteRoutedEventArgs e)
        {
            if (Designer?.Context != null)
            {
                var selection = Designer.Context.Items.GetValue<Selection>();

                if (selection?.PrimarySelection == null)
                {
                    return;
                }

                if (selection.PrimarySelection.ItemType != typeof(Flowchart) &&
                   selection.SelectedObjects.All(modelItem => modelItem.ItemType != typeof(Flowchart)))
                {
                    return;
                }
            }

            e.CanExecute = false;
            e.Handled = true;
        }
        
        void SetLastDroppedPoint(DragEventArgs e)
        {
            var senderAsFrameworkElement = _modelService.Root.View as FrameworkElement;
            UIElement freePormPanel = senderAsFrameworkElement?.FindNameAcrossNamescopes("flowchartPanel");
            if (freePormPanel != null)
            {
                e.GetPosition(freePormPanel);
            }
        }

        IList<IDataListVerifyPart> BuildWorkflowFields()
        {
            var dataPartVerifyDuplicates = new DataListVerifyPartDuplicationParser();
            _uniqueWorkflowParts = new Dictionary<IDataListVerifyPart, string>(dataPartVerifyDuplicates);
            var modelService = Designer?.Context.Services.GetService<ModelService>();
            if (modelService != null)
            {
                var flowNodes = modelService.Find(modelService.Root, typeof(FlowNode));

                GetWorkflowFieldsFromFlowNodes(flowNodes);
            }
            var flattenedList = _uniqueWorkflowParts.Keys.ToList();
            return flattenedList;
        }

        protected void GetWorkflowFieldsFromFlowNodes(IEnumerable<ModelItem> flowNodes)
        {
            foreach (var flowNode in flowNodes)
            {
                var workflowFields = GetWorkflowFieldsFromModelItem(flowNode);
                foreach (var field in workflowFields)
                {
                    var isJsonObjectSource = field.StartsWith("@");
                    WorkflowDesignerDataPartUtils.BuildDataPart(field, _uniqueWorkflowParts, isJsonObjectSource);
                }
            }
        }

        IEnumerable<string> GetWorkflowFieldsFromModelItem(ModelItem flowNode)
        {
            var workflowFields = new List<string>();
            try
            {
                var modelProperty = flowNode.Properties["Action"];
                if (modelProperty != null)
                {
                    var activity = modelProperty.ComputedValue;
                    workflowFields = GetActivityElements(activity);
                }
                else
                {
                    var propertyName = string.Empty;
                    if (flowNode.ItemType.Name == "FlowDecision")
                    {
                        propertyName = "Condition";
                    }
                    else
                    {
                        if (flowNode.ItemType.Name == "FlowSwitch`1")
                        {
                            propertyName = "Expression";
                        }
                    }

                    var property = flowNode.Properties[propertyName];
                    if (property != null)
                    {
                        workflowFields = GetWorkflowFieldsFromProperty(workflowFields, property);
                    }
                }
            }
            catch (Exception ex)
            {
                Dev2Logger.Error(ex.Message, GlobalConstants.WarewolfError);
            }
            return workflowFields;
        }

        List<string> GetWorkflowFieldsFromProperty(List<string> workflowFields, ModelProperty property)
        {
            if (!string.IsNullOrEmpty(_expressionString))
            {
                workflowFields = TryGetDecisionElements(_expressionString, DataListSingleton.ActiveDataList);
                var activity = property.ComputedValue;
                if (activity != null)
                {
                    workflowFields.AddRange(TryGetDecisionElements(((dynamic)activity).ExpressionText, DataListSingleton.ActiveDataList));
                }
            }
            else
            {
                var activity = property.ComputedValue;
                if (activity != null)
                {
                    workflowFields.AddRange(TryGetDecisionElements(((dynamic)activity).ExpressionText, DataListSingleton.ActiveDataList));
                }
            }

            return workflowFields;
        }

        public static List<String> TryGetDecisionElements(string expression, IDataListViewModel datalistModel)
        {
            var decisionFields = new List<string>();
            if (!string.IsNullOrEmpty(expression))
            {
                var startIndex = expression.IndexOf('"');
                startIndex = startIndex + 1;
                var endindex = expression.IndexOf('"', startIndex);
                var decisionValue = expression.Substring(startIndex, endindex - startIndex);
                try
                {
                    decisionFields = GetDecisionElements(datalistModel, decisionFields, decisionValue);
                }
                catch (Exception)
                {
                    if (!DataListUtil.IsValueRecordset(decisionValue))
                    {
                        var parts = DataListFactory.CreateLanguageParser().ParseExpressionIntoParts(decisionValue, new List<IDev2DataLanguageIntellisensePart>());
                        decisionFields.AddRange(parts.Select(part => DataListUtil.StripBracketsFromValue(part.Option.DisplayValue)));
                        return decisionFields;
                    }
                    if (DataListSingleton.ActiveDataList != null)
                    {
                        var parts = DataListFactory.CreateLanguageParser().ParseDataLanguageForIntellisense(decisionValue, DataListSingleton.ActiveDataList.WriteToResourceModel(), true);
                        decisionFields.AddRange(parts.Select(part => DataListUtil.StripBracketsFromValue(part.Option.DisplayValue)));
                    }
                }
            }
            return decisionFields;
        }

        private static List<string> GetDecisionElements(IDataListViewModel datalistModel, List<string> decisionFields, string decisionValue)
        {
            var dds = JsonConvert.DeserializeObject<Dev2DecisionStack>(decisionValue.Replace('!', '\"'));
            foreach (var decision in dds.TheStack)
            {
                var getCols = new[] { decision.Col1, decision.Col2, decision.Col3 };
                for (var i = 0; i < 3; i++)
                {
                    decisionFields = GetDecisionFields(datalistModel, decisionFields, decisionValue, getCols, i);
                }
            }
            return decisionFields;
        }

        private static List<string> GetDecisionFields(IDataListViewModel datalistModel, List<string> decisionFields, string decisionValue, string[] getCols, int i)
        {
            var getCol = getCols[i];
            if (datalistModel != null)
            {
                var parsed = GetParsedRegions(getCol, datalistModel);
                if (!DataListUtil.IsValueRecordset(getCol) && parsed.Any(DataListUtil.IsValueRecordset))
                {
                    var parts = DataListFactory.CreateLanguageParser().ParseExpressionIntoParts(decisionValue, new List<IDev2DataLanguageIntellisensePart>());
                    decisionFields.AddRange(parts.Select(part => DataListUtil.StripBracketsFromValue(part.Option.DisplayValue)));
                }
                else
                {
                    decisionFields = decisionFields.Union(GetParsedRegions(getCol, datalistModel)).ToList();
                }
            }

            return decisionFields;
        }

        static IEnumerable<string> GetParsedRegions(string getCol, IDataListViewModel datalistModel)
        {
            // Travis.Frisinger - 25.01.2013
            // We now need to parse this data for regions ;)

            var parser = DataListFactory.CreateLanguageParser();
            // NEED - DataList for active workflow
            var parts = parser.ParseDataLanguageForIntellisense(getCol, datalistModel.WriteToResourceModel(), true);

            return (from intellisenseResult in parts
                    select DataListUtil.StripBracketsFromValue(intellisenseResult.Option.DisplayValue)
                    into varWithNoBrackets
                    where !string.IsNullOrEmpty(getCol) && !varWithNoBrackets.Equals(getCol)
                    select getCol
                   ).ToList();
        }

        static List<String> GetActivityElements(object activity)
        {
            var assign = activity as DsfActivityAbstract<string>;
            var other = activity as DsfActivityAbstract<bool>;
            enFindMissingType findMissingType;

            if (assign != null)
            {
                findMissingType = assign.GetFindMissingType();
            }
            else if (other != null)
            {
                findMissingType = other.GetFindMissingType();
            }
            else
            {
                return new List<String>();
            }

            var activityFields = new List<string>();
            var stratFac = new Dev2FindMissingStrategyFactory();
            var strategy = stratFac.CreateFindMissingStrategy(findMissingType);

            foreach (var activityField in strategy.GetActivityFields(activity))
            {
                if (!string.IsNullOrEmpty(activityField))
                {
                    var wdu = new WorkflowDesignerUtils();
                    activityFields.AddRange(wdu.FormatDsfActivityField(activityField).Where(item => !item.Contains("xpath(")));
                }
            }
            return activityFields;
        }

        void OnItemSelected(Selection item)
        {
            var primarySelection = item.PrimarySelection;
            NotifyItemSelected(primarySelection);
            primarySelection.SetProperty("IsSelected", true);
            SelectedItem = primarySelection;
        }

        public Action<ModelItem> ItemSelectedAction { get; set; }

        public void Handle(AddStringListToDataListMessage message)
        {
            Dev2Logger.Info(message.GetType().Name, "Warewolf Info");
            var dlvm = DataListSingleton.ActiveDataList;
            if (dlvm != null)
            {
                var dataPartVerifyDuplicates = new DataListVerifyPartDuplicationParser();
                _uniqueWorkflowParts = new Dictionary<IDataListVerifyPart, string>(dataPartVerifyDuplicates);
                foreach (var s in message.ListToAdd)
                {
                    WorkflowDesignerDataPartUtils.BuildDataPart(s, _uniqueWorkflowParts);
                }
                var partsToAdd = _uniqueWorkflowParts.Keys.ToList();
                var uniqueDataListPartsToAdd = dlvm.MissingDataListParts(partsToAdd);
                dlvm.AddMissingDataListItems(uniqueDataListPartsToAdd);
            }
        }

        public bool NotifyItemSelected(object primarySelection) => false;

        public void BindToModel() => _resourceModel.WorkflowXaml = ServiceDefinition;

        public void InitializeDesigner(IDictionary<Type, Type> designerAttributes) => InitializeDesigner(designerAttributes, false);

        public void InitializeDesigner(IDictionary<Type, Type> designerAttributes, bool liteInit)
        {
            _wd = new WorkflowDesigner();
            if (!liteInit)
            {
                SetHashTable();
                SetDesignerConfigService();

                _wdMeta = new DesignerMetadata();
                _wdMeta.Register();
                var builder = new AttributeTableBuilder();
                foreach (var designerAttribute in designerAttributes)
                {
                    builder.AddCustomAttributes(designerAttribute.Key, new DesignerAttribute(designerAttribute.Value));
                }

                MetadataStore.AddAttributeTable(builder.CreateTable());

                _wd.Context.Items.Subscribe<Selection>(OnItemSelected);
                _wd.Context.Services.Subscribe<ModelService>(ModelServiceSubscribe);
                _wd.Context.Services.Subscribe<DesignerView>(DesigenrViewSubscribe);
                _wd.Context.Services.Publish(_designerManagementService);

                _wd.View.Measure(new Size(2000, 2000));
                _wd.View.PreviewDrop += ViewPreviewDrop;
                _wd.View.PreviewMouseDown += ViewPreviewMouseDown;
                _wd.View.PreviewKeyDown += ViewOnKeyDown;
                _wd.View.LostFocus += OnViewOnLostFocus;

                //Jurie.Smit 2013/01/03 - Added to disable the deleting of the root flowchart
                CommandManager.AddPreviewCanExecuteHandler(_wd.View, CanExecuteRoutedEventHandler);
                _wd.ModelChanged += WdOnModelChanged;
                _wd.View.Focus();

                var indexOfOpenItem = -1;
                if (_wd.ContextMenu?.Items != null)
                {
                    foreach (var menuItem in _wd.ContextMenu.Items.Cast<object>().OfType<MenuItem>().Where(menuItem => (string)menuItem.Header == "_Open"))
                    {
                        indexOfOpenItem = _wd.ContextMenu.Items.IndexOf(menuItem);
                        break;
                    }
                    if (indexOfOpenItem != -1)
                    {
                        _wd.ContextMenu.Items.RemoveAt(indexOfOpenItem);
                    }
                }

                CommandManager.AddPreviewExecutedHandler(_wd.View, PreviewExecutedRoutedEventHandler);

                Selection.Subscribe(_wd.Context, SelectedItemChanged);

                LoadDesignerXaml();
                _workflowHelper.EnsureImplementation(_modelService);

                WorkflowDesignerIcons.Activities.Flowchart = Application.Current.TryFindResource("Explorer-WorkflowService-Icon") as DrawingBrush;
                WorkflowDesignerIcons.Activities.StartNode = Application.Current.TryFindResource("System-StartNode-Icon") as DrawingBrush;
                SubscribeToDebugSelectionChanged();
                SetPermission(ResourceModel.UserPermissions);
                ViewModelUtils.RaiseCanExecuteChanged(_debugOutputViewModel?.AddNewTestCommand);
                UpdateErrorIconWithCorrectMessage();
            }
        }

        public void CreateDesigner() => CreateDesigner(false);

        public void CreateDesigner(bool liteInit)
        {
            _wd = new WorkflowDesigner();

            if (!liteInit)
            {
                SetHashTable();
                SetDesignerConfigService();

                _wdMeta = new DesignerMetadata();
                _wdMeta.Register();
                var builder = new AttributeTableBuilder();
                foreach (var designerAttribute in ActivityDesignerHelper.DesignerAttributes)
                {
                    builder.AddCustomAttributes(designerAttribute.Key, new DesignerAttribute(designerAttribute.Value));
                }

                MetadataStore.AddAttributeTable(builder.CreateTable());

                _wd.Context.Items.Subscribe<Selection>(OnItemSelected);
                _wd.Context.Services.Subscribe<ModelService>(ModelServiceSubscribe);
                _wd.Context.Services.Subscribe<DesignerView>(DesigenrViewSubscribe);
                _wd.Context.Services.Publish(_designerManagementService);

                _wd.View.Measure(new Size(2000, 2000));
                _wd.View.PreviewDrop += ViewPreviewDrop;
                _wd.View.PreviewMouseDown += ViewPreviewMouseDown;
                _wd.View.PreviewKeyDown += ViewOnKeyDown;
                _wd.View.LostFocus += OnViewOnLostFocus;

                //Jurie.Smit 2013/01/03 - Added to disable the deleting of the root flowchart
                CommandManager.AddPreviewCanExecuteHandler(_wd.View, CanExecuteRoutedEventHandler);
                _wd.ModelChanged += WdOnModelChanged;
                _wd.View.Focus();

                var indexOfOpenItem = -1;
                if (_wd.ContextMenu?.Items != null)
                {
                    foreach (var menuItem in _wd.ContextMenu.Items.Cast<object>().OfType<MenuItem>().Where(menuItem => (string)menuItem.Header == "_Open"))
                    {
                        indexOfOpenItem = _wd.ContextMenu.Items.IndexOf(menuItem);
                        break;
                    }
                    if (indexOfOpenItem != -1)
                    {
                        _wd.ContextMenu.Items.RemoveAt(indexOfOpenItem);
                    }
                }

                CommandManager.AddPreviewExecutedHandler(_wd.View, PreviewExecutedRoutedEventHandler);

                Selection.Subscribe(_wd.Context, SelectedItemChanged);
                WorkflowDesignerIcons.Activities.Flowchart = Application.Current.TryFindResource("Explorer-WorkflowService-Icon") as DrawingBrush;
                WorkflowDesignerIcons.Activities.StartNode = Application.Current.TryFindResource("System-StartNode-Icon") as DrawingBrush;
                SubscribeToDebugSelectionChanged();
                SetPermission(ResourceModel.UserPermissions);
                ViewModelUtils.RaiseCanExecuteChanged(_debugOutputViewModel?.AddNewTestCommand);
                UpdateErrorIconWithCorrectMessage();
            }
        }

        void SetHashTable() => _wd.PropertyInspectorFontAndColorData = XamlServices.Save(ActivityDesignerHelper.GetDesignerHashTable());

        void SetDesignerConfigService()
        {
            var designerConfigService = _wd.Context.Services.GetService<DesignerConfigurationService>();
            if (designerConfigService != null)
            {
                // set the runtime Framework version to 4.5 as new features are in .NET 4.5 and do not exist in .NET 4
                designerConfigService.TargetFrameworkName = new FrameworkName(".NETFramework", new Version(4, 5));
                designerConfigService.AutoConnectEnabled = true;
                designerConfigService.AutoSplitEnabled = true;
                designerConfigService.PanModeEnabled = true;
                designerConfigService.RubberBandSelectionEnabled = true;
                designerConfigService.BackgroundValidationEnabled = true;

                // prevent design-time background validation from blocking UI thread
                // Disabled for now
                designerConfigService.AnnotationEnabled = false;
                designerConfigService.AutoSurroundWithSequenceEnabled = false;
            }
        }
        
        static void ViewOnKeyDown(object sender, KeyEventArgs e)
        {
            var grid = sender as Grid;
            if (e.OriginalSource != null)
            {
                var origSource = e.OriginalSource.GetType();
                if (origSource.BaseType == typeof(ActivityDesigner) && e.Key == Key.Return)
                {
                    e.Handled = true;
                }

                var type = grid?.DataContext.GetType();
                if (type == typeof(ServiceTestViewModel) && e.Key == Key.Delete)
                {
                    e.Handled = true;
                }

                if (type == typeof(MergeWorkflowViewModel))
                {
                    if (origSource == typeof(TextBox))
                    {
                        return;
                    }
                    if (e.Key == Key.Delete)
                    {
                        e.Handled = true;
                        return;
                    }
                    var isControlPressed = (Keyboard.Modifiers & ModifierKeys.Control) == ModifierKeys.Control;
                    var isExpectedKey = e.Key == Key.C || e.Key == Key.V;
                    isExpectedKey |= e.Key == Key.X || e.Key == Key.Y || e.Key == Key.Z;
                    if (isControlPressed && isExpectedKey)
                    {
                        e.Handled = true;
                    }
                }
            }
        }

        static void DesigenrViewSubscribe(DesignerView instance)
        {
            // PBI 9221 : TWR : 2013.04.22 - .NET 4.5 upgrade
            instance.WorkflowShellHeaderItemsVisibility = ShellHeaderItemsVisibility.ExpandAll;
            instance.WorkflowShellBarItemVisibility = ShellBarItemVisibility.None;
            instance.WorkflowShellBarItemVisibility = ShellBarItemVisibility.Zoom | ShellBarItemVisibility.PanMode | ShellBarItemVisibility.MiniMap;
        }
        
        void OnViewOnLostFocus(object sender, RoutedEventArgs args)
        {
            var workSurfaceKey = WorkSurfaceKeyFactory.CreateKey(ResourceModel);

            // If we are opening from server skip this check, it cannot have "real" changes!
            if (!OpeningWorkflowsHelper.IsWorkflowWaitingforDesignerLoad(workSurfaceKey))
            {
                // an additional case we need to account for - Designer has resized and is only visible once focus is lost?! ;)
                if (OpeningWorkflowsHelper.IsWaitingForFistFocusLoss(workSurfaceKey) || WatermarkSential.IsWatermarkBeingApplied)
                {
                    ResourceModel.WorkflowXaml = ServiceDefinition;
                    OpeningWorkflowsHelper.RemoveWorkflowWaitingForFirstFocusLoss(workSurfaceKey);
                }
            }
        }

        protected void ModelServiceSubscribe(ModelService instance)
        {
            _modelService = instance;
            _modelService.ModelChanged += ModelServiceModelChanged;
            if (_activityCollection == null)
            {
                _activityCollection = _modelService.Find(_modelService.Root, typeof(Activity));
            }
            if (_modelItems == null)
            {
                _modelItems = _modelService.Find(_modelService.Root, typeof(IDev2Activity));
            }
        }

        void SubscribeToDebugSelectionChanged()
        {
            _virtualizedContainerService = _wd.Context.Services.GetService<VirtualizedContainerService>();
            if (_virtualizedContainerService != null)
            {
                _virtualizedContainerServicePopulateAllMethod = _virtualizedContainerService.GetType().GetMethod("BeginPopulateAll", BindingFlags.Instance | BindingFlags.NonPublic);
            }
            _debugSelectionChangedService.Unsubscribe();
            _debugSelectionChangedService.Subscribe(args =>
            {
                // we only care when the designer is visible
                if (!IsDesignerViewVisible)
                {
                    return;
                }

                if (args.SelectionType == ActivitySelectionType.None)
                {
                    ClearSelection();
                    return;
                }

                var debugState = args.DebugState;
                if (debugState != null)
                {
                    var workSurfaceMappingId = debugState.WorkSurfaceMappingId;
                    var selectedModelItem = GetSelectedModelItem(workSurfaceMappingId, debugState.ParentID.GetValueOrDefault());
                    if (selectedModelItem != null)
                    {
                        switch (args.SelectionType)
                        {
                            case ActivitySelectionType.Single:
                                ClearSelection();
                                SelectSingleModelItem(selectedModelItem);

                                BringIntoView(selectedModelItem);
                                break;

                            case ActivitySelectionType.Add:
                                AddModelItemToSelection(selectedModelItem);

                                BringIntoView(selectedModelItem);
                                break;

                            case ActivitySelectionType.Remove:
                                RemoveModelItemFromSelection(selectedModelItem);
                                break;

                            case ActivitySelectionType.None:
                                break;

                            default:
                                break;
                        }
                    }
                }
            });
        }

        public bool IsTestView { get; set; }

        protected virtual ModelItem GetSelectedModelItem(Guid itemId, Guid parentId)
        {
            if (_modelService != null)
            {
                var selectedModelItem = (from mi in _modelItems
                                         let instanceID = ModelItemUtils.GetUniqueID(mi)
                                         where instanceID == itemId || instanceID == parentId
                                         select mi).FirstOrDefault();

                if (selectedModelItem == null)
                {
                    // Find the root flow chart
                    selectedModelItem = _modelService.Find(_modelService.Root, typeof(Flowchart)).FirstOrDefault();
                }
                else
                {
                    if (DecisionSwitchTypes.Contains(selectedModelItem.Parent.ItemType))
                    {
                        // Decision/switches activities are represented by their parents in the designer!
                        selectedModelItem = selectedModelItem.Parent;
                    }
                }
                return selectedModelItem;
            }
            return null;
        }

        void SelectSingleModelItem(ModelItem selectedModelItem)
        {
            if (SelectedDebugItems.Contains(selectedModelItem))
            {
                return;
            }
            Selection.SelectOnly(_wd.Context, selectedModelItem);
            SelectedDebugItems.Add(selectedModelItem);
        }

        void RemoveModelItemFromSelection(ModelItem selectedModelItem)
        {
            if (SelectedDebugItems.Contains(selectedModelItem))
            {
                SelectedDebugItems.Remove(selectedModelItem);
            }
            Selection.Unsubscribe(_wd.Context, SelectedItemChanged);
        }

        public List<ModelItem> DebugModels => SelectedDebugItems;

        void AddModelItemToSelection(ModelItem selectedModelItem)
        {
            if (SelectedDebugItems.Contains(selectedModelItem))
            {
                return;
            }
            Selection.Union(_wd.Context, selectedModelItem);

            var modelItems = _activityCollection as ModelItem[] ?? _activityCollection.ToArray();
            var index = modelItems.ToList().IndexOf(selectedModelItem);
            if (index != -1)
            {
                Selection.Select(_wd.Context, modelItems.ElementAt(index));
            }
            else
            {
                if (DecisionSwitchTypes.Contains(selectedModelItem.Parent.ItemType))
                {
                    // Decision/switches activities are represented by their parents in the designer!
                    selectedModelItem = selectedModelItem.Parent;
                    index = modelItems.ToList().IndexOf(selectedModelItem);
                    if (index != -1)
                    {
                        Selection.Select(_wd.Context, modelItems.ElementAt(index));
                    }
                }
            }
            SelectedDebugItems.Add(selectedModelItem);
        }

        void ClearSelection()
        {
            _wd.Context.Items.SetValue(new Selection());
            if (_selectedDebugItems != null)
            {
                foreach (var selectedDebugItem in _selectedDebugItems)
                {
                    selectedDebugItem.SetProperty("IsSelected", false);
                }
            }
            _selectedDebugItems = new List<ModelItem>();
        }

        protected virtual void BringIntoView(ModelItem selectedModelItem)
        {
            if (selectedModelItem.View is FrameworkElement view && view.IsVisible)
            {
                BringIntoView(view);
                return;
            }

            var onAfterPopulateAll = new System.Action(() => BringIntoView(selectedModelItem.View as FrameworkElement));
            _virtualizedContainerServicePopulateAllMethod?.Invoke(_virtualizedContainerService, new object[] { onAfterPopulateAll });
        }

        public void BringMergeToView(DataTemplate selectedDataTemplate)
        {
            var dependencyObject = selectedDataTemplate.LoadContent();
            var frameworkElement = dependencyObject as FrameworkElement;
            BringIntoView(frameworkElement);
        }

        static void BringIntoView(FrameworkElement view) => Application.Current?.Dispatcher?.InvokeAsync(() => view?.BringIntoView(), DispatcherPriority.Background);

        protected void LoadDesignerXaml()
        {
            var xaml = _resourceModel.WorkflowXaml;

            // if null, try fetching. It appears there is more than the two routes identified to populating xaml ;(
            if (xaml == null || xaml.Length == 0)
            {
                // we always want server at this point ;)
                var workspace = GlobalConstants.ServerWorkspaceID;

                // log the trace for fetch ;)
                Dev2Logger.Info($"Null Definition For {_resourceModel.ID} :: {_resourceModel.ResourceName}. Fetching...", "Warewolf Info");

                // In the case of null of empty try fetching again ;)
                var msg = Server.ResourceRepository.FetchResourceDefinition(_resourceModel.Environment, workspace, _resourceModel.ID, false);
                if (msg != null)
                {
                    xaml = msg.Message;
                }
            }

            // if we still cannot find it, create a new one ;)
            if (xaml == null || xaml.Length == 0)
            {
                if (_resourceModel.ResourceType == ResourceType.WorkflowService)
                {
                    // log the trace for fetch ;)
                    CreateBlankWorkflow();
                }
                else
                {
                    // we have big issues ;(
                    throw new Exception($"Could not find resource definition for {_resourceModel.ResourceName}");
                }
            }
            else
            {
                SetDesignerText(xaml);
                _wd.Load();
            }
        }

        public void CreateBlankWorkflow()
        {
            CreateDesigner();
            var activityBuilder = _workflowHelper.CreateWorkflow(_resourceModel.ResourceName);
            _wd.Load(activityBuilder);
            BindToModel();
            _workflowHelper.EnsureImplementation(_modelService);
        }

        void SetDesignerText(StringBuilder xaml)
        {
            var designerText = _workflowHelper.SanitizeXaml(xaml);
            if (designerText != null)
            {
                _wd.Text = designerText.ToString();
            }
        }

        void SelectedItemChanged(Selection item)
        {
            if (_wd?.Context != null)
            {
                var contextItemManager = _wd.Context.Items;
                var selection = contextItemManager.GetValue<Selection>();
                if (selection.SelectedObjects.Count() > 1)
                {
                    DeselectFlowchart();
                }
            }
        }

        void DeselectFlowchart()
        {
            if (_wd?.Context != null)
            {
                var editingContext = _wd.Context;
                var selection = editingContext.Items.GetValue<Selection>();
                foreach (var item in selection.SelectedObjects.Where(item => item.ItemType == typeof(Flowchart)))
                {
                    Selection.Toggle(editingContext, item);
                    break;
                }
            }
        }

        public List<NameValue> GetSelectableGates(string uniqueId)
        {
            var serviceDifferenceParser = CustomContainer.Get<IServiceDifferenceParser>();
            var treeNodes = serviceDifferenceParser.BuildWorkflow(ServiceDefinition);

            var list = new List<NameValue> { new NameValue { Name = "End", Value = Guid.Empty.ToString() } };
            try
            {
                IEnumerable<IDev2Activity> connectedList(IDev2Activity activity)
                {
                    var ret = new List<IDev2Activity>();
                    ret.Add(activity);
                    if (activity.NextNodes is null)
                    {
                        return ret;
                    }

                    foreach (var nextActivity in activity.NextNodes)
                    {
                        ret.AddRange(connectedList(nextActivity));
                    }
                    return ret.Where(o => (o is GateActivity));
                }

                bool found = false;
                var allGates = connectedList(treeNodes[0].Activity)
                    .Cast<GateActivity>()
                    .Where(gate => gate?.GateOptions != null && gate.GateOptions.GateOpts is Continue);

                var selectableGates = allGates
                    .TakeWhile(gate => !(found = (gate.UniqueID == uniqueId)));

                foreach (var gate in selectableGates)
                {
                    var id = gate.UniqueID;
                    var activityName = gate.GetDisplayName();
                    var nameValue = new NameValue { Name = activityName, Value = id };
                    list.Add(nameValue);
                }
            }
            catch (Exception ex)
            {
                Dev2Logger.Error("Error loading selectable gates. Exception: " + ex.Message, GlobalConstants.ServerWorkspaceID.ToString());
            }
            return list;
        }

        protected void WdOnModelChanged(object sender, EventArgs eventArgs)
        {
            if ((Designer != null && Designer.View.IsKeyboardFocusWithin) || sender != null)
            {
                var workSurfaceKey = WorkSurfaceKeyFactory.CreateKey(ResourceModel);
                UpdateErrorIconWithCorrectMessage();

                // If we are opening from server skip this check, it cannot have "real" changes!
                if (!OpeningWorkflowsHelper.IsWorkflowWaitingforDesignerLoad(workSurfaceKey))
                {
                    // an additional case we need to account for - Designer has resized and is only visible once focus is lost?! ;)
                    if (OpeningWorkflowsHelper.IsWaitingForFistFocusLoss(workSurfaceKey))
                    {
                        ResourceModel.WorkflowXaml = ServiceDefinition;
                        OpeningWorkflowsHelper.RemoveWorkflowWaitingForFirstFocusLoss(workSurfaceKey);
                    }
                    if (ResourceModel.WorkflowXaml is null)
                    {
                        ResourceModel.WorkflowXaml = ServiceDefinition;
                    }

                    var checkServiceDefinition = CheckServiceDefinition();
                    var checkDataList = CheckDataList();

                    ResourceModel.IsWorkflowSaved = checkServiceDefinition && checkDataList;
                    _workspaceSave = false;
                    WorkflowChanged?.Invoke();
                    NotifyOfPropertyChange(() => DisplayName);
                    ViewModelUtils.RaiseCanExecuteChanged(_debugOutputViewModel?.AddNewTestCommand);
                }
                else
                {
                    // When opening from server, save the hydrated changes for future comparison ;)
                    if (!CheckServiceDefinition())
                    {
                        // process any latent datalist changes ;)
                        ProcessDataListOnLoad();
                        ResourceModel.WorkflowXaml = ServiceDefinition;
                    }
                }

                // THIS MUST NEVER BE DELETED ;)
                WatermarkSential.IsWatermarkBeingApplied = false;
            }
            if (_firstWorkflowChange)
            {
                AddMissingWithNoPopUpAndFindUnusedDataListItemsImpl(false);
                _firstWorkflowChange = false;
            }
        }

        void UpdateErrorIconWithCorrectMessage()
        {
            var validationIcon = DesignerView?.FindChild<Border>(border => border.Name.Equals("validationVisuals", StringComparison.CurrentCultureIgnoreCase));
            if (validationIcon != null && validationIcon.Name.Equals("validationVisuals", StringComparison.CurrentCultureIgnoreCase))
            {
                validationIcon.ToolTip = Warewolf.Studio.Resources.Languages.Tooltips.StartNodeNotConnectedToolTip;

                //It should be called once when there is first tool dragged or start node link get deleted
                if (!IsStartNodeErrorMessageSet)
                {
                    IsStartNodeErrorMessageSet = true;
                    _applicationTracker?.TrackEvent(Warewolf.Studio.Resources.Languages.TrackEventWorkflowTabs.EventCategory, Warewolf.Studio.Resources.Languages.TrackEventWorkflowTabs.StartNodeNotConnected);
                }
            }
        }

        bool CheckDataList()
        {
            if (_originalDataList == null)
            {
                return true;
            }

            if (ResourceModel.DataList != null)
            {
                var currentDataList = ResourceModel.DataList.Replace("<DataList>", "").Replace("</DataList>", "");
                return StringExtension.SpaceCaseInsenstiveComparision(currentDataList, _originalDataList);
            }
            return true;
        }
        string _serviceDefinitionXamlCache = "";
        string _resourceDefinitionXamlCache = "";
        bool _serviceAndResourceDefinitionXamlSameCache;
        bool CheckServiceDefinition()
        {
            if (ServiceDefinition is null || ResourceModel.WorkflowXaml is null)
            {
                return ServiceDefinition == ResourceModel.WorkflowXaml;
            }
            var serviceDefinitionXaml = ServiceDefinition.ToString();
            var resourceDefinitionXaml = ResourceModel.WorkflowXaml.ToString();
            if (serviceDefinitionXaml == _serviceDefinitionXamlCache && resourceDefinitionXaml == _resourceDefinitionXamlCache)
            {
                return _serviceAndResourceDefinitionXamlSameCache;
            }

            _serviceDefinitionXamlCache = serviceDefinitionXaml;
            _resourceDefinitionXamlCache = resourceDefinitionXaml;

            var eq = WorkflowHelper.AreWorkflowsEqual(ServiceDefinition.ToString(), ResourceModel.WorkflowXaml.ToString());
            _serviceAndResourceDefinitionXamlSameCache = eq;
            return eq;
        }
        
        void ProcessDataListOnLoad()
        {
            AddMissingWithNoPopUpAndFindUnusedDataListItemsImpl(true);
        }

        public void DoWorkspaceSave()
        {
            if (ResourceModel != null && ResourceModel.IsNewWorkflow && !_workspaceSave && ResourceModel.Environment.IsConnected)
            {
                _asyncWorker.Start(SaveToWorkspace);
            }
            AddMissingWithNoPopUpAndFindUnusedDataListItemsImpl(false);
        }

        void SaveToWorkspace()
        {
            BindToModel();
            ResourceModel.Environment.ResourceRepository.Save(ResourceModel);
            _workspaceSave = true;
        }
        
        public void UpdateDataList()
        {
            AddMissingWithNoPopUpAndFindUnusedDataListItemsImpl(false);
        }

        public static bool ValidatResourceModel(string dataList)
        {
            try
            {
                if (!string.IsNullOrEmpty(dataList))
                {
                    XElement.Parse(dataList);
                }
            }
            catch (Exception)
            {
                return false;
            }
            return true;
        }

        public void AddMissingWithNoPopUpAndFindUnusedDataListItems()
        {
            UpdateDataList();
        }

        public ModelItem GetModelItem(Guid workSurfaceMappingId, Guid parentID)
        {
            var modelItems = _modelService.Find(_modelService.Root, typeof(IDev2Activity));
            ModelItem selectedModelItem = null;
            foreach (var mi in modelItems)
            {
                var instanceID = ModelItemUtils.GetUniqueID(mi);
                if (instanceID == workSurfaceMappingId || instanceID == parentID)
                {
                    selectedModelItem = mi;
                    break;
                }
            }
            return selectedModelItem;
        }

        void AddMissingWithNoPopUpAndFindUnusedDataListItemsImpl(bool isLoadEvent)
        {
            if (DataListViewModel != null)
            {
                if (Application.Current != null && Application.Current.Dispatcher != null)
                {
                    Application.Current.Dispatcher.BeginInvoke(new System.Action(() =>
                    {
                        UpdateDataListWithMissingParts(isLoadEvent);
                    }), DispatcherPriority.Background);
                }
                else
                {
                    UpdateDataListWithMissingParts(isLoadEvent);
                }
            }
        }

        void UpdateDataListWithMissingParts(bool isLoadEvent)
        {
            var workSurfaceKey = WorkSurfaceKeyFactory.CreateKey(ResourceModel);
            if (OpeningWorkflowsHelper.IsWorkflowWaitingforDesignerLoad(workSurfaceKey) && !isLoadEvent)
            {
                OpeningWorkflowsHelper.RemoveWorkflowWaitingForDesignerLoad(workSurfaceKey);
            }

            var workflowFields = BuildWorkflowFields();
            DataListViewModel?.UpdateDataListItems(ResourceModel, workflowFields);
        }

        void ViewPreviewMouseDown(object sender, MouseButtonEventArgs e) => e.Handled = HandleMouseClick(e.LeftButton, e.ClickCount, e.OriginalSource as DependencyObject, e.Source as DesignerView);
        
        bool HandleMouseClick(MouseButtonState leftButtonState, int clickCount, DependencyObject dp, DesignerView designerView)
        {
            if (HandleDoubleClick(leftButtonState, clickCount, dp, designerView))
            {
                return true;
            }

            if (Application.Current != null && Application.Current.Dispatcher != null && Application.Current.Dispatcher.CheckAccess() && Application.Current.MainWindow != null)
            {
                var mvm = Application.Current.MainWindow.DataContext as ShellViewModel;
                if (mvm?.ActiveItem != null)
                {
                    mvm.RefreshActiveServer();
                }
            }

            if (dp is Border border && border.DataContext is GateDesignerViewModel gateDesignerViewModel)
            {
                gateDesignerViewModel.ClearGates();
                string uniqueId = gateDesignerViewModel.ModelItem.Properties["UniqueID"].ComputedValue.ToString();
                var gates = GetSelectableGates(uniqueId);
                gateDesignerViewModel.Gates = gates;
            }

            var dp1 = dp as Run;
            if (dp1?.Parent is TextBlock && dp1.DataContext.GetType().Name.Contains("FlowchartDesigner"))
            {
                var selectedModelItem = _modelService.Find(_modelService.Root, typeof(Flowchart)).FirstOrDefault();
                if (selectedModelItem != null)
                {
                    SelectSingleModelItem(selectedModelItem);
                }
                return true;
            }

            if (dp is TextBlock dp2 && dp2.DataContext.GetType().Name.Contains("FlowchartDesigner"))
            {
                var selectedModelItem = _modelService.Find(_modelService.Root, typeof(Flowchart)).FirstOrDefault();
                if (selectedModelItem != null)
                {
                    SelectSingleModelItem(selectedModelItem);
                }
                return true;
            }

            return false;
        }
        
        bool HandleDoubleClick(MouseButtonState leftButtonState, int clickCount, DependencyObject dp, DesignerView designerView)
        {
            if (leftButtonState == MouseButtonState.Pressed && clickCount == 2)
            {
                if (designerView != null && designerView.FocusedViewElement == null)
                {
                    return true;
                }

                var item = SelectedModelItem as ModelItem;

                if (item != null && item.ItemType == typeof(Flowchart))
                {
                    return true;
                }

                HandleDependencyObject(dp, item);
            }
            return false;
        }
        
        void HandleDependencyObject(DependencyObject dp, ModelItem item)
        {
            if (item != null)
            {
                var itemFn = item.ItemType.FullName;

                if (dp != null && string.Equals(dp.ToString(), "Microsoft.Windows.Themes.ScrollChrome", StringComparison.InvariantCulture))
                {
                    WizardEngineAttachedProperties.SetDontOpenWizard(dp, true);
                }

                // Handle Case Edits
                if (itemFn.StartsWith("System.Activities.Core.Presentation.FlowSwitchCaseLink", StringComparison.Ordinal) &&
                    !itemFn.StartsWith("System.Activities.Core.Presentation.FlowSwitchDefaultLink", StringComparison.Ordinal))
                {
                    if (dp != null && !WizardEngineAttachedProperties.GetDontOpenWizard(dp))
                    {
                        FlowController.TryEditSwitchCaseExpression(new EditCaseExpressionMessage
                        {
                            ModelItem = item,
                            Server = _resourceModel.Environment
                        });
                    }
                }

                // Handle Switch Edits
                if (dp != null && !WizardEngineAttachedProperties.GetDontOpenWizard(dp) &&
                    item.ItemType == typeof(FlowSwitch<string>))
                {
                    _expressionString =
                        FlowController.ConfigureSwitchExpression(new ConfigureSwitchExpressionMessage
                        {
                            ModelItem = item,
                            Server = _resourceModel.Environment
                        });
                    AddMissingWithNoPopUpAndFindUnusedDataListItemsImpl(false);
                }

                //// Handle Decision Edits
                if (dp != null && !WizardEngineAttachedProperties.GetDontOpenWizard(dp) &&
                    item.ItemType == typeof(FlowDecision))
                {
                    _expressionString =
                        FlowController.ConfigureDecisionExpression(new ConfigureDecisionExpressionMessage
                        {
                            ModelItem = item,
                            Server = _resourceModel.Environment
                        });
                    AddMissingWithNoPopUpAndFindUnusedDataListItemsImpl(false);
                }
            }
        }
        
        static IResourcePickerDialog CreateResourcePickerDialog(enDsfActivityType activityType)
        {
            var server = CustomContainer.Get<IServerRepository>().ActiveServer;

            if (server.Permissions == null)
            {
                server.Permissions = new List<IWindowsGroupPermission>();
                server.Permissions.AddRange(server.AuthorizationService.SecurityService.Permissions);
            }
            var env = new EnvironmentViewModel(server, CustomContainer.Get<IShellViewModel>(), true);
            var res = new ResourcePickerDialog(activityType, env);
            ResourcePickerDialog.CreateAsync(activityType, env);
            return res;
        }
        
        void ViewPreviewDrop(object sender, DragEventArgs e)
        {
            SetLastDroppedPoint(e);
            var dataObject = e.Data;
            e.Handled = ApplyForDrop(dataObject);
        }

        protected bool ApplyForDrop(IDataObject dataObject)
        {
            var handled = false;
            if (dataObject != null)
            {
                DataObject = dataObject.GetData(typeof(ExplorerItemViewModel));
                if (DataObject != null)
                {
                    IsItemDragged.Instance.IsDragged = true;
                }

                if (dataObject.GetData("WorkflowItemTypeNameFormat") is string isWorkflow)
                {
                    handled = WorkflowDropFromResourceToolboxItem(dataObject, isWorkflow, true, false);
                    ApplyIsDraggedInstance(isWorkflow);
                }
                else
                {
                    IsItemDragged.Instance.IsDragged = false;
                }
            }
            return handled;
        }

        static void ApplyIsDraggedInstance(string isWorkflow)
        {
            IsItemDragged.Instance.IsDragged |= isWorkflow.Contains("DsfSqlServerDatabaseActivity") || isWorkflow.Contains("DsfMySqlDatabaseActivity");
            IsItemDragged.Instance.IsDragged |= isWorkflow.Contains("DsfODBCDatabaseActivity") || isWorkflow.Contains("DsfOracleDatabaseActivity");
            IsItemDragged.Instance.IsDragged |= isWorkflow.Contains("DsfPostgreSqlActivity") || isWorkflow.Contains("DsfWebDeleteActivity");
            IsItemDragged.Instance.IsDragged |= isWorkflow.Contains("DsfWebGetActivity") || isWorkflow.Contains("WebPostActivity");
            IsItemDragged.Instance.IsDragged |= isWorkflow.Contains("DsfWebPutActivity") || isWorkflow.Contains("DsfComDllActivity");
            IsItemDragged.Instance.IsDragged |= isWorkflow.Contains("DsfEnhancedDotNetDllActivity") || isWorkflow.Contains("DsfWcfEndPointActivity");
            IsItemDragged.Instance.IsDragged |= isWorkflow.Contains("AdvancedRecordsetActivity");
            IsItemDragged.Instance.IsDragged |= isWorkflow.Contains("GateActivity");
        }
        
        bool WorkflowDropFromResourceToolboxItem(IDataObject dataObject, string isWorkflow, bool dropOccured, bool handled)
        {
            var activityType = ResourcePickerDialog.DetermineDropActivityType(isWorkflow);
            if (IsTestView)
            {
                return true;
            }
            if (activityType != enDsfActivityType.All)
            {
                var dialog = CreateResourcePickerDialog(activityType);
                if (dialog.ShowDialog())
                {
                    var res = dialog.SelectedResource;
                    if (res != null)
                    {
                        dataObject.SetData(res);
                        dataObject.SetData(new FromToolBox());
                        DataObject = res;
                    }
                    if (res == null)
                    {
                        dropOccured = false;
                        handled = true;
                    }
                }
                else
                {
                    handled = true;
                    dropOccured = false;
                }
            }
            if (dropOccured)
            {
                _workspaceSave = false;
                ResourceModel.IsWorkflowSaved = false;
                NotifyOfPropertyChange(() => DisplayName);
            }
            return handled;
        }

        // Activity : Next
        // Decision : True, False
        // Switch   : Default, Key
        public static readonly string[] SelfConnectProperties =
        {
            "Next",
            "True",
            "False",
            "Default",
            "Key"
        };

        string _originalDataList;
        bool _workspaceSave;
        WorkflowInputDataViewModel _workflowInputDataViewModel;
        string _workflowLink;
        string _workflowLinkWithWid;
        ICommand _openWorkflowLinkCommand;
        bool _firstWorkflowChange;
        readonly IAsyncWorker _asyncWorker;
        string _expressionString;
        ICommand _debugInputsCommand;
        ICommand _debugStudioCommand;
        ICommand _debugBrowserCommand;
        ICommand _scheduleCommand;
        ICommand _queueEventCommand;
        ICommand _testEditorCommand;
        ICommand _runAllTestsCommand;
        ICommand _duplicateCommand;
        ICommand _deployCommand;
        ICommand _showDependenciesCommand;
        ICommand _viewOpenAPICommand;
        ICommand _copyUrlCommand;
        DebugOutputViewModel _debugOutputViewModel;
        IDataListViewModel _dataListViewModel;
        bool _canDebugInputs;
        bool _canDebugStudio;
        bool _debugBrowser;
        bool _canCreateSchedule;
        bool _canCreateQueueEvent;
        bool _canCreateTest;
        bool _canRunAllTests;
        bool _canDuplicate;
        bool _canDeploy;
        bool _canShowDependencies;
        bool _canViewOpenAPI;
        bool _canCopyUrl;
        string _copyUrlTooltip;
        string _viewOpenAPITooltip;
        string _debugInputsTooltip;
        string _debugStudioTooltip;
        string _debugBrowserTooltip;
        string _scheduleTooltip;
        string _queueEventTooltip;
        string _createTestTooltip;
        string _runAllTestsTooltip;
        string _runCoverageTooltip;
        string _duplicateTooltip;
        string _deployTooltip;
        string _showDependenciesTooltip;
        ICommand _newServiceCommand;
        ModelItem _selectedItem;
        IEnumerable<ModelItem> _modelItems;
        IEnumerable<ModelItem> _activityCollection;
        ICommand _mergeCommand;
        bool _canMerge;
        string _mergeTooltip;
       
        protected void ModelServiceModelChanged(object sender, ModelChangedEventArgs e)
        {
            if (e.ModelChangeInfo != null &&
                e.ModelChangeInfo.ModelChangeType == ModelChangeType.PropertyChanged)
            {
                if (SelfConnectProperties.Contains(e.ModelChangeInfo.PropertyName))
                {
                    if (e.ModelChangeInfo.Subject == e.ModelChangeInfo.Value)
                    {
                        var modelProperty = e.ModelChangeInfo.Value.Properties[e.ModelChangeInfo.PropertyName];
                        modelProperty?.ClearValue();
                    }
                    return;
                }
                if (e.ModelChangeInfo.PropertyName == "StartNode")
                {
                    if (e.ModelChangeInfo.OldValue != null)
                    {
                        // incase of delete it will have old value then log
                        IsStartNodeErrorMessageSet = false;
                    }
                    return;
                }

                if (e.ModelChangeInfo.PropertyName == "Handler")
                {
                    if (DataObject != null)
                    {
                        ModelItemPropertyChanged(e);
                    }
                }
            }

            if (e.ModelChangeInfo != null && e.ModelChangeInfo.ModelChangeType == ModelChangeType.CollectionItemAdded)
            {
                PerformAddItems(e.ModelChangeInfo.Value);
            }

            if (e.ModelChangeInfo != null && e.ModelChangeInfo.ModelChangeType == ModelChangeType.PropertyChanged
                && (e.ModelChangeInfo.Value?.Source?.ComputedValue?.GetType() == typeof(DsfFlowDecisionActivity)
                || e.ModelChangeInfo.Value?.Source?.ComputedValue?.GetType() == typeof(DsfFlowSwitchActivity)))
            {
                PerformAddItems(e.ModelChangeInfo.Value);
            }
            WorkflowChanged?.Invoke();
        }

        void ModelItemPropertyChanged(ModelChangedEventArgs e)
        {
            Guid? envID = null;
            Guid? resourceID = null;
            if (DataObject is IExplorerItemViewModel explorerItem)
            {
                if (explorerItem.Server != null)
                {
                    envID = explorerItem.Server.EnvironmentID;
                }

                resourceID = explorerItem.ResourceId;
            }

            var modelProperty = e.ModelChangeInfo.Subject.Content;

            if (envID != null && modelProperty != null)
            {
                var server = CustomContainer.Get<IServerRepository>().FindSingle(c => c.EnvironmentID == envID);
                var resource = server?.ResourceRepository.LoadContextualResourceModel(resourceID.Value);
                if (resource != null)
                {
                    var d = DsfActivityFactory.CreateDsfActivity(resource, null, true, CustomContainer.Get<IServerRepository>(), _resourceModel.Environment.IsLocalHostCheck());
                    d.ServiceName = d.DisplayName = d.ToolboxFriendlyName = resource.Category;
                    UpdateForRemote(d, resource);
                    modelProperty.SetValue(d);
                }
            }
            DataObject = null;
            WorkflowChanged?.Invoke();
        }

        void UpdateForRemote(DsfActivity d, IContextualResourceModel resource)
        {
            if (Application.Current != null && Application.Current.Dispatcher.CheckAccess() && Application.Current.MainWindow != null)
            {
                dynamic mvm = Application.Current.MainWindow.DataContext;
                if (mvm?.ActiveItem != null)
                {
                    WorkflowDesignerUtils.CheckIfRemoteWorkflowAndSetProperties(d, resource, mvm.ActiveItem.Environment);
                }
            }
            else
            {
                if (ActiveEnvironment != null)
                {
                    WorkflowDesignerUtils.CheckIfRemoteWorkflowAndSetProperties(d, resource, ActiveEnvironment);
                }
            }
        }

        protected IServer ActiveEnvironment { get; set; }

        void CanExecuteRoutedEventHandler(object sender, CanExecuteRoutedEventArgs e)
        {
            if (e.Command.Equals(ApplicationCommands.Delete) ||      //triggered from deleting an activity
                e.Command.Equals(EditingCommands.Delete) ||          //triggered from editing displayname, expressions, etc
                e.Command.Equals(System.Activities.Presentation.View.DesignerView.CopyCommand) ||
                e.Command.Equals(System.Activities.Presentation.View.DesignerView.CutCommand))
            {
                PreventCommandFromBeingExecuted(e);
            }
        }

        void PreviewExecutedRoutedEventHandler(object sender, ExecutedRoutedEventArgs e)
        {
            if (e.Command.Equals(ApplicationCommands.Delete))
            {
                _wd?.View?.MoveFocus(new TraversalRequest(FocusNavigationDirection.First));
            }
            
            if (!Handle(e))
            {
                BuildWorkflowFields();
            }
        }

        bool Handle(ExecutedRoutedEventArgs e)
        {
            var Handled = false;
            if (e.Command.Equals(System.Activities.Presentation.View.DesignerView.PasteCommand))
            {
                _isPaste = true;
                var dataObject = Clipboard.GetDataObject();
                if (dataObject != null)
                {
                    var dataPresent = dataObject.GetDataPresent("WorkflowXamlFormat");
                    if (dataPresent)
                    {
                        Handled = Handle(e, dataObject);
                    }
                }
            }
            return Handled;
        }

        bool Handle(ExecutedRoutedEventArgs e, IDataObject dataObject)
        {
            var data = dataObject.GetData("WorkflowXamlFormat") as string;
            if (!string.IsNullOrEmpty(data))
            {
                var indexOf = data.IndexOf("ResourceID=", StringComparison.InvariantCultureIgnoreCase);
                var guid = data.Substring(indexOf + 12, 36);
                if (guid.Equals(ResourceModel.ID.ToString(), StringComparison.InvariantCultureIgnoreCase))
                {
                    e.Handled = true;
                }
            }
            return e.Handled;
        }

        protected override void OnDispose()
        {
            if (_wd != null)
            {
                _wd.ModelChanged -= WdOnModelChanged;
                _wd.Context.Services.Unsubscribe<ModelService>(ModelServiceSubscribe);

                _wd.View.PreviewDrop -= ViewPreviewDrop;

                _wd.View.PreviewMouseDown -= ViewPreviewMouseDown;

                _wd.Context.Services.Unsubscribe<DesignerView>(DesigenrViewSubscribe);
                _virtualizedContainerService = null;
                _virtualizedContainerServicePopulateAllMethod = null;
            }

            _designerManagementService?.Dispose();
            _debugSelectionChangedService?.Unsubscribe();

            if (_resourceModel != null)
            {
                _resourceModel.OnDataListChanged -= FireWdChanged;
                _resourceModel.OnResourceSaved -= UpdateOriginalDataList;
            }

            if (_modelService != null)
            {
                _modelService.ModelChanged -= ModelServiceModelChanged;
            }

            if (_uniqueWorkflowParts != null)
            {
                _uniqueWorkflowParts.Clear();
                _uniqueWorkflowParts = null;
            }
            
            if (ResourceModel != null)
            {
                var workSurfaceKey = WorkSurfaceKeyFactory.CreateKey(ResourceModel);
                OpeningWorkflowsHelper.PruneWorkflowFromCaches(workSurfaceKey);
            }
            if (_workflowInputDataViewModel != null)
            {
                _workflowInputDataViewModel.Dispose();
                _workflowInputDataViewModel = null;
            }
            try
            {
                CEventHelper.RemoveAllEventHandlers(_wd);
            }
            catch (Exception e)
            {
                Dev2Logger.Warn("Error disposing Workflow Designer View Model: " + e.Message, GlobalConstants.WarewolfWarn);
            }

            _debugSelectionChangedService?.Unsubscribe();
            base.OnDispose();
        }

        public override WorkSurfaceContext WorkSurfaceContext => ResourceModel?.ResourceType.ToWorkSurfaceContext() ?? WorkSurfaceContext.Unknown;

        public IServer Server => ResourceModel.Environment;

        protected List<ModelItem> SelectedDebugItems => _selectedDebugItems;

        public ModelItem SelectedItem
        {
            get => _selectedItem;
            set => _selectedItem = value;
        }

        public bool WorkspaceSave => _workspaceSave;

        public void Handle(EditActivityMessage message)
        {
            Dev2Logger.Info(message.GetType().Name, "Warewolf Info");
            EditActivity(message.ModelItem, message.ParentEnvironmentID);
        }

        void FireWdChanged()
        {
            WdOnModelChanged(new object(), new EventArgs());
            UpdateWorkflowLink();
        }

        public void Handle(SaveUnsavedWorkflowMessage message)
        {
            if (message?.ResourceModel == null || string.IsNullOrEmpty(message.ResourceName) || message.ResourceModel.ID != ResourceModel.ID)
            {
                return;
            }

            var resourceModel = message.ResourceModel;
            WorkspaceItemRepository.Instance.Remove(resourceModel);
            var unsavedName = resourceModel.ResourceName;
            UpdateResourceModel(message, resourceModel, unsavedName);
            PublishMessages(resourceModel);
            DisposeDesigner();

            if (message.KeepTabOpen)
            {
                ActivityDesignerHelper.AddDesignerAttributes(this);
                UpdateWorkflowInputDataViewModel(_resourceModel);

                DisplayWorkflowLink = GetAndUpdateWorkflowLinkWithWorkspaceID();
                NotifyOfPropertyChange(nameof(DisplayWorkflowLink));
                NotifyOfPropertyChange(nameof(DesignerView));
            }
            RemoveUnsavedWorkflowName(unsavedName);
        }

        public void UpdateWorkflowInputDataViewModel(IContextualResourceModel resourceModel)
        {
            _workflowInputDataViewModel = WorkflowInputDataViewModel.Create(_resourceModel);
            _workflowInputDataViewModel.LoadWorkflowInputs();
        }

        internal void RemoveUnsavedWorkflowName(string unsavedName) => NewWorkflowNames.Instance.Remove(unsavedName);
        internal void RemoveAllWorkflowName(string unsavedName) => NewWorkflowNames.Instance.RemoveAll(unsavedName);

        void DisposeDesigner()
        {
            if (_wd != null)
            {
                _wd.ModelChanged -= WdOnModelChanged;
                _wd.Context.Services.Unsubscribe<ModelService>(ModelServiceSubscribe);

                _wd.View.PreviewDrop -= ViewPreviewDrop;
                _wd.View.PreviewMouseDown -= ViewPreviewMouseDown;

                _wd.Context.Services.Unsubscribe<DesignerView>(DesigenrViewSubscribe);
                _virtualizedContainerService = null;
                _virtualizedContainerServicePopulateAllMethod = null;
            }

            _designerManagementService?.Dispose();
            if (_modelService != null)
            {
                _modelService.ModelChanged -= ModelServiceModelChanged;
            }
            _debugSelectionChangedService?.Unsubscribe();
        }

        void PublishMessages(IContextualResourceModel resourceModel)
        {
            UpdateResource(resourceModel);
            Dev2Logger.Info("Publish message of type - " + typeof(UpdateResourceMessage), "Warewolf Info");
            EventPublisher.Publish(new UpdateResourceMessage(resourceModel));
        }

        void UpdateResource(IContextualResourceModel resourceModel)
        {
            if (ContexttualResourceModelEqualityComparer.Current.Equals(resourceModel, _resourceModel))
            {
                IObservableReadOnlyList<IErrorInfo> currentErrors = null;
                if (resourceModel.Errors != null && resourceModel.Errors.Count > 0)
                {
                    currentErrors = resourceModel.Errors;
                }
                _resourceModel.Update(resourceModel);
                if (currentErrors != null && currentErrors.Count > 0)
                {
                    foreach (var currentError in currentErrors)
                    {
                        _resourceModel.AddError(currentError);
                    }
                }
            }
        }

        void UpdateResourceModel(SaveUnsavedWorkflowMessage message, IContextualResourceModel resourceModel, string unsavedName)
        {
            resourceModel.ResourceName = message.ResourceName;
            resourceModel.DisplayName = message.ResourceName;
            resourceModel.Category = message.ResourceCategory;
            resourceModel.WorkflowXaml = ServiceDefinition?.Replace(unsavedName, message.ResourceName);
            resourceModel.IsNewWorkflow = false;
            var saveResult = resourceModel.Environment.ResourceRepository.SaveToServer(resourceModel);
            var mainViewModel = CustomContainer.Get<IShellViewModel>();
            var environmentViewModel = mainViewModel?.ExplorerViewModel?.Environments.FirstOrDefault(model => model.Server.EnvironmentID == resourceModel.Environment.EnvironmentID);
            if (environmentViewModel != null)
            {
                var item = environmentViewModel.FindByPath(resourceModel.GetSavePath());
                var savedItem = environmentViewModel?.CreateExplorerItemFromResource(environmentViewModel.Server, item, false, false, resourceModel);
                item.AddChild(savedItem);
            }
            resourceModel.IsWorkflowSaved = true;
            DeleteOldResourceAfterSucessfulSave(message, saveResult);
        }

        public void DeleteOldResourceAfterSucessfulSave(SaveUnsavedWorkflowMessage message, ExecuteMessage saveResult)
        {
            if (!saveResult.HasError
                && saveResult.Message.Contains("Added")
                && !message.ResourceLoadingFromServer
                && !string.IsNullOrEmpty(message.OriginalPath))
            {
                try
                {
                    File.Delete(message.OriginalPath);
                }
                catch (Exception)
                {
                    Dev2Logger.Error("Resource from " + message.OriginalPath + " could not be Deleted", "Warewolf Error");
                }
            }
        }

        protected bool _isPaste;
        private IShellViewModel _shellViewModel;

        public System.Action WorkflowChanged { get; set; }
    }
}
---- Transformed Tree ----
using Caliburn.Micro;
using Dev2.Activities.Designers2.Core;
using Dev2.Common;
using Dev2.Common.Common;
using Dev2.Common.Interfaces.Core.Collections;
using Dev2.Common.Interfaces.Enums;
using Dev2.Common.Interfaces.Infrastructure;
using Dev2.Common.Interfaces.Infrastructure.Providers.Errors;
using Dev2.Common.Interfaces.Security;
using Dev2.Common.Interfaces.Studio.Controller;
using Dev2.Common.Interfaces.Threading;
using Dev2.CustomControls.Utils;
using Dev2.Data.Interfaces;
using Dev2.Data.SystemTemplates.Models;
using Dev2.Data.Util;
using Dev2.DataList.Contract;
using Dev2.Diagnostics;
using Dev2.Dialogs;
using Dev2.Factories;
using Dev2.Factory;
using Dev2.Instrumentation;
using Dev2.Messages;
using Dev2.Runtime.Configuration.ViewModels.Base;
using Dev2.Services.Events;
using Dev2.Studio.ActivityDesigners;
using Dev2.Studio.AppResources.AttachedProperties;
using Dev2.Studio.AppResources.ExtensionMethods;
using Dev2.Studio.Controller;
using Dev2.Studio.Core;
using Dev2.Studio.Core.Activities.Services;
using Dev2.Studio.Core.Activities.Utils;
using Dev2.Studio.Core.AppResources.DependencyInjection.EqualityComparers;
using Dev2.Studio.Core.AppResources.ExtensionMethods;
using Dev2.Studio.Core.Factories;
using Dev2.Studio.Core.Messages;
using Dev2.Studio.Core.Network;
using Dev2.Studio.Core.Utils;
using Dev2.Studio.Enums;
using Dev2.Studio.Factory;
using Dev2.Studio.Interfaces;
using Dev2.Studio.Interfaces.DataList;
using Dev2.Studio.Interfaces.Enums;
using Dev2.Studio.ViewModels.Diagnostics;
using Dev2.Studio.ViewModels.WorkSurface;
using Dev2.Threading;
using Dev2.Utilities;
using Dev2.Utils;
using Dev2.ViewModels.Workflow;
using Dev2.Workspaces;
using Newtonsoft.Json;
using System;
using System.Activities;
using System.Activities.Core.Presentation;
using System.Activities.Presentation;
using System.Activities.Presentation.Metadata;
using System.Activities.Presentation.Model;
using System.Activities.Presentation.Services;
using System.Activities.Presentation.View;
using System.Activities.Statements;
using System.Collections.Generic;
using System.ComponentModel;
using System.Linq;
using System.Reflection;
using System.Runtime.Versioning;
using System.Text;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Threading;
using System.Xaml;
using System.Xml.Linq;
using Unlimited.Applications.BusinessDesignStudio.Activities;
using Warewolf.Studio.ViewModels;
using Dev2.ViewModels.Merge;
using Dev2.Communication;
using System.IO;
using Dev2.Common.Interfaces;
using Dev2.Activities.Designers2.Gate;
using Dev2.Activities;
using Warewolf.Data;
using Warewolf.Data.Options;
using StringExtension = Dev2.Common.ExtMethods.StringExtension;

namespace Dev2.Studio.ViewModels.Workflow
{
    public class FromToolBox
    {
    }

    public class WorkflowDesignerViewModel : BaseWorkSurfaceViewModel,
                                             IHandle<AddStringListToDataListMessage>,
                                             IHandle<EditActivityMessage>,
                                             IHandle<SaveUnsavedWorkflowMessage>,
                                             IWorkflowDesignerViewModel
    {
        static readonly Type[] DecisionSwitchTypes = { typeof(FlowSwitch<string>), typeof(FlowDecision) };

        protected readonly IDesignerManagementService _designerManagementService;
        readonly IWorkflowHelper _workflowHelper;
        DelegateCommand _collapseAllCommand;

        protected dynamic DataObject { get; set; }
        List<ModelItem> _selectedDebugItems = new List<ModelItem>();
        DelegateCommand _expandAllCommand;

        protected ModelService _modelService;
        IContextualResourceModel _resourceModel;

        protected Dictionary<IDataListVerifyPart, string> _uniqueWorkflowParts;

        protected WorkflowDesigner _wd;
        DesignerMetadata _wdMeta;

        VirtualizedContainerService _virtualizedContainerService;
        MethodInfo _virtualizedContainerServicePopulateAllMethod;

        readonly StudioSubscriptionService<DebugSelectionChangedEventArgs> _debugSelectionChangedService = new StudioSubscriptionService<DebugSelectionChangedEventArgs>();

        readonly IApplicationTracker _applicationTracker;
        public bool IsStartNodeErrorMessageSet { get; set; }

        protected IWorkflowDesignerWrapper _workflowDesignerHelper;

        public WorkflowDesignerViewModel(IContextualResourceModel resource)
            : this(resource, true)
        {
        }

        public WorkflowDesignerViewModel(IContextualResourceModel resource, bool createDesigner)
            : this(resource, new WorkflowHelper(), createDesigner)
        {
        }

        public WorkflowDesignerViewModel(IContextualResourceModel resource, IWorkflowHelper workflowHelper, bool createDesigner)
            : this(EventPublishers.Aggregator, resource, workflowHelper, createDesigner)
        {
        }

        WorkflowDesignerViewModel(IEventAggregator eventPublisher, IContextualResourceModel resource, IWorkflowHelper workflowHelper, bool createDesigner)
            : this(eventPublisher, resource, workflowHelper,
                CustomContainer.Get<IPopupController>(), new AsyncWorker(), createDesigner)
        {
        }

        public WorkflowDesignerViewModel(IWorkflowDesignerWrapper workflowDesignerHelper, IEventAggregator eventPublisher, IContextualResourceModel resource, IWorkflowHelper workflowHelper, IPopupController popupController, IAsyncWorker asyncWorker, bool createDesigner, bool liteInit)
            : this(eventPublisher, resource, workflowHelper, popupController, asyncWorker, createDesigner, liteInit)
        {
            _workflowDesignerHelper = workflowDesignerHelper;
        }

        public WorkflowDesignerViewModel(IEventAggregator eventPublisher, IContextualResourceModel resource, IWorkflowHelper workflowHelper, IPopupController popupController, IAsyncWorker asyncWorker, bool createDesigner)
            : this(eventPublisher, resource, workflowHelper, popupController, asyncWorker, createDesigner, false)
        {
        }

        public WorkflowDesignerViewModel(IEventAggregator eventPublisher, IContextualResourceModel resource, IWorkflowHelper workflowHelper, IPopupController popupController, IAsyncWorker asyncWorker, bool createDesigner, bool liteInit)
            : base(eventPublisher)
        {
            VerifyArgument.IsNotNull("workflowHelper", workflowHelper);
            VerifyArgument.IsNotNull("popupController", popupController);
            VerifyArgument.IsNotNull("asyncWorker", asyncWorker);
            _workflowHelper = workflowHelper;
            _resourceModel = resource;
            _resourceModel.OnDataListChanged += FireWdChanged;
            _resourceModel.OnResourceSaved += UpdateOriginalDataList;
            _asyncWorker = asyncWorker;
            CanViewWorkflowLink = true;

            PopUp = popupController;

            if (_resourceModel.DataList != null)
            {
                SetOriginalDataList(_resourceModel);
            }
            _designerManagementService = new DesignerManagementService(resource, _resourceModel.Environment.ResourceRepository);
            if (createDesigner)
            {
                ActivityDesignerHelper.AddDesignerAttributes(this, liteInit);
            }
            UpdateWorkflowInputDataViewModel(_resourceModel);
            UpdateWorkflowLink();
            DataListViewModel = DataListViewModelFactory.CreateDataListViewModel(_resourceModel);
            DebugOutputViewModel = new DebugOutputViewModel(_resourceModel.Environment.Connection.ServerEvents, CustomContainer.Get<IServerRepository>(), new DebugOutputFilterStrategy(), ResourceModel);
            _firstWorkflowChange = true;
            _workflowDesignerHelper = new WorkflowDesignerWrapper();
            _applicationTracker = CustomContainer.Get<IApplicationTracker>();
            _shellViewModel = GetShellViewModel();
        }

        private static IShellViewModel GetShellViewModel()
        {
            IShellViewModel shellViewModel;
            try
            {
                if (Application.Current?.MainWindow?.DataContext is IShellViewModel tmpShellViewModel)
                {
                    return tmpShellViewModel;
                }
            }
            catch
            {
            }
            return CustomContainer.Get<IShellViewModel>();
        }

        public void SetPermission(Permissions permission)
        {
            SetNonePermissions();

            if (permission.HasFlag(Permissions.View))
            {
                SetViewPermissions();
            }
            if (permission.HasFlag(Permissions.Execute))
            {
                SetExecutePermissions();
            }
            if (permission.HasFlag(Permissions.Contribute))
            {
                SetContributePermissions();
            }
            if (permission.HasFlag(Permissions.Administrator))
            {
                SetAdministratorPermissions();
            }
        }

        void SetExecutePermissions()
        {
            CanDebugInputs = true;
            CanDebugStudio = true;
            CanDebugBrowser = true;
            CanRunAllTests = !ResourceModel.IsNewWorkflow;
            CanViewOpenAPI = !ResourceModel.IsNewWorkflow;
            CanCopyUrl = !ResourceModel.IsNewWorkflow;
        }

        void SetViewPermissions()
        {
            CanViewOpenAPI = !ResourceModel.IsVersionResource;
            CanCopyUrl = !ResourceModel.IsVersionResource;
        }

        void SetNonePermissions()
        {
            CanDebugInputs = false;
            CanDebugStudio = false;
            CanDebugBrowser = false;
            CanCreateSchedule = false;
            CanCreateQueueEvent = false;
            CanCreateTest = false;
            CanRunAllTests = false;
            CanDuplicate = false;
            CanDeploy = false;
            CanMerge = false;
            CanShowDependencies = false;
            CanViewOpenAPI = false;
            CanCopyUrl = false;
        }

        void SetAdministratorPermissions()
        {
            CanDebugInputs = true;
            CanDebugStudio = true;
            CanDebugBrowser = true;
            CanCreateSchedule = !ResourceModel.IsNewWorkflow;
            CanCreateQueueEvent = !ResourceModel.IsNewWorkflow;
            CanCreateTest = !ResourceModel.IsNewWorkflow;
            CanRunAllTests = !ResourceModel.IsNewWorkflow;
            CanDuplicate = !ResourceModel.IsNewWorkflow;
            CanDeploy = !ResourceModel.IsNewWorkflow;
            CanMerge = !ResourceModel.IsNewWorkflow;
            CanShowDependencies = !ResourceModel.IsNewWorkflow;
            CanViewOpenAPI = !ResourceModel.IsNewWorkflow;
            CanCopyUrl = !ResourceModel.IsNewWorkflow;
        }

        void SetContributePermissions()
        {
            CanDebugInputs = true;
            CanDebugStudio = true;
            CanDebugBrowser = true;
            CanCreateSchedule = !ResourceModel.IsNewWorkflow;
            CanCreateQueueEvent = !ResourceModel.IsNewWorkflow;
            CanCreateTest = !ResourceModel.IsNewWorkflow;
            CanRunAllTests = !ResourceModel.IsNewWorkflow;
            CanDuplicate = !ResourceModel.IsNewWorkflow;
            CanDeploy = !ResourceModel.IsNewWorkflow;
            CanMerge = !ResourceModel.IsNewWorkflow;
            CanShowDependencies = !ResourceModel.IsNewWorkflow;
            CanViewOpenAPI = !ResourceModel.IsNewWorkflow;
            CanCopyUrl = !ResourceModel.IsNewWorkflow;
        }

        public bool CanCopyUrl
        {
            get => _canCopyUrl;
            set
            {
                _canCopyUrl = value;
                CopyUrlTooltip = ResourceModel.IsNewWorkflow ? Warewolf.Studio.Resources.Languages.Tooltips.DisabledToolTip : _canCopyUrl ? Warewolf.Studio.Resources.Languages.Tooltips.CopyUrlToolTip : Warewolf.Studio.Resources.Languages.Tooltips.NoPermissionsToolTip;
                OnPropertyChanged("CanCopyUrl");
            }
        }

        public string CopyUrlTooltip
        {
            get => _copyUrlTooltip;
            set
            {
                _copyUrlTooltip = value;
                OnPropertyChanged("CopyUrlTooltip");
            }
        }

        public bool CanViewOpenAPI
        {
            get => _canViewOpenAPI;
            set
            {
                _canViewOpenAPI = value;
                ViewOpenAPITooltip = ResourceModel.IsNewWorkflow ? Warewolf.Studio.Resources.Languages.Tooltips.DisabledToolTip : _canViewOpenAPI ? Warewolf.Studio.Resources.Languages.Tooltips.ViewOpenAPIToolTip : Warewolf.Studio.Resources.Languages.Tooltips.NoPermissionsToolTip;
                OnPropertyChanged("CanViewOpenAPI");
            }
        }

        public string ViewOpenAPITooltip
        {
            get => _viewOpenAPITooltip;
            set
            {
                _viewOpenAPITooltip = value;
                OnPropertyChanged("ViewOpenAPITooltip");
            }
        }

        public bool CanShowDependencies
        {
            get => _canShowDependencies;
            set
            {
                _canShowDependencies = value;
                ShowDependenciesTooltip = ResourceModel.IsNewWorkflow ? Warewolf.Studio.Resources.Languages.Tooltips.DisabledToolTip : _canShowDependencies ? Warewolf.Studio.Resources.Languages.Tooltips.DependenciesToolTip : Warewolf.Studio.Resources.Languages.Tooltips.NoPermissionsToolTip;
                OnPropertyChanged("CanShowDependencies");
            }
        }

        public string ShowDependenciesTooltip
        {
            get => _showDependenciesTooltip;
            set
            {
                _showDependenciesTooltip = value;
                OnPropertyChanged("ShowDependenciesTooltip");
            }
        }

        public bool CanDeploy
        {
            get => _canDeploy;
            set
            {
                _canDeploy = value;
                DeployTooltip = ResourceModel.IsNewWorkflow ? Warewolf.Studio.Resources.Languages.Tooltips.DisabledToolTip : _canDeploy ? Warewolf.Studio.Resources.Languages.Tooltips.DeployToolTip : Warewolf.Studio.Resources.Languages.Tooltips.NoPermissionsToolTip;
                OnPropertyChanged("CanDeploy");
            }
        }

        public bool CanMerge
        {
            get
            {
                if (ResourceModel.IsVersionResource || (GetVersionHistory() != null && _canMerge))
                {
                    return true;
                }

                return false;
            }
            set
            {
                _canMerge = value;
                MergeTooltip = Warewolf.Studio.Resources.Languages.Tooltips.ViewMergeTooltip;
                OnPropertyChanged("CanMerge");
            }
        }

        ICollection<IVersionInfo> GetVersionHistory()
        {
            var versionInfos = Server?.ExplorerRepository?.GetVersions(ResourceModel.ID);
            if (versionInfos?.Count <= 0)
            {
                return null;
            }

            return versionInfos;
        }

        public string DeployTooltip
        {
            get => _deployTooltip;
            set
            {
                _deployTooltip = value;
                OnPropertyChanged("DeployTooltip");
            }
        }

        public string MergeTooltip
        {
            get => _mergeTooltip;
            set
            {
                _mergeTooltip = value;
                OnPropertyChanged("MergeTooltip");
            }
        }

        public bool CanDuplicate
        {
            get => _canDuplicate;
            set
            {
                _canDuplicate = value;
                DuplicateTooltip = ResourceModel.IsNewWorkflow ? Warewolf.Studio.Resources.Languages.Tooltips.DisabledToolTip : _canDuplicate ? Warewolf.Studio.Resources.Languages.Tooltips.DuplicateToolTip : Warewolf.Studio.Resources.Languages.Tooltips.NoPermissionsToolTip;
                OnPropertyChanged("CanDuplicate");
            }
        }

        public string DuplicateTooltip
        {
            get => _duplicateTooltip;
            set
            {
                _duplicateTooltip = value;
                OnPropertyChanged("DuplicateTooltip");
            }
        }

        public bool CanRunAllTests
        {
            get => _canRunAllTests;
            set
            {
                _canRunAllTests = value;
                RunAllTestsTooltip = ResourceModel.IsNewWorkflow ? Warewolf.Studio.Resources.Languages.Tooltips.DisabledToolTip : _canRunAllTests ? Warewolf.Studio.Resources.Languages.Tooltips.RunAllTestsToolTip : Warewolf.Studio.Resources.Languages.Tooltips.NoPermissionsToolTip;
                RunCoverageTooltip = ResourceModel.IsNewWorkflow ? Warewolf.Studio.Resources.Languages.Tooltips.DisabledToolTip : _canRunAllTests ? Warewolf.Studio.Resources.Languages.Tooltips.RunCoverageToolTip : Warewolf.Studio.Resources.Languages.Tooltips.NoPermissionsToolTip;
                OnPropertyChanged("CanRunAllTests");
            }
        }

        public string RunAllTestsTooltip
        {
            get => _runAllTestsTooltip;
            set
            {
                _runAllTestsTooltip = value;
                OnPropertyChanged("RunAllTestsTooltip");
            }
        }
        
        public string RunCoverageTooltip
        {
            get => _runCoverageTooltip;
            set
            {
                _runCoverageTooltip = value;
                OnPropertyChanged(nameof(RunCoverageTooltip));
            }
        }

        public bool CanCreateTest
        {
            get => _canCreateTest;
            set
            {
                _canCreateTest = value;
                CreateTestTooltip = ResourceModel.IsNewWorkflow ? Warewolf.Studio.Resources.Languages.Tooltips.DisabledToolTip : _canCreateTest ? Warewolf.Studio.Resources.Languages.Tooltips.TestEditorToolTip : Warewolf.Studio.Resources.Languages.Tooltips.NoPermissionsToolTip;
                OnPropertyChanged("CanCreateTest");
            }
        }

        public string CreateTestTooltip
        {
            get => _createTestTooltip;
            set
            {
                _createTestTooltip = value;
                OnPropertyChanged("CreateTestTooltip");
            }
        }

        public bool CanCreateSchedule
        {
            get => _canCreateSchedule;
            set
            {
                _canCreateSchedule = value;
                ScheduleTooltip = ResourceModel.IsNewWorkflow ? Warewolf.Studio.Resources.Languages.Tooltips.DisabledToolTip : _canCreateSchedule ? Warewolf.Studio.Resources.Languages.Tooltips.ScheduleToolTip : Warewolf.Studio.Resources.Languages.Tooltips.NoPermissionsToolTip;
                OnPropertyChanged("CanCreateSchedule");
            }
        }

        public string ScheduleTooltip
        {
            get => _scheduleTooltip;
            set
            {
                _scheduleTooltip = value;
                OnPropertyChanged("ScheduleTooltip");
            }
        }

        public bool CanCreateQueueEvent
        {
            get => _canCreateQueueEvent;
            set
            {
                _canCreateQueueEvent = value;
                QueueEventTooltip = ResourceModel.IsNewWorkflow ? Warewolf.Studio.Resources.Languages.Tooltips.DisabledToolTip : _canCreateSchedule ? Warewolf.Studio.Resources.Languages.Tooltips.QueueEventToolTip : Warewolf.Studio.Resources.Languages.Tooltips.NoPermissionsToolTip;
                OnPropertyChanged("CanCreateQueueEvent");
            }
        }

        public string QueueEventTooltip
        {
            get => _queueEventTooltip;
            set
            {
                _queueEventTooltip = value;
                OnPropertyChanged("QueueEventTooltip");
            }
        }

        public bool CanDebugBrowser
        {
            get => _debugBrowser;
            set
            {
                _debugBrowser = value;
                DebugBrowserTooltip = ResourceModel.IsNewWorkflow ? Warewolf.Studio.Resources.Languages.Tooltips.DisabledToolTip : _debugBrowser ? Warewolf.Studio.Resources.Languages.Tooltips.StartNodeDebugBrowserToolTip : Warewolf.Studio.Resources.Languages.Tooltips.NoPermissionsToolTip;
                OnPropertyChanged("CanDebugBrowser");
            }
        }

        public string DebugBrowserTooltip
        {
            get => _debugBrowserTooltip;
            set
            {
                _debugBrowserTooltip = value;
                OnPropertyChanged("DebugBrowserTooltip");
            }
        }

        public bool CanDebugStudio
        {
            get => _canDebugStudio;
            set
            {
                _canDebugStudio = value;
                DebugStudioTooltip = ResourceModel.IsNewWorkflow ? Warewolf.Studio.Resources.Languages.Tooltips.DisabledToolTip : _canDebugStudio ? Warewolf.Studio.Resources.Languages.Tooltips.StartNodeDebugStudioToolTip : Warewolf.Studio.Resources.Languages.Tooltips.NoPermissionsToolTip;
                OnPropertyChanged("CanDebugStudio");
            }
        }

        public string DebugStudioTooltip
        {
            get => _debugStudioTooltip;
            set
            {
                _debugStudioTooltip = value;
                OnPropertyChanged("DebugStudioTooltip");
            }
        }

        public bool CanDebugInputs
        {
            get => _canDebugInputs;
            set
            {
                _canDebugInputs = value;
                DebugInputsTooltip = ResourceModel.IsNewWorkflow ? Warewolf.Studio.Resources.Languages.Tooltips.DisabledToolTip : _canDebugInputs ? Warewolf.Studio.Resources.Languages.Tooltips.StartNodeDebugInputsToolTip : Warewolf.Studio.Resources.Languages.Tooltips.NoPermissionsToolTip;
                OnPropertyChanged("CanDebugInputs");
            }
        }

        public string DebugInputsTooltip
        {
            get => _debugInputsTooltip;
            set
            {
                _debugInputsTooltip = value;
                OnPropertyChanged("DebugInputsTooltip");
            }
        }

        void SetOriginalDataList(IContextualResourceModel contextualResourceModel)
        {
            if (!string.IsNullOrEmpty(contextualResourceModel.DataList))
            {
                _originalDataList = contextualResourceModel.DataList.Replace("<DataList>", "").Replace("</DataList>", "").Replace(Environment.NewLine, "").Trim();
            }
        }

        void UpdateOriginalDataList(IContextualResourceModel obj)
        {
            if (obj.IsWorkflowSaved)
            {
                SetOriginalDataList(obj);
            }
        }

        public DebugOutputViewModel DebugOutputViewModel
        {
            get => _debugOutputViewModel;
            set => _debugOutputViewModel = value;
        }

        public IDataListViewModel DataListViewModel
        {
            get => _dataListViewModel;
            set
            {
                _dataListViewModel = value;
                NotifyOfPropertyChange(() => DataListViewModel);
            }
        }

        public override bool HasVariables => true;
        public override bool HasDebugOutput => true;

        public override bool CanSave => ResourceModel.IsAuthorized(AuthorizationContext.Contribute);

        protected virtual bool IsDesignerViewVisible => DesignerView != null && DesignerView.IsVisible;

#pragma warning disable 108,114

        public string DisplayName
#pragma warning restore 108,114
        {
            get
            {
                var displayName = ResourceModel.UserPermissions == Permissions.View ?
                    $"{ResourceHelper.GetDisplayName(ResourceModel)} [READONLY]"
                    : ResourceHelper.GetDisplayName(ResourceModel);
                return displayName;
            }
        }
        
        public string GetAndUpdateWorkflowLinkWithWorkspaceID()
        {
            UpdateWorkflowLink();
            return _workflowLinkWithWid;
        }

        public void UpdateWorkflowLink()
        {
            if (_workflowInputDataViewModel != null)
            {
                if (!string.IsNullOrEmpty(_resourceModel.DataList))
                {
                    _workflowInputDataViewModel.DebugTo.DataList = _resourceModel.DataList;
                }
                _workflowLink = "";
                _workflowInputDataViewModel.LoadWorkflowInputs();
                _workflowInputDataViewModel.SetXmlData(true);
                var buildWebPayLoad = _workflowInputDataViewModel.BuildInputDataList();

                var uri = _resourceModel.GetWorkflowUri(buildWebPayLoad, UrlType.Json, true);
                if (uri != null) {
                    _workflowLinkWithWid = uri.ToString();
                    var startIndex = _workflowLinkWithWid.IndexOf("&wid", StringComparison.InvariantCultureIgnoreCase);
                    if (startIndex != -1)
                    {
                        _workflowLink = _workflowLinkWithWid.Remove(startIndex);
                    }
                }
            }
            NotifyOfPropertyChange(() => DisplayWorkflowLink);
        }

        public string GetWorkflowInputs(string field)
        {
            var workflowInputDataViewModel = _workflowInputDataViewModel as WorkflowInputDataViewModel;
            var inputsValue = workflowInputDataViewModel?.WorkflowInputs?.FirstOrDefault(o => o.Field == field);
            return inputsValue?.Value;
        }

        public string DisplayWorkflowLink
        {
            get
            {
                return _workflowLink;
            }
            private set
            {
                _workflowLink = value;
            }
        }

        public Visibility WorkflowLinkVisible => _resourceModel.IsVersionResource ? Visibility.Hidden : Visibility.Visible;
        public bool CanViewWorkflowLink { get; set; }

        public IPopupController PopUp { get; set; }
        
        public virtual object SelectedModelItem => _wd?.Context?.Items.GetValue<Selection>().SelectedObjects.FirstOrDefault();

        public IContextualResourceModel ResourceModel
        {
            get => _resourceModel;
            set => _resourceModel = value;
        }

        public string WorkflowName => _resourceModel.ResourceName;

        public WorkflowDesigner Designer => _wd;

        public UIElement DesignerView => _wd?.View;

        public StringBuilder DesignerText => ServiceDefinition;

        public StringBuilder ServiceDefinition => _workflowHelper.SerializeWorkflow(_modelService);

        public ICommand CollapseAllCommand => _collapseAllCommand ?? (_collapseAllCommand = new DelegateCommand(param =>
        {
            var val = Convert.ToBoolean(param);
            if (val)
            {
                _designerManagementService.RequestCollapseAll();
            }
            else
            {
                _designerManagementService.RequestRestoreAll();
            }
        }));

        public ICommand ExpandAllCommand => _expandAllCommand ?? (_expandAllCommand = new DelegateCommand(param =>
        {
            var val = Convert.ToBoolean(param);
            if (val)
            {
                _designerManagementService.RequestExpandAll();
            }
            else
            {
                _designerManagementService.RequestRestoreAll();
            }
        }));

        public ICommand OpenWorkflowLinkCommand
        {
            get
            {
                return _openWorkflowLinkCommand ?? (_openWorkflowLinkCommand = new DelegateCommand(param =>
                {
                    if (!string.IsNullOrEmpty(_workflowLink))
                    {
                        if (_applicationTracker != null)
                        {
                            _applicationTracker.TrackEvent(Warewolf.Studio.Resources.Languages.TrackEventMenu.EventCategory,
                                                                Warewolf.Studio.Resources.Languages.TrackEventMenu.LinkUrl);
                        }
                        SaveToWorkspace();
                        if (_workflowInputDataViewModel.WorkflowInputCount == 0)
                        {
                            PopUp.ShowNoInputsSelectedWhenClickLink();
                        }
                        try
                        {
                            OpenLinkInBrowser();
                        }
                        catch (Exception e)
                        {
                            Dev2Logger.Error("OpenWorkflowLinkCommand", e, GlobalConstants.WarewolfError);
                        }
                    }
                }));
            }
        }

        public ICommand NewServiceCommand => _newServiceCommand ?? (_newServiceCommand = new DelegateCommand(param =>
        {
            if (Application.Current != null && Application.Current.Dispatcher != null && Application.Current.Dispatcher.CheckAccess() && Application.Current.MainWindow != null)
            {
                var mvm = Application.Current.MainWindow.DataContext as ShellViewModel;
                if (mvm?.ActiveItem != null)
                {
                    mvm.NewService("");
                }
            }
        }));

        public ICommand DebugInputsCommand => _debugInputsCommand ?? (_debugInputsCommand = new DelegateCommand(param =>
        {
            if (Application.Current != null && Application.Current.Dispatcher != null && Application.Current.Dispatcher.CheckAccess() && Application.Current.MainWindow != null)
            {
                var mvm = Application.Current.MainWindow.DataContext as ShellViewModel;
                if (mvm?.ActiveItem != null)
                {
                    mvm.DebugCommand.Execute(mvm.ActiveItem);
                }
            }
        }));

        public ICommand DebugStudioCommand => _debugStudioCommand ?? (_debugStudioCommand = new DelegateCommand(param =>
        {
            if (Application.Current != null && Application.Current.Dispatcher != null && Application.Current.Dispatcher.CheckAccess() && Application.Current.MainWindow != null)
            {
                var mvm = Application.Current.MainWindow.DataContext as ShellViewModel;
                if (mvm?.ActiveItem != null)
                {
                    mvm.QuickDebugCommand.Execute(mvm.ActiveItem);
                }
            }
        }));

        public ICommand DebugBrowserCommand => _debugBrowserCommand ?? (_debugBrowserCommand = new DelegateCommand(param =>
        {
            OpenLinkInBrowser();
        }));

        static void OpenLinkInBrowser()
        {
            if (Application.Current != null && Application.Current.Dispatcher != null && Application.Current.Dispatcher.CheckAccess() && Application.Current.MainWindow != null)
            {
                var mvm = Application.Current.MainWindow.DataContext as ShellViewModel;
                if (mvm?.ActiveItem != null)
                {
                    mvm.QuickViewInBrowserCommand.Execute(mvm.ActiveItem);
                }
            }
        }

        public ICommand ScheduleCommand => _scheduleCommand ?? (_scheduleCommand = new DelegateCommand(param =>
        {
            if (Application.Current != null && Application.Current.Dispatcher != null && Application.Current.Dispatcher.CheckAccess() && Application.Current.MainWindow != null)
            {
                var mvm = Application.Current.MainWindow.DataContext as ShellViewModel;
                if (mvm?.ActiveItem != null)
                {
                    mvm.CreateNewSchedule(mvm.ActiveItem.ContextualResourceModel.ID);
                }
            }
        }));

        public ICommand QueueEventCommand => _queueEventCommand ?? (_queueEventCommand = new DelegateCommand(param =>
        {
            if (Application.Current != null && Application.Current.Dispatcher != null && Application.Current.Dispatcher.CheckAccess() && Application.Current.MainWindow != null)
            {
                var mvm = Application.Current.MainWindow.DataContext as ShellViewModel;
                if (mvm?.ActiveItem != null)
                {
                    mvm.CreateNewQueueEvent(mvm.ActiveItem.ContextualResourceModel.ID);
                }
            }
        }));

        public ICommand TestEditorCommand => _testEditorCommand ?? (_testEditorCommand = new DelegateCommand(param =>
        {
            if (Application.Current != null && Application.Current.Dispatcher != null && Application.Current.Dispatcher.CheckAccess() && Application.Current.MainWindow != null)
            {
                var mvm = Application.Current.MainWindow.DataContext as ShellViewModel;
                if (mvm?.ActiveItem != null)
                {
                    mvm.CreateTest(mvm.ActiveItem.ContextualResourceModel.ID);
                }
            }
        }));

        public ICommand DuplicateCommand => _duplicateCommand ?? (_duplicateCommand = new DelegateCommand(param =>
        {
            if (Application.Current != null && Application.Current.Dispatcher != null && Application.Current.Dispatcher.CheckAccess() && Application.Current.MainWindow != null)
            {
                var mvm = Application.Current.MainWindow.DataContext as ShellViewModel;
                if (mvm?.ActiveItem != null)
                {
                    IExplorerItemViewModel explorerItem = null;
                    var environmentViewModels = mvm.ExplorerViewModel.Environments.Where(a => a.ResourceId == mvm.ActiveServer.EnvironmentID);
                    foreach (var environmentViewModel in environmentViewModels)
                    {
                        explorerItem = environmentViewModel.Children.Flatten(model => model.Children).FirstOrDefault(c => c.ResourceId == mvm.ActiveItem.ContextualResourceModel.ID);
                    }

                    if (explorerItem != null)
                    {
                        mvm.DuplicateResource(explorerItem);
                    }
                }
            }
        }));

        public ICommand DeployCommand => _deployCommand ?? (_deployCommand = new DelegateCommand(param =>
        {
            if (Application.Current != null && Application.Current.Dispatcher != null && Application.Current.Dispatcher.CheckAccess() && Application.Current.MainWindow != null)
            {
                var mvm = Application.Current.MainWindow.DataContext as ShellViewModel;
                if (mvm?.ActiveItem != null)
                {
                    var explorerItem = GetSelected(mvm);
                    if (explorerItem != null)
                    {
                        mvm.AddDeploySurface(explorerItem.AsList().Union(new[] { explorerItem }));
                    }
                }
            }
        }));

        public ICommand MergeCommand => _mergeCommand ?? (_mergeCommand = new DelegateCommand(param =>
        {
            if (Application.Current?.Dispatcher == null || !Application.Current.Dispatcher.CheckAccess() || Application.Current?.MainWindow == null)
            {
                return;
            }
            MergeWorkflow();
        }));

        public IShellViewModel ShellViewModel => _shellViewModel ?? CustomContainer.Get<IShellViewModel>();
        
        private static void MergeWorkflow()
        {
            var shellViewModel = Application.Current.MainWindow.DataContext as ShellViewModel;
            if (shellViewModel?.ActiveItem == null)
            {
                return;
            }

            var explorerItem = shellViewModel.ActiveItem.ContextualResourceModel.IsVersionResource
                             ? GetMergeResourceVersion(shellViewModel)
                             : GetMergeCurrentResource(shellViewModel);

            if (explorerItem == null)
            {
                return;
            }
            shellViewModel.OpenMergeDialogView(explorerItem);
        }

        private static IExplorerItemViewModel GetMergeResourceVersion(ShellViewModel shellViewModel)
        {
            var resourceId = shellViewModel.ActiveItem.ContextualResourceModel.OriginalId;
            var environmentViewModel = shellViewModel.ExplorerViewModel.Environments.FirstOrDefault(a => a.ResourceId == shellViewModel.ActiveServer.EnvironmentID);
            return environmentViewModel?.UnfilteredChildren?.Flatten(model => model.UnfilteredChildren).FirstOrDefault(c => c.ResourceId == resourceId);
        }

        private static IExplorerItemViewModel GetMergeCurrentResource(ShellViewModel shellViewModel)
        {
            var resourceId = shellViewModel.ActiveItem.ContextualResourceModel.ID;
            var environmentViewModel = shellViewModel.ExplorerViewModel.Environments.FirstOrDefault(a => a.ResourceId == shellViewModel.ActiveServer.EnvironmentID);
            return environmentViewModel?.UnfilteredChildren?.Flatten(model => model.UnfilteredChildren).Where(a => !a.IsVersion).FirstOrDefault(c => c.ResourceId == resourceId);
        }

        static IExplorerItemViewModel GetSelected(ShellViewModel mvm)
        {
            IExplorerItemViewModel explorerItem = null;
            if (mvm?.ActiveServer != null)
            {
                var environmentViewModels = mvm.ExplorerViewModel.Environments.Where(a => a.ResourceId == mvm.ActiveServer.EnvironmentID);
                foreach (var environmentViewModel in environmentViewModels)
                {
                    explorerItem =
                        environmentViewModel.UnfilteredChildren.Flatten(model => model.UnfilteredChildren)
                            .FirstOrDefault(c => c.ResourceId == mvm.ActiveItem.ContextualResourceModel.ID);
                }
            }
            return explorerItem;
        }

        public ICommand ShowDependenciesCommand => _showDependenciesCommand ?? (_showDependenciesCommand = new DelegateCommand(param =>
        {
            if (Application.Current != null && Application.Current.Dispatcher != null && Application.Current.Dispatcher.CheckAccess() && Application.Current.MainWindow != null)
            {
                var mvm = Application.Current.MainWindow.DataContext as ShellViewModel;
                var explorerItem = GetSelected(mvm);
                if (explorerItem != null)
                {
                    mvm.ShowDependencies(mvm.ActiveItem.ContextualResourceModel.ID, mvm.ActiveServer, explorerItem.IsSource || explorerItem.IsServer);
                }
            }
        }));

        public ICommand ViewOpenAPICommand => _viewOpenAPICommand ?? (_viewOpenAPICommand = new DelegateCommand(param =>
        {
            if (Application.Current != null && Application.Current.Dispatcher != null && Application.Current.Dispatcher.CheckAccess() && Application.Current.MainWindow != null)
            {
                var mvm = Application.Current.MainWindow.DataContext as ShellViewModel;
                if (mvm?.ActiveItem != null)
                {
                    mvm.ViewOpenAPI(mvm.ActiveItem.ContextualResourceModel.ResourceName, mvm.ActiveItem.ContextualResourceModel.ResourceName, mvm.ActiveServer.Connection.WebServerUri);
                }
            }
        }));

        public ICommand CopyUrlCommand => _copyUrlCommand ?? (_copyUrlCommand = new DelegateCommand(param =>
        {
            Clipboard.SetText(_workflowLink);
        }));
        
        protected ModelItem PerformAddItems(ModelItem addedItem)


        {
            var mi = addedItem;
            var computedValue = mi.Content?.ComputedValue;

            //Track added items when dragged on design surface
            if (computedValue != null && computedValue.GetType() != typeof(DsfActivity))
            {
                _applicationTracker?.TrackCustomEvent(Warewolf.Studio.Resources.Languages.TrackEventWorkflowTabs.EventCategory, Warewolf.Studio.Resources.Languages.TrackEventWorkflowTabs.ItemDragged, computedValue.ToString());
            }
            if (computedValue == null && (mi.ItemType == typeof(DsfFlowDecisionActivity) ||
                                          mi.ItemType == typeof(DsfFlowSwitchActivity)))
            {
                computedValue = mi.Source?.Value?.Source?.ComputedValue;
            }
            if (computedValue is IDev2Activity act)
            {
                if (_isPaste || string.IsNullOrEmpty(act.UniqueID))
                {
                    act.UniqueID = Guid.NewGuid().ToString();
                }
                _modelItems = _modelService.Find(_modelService.Root, typeof(IDev2Activity));
            }
            if (computedValue is Activity)
            {
                _activityCollection = _modelService.Find(_modelService.Root, typeof(Activity));
            }

            if (mi.ItemType == typeof(FlowSwitch<string>))
            {
                InitializeFlowSwitch(mi);
            }
            else if (mi.ItemType == typeof(FlowDecision))
            {
                InitializeFlowDecision(mi);
                _applicationTracker?.TrackCustomEvent(Warewolf.Studio.Resources.Languages.TrackEventWorkflowTabs.EventCategory, Warewolf.Studio.Resources.Languages.TrackEventWorkflowTabs.ItemDragged, mi.ItemType.Name);
            }
            else if (mi.ItemType == typeof(FlowStep))
            {
                InitializeFlowStep(mi);
            }
            else
            {
                AddSwitch(mi);
            }
            _isPaste = false;
            return addedItem;
        }

        void AddSwitch(ModelItem mi)
        {
            if (mi.Parent?.Parent?.Parent != null && mi.Parent.Parent.Parent.ItemType == typeof(FlowSwitch<string>))
            {
                var activityExpression = mi.Parent.Parent.Parent.Properties["Expression"];
                if (activityExpression != null)
                {
                    var switchExpressionValue = SwitchExpressionValue(activityExpression);
                    var modelProperty = mi.Properties["Key"];
                    if (modelProperty?.Value != null && (FlowController.OldSwitchValue == null || string.IsNullOrWhiteSpace(FlowController.OldSwitchValue)))
                    {
                        FlowController.ConfigureSwitchCaseExpression(new ConfigureCaseExpressionMessage { ModelItem = mi, ExpressionText = switchExpressionValue, Server = _resourceModel.Environment, IsPaste = _isPaste });
                    }
                }
            }
        }
        
        static string SwitchExpressionValue(ModelProperty activityExpression)
        {
            var tmpModelItem = activityExpression.Value;
            var switchExpressionValue = string.Empty;
            var tmpProperty = tmpModelItem?.Properties["ExpressionText"];
            var tmp = tmpProperty?.Value?.ToString();

            if (!string.IsNullOrEmpty(tmp))
            {
                var start = tmp.IndexOf("(", StringComparison.Ordinal);
                var end = tmp.IndexOf(",", StringComparison.Ordinal);

                if (start < end && start >= 0)
                {
                    start += 2;
                    end -= 1;
                    switchExpressionValue = tmp.Substring(start, (end - start));
                }
            }
            return switchExpressionValue;
        }

        void InitializeFlowStep(ModelItem mi)
        {
            // PBI 9135 - 2013.07.15 - TWR - Changed to "as" check so that database activity also flows through this
            var modelProperty1 = mi.Properties["Action"];
            InitialiseWithAction(modelProperty1);
        }

        void InitialiseWithAction(ModelProperty modelProperty1)
        {
            if (modelProperty1?.ComputedValue is DsfActivity droppedActivity)
            {
                if (!string.IsNullOrEmpty(droppedActivity.ServiceName))
                {
                    InitialiseWithoutServiceName(modelProperty1, droppedActivity);
                }
                else
                {
                    InitialiseWithDataObject(droppedActivity);
                }
            }
        }

        void InitialiseWithDataObject(DsfActivity droppedActivity)
        {
            if (DataObject != null)
            {
                if (DataObject is ExplorerItemViewModel viewModel)
                {
                    var serverRepository = CustomContainer.Get<IServerRepository>();
                    var server = serverRepository.FindSingle(c => c.EnvironmentID == viewModel.Server.EnvironmentID);
                    serverRepository.ActiveServer = server;
                    var theResource = server?.ResourceRepository.LoadContextualResourceModel(viewModel.ResourceId);

                    if (theResource != null)
                    {
                        DsfActivity d = DsfActivityFactory.CreateDsfActivity(theResource, droppedActivity, true, serverRepository, _resourceModel.Environment.IsLocalHostCheck());
                        TrackAction(theResource);

                        UpdateForRemote(d, theResource);
                    }
                }
                DataObject = null;
            }
        }

        void TrackAction(IContextualResourceModel theResource)
        {
            if (_applicationTracker != null)
            {
                if (theResource.DisplayName == "Hello World")
                {
                    //track hello world dragged
                    _applicationTracker.TrackCustomEvent(Warewolf.Studio.Resources.Languages.TrackEventWorkflowTabs.EventCategory,
                                       Warewolf.Studio.Resources.Languages.TrackEventWorkflowTabs.HelloWorld, theResource.DisplayName);
                }
                else if (theResource.Category != null && theResource.Category.StartsWith("Examples"))
                {
                    //track examples actitvity dragged
                    _applicationTracker.TrackCustomEvent(Warewolf.Studio.Resources.Languages.TrackEventWorkflowTabs.EventCategory,
                                        Warewolf.Studio.Resources.Languages.TrackEventWorkflowTabs.Examples, theResource.DisplayName);
                }
                else
                {
                    // other than above
                    _applicationTracker.TrackCustomEvent(Warewolf.Studio.Resources.Languages.TrackEventWorkflowTabs.EventCategory,
                                        Warewolf.Studio.Resources.Languages.TrackEventWorkflowTabs.ItemDragged, theResource.DisplayName);
                }
            }
        }

        public ResourceType ResourceType
        {
            get
            {
                if (ResourceModel != null)
                {
                    return ResourceModel.ResourceType;
                }
                return ResourceType.Unknown;
            }
        }

        void InitialiseWithoutServiceName(ModelProperty modelProperty1, DsfActivity droppedActivity)
        {
            var activity = droppedActivity;
            var serverRepository = CustomContainer.Get<IServerRepository>();
            var server = CustomContainer.Get<IServerRepository>().ActiveServer;
            var resourceId = Guid.Parse(activity.ResourceID.Expression.ToString());
            var resource = server.ResourceRepository.LoadContextualResourceModel(resourceId);
            var displayName = resource != null ? resource.DisplayName : activity.DisplayName;

            droppedActivity = DsfActivityFactory.CreateDsfActivity(resource, droppedActivity, false, serverRepository, _resourceModel.Environment.IsLocalHostCheck());
            WorkflowDesignerUtils.CheckIfRemoteWorkflowAndSetProperties(droppedActivity, resource, serverRepository.ActiveServer);
            modelProperty1.SetValue(droppedActivity);
            _applicationTracker?.TrackCustomEvent(Warewolf.Studio.Resources.Languages.TrackEventWorkflowTabs.EventCategory, Warewolf.Studio.Resources.Languages.TrackEventWorkflowTabs.ItemDragged, displayName);
        }

        void InitializeFlowSwitch(ModelItem mi)
        {
            // Travis.Frisinger : 28.01.2013 - Switch Amendments
            Dev2Logger.Info("Publish message of type - " + typeof(ConfigureSwitchExpressionMessage), "Warewolf Info");
            _expressionString = FlowController.ConfigureSwitchExpression(new ConfigureSwitchExpressionMessage { ModelItem = mi, Server = _resourceModel.Environment, IsNew = true, IsPaste = _isPaste });
            AddMissingWithNoPopUpAndFindUnusedDataListItemsImpl(false);
        }

        void InitializeFlowDecision(ModelItem mi)
        {
            Dev2Logger.Info("Publish message of type - " + typeof(ConfigureDecisionExpressionMessage), "Warewolf Info");
            var modelProperty = mi.Properties["Action"];

            InitialiseWithAction(modelProperty);
            _expressionString = FlowController.ConfigureDecisionExpression(new ConfigureDecisionExpressionMessage { ModelItem = mi, Server = _resourceModel.Environment, IsNew = true, IsPaste = _isPaste });
            AddMissingWithNoPopUpAndFindUnusedDataListItemsImpl(false);
        }

        void EditActivity(ModelItem modelItem, Guid parentEnvironmentID)
        {
            if (Designer == null)
            {
                return;
            }
            var modelService = Designer.Context.Services.GetService<ModelService>();
            if (modelService.Root == modelItem.Root && (modelItem.ItemType == typeof(DsfActivity) || modelItem.ItemType.BaseType == typeof(DsfActivity)))
            {
                var resourceID = ModelItemUtils.TryGetResourceID(modelItem);
                var shellViewModel = CustomContainer.Get<IShellViewModel>();
                shellViewModel.OpenResource(resourceID, parentEnvironmentID, shellViewModel.ActiveServer);
            }
        }

        static ModelItem RecursiveForEachCheck(dynamic activity)
        {
            if (activity.DataFunc.Handler is ModelItem innerAct)
            {
                if (innerAct.ItemType == typeof(DsfForEachActivity))
                {
                    innerAct = RecursiveForEachCheck(innerAct);
                }
            }
            return innerAct;
        }
        
        void PreventCommandFromBeingExecuted(CanExecuteRoutedEventArgs e)
        {
            if (Designer?.Context != null)
            {
                var selection = Designer.Context.Items.GetValue<Selection>();

                if (selection?.PrimarySelection == null)
                {
                    return;
                }

                if (selection.PrimarySelection.ItemType != typeof(Flowchart) &&
                   selection.SelectedObjects.All(modelItem => modelItem.ItemType != typeof(Flowchart)))
                {
                    return;
                }
            }

            e.CanExecute = false;
            e.Handled = true;
        }
        
        void SetLastDroppedPoint(DragEventArgs e)
        {
            var senderAsFrameworkElement = _modelService.Root.View as FrameworkElement;
            UIElement freePormPanel = senderAsFrameworkElement?.FindNameAcrossNamescopes("flowchartPanel");
            if (freePormPanel != null)
            {
                e.GetPosition(freePormPanel);
            }
        }

        IList<IDataListVerifyPart> BuildWorkflowFields()
        {
            var dataPartVerifyDuplicates = new DataListVerifyPartDuplicationParser();
            _uniqueWorkflowParts = new Dictionary<IDataListVerifyPart, string>(dataPartVerifyDuplicates);
            var modelService = Designer?.Context.Services.GetService<ModelService>();
            if (modelService != null)
            {
                var flowNodes = modelService.Find(modelService.Root, typeof(FlowNode));

                GetWorkflowFieldsFromFlowNodes(flowNodes);
            }
            var flattenedList = _uniqueWorkflowParts.Keys.ToList();
            return flattenedList;
        }

        protected void GetWorkflowFieldsFromFlowNodes(IEnumerable<ModelItem> flowNodes)
        {
            foreach (var flowNode in flowNodes)
            {
                var workflowFields = GetWorkflowFieldsFromModelItem(flowNode);
                foreach (var field in workflowFields)
                {
                    var isJsonObjectSource = field.StartsWith("@");
                    WorkflowDesignerDataPartUtils.BuildDataPart(field, _uniqueWorkflowParts, isJsonObjectSource);
                }
            }
        }

        IEnumerable<string> GetWorkflowFieldsFromModelItem(ModelItem flowNode)
        {
            var workflowFields = new List<string>();
            try
            {
                var modelProperty = flowNode.Properties["Action"];
                if (modelProperty != null)
                {
                    var activity = modelProperty.ComputedValue;
                    workflowFields = GetActivityElements(activity);
                }
                else
                {
                    var propertyName = string.Empty;
                    if (flowNode.ItemType.Name == "FlowDecision")
                    {
                        propertyName = "Condition";
                    }
                    else
                    {
                        if (flowNode.ItemType.Name == "FlowSwitch`1")
                        {
                            propertyName = "Expression";
                        }
                    }

                    var property = flowNode.Properties[propertyName];
                    if (property != null)
                    {
                        workflowFields = GetWorkflowFieldsFromProperty(workflowFields, property);
                    }
                }
            }
            catch (Exception ex)
            {
                Dev2Logger.Error(ex.Message, GlobalConstants.WarewolfError);
            }
            return workflowFields;
        }

        List<string> GetWorkflowFieldsFromProperty(List<string> workflowFields, ModelProperty property)
        {
            if (!string.IsNullOrEmpty(_expressionString))
            {
                workflowFields = TryGetDecisionElements(_expressionString, DataListSingleton.ActiveDataList);
                var activity = property.ComputedValue;
                if (activity != null)
                {
                    workflowFields.AddRange(TryGetDecisionElements(((dynamic)activity).ExpressionText, DataListSingleton.ActiveDataList));
                }
            }
            else
            {
                var activity = property.ComputedValue;
                if (activity != null)
                {
                    workflowFields.AddRange(TryGetDecisionElements(((dynamic)activity).ExpressionText, DataListSingleton.ActiveDataList));
                }
            }

            return workflowFields;
        }

        public static List<String> TryGetDecisionElements(string expression, IDataListViewModel datalistModel)
        {
            var decisionFields = new List<string>();
            if (!string.IsNullOrEmpty(expression))
            {
                var startIndex = expression.IndexOf('"');
                startIndex = startIndex + 1;
                var endindex = expression.IndexOf('"', startIndex);
                var decisionValue = expression.Substring(startIndex, endindex - startIndex);
                try
                {
                    decisionFields = GetDecisionElements(datalistModel, decisionFields, decisionValue);
                }
                catch (Exception)
                {
                    if (!DataListUtil.IsValueRecordset(decisionValue))
                    {
                        var parts = DataListFactory.CreateLanguageParser().ParseExpressionIntoParts(decisionValue, new List<IDev2DataLanguageIntellisensePart>());
                        decisionFields.AddRange(parts.Select(part => DataListUtil.StripBracketsFromValue(part.Option.DisplayValue)));
                        return decisionFields;
                    }
                    if (DataListSingleton.ActiveDataList != null)
                    {
                        var parts = DataListFactory.CreateLanguageParser().ParseDataLanguageForIntellisense(decisionValue, DataListSingleton.ActiveDataList.WriteToResourceModel(), true);
                        decisionFields.AddRange(parts.Select(part => DataListUtil.StripBracketsFromValue(part.Option.DisplayValue)));
                    }
                }
            }
            return decisionFields;
        }

        private static List<string> GetDecisionElements(IDataListViewModel datalistModel, List<string> decisionFields, string decisionValue)
        {
            var dds = JsonConvert.DeserializeObject<Dev2DecisionStack>(decisionValue.Replace('!', '\"'));
            foreach (var decision in dds.TheStack)
            {
                var getCols = new[] { decision.Col1, decision.Col2, decision.Col3 };
                for (var i = 0; i < 3; i++)
                {
                    decisionFields = GetDecisionFields(datalistModel, decisionFields, decisionValue, getCols, i);
                }
            }
            return decisionFields;
        }

        private static List<string> GetDecisionFields(IDataListViewModel datalistModel, List<string> decisionFields, string decisionValue, string[] getCols, int i)
        {
            var getCol = getCols[i];
            if (datalistModel != null)
            {
                var parsed = GetParsedRegions(getCol, datalistModel);
                if (!DataListUtil.IsValueRecordset(getCol) && parsed.Any(DataListUtil.IsValueRecordset))
                {
                    var parts = DataListFactory.CreateLanguageParser().ParseExpressionIntoParts(decisionValue, new List<IDev2DataLanguageIntellisensePart>());
                    decisionFields.AddRange(parts.Select(part => DataListUtil.StripBracketsFromValue(part.Option.DisplayValue)));
                }
                else
                {
                    decisionFields = decisionFields.Union(GetParsedRegions(getCol, datalistModel)).ToList();
                }
            }

            return decisionFields;
        }

        static IEnumerable<string> GetParsedRegions(string getCol, IDataListViewModel datalistModel)
        {
            // Travis.Frisinger - 25.01.2013
            // We now need to parse this data for regions ;)

            var parser = DataListFactory.CreateLanguageParser();
            // NEED - DataList for active workflow
            var parts = parser.ParseDataLanguageForIntellisense(getCol, datalistModel.WriteToResourceModel(), true);

            return (from intellisenseResult in parts
                    select DataListUtil.StripBracketsFromValue(intellisenseResult.Option.DisplayValue)
                    into varWithNoBrackets
                    where !string.IsNullOrEmpty(getCol) && !varWithNoBrackets.Equals(getCol)
                    select getCol
                   ).ToList();
        }

        static List<String> GetActivityElements(object activity)
        {
            enFindMissingType findMissingType;

            if (activity is DsfActivityAbstract<string> assign)
            {
                findMissingType = assign.GetFindMissingType();
            }
            else if (activity is DsfActivityAbstract<bool> other)
            {
                findMissingType = other.GetFindMissingType();
            }
            else
            {
                return new List<String>();
            }

            var activityFields = new List<string>();
            var stratFac = new Dev2FindMissingStrategyFactory();
            var strategy = stratFac.CreateFindMissingStrategy(findMissingType);

            foreach (var activityField in strategy.GetActivityFields(activity))
            {
                if (!string.IsNullOrEmpty(activityField))
                {
                    var wdu = new WorkflowDesignerUtils();
                    activityFields.AddRange(wdu.FormatDsfActivityField(activityField).Where(item => !item.Contains("xpath(")));
                }
            }
            return activityFields;
        }

        void OnItemSelected(Selection item)
        {
            var primarySelection = item.PrimarySelection;
            NotifyItemSelected(primarySelection);
            primarySelection.SetProperty("IsSelected", true);
            SelectedItem = primarySelection;
        }

        public Action<ModelItem> ItemSelectedAction { get; set; }

        public void Handle(AddStringListToDataListMessage message)
        {
            Dev2Logger.Info(message.GetType().Name, "Warewolf Info");
            var dlvm = DataListSingleton.ActiveDataList;
            if (dlvm != null)
            {
                var dataPartVerifyDuplicates = new DataListVerifyPartDuplicationParser();
                _uniqueWorkflowParts = new Dictionary<IDataListVerifyPart, string>(dataPartVerifyDuplicates);
                foreach (var s in message.ListToAdd)
                {
                    WorkflowDesignerDataPartUtils.BuildDataPart(s, _uniqueWorkflowParts);
                }
                var partsToAdd = _uniqueWorkflowParts.Keys.ToList();
                var uniqueDataListPartsToAdd = dlvm.MissingDataListParts(partsToAdd);
                dlvm.AddMissingDataListItems(uniqueDataListPartsToAdd);
            }
        }

        public bool NotifyItemSelected(object primarySelection) => false;

        public void BindToModel() => _resourceModel.WorkflowXaml = ServiceDefinition;

        public void InitializeDesigner(IDictionary<Type, Type> designerAttributes) => InitializeDesigner(designerAttributes, false);

        public void InitializeDesigner(IDictionary<Type, Type> designerAttributes, bool liteInit)
        {
            _wd = new WorkflowDesigner();
            if (!liteInit)
            {
                SetHashTable();
                SetDesignerConfigService();

                _wdMeta = new DesignerMetadata();
                _wdMeta.Register();
                var builder = new AttributeTableBuilder();
                foreach (var designerAttribute in designerAttributes)
                {
                    builder.AddCustomAttributes(designerAttribute.Key, new DesignerAttribute(designerAttribute.Value));
                }

                MetadataStore.AddAttributeTable(builder.CreateTable());

                _wd.Context.Items.Subscribe<Selection>(OnItemSelected);
                _wd.Context.Services.Subscribe<ModelService>(ModelServiceSubscribe);
                _wd.Context.Services.Subscribe<DesignerView>(DesigenrViewSubscribe);
                _wd.Context.Services.Publish(_designerManagementService);

                _wd.View.Measure(new Size(2000, 2000));
                _wd.View.PreviewDrop += ViewPreviewDrop;
                _wd.View.PreviewMouseDown += ViewPreviewMouseDown;
                _wd.View.PreviewKeyDown += ViewOnKeyDown;
                _wd.View.LostFocus += OnViewOnLostFocus;

                //Jurie.Smit 2013/01/03 - Added to disable the deleting of the root flowchart
                CommandManager.AddPreviewCanExecuteHandler(_wd.View, CanExecuteRoutedEventHandler);
                _wd.ModelChanged += WdOnModelChanged;
                _wd.View.Focus();

                var indexOfOpenItem = -1;
                if (_wd.ContextMenu?.Items != null)
                {
                    foreach (var menuItem in _wd.ContextMenu.Items.Cast<object>().OfType<MenuItem>().Where(menuItem => (string)menuItem.Header == "_Open"))
                    {
                        indexOfOpenItem = _wd.ContextMenu.Items.IndexOf(menuItem);
                        break;
                    }
                    if (indexOfOpenItem != -1)
                    {
                        _wd.ContextMenu.Items.RemoveAt(indexOfOpenItem);
                    }
                }

                CommandManager.AddPreviewExecutedHandler(_wd.View, PreviewExecutedRoutedEventHandler);

                Selection.Subscribe(_wd.Context, SelectedItemChanged);

                LoadDesignerXaml();
                _workflowHelper.EnsureImplementation(_modelService);

                WorkflowDesignerIcons.Activities.Flowchart = Application.Current.TryFindResource("Explorer-WorkflowService-Icon") as DrawingBrush;
                WorkflowDesignerIcons.Activities.StartNode = Application.Current.TryFindResource("System-StartNode-Icon") as DrawingBrush;
                SubscribeToDebugSelectionChanged();
                SetPermission(ResourceModel.UserPermissions);
                ViewModelUtils.RaiseCanExecuteChanged(_debugOutputViewModel?.AddNewTestCommand);
                UpdateErrorIconWithCorrectMessage();
            }
        }

        public void CreateDesigner() => CreateDesigner(false);

        public void CreateDesigner(bool liteInit)
        {
            _wd = new WorkflowDesigner();

            if (!liteInit)
            {
                SetHashTable();
                SetDesignerConfigService();

                _wdMeta = new DesignerMetadata();
                _wdMeta.Register();
                var builder = new AttributeTableBuilder();
                foreach (var designerAttribute in ActivityDesignerHelper.DesignerAttributes)
                {
                    builder.AddCustomAttributes(designerAttribute.Key, new DesignerAttribute(designerAttribute.Value));
                }

                MetadataStore.AddAttributeTable(builder.CreateTable());

                _wd.Context.Items.Subscribe<Selection>(OnItemSelected);
                _wd.Context.Services.Subscribe<ModelService>(ModelServiceSubscribe);
                _wd.Context.Services.Subscribe<DesignerView>(DesigenrViewSubscribe);
                _wd.Context.Services.Publish(_designerManagementService);

                _wd.View.Measure(new Size(2000, 2000));
                _wd.View.PreviewDrop += ViewPreviewDrop;
                _wd.View.PreviewMouseDown += ViewPreviewMouseDown;
                _wd.View.PreviewKeyDown += ViewOnKeyDown;
                _wd.View.LostFocus += OnViewOnLostFocus;

                //Jurie.Smit 2013/01/03 - Added to disable the deleting of the root flowchart
                CommandManager.AddPreviewCanExecuteHandler(_wd.View, CanExecuteRoutedEventHandler);
                _wd.ModelChanged += WdOnModelChanged;
                _wd.View.Focus();

                var indexOfOpenItem = -1;
                if (_wd.ContextMenu?.Items != null)
                {
                    foreach (var menuItem in _wd.ContextMenu.Items.Cast<object>().OfType<MenuItem>().Where(menuItem => (string)menuItem.Header == "_Open"))
                    {
                        indexOfOpenItem = _wd.ContextMenu.Items.IndexOf(menuItem);
                        break;
                    }
                    if (indexOfOpenItem != -1)
                    {
                        _wd.ContextMenu.Items.RemoveAt(indexOfOpenItem);
                    }
                }

                CommandManager.AddPreviewExecutedHandler(_wd.View, PreviewExecutedRoutedEventHandler);

                Selection.Subscribe(_wd.Context, SelectedItemChanged);
                WorkflowDesignerIcons.Activities.Flowchart = Application.Current.TryFindResource("Explorer-WorkflowService-Icon") as DrawingBrush;
                WorkflowDesignerIcons.Activities.StartNode = Application.Current.TryFindResource("System-StartNode-Icon") as DrawingBrush;
                SubscribeToDebugSelectionChanged();
                SetPermission(ResourceModel.UserPermissions);
                ViewModelUtils.RaiseCanExecuteChanged(_debugOutputViewModel?.AddNewTestCommand);
                UpdateErrorIconWithCorrectMessage();
            }
        }

        void SetHashTable() => _wd.PropertyInspectorFontAndColorData = XamlServices.Save(ActivityDesignerHelper.GetDesignerHashTable());

        void SetDesignerConfigService()
        {
            var designerConfigService = _wd.Context.Services.GetService<DesignerConfigurationService>();
            if (designerConfigService != null)
            {
                // set the runtime Framework version to 4.5 as new features are in .NET 4.5 and do not exist in .NET 4
                designerConfigService.TargetFrameworkName = new FrameworkName(".NETFramework", new Version(4, 5));
                designerConfigService.AutoConnectEnabled = true;
                designerConfigService.AutoSplitEnabled = true;
                designerConfigService.PanModeEnabled = true;
                designerConfigService.RubberBandSelectionEnabled = true;
                designerConfigService.BackgroundValidationEnabled = true;

                // prevent design-time background validation from blocking UI thread
                // Disabled for now
                designerConfigService.AnnotationEnabled = false;
                designerConfigService.AutoSurroundWithSequenceEnabled = false;
            }
        }
        
        static void ViewOnKeyDown(object sender, KeyEventArgs e)
        {
            var grid = sender as Grid;
            if (e.OriginalSource != null)
            {
                var origSource = e.OriginalSource.GetType();
                if (origSource.BaseType == typeof(ActivityDesigner) && e.Key == Key.Return)
                {
                    e.Handled = true;
                }

                var type = grid?.DataContext.GetType();
                if (type == typeof(ServiceTestViewModel) && e.Key == Key.Delete)
                {
                    e.Handled = true;
                }

                if (type == typeof(MergeWorkflowViewModel))
                {
                    if (origSource == typeof(TextBox))
                    {
                        return;
                    }
                    if (e.Key == Key.Delete)
                    {
                        e.Handled = true;
                        return;
                    }
                    var isControlPressed = (Keyboard.Modifiers & ModifierKeys.Control) == ModifierKeys.Control;
                    var isExpectedKey = e.Key == Key.C || e.Key == Key.V;
                    isExpectedKey |= e.Key == Key.X || e.Key == Key.Y || e.Key == Key.Z;
                    if (isControlPressed && isExpectedKey)
                    {
                        e.Handled = true;
                    }
                }
            }
        }

        static void DesigenrViewSubscribe(DesignerView instance)
        {
            // PBI 9221 : TWR : 2013.04.22 - .NET 4.5 upgrade
            instance.WorkflowShellHeaderItemsVisibility = ShellHeaderItemsVisibility.ExpandAll;
            instance.WorkflowShellBarItemVisibility = ShellBarItemVisibility.None;
            instance.WorkflowShellBarItemVisibility = ShellBarItemVisibility.Zoom | ShellBarItemVisibility.PanMode | ShellBarItemVisibility.MiniMap;
        }
        
        void OnViewOnLostFocus(object sender, RoutedEventArgs args)
        {
            var workSurfaceKey = WorkSurfaceKeyFactory.CreateKey(ResourceModel);

            // If we are opening from server skip this check, it cannot have "real" changes!
            if (!OpeningWorkflowsHelper.IsWorkflowWaitingforDesignerLoad(workSurfaceKey))
            {
                // an additional case we need to account for - Designer has resized and is only visible once focus is lost?! ;)
                if (OpeningWorkflowsHelper.IsWaitingForFistFocusLoss(workSurfaceKey) || WatermarkSential.IsWatermarkBeingApplied)
                {
                    ResourceModel.WorkflowXaml = ServiceDefinition;
                    OpeningWorkflowsHelper.RemoveWorkflowWaitingForFirstFocusLoss(workSurfaceKey);
                }
            }
        }

        protected void ModelServiceSubscribe(ModelService instance)
        {
            _modelService = instance;
            _modelService.ModelChanged += ModelServiceModelChanged;
            if (_activityCollection == null)
            {
                _activityCollection = _modelService.Find(_modelService.Root, typeof(Activity));
            }
            if (_modelItems == null)
            {
                _modelItems = _modelService.Find(_modelService.Root, typeof(IDev2Activity));
            }
        }

        void SubscribeToDebugSelectionChanged()
        {
            _virtualizedContainerService = _wd.Context.Services.GetService<VirtualizedContainerService>();
            if (_virtualizedContainerService != null)
            {
                _virtualizedContainerServicePopulateAllMethod = _virtualizedContainerService.GetType().GetMethod("BeginPopulateAll", BindingFlags.Instance | BindingFlags.NonPublic);
            }
            _debugSelectionChangedService.Unsubscribe();
            _debugSelectionChangedService.Subscribe(args =>
            {
                // we only care when the designer is visible
                if (!IsDesignerViewVisible)
                {
                    return;
                }

                if (args.SelectionType == ActivitySelectionType.None)
                {
                    ClearSelection();
                    return;
                }

                var debugState = args.DebugState;
                if (debugState != null)
                {
                    var workSurfaceMappingId = debugState.WorkSurfaceMappingId;
                    var selectedModelItem = GetSelectedModelItem(workSurfaceMappingId, debugState.ParentID.GetValueOrDefault());
                    if (selectedModelItem != null)
                    {
                        switch (args.SelectionType)
                        {
                            case ActivitySelectionType.Single:
                                ClearSelection();
                                SelectSingleModelItem(selectedModelItem);

                                BringIntoView(selectedModelItem);
                                break;

                            case ActivitySelectionType.Add:
                                AddModelItemToSelection(selectedModelItem);

                                BringIntoView(selectedModelItem);
                                break;

                            case ActivitySelectionType.Remove:
                                RemoveModelItemFromSelection(selectedModelItem);
                                break;

                            case ActivitySelectionType.None:
                                break;

                            default:
                                break;
                        }
                    }
                }
            });
        }

        public bool IsTestView { get; set; }

        protected virtual ModelItem GetSelectedModelItem(Guid itemId, Guid parentId)
        {
            if (_modelService != null)
            {
                var selectedModelItem = (from mi in _modelItems
                                         let instanceID = ModelItemUtils.GetUniqueID(mi)
                                         where instanceID == itemId || instanceID == parentId
                                         select mi).FirstOrDefault();

                if (selectedModelItem == null)
                {
                    // Find the root flow chart
                    selectedModelItem = _modelService.Find(_modelService.Root, typeof(Flowchart)).FirstOrDefault();
                }
                else
                {
                    if (DecisionSwitchTypes.Contains(selectedModelItem.Parent.ItemType))
                    {
                        // Decision/switches activities are represented by their parents in the designer!
                        selectedModelItem = selectedModelItem.Parent;
                    }
                }
                return selectedModelItem;
            }
            return null;
        }

        void SelectSingleModelItem(ModelItem selectedModelItem)
        {
            if (SelectedDebugItems.Contains(selectedModelItem))
            {
                return;
            }
            Selection.SelectOnly(_wd.Context, selectedModelItem);
            SelectedDebugItems.Add(selectedModelItem);
        }

        void RemoveModelItemFromSelection(ModelItem selectedModelItem)
        {
            if (SelectedDebugItems.Contains(selectedModelItem))
            {
                SelectedDebugItems.Remove(selectedModelItem);
            }
            Selection.Unsubscribe(_wd.Context, SelectedItemChanged);
        }

        public List<ModelItem> DebugModels => SelectedDebugItems;

        void AddModelItemToSelection(ModelItem selectedModelItem)
        {
            if (SelectedDebugItems.Contains(selectedModelItem))
            {
                return;
            }
            Selection.Union(_wd.Context, selectedModelItem);

            var modelItems = _activityCollection as ModelItem[] ?? _activityCollection.ToArray();
            var index = modelItems.ToList().IndexOf(selectedModelItem);
            if (index != -1)
            {
                Selection.Select(_wd.Context, modelItems.ElementAt(index));
            }
            else
            {
                if (DecisionSwitchTypes.Contains(selectedModelItem.Parent.ItemType))
                {
                    // Decision/switches activities are represented by their parents in the designer!
                    selectedModelItem = selectedModelItem.Parent;
                    index = modelItems.ToList().IndexOf(selectedModelItem);
                    if (index != -1)
                    {
                        Selection.Select(_wd.Context, modelItems.ElementAt(index));
                    }
                }
            }
            SelectedDebugItems.Add(selectedModelItem);
        }

        void ClearSelection()
        {
            _wd.Context.Items.SetValue(new Selection());
            if (_selectedDebugItems != null)
            {
                foreach (var selectedDebugItem in _selectedDebugItems)
                {
                    selectedDebugItem.SetProperty("IsSelected", false);
                }
            }
            _selectedDebugItems = new List<ModelItem>();
        }

        protected virtual void BringIntoView(ModelItem selectedModelItem)
        {
            if (selectedModelItem.View is FrameworkElement view && view.IsVisible)
            {
                BringIntoView(view);
                return;
            }

            var onAfterPopulateAll = new System.Action(() => BringIntoView(selectedModelItem.View as FrameworkElement));
            _virtualizedContainerServicePopulateAllMethod?.Invoke(_virtualizedContainerService, new object[] { onAfterPopulateAll });
        }

        public void BringMergeToView(DataTemplate selectedDataTemplate)
        {
            var dependencyObject = selectedDataTemplate.LoadContent();
            var frameworkElement = dependencyObject as FrameworkElement;
            BringIntoView(frameworkElement);
        }

        static void BringIntoView(FrameworkElement view) => Application.Current?.Dispatcher?.InvokeAsync(() => view?.BringIntoView(), DispatcherPriority.Background);

        protected void LoadDesignerXaml()
        {
            var xaml = _resourceModel.WorkflowXaml;

            // if null, try fetching. It appears there is more than the two routes identified to populating xaml ;(
            if (xaml == null || xaml.Length == 0)
            {
                // we always want server at this point ;)
                var workspace = GlobalConstants.ServerWorkspaceID;

                // log the trace for fetch ;)
                Dev2Logger.Info($"Null Definition For {_resourceModel.ID} :: {_resourceModel.ResourceName}. Fetching...", "Warewolf Info");

                // In the case of null of empty try fetching again ;)
                var msg = Server.ResourceRepository.FetchResourceDefinition(_resourceModel.Environment, workspace, _resourceModel.ID, false);
                if (msg != null)
                {
                    xaml = msg.Message;
                }
            }

            // if we still cannot find it, create a new one ;)
            if (xaml == null || xaml.Length == 0)
            {
                if (_resourceModel.ResourceType == ResourceType.WorkflowService)
                {
                    // log the trace for fetch ;)
                    CreateBlankWorkflow();
                }
                else
                {
                    // we have big issues ;(
                    throw new Exception($"Could not find resource definition for {_resourceModel.ResourceName}");
                }
            }
            else
            {
                SetDesignerText(xaml);
                _wd.Load();
            }
        }

        public void CreateBlankWorkflow()
        {
            CreateDesigner();
            var activityBuilder = _workflowHelper.CreateWorkflow(_resourceModel.ResourceName);
            _wd.Load(activityBuilder);
            BindToModel();
            _workflowHelper.EnsureImplementation(_modelService);
        }

        void SetDesignerText(StringBuilder xaml)
        {
            var designerText = _workflowHelper.SanitizeXaml(xaml);
            if (designerText != null)
            {
                _wd.Text = designerText.ToString();
            }
        }

        void SelectedItemChanged(Selection item)
        {
            if (_wd?.Context != null)
            {
                var contextItemManager = _wd.Context.Items;
                var selection = contextItemManager.GetValue<Selection>();
                if (selection.SelectedObjects.Count() > 1)
                {
                    DeselectFlowchart();
                }
            }
        }

        void DeselectFlowchart()
        {
            if (_wd?.Context != null)
            {
                var editingContext = _wd.Context;
                var selection = editingContext.Items.GetValue<Selection>();
                foreach (var item in selection.SelectedObjects.Where(item => item.ItemType == typeof(Flowchart)))
                {
                    Selection.Toggle(editingContext, item);
                    break;
                }
            }
        }

        public List<NameValue> GetSelectableGates(string uniqueId)
        {
            var serviceDifferenceParser = CustomContainer.Get<IServiceDifferenceParser>();
            var treeNodes = serviceDifferenceParser.BuildWorkflow(ServiceDefinition);

            var list = new List<NameValue> { new NameValue { Name = "End", Value = Guid.Empty.ToString() } };
            try
            {
                IEnumerable<IDev2Activity> connectedList(IDev2Activity activity)
                {
                    var ret = new List<IDev2Activity>();
                    ret.Add(activity);
                    if (activity.NextNodes is null)
                    {
                        return ret;
                    }

                    foreach (var nextActivity in activity.NextNodes)
                    {
                        ret.AddRange(connectedList(nextActivity));
                    }
                    return ret.Where(o => (o is GateActivity));
                }

                bool found = false;
                var allGates = connectedList(treeNodes[0].Activity)
                    .Cast<GateActivity>()
                    .Where(gate => gate?.GateOptions != null && gate.GateOptions.GateOpts is Continue);

                var selectableGates = allGates
                    .TakeWhile(gate => !(found = (gate.UniqueID == uniqueId)));

                foreach (var gate in selectableGates)
                {
                    var id = gate.UniqueID;
                    var activityName = gate.GetDisplayName();
                    var nameValue = new NameValue { Name = activityName, Value = id };
                    list.Add(nameValue);
                }
            }
            catch (Exception ex)
            {
                Dev2Logger.Error("Error loading selectable gates. Exception: " + ex.Message, GlobalConstants.ServerWorkspaceID.ToString());
            }
            return list;
        }

        protected void WdOnModelChanged(object sender, EventArgs eventArgs)
        {
            if ((Designer != null && Designer.View.IsKeyboardFocusWithin) || sender != null)
            {
                var workSurfaceKey = WorkSurfaceKeyFactory.CreateKey(ResourceModel);
                UpdateErrorIconWithCorrectMessage();

                // If we are opening from server skip this check, it cannot have "real" changes!
                if (!OpeningWorkflowsHelper.IsWorkflowWaitingforDesignerLoad(workSurfaceKey))
                {
                    // an additional case we need to account for - Designer has resized and is only visible once focus is lost?! ;)
                    if (OpeningWorkflowsHelper.IsWaitingForFistFocusLoss(workSurfaceKey))
                    {
                        ResourceModel.WorkflowXaml = ServiceDefinition;
                        OpeningWorkflowsHelper.RemoveWorkflowWaitingForFirstFocusLoss(workSurfaceKey);
                    }
                    if (ResourceModel.WorkflowXaml is null)
                    {
                        ResourceModel.WorkflowXaml = ServiceDefinition;
                    }

                    var checkServiceDefinition = CheckServiceDefinition();
                    var checkDataList = CheckDataList();

                    ResourceModel.IsWorkflowSaved = checkServiceDefinition && checkDataList;
                    _workspaceSave = false;
                    WorkflowChanged?.Invoke();
                    NotifyOfPropertyChange(() => DisplayName);
                    ViewModelUtils.RaiseCanExecuteChanged(_debugOutputViewModel?.AddNewTestCommand);
                }
                else
                {
                    // When opening from server, save the hydrated changes for future comparison ;)
                    if (!CheckServiceDefinition())
                    {
                        // process any latent datalist changes ;)
                        ProcessDataListOnLoad();
                        ResourceModel.WorkflowXaml = ServiceDefinition;
                    }
                }

                // THIS MUST NEVER BE DELETED ;)
                WatermarkSential.IsWatermarkBeingApplied = false;
            }
            if (_firstWorkflowChange)
            {
                AddMissingWithNoPopUpAndFindUnusedDataListItemsImpl(false);
                _firstWorkflowChange = false;
            }
        }

        void UpdateErrorIconWithCorrectMessage()
        {
            var validationIcon = DesignerView?.FindChild<Border>(border => border.Name.Equals("validationVisuals", StringComparison.CurrentCultureIgnoreCase));
            if (validationIcon != null && validationIcon.Name.Equals("validationVisuals", StringComparison.CurrentCultureIgnoreCase))
            {
                validationIcon.ToolTip = Warewolf.Studio.Resources.Languages.Tooltips.StartNodeNotConnectedToolTip;

                //It should be called once when there is first tool dragged or start node link get deleted
                if (!IsStartNodeErrorMessageSet)
                {
                    IsStartNodeErrorMessageSet = true;
                    _applicationTracker?.TrackEvent(Warewolf.Studio.Resources.Languages.TrackEventWorkflowTabs.EventCategory, Warewolf.Studio.Resources.Languages.TrackEventWorkflowTabs.StartNodeNotConnected);
                }
            }
        }

        bool CheckDataList()
        {
            if (_originalDataList == null)
            {
                return true;
            }

            if (ResourceModel.DataList != null)
            {
                var currentDataList = ResourceModel.DataList.Replace("<DataList>", "").Replace("</DataList>", "");
                return StringExtension.SpaceCaseInsenstiveComparision(currentDataList, _originalDataList);
            }
            return true;
        }
        string _serviceDefinitionXamlCache = "";
        string _resourceDefinitionXamlCache = "";
        bool _serviceAndResourceDefinitionXamlSameCache;
        bool CheckServiceDefinition()
        {
            if (ServiceDefinition is null || ResourceModel.WorkflowXaml is null)
            {
                return ServiceDefinition == ResourceModel.WorkflowXaml;
            }
            var serviceDefinitionXaml = ServiceDefinition.ToString();
            var resourceDefinitionXaml = ResourceModel.WorkflowXaml.ToString();
            if (serviceDefinitionXaml == _serviceDefinitionXamlCache && resourceDefinitionXaml == _resourceDefinitionXamlCache)
            {
                return _serviceAndResourceDefinitionXamlSameCache;
            }

            _serviceDefinitionXamlCache = serviceDefinitionXaml;
            _resourceDefinitionXamlCache = resourceDefinitionXaml;

            var eq = WorkflowHelper.AreWorkflowsEqual(ServiceDefinition.ToString(), ResourceModel.WorkflowXaml.ToString());
            _serviceAndResourceDefinitionXamlSameCache = eq;
            return eq;
        }
        
        void ProcessDataListOnLoad()
        {
            AddMissingWithNoPopUpAndFindUnusedDataListItemsImpl(true);
        }

        public void DoWorkspaceSave()
        {
            if (ResourceModel != null && ResourceModel.IsNewWorkflow && !_workspaceSave && ResourceModel.Environment.IsConnected)
            {
                _asyncWorker.Start(SaveToWorkspace);
            }
            AddMissingWithNoPopUpAndFindUnusedDataListItemsImpl(false);
        }

        void SaveToWorkspace()
        {
            BindToModel();
            ResourceModel.Environment.ResourceRepository.Save(ResourceModel);
            _workspaceSave = true;
        }
        
        public void UpdateDataList()
        {
            AddMissingWithNoPopUpAndFindUnusedDataListItemsImpl(false);
        }

        public static bool ValidatResourceModel(string dataList)
        {
            try
            {
                if (!string.IsNullOrEmpty(dataList))
                {
                    XElement.Parse(dataList);
                }
            }
            catch (Exception)
            {
                return false;
            }
            return true;
        }

        public void AddMissingWithNoPopUpAndFindUnusedDataListItems()
        {
            UpdateDataList();
        }

        public ModelItem GetModelItem(Guid workSurfaceMappingId, Guid parentID)
        {
            var modelItems = _modelService.Find(_modelService.Root, typeof(IDev2Activity));
            ModelItem selectedModelItem = null;
            foreach (var mi in modelItems)
            {
                var instanceID = ModelItemUtils.GetUniqueID(mi);
                if (instanceID == workSurfaceMappingId || instanceID == parentID)
                {
                    selectedModelItem = mi;
                    break;
                }
            }
            return selectedModelItem;
        }

        void AddMissingWithNoPopUpAndFindUnusedDataListItemsImpl(bool isLoadEvent)
        {
            if (DataListViewModel != null)
            {
                if (Application.Current != null && Application.Current.Dispatcher != null)
                {
                    Application.Current.Dispatcher.BeginInvoke(new System.Action(() =>
                    {
                        UpdateDataListWithMissingParts(isLoadEvent);
                    }), DispatcherPriority.Background);
                }
                else
                {
                    UpdateDataListWithMissingParts(isLoadEvent);
                }
            }
        }

        void UpdateDataListWithMissingParts(bool isLoadEvent)
        {
            var workSurfaceKey = WorkSurfaceKeyFactory.CreateKey(ResourceModel);
            if (OpeningWorkflowsHelper.IsWorkflowWaitingforDesignerLoad(workSurfaceKey) && !isLoadEvent)
            {
                OpeningWorkflowsHelper.RemoveWorkflowWaitingForDesignerLoad(workSurfaceKey);
            }

            var workflowFields = BuildWorkflowFields();
            DataListViewModel?.UpdateDataListItems(ResourceModel, workflowFields);
        }

        void ViewPreviewMouseDown(object sender, MouseButtonEventArgs e) => e.Handled = HandleMouseClick(e.LeftButton, e.ClickCount, e.OriginalSource as DependencyObject, e.Source as DesignerView);
        
        bool HandleMouseClick(MouseButtonState leftButtonState, int clickCount, DependencyObject dp, DesignerView designerView)
        {
            if (HandleDoubleClick(leftButtonState, clickCount, dp, designerView))
            {
                return true;
            }

            if (Application.Current != null && Application.Current.Dispatcher != null && Application.Current.Dispatcher.CheckAccess() && Application.Current.MainWindow != null)
            {
                var mvm = Application.Current.MainWindow.DataContext as ShellViewModel;
                if (mvm?.ActiveItem != null)
                {
                    mvm.RefreshActiveServer();
                }
            }

            if (dp is Border border && border.DataContext is GateDesignerViewModel gateDesignerViewModel)
            {
                gateDesignerViewModel.ClearGates();
                string uniqueId = gateDesignerViewModel.ModelItem.Properties["UniqueID"].ComputedValue.ToString();
                var gates = GetSelectableGates(uniqueId);
                gateDesignerViewModel.Gates = gates;
            }

            var dp1 = dp as Run;
            if (dp1?.Parent is TextBlock && dp1.DataContext.GetType().Name.Contains("FlowchartDesigner"))
            {
                var selectedModelItem = _modelService.Find(_modelService.Root, typeof(Flowchart)).FirstOrDefault();
                if (selectedModelItem != null)
                {
                    SelectSingleModelItem(selectedModelItem);
                }
                return true;
            }

            if (dp is TextBlock dp2 && dp2.DataContext.GetType().Name.Contains("FlowchartDesigner"))
            {
                var selectedModelItem = _modelService.Find(_modelService.Root, typeof(Flowchart)).FirstOrDefault();
                if (selectedModelItem != null)
                {
                    SelectSingleModelItem(selectedModelItem);
                }
                return true;
            }

            return false;
        }
        
        bool HandleDoubleClick(MouseButtonState leftButtonState, int clickCount, DependencyObject dp, DesignerView designerView)
        {
            if (leftButtonState == MouseButtonState.Pressed && clickCount == 2)
            {
                if (designerView != null && designerView.FocusedViewElement == null)
                {
                    return true;
                }

                if (SelectedModelItem is ModelItem item && item.ItemType == typeof(Flowchart))
                {
                    return true;
                }

                HandleDependencyObject(dp, item);
            }
            return false;
        }
        
        void HandleDependencyObject(DependencyObject dp, ModelItem item)
        {
            if (item != null)
            {
                var itemFn = item.ItemType.FullName;

                if (dp != null && string.Equals(dp.ToString(), "Microsoft.Windows.Themes.ScrollChrome", StringComparison.InvariantCulture))
                {
                    WizardEngineAttachedProperties.SetDontOpenWizard(dp, true);
                }

                // Handle Case Edits
                if (itemFn.StartsWith("System.Activities.Core.Presentation.FlowSwitchCaseLink", StringComparison.Ordinal) &&
                    !itemFn.StartsWith("System.Activities.Core.Presentation.FlowSwitchDefaultLink", StringComparison.Ordinal))
                {
                    if (dp != null && !WizardEngineAttachedProperties.GetDontOpenWizard(dp))
                    {
                        FlowController.TryEditSwitchCaseExpression(new EditCaseExpressionMessage
                        {
                            ModelItem = item,
                            Server = _resourceModel.Environment
                        });
                    }
                }

                // Handle Switch Edits
                if (dp != null && !WizardEngineAttachedProperties.GetDontOpenWizard(dp) &&
                    item.ItemType == typeof(FlowSwitch<string>))
                {
                    _expressionString =
                        FlowController.ConfigureSwitchExpression(new ConfigureSwitchExpressionMessage
                        {
                            ModelItem = item,
                            Server = _resourceModel.Environment
                        });
                    AddMissingWithNoPopUpAndFindUnusedDataListItemsImpl(false);
                }

                //// Handle Decision Edits
                if (dp != null && !WizardEngineAttachedProperties.GetDontOpenWizard(dp) &&
                    item.ItemType == typeof(FlowDecision))
                {
                    _expressionString =
                        FlowController.ConfigureDecisionExpression(new ConfigureDecisionExpressionMessage
                        {
                            ModelItem = item,
                            Server = _resourceModel.Environment
                        });
                    AddMissingWithNoPopUpAndFindUnusedDataListItemsImpl(false);
                }
            }
        }
        
        static IResourcePickerDialog CreateResourcePickerDialog(enDsfActivityType activityType)
        {
            var server = CustomContainer.Get<IServerRepository>().ActiveServer;

            if (server.Permissions == null)
            {
                server.Permissions = new List<IWindowsGroupPermission>();
                server.Permissions.AddRange(server.AuthorizationService.SecurityService.Permissions);
            }
            var env = new EnvironmentViewModel(server, CustomContainer.Get<IShellViewModel>(), true);
            var res = new ResourcePickerDialog(activityType, env);
            ResourcePickerDialog.CreateAsync(activityType, env);
            return res;
        }
        
        void ViewPreviewDrop(object sender, DragEventArgs e)
        {
            SetLastDroppedPoint(e);
            var dataObject = e.Data;
            e.Handled = ApplyForDrop(dataObject);
        }

        protected bool ApplyForDrop(IDataObject dataObject)
        {
            var handled = false;
            if (dataObject != null)
            {
                DataObject = dataObject.GetData(typeof(ExplorerItemViewModel));
                if (DataObject != null)
                {
                    IsItemDragged.Instance.IsDragged = true;
                }

                if (dataObject.GetData("WorkflowItemTypeNameFormat") is string isWorkflow)
                {
                    handled = WorkflowDropFromResourceToolboxItem(dataObject, isWorkflow, true, false);
                    ApplyIsDraggedInstance(isWorkflow);
                }
                else
                {
                    IsItemDragged.Instance.IsDragged = false;
                }
            }
            return handled;
        }

        static void ApplyIsDraggedInstance(string isWorkflow)
        {
            IsItemDragged.Instance.IsDragged |= isWorkflow.Contains("DsfSqlServerDatabaseActivity") || isWorkflow.Contains("DsfMySqlDatabaseActivity");
            IsItemDragged.Instance.IsDragged |= isWorkflow.Contains("DsfODBCDatabaseActivity") || isWorkflow.Contains("DsfOracleDatabaseActivity");
            IsItemDragged.Instance.IsDragged |= isWorkflow.Contains("DsfPostgreSqlActivity") || isWorkflow.Contains("DsfWebDeleteActivity");
            IsItemDragged.Instance.IsDragged |= isWorkflow.Contains("DsfWebGetActivity") || isWorkflow.Contains("WebPostActivity");
            IsItemDragged.Instance.IsDragged |= isWorkflow.Contains("DsfWebPutActivity") || isWorkflow.Contains("DsfComDllActivity");
            IsItemDragged.Instance.IsDragged |= isWorkflow.Contains("DsfEnhancedDotNetDllActivity") || isWorkflow.Contains("DsfWcfEndPointActivity");
            IsItemDragged.Instance.IsDragged |= isWorkflow.Contains("AdvancedRecordsetActivity");
            IsItemDragged.Instance.IsDragged |= isWorkflow.Contains("GateActivity");
        }
        
        bool WorkflowDropFromResourceToolboxItem(IDataObject dataObject, string isWorkflow, bool dropOccured, bool handled)
        {
            var activityType = ResourcePickerDialog.DetermineDropActivityType(isWorkflow);
            if (IsTestView)
            {
                return true;
            }
            if (activityType != enDsfActivityType.All)
            {
                var dialog = CreateResourcePickerDialog(activityType);
                if (dialog.ShowDialog())
                {
                    var res = dialog.SelectedResource;
                    if (res != null)
                    {
                        dataObject.SetData(res);
                        dataObject.SetData(new FromToolBox());
                        DataObject = res;
                    }
                    if (res == null)
                    {
                        dropOccured = false;
                        handled = true;
                    }
                }
                else
                {
                    handled = true;
                    dropOccured = false;
                }
            }
            if (dropOccured)
            {
                _workspaceSave = false;
                ResourceModel.IsWorkflowSaved = false;
                NotifyOfPropertyChange(() => DisplayName);
            }
            return handled;
        }

        // Activity : Next
        // Decision : True, False
        // Switch   : Default, Key
        public static readonly string[] SelfConnectProperties =
        {
            "Next",
            "True",
            "False",
            "Default",
            "Key"
        };

        string _originalDataList;
        bool _workspaceSave;
        WorkflowInputDataViewModel _workflowInputDataViewModel;
        string _workflowLink;
        string _workflowLinkWithWid;
        ICommand _openWorkflowLinkCommand;
        bool _firstWorkflowChange;
        readonly IAsyncWorker _asyncWorker;
        string _expressionString;
        ICommand _debugInputsCommand;
        ICommand _debugStudioCommand;
        ICommand _debugBrowserCommand;
        ICommand _scheduleCommand;
        ICommand _queueEventCommand;
        ICommand _testEditorCommand;
        ICommand _runAllTestsCommand;
        ICommand _duplicateCommand;
        ICommand _deployCommand;
        ICommand _showDependenciesCommand;
        ICommand _viewOpenAPICommand;
        ICommand _copyUrlCommand;
        DebugOutputViewModel _debugOutputViewModel;
        IDataListViewModel _dataListViewModel;
        bool _canDebugInputs;
        bool _canDebugStudio;
        bool _debugBrowser;
        bool _canCreateSchedule;
        bool _canCreateQueueEvent;
        bool _canCreateTest;
        bool _canRunAllTests;
        bool _canDuplicate;
        bool _canDeploy;
        bool _canShowDependencies;
        bool _canViewOpenAPI;
        bool _canCopyUrl;
        string _copyUrlTooltip;
        string _viewOpenAPITooltip;
        string _debugInputsTooltip;
        string _debugStudioTooltip;
        string _debugBrowserTooltip;
        string _scheduleTooltip;
        string _queueEventTooltip;
        string _createTestTooltip;
        string _runAllTestsTooltip;
        string _runCoverageTooltip;
        string _duplicateTooltip;
        string _deployTooltip;
        string _showDependenciesTooltip;
        ICommand _newServiceCommand;
        ModelItem _selectedItem;
        IEnumerable<ModelItem> _modelItems;
        IEnumerable<ModelItem> _activityCollection;
        ICommand _mergeCommand;
        bool _canMerge;
        string _mergeTooltip;
       
        protected void ModelServiceModelChanged(object sender, ModelChangedEventArgs e)
        {
            if (e.ModelChangeInfo != null &&
                e.ModelChangeInfo.ModelChangeType == ModelChangeType.PropertyChanged)
            {
                if (SelfConnectProperties.Contains(e.ModelChangeInfo.PropertyName))
                {
                    if (e.ModelChangeInfo.Subject == e.ModelChangeInfo.Value)
                    {
                        var modelProperty = e.ModelChangeInfo.Value.Properties[e.ModelChangeInfo.PropertyName];
                        modelProperty?.ClearValue();
                    }
                    return;
                }
                if (e.ModelChangeInfo.PropertyName == "StartNode")
                {
                    if (e.ModelChangeInfo.OldValue != null)
                    {
                        // incase of delete it will have old value then log
                        IsStartNodeErrorMessageSet = false;
                    }
                    return;
                }

                if (e.ModelChangeInfo.PropertyName == "Handler")
                {
                    if (DataObject != null)
                    {
                        ModelItemPropertyChanged(e);
                    }
                }
            }

            if (e.ModelChangeInfo != null && e.ModelChangeInfo.ModelChangeType == ModelChangeType.CollectionItemAdded)
            {
                PerformAddItems(e.ModelChangeInfo.Value);
            }

            if (e.ModelChangeInfo != null && e.ModelChangeInfo.ModelChangeType == ModelChangeType.PropertyChanged
                && (e.ModelChangeInfo.Value?.Source?.ComputedValue?.GetType() == typeof(DsfFlowDecisionActivity)
                || e.ModelChangeInfo.Value?.Source?.ComputedValue?.GetType() == typeof(DsfFlowSwitchActivity)))
            {
                PerformAddItems(e.ModelChangeInfo.Value);
            }
            WorkflowChanged?.Invoke();
        }

        void ModelItemPropertyChanged(ModelChangedEventArgs e)
        {
            Guid? envID = null;
            Guid? resourceID = null;
            if (DataObject is IExplorerItemViewModel explorerItem)
            {
                if (explorerItem.Server != null)
                {
                    envID = explorerItem.Server.EnvironmentID;
                }

                resourceID = explorerItem.ResourceId;
            }

            var modelProperty = e.ModelChangeInfo.Subject.Content;

            if (envID != null && modelProperty != null)
            {
                var server = CustomContainer.Get<IServerRepository>().FindSingle(c => c.EnvironmentID == envID);
                var resource = server?.ResourceRepository.LoadContextualResourceModel(resourceID.Value);
                if (resource != null)
                {
                    var d = DsfActivityFactory.CreateDsfActivity(resource, null, true, CustomContainer.Get<IServerRepository>(), _resourceModel.Environment.IsLocalHostCheck());
                    d.ServiceName = d.DisplayName = d.ToolboxFriendlyName = resource.Category;
                    UpdateForRemote(d, resource);
                    modelProperty.SetValue(d);
                }
            }
            DataObject = null;
            WorkflowChanged?.Invoke();
        }

        void UpdateForRemote(DsfActivity d, IContextualResourceModel resource)
        {
            if (Application.Current != null && Application.Current.Dispatcher.CheckAccess() && Application.Current.MainWindow != null)
            {
                dynamic mvm = Application.Current.MainWindow.DataContext;
                if (mvm?.ActiveItem != null)
                {
                    WorkflowDesignerUtils.CheckIfRemoteWorkflowAndSetProperties(d, resource, mvm.ActiveItem.Environment);
                }
            }
            else
            {
                if (ActiveEnvironment != null)
                {
                    WorkflowDesignerUtils.CheckIfRemoteWorkflowAndSetProperties(d, resource, ActiveEnvironment);
                }
            }
        }

        protected IServer ActiveEnvironment { get; set; }

        void CanExecuteRoutedEventHandler(object sender, CanExecuteRoutedEventArgs e)
        {
            if (e.Command.Equals(ApplicationCommands.Delete) ||      //triggered from deleting an activity
                e.Command.Equals(EditingCommands.Delete) ||          //triggered from editing displayname, expressions, etc
                e.Command.Equals(System.Activities.Presentation.View.DesignerView.CopyCommand) ||
                e.Command.Equals(System.Activities.Presentation.View.DesignerView.CutCommand))
            {
                PreventCommandFromBeingExecuted(e);
            }
        }

        void PreviewExecutedRoutedEventHandler(object sender, ExecutedRoutedEventArgs e)
        {
            if (e.Command.Equals(ApplicationCommands.Delete))
            {
                _wd?.View?.MoveFocus(new TraversalRequest(FocusNavigationDirection.First));
            }
            
            if (!Handle(e))
            {
                BuildWorkflowFields();
            }
        }

        bool Handle(ExecutedRoutedEventArgs e)
        {
            var Handled = false;
            if (e.Command.Equals(System.Activities.Presentation.View.DesignerView.PasteCommand))
            {
                _isPaste = true;
                var dataObject = Clipboard.GetDataObject();
                if (dataObject != null)
                {
                    var dataPresent = dataObject.GetDataPresent("WorkflowXamlFormat");
                    if (dataPresent)
                    {
                        Handled = Handle(e, dataObject);
                    }
                }
            }
            return Handled;
        }

        bool Handle(ExecutedRoutedEventArgs e, IDataObject dataObject)
        {
            var data = dataObject.GetData("WorkflowXamlFormat") as string;
            if (!string.IsNullOrEmpty(data))
            {
                var indexOf = data.IndexOf("ResourceID=", StringComparison.InvariantCultureIgnoreCase);
                var guid = data.Substring(indexOf + 12, 36);
                if (guid.Equals(ResourceModel.ID.ToString(), StringComparison.InvariantCultureIgnoreCase))
                {
                    e.Handled = true;
                }
            }
            return e.Handled;
        }

        protected override void OnDispose()
        {
            if (_wd != null)
            {
                _wd.ModelChanged -= WdOnModelChanged;
                _wd.Context.Services.Unsubscribe<ModelService>(ModelServiceSubscribe);

                _wd.View.PreviewDrop -= ViewPreviewDrop;

                _wd.View.PreviewMouseDown -= ViewPreviewMouseDown;

                _wd.Context.Services.Unsubscribe<DesignerView>(DesigenrViewSubscribe);
                _virtualizedContainerService = null;
                _virtualizedContainerServicePopulateAllMethod = null;
            }

            _designerManagementService?.Dispose();
            _debugSelectionChangedService?.Unsubscribe();

            if (_resourceModel != null)
            {
                _resourceModel.OnDataListChanged -= FireWdChanged;
                _resourceModel.OnResourceSaved -= UpdateOriginalDataList;
            }

            if (_modelService != null)
            {
                _modelService.ModelChanged -= ModelServiceModelChanged;
            }

            if (_uniqueWorkflowParts != null)
            {
                _uniqueWorkflowParts.Clear();
                _uniqueWorkflowParts = null;
            }
            
            if (ResourceModel != null)
            {
                var workSurfaceKey = WorkSurfaceKeyFactory.CreateKey(ResourceModel);
                OpeningWorkflowsHelper.PruneWorkflowFromCaches(workSurfaceKey);
            }
            if (_workflowInputDataViewModel != null)
            {
                _workflowInputDataViewModel.Dispose();
                _workflowInputDataViewModel = null;
            }
            try
            {
                CEventHelper.RemoveAllEventHandlers(_wd);
            }
            catch (Exception e)
            {
                Dev2Logger.Warn("Error disposing Workflow Designer View Model: " + e.Message, GlobalConstants.WarewolfWarn);
            }

            _debugSelectionChangedService?.Unsubscribe();
            base.OnDispose();
        }

        public override WorkSurfaceContext WorkSurfaceContext => ResourceModel?.ResourceType.ToWorkSurfaceContext() ?? WorkSurfaceContext.Unknown;

        public IServer Server => ResourceModel.Environment;

        protected List<ModelItem> SelectedDebugItems => _selectedDebugItems;

        public ModelItem SelectedItem
        {
            get => _selectedItem;
            set => _selectedItem = value;
        }

        public bool WorkspaceSave => _workspaceSave;

        public void Handle(EditActivityMessage message)
        {
            Dev2Logger.Info(message.GetType().Name, "Warewolf Info");
            EditActivity(message.ModelItem, message.ParentEnvironmentID);
        }

        void FireWdChanged()
        {
            WdOnModelChanged(new object(), new EventArgs());
            UpdateWorkflowLink();
        }

        public void Handle(SaveUnsavedWorkflowMessage message)
        {
            if (message?.ResourceModel == null || string.IsNullOrEmpty(message.ResourceName) || message.ResourceModel.ID != ResourceModel.ID)
            {
                return;
            }

            var resourceModel = message.ResourceModel;
            WorkspaceItemRepository.Instance.Remove(resourceModel);
            var unsavedName = resourceModel.ResourceName;
            UpdateResourceModel(message, resourceModel, unsavedName);
            PublishMessages(resourceModel);
            DisposeDesigner();

            if (message.KeepTabOpen)
            {
                ActivityDesignerHelper.AddDesignerAttributes(this);
                UpdateWorkflowInputDataViewModel(_resourceModel);

                DisplayWorkflowLink = GetAndUpdateWorkflowLinkWithWorkspaceID();
                NotifyOfPropertyChange(nameof(DisplayWorkflowLink));
                NotifyOfPropertyChange(nameof(DesignerView));
            }
            RemoveUnsavedWorkflowName(unsavedName);
        }

        public void UpdateWorkflowInputDataViewModel(IContextualResourceModel resourceModel)
        {
            _workflowInputDataViewModel = WorkflowInputDataViewModel.Create(_resourceModel);
            _workflowInputDataViewModel.LoadWorkflowInputs();
        }

        internal void RemoveUnsavedWorkflowName(string unsavedName) => NewWorkflowNames.Instance.Remove(unsavedName);
        internal void RemoveAllWorkflowName(string unsavedName) => NewWorkflowNames.Instance.RemoveAll(unsavedName);

        void DisposeDesigner()
        {
            if (_wd != null)
            {
                _wd.ModelChanged -= WdOnModelChanged;
                _wd.Context.Services.Unsubscribe<ModelService>(ModelServiceSubscribe);

                _wd.View.PreviewDrop -= ViewPreviewDrop;
                _wd.View.PreviewMouseDown -= ViewPreviewMouseDown;

                _wd.Context.Services.Unsubscribe<DesignerView>(DesigenrViewSubscribe);
                _virtualizedContainerService = null;
                _virtualizedContainerServicePopulateAllMethod = null;
            }

            _designerManagementService?.Dispose();
            if (_modelService != null)
            {
                _modelService.ModelChanged -= ModelServiceModelChanged;
            }
            _debugSelectionChangedService?.Unsubscribe();
        }

        void PublishMessages(IContextualResourceModel resourceModel)
        {
            UpdateResource(resourceModel);
            Dev2Logger.Info("Publish message of type - " + typeof(UpdateResourceMessage), "Warewolf Info");
            EventPublisher.Publish(new UpdateResourceMessage(resourceModel));
        }

        void UpdateResource(IContextualResourceModel resourceModel)
        {
            if (ContexttualResourceModelEqualityComparer.Current.Equals(resourceModel, _resourceModel))
            {
                IObservableReadOnlyList<IErrorInfo> currentErrors = null;
                if (resourceModel.Errors != null && resourceModel.Errors.Count > 0)
                {
                    currentErrors = resourceModel.Errors;
                }
                _resourceModel.Update(resourceModel);
                if (currentErrors != null && currentErrors.Count > 0)
                {
                    foreach (var currentError in currentErrors)
                    {
                        _resourceModel.AddError(currentError);
                    }
                }
            }
        }

        void UpdateResourceModel(SaveUnsavedWorkflowMessage message, IContextualResourceModel resourceModel, string unsavedName)
        {
            resourceModel.ResourceName = message.ResourceName;
            resourceModel.DisplayName = message.ResourceName;
            resourceModel.Category = message.ResourceCategory;
            resourceModel.WorkflowXaml = ServiceDefinition?.Replace(unsavedName, message.ResourceName);
            resourceModel.IsNewWorkflow = false;
            var saveResult = resourceModel.Environment.ResourceRepository.SaveToServer(resourceModel);
            var mainViewModel = CustomContainer.Get<IShellViewModel>();
            var environmentViewModel = mainViewModel?.ExplorerViewModel?.Environments.FirstOrDefault(model => model.Server.EnvironmentID == resourceModel.Environment.EnvironmentID);
            if (environmentViewModel != null)
            {
                var item = environmentViewModel.FindByPath(resourceModel.GetSavePath());
                var savedItem = environmentViewModel?.CreateExplorerItemFromResource(environmentViewModel.Server, item, false, false, resourceModel);
                item.AddChild(savedItem);
            }
            resourceModel.IsWorkflowSaved = true;
            DeleteOldResourceAfterSucessfulSave(message, saveResult);
        }

        public void DeleteOldResourceAfterSucessfulSave(SaveUnsavedWorkflowMessage message, ExecuteMessage saveResult)
        {
            if (!saveResult.HasError
                && saveResult.Message.Contains("Added")
                && !message.ResourceLoadingFromServer
                && !string.IsNullOrEmpty(message.OriginalPath))
            {
                try
                {
                    File.Delete(message.OriginalPath);
                }
                catch (Exception)
                {
                    Dev2Logger.Error("Resource from " + message.OriginalPath + " could not be Deleted", "Warewolf Error");
                }
            }
        }

        protected bool _isPaste;
        private IShellViewModel _shellViewModel;

        public System.Action WorkflowChanged { get; set; }
    }
}
---- Semantic diagnostics *before* transformation ----

---- Semantic diagnostics *after* transformation ----
D:\a\1\s\Dev\Dev2.Studio\ViewModels\Workflow\WorkflowDesignerViewModel.cs(1241,20): error CS0165: Use of unassigned local variable 'innerAct',D:\a\1\s\Dev\Dev2.Studio\ViewModels\Workflow\WorkflowDesignerViewModel.cs(2310,44): error CS0165: Use of unassigned local variable 'item'
######################################################################


######################################################################
Nr: 26 - UsePatternMatchingRewriterR8
Filepath: D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs
Description: Error: The created Syntax Tree is semantically incorrect.
------------------------------------------------------------------------
---- Original Tree ----
using System;
using System.ComponentModel;
using System.Diagnostics;
using System.IO;
using System.Linq;
using System.Runtime.InteropServices;
using System.Windows;
using System.Windows.Data;
using System.Windows.Forms;
using System.Windows.Input;
using System.Windows.Media.Animation;
using System.Xml;
using Dev2.Common;
using Dev2.Triggers.Scheduler;
using Dev2.Studio.ViewModels;
using FontAwesome.WPF;
using Infragistics.Windows.DockManager.Events;
using WinInterop = System.Windows.Interop;
using Dev2.Studio.Core;
using Dev2.Studio.ViewModels.Workflow;
using Dev2.Studio.ViewModels.WorkSurface;
using Dev2.ViewModels;
using Dev2.Workspaces;
using Infragistics.Windows.DockManager;
using Dev2.Triggers.Scheduler;

namespace Dev2.Studio.Views
{
    public partial class ShellView : IWin32Window
    {
        static bool _isSuperMaximising;
        bool _isLocked;
        readonly string _savedLayout;
        static ShellView _this;

        #region Constructor

        public static ShellView GetInstance() => _this;

        public ShellView()
        {
            InitializeComponent();
            _isLocked = true;
            HideFullScreenPanel.IsHitTestVisible = false;
            ShowFullScreenPanel.IsHitTestVisible = false;
            Loaded += OnLoaded;
            KeyDown += Shell_KeyDown;
            SourceInitialized += WinSourceInitialized;

            if (File.Exists(FilePath))
            {
                GetFilePath();
                using (FileStream fs = new FileStream(FilePath, FileMode.Open, FileAccess.Read))
                {
                    var streamReader = new StreamReader(fs);
                    _savedLayout = streamReader.ReadToEnd();
                }
                if (!string.IsNullOrEmpty(_savedLayout))
                {
                    try
                    {
                        DockManager.LoadLayout(_savedLayout);
                    }
                    catch (Exception err)
                    {
                        _savedLayout = null;
                        File.Delete(FilePath);
                        Dev2Logger.Error("Unable to load layout", GlobalConstants.WarewolfError);
                        Dev2Logger.Error(err, GlobalConstants.WarewolfError);
                    }
                }
            }

#pragma warning disable S3010 // For testing (Studio reset shortcut)
            _this = this;
#pragma warning restore S3010
        }

        string FilePath => Path.Combine(new[]
        {
            Environment.GetFolderPath(Environment.SpecialFolder.LocalApplicationData),
            StringResources.App_Data_Directory,
            StringResources.User_Interface_Layouts_Directory,
            "WorkspaceLayout.xml"
        });

        void GetFilePath()
        {
            if (!File.Exists(FilePath))
            {
                var fileInfo = new FileInfo(FilePath);
                if (fileInfo.Directory != null)
                {
                    var finalDirectoryPath = fileInfo.Directory.FullName;

                    if (!Directory.Exists(finalDirectoryPath))
                    {
                        Directory.CreateDirectory(finalDirectoryPath);
                    }
                }
            }
        }

        #endregion Constructor

        void WinSourceInitialized(object sender, EventArgs e)
        {
            Maximise();
        }

        void Maximise()
        {
            var handle = new WinInterop.WindowInteropHelper(this).Handle;
            var handleSource = WinInterop.HwndSource.FromHwnd(handle);
            handleSource?.AddHook(WindowProc);
        }

        static IntPtr WindowProc(IntPtr hwnd, int msg, IntPtr wParam, IntPtr lParam, ref bool handled)
        {
            if (msg == 0x0024 && !_isSuperMaximising)
            {
                WmGetMinMaxInfo(hwnd, lParam);
                handled = true;
            }
            return (IntPtr)0;
        }

        static void WmGetMinMaxInfo(IntPtr hwnd, IntPtr lParam)
        {
            var mmi = (Minmaxinfo)Marshal.PtrToStructure(lParam, typeof(Minmaxinfo));

            // Adjust the maximized size and position to fit the work area of the correct monitor
            var currentScreen = Screen.FromHandle(hwnd);
            var workArea = currentScreen.WorkingArea;
            var monitorArea = currentScreen.Bounds;
            mmi.ptMaxPosition.x = Math.Abs(workArea.Left - monitorArea.Left);
            mmi.ptMaxPosition.y = Math.Abs(workArea.Top - monitorArea.Top);
            mmi.ptMaxSize.x = Math.Abs(workArea.Right - workArea.Left);
            mmi.ptMaxSize.y = Math.Abs(workArea.Bottom - workArea.Top);

            Marshal.StructureToPtr(mmi, lParam, true);
        }

        [StructLayout(LayoutKind.Sequential)]

        public struct Minmaxinfo
        {
            public Point ptReserved;
            public Point ptMaxSize;
            public Point ptMaxPosition;
            public Point ptMinTrackSize;
            public Point ptMaxTrackSize;
        };

        [StructLayout(LayoutKind.Sequential)]
        public struct Point
        {
            /// <summary>
            /// x coordinate of point.
            /// </summary>
            public int x;

            /// <summary>
            /// y coordinate of point.
            /// </summary>
            public int y;

            /// <summary>
            /// Construct a point of coordinates (x,y).
            /// </summary>
            public Point(int x, int y)
            {
                this.x = x;
                this.y = y;
            }
        }

        void Shell_KeyDown(object sender, System.Windows.Input.KeyEventArgs e)
        {
            if ((Keyboard.Modifiers == (ModifierKeys.Alt | ModifierKeys.Control)) && (e.Key == Key.F4))
            {
                ResetToStartupView();
            }
            if (e.Key == Key.Home && (Keyboard.Modifiers & ModifierKeys.Control) == ModifierKeys.Control)
            {
                var shellViewModel = DataContext as ShellViewModel;
                shellViewModel?.MergeCommand.Execute(null);
            }
            if (e.Key == Key.F1)
            {
                Process.Start(Warewolf.Studio.Resources.Languages.HelpText.WarewolfHelpURL);
            }
            if (e.Key == Key.F11 && _isLocked)
            {
                if (_isSuperMaximising)
                {
                    HideFullScreenPanel.IsHitTestVisible = false;
                    ShowFullScreenPanel.IsHitTestVisible = false;
                    ExitSuperMaximisedMode();
                }
                else
                {
                    HideFullScreenPanel.IsHitTestVisible = true;
                    ShowFullScreenPanel.IsHitTestVisible = true;
                    EnterSuperMaximisedMode();
                }
            }
        }

        public void ResetToStartupView()
        {
            if (DataContext is ShellViewModel mainViewModel)
            {
                ClearWindowCollection(mainViewModel);
                ClearTabItems(mainViewModel);

                var localhostServer = mainViewModel.LocalhostServer;
                if (localhostServer.IsConnected && !Equals(mainViewModel.ActiveServer, localhostServer))
                {
                    mainViewModel.SetActiveServer(localhostServer.EnvironmentID);
                    mainViewModel.SetActiveServer(localhostServer);
                }

                var explorerViewModel = mainViewModel.ExplorerViewModel;
                if (explorerViewModel != null)
                {
                    DisconnectAllServers(localhostServer, explorerViewModel);
                }

                if (mainViewModel.ToolboxViewModel != null)
                {
                    mainViewModel.ToolboxViewModel.SearchTerm = string.Empty;
                    Toolbox.Activate();
                    Toolboxcontrol.Focus();
                }
            }
        }

        static void DisconnectAllServers(Interfaces.IServer localhostServer, Interfaces.IExplorerViewModel explorerViewModel)
        {
            explorerViewModel.SearchText = string.Empty;

            DisconnectServers(localhostServer, explorerViewModel);

            var environmentViewModels = explorerViewModel.Environments;
            if (environmentViewModels?.Count > 1)
            {
                for (var i = 0; i < environmentViewModels.Count - 1; i++)
                {
                    var remoteEnvironment = environmentViewModels.FirstOrDefault(model => model.ResourceId != Guid.Empty);
                    environmentViewModels.Remove(remoteEnvironment);
                }
            }
        }

        static void DisconnectServers(Interfaces.IServer localhostServer, Interfaces.IExplorerViewModel explorerViewModel)
        {
            if (explorerViewModel.ConnectControlViewModel != null)
            {
                foreach (var server in explorerViewModel.ConnectControlViewModel.Servers)
                {
                    if (server != null && server.DisplayName != localhostServer.DisplayName && server.IsConnected)
                    {
                        server.Disconnect();
                    }
                }
            }
        }

        void ClearTabItems(ShellViewModel mainViewModel)
        {
            for (int i = TabManager.Items.Count - 1; i >= 0; i--)
            {
                var item = TabManager.Items[i];
                var contentPane = item as ContentPane;
                RemoveWorkspaceItems(contentPane, mainViewModel);
            }
            TabManager.Items.Clear();
        }

        static void ClearWindowCollection(ShellViewModel mainViewModel)
        {
            var windowCollection = System.Windows.Application.Current.Windows;
            foreach (var window in windowCollection)
            {
                if (window is Window window1 && window1.Name != "MainViewWindow")
                {
                    if (window1.GetType().Name == "ToolWindowHostWindow")
                    {
                        ClearWindowCollection(mainViewModel, window1);
                    }
                    window1.Close();
                }
            }
        }

        static void ClearWindowCollection(ShellViewModel mainViewModel, Window window1)
        {
            var contentPane = window1.Content as PaneToolWindow;
            foreach (var item in contentPane?.Pane?.Panes)
            {
                var pane = item as ContentPane;
                RemoveWorkspaceItems(pane, mainViewModel);
            }
        }

        static void RemoveWorkspaceItems(ContentPane pane, ShellViewModel shellViewModel)
        {
            var item1 = pane?.Content as WorkflowDesignerViewModel;
            if (item1?.ResourceModel != null)
            {
                WorkspaceItemRepository.Instance.ClearWorkspaceItems(item1.ResourceModel);
            }
            item1?.RemoveAllWorkflowName(item1.DisplayName);

            var workSurfaceContextViewModel = pane?.DataContext as WorkSurfaceContextViewModel;
            shellViewModel?.Items.Remove(workSurfaceContextViewModel);
        }

        void OnLoaded(object sender, RoutedEventArgs e)
        {
            var xmlDocument = new XmlDocument();
            if (_savedLayout != null)
            {
                try
                {
                    xmlDocument.LoadXml(_savedLayout);
                }
                catch (Exception err)
                {
                    File.Delete(FilePath);
                    Dev2Logger.Error("Unable to load layout", GlobalConstants.WarewolfError);
                    Dev2Logger.Error(err, GlobalConstants.WarewolfError);
                }
            }
            if (DataContext is ShellViewModel shellViewModel)
            {
                SetMenuExpanded(xmlDocument, shellViewModel);
                SetMenuPanelOpen(xmlDocument, shellViewModel);
                SetMenuPanelLockedOpen(xmlDocument, shellViewModel);
            }
            Toolbox.Activate();
            Toolboxcontrol.Focus();
        }

        static void SetMenuExpanded(XmlDocument xmlDocument, ShellViewModel shellViewModel)
        {
            var elementsByTagNameMenuExpanded = xmlDocument.GetElementsByTagName("MenuExpanded");
            if (elementsByTagNameMenuExpanded.Count > 0)
            {
                var menuExpandedString = elementsByTagNameMenuExpanded[0].InnerXml;

                if (bool.TryParse(menuExpandedString, out bool menuExpanded))
                {
                    shellViewModel.MenuExpanded = menuExpanded;
                }
            }
            else
            {
                shellViewModel.MenuExpanded = true;
            }
        }

        static void SetMenuPanelOpen(XmlDocument xmlDocument, ShellViewModel shellViewModel)
        {
            var elementsByTagNameMenuPanelOpen = xmlDocument.GetElementsByTagName("MenuPanelOpen");
            if (elementsByTagNameMenuPanelOpen.Count > 0)
            {
                var menuPanelOpenString = elementsByTagNameMenuPanelOpen[0].InnerXml;

                if (bool.TryParse(menuPanelOpenString, out bool panelOpen))
                {
                    shellViewModel.MenuViewModel.IsPanelOpen = panelOpen;
                }
            }
        }

        static void SetMenuPanelLockedOpen(XmlDocument xmlDocument, ShellViewModel shellViewModel)
        {
            var elementsByTagNameMenuPanelLockedOpen = xmlDocument.GetElementsByTagName("MenuPanelLockedOpen");
            if (elementsByTagNameMenuPanelLockedOpen.Count > 0)
            {
                var menuPanelLockedOpenString = elementsByTagNameMenuPanelLockedOpen[0].InnerXml;

                if (bool.TryParse(menuPanelLockedOpenString, out bool panelLockedOpen))
                {
                    shellViewModel.MenuViewModel.IsPanelLockedOpen = panelLockedOpen;
                }
            }
            else
            {
                shellViewModel.MenuViewModel.IsPanelLockedOpen = false;
            }
        }

        #region Implementation of IWin32Window

        public IntPtr Handle
        {
            get
            {
                var interopHelper = new WinInterop.WindowInteropHelper(this);
                return interopHelper.Handle;
            }
        }

        #endregion

        void MainView_OnClosing(object sender, CancelEventArgs e)
        {
            var shellViewModel = DataContext as ShellViewModel;
            if (shellViewModel != null)
            {
                if (!shellViewModel.OnStudioClosing())
                {
                    e.Cancel = true;
                }

                if (ShellViewModel.IsDownloading())
                {
                    e.Cancel = true;
                }
            }
            GetFilePath();
            SaveLayout(shellViewModel);
        }

        void SaveLayout(ShellViewModel shellViewModel)
        {
            var dockManagerLayout = DockManager.SaveLayout();
            var document = new XmlDocument();
            document.LoadXml(dockManagerLayout);
            var menuExpandedNode = document.CreateNode(XmlNodeType.Element, "MenuExpanded", document.NamespaceURI);
            menuExpandedNode.InnerXml = (shellViewModel != null && shellViewModel.MenuExpanded).ToString();

            var menuPanelOpenNode = document.CreateNode(XmlNodeType.Element, "MenuPanelOpen", document.NamespaceURI);
            menuPanelOpenNode.InnerXml = (shellViewModel != null && shellViewModel.MenuViewModel.IsPanelOpen).ToString();

            var menuPanelLockedOpenNode = document.CreateNode(XmlNodeType.Element, "MenuPanelLockedOpen", document.NamespaceURI);
            menuPanelLockedOpenNode.InnerXml =
                (shellViewModel != null && shellViewModel.MenuViewModel.IsPanelLockedOpen).ToString();

            if (document.DocumentElement != null)
            {
                document.DocumentElement.AppendChild(menuExpandedNode);
                document.DocumentElement.AppendChild(menuPanelOpenNode);
                document.DocumentElement.AppendChild(menuPanelLockedOpenNode);
            }
            using (FileStream fs = new FileStream(FilePath, FileMode.Create, FileAccess.Write))
            {
                document.Save(fs);
            }
        }

        void SlidingMenuPane_OnSizeChanged(object sender, SizeChangedEventArgs e)
        {
            if (DataContext is ShellViewModel vm)
            {
                vm.MenuPanelWidth = e.NewSize.Width;
            }
        }

        void TryDockManager_OnToolWindowLoaded(object sender, PaneToolWindowEventArgs e)
        {
            try
            {
                DockManager_OnToolWindowLoaded(sender, e);
            }
            catch (Exception ex)
            {
                Dev2Logger.Error(ex, GlobalConstants.WarewolfError);
            }
        }

        void DockManager_OnToolWindowLoaded(object sender, PaneToolWindowEventArgs e)
        {
            var window = e.Window;
            var resourceDictionary = System.Windows.Application.Current.Resources;
            if (resourceDictionary["WarewolfToolWindow"] is Style style)
            {
                window.UseOSNonClientArea = false;
                window.Style = style;
                window.PreviewMouseLeftButtonUp += WindowOnPreviewMouseDown;
            }

            if (e.Source.GetType() == typeof(XamDockManager))
            {
                var binding = Infragistics.Windows.Utilities.CreateBindingObject(DataContextProperty, BindingMode.OneWay, sender as XamDockManager);
                e.Window.SetBinding(DataContextProperty, binding);

                var shellViewModel = DataContext as ShellViewModel;
                PaneToolWindow = window;

                if (PaneToolWindow.Pane.Panes != null && PaneToolWindow.Pane.Panes.Count > 0)
                {
                    var workSurfaceContextViewModel = PaneToolWindow.Pane.Panes[0].DataContext as WorkSurfaceContextViewModel;
                    shellViewModel?.ActivateItem(workSurfaceContextViewModel);
                    PaneToolWindow.Name = "FloatingWindow";
                    if (string.IsNullOrWhiteSpace(e.Window.Title))
                    {
                        PaneToolWindow.Title = Title;
                    }
                    else
                    {
                        UpdatePaneToolWindow(sender);
                    }
                    if (workSurfaceContextViewModel?.ContextualResourceModel != null)
                    {
                        PaneToolWindow.ToolTip = "Floating window for - " + workSurfaceContextViewModel.ContextualResourceModel.DisplayName;
                    }
                }
            }
        }

        void UpdatePaneToolWindow(object sender)
        {
            var dockManager = sender as XamDockManager;
            var displayName = string.Empty;
            if (dockManager?.DataContext.GetType() == typeof(WorkflowDesignerViewModel))
            {
                var workflowDesignerViewModel = dockManager.DataContext as WorkflowDesignerViewModel;
                displayName = workflowDesignerViewModel?.DisplayName;
            }
            else if (dockManager?.DataContext.GetType() == typeof(StudioTestViewModel))
            {
                var studioTestViewModel = dockManager.DataContext as StudioTestViewModel;
                displayName = studioTestViewModel?.DisplayName;
            }
            else
            {
                if (dockManager?.DataContext.GetType() == typeof(SchedulerViewModel))
                {
                    var schedulerViewModel = dockManager.DataContext as SchedulerViewModel;
                    displayName = schedulerViewModel?.DisplayName;
                }
            }
            SetPaneToolWindowTitle(displayName);
        }

        void SetPaneToolWindowTitle(string displayName)
        {
            var title = PaneToolWindow.Title;
            var newTitle = " - " + displayName?.Replace("*", "").TrimEnd();
            if (!title.Contains(newTitle) && !string.IsNullOrWhiteSpace(displayName))
            {
                PaneToolWindow.Title = PaneToolWindow.Title + " - " + displayName;
            }
        }

        public PaneToolWindow PaneToolWindow { get; set; }

        void WindowOnPreviewMouseDown(object sender, MouseButtonEventArgs e)
        {
            try
            {
                if (DataContext is ShellViewModel shellViewModel)
                {
                    WindowOnPreviewMouseDown(sender, shellViewModel);
                }
            }
            catch (Exception ex)
            {
                Dev2Logger.Error(ex, GlobalConstants.WarewolfError);
            }
        }

        static void WindowOnPreviewMouseDown(object sender, ShellViewModel shellViewModel)
        {
            var paneToolWindow = sender as PaneToolWindow;
            if (paneToolWindow?.Pane?.Panes.Count > 0)
            {
                if (paneToolWindow.Pane.Panes[0] is ContentPane contentPane)
                {
                    var workSurfaceContextViewModel = contentPane.DataContext as WorkSurfaceContextViewModel;
                    shellViewModel.ActivateItem(workSurfaceContextViewModel);
                }
                else
                {
                    var tabGroupPane = paneToolWindow.Pane.Panes[0] as TabGroupPane;
                    if (tabGroupPane?.Items.Count >= 1)
                    {
                        var selectedContent = tabGroupPane.SelectedContent as ContentPane;
                        var workSurfaceContextViewModel = selectedContent?.DataContext as WorkSurfaceContextViewModel;
                        shellViewModel.ActivateItem(workSurfaceContextViewModel);
                    }
                }
            }
        }

        void EnterSuperMaximisedMode()
        {
            _isSuperMaximising = true;
            var dependencyObject = GetTemplateChild("PART_TITLEBAR");
            if (dependencyObject != null)
            {
                dependencyObject.SetValue(VisibilityProperty, Visibility.Collapsed);
                WindowState = WindowState.Normal;
                WindowState = WindowState.Maximized;
            }
        }

        void CloseSuperMaximised(object sender, RoutedEventArgs e)
        {
            ExitSuperMaximisedMode();
        }

        void ExitSuperMaximisedMode()
        {
            DoCloseExitFullScreenPanelAnimation();
            _isSuperMaximising = false;
            var dependencyObject = GetTemplateChild("PART_TITLEBAR");
            if (dependencyObject != null)
            {
                dependencyObject.SetValue(VisibilityProperty, Visibility.Visible);
                WindowState = WindowState.Normal;
                WindowState = WindowState.Maximized;
            }
        }

        void DoCloseExitFullScreenPanelAnimation()
        {
            var storyboard = Resources["AnimateExitFullScreenPanelClose"] as Storyboard;
            storyboard?.Begin();
        }

        void ShowFullScreenPanel_OnMouseEnter(object sender, System.Windows.Input.MouseEventArgs e)
        {
            if (_isSuperMaximising)
            {
                var storyboard = Resources["AnimateExitFullScreenPanelOpen"] as Storyboard;
                storyboard?.Begin();
            }
            if (!_isLocked)
            {
                DoAnimateOpenTitleBar();
            }
        }

        void DoAnimateOpenTitleBar()
        {
            if (Resources["AnimateOpenTitleBorder"] is Storyboard storyboard)
            {
                var titleBar = GetTemplateChild("PART_TITLEBAR");
                storyboard.SetValue(Storyboard.TargetProperty, titleBar);
                storyboard.Begin();
            }
        }

        void HideFullScreenPanel_OnMouseEnter(object sender, System.Windows.Input.MouseEventArgs e)
        {
            if (_isSuperMaximising)
            {
                DoCloseExitFullScreenPanelAnimation();
            }
            if (!_isLocked)
            {
                DoAnimateCloseTitle();
            }
        }

        void DoAnimateCloseTitle()
        {
            if (Resources["AnimateCloseTitleBorder"] is Storyboard storyboard)
            {
                var titleBar = GetTemplateChild("PART_TITLEBAR");
                storyboard.SetValue(Storyboard.TargetProperty, titleBar);
                storyboard.Begin();
            }
        }

        bool restoreIfMove;
        bool allowMaximizeState;

        void PART_TITLEBAR_MouseLeftButtonDown(object sender, MouseButtonEventArgs e)
        {
            if (e.ClickCount == 2)
            {
                SwitchState();
                ResizeMode = WindowState == WindowState.Normal ? ResizeMode.CanResize : ResizeMode.CanMinimize;
            }
            else
            {
                if (WindowState == WindowState.Maximized)
                {
                    restoreIfMove = true;
                }
                DragMove();
            }
        }

        void SwitchState()
        {
            switch (WindowState)
            {
                case WindowState.Normal:
                    {
                        WindowState = WindowState.Maximized;
                        break;
                    }
                case WindowState.Maximized:
                    {
                        WindowState = WindowState.Normal;
                        break;
                    }

                case WindowState.Minimized:
                    break;
                default:
                    WindowState = WindowState.Normal;
                    break;
            }
        }

        void PART_CLOSE_Click(object sender, RoutedEventArgs e)
        {
            Close();
        }

        void PART_MAXIMIZE_RESTORE_Click(object sender, RoutedEventArgs e)
        {
            ToggleWindowState();
        }

        void ToggleWindowState()
        {
            WindowState = WindowState == WindowState.Normal ? WindowState.Maximized : WindowState.Normal;
            ResizeMode = WindowState == WindowState.Normal ? ResizeMode.CanResize : ResizeMode.CanMinimize;
        }

        void PART_MINIMIZE_Click(object sender, RoutedEventArgs e)
        {
            WindowState = WindowState.Minimized;
        }

        void PART_SUPER_MAXIMIZE_RESTORE_Click(object sender, RoutedEventArgs e)
        {
            EnterSuperMaximisedMode();
        }

        void PART_LOCK_Click(object sender, RoutedEventArgs e)
        {
            var dependencyObject = GetTemplateChild("PART_LOCK");
            if (dependencyObject != null)
            {
                var fontAwesome = new FontAwesome.WPF.FontAwesome();
                if (_isLocked)
                {
                    HideFullScreenPanel.IsHitTestVisible = true;
                    ShowFullScreenPanel.IsHitTestVisible = true;
                    fontAwesome.Icon = FontAwesomeIcon.Unlock;
                    DoAnimateCloseTitle();
                }
                else
                {
                    fontAwesome.Icon = FontAwesomeIcon.Lock;
                }
                dependencyObject.SetValue(ContentProperty, fontAwesome);
                _isLocked = !_isLocked;
            }
        }

        void PART_TITLEBAR_OnMouseLeftButtonUp(object sender, MouseButtonEventArgs e)
        {
            restoreIfMove = false;
            allowMaximizeState = true;
        }

        [DllImport("user32.dll")]
        [return: MarshalAs(UnmanagedType.Bool)]
        static extern bool GetCursorPos(out Point lpPoint);
        void PART_TITLEBAR_OnMouseMove(object sender, System.Windows.Input.MouseEventArgs e)
        {
            try
            {
                if (restoreIfMove)
                {
                    restoreIfMove = false;

                    var percentHorizontal = e.GetPosition(this).X / ActualWidth;
                    var targetHorizontal = RestoreBounds.Width * percentHorizontal;

                    var percentVertical = e.GetPosition(this).Y / ActualHeight;
                    var targetVertical = RestoreBounds.Height * percentVertical;

                    WindowState = WindowState.Normal;
                    ResizeMode = WindowState == WindowState.Normal ? ResizeMode.CanResize : ResizeMode.CanMinimize;

                    GetCursorPos(out Point lMousePosition);

                    Left = lMousePosition.x - targetHorizontal;
                    Top = lMousePosition.y - targetVertical;

                    DragMove();
                    allowMaximizeState = true;
                }
                if (allowMaximizeState)
                {
                    GetCursorPos(out Point lMousePosition);

                    if (lMousePosition.y <= 0)
                    {
                        WindowState = WindowState.Maximized;
                    }
                }
            }
            catch (Exception)
            {
                // ignored
            }
        }

        void ContentDockManager_OnPaneDragEnded(object sender, PaneDragEndedEventArgs e)
        {
            if (e.Panes != null)
            {
                var tabGroupPane = e.Panes[0].Parent as TabGroupPane;
                var splitPane = tabGroupPane?.Parent as SplitPane;
                if (splitPane?.Parent is PaneToolWindow paneToolWindow && string.IsNullOrWhiteSpace(paneToolWindow.Title))
                {
                    paneToolWindow.Title = Title;
                }

            }
        }

        void MainViewWindow_Closed(object sender, EventArgs e)
        {
            foreach (Process proc in Process.GetProcessesByName("Warewolf Studio"))
            {
                Dev2Logger.Warn(proc.ProcessName + " still running in the background.", "Warewolf Warn");
            }
        }
    }
}
---- Transformed Tree ----
using System;
using System.ComponentModel;
using System.Diagnostics;
using System.IO;
using System.Linq;
using System.Runtime.InteropServices;
using System.Windows;
using System.Windows.Data;
using System.Windows.Forms;
using System.Windows.Input;
using System.Windows.Media.Animation;
using System.Xml;
using Dev2.Common;
using Dev2.Triggers.Scheduler;
using Dev2.Studio.ViewModels;
using FontAwesome.WPF;
using Infragistics.Windows.DockManager.Events;
using WinInterop = System.Windows.Interop;
using Dev2.Studio.Core;
using Dev2.Studio.ViewModels.Workflow;
using Dev2.Studio.ViewModels.WorkSurface;
using Dev2.ViewModels;
using Dev2.Workspaces;
using Infragistics.Windows.DockManager;
using Dev2.Triggers.Scheduler;

namespace Dev2.Studio.Views
{
    public partial class ShellView : IWin32Window
    {
        static bool _isSuperMaximising;
        bool _isLocked;
        readonly string _savedLayout;
        static ShellView _this;

        #region Constructor

        public static ShellView GetInstance() => _this;

        public ShellView()
        {
            InitializeComponent();
            _isLocked = true;
            HideFullScreenPanel.IsHitTestVisible = false;
            ShowFullScreenPanel.IsHitTestVisible = false;
            Loaded += OnLoaded;
            KeyDown += Shell_KeyDown;
            SourceInitialized += WinSourceInitialized;

            if (File.Exists(FilePath))
            {
                GetFilePath();
                using (FileStream fs = new FileStream(FilePath, FileMode.Open, FileAccess.Read))
                {
                    var streamReader = new StreamReader(fs);
                    _savedLayout = streamReader.ReadToEnd();
                }
                if (!string.IsNullOrEmpty(_savedLayout))
                {
                    try
                    {
                        DockManager.LoadLayout(_savedLayout);
                    }
                    catch (Exception err)
                    {
                        _savedLayout = null;
                        File.Delete(FilePath);
                        Dev2Logger.Error("Unable to load layout", GlobalConstants.WarewolfError);
                        Dev2Logger.Error(err, GlobalConstants.WarewolfError);
                    }
                }
            }

#pragma warning disable S3010 // For testing (Studio reset shortcut)
            _this = this;
#pragma warning restore S3010
        }

        string FilePath => Path.Combine(new[]
        {
            Environment.GetFolderPath(Environment.SpecialFolder.LocalApplicationData),
            StringResources.App_Data_Directory,
            StringResources.User_Interface_Layouts_Directory,
            "WorkspaceLayout.xml"
        });

        void GetFilePath()
        {
            if (!File.Exists(FilePath))
            {
                var fileInfo = new FileInfo(FilePath);
                if (fileInfo.Directory != null)
                {
                    var finalDirectoryPath = fileInfo.Directory.FullName;

                    if (!Directory.Exists(finalDirectoryPath))
                    {
                        Directory.CreateDirectory(finalDirectoryPath);
                    }
                }
            }
        }

        #endregion Constructor

        void WinSourceInitialized(object sender, EventArgs e)
        {
            Maximise();
        }

        void Maximise()
        {
            var handle = new WinInterop.WindowInteropHelper(this).Handle;
            var handleSource = WinInterop.HwndSource.FromHwnd(handle);
            handleSource?.AddHook(WindowProc);
        }

        static IntPtr WindowProc(IntPtr hwnd, int msg, IntPtr wParam, IntPtr lParam, ref bool handled)
        {
            if (msg == 0x0024 && !_isSuperMaximising)
            {
                WmGetMinMaxInfo(hwnd, lParam);
                handled = true;
            }
            return (IntPtr)0;
        }

        static void WmGetMinMaxInfo(IntPtr hwnd, IntPtr lParam)
        {
            var mmi = (Minmaxinfo)Marshal.PtrToStructure(lParam, typeof(Minmaxinfo));

            // Adjust the maximized size and position to fit the work area of the correct monitor
            var currentScreen = Screen.FromHandle(hwnd);
            var workArea = currentScreen.WorkingArea;
            var monitorArea = currentScreen.Bounds;
            mmi.ptMaxPosition.x = Math.Abs(workArea.Left - monitorArea.Left);
            mmi.ptMaxPosition.y = Math.Abs(workArea.Top - monitorArea.Top);
            mmi.ptMaxSize.x = Math.Abs(workArea.Right - workArea.Left);
            mmi.ptMaxSize.y = Math.Abs(workArea.Bottom - workArea.Top);

            Marshal.StructureToPtr(mmi, lParam, true);
        }

        [StructLayout(LayoutKind.Sequential)]

        public struct Minmaxinfo
        {
            public Point ptReserved;
            public Point ptMaxSize;
            public Point ptMaxPosition;
            public Point ptMinTrackSize;
            public Point ptMaxTrackSize;
        };

        [StructLayout(LayoutKind.Sequential)]
        public struct Point
        {
            /// <summary>
            /// x coordinate of point.
            /// </summary>
            public int x;

            /// <summary>
            /// y coordinate of point.
            /// </summary>
            public int y;

            /// <summary>
            /// Construct a point of coordinates (x,y).
            /// </summary>
            public Point(int x, int y)
            {
                this.x = x;
                this.y = y;
            }
        }

        void Shell_KeyDown(object sender, System.Windows.Input.KeyEventArgs e)
        {
            if ((Keyboard.Modifiers == (ModifierKeys.Alt | ModifierKeys.Control)) && (e.Key == Key.F4))
            {
                ResetToStartupView();
            }
            if (e.Key == Key.Home && (Keyboard.Modifiers & ModifierKeys.Control) == ModifierKeys.Control)
            {
                var shellViewModel = DataContext as ShellViewModel;
                shellViewModel?.MergeCommand.Execute(null);
            }
            if (e.Key == Key.F1)
            {
                Process.Start(Warewolf.Studio.Resources.Languages.HelpText.WarewolfHelpURL);
            }
            if (e.Key == Key.F11 && _isLocked)
            {
                if (_isSuperMaximising)
                {
                    HideFullScreenPanel.IsHitTestVisible = false;
                    ShowFullScreenPanel.IsHitTestVisible = false;
                    ExitSuperMaximisedMode();
                }
                else
                {
                    HideFullScreenPanel.IsHitTestVisible = true;
                    ShowFullScreenPanel.IsHitTestVisible = true;
                    EnterSuperMaximisedMode();
                }
            }
        }

        public void ResetToStartupView()
        {
            if (DataContext is ShellViewModel mainViewModel)
            {
                ClearWindowCollection(mainViewModel);
                ClearTabItems(mainViewModel);

                var localhostServer = mainViewModel.LocalhostServer;
                if (localhostServer.IsConnected && !Equals(mainViewModel.ActiveServer, localhostServer))
                {
                    mainViewModel.SetActiveServer(localhostServer.EnvironmentID);
                    mainViewModel.SetActiveServer(localhostServer);
                }

                var explorerViewModel = mainViewModel.ExplorerViewModel;
                if (explorerViewModel != null)
                {
                    DisconnectAllServers(localhostServer, explorerViewModel);
                }

                if (mainViewModel.ToolboxViewModel != null)
                {
                    mainViewModel.ToolboxViewModel.SearchTerm = string.Empty;
                    Toolbox.Activate();
                    Toolboxcontrol.Focus();
                }
            }
        }

        static void DisconnectAllServers(Interfaces.IServer localhostServer, Interfaces.IExplorerViewModel explorerViewModel)
        {
            explorerViewModel.SearchText = string.Empty;

            DisconnectServers(localhostServer, explorerViewModel);

            var environmentViewModels = explorerViewModel.Environments;
            if (environmentViewModels?.Count > 1)
            {
                for (var i = 0; i < environmentViewModels.Count - 1; i++)
                {
                    var remoteEnvironment = environmentViewModels.FirstOrDefault(model => model.ResourceId != Guid.Empty);
                    environmentViewModels.Remove(remoteEnvironment);
                }
            }
        }

        static void DisconnectServers(Interfaces.IServer localhostServer, Interfaces.IExplorerViewModel explorerViewModel)
        {
            if (explorerViewModel.ConnectControlViewModel != null)
            {
                foreach (var server in explorerViewModel.ConnectControlViewModel.Servers)
                {
                    if (server != null && server.DisplayName != localhostServer.DisplayName && server.IsConnected)
                    {
                        server.Disconnect();
                    }
                }
            }
        }

        void ClearTabItems(ShellViewModel mainViewModel)
        {
            for (int i = TabManager.Items.Count - 1; i >= 0; i--)
            {
                var item = TabManager.Items[i];
                var contentPane = item as ContentPane;
                RemoveWorkspaceItems(contentPane, mainViewModel);
            }
            TabManager.Items.Clear();
        }

        static void ClearWindowCollection(ShellViewModel mainViewModel)
        {
            var windowCollection = System.Windows.Application.Current.Windows;
            foreach (var window in windowCollection)
            {
                if (window is Window window1 && window1.Name != "MainViewWindow")
                {
                    if (window1.GetType().Name == "ToolWindowHostWindow")
                    {
                        ClearWindowCollection(mainViewModel, window1);
                    }
                    window1.Close();
                }
            }
        }

        static void ClearWindowCollection(ShellViewModel mainViewModel, Window window1)
        {
            var contentPane = window1.Content as PaneToolWindow;
            foreach (var item in contentPane?.Pane?.Panes)
            {
                var pane = item as ContentPane;
                RemoveWorkspaceItems(pane, mainViewModel);
            }
        }

        static void RemoveWorkspaceItems(ContentPane pane, ShellViewModel shellViewModel)
        {
            var item1 = pane?.Content as WorkflowDesignerViewModel;
            if (item1?.ResourceModel != null)
            {
                WorkspaceItemRepository.Instance.ClearWorkspaceItems(item1.ResourceModel);
            }
            item1?.RemoveAllWorkflowName(item1.DisplayName);

            var workSurfaceContextViewModel = pane?.DataContext as WorkSurfaceContextViewModel;
            shellViewModel?.Items.Remove(workSurfaceContextViewModel);
        }

        void OnLoaded(object sender, RoutedEventArgs e)
        {
            var xmlDocument = new XmlDocument();
            if (_savedLayout != null)
            {
                try
                {
                    xmlDocument.LoadXml(_savedLayout);
                }
                catch (Exception err)
                {
                    File.Delete(FilePath);
                    Dev2Logger.Error("Unable to load layout", GlobalConstants.WarewolfError);
                    Dev2Logger.Error(err, GlobalConstants.WarewolfError);
                }
            }
            if (DataContext is ShellViewModel shellViewModel)
            {
                SetMenuExpanded(xmlDocument, shellViewModel);
                SetMenuPanelOpen(xmlDocument, shellViewModel);
                SetMenuPanelLockedOpen(xmlDocument, shellViewModel);
            }
            Toolbox.Activate();
            Toolboxcontrol.Focus();
        }

        static void SetMenuExpanded(XmlDocument xmlDocument, ShellViewModel shellViewModel)
        {
            var elementsByTagNameMenuExpanded = xmlDocument.GetElementsByTagName("MenuExpanded");
            if (elementsByTagNameMenuExpanded.Count > 0)
            {
                var menuExpandedString = elementsByTagNameMenuExpanded[0].InnerXml;

                if (bool.TryParse(menuExpandedString, out bool menuExpanded))
                {
                    shellViewModel.MenuExpanded = menuExpanded;
                }
            }
            else
            {
                shellViewModel.MenuExpanded = true;
            }
        }

        static void SetMenuPanelOpen(XmlDocument xmlDocument, ShellViewModel shellViewModel)
        {
            var elementsByTagNameMenuPanelOpen = xmlDocument.GetElementsByTagName("MenuPanelOpen");
            if (elementsByTagNameMenuPanelOpen.Count > 0)
            {
                var menuPanelOpenString = elementsByTagNameMenuPanelOpen[0].InnerXml;

                if (bool.TryParse(menuPanelOpenString, out bool panelOpen))
                {
                    shellViewModel.MenuViewModel.IsPanelOpen = panelOpen;
                }
            }
        }

        static void SetMenuPanelLockedOpen(XmlDocument xmlDocument, ShellViewModel shellViewModel)
        {
            var elementsByTagNameMenuPanelLockedOpen = xmlDocument.GetElementsByTagName("MenuPanelLockedOpen");
            if (elementsByTagNameMenuPanelLockedOpen.Count > 0)
            {
                var menuPanelLockedOpenString = elementsByTagNameMenuPanelLockedOpen[0].InnerXml;

                if (bool.TryParse(menuPanelLockedOpenString, out bool panelLockedOpen))
                {
                    shellViewModel.MenuViewModel.IsPanelLockedOpen = panelLockedOpen;
                }
            }
            else
            {
                shellViewModel.MenuViewModel.IsPanelLockedOpen = false;
            }
        }

        #region Implementation of IWin32Window

        public IntPtr Handle
        {
            get
            {
                var interopHelper = new WinInterop.WindowInteropHelper(this);
                return interopHelper.Handle;
            }
        }

        #endregion

        void MainView_OnClosing(object sender, CancelEventArgs e)
        {
            if (DataContext is ShellViewModel shellViewModel)
            {
                if (!shellViewModel.OnStudioClosing())
                {
                    e.Cancel = true;
                }

                if (ShellViewModel.IsDownloading())
                {
                    e.Cancel = true;
                }
            }
            GetFilePath();
            SaveLayout(shellViewModel);
        }

        void SaveLayout(ShellViewModel shellViewModel)
        {
            var dockManagerLayout = DockManager.SaveLayout();
            var document = new XmlDocument();
            document.LoadXml(dockManagerLayout);
            var menuExpandedNode = document.CreateNode(XmlNodeType.Element, "MenuExpanded", document.NamespaceURI);
            menuExpandedNode.InnerXml = (shellViewModel != null && shellViewModel.MenuExpanded).ToString();

            var menuPanelOpenNode = document.CreateNode(XmlNodeType.Element, "MenuPanelOpen", document.NamespaceURI);
            menuPanelOpenNode.InnerXml = (shellViewModel != null && shellViewModel.MenuViewModel.IsPanelOpen).ToString();

            var menuPanelLockedOpenNode = document.CreateNode(XmlNodeType.Element, "MenuPanelLockedOpen", document.NamespaceURI);
            menuPanelLockedOpenNode.InnerXml =
                (shellViewModel != null && shellViewModel.MenuViewModel.IsPanelLockedOpen).ToString();

            if (document.DocumentElement != null)
            {
                document.DocumentElement.AppendChild(menuExpandedNode);
                document.DocumentElement.AppendChild(menuPanelOpenNode);
                document.DocumentElement.AppendChild(menuPanelLockedOpenNode);
            }
            using (FileStream fs = new FileStream(FilePath, FileMode.Create, FileAccess.Write))
            {
                document.Save(fs);
            }
        }

        void SlidingMenuPane_OnSizeChanged(object sender, SizeChangedEventArgs e)
        {
            if (DataContext is ShellViewModel vm)
            {
                vm.MenuPanelWidth = e.NewSize.Width;
            }
        }

        void TryDockManager_OnToolWindowLoaded(object sender, PaneToolWindowEventArgs e)
        {
            try
            {
                DockManager_OnToolWindowLoaded(sender, e);
            }
            catch (Exception ex)
            {
                Dev2Logger.Error(ex, GlobalConstants.WarewolfError);
            }
        }

        void DockManager_OnToolWindowLoaded(object sender, PaneToolWindowEventArgs e)
        {
            var window = e.Window;
            var resourceDictionary = System.Windows.Application.Current.Resources;
            if (resourceDictionary["WarewolfToolWindow"] is Style style)
            {
                window.UseOSNonClientArea = false;
                window.Style = style;
                window.PreviewMouseLeftButtonUp += WindowOnPreviewMouseDown;
            }

            if (e.Source.GetType() == typeof(XamDockManager))
            {
                var binding = Infragistics.Windows.Utilities.CreateBindingObject(DataContextProperty, BindingMode.OneWay, sender as XamDockManager);
                e.Window.SetBinding(DataContextProperty, binding);

                var shellViewModel = DataContext as ShellViewModel;
                PaneToolWindow = window;

                if (PaneToolWindow.Pane.Panes != null && PaneToolWindow.Pane.Panes.Count > 0)
                {
                    var workSurfaceContextViewModel = PaneToolWindow.Pane.Panes[0].DataContext as WorkSurfaceContextViewModel;
                    shellViewModel?.ActivateItem(workSurfaceContextViewModel);
                    PaneToolWindow.Name = "FloatingWindow";
                    if (string.IsNullOrWhiteSpace(e.Window.Title))
                    {
                        PaneToolWindow.Title = Title;
                    }
                    else
                    {
                        UpdatePaneToolWindow(sender);
                    }
                    if (workSurfaceContextViewModel?.ContextualResourceModel != null)
                    {
                        PaneToolWindow.ToolTip = "Floating window for - " + workSurfaceContextViewModel.ContextualResourceModel.DisplayName;
                    }
                }
            }
        }

        void UpdatePaneToolWindow(object sender)
        {
            var dockManager = sender as XamDockManager;
            var displayName = string.Empty;
            if (dockManager?.DataContext.GetType() == typeof(WorkflowDesignerViewModel))
            {
                var workflowDesignerViewModel = dockManager.DataContext as WorkflowDesignerViewModel;
                displayName = workflowDesignerViewModel?.DisplayName;
            }
            else if (dockManager?.DataContext.GetType() == typeof(StudioTestViewModel))
            {
                var studioTestViewModel = dockManager.DataContext as StudioTestViewModel;
                displayName = studioTestViewModel?.DisplayName;
            }
            else
            {
                if (dockManager?.DataContext.GetType() == typeof(SchedulerViewModel))
                {
                    var schedulerViewModel = dockManager.DataContext as SchedulerViewModel;
                    displayName = schedulerViewModel?.DisplayName;
                }
            }
            SetPaneToolWindowTitle(displayName);
        }

        void SetPaneToolWindowTitle(string displayName)
        {
            var title = PaneToolWindow.Title;
            var newTitle = " - " + displayName?.Replace("*", "").TrimEnd();
            if (!title.Contains(newTitle) && !string.IsNullOrWhiteSpace(displayName))
            {
                PaneToolWindow.Title = PaneToolWindow.Title + " - " + displayName;
            }
        }

        public PaneToolWindow PaneToolWindow { get; set; }

        void WindowOnPreviewMouseDown(object sender, MouseButtonEventArgs e)
        {
            try
            {
                if (DataContext is ShellViewModel shellViewModel)
                {
                    WindowOnPreviewMouseDown(sender, shellViewModel);
                }
            }
            catch (Exception ex)
            {
                Dev2Logger.Error(ex, GlobalConstants.WarewolfError);
            }
        }

        static void WindowOnPreviewMouseDown(object sender, ShellViewModel shellViewModel)
        {
            var paneToolWindow = sender as PaneToolWindow;
            if (paneToolWindow?.Pane?.Panes.Count > 0)
            {
                if (paneToolWindow.Pane.Panes[0] is ContentPane contentPane)
                {
                    var workSurfaceContextViewModel = contentPane.DataContext as WorkSurfaceContextViewModel;
                    shellViewModel.ActivateItem(workSurfaceContextViewModel);
                }
                else
                {
                    var tabGroupPane = paneToolWindow.Pane.Panes[0] as TabGroupPane;
                    if (tabGroupPane?.Items.Count >= 1)
                    {
                        var selectedContent = tabGroupPane.SelectedContent as ContentPane;
                        var workSurfaceContextViewModel = selectedContent?.DataContext as WorkSurfaceContextViewModel;
                        shellViewModel.ActivateItem(workSurfaceContextViewModel);
                    }
                }
            }
        }

        void EnterSuperMaximisedMode()
        {
            _isSuperMaximising = true;
            var dependencyObject = GetTemplateChild("PART_TITLEBAR");
            if (dependencyObject != null)
            {
                dependencyObject.SetValue(VisibilityProperty, Visibility.Collapsed);
                WindowState = WindowState.Normal;
                WindowState = WindowState.Maximized;
            }
        }

        void CloseSuperMaximised(object sender, RoutedEventArgs e)
        {
            ExitSuperMaximisedMode();
        }

        void ExitSuperMaximisedMode()
        {
            DoCloseExitFullScreenPanelAnimation();
            _isSuperMaximising = false;
            var dependencyObject = GetTemplateChild("PART_TITLEBAR");
            if (dependencyObject != null)
            {
                dependencyObject.SetValue(VisibilityProperty, Visibility.Visible);
                WindowState = WindowState.Normal;
                WindowState = WindowState.Maximized;
            }
        }

        void DoCloseExitFullScreenPanelAnimation()
        {
            var storyboard = Resources["AnimateExitFullScreenPanelClose"] as Storyboard;
            storyboard?.Begin();
        }

        void ShowFullScreenPanel_OnMouseEnter(object sender, System.Windows.Input.MouseEventArgs e)
        {
            if (_isSuperMaximising)
            {
                var storyboard = Resources["AnimateExitFullScreenPanelOpen"] as Storyboard;
                storyboard?.Begin();
            }
            if (!_isLocked)
            {
                DoAnimateOpenTitleBar();
            }
        }

        void DoAnimateOpenTitleBar()
        {
            if (Resources["AnimateOpenTitleBorder"] is Storyboard storyboard)
            {
                var titleBar = GetTemplateChild("PART_TITLEBAR");
                storyboard.SetValue(Storyboard.TargetProperty, titleBar);
                storyboard.Begin();
            }
        }

        void HideFullScreenPanel_OnMouseEnter(object sender, System.Windows.Input.MouseEventArgs e)
        {
            if (_isSuperMaximising)
            {
                DoCloseExitFullScreenPanelAnimation();
            }
            if (!_isLocked)
            {
                DoAnimateCloseTitle();
            }
        }

        void DoAnimateCloseTitle()
        {
            if (Resources["AnimateCloseTitleBorder"] is Storyboard storyboard)
            {
                var titleBar = GetTemplateChild("PART_TITLEBAR");
                storyboard.SetValue(Storyboard.TargetProperty, titleBar);
                storyboard.Begin();
            }
        }

        bool restoreIfMove;
        bool allowMaximizeState;

        void PART_TITLEBAR_MouseLeftButtonDown(object sender, MouseButtonEventArgs e)
        {
            if (e.ClickCount == 2)
            {
                SwitchState();
                ResizeMode = WindowState == WindowState.Normal ? ResizeMode.CanResize : ResizeMode.CanMinimize;
            }
            else
            {
                if (WindowState == WindowState.Maximized)
                {
                    restoreIfMove = true;
                }
                DragMove();
            }
        }

        void SwitchState()
        {
            switch (WindowState)
            {
                case WindowState.Normal:
                    {
                        WindowState = WindowState.Maximized;
                        break;
                    }
                case WindowState.Maximized:
                    {
                        WindowState = WindowState.Normal;
                        break;
                    }

                case WindowState.Minimized:
                    break;
                default:
                    WindowState = WindowState.Normal;
                    break;
            }
        }

        void PART_CLOSE_Click(object sender, RoutedEventArgs e)
        {
            Close();
        }

        void PART_MAXIMIZE_RESTORE_Click(object sender, RoutedEventArgs e)
        {
            ToggleWindowState();
        }

        void ToggleWindowState()
        {
            WindowState = WindowState == WindowState.Normal ? WindowState.Maximized : WindowState.Normal;
            ResizeMode = WindowState == WindowState.Normal ? ResizeMode.CanResize : ResizeMode.CanMinimize;
        }

        void PART_MINIMIZE_Click(object sender, RoutedEventArgs e)
        {
            WindowState = WindowState.Minimized;
        }

        void PART_SUPER_MAXIMIZE_RESTORE_Click(object sender, RoutedEventArgs e)
        {
            EnterSuperMaximisedMode();
        }

        void PART_LOCK_Click(object sender, RoutedEventArgs e)
        {
            var dependencyObject = GetTemplateChild("PART_LOCK");
            if (dependencyObject != null)
            {
                var fontAwesome = new FontAwesome.WPF.FontAwesome();
                if (_isLocked)
                {
                    HideFullScreenPanel.IsHitTestVisible = true;
                    ShowFullScreenPanel.IsHitTestVisible = true;
                    fontAwesome.Icon = FontAwesomeIcon.Unlock;
                    DoAnimateCloseTitle();
                }
                else
                {
                    fontAwesome.Icon = FontAwesomeIcon.Lock;
                }
                dependencyObject.SetValue(ContentProperty, fontAwesome);
                _isLocked = !_isLocked;
            }
        }

        void PART_TITLEBAR_OnMouseLeftButtonUp(object sender, MouseButtonEventArgs e)
        {
            restoreIfMove = false;
            allowMaximizeState = true;
        }

        [DllImport("user32.dll")]
        [return: MarshalAs(UnmanagedType.Bool)]
        static extern bool GetCursorPos(out Point lpPoint);
        void PART_TITLEBAR_OnMouseMove(object sender, System.Windows.Input.MouseEventArgs e)
        {
            try
            {
                if (restoreIfMove)
                {
                    restoreIfMove = false;

                    var percentHorizontal = e.GetPosition(this).X / ActualWidth;
                    var targetHorizontal = RestoreBounds.Width * percentHorizontal;

                    var percentVertical = e.GetPosition(this).Y / ActualHeight;
                    var targetVertical = RestoreBounds.Height * percentVertical;

                    WindowState = WindowState.Normal;
                    ResizeMode = WindowState == WindowState.Normal ? ResizeMode.CanResize : ResizeMode.CanMinimize;

                    GetCursorPos(out Point lMousePosition);

                    Left = lMousePosition.x - targetHorizontal;
                    Top = lMousePosition.y - targetVertical;

                    DragMove();
                    allowMaximizeState = true;
                }
                if (allowMaximizeState)
                {
                    GetCursorPos(out Point lMousePosition);

                    if (lMousePosition.y <= 0)
                    {
                        WindowState = WindowState.Maximized;
                    }
                }
            }
            catch (Exception)
            {
                // ignored
            }
        }

        void ContentDockManager_OnPaneDragEnded(object sender, PaneDragEndedEventArgs e)
        {
            if (e.Panes != null)
            {
                var tabGroupPane = e.Panes[0].Parent as TabGroupPane;
                var splitPane = tabGroupPane?.Parent as SplitPane;
                if (splitPane?.Parent is PaneToolWindow paneToolWindow && string.IsNullOrWhiteSpace(paneToolWindow.Title))
                {
                    paneToolWindow.Title = Title;
                }

            }
        }

        void MainViewWindow_Closed(object sender, EventArgs e)
        {
            foreach (Process proc in Process.GetProcessesByName("Warewolf Studio"))
            {
                Dev2Logger.Warn(proc.ProcessName + " still running in the background.", "Warewolf Warn");
            }
        }
    }
}
---- Semantic diagnostics *before* transformation ----
D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(53,13): error CS0103: The name 'InitializeComponent' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(55,13): error CS0103: The name 'HideFullScreenPanel' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(56,13): error CS0103: The name 'ShowFullScreenPanel' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(57,13): error CS0103: The name 'Loaded' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(58,13): error CS0103: The name 'KeyDown' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(59,13): error CS0103: The name 'SourceInitialized' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(73,25): error CS0103: The name 'DockManager' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(124,61): error CS1503: Argument 1: cannot convert from 'Dev2.Studio.Views.ShellView' to 'System.Windows.Window',D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(197,38): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(208,21): error CS0103: The name 'HideFullScreenPanel' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(209,21): error CS0103: The name 'ShowFullScreenPanel' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(214,21): error CS0103: The name 'HideFullScreenPanel' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(215,21): error CS0103: The name 'ShowFullScreenPanel' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(223,17): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(244,21): error CS0103: The name 'Toolbox' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(245,21): error CS0103: The name 'Toolboxcontrol' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(283,26): error CS0103: The name 'TabManager' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(285,28): error CS0103: The name 'TabManager' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(289,13): error CS0103: The name 'TabManager' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(347,17): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(353,13): error CS0103: The name 'Toolbox' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(354,13): error CS0103: The name 'Toolboxcontrol' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(413,72): error CS1503: Argument 1: cannot convert from 'Dev2.Studio.Views.ShellView' to 'System.Windows.Window',D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(422,34): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(441,37): error CS0103: The name 'DockManager' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(468,17): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(499,82): error CS0103: The name 'DataContextProperty' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(500,37): error CS0103: The name 'DataContextProperty' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(502,38): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(512,48): error CS0103: The name 'Title' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(567,21): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(604,36): error CS0103: The name 'GetTemplateChild' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(607,43): error CS0103: The name 'VisibilityProperty' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(608,17): error CS0118: 'WindowState' is a type but is used like a variable,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(609,17): error CS0118: 'WindowState' is a type but is used like a variable,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(622,36): error CS0103: The name 'GetTemplateChild' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(625,43): error CS0103: The name 'VisibilityProperty' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(626,17): error CS0118: 'WindowState' is a type but is used like a variable,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(627,17): error CS0118: 'WindowState' is a type but is used like a variable,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(633,30): error CS0119: 'Resources' is a type, which is not valid in the given context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(641,34): error CS0119: 'Resources' is a type, which is not valid in the given context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(652,17): error CS0119: 'Resources' is a type, which is not valid in the given context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(654,32): error CS0103: The name 'GetTemplateChild' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(674,17): error CS0119: 'Resources' is a type, which is not valid in the given context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(676,32): error CS0103: The name 'GetTemplateChild' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(690,17): error CS0118: 'ResizeMode' is a type but is used like a variable,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(690,30): error CS0119: 'WindowState' is a type, which is not valid in the given context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(694,21): error CS0119: 'WindowState' is a type, which is not valid in the given context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(698,17): error CS0103: The name 'DragMove' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(704,21): error CS0119: 'WindowState' is a type, which is not valid in the given context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(708,25): error CS0118: 'WindowState' is a type but is used like a variable,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(713,25): error CS0118: 'WindowState' is a type but is used like a variable,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(720,21): error CS0118: 'WindowState' is a type but is used like a variable,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(727,13): error CS0103: The name 'Close' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(737,13): error CS0118: 'WindowState' is a type but is used like a variable,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(737,27): error CS0119: 'WindowState' is a type, which is not valid in the given context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(738,13): error CS0118: 'ResizeMode' is a type but is used like a variable,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(738,26): error CS0119: 'WindowState' is a type, which is not valid in the given context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(743,13): error CS0118: 'WindowState' is a type but is used like a variable,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(753,36): error CS0103: The name 'GetTemplateChild' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(759,21): error CS0103: The name 'HideFullScreenPanel' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(760,21): error CS0103: The name 'ShowFullScreenPanel' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(768,43): error CS0103: The name 'ContentProperty' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(790,59): error CS1503: Argument 1: cannot convert from 'Dev2.Studio.Views.ShellView' to 'System.Windows.IInputElement',D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(790,69): error CS0103: The name 'ActualWidth' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(791,44): error CS0103: The name 'RestoreBounds' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(793,57): error CS1503: Argument 1: cannot convert from 'Dev2.Studio.Views.ShellView' to 'System.Windows.IInputElement',D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(793,67): error CS0103: The name 'ActualHeight' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(794,42): error CS0103: The name 'RestoreBounds' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(796,21): error CS0118: 'WindowState' is a type but is used like a variable,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(797,21): error CS0118: 'ResizeMode' is a type but is used like a variable,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(797,34): error CS0119: 'WindowState' is a type, which is not valid in the given context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(801,21): error CS0103: The name 'Left' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(802,21): error CS0103: The name 'Top' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(804,21): error CS0103: The name 'DragMove' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(813,25): error CS0118: 'WindowState' is a type but is used like a variable,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(831,44): error CS0103: The name 'Title' does not exist in the current context
---- Semantic diagnostics *after* transformation ----
D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(53,13): error CS0103: The name 'InitializeComponent' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(55,13): error CS0103: The name 'HideFullScreenPanel' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(56,13): error CS0103: The name 'ShowFullScreenPanel' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(57,13): error CS0103: The name 'Loaded' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(58,13): error CS0103: The name 'KeyDown' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(59,13): error CS0103: The name 'SourceInitialized' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(73,25): error CS0103: The name 'DockManager' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(124,61): error CS1503: Argument 1: cannot convert from 'Dev2.Studio.Views.ShellView' to 'System.Windows.Window',D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(197,38): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(208,21): error CS0103: The name 'HideFullScreenPanel' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(209,21): error CS0103: The name 'ShowFullScreenPanel' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(214,21): error CS0103: The name 'HideFullScreenPanel' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(215,21): error CS0103: The name 'ShowFullScreenPanel' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(223,17): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(244,21): error CS0103: The name 'Toolbox' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(245,21): error CS0103: The name 'Toolboxcontrol' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(283,26): error CS0103: The name 'TabManager' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(285,28): error CS0103: The name 'TabManager' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(289,13): error CS0103: The name 'TabManager' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(347,17): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(353,13): error CS0103: The name 'Toolbox' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(354,13): error CS0103: The name 'Toolboxcontrol' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(413,72): error CS1503: Argument 1: cannot convert from 'Dev2.Studio.Views.ShellView' to 'System.Windows.Window',D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(422,17): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(435,24): error CS0165: Use of unassigned local variable 'shellViewModel',D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(440,37): error CS0103: The name 'DockManager' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(467,17): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(498,82): error CS0103: The name 'DataContextProperty' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(499,37): error CS0103: The name 'DataContextProperty' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(501,38): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(511,48): error CS0103: The name 'Title' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(566,21): error CS0103: The name 'DataContext' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(603,36): error CS0103: The name 'GetTemplateChild' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(606,43): error CS0103: The name 'VisibilityProperty' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(607,17): error CS0118: 'WindowState' is a type but is used like a variable,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(608,17): error CS0118: 'WindowState' is a type but is used like a variable,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(621,36): error CS0103: The name 'GetTemplateChild' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(624,43): error CS0103: The name 'VisibilityProperty' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(625,17): error CS0118: 'WindowState' is a type but is used like a variable,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(626,17): error CS0118: 'WindowState' is a type but is used like a variable,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(632,30): error CS0119: 'Resources' is a type, which is not valid in the given context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(640,34): error CS0119: 'Resources' is a type, which is not valid in the given context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(651,17): error CS0119: 'Resources' is a type, which is not valid in the given context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(653,32): error CS0103: The name 'GetTemplateChild' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(673,17): error CS0119: 'Resources' is a type, which is not valid in the given context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(675,32): error CS0103: The name 'GetTemplateChild' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(689,17): error CS0118: 'ResizeMode' is a type but is used like a variable,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(689,30): error CS0119: 'WindowState' is a type, which is not valid in the given context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(693,21): error CS0119: 'WindowState' is a type, which is not valid in the given context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(697,17): error CS0103: The name 'DragMove' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(703,21): error CS0119: 'WindowState' is a type, which is not valid in the given context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(707,25): error CS0118: 'WindowState' is a type but is used like a variable,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(712,25): error CS0118: 'WindowState' is a type but is used like a variable,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(719,21): error CS0118: 'WindowState' is a type but is used like a variable,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(726,13): error CS0103: The name 'Close' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(736,13): error CS0118: 'WindowState' is a type but is used like a variable,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(736,27): error CS0119: 'WindowState' is a type, which is not valid in the given context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(737,13): error CS0118: 'ResizeMode' is a type but is used like a variable,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(737,26): error CS0119: 'WindowState' is a type, which is not valid in the given context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(742,13): error CS0118: 'WindowState' is a type but is used like a variable,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(752,36): error CS0103: The name 'GetTemplateChild' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(758,21): error CS0103: The name 'HideFullScreenPanel' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(759,21): error CS0103: The name 'ShowFullScreenPanel' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(767,43): error CS0103: The name 'ContentProperty' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(789,59): error CS1503: Argument 1: cannot convert from 'Dev2.Studio.Views.ShellView' to 'System.Windows.IInputElement',D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(789,69): error CS0103: The name 'ActualWidth' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(790,44): error CS0103: The name 'RestoreBounds' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(792,57): error CS1503: Argument 1: cannot convert from 'Dev2.Studio.Views.ShellView' to 'System.Windows.IInputElement',D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(792,67): error CS0103: The name 'ActualHeight' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(793,42): error CS0103: The name 'RestoreBounds' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(795,21): error CS0118: 'WindowState' is a type but is used like a variable,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(796,21): error CS0118: 'ResizeMode' is a type but is used like a variable,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(796,34): error CS0119: 'WindowState' is a type, which is not valid in the given context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(800,21): error CS0103: The name 'Left' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(801,21): error CS0103: The name 'Top' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(803,21): error CS0103: The name 'DragMove' does not exist in the current context,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(812,25): error CS0118: 'WindowState' is a type but is used like a variable,D:\a\1\s\Dev\Dev2.Studio\Views\ShellView.xaml.cs(830,44): error CS0103: The name 'Title' does not exist in the current context
######################################################################


######################################################################
Nr: 27 - UsePatternMatchingRewriterR8
Filepath: D:\a\1\s\Dev\Dev2.Studio.Core.Tests\Merge\ConflictRowListTests.cs
Description: Error: The created Syntax Tree is semantically incorrect.
------------------------------------------------------------------------
---- Original Tree ----
using Dev2.Core.Tests.Merge.Utils;
using Dev2.ViewModels.Merge;
using Microsoft.VisualStudio.TestTools.UnitTesting;

namespace Dev2.Core.Tests.Merge
{
    [TestClass]
    public class ConflictRowListTests : MergeTestUtils
    {
        [TestMethod]
        public void ConflictRowList_Constructor()
        {
            var conflictRowList = CreateConflictRowList();

            Assert.AreEqual(6, conflictRowList.Count);
            Assert.AreEqual(6, conflictRowList.Count);

            Assert.IsNotNull(conflictRowList[0].Current);
            Assert.IsNotNull(conflictRowList[0].Different);

            Assert.IsNotNull(conflictRowList[1].Current);
            Assert.IsNotNull(conflictRowList[1].Different);

            Assert.AreEqual(conflictRowList[0].Current, conflictRowList[0].Different);
            Assert.AreEqual(conflictRowList[0].Different, conflictRowList[0].Current);

            Assert.AreNotEqual(conflictRowList[0].Current, conflictRowList[1].Different);
            Assert.AreNotEqual(conflictRowList[0].Different, conflictRowList[1].Current);

            Assert.AreNotEqual(conflictRowList[1].Current, conflictRowList[0].Different);
            Assert.AreNotEqual(conflictRowList[1].Different, conflictRowList[0].Current);

            var toolConflictRow = conflictRowList[0] as ToolConflictRow;
            if (toolConflictRow != null)
            {
                Assert.IsNotNull(toolConflictRow.UniqueId);
                Assert.IsNotNull(toolConflictRow.Connectors);
                Assert.IsFalse(toolConflictRow.HasConflict);
            } else
            {
                Assert.Fail();
            }

            var toolConflictRow2 = conflictRowList[2] as ToolConflictRow;
            if (toolConflictRow2 != null)
            {
                Assert.IsNotNull(toolConflictRow2.UniqueId);
                Assert.IsNotNull(toolConflictRow2.Connectors);
                Assert.IsFalse(toolConflictRow2.HasConflict);
            } else
            {
                Assert.Fail();
            }

            // Validate User Interface properties are Visible
            Assert.IsFalse(toolConflictRow.IsMergeVisible);
            Assert.IsFalse(toolConflictRow2.IsMergeVisible);
        }
    }
}

---- Transformed Tree ----
using Dev2.Core.Tests.Merge.Utils;
using Dev2.ViewModels.Merge;
using Microsoft.VisualStudio.TestTools.UnitTesting;

namespace Dev2.Core.Tests.Merge
{
    [TestClass]
    public class ConflictRowListTests : MergeTestUtils
    {
        [TestMethod]
        public void ConflictRowList_Constructor()
        {
            var conflictRowList = CreateConflictRowList();

            Assert.AreEqual(6, conflictRowList.Count);
            Assert.AreEqual(6, conflictRowList.Count);

            Assert.IsNotNull(conflictRowList[0].Current);
            Assert.IsNotNull(conflictRowList[0].Different);

            Assert.IsNotNull(conflictRowList[1].Current);
            Assert.IsNotNull(conflictRowList[1].Different);

            Assert.AreEqual(conflictRowList[0].Current, conflictRowList[0].Different);
            Assert.AreEqual(conflictRowList[0].Different, conflictRowList[0].Current);

            Assert.AreNotEqual(conflictRowList[0].Current, conflictRowList[1].Different);
            Assert.AreNotEqual(conflictRowList[0].Different, conflictRowList[1].Current);

            Assert.AreNotEqual(conflictRowList[1].Current, conflictRowList[0].Different);
            Assert.AreNotEqual(conflictRowList[1].Different, conflictRowList[0].Current);

            if (conflictRowList[0] is ToolConflictRow toolConflictRow)
            {
                Assert.IsNotNull(toolConflictRow.UniqueId);
                Assert.IsNotNull(toolConflictRow.Connectors);
                Assert.IsFalse(toolConflictRow.HasConflict);
            } else
            {
                Assert.Fail();
            }

            if (conflictRowList[2] is ToolConflictRow toolConflictRow2)
            {
                Assert.IsNotNull(toolConflictRow2.UniqueId);
                Assert.IsNotNull(toolConflictRow2.Connectors);
                Assert.IsFalse(toolConflictRow2.HasConflict);
            } else
            {
                Assert.Fail();
            }

            // Validate User Interface properties are Visible
            Assert.IsFalse(toolConflictRow.IsMergeVisible);
            Assert.IsFalse(toolConflictRow2.IsMergeVisible);
        }
    }
}

---- Semantic diagnostics *before* transformation ----

---- Semantic diagnostics *after* transformation ----
D:\a\1\s\Dev\Dev2.Studio.Core.Tests\Merge\ConflictRowListTests.cs(54,28): error CS0165: Use of unassigned local variable 'toolConflictRow',D:\a\1\s\Dev\Dev2.Studio.Core.Tests\Merge\ConflictRowListTests.cs(55,28): error CS0165: Use of unassigned local variable 'toolConflictRow2'
######################################################################


